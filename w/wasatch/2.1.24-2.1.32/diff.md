# Comparing `tmp/wasatch-2.1.24.tar.gz` & `tmp/wasatch-2.1.32.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "wasatch-2.1.24.tar", last modified: Wed Dec  7 18:38:08 2022, max compression
+gzip compressed data, was "wasatch-2.1.32.tar", last modified: Mon Jul 10 21:52:07 2023, max compression
```

## Comparing `wasatch-2.1.24.tar` & `wasatch-2.1.32.tar`

### file list

```diff
@@ -1,77 +1,78 @@
--rw-r--r--   0        0        0      282 2022-04-22 11:42:26.280888 wasatch-2.1.24/.example_pypirc
--rw-r--r--   0        0        0     1230 2022-04-22 11:42:26.281749 wasatch-2.1.24/.gitignore
--rw-r--r--   0        0        0   114678 2021-08-10 23:05:24.690860 wasatch-2.1.24/Doxyfile
--rw-r--r--   0        0        0     1074 2018-01-05 13:20:02.000000 wasatch-2.1.24/LICENSE
--rw-r--r--   0        0        0       17 2022-04-22 11:42:26.283332 wasatch-2.1.24/MANIFEST.in
--rw-r--r--   0        0        0      864 2022-04-22 11:42:26.285214 wasatch-2.1.24/Makefile
--rw-r--r--   0        0        0    20629 2022-07-27 13:35:35.050889 wasatch-2.1.24/README.md
--rw-r--r--   0        0        0    20831 2022-12-07 18:36:42.441944 wasatch-2.1.24/README_CHANGELOG.md
--rw-r--r--   0        0        0     2246 2022-10-26 15:39:47.543404 wasatch-2.1.24/README_PYPI.md
--rw-r--r--   0        0        0     7106 2022-07-27 13:31:46.643915 wasatch-2.1.24/README_RPI.md
--rw-r--r--   0        0        0     5936 2021-09-01 16:55:16.091843 wasatch-2.1.24/README_SETTINGS.md
--rw-r--r--   0        0        0     1733 2022-11-29 20:47:20.253694 wasatch-2.1.24/README_VIRTUAL.md
--rw-r--r--   0        0        0     3826 2019-09-18 18:04:41.000000 wasatch-2.1.24/WasatchShell/README.md
--rwxr-xr-x   0        0        0     4621 2019-04-24 16:56:32.000000 wasatch-2.1.24/WasatchShell/laser-test.py
--rwxr-xr-x   0        0        0     9159 2019-06-20 18:48:53.000000 wasatch-2.1.24/WasatchShell/load-test.py
--rwxr-xr-x   0        0        0     2059 2019-09-18 14:02:17.000000 wasatch-2.1.24/WasatchShell/one-shot.py
--rwxr-xr-x   0        0        0    31369 2022-07-27 13:35:35.052014 wasatch-2.1.24/WasatchShell/wasatch-shell.py
--rwxr-xr-x   0        0        0     2238 2020-03-27 17:01:48.000000 wasatch-2.1.24/demo-simple.py
--rw-r--r--   0        0        0      515 2022-10-17 20:08:52.380944 wasatch-2.1.24/demo-virtual.py
--rw-r--r--   0        0        0     5614 2022-12-07 18:36:33.923380 wasatch-2.1.24/demo-workflow.py
--rwxr-xr-x   0        0        0    12932 2022-10-26 13:48:56.143983 wasatch-2.1.24/demo.py
--rw-r--r--   0        0        0      189 2022-08-11 13:43:29.091006 wasatch-2.1.24/environments/conda-linux.yml
--rw-r--r--   0        0        0      178 2022-04-22 11:42:26.401203 wasatch-2.1.24/environments/conda-macos.yml
--rw-r--r--   0        0        0      172 2022-04-22 11:42:26.402369 wasatch-2.1.24/environments/conda-rpi.yml
--rw-r--r--   0        0        0      288 2022-08-11 13:43:29.091225 wasatch-2.1.24/environments/conda-win10.yml
--rw-r--r--   0        0        0      380 2022-04-22 11:42:26.404326 wasatch-2.1.24/pyproject.toml
--rw-r--r--   0        0        0   332281 2018-01-23 15:15:17.000000 wasatch-2.1.24/screenshots/multiplatform.png
--rwxr-xr-x   0        0        0     2895 2022-10-26 15:37:41.955854 wasatch-2.1.24/scripts/dark-vs-integ.py
--rwxr-xr-x   0        0        0     1522 2019-06-05 19:59:37.000000 wasatch-2.1.24/scripts/deploy
--rw-r--r--   0        0        0      621 2022-04-22 11:42:26.404978 wasatch-2.1.24/setup.cfg
--rw-r--r--   0        0        0     5085 2022-10-12 13:38:46.236134 wasatch-2.1.24/testSpectrometers/SiG_785/eeprom/EEPROM-EM-9c65d19f4c.json
--rw-r--r--   0        0        0    38895 2022-10-12 13:38:46.236603 wasatch-2.1.24/testSpectrometers/SiG_785/readings/enlighten-20210329-094722-799520-WP-00686.csv
--rw-r--r--   0        0        0    38895 2022-10-12 13:38:46.237050 wasatch-2.1.24/testSpectrometers/SiG_785/readings/enlighten-20210329-094755-288958-WP-00686.csv
--rw-r--r--   0        0        0    52730 2022-10-12 13:38:46.237580 wasatch-2.1.24/testSpectrometers/WP-00887/eeprom/WP-00887-mock.json
--rw-r--r--   0        0        0    89301 2022-10-12 13:38:46.238221 wasatch-2.1.24/testSpectrometers/WP-00904/eeprom/WP-00904-mock.json
--rw-r--r--   0        0        0    90309 2022-10-12 13:38:46.238871 wasatch-2.1.24/testSpectrometers/WP-00913/eeprom/WP-00913-mock.json
--rwxr-xr-x   0        0        0     7341 2019-04-19 15:21:50.000000 wasatch-2.1.24/tests/noise-by-setpoint.py
--rw-r--r--   0        0        0     4436 2019-04-10 16:42:40.000000 wasatch-2.1.24/tests/queues.py
--rw-r--r--   0        0        0      684 2018-01-23 00:13:39.000000 wasatch-2.1.24/udev/10-wasatch.rules
--rw-r--r--   0        0        0      387 2022-04-22 11:42:26.405223 wasatch-2.1.24/wasatch/AbstractUSBDevice.py
--rw-r--r--   0        0        0    32143 2022-07-28 16:29:39.016191 wasatch-2.1.24/wasatch/AndorDevice.py
--rw-r--r--   0        0        0    19753 2022-08-29 15:47:20.023909 wasatch-2.1.24/wasatch/BLEDevice.py
--rw-r--r--   0        0        0     4787 2019-04-24 14:36:28.000000 wasatch-2.1.24/wasatch/BalanceAcquisition.py
--rw-r--r--   0        0        0     6462 2022-08-11 13:43:29.091462 wasatch-2.1.24/wasatch/CSVLoader.py
--rw-r--r--   0        0        0     3490 2022-07-27 13:35:35.052909 wasatch-2.1.24/wasatch/CommandSettings.py
--rw-r--r--   0        0        0      603 2019-03-19 20:52:40.000000 wasatch-2.1.24/wasatch/ControlObject.py
--rw-r--r--   0        0        0     1062 2022-07-27 13:35:35.053227 wasatch-2.1.24/wasatch/DetectorROI.py
--rw-r--r--   0        0        0     6185 2022-07-27 13:35:35.053572 wasatch-2.1.24/wasatch/DetectorRegions.py
--rw-r--r--   0        0        0    11568 2022-09-28 13:02:40.272985 wasatch-2.1.24/wasatch/DeviceFinderUSB.py
--rw-r--r--   0        0        0    11931 2022-10-12 13:38:46.240370 wasatch-2.1.24/wasatch/DeviceID.py
--rw-r--r--   0        0        0    54981 2022-12-07 18:36:33.924650 wasatch-2.1.24/wasatch/EEPROM.py
--rw-r--r--   0        0        0     1712 2021-09-20 14:45:40.416628 wasatch-2.1.24/wasatch/EEPROM_multical.sav
--rw-r--r--   0        0        0     4591 2022-06-09 20:58:02.191416 wasatch-2.1.24/wasatch/FPGAOptions.py
--rw-r--r--   0        0        0   139792 2022-12-07 18:36:33.927289 wasatch-2.1.24/wasatch/FeatureIdentificationDevice.py
--rw-r--r--   0        0        0     1081 2022-04-22 11:42:26.414332 wasatch-2.1.24/wasatch/HardwareInfo.py
--rw-r--r--   0        0        0     1374 2022-07-27 13:35:35.055551 wasatch-2.1.24/wasatch/InterfaceDevice.py
--rw-r--r--   0        0        0    13392 2022-10-17 20:08:52.383096 wasatch-2.1.24/wasatch/MockUSBDevice.py
--rw-r--r--   0        0        0     9979 2022-04-22 11:42:26.417522 wasatch-2.1.24/wasatch/OceanDevice.py
--rw-r--r--   0        0        0     7888 2022-05-06 17:28:59.208063 wasatch-2.1.24/wasatch/ProcessedReading.py
--rw-r--r--   0        0        0      557 2022-07-27 13:35:35.055892 wasatch-2.1.24/wasatch/ROI.py
--rw-r--r--   0        0        0     2913 2022-04-22 11:42:26.419739 wasatch-2.1.24/wasatch/Reading.py
--rw-r--r--   0        0        0     1675 2022-08-04 17:30:55.426169 wasatch-2.1.24/wasatch/RealUSBDevice.py
--rw-r--r--   0        0        0    28430 2022-07-27 13:35:35.056447 wasatch-2.1.24/wasatch/SPIDevice.py
--rw-r--r--   0        0        0      410 2022-04-22 11:42:26.421257 wasatch-2.1.24/wasatch/SpectrometerRequest.py
--rw-r--r--   0        0        0     1220 2022-07-27 15:06:20.954386 wasatch-2.1.24/wasatch/SpectrometerResponse.py
--rw-r--r--   0        0        0    19985 2022-12-07 18:36:33.929169 wasatch-2.1.24/wasatch/SpectrometerSettings.py
--rw-r--r--   0        0        0    10690 2022-12-07 18:36:33.930035 wasatch-2.1.24/wasatch/SpectrometerState.py
--rw-r--r--   0        0        0      460 2018-07-13 19:34:51.000000 wasatch-2.1.24/wasatch/StatusMessage.py
--rw-r--r--   0        0        0     2039 2022-09-19 19:38:55.643728 wasatch-2.1.24/wasatch/WasatchBus.py
--rw-r--r--   0        0        0    48107 2022-10-26 15:37:41.957088 wasatch-2.1.24/wasatch/WasatchDevice.py
--rw-r--r--   0        0        0    21835 2022-10-17 20:08:52.384811 wasatch-2.1.24/wasatch/WasatchDeviceWrapper.py
--rw-r--r--   0        0        0    11965 2022-10-26 12:49:22.062092 wasatch-2.1.24/wasatch/WrapperWorker.py
--rw-r--r--   0        0        0      254 2022-12-07 18:36:50.894058 wasatch-2.1.24/wasatch/__init__.py
--rw-r--r--   0        0        0     5841 2021-08-14 02:28:59.095415 wasatch-2.1.24/wasatch/applog.py
--rw-r--r--   0        0        0     8508 2019-04-15 16:11:07.000000 wasatch-2.1.24/wasatch/simulation_protocol.py
--rw-r--r--   0        0        0    20278 2022-10-12 13:38:46.242695 wasatch-2.1.24/wasatch/utils.py
--rw-r--r--   0        0        0    20971 1970-01-01 00:00:00.000000 wasatch-2.1.24/PKG-INFO
+-rw-r--r--   0        0        0      282 2022-04-22 11:42:26.280888 wasatch-2.1.32/.example_pypirc
+-rw-r--r--   0        0        0     1230 2022-04-22 11:42:26.281749 wasatch-2.1.32/.gitignore
+-rw-r--r--   0        0        0   114678 2021-08-10 23:05:24.690860 wasatch-2.1.32/Doxyfile
+-rw-r--r--   0        0        0     1074 2018-01-05 13:20:02.000000 wasatch-2.1.32/LICENSE
+-rw-r--r--   0        0        0       17 2022-04-22 11:42:26.283332 wasatch-2.1.32/MANIFEST.in
+-rw-r--r--   0        0        0      864 2022-04-22 11:42:26.285214 wasatch-2.1.32/Makefile
+-rw-r--r--   0        0        0    20629 2022-07-27 13:35:35.050889 wasatch-2.1.32/README.md
+-rw-r--r--   0        0        0    21795 2023-07-10 21:45:09.977090 wasatch-2.1.32/README_CHANGELOG.md
+-rw-r--r--   0        0        0     2246 2022-10-26 15:39:47.543404 wasatch-2.1.32/README_PYPI.md
+-rw-r--r--   0        0        0     7106 2022-07-27 13:31:46.643915 wasatch-2.1.32/README_RPI.md
+-rw-r--r--   0        0        0     5936 2021-09-01 16:55:16.091843 wasatch-2.1.32/README_SETTINGS.md
+-rw-r--r--   0        0        0     1733 2022-11-29 20:47:20.253694 wasatch-2.1.32/README_VIRTUAL.md
+-rw-r--r--   0        0        0     3826 2019-09-18 18:04:41.000000 wasatch-2.1.32/WasatchShell/README.md
+-rwxr-xr-x   0        0        0     4621 2019-04-24 16:56:32.000000 wasatch-2.1.32/WasatchShell/laser-test.py
+-rwxr-xr-x   0        0        0     9159 2019-06-20 18:48:53.000000 wasatch-2.1.32/WasatchShell/load-test.py
+-rwxr-xr-x   0        0        0     2059 2019-09-18 14:02:17.000000 wasatch-2.1.32/WasatchShell/one-shot.py
+-rwxr-xr-x   0        0        0    33703 2023-07-10 21:42:03.867395 wasatch-2.1.32/WasatchShell/wasatch-shell.py
+-rwxr-xr-x   0        0        0     2263 2023-06-23 14:45:48.435856 wasatch-2.1.32/demo-simple.py
+-rw-r--r--   0        0        0      515 2022-10-17 20:08:52.380944 wasatch-2.1.32/demo-virtual.py
+-rw-r--r--   0        0        0     5620 2023-06-29 23:26:13.474772 wasatch-2.1.32/demo-workflow.py
+-rwxr-xr-x   0        0        0    12932 2022-10-26 13:48:56.143983 wasatch-2.1.32/demo.py
+-rw-r--r--   0        0        0      189 2022-08-11 13:43:29.091006 wasatch-2.1.32/environments/conda-linux.yml
+-rw-r--r--   0        0        0      178 2022-04-22 11:42:26.401203 wasatch-2.1.32/environments/conda-macos.yml
+-rw-r--r--   0        0        0      172 2022-04-22 11:42:26.402369 wasatch-2.1.32/environments/conda-rpi.yml
+-rw-r--r--   0        0        0      288 2022-08-11 13:43:29.091225 wasatch-2.1.32/environments/conda-win10.yml
+-rw-r--r--   0        0        0      380 2022-04-22 11:42:26.404326 wasatch-2.1.32/pyproject.toml
+-rw-r--r--   0        0        0       76 2023-02-01 00:14:07.624753 wasatch-2.1.32/requirements.txt
+-rw-r--r--   0        0        0   332281 2018-01-23 15:15:17.000000 wasatch-2.1.32/screenshots/multiplatform.png
+-rwxr-xr-x   0        0        0     2895 2022-10-26 15:37:41.955854 wasatch-2.1.32/scripts/dark-vs-integ.py
+-rwxr-xr-x   0        0        0     1522 2019-06-05 19:59:37.000000 wasatch-2.1.32/scripts/deploy
+-rw-r--r--   0        0        0      621 2022-04-22 11:42:26.404978 wasatch-2.1.32/setup.cfg
+-rw-r--r--   0        0        0     5085 2022-10-12 13:38:46.236134 wasatch-2.1.32/testSpectrometers/SiG_785/eeprom/EEPROM-EM-9c65d19f4c.json
+-rw-r--r--   0        0        0    38895 2022-10-12 13:38:46.236603 wasatch-2.1.32/testSpectrometers/SiG_785/readings/enlighten-20210329-094722-799520-WP-00686.csv
+-rw-r--r--   0        0        0    38895 2022-10-12 13:38:46.237050 wasatch-2.1.32/testSpectrometers/SiG_785/readings/enlighten-20210329-094755-288958-WP-00686.csv
+-rw-r--r--   0        0        0    52730 2022-10-12 13:38:46.237580 wasatch-2.1.32/testSpectrometers/WP-00887/eeprom/WP-00887-mock.json
+-rw-r--r--   0        0        0    89301 2022-10-12 13:38:46.238221 wasatch-2.1.32/testSpectrometers/WP-00904/eeprom/WP-00904-mock.json
+-rw-r--r--   0        0        0    90309 2022-10-12 13:38:46.238871 wasatch-2.1.32/testSpectrometers/WP-00913/eeprom/WP-00913-mock.json
+-rwxr-xr-x   0        0        0     7341 2019-04-19 15:21:50.000000 wasatch-2.1.32/tests/noise-by-setpoint.py
+-rw-r--r--   0        0        0     4436 2019-04-10 16:42:40.000000 wasatch-2.1.32/tests/queues.py
+-rw-r--r--   0        0        0      638 2023-02-01 00:14:07.625135 wasatch-2.1.32/udev/10-wasatch.rules
+-rw-r--r--   0        0        0      387 2022-04-22 11:42:26.405223 wasatch-2.1.32/wasatch/AbstractUSBDevice.py
+-rw-r--r--   0        0        0    32987 2023-06-29 23:26:13.475674 wasatch-2.1.32/wasatch/AndorDevice.py
+-rw-r--r--   0        0        0    19783 2023-06-29 23:26:13.476471 wasatch-2.1.32/wasatch/BLEDevice.py
+-rw-r--r--   0        0        0     4787 2019-04-24 14:36:28.000000 wasatch-2.1.32/wasatch/BalanceAcquisition.py
+-rw-r--r--   0        0        0     7045 2023-06-13 19:15:55.934605 wasatch-2.1.32/wasatch/CSVLoader.py
+-rw-r--r--   0        0        0     3490 2022-07-27 13:35:35.052909 wasatch-2.1.32/wasatch/CommandSettings.py
+-rw-r--r--   0        0        0      603 2019-03-19 20:52:40.000000 wasatch-2.1.32/wasatch/ControlObject.py
+-rw-r--r--   0        0        0     1062 2022-07-27 13:35:35.053227 wasatch-2.1.32/wasatch/DetectorROI.py
+-rw-r--r--   0        0        0     6196 2023-06-29 23:26:13.477554 wasatch-2.1.32/wasatch/DetectorRegions.py
+-rw-r--r--   0        0        0    11577 2023-06-29 23:26:13.478118 wasatch-2.1.32/wasatch/DeviceFinderUSB.py
+-rw-r--r--   0        0        0    11986 2023-06-29 23:26:13.479122 wasatch-2.1.32/wasatch/DeviceID.py
+-rw-r--r--   0        0        0    57024 2023-07-10 13:11:42.339101 wasatch-2.1.32/wasatch/EEPROM.py
+-rw-r--r--   0        0        0     1712 2021-09-20 14:45:40.416628 wasatch-2.1.32/wasatch/EEPROM_multical.sav
+-rw-r--r--   0        0        0     4591 2022-06-09 20:58:02.191416 wasatch-2.1.32/wasatch/FPGAOptions.py
+-rw-r--r--   0        0        0   146403 2023-07-10 21:42:03.869610 wasatch-2.1.32/wasatch/FeatureIdentificationDevice.py
+-rw-r--r--   0        0        0     1103 2023-06-29 23:26:13.482659 wasatch-2.1.32/wasatch/HardwareInfo.py
+-rw-r--r--   0        0        0     1380 2023-06-29 23:26:13.483042 wasatch-2.1.32/wasatch/InterfaceDevice.py
+-rw-r--r--   0        0        0    13421 2023-06-29 23:26:13.483532 wasatch-2.1.32/wasatch/MockUSBDevice.py
+-rw-r--r--   0        0        0     9991 2023-06-29 23:26:13.484117 wasatch-2.1.32/wasatch/OceanDevice.py
+-rw-r--r--   0        0        0     7910 2023-07-04 13:05:06.754652 wasatch-2.1.32/wasatch/ProcessedReading.py
+-rw-r--r--   0        0        0      557 2023-05-05 13:42:22.754238 wasatch-2.1.32/wasatch/ROI.py
+-rw-r--r--   0        0        0     2913 2023-06-08 17:38:27.333518 wasatch-2.1.32/wasatch/Reading.py
+-rw-r--r--   0        0        0     1675 2022-08-04 17:30:55.426169 wasatch-2.1.32/wasatch/RealUSBDevice.py
+-rw-r--r--   0        0        0    28469 2023-06-29 23:26:13.485264 wasatch-2.1.32/wasatch/SPIDevice.py
+-rw-r--r--   0        0        0      410 2022-04-22 11:42:26.421257 wasatch-2.1.32/wasatch/SpectrometerRequest.py
+-rw-r--r--   0        0        0     1220 2023-07-10 13:28:46.077197 wasatch-2.1.32/wasatch/SpectrometerResponse.py
+-rw-r--r--   0        0        0    20478 2023-07-07 21:04:42.479858 wasatch-2.1.32/wasatch/SpectrometerSettings.py
+-rw-r--r--   0        0        0    10690 2023-06-07 13:32:46.850477 wasatch-2.1.32/wasatch/SpectrometerState.py
+-rw-r--r--   0        0        0      460 2018-07-13 19:34:51.000000 wasatch-2.1.32/wasatch/StatusMessage.py
+-rw-r--r--   0        0        0     2217 2023-06-29 23:26:13.486306 wasatch-2.1.32/wasatch/WasatchBus.py
+-rw-r--r--   0        0        0    48128 2023-06-29 23:26:13.487074 wasatch-2.1.32/wasatch/WasatchDevice.py
+-rw-r--r--   0        0        0    21844 2023-06-29 23:26:13.487783 wasatch-2.1.32/wasatch/WasatchDeviceWrapper.py
+-rw-r--r--   0        0        0    11971 2023-06-29 23:26:13.488407 wasatch-2.1.32/wasatch/WrapperWorker.py
+-rw-r--r--   0        0        0      254 2023-07-10 21:45:18.756604 wasatch-2.1.32/wasatch/__init__.py
+-rw-r--r--   0        0        0     5841 2021-08-14 02:28:59.095415 wasatch-2.1.32/wasatch/applog.py
+-rw-r--r--   0        0        0     8508 2019-04-15 16:11:07.000000 wasatch-2.1.32/wasatch/simulation_protocol.py
+-rw-r--r--   0        0        0    20297 2023-06-29 23:26:13.489708 wasatch-2.1.32/wasatch/utils.py
+-rw-r--r--   0        0        0    20971 1970-01-01 00:00:00.000000 wasatch-2.1.32/PKG-INFO
```

### Comparing `wasatch-2.1.24/.gitignore` & `wasatch-2.1.32/.gitignore`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/Doxyfile` & `wasatch-2.1.32/Doxyfile`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/LICENSE` & `wasatch-2.1.32/LICENSE`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/Makefile` & `wasatch-2.1.32/Makefile`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/README.md` & `wasatch-2.1.32/README.md`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/README_CHANGELOG.md` & `wasatch-2.1.32/README_CHANGELOG.md`

 * *Files 8% similar despite different names*

```diff
@@ -1,9 +1,33 @@
 # Changelog
 
+- 2023-07-10 2.1.32
+    - offset gettors now return SpectrometerResponse 
+    - fixed display of gettors returning SpectrometerResponse in WasatchShell 
+- 2023-07-04 2.1.31
+    - clarify methods returning bool vs SpectrometerResponse
+    - remove return type annotations
+    - s/vignette/crop/
+- 2023-06-13 2.1.30
+    - invert x-axis for 1064XL
+    - don't enable TEC with default / invalid TEC calibration
+    - restore ability for CSVLoader.parse_metadata to support single-measurement
+      CSVs where metadata fields are expected to be scalars rather than lists
+- 2023-05-10 2.1.29
+    - support for 1064XL
+- 2023-05-03 2.1.28
+    - better handling of rare null-buffer EEPROM readout
+- 2023-01-13 2.1.27
+    - is_andor fix
+    - laser watchdog fix (disable on older EEPROMs)
+- 2022-12-14 2.1.26
+    - default InGaAs detectors to high-gain mode
+    - forget disconnected USB devices
+- 2022-12-13 2.1.25
+    - disable laserEnable verification loop for Series-XS
 - 2022-12-07 2.1.24
     - update EEPROM to Rev15
     - default laser power calibration to high-resolution
 - 2022-10-26 2.1.23
     - fix connect bug
     - added scripts/dark-vs-integ.py
 - 2022-10-17 2.1.22
```

### Comparing `wasatch-2.1.24/README_PYPI.md` & `wasatch-2.1.32/README_PYPI.md`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/README_RPI.md` & `wasatch-2.1.32/README_RPI.md`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/README_SETTINGS.md` & `wasatch-2.1.32/README_SETTINGS.md`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/README_VIRTUAL.md` & `wasatch-2.1.32/README_VIRTUAL.md`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/WasatchShell/README.md` & `wasatch-2.1.32/WasatchShell/README.md`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/WasatchShell/laser-test.py` & `wasatch-2.1.32/WasatchShell/laser-test.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/WasatchShell/load-test.py` & `wasatch-2.1.32/WasatchShell/load-test.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/WasatchShell/one-shot.py` & `wasatch-2.1.32/WasatchShell/one-shot.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/WasatchShell/wasatch-shell.py` & `wasatch-2.1.32/WasatchShell/wasatch-shell.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,734 +1,743 @@
-#!/usr/bin/env python -u
-
-import datetime
-import platform
-import argparse
-import logging
-import time
-import sys
-import os
-import re
-
-import wasatch
-
-from wasatch import utils
-from wasatch.WasatchBus         import WasatchBus
-from wasatch.WasatchDevice      import WasatchDevice
-from wasatch.BalanceAcquisition import BalanceAcquisition
-from wasatch.RealUSBDevice      import RealUSBDevice
-
-VERSION = "2.3.0"
-
-log = logging.getLogger(__name__)
-
-## 
-# An interactive wrapper over a wasatch.WasatchDevice.
-#
-# EXAMPLE:
-# \verbatim
-#   $ ./wasatch-shell.py [--logfile path]
-#   open
-#   set_integration_time_ms
-#   100
-#   get_spectrum
-#   close
-# \endverbatim
-#
-# @todo currently there is no support for scan averaging.  That is because 
-#       scan averaging is built into WasatchDevice.acquire_data, and configured
-#       via Feature
-class WasatchShell(object):
-    
-    def __init__(self):
-        self.device = None                      # wasatch.WasatchDevice
-        self.clear()
-
-        # process command-line options
-        parser = argparse.ArgumentParser()
-        parser.add_argument("--eod", action="store_true", help="output END_OF_DATA on a line by itself following every action")
-        parser.add_argument("--logfile", help="where to write log messages")
-        parser.add_argument("--log-level", type=str, default="info", help="logging level", choices=['debug', 'info', 'warning', 'error', 'critical'])
-        parser.add_argument("--timestamp", action="store_true", help="timestamp console messages")
-        self.args = parser.parse_args()
-
-        self.configure_logging()
-        self.input_tokens = None
-        self.dark_spectra = None
-        self.srm = False
-
-        # pass-through calls to any of these gettors (note names are lowercased)
-        self.gettors = {}
-        for func_name in [ 
-            "get_actual_frames",
-            "get_actual_integration_time_us",
-            "get_ambient_temperature_degC",
-            "get_ccd_sensing_threshold",
-            "get_ccd_threshold_sensing_mode",
-            "get_dac",
-            "get_detector_gain",
-            "get_detector_gain_odd",
-            "get_detector_offset",
-            "get_detector_offset_odd",
-            "get_detector_tec_setpoint_degC",
-            "get_detector_tec_setpoint_raw",
-            "get_detector_temperature_degC",
-            "get_detector_temperature_raw",
-            "get_external_trigger_output",
-            "get_fan_enabled",
-            "get_fpga_firmware_version",
-            "get_high_gain_mode_enabled",
-            "get_integration_time_ms",
-            "get_lamp_enabled",
-            "get_laser_enabled",
-            "get_laser_interlock",
-            "get_laser_temperature_degC",
-            "get_laser_temperature_raw",
-            "get_laser_watchdog_sec",
-            "get_microcontroller_firmware_version",
-            "get_mod_delay_us",
-            "get_mod_duration_us",
-            "get_mod_enabled",
-            "get_mod_linked_to_integration",
-            "get_mod_period_us",
-            "get_mod_width_us",
-            "get_opt_actual_integration_time",
-            "get_opt_area_scan",
-            "get_opt_cf_select",
-            "get_opt_data_header_tab",
-            "get_opt_has_laser",
-            "get_opt_horizontal_binning",
-            "get_opt_integration_time_resolution",
-            "get_opt_laser_control",
-            "get_raman_delay_ms",
-            "get_secondary_adc_calibrated",
-            "get_secondary_adc_raw",
-            "get_selected_adc",
-            "get_selected_laser",
-            "get_sensor_line_length",
-            "get_shutter_enabled",
-            "get_strobe_enabled",
-            "get_tec_enabled",
-            "get_trigger_delay",
-            "get_trigger_source",
-            "get_vr_continuous_ccd",
-            "get_vr_num_frames",
-            "has_laser_power_calibration",
-            "has_linearity_coeffs" ]:
-            self.gettors[func_name.lower()] = func_name
-
-    # ##############################################################################
-    # Utility Functions
-    # ##############################################################################
-
-    def usage(self):
-        print("Version: %s" % VERSION)
-        print("""The following commands are supported:
-        help                                   - this screen
-        version                                - program and library versions
-                                               
-        open                                   - initialize connected spectrometer
-        close                                  - exit program (synonyms 'exit', 'quit')
-        connection_check                       - confirm communication
-        clear                                  - reset interpolated x axes
-                                               
-        set_scans_to_average                   - takes integer argument
-        set_integration_time_ms                - takes integer argument
-        set_laser_enable                       - takes bool argument (on/off, true/false, 1/0)
-        set_laser_power_mw                     - takes float argument
-        set_laser_power_perc                   - takes int argument
-        set_laser_watchdog_sec                 - takes integer argument
-        set_acquisition_laser_trigger_enable   - takes bool argument
-        set_acquisition_laser_trigger_delay_ms - takes float argument
-        set_tec_enable                         - takes bool argument
-        set_detector_tec_setpoint_degc         - takes float argument
-        set_detector_offset                    - override the "offset" added to pixel readings
-        set_selected_laser                     - takes 0 or 1
-        set_raman_mode                         - takes 0 or 1
-        set_raman_delay_ms                     - takes integer argument
-                                               
-        set_fan_enable                         - takes bool argument
-        set_lamp_enable                        - takes bool argument
-        set_shutter_enable                     - takes bool argument
-        set_strobe_enable                      - takes bool argument
-        set_mod_enable                         - takes bool argument
-        set_mod_period_us                      - takes int argument
-        set_mod_width_us                       - takes int argument
-        set_mod_delay_us                       - takes int argument
-
-        set_interpolated_x_axis_cm             - takes start, end, incr (zero incr to disable)
-        set_interpolated_x_axis_nm             - takes start, end, incr (zero incr to disable)
-        balance_acquisition                    - takes mode [integ, laser, laser_and_integ], 
-                                                    intensity, threshold, max_integration_time_ms, 
-                                                    max_tries, x, unit [px, nm, cm]
-                                               
-        get_spectrum                           - print received spectrum
-        set_raman_intensity_correction_enable  - takes bool argument
-        get_dark                               - captures spectrum and stores as dark
-        clear_dark                             - clears a stored dark spectrum
-        get_spectrum_pretty                    - graph received spectrum
-        get_spectrum_save                      - save spectrum to filename as CSV
-        get_config_json                        - return EEPROM as JSON string
-        get_all                                - calls all gettors
-        """)
-        print("The following gettors are also available:")
-        for k in sorted(self.gettors.keys()):
-            print("        %s" % k)
-
-    def disconnected(self):
-        self.display("ERROR: no device connected")
-
-    ## encapsulating in case any platforms don't like GNU readline
-    def get_line(self, prompt="args> "):
-        return input(prompt).strip()
-
-    def has_input(self):
-        return self.input_tokens is not None and len(self.input_tokens) > 0
-
-    def get_next_token(self):
-        while not self.has_input():
-            line = self.get_line()
-            log.info("<< %s", line)
-            self.input_tokens = [s.strip() for s in line.lower().strip().split()]
-        return self.input_tokens.pop(0)
-
-    def read_bool(self):
-        s = self.get_next_token()
-        return re.match("1|true|yes|on", s.lower()) is not None
-
-    def read_int(self):
-        return int(self.get_next_token())
-
-    def read_float(self):
-        return float(self.get_next_token())
-
-    def read_str(self):
-        return self.get_next_token()
-
-    def display(self, msg):
-        log.info(">> %s", msg)
-        print(msg)
-        sys.stdout.flush()
-
-    def configure_logging(self):
-        logging.basicConfig(filename=(self.args.logfile if self.args.logfile else ("wasatch-%s.log" % utils.timestamp())),
-                            level=self.args.log_level.upper(),
-                            format='%(asctime)s.%(msecs)03d %(name)s %(levelname)-8s %(message)s', 
-                            datefmt='%m/%d/%Y %I:%M:%S')
-
-    # ##############################################################################
-    # command loop
-    # ##############################################################################
-
-    def run(self):
-        self.display("-" * 80)
-        self.display("wasatch-shell version %s invoked (Wasatch.PY %s)" % (VERSION, wasatch.version))
-
-        try:
-            while True:
-                prompt = "wp> " if not self.args.timestamp else str(datetime.datetime.now()) + " wp> "
-                line = self.get_line(prompt)
-
-                # ignore comments
-                if line.startswith('#') or len(line) == 0:
-                    continue
-
-                log.info("<< %s", line)
-
-                # tokenize
-                self.input_tokens = [s.strip() for s in line.lower().strip().split()]
-                command = self.read_str()
-
-                # these commands always work
-                if command == "help":
-                    self.usage()
-                    continue
-
-                elif command == "version":
-                    self.display("WasatchShell version: %s" % VERSION)
-                    self.display("Wasatch.PY   version: %s" % wasatch.version)
-                    continue
-
-                if re.match("close|quit|exit", command):
-                    break
-
-                # these commands work if currently closed
-                if self.device is None:
-                    if command == "open":
-                        self.display(1 if self.open() else 0)
-                    else:
-                        self.display("ERROR: must open spectrometer first")
-
-                else:
-                    try:
-                        # anything past this point assumes spectrometer already open
-
-                        # pass-through gettors
-                        if command in self.gettors:
-                            self.run_gettor(command)
-                            
-                        # special processing for these
-                        elif command == "get_spectrum":
-                            self.get_spectrum(quiet=False)
-
-                        elif command == "get_dark":
-                            self.get_dark()
-                            self.display(1)
-
-                        elif command == "clear_dark":
-                            self.clear_dark()
-                            self.display(1)
-
-                        elif command == "get_spectrum_pretty":
-                            self.get_spectrum_pretty()
-
-                        elif command == "get_spectrum_save":
-                            self.get_spectrum_save()
-
-                        elif command == "get_config_json":
-                            self.display(self.device.settings.eeprom.json(allow_nan=False))
-
-                        elif command == "get_all":
-                            self.get_all()
-
-                        elif command == "connection_check":
-                            self.run_gettor("get_integration_time_ms")
-
-                        elif command == "balance_acquisition":
-                            self.balance_acquisition()
-
-                        elif command == "set_interpolated_x_axis_cm":
-                            self.set_interpolated_x_axis_cm(start = self.read_float(),
-                                                            end   = self.read_float(),
-                                                            incr  = self.read_float())
-
-                        elif command == "set_interpolated_x_axis_nm":
-                            self.set_interpolated_x_axis_nm(start = self.read_float(),
-                                                            end   = self.read_float(),
-                                                            incr  = self.read_float())
-
-                        elif command == "set_raman_intensity_correction_enable":
-                            self.set_raman_intensity_correction_enable(self.device, self.read_bool())
-
-                        elif command == "clear":
-                            self.clear()
-
-                        # currently these are the only setters implemented
-                        #
-                        # These originally called directly into 
-                        # FeatureIdentificationDevice, which was efficient, but:
-                        #
-                        #   1. missed value-add processing in WasatchDevice.change_setting, 
-                        #   2. couldn't utilize inline (non functional) 
-                        #      implementations in FID.write_setting,
-                        #   3. provided no obvious path to achieve scan averaging 
-                        #      (issues 1 and 2)
-                        #   4. potentially differed than ENLIGHTEN processing 
-                        #      while failing to exercise ENLIGHTEN communication
-                        #      path (part of the script's purpose)
-                        #
-                        # Therefore, setters now utilize WasatchDevice.change_setting 
-                        # where possible.
-                        #
-                        # An obvious CONSEQUENCE of using change_setting() over 
-                        # direct FID function calls is that no return value is 
-                        # possible on "settor" functions :-(
-
-                        elif command == "set_integration_time_ms":
-                            self.device.change_setting("integration_time_ms", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_laser_watchdog_sec":
-                            self.device.change_setting("laser_watchdog_sec", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_raman_delay_ms":
-                            self.device.change_setting("raman_delay_ms", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_raman_mode":
-                            self.device.change_setting("raman_mode_enable", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_laser_power_mw":
-                            self.device.change_setting("laser_power_mW", self.read_float())
-                            self.display(1)
-
-                        elif command == "set_laser_power_perc":
-                            self.device.change_setting("laser_power_perc", self.read_float())
-                            self.display(1)
-
-                        elif command == "set_laser_enable":
-                            self.set_laser_enable(flag = self.read_bool())
-
-                        elif command == "set_laser_power_high_resolution":
-                            self.device.change_setting("laser_power_high_resolution", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_tec_enable":
-                            self.device.change_setting("detector_tec_enable", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_detector_tec_setpoint_degc":
-                            self.device.change_setting("detector_tec_setpoint_degC", self.read_float())
-                            self.display(1)
-
-                        elif command == "set_detector_offset":
-                            self.device.change_setting("detector_offset", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_scans_to_average":
-                            self.device.change_setting("scans_to_average", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_acquisition_laser_trigger_enable":
-                            self.device.change_setting("acquisition_laser_trigger_enable", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_acquisition_laser_trigger_delay_ms":
-                            self.device.change_setting("acquisition_laser_trigger_delay_ms", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_selected_laser":
-                            self.device.change_setting("selected_laser", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_fan_enable":
-                            self.device.change_setting("fan_enable", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_lamp_enable":
-                            self.device.change_setting("lamp_enable", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_shutter_enable":
-                            self.device.change_setting("shutter_enable", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_strobe_enable":
-                            self.device.change_setting("strobe_enable", self.read_bool())
-                            self.display(1)
-
-                        elif command == "set_mod_period_us":
-                            self.device.change_setting("mod_period_us", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_mod_width_us":
-                            self.device.change_setting("mod_width_us", self.read_int())
-                            self.display(1)
-
-                        elif command == "set_mod_delay_us":
-                            self.device.change_setting("mod_period_us", self.read_int())
-                            self.display(1)
-
-                        elif command == "open":
-                            # if user re-sends open command when already open, do nothing
-                            self.display(1)
-
-                        else:
-                            self.display("ERROR: unknown command: " + command)
-                    except Exception as ex:
-                        log.critical("caught exception", exc_info=1)
-                        log.info("disconnecting")
-                        self.device.disconnect()
-                        self.device = None
-
-                        log.info("sleeping 5sec")
-                        time.sleep(5.100)
-                        
-                        log.info("re-opening")
-                        if self.open():
-                            log.info("successfully re-opened")
-                        else:
-                            log.error("could not re-open...giving up")
-                            break
-
-                if self.args.eod:
-                    self.display("END_OF_DATA")
-
-                # whatever happened, flush stdout
-                try:
-                    sys.stdout.flush()
-                except:
-                    self.display("ERROR: caller has closed stdout...exiting")
-                    break
-
-        except Exception as e:
-            log.error(e, exc_info=1)
-            raise
-
-        # disable the laser if connected
-        if self.device is not None:
-            self.set_laser_enable(False, quiet=True)
-            self.device.disconnect()
-            self.device = None
-
-        log.info("wasatch-shell exiting")
-
-    ## 
-    # If the current device is disconnected, and there is a new device, 
-    # attempt to connect to it. """
-    def open(self):
-        # if we're already connected, nevermind
-        if self.device is not None:
-            return False
-
-        # lazy-load a USB bus
-        log.debug("instantiating WasatchBus")
-        bus = WasatchBus()
-        if not bus.device_ids:
-            self.display("No Wasatch USB spectrometers found.")
-            return False
-
-        device_id = bus.device_ids[0]
-        log.debug("open: trying to connect to %s", device_id)
-        device_id.device_type = RealUSBDevice(device_id)
-        device = WasatchDevice(device_id)
-
-        ok = device.connect()
-        if not ok.data: 
-            log.critical("open: can't connect to device on bus 1")
-            return
-
-        log.info("open: device connected")
-        self.device = device
-
-        # enable exceptions
-        self.device.hardware.raise_exceptions = True
-
-        # enable immediate mode (don't queue commands until acquire_data)
-        self.device.immediate_mode = True
-
-        # enable bare readings (don't query extra hardware metadata during acquisitions)
-        self.device.bare_readings = True
-
-        # disable free-running mode (interactive shell is the definition of "slaved to user commands")
-        self.device.change_setting("free_running_mode", False)
-
-        # laser should not be on, but even so
-        self.set_laser_enable(False, quiet=True)
-
-        # enable high-resolution laser power by default
-        self.device.change_setting("laser_power_high_resolution", True)
-
-        # if laser has power calibration, require it and initialize accordingly 
-        # (so if the user enables the laser, it won't fire at an out-of-bounds 
-        # 100% unmodulated)
-        if self.device.hardware.has_laser_power_calibration():
-            log.info("laser has power calibration, so requiring modulation and initializing to max-rated power in mW")
-            self.device.change_setting("laser_power_require_modulation", True)
-            self.device.change_setting("laser_power_mW", self.device.settings.eeprom.max_laser_power_mW)
-
-        # throw random errors
-        # self.device.hardware.random_errors = True
-
-        # validate gettors (in case this is used against a StrokerProtocol unit, for instance)
-        for func_name in list(self.gettors.keys()):
-            if not hasattr(device.hardware, self.gettors[func_name]):
-                self.display("WARNING: gettor %s (%s) not found in device" % (func_name, self.gettors[func_name]))
-                del self.gettors[func_name]
-
-        # default to minimum configured integration time
-        self.device.change_setting("integration_time_ms", self.device.settings.eeprom.min_integration_time_ms)
-
-        return True
-
-    def run_gettor(self, command):
-        func_name = self.gettors[command]
-        value = getattr(self.device.hardware, func_name)()
-        if isinstance(value, bool):
-            self.display(1 if value else 0)
-        else:
-            self.display(value)
-
-    def get_dark(self):
-        spectrum = self.get_spectrum(quiet=True)
-        self.dark_spectra = spectrum
-
-    def clear_dark(self):
-        self.dark_spectra = None
-
-    def set_raman_intensity_correction_enable(self, device: WasatchDevice, status: bool) -> int:
-        if not device.settings.eeprom.has_raman_intensity_calibration():
-            self.display("Device has no Raman Intensity Calibration")
-            self.srm = False
-            return
-        else:
-            self.srm = status
-            self.display(1)
-            return
-
-    def srm_process(self, spectrum: list[float], device: WasatchDevice) -> list[float]:
-
-        factors = device.settings.raman_intensity_factors
-        if factors is None or len(factors) != len(spectrum):
-            return 
-
-        spectrum = [px*fac for px, fac in zip(spectrum,factors)]
-        return spectrum
-
-    ##
-    # This calls WasatchDevice.acquire_data, rather than FID.get_line, because 
-    # scan averaging, bad-pixel correction, acquisition laser trigger and other
-    # high-level acquisition features are implemented in WasatchDevice rather 
-    # than FID.
-    def get_spectrum(self, quiet=True):
-        # enqueue ACQUIRE command, as we're not in free-running mode
-        self.device.change_setting("acquire", True, allow_immediate=False)
-
-        # now collect the spectrum
-        reading_response = self.device.acquire_data()
-        reading = reading_response.data
-        if reading is None or isinstance(reading, bool) or reading.spectrum is None:
-            self.display("ERROR: get_spectrum failed")
-            return
-        spectrum = reading.spectrum
-        if self.dark_spectra is not None and len(self.dark_spectra) == len(spectrum):
-            spectrum = [spec-dark for spec, dark in zip(spectrum, self.dark_spectra)]
-        log.debug("received %d pixels", len(spectrum))
-
-        if self.srm:
-            spectrum = self.srm_process(spectrum, self.device)
-
-        if self.interpolated_x_axis_cm and self.device.settings.wavenumbers:
-            spectrum = utils.interpolate_array(spectrum, 
-                                               self.device.settings.wavenumbers, 
-                                               self.interpolated_x_axis_cm)
-        elif self.interpolated_x_axis_nm:
-            spectrum = utils.interpolate_array(spectrum, 
-                                               self.device.settings.wavelengths, 
-                                               self.interpolated_x_axis_nm)
-        if quiet:
-            return spectrum
-
-        for pixel in spectrum:
-            print(pixel)
-
-    def get_spectrum_save(self):
-        spectrum = self.get_spectrum()
-        if spectrum is None:
-            return 
-
-        if self.has_input():
-            filename = self.read_str()
-        else:
-            filename = datetime.datetime.now().strftime("%Y%m%d-%H%M%S.csv")
-
-        with open(filename, "w") as outfile:
-            for i in range(len(spectrum)):
-                if self.interpolated_x_axis_cm:
-                    x = self.interpolated_x_axis_cm[i]
-                elif self.interpolated_x_axis_nm:
-                    x = self.interpolated_x_axis_nm[i]
-                elif self.device.settings.wavenumbers:
-                    x = self.device.settings.wavenumbers[i]
-                else:
-                    x = self.device.settings.wavelengths[i]
-                outfile.write("%.2f,%.2f\n" % (x, spectrum[i]))
-
-    def get_spectrum_pretty(self):
-        spectrum = self.get_spectrum()
-        if spectrum is None:
-            return 
-
-        if self.interpolated_x_axis_cm:
-            x_axis = self.interpolated_x_axis_cm
-            x_unit = "cm-1"
-        elif self.interpolated_x_axis_nm:
-            x_axis = self.interpolated_x_axis_nm
-            x_unit = "nm"
-        elif self.device.settings.wavenumbers:
-            x_axis = self.device.settings.wavenumbers
-            x_unit = "cm-1"
-        else:
-            x_axis = self.device.settings.wavelengths
-            x_unit = "nm"
-
-        lines = utils.ascii_spectrum(spectrum=spectrum, rows=24, cols=80, x_axis=x_axis, x_unit=x_unit)
-        for line in lines:
-            self.display(line)
-
-    def set_laser_enable(self, flag, quiet=False):
-        self.device.change_setting("laser_enable", flag)
-        return None if quiet else self.display(1)
-
-    ## should use numpy.arange
-    def generate_interpolated_x_axis(self, start, end, incr):
-        if incr == 0 or start >= end:
-            return [ start ]
-
-        axis = []
-        x = start
-        while x <= end:
-            axis.append(x)
-            x += incr
-        return axis
-                
-    def set_interpolated_x_axis_cm(self, start, end, incr):
-        self.interpolated_x_axis_cm = self.generate_interpolated_x_axis(start, end, incr)
-        self.display(1)
-
-    def set_interpolated_x_axis_nm(self, start, end, incr):
-        self.interpolated_x_axis_nm = self.generate_interpolated_x_axis(start, end, incr)
-        self.display(1)
-
-    def clear(self):
-        self.interpolated_x_axis_nm = None
-        self.interpolated_x_axis_cm = None
-        # ...more...
-
-    ## takes mode [integ, laser, laser_and_integ], intensity, threshold, x, unit [px, nm, cm]
-    def balance_acquisition(self):
-        mode                    = "integration" if not self.has_input() else self.read_str()
-        intensity               = 45000         if not self.has_input() else self.read_float()
-        threshold               = 2500          if not self.has_input() else self.read_float()
-        max_integration_time_ms = 5000          if not self.has_input() else self.read_int()
-        max_tries               = 20            if not self.has_input() else self.read_int()
-        x_value                 = None          if not self.has_input() else self.read_float()
-        unit                    = "px"          if not self.has_input() else self.read_str()
-
-        if not re.match('(px|cm|nm)$', unit):
-            return self.display("ERROR: invalid unit " + s)
-
-        pixel = None
-        if x_value is not None:
-            if unit == "px":
-                pixel = int(x_value)
-            elif unit == "nm":
-                pixel = utils.find_nearest_index(self.device.settings.wavelengths, x_value)
-            elif unit == "cm" and self.device.settings.wavenumbers:
-                pixel = utils.find_nearest_index(self.device.settings.wavenumbers, x_value)
-            else:
-                return self.display("ERROR: can't determine pixel from %s %s" % (x_value, unit))
-
-        ok = self.device.balance_acquisition(
-                mode                    = mode, 
-                intensity               = intensity, 
-                threshold               = threshold, 
-                pixel                   = pixel, 
-                max_integration_time_ms = max_integration_time_ms, 
-                max_tries               = max_tries)
-
-        if ok:
-            self.display("Ok integration_time_ms %s laser_power %s %s" % (
-                self.device.settings.state.integration_time_ms,
-                self.device.settings.state.laser_power, 
-                "mW" if self.device.settings.state.laser_power_in_mW else "percent"))
-        else:
-            self.display(0)
-
-    def get_all(self):
-        for command in sorted(self.gettors):
-            func_name = self.gettors[command]
-            value = getattr(self.device.hardware, func_name)()
-            if isinstance(value, bool):
-                value = 1 if value else 0
-            self.display("%-40s: %s" % (command, value))
-
-# ##############################################################################
-# main()
-# ##############################################################################
-
-shell = None
-if __name__ == "__main__":
-    shell = WasatchShell()
-    shell.run()
+#!/usr/bin/env python -u
+
+import datetime
+import platform
+import argparse
+import logging
+import time
+import sys
+import os
+import re
+
+import wasatch
+
+from wasatch import utils
+from wasatch.WasatchBus         import WasatchBus
+from wasatch.WasatchDevice      import WasatchDevice
+from wasatch.BalanceAcquisition import BalanceAcquisition
+from wasatch.RealUSBDevice      import RealUSBDevice
+from wasatch.SpectrometerResponse import SpectrometerResponse
+from wasatch.SpectrometerResponse import ErrorLevel
+
+VERSION = "2.3.0"
+
+log = logging.getLogger(__name__)
+
+## 
+# An interactive wrapper over a wasatch.WasatchDevice.
+#
+# EXAMPLE:
+# \verbatim
+#   $ ./wasatch-shell.py [--logfile path]
+#   open
+#   set_integration_time_ms
+#   100
+#   get_spectrum
+#   close
+# \endverbatim
+#
+# @todo currently there is no support for scan averaging.  That is because 
+#       scan averaging is built into WasatchDevice.acquire_data, and configured
+#       via Feature
+class WasatchShell(object):
+    
+    def __init__(self):
+        self.device = None                      # wasatch.WasatchDevice
+        self.clear()
+
+        # process command-line options
+        parser = argparse.ArgumentParser()
+        parser.add_argument("--eod", action="store_true", help="output END_OF_DATA on a line by itself following every action")
+        parser.add_argument("--logfile", help="where to write log messages")
+        parser.add_argument("--log-level", type=str, default="info", help="logging level", choices=['debug', 'info', 'warning', 'error', 'critical'])
+        parser.add_argument("--timestamp", action="store_true", help="timestamp console messages")
+        self.args = parser.parse_args()
+
+        self.configure_logging()
+        self.input_tokens = None
+        self.dark_spectra = None
+        self.srm = False
+
+        # pass-through calls to any of these gettors (note names are lowercased)
+        # SR = SpectrometerResponse
+        self.gettors = {}
+        for func_name in [ 
+            "get_actual_frames",                        # SR
+            "get_actual_integration_time_us",           # SR
+            "get_ambient_temperature_degC",             # SR
+            "get_ccd_sensing_threshold",                # SR
+            "get_ccd_threshold_sensing_mode",           # SR
+            "get_dac",                                  # SR
+            "get_detector_gain",                        # SR
+            "get_detector_gain_odd",                    # SR
+            "get_detector_offset",                      # raw (now SR)
+            "get_detector_offset_odd",                  # raw (now SR)
+            "get_detector_tec_setpoint_degC",           # SR
+            "get_detector_tec_setpoint_raw",            # SR
+            "get_detector_temperature_degC",            # SR
+            "get_detector_temperature_raw",             # SR
+            "get_external_trigger_output",              # SR
+            "get_fan_enabled",                          # SR
+            "get_fpga_firmware_version",                # SR
+            "get_high_gain_mode_enabled",               # SR
+            "get_integration_time_ms",                  # SR
+            "get_lamp_enabled",                         # SR
+            "get_laser_enabled",                        # SR
+            "get_laser_interlock",                      # SR
+            "get_laser_temperature_degC",               # SR
+            "get_laser_temperature_raw",                # SR
+            "get_laser_watchdog_sec",                   # SR
+            "get_microcontroller_firmware_version",     # SR
+            "get_mod_delay_us",                         # SR
+            "get_mod_duration_us",                      # SR
+            "get_mod_enabled",                          # SR
+            "get_mod_linked_to_integration",            # SR
+            "get_mod_period_us",                        # SR
+            "get_mod_width_us",                         # SR
+            "get_opt_actual_integration_time",          # SR
+            "get_opt_area_scan",                        # SR
+            "get_opt_cf_select",                        # SR
+            "get_opt_data_header_tab",                  # SR
+            "get_opt_has_laser",                        # SR
+            "get_opt_horizontal_binning",               # SR
+            "get_opt_integration_time_resolution",      # SR
+            "get_opt_laser_control",                    # SR
+            "get_raman_delay_ms",                       # SR
+            "get_secondary_adc_calibrated",             # SR
+            "get_secondary_adc_raw",                    # SR
+            "get_selected_adc",                         # SR
+            "get_selected_laser",                       # SR
+            "get_sensor_line_length",                   # SR
+            "get_shutter_enabled",                      # SR
+            "get_strobe_enabled",                       # SR
+            "get_tec_enabled",                          # SR
+            "get_trigger_delay",                        # SR
+            "get_trigger_source",                       # SR
+            "get_vr_continuous_ccd",                    # SR
+            "get_vr_num_frames",                        # SR
+            "has_linearity_coeffs" ]:                   # BOOL
+            self.gettors[func_name.lower()] = func_name
+
+    # ##############################################################################
+    # Utility Functions
+    # ##############################################################################
+
+    def usage(self):
+        print("Version: %s" % VERSION)
+        print("""The following commands are supported:
+        help                                   - this screen
+        version                                - program and library versions
+                                               
+        open                                   - initialize connected spectrometer
+        close                                  - exit program (synonyms 'exit', 'quit')
+        connection_check                       - confirm communication
+        clear                                  - reset interpolated x axes
+                                               
+        set_scans_to_average                   - takes integer argument
+        set_integration_time_ms                - takes integer argument
+        set_laser_enable                       - takes bool argument (on/off, true/false, 1/0)
+        set_laser_power_mw                     - takes float argument
+        set_laser_power_perc                   - takes int argument
+        set_laser_watchdog_sec                 - takes integer argument
+        set_acquisition_laser_trigger_enable   - takes bool argument
+        set_acquisition_laser_trigger_delay_ms - takes float argument
+        set_tec_enable                         - takes bool argument
+        set_detector_tec_setpoint_degc         - takes float argument
+        set_detector_offset                    - override the "offset" added to pixel readings
+        set_selected_laser                     - takes 0 or 1
+        set_raman_mode                         - takes 0 or 1
+        set_raman_delay_ms                     - takes integer argument
+                                               
+        set_fan_enable                         - takes bool argument
+        set_lamp_enable                        - takes bool argument
+        set_shutter_enable                     - takes bool argument
+        set_strobe_enable                      - takes bool argument
+        set_mod_enable                         - takes bool argument
+        set_mod_period_us                      - takes int argument
+        set_mod_width_us                       - takes int argument
+        set_mod_delay_us                       - takes int argument
+
+        set_interpolated_x_axis_cm             - takes start, end, incr (zero incr to disable)
+        set_interpolated_x_axis_nm             - takes start, end, incr (zero incr to disable)
+        balance_acquisition                    - takes mode [integ, laser, laser_and_integ], 
+                                                    intensity, threshold, max_integration_time_ms, 
+                                                    max_tries, x, unit [px, nm, cm]
+                                               
+        get_spectrum                           - print received spectrum
+        set_raman_intensity_correction_enable  - takes bool argument
+        get_dark                               - captures spectrum and stores as dark
+        clear_dark                             - clears a stored dark spectrum
+        get_spectrum_pretty                    - graph received spectrum
+        get_spectrum_save                      - save spectrum to filename as CSV
+        get_config_json                        - return EEPROM as JSON string
+        get_all                                - calls all gettors
+        """)
+        print("The following gettors are also available:")
+        for k in sorted(self.gettors.keys()):
+            print("        %s" % k)
+
+    def disconnected(self):
+        self.display("ERROR: no device connected")
+
+    ## encapsulating in case any platforms don't like GNU readline
+    def get_line(self, prompt="args> "):
+        return input(prompt).strip()
+
+    def has_input(self):
+        return self.input_tokens is not None and len(self.input_tokens) > 0
+
+    def get_next_token(self):
+        while not self.has_input():
+            line = self.get_line()
+            log.info("<< %s", line)
+            self.input_tokens = [s.strip() for s in line.lower().strip().split()]
+        return self.input_tokens.pop(0)
+
+    def read_bool(self):
+        s = self.get_next_token()
+        return re.match("1|true|yes|on", s.lower()) is not None
+
+    def read_int(self):
+        return int(self.get_next_token())
+
+    def read_float(self):
+        return float(self.get_next_token())
+
+    def read_str(self):
+        return self.get_next_token()
+
+    def display(self, msg):
+        log.info(">> %s", msg)
+        print(msg)
+        sys.stdout.flush()
+
+    def configure_logging(self):
+        logging.basicConfig(filename=(self.args.logfile if self.args.logfile else ("wasatch-%s.log" % utils.timestamp())),
+                            level=self.args.log_level.upper(),
+                            format='%(asctime)s.%(msecs)03d %(name)s %(levelname)-8s %(message)s', 
+                            datefmt='%m/%d/%Y %I:%M:%S')
+
+    # ##############################################################################
+    # command loop
+    # ##############################################################################
+
+    def run(self):
+        self.display("-" * 80)
+        self.display("wasatch-shell version %s invoked (Wasatch.PY %s)" % (VERSION, wasatch.version))
+
+        try:
+            while True:
+                prompt = "wp> " if not self.args.timestamp else str(datetime.datetime.now()) + " wp> "
+                line = self.get_line(prompt)
+
+                # ignore comments
+                if line.startswith('#') or len(line) == 0:
+                    continue
+
+                log.info("<< %s", line)
+
+                # tokenize
+                self.input_tokens = [s.strip() for s in line.lower().strip().split()]
+                command = self.read_str()
+
+                # these commands always work
+                if command == "help":
+                    self.usage()
+                    continue
+
+                elif command == "version":
+                    self.display("WasatchShell version: %s" % VERSION)
+                    self.display("Wasatch.PY   version: %s" % wasatch.version)
+                    continue
+
+                if re.match("close|quit|exit", command):
+                    break
+
+                # these commands work if currently closed
+                if self.device is None:
+                    if command == "open":
+                        self.display(1 if self.open() else 0)
+                    else:
+                        self.display("ERROR: must open spectrometer first")
+
+                else:
+                    try:
+                        # anything past this point assumes spectrometer already open
+
+                        # pass-through gettors
+                        if command in self.gettors:
+                            self.run_gettor(command)
+                            
+                        # special processing for these
+                        elif command == "get_spectrum":
+                            self.get_spectrum(quiet=False)
+
+                        elif command == "get_dark":
+                            self.get_dark()
+                            self.display(1)
+
+                        elif command == "clear_dark":
+                            self.clear_dark()
+                            self.display(1)
+
+                        elif command == "get_spectrum_pretty":
+                            self.get_spectrum_pretty()
+
+                        elif command == "get_spectrum_save":
+                            self.get_spectrum_save()
+
+                        elif command == "get_config_json":
+                            self.display(self.device.settings.eeprom.json(allow_nan=False))
+
+                        elif command == "get_all":
+                            self.get_all()
+
+                        elif command == "connection_check":
+                            self.run_gettor("get_integration_time_ms")
+
+                        elif command == "balance_acquisition":
+                            self.balance_acquisition()
+
+                        elif command == "set_interpolated_x_axis_cm":
+                            self.set_interpolated_x_axis_cm(start = self.read_float(),
+                                                            end   = self.read_float(),
+                                                            incr  = self.read_float())
+
+                        elif command == "set_interpolated_x_axis_nm":
+                            self.set_interpolated_x_axis_nm(start = self.read_float(),
+                                                            end   = self.read_float(),
+                                                            incr  = self.read_float())
+
+                        elif command == "set_raman_intensity_correction_enable":
+                            self.set_raman_intensity_correction_enable(self.device, self.read_bool())
+
+                        elif command == "clear":
+                            self.clear()
+
+                        # currently these are the only setters implemented
+                        #
+                        # These originally called directly into 
+                        # FeatureIdentificationDevice, which was efficient, but:
+                        #
+                        #   1. missed value-add processing in WasatchDevice.change_setting, 
+                        #   2. couldn't utilize inline (non functional) 
+                        #      implementations in FID.write_setting,
+                        #   3. provided no obvious path to achieve scan averaging 
+                        #      (issues 1 and 2)
+                        #   4. potentially differed than ENLIGHTEN processing 
+                        #      while failing to exercise ENLIGHTEN communication
+                        #      path (part of the script's purpose)
+                        #
+                        # Therefore, setters now utilize WasatchDevice.change_setting 
+                        # where possible.
+                        #
+                        # An obvious CONSEQUENCE of using change_setting() over 
+                        # direct FID function calls is that no return value is 
+                        # possible on "settor" functions :-(
+
+                        elif command == "set_integration_time_ms":
+                            self.device.change_setting("integration_time_ms", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_laser_watchdog_sec":
+                            self.device.change_setting("laser_watchdog_sec", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_raman_delay_ms":
+                            self.device.change_setting("raman_delay_ms", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_raman_mode":
+                            self.device.change_setting("raman_mode_enable", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_laser_power_mw":
+                            self.device.change_setting("laser_power_mW", self.read_float())
+                            self.display(1)
+
+                        elif command == "set_laser_power_perc":
+                            self.device.change_setting("laser_power_perc", self.read_float())
+                            self.display(1)
+
+                        elif command == "set_laser_enable":
+                            self.set_laser_enable(flag = self.read_bool())
+
+                        elif command == "set_laser_power_high_resolution":
+                            self.device.change_setting("laser_power_high_resolution", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_tec_enable":
+                            self.device.change_setting("detector_tec_enable", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_detector_tec_setpoint_degc":
+                            self.device.change_setting("detector_tec_setpoint_degC", self.read_float())
+                            self.display(1)
+
+                        elif command == "set_detector_offset":
+                            self.device.change_setting("detector_offset", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_scans_to_average":
+                            self.device.change_setting("scans_to_average", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_acquisition_laser_trigger_enable":
+                            self.device.change_setting("acquisition_laser_trigger_enable", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_acquisition_laser_trigger_delay_ms":
+                            self.device.change_setting("acquisition_laser_trigger_delay_ms", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_selected_laser":
+                            self.device.change_setting("selected_laser", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_fan_enable":
+                            self.device.change_setting("fan_enable", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_lamp_enable":
+                            self.device.change_setting("lamp_enable", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_shutter_enable":
+                            self.device.change_setting("shutter_enable", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_strobe_enable":
+                            self.device.change_setting("strobe_enable", self.read_bool())
+                            self.display(1)
+
+                        elif command == "set_mod_period_us":
+                            self.device.change_setting("mod_period_us", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_mod_width_us":
+                            self.device.change_setting("mod_width_us", self.read_int())
+                            self.display(1)
+
+                        elif command == "set_mod_delay_us":
+                            self.device.change_setting("mod_period_us", self.read_int())
+                            self.display(1)
+
+                        elif command == "open":
+                            # if user re-sends open command when already open, do nothing
+                            self.display(1)
+
+                        else:
+                            self.display("ERROR: unknown command: " + command)
+                    except Exception as ex:
+                        log.critical("caught exception", exc_info=1)
+                        log.info("disconnecting")
+                        self.device.disconnect()
+                        self.device = None
+
+                        log.info("sleeping 5sec")
+                        time.sleep(5.100)
+                        
+                        log.info("re-opening")
+                        if self.open():
+                            log.info("successfully re-opened")
+                        else:
+                            log.error("could not re-open...giving up")
+                            break
+
+                if self.args.eod:
+                    self.display("END_OF_DATA")
+
+                # whatever happened, flush stdout
+                try:
+                    sys.stdout.flush()
+                except:
+                    self.display("ERROR: caller has closed stdout...exiting")
+                    break
+
+        except Exception as e:
+            log.error(e, exc_info=1)
+            raise
+
+        # disable the laser if connected
+        if self.device is not None:
+            self.set_laser_enable(False, quiet=True)
+            self.device.disconnect()
+            self.device = None
+
+        log.info("wasatch-shell exiting")
+
+    ## 
+    # If the current device is disconnected, and there is a new device, 
+    # attempt to connect to it. """
+    def open(self):
+        # if we're already connected, nevermind
+        if self.device is not None:
+            return False
+
+        # lazy-load a USB bus
+        log.debug("instantiating WasatchBus")
+        bus = WasatchBus()
+        if not bus.device_ids:
+            self.display("No Wasatch USB spectrometers found.")
+            return False
+
+        device_id = bus.device_ids[0]
+        log.debug("open: trying to connect to %s", device_id)
+        device_id.device_type = RealUSBDevice(device_id)
+        device = WasatchDevice(device_id)
+
+        ok = device.connect()
+        if not ok.data: 
+            log.critical("open: can't connect to device on bus 1")
+            return
+
+        log.info("open: device connected")
+        self.device = device
+
+        # enable exceptions
+        self.device.hardware.raise_exceptions = True
+
+        # enable immediate mode (don't queue commands until acquire_data)
+        self.device.immediate_mode = True
+
+        # enable bare readings (don't query extra hardware metadata during acquisitions)
+        self.device.bare_readings = True
+
+        # disable free-running mode (interactive shell is the definition of "slaved to user commands")
+        self.device.change_setting("free_running_mode", False)
+
+        # laser should not be on, but even so
+        self.set_laser_enable(False, quiet=True)
+
+        # enable high-resolution laser power by default
+        self.device.change_setting("laser_power_high_resolution", True)
+
+        # if laser has power calibration, require it and initialize accordingly 
+        # (so if the user enables the laser, it won't fire at an out-of-bounds 
+        # 100% unmodulated)
+        if self.device.settings.eeprom.has_laser_power_calibration():
+            log.info("laser has power calibration, so requiring modulation and initializing to max-rated power in mW")
+            self.device.change_setting("laser_power_require_modulation", True)
+            self.device.change_setting("laser_power_mW", self.device.settings.eeprom.max_laser_power_mW)
+
+        # throw random errors
+        # self.device.hardware.random_errors = True
+
+        # validate gettors (in case this is used against a StrokerProtocol unit, for instance)
+        for func_name in list(self.gettors.keys()):
+            if not hasattr(device.hardware, self.gettors[func_name]):
+                self.display("WARNING: gettor %s (%s) not found in device" % (func_name, self.gettors[func_name]))
+                del self.gettors[func_name]
+
+        # default to minimum configured integration time
+        self.device.change_setting("integration_time_ms", self.device.settings.eeprom.min_integration_time_ms)
+
+        return True
+
+    def run_gettor(self, command):
+        func_name = self.gettors[command]
+        value = getattr(self.device.hardware, func_name)()
+
+        if isinstance(value, SpectrometerResponse):
+            if value.error_msg:
+                self.display(f"ERROR: {value.error_msg}")
+                return
+            value = value.data
+
+        if isinstance(value, bool):
+            self.display(1 if value else 0)
+        else:
+            self.display(value)
+
+    def get_dark(self):
+        spectrum = self.get_spectrum(quiet=True)
+        self.dark_spectra = spectrum
+
+    def clear_dark(self):
+        self.dark_spectra = None
+
+    def set_raman_intensity_correction_enable(self, device: WasatchDevice, status: bool): # -> int 
+        if not device.settings.eeprom.has_raman_intensity_calibration():
+            self.display("Device has no Raman Intensity Calibration")
+            self.srm = False
+            return
+        else:
+            self.srm = status
+            self.display(1)
+            return
+
+    def srm_process(self, spectrum: list[float], device: WasatchDevice): # -> list[float] 
+
+        factors = device.settings.raman_intensity_factors
+        if factors is None or len(factors) != len(spectrum):
+            return 
+
+        spectrum = [px*fac for px, fac in zip(spectrum,factors)]
+        return spectrum
+
+    ##
+    # This calls WasatchDevice.acquire_data, rather than FID.get_line, because 
+    # scan averaging, bad-pixel correction, acquisition laser trigger and other
+    # high-level acquisition features are implemented in WasatchDevice rather 
+    # than FID.
+    def get_spectrum(self, quiet=True):
+        # enqueue ACQUIRE command, as we're not in free-running mode
+        self.device.change_setting("acquire", True, allow_immediate=False)
+
+        # now collect the spectrum
+        reading_response = self.device.acquire_data()
+        reading = reading_response.data
+        if reading is None or isinstance(reading, bool) or reading.spectrum is None:
+            self.display("ERROR: get_spectrum failed")
+            return
+        spectrum = reading.spectrum
+        if self.dark_spectra is not None and len(self.dark_spectra) == len(spectrum):
+            spectrum = [spec-dark for spec, dark in zip(spectrum, self.dark_spectra)]
+        log.debug("received %d pixels", len(spectrum))
+
+        if self.srm:
+            spectrum = self.srm_process(spectrum, self.device)
+
+        if self.interpolated_x_axis_cm and self.device.settings.wavenumbers:
+            spectrum = utils.interpolate_array(spectrum, 
+                                               self.device.settings.wavenumbers, 
+                                               self.interpolated_x_axis_cm)
+        elif self.interpolated_x_axis_nm:
+            spectrum = utils.interpolate_array(spectrum, 
+                                               self.device.settings.wavelengths, 
+                                               self.interpolated_x_axis_nm)
+        if quiet:
+            return spectrum
+
+        for pixel in spectrum:
+            print(pixel)
+
+    def get_spectrum_save(self):
+        spectrum = self.get_spectrum()
+        if spectrum is None:
+            return 
+
+        if self.has_input():
+            filename = self.read_str()
+        else:
+            filename = datetime.datetime.now().strftime("%Y%m%d-%H%M%S.csv")
+
+        with open(filename, "w") as outfile:
+            for i in range(len(spectrum)):
+                if self.interpolated_x_axis_cm:
+                    x = self.interpolated_x_axis_cm[i]
+                elif self.interpolated_x_axis_nm:
+                    x = self.interpolated_x_axis_nm[i]
+                elif self.device.settings.wavenumbers:
+                    x = self.device.settings.wavenumbers[i]
+                else:
+                    x = self.device.settings.wavelengths[i]
+                outfile.write("%.2f,%.2f\n" % (x, spectrum[i]))
+
+    def get_spectrum_pretty(self):
+        spectrum = self.get_spectrum()
+        if spectrum is None:
+            return 
+
+        if self.interpolated_x_axis_cm:
+            x_axis = self.interpolated_x_axis_cm
+            x_unit = "cm-1"
+        elif self.interpolated_x_axis_nm:
+            x_axis = self.interpolated_x_axis_nm
+            x_unit = "nm"
+        elif self.device.settings.wavenumbers:
+            x_axis = self.device.settings.wavenumbers
+            x_unit = "cm-1"
+        else:
+            x_axis = self.device.settings.wavelengths
+            x_unit = "nm"
+
+        lines = utils.ascii_spectrum(spectrum=spectrum, rows=24, cols=80, x_axis=x_axis, x_unit=x_unit)
+        for line in lines:
+            self.display(line)
+
+    def set_laser_enable(self, flag, quiet=False):
+        self.device.change_setting("laser_enable", flag)
+        return None if quiet else self.display(1)
+
+    ## should use numpy.arange
+    def generate_interpolated_x_axis(self, start, end, incr):
+        if incr == 0 or start >= end:
+            return [ start ]
+
+        axis = []
+        x = start
+        while x <= end:
+            axis.append(x)
+            x += incr
+        return axis
+                
+    def set_interpolated_x_axis_cm(self, start, end, incr):
+        self.interpolated_x_axis_cm = self.generate_interpolated_x_axis(start, end, incr)
+        self.display(1)
+
+    def set_interpolated_x_axis_nm(self, start, end, incr):
+        self.interpolated_x_axis_nm = self.generate_interpolated_x_axis(start, end, incr)
+        self.display(1)
+
+    def clear(self):
+        self.interpolated_x_axis_nm = None
+        self.interpolated_x_axis_cm = None
+        # ...more...
+
+    ## takes mode [integ, laser, laser_and_integ], intensity, threshold, x, unit [px, nm, cm]
+    def balance_acquisition(self):
+        mode                    = "integration" if not self.has_input() else self.read_str()
+        intensity               = 45000         if not self.has_input() else self.read_float()
+        threshold               = 2500          if not self.has_input() else self.read_float()
+        max_integration_time_ms = 5000          if not self.has_input() else self.read_int()
+        max_tries               = 20            if not self.has_input() else self.read_int()
+        x_value                 = None          if not self.has_input() else self.read_float()
+        unit                    = "px"          if not self.has_input() else self.read_str()
+
+        if not re.match('(px|cm|nm)$', unit):
+            return self.display("ERROR: invalid unit " + s)
+
+        pixel = None
+        if x_value is not None:
+            if unit == "px":
+                pixel = int(x_value)
+            elif unit == "nm":
+                pixel = utils.find_nearest_index(self.device.settings.wavelengths, x_value)
+            elif unit == "cm" and self.device.settings.wavenumbers:
+                pixel = utils.find_nearest_index(self.device.settings.wavenumbers, x_value)
+            else:
+                return self.display("ERROR: can't determine pixel from %s %s" % (x_value, unit))
+
+        ok = self.device.balance_acquisition(
+                mode                    = mode, 
+                intensity               = intensity, 
+                threshold               = threshold, 
+                pixel                   = pixel, 
+                max_integration_time_ms = max_integration_time_ms, 
+                max_tries               = max_tries)
+
+        if ok:
+            self.display("Ok integration_time_ms %s laser_power %s %s" % (
+                self.device.settings.state.integration_time_ms,
+                self.device.settings.state.laser_power, 
+                "mW" if self.device.settings.state.laser_power_in_mW else "percent"))
+        else:
+            self.display(0)
+
+    def get_all(self):
+        for command in sorted(self.gettors):
+            func_name = self.gettors[command]
+            value = getattr(self.device.hardware, func_name)()
+            if isinstance(value, bool):
+                value = 1 if value else 0
+            self.display("%-40s: %s" % (command, value))
+
+# ##############################################################################
+# main()
+# ##############################################################################
+
+shell = None
+if __name__ == "__main__":
+    shell = WasatchShell()
+    shell.run()
```

### Comparing `wasatch-2.1.24/demo-simple.py` & `wasatch-2.1.32/demo-simple.py`

 * *Files 8% similar despite different names*

```diff
@@ -16,14 +16,16 @@
 ################################################################################
 
 from wasatch.WasatchBus    import WasatchBus
 from wasatch.WasatchDevice import WasatchDevice
 
 bus = WasatchBus()
 if not bus.device_ids:
+    import sys
+    
     print("no spectrometers found")
     sys.exit(1)
 
 device_id = bus.device_ids[0]
 print("found %s" % device_id)
 
 device = WasatchDevice(device_id)
@@ -39,14 +41,14 @@
     device.settings.wavelengths[-1]))
 
 print("setting integration time")
 device.hardware.set_integration_time_ms(10)
 # or: device.change_setting("integration_time_ms", 10)
 
 print("reading spectrum")
-spectrum = device.hardware.get_line().spectrum
+spectrum = device.hardware.get_line().data.spectrum
 # or: spectrum = device.acquire_data().spectrum
 
 for pixel in range(device.settings.pixels()):
     print("%8.2f %8.2f" % (device.settings.wavelengths[pixel], spectrum[pixel]))
 
 print("done")
```

### Comparing `wasatch-2.1.24/demo-virtual.py` & `wasatch-2.1.32/demo-virtual.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/demo-workflow.py` & `wasatch-2.1.32/demo-workflow.py`

 * *Files 2% similar despite different names*

```diff
@@ -25,15 +25,15 @@
 
 class Workflow:
 
     def __init__(self, integ_time_ms, laser_power_mW):
         self.integ_time_ms = integ_time_ms
         self.laser_power_mW = laser_power_mW
 
-    def connect(self) -> bool:
+    def connect(self): # -> bool 
         bus = WasatchBus(use_sim=False)
         if not bus.device_ids:
             print("No Wasatch USB spectrometers found.")
             return False
 
         device_id = bus.device_ids[0]
         print(f"connecting to {device_id}")
@@ -82,15 +82,15 @@
 
             # debugging
             with open(TEMPFILE, "w") as outfile:
                 outfile.write("\n".join([f"{x:0.2f}" for x in spectrum]))
 
             return np.asarray(spectrum)
 
-    def test_working_distance(self) -> bool:
+    def test_working_distance(self): # -> bool 
         print("-" * 50)
         print("Please insert calibration sample and press <Enter> (ctrl-C to exit)...", end='')
         try:
             input()
         except:
             print("Program exiting")
             sys.exit(1)
```

### Comparing `wasatch-2.1.24/demo.py` & `wasatch-2.1.32/demo.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/screenshots/multiplatform.png` & `wasatch-2.1.32/screenshots/multiplatform.png`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/scripts/dark-vs-integ.py` & `wasatch-2.1.32/scripts/dark-vs-integ.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/scripts/deploy` & `wasatch-2.1.32/scripts/deploy`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/setup.cfg` & `wasatch-2.1.32/setup.cfg`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/testSpectrometers/SiG_785/eeprom/EEPROM-EM-9c65d19f4c.json` & `wasatch-2.1.32/testSpectrometers/SiG_785/eeprom/EEPROM-EM-9c65d19f4c.json`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/testSpectrometers/SiG_785/readings/enlighten-20210329-094722-799520-WP-00686.csv` & `wasatch-2.1.32/testSpectrometers/SiG_785/readings/enlighten-20210329-094722-799520-WP-00686.csv`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/testSpectrometers/SiG_785/readings/enlighten-20210329-094755-288958-WP-00686.csv` & `wasatch-2.1.32/testSpectrometers/SiG_785/readings/enlighten-20210329-094755-288958-WP-00686.csv`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/testSpectrometers/WP-00887/eeprom/WP-00887-mock.json` & `wasatch-2.1.32/testSpectrometers/WP-00887/eeprom/WP-00887-mock.json`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/testSpectrometers/WP-00904/eeprom/WP-00904-mock.json` & `wasatch-2.1.32/testSpectrometers/WP-00904/eeprom/WP-00904-mock.json`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/testSpectrometers/WP-00913/eeprom/WP-00913-mock.json` & `wasatch-2.1.32/testSpectrometers/WP-00913/eeprom/WP-00913-mock.json`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/tests/noise-by-setpoint.py` & `wasatch-2.1.32/tests/noise-by-setpoint.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/tests/queues.py` & `wasatch-2.1.32/tests/queues.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/AndorDevice.py` & `wasatch-2.1.32/wasatch/AndorDevice.py`

 * *Files 4% similar despite different names*

```diff
@@ -22,53 +22,57 @@
 log = logging.getLogger(__name__)
 
 class AndorDevice(InterfaceDevice):
     """
     This is the basic implementation of our interface with Andor cameras     
 
     @todo have check_result return a SpectrometerResponse 
+    @todo try to auto-detect whether x-axis needs inverted via DLL.GetImageFlip()
+
     ##########################################################################
-    This class adopts the external device interface structure
-    This involves receiving a request through the handle_request function
-    A request is processed based on the key in the request
-    The processing function passes the commands to the requested device
+    This class adopts the external device interface structure.
+    This involves receiving a request through the handle_request function.
+    A request is processed based on the key in the request.
+    The processing function passes the commands to the requested device.
     Once it receives a response from the connected device it then passes that
-    back up the chain
+    back up the chain.
+    @verbatim
                                Enlighten Request
                                        |
                                 handle_requests
                                        |
                                  ------------
-                                /   /  |  \  \
+                                /   /  |  \  \  
              { get_laser status, acquire, set_laser_watchdog, etc....}
                                 \   \  |  /  /
                                  ------------
                                        |
                          {self.driver.some_andor_sdk_call}
+    @endverbatim
     ############################################################################
     """
 
     SUCCESS = 20002             #!< see load_error_codes()
-    SHUTTER_SPEED_MS = 50       #!< empirically determined
+    SHUTTER_SPEED_MS = 50       #!< allow time for mechanical shutter to stabilize
 
-    def __init__(self, device_id, message_queue=None) -> None:
+    def __init__(self, device_id, message_queue=None): # -> None 
         # if passed a string representation of a DeviceID, deserialize it
         super().__init__()
         if type(device_id) is str:
             device_id = DeviceID(label=device_id)
 
         self.device_id      = device_id
         self.message_queue  = message_queue
 
         self.load_error_codes()
 
         self.connected = False
 
         # Receives ENLIGHTEN's 'change settings' commands in the spectrometer
-        # process. Although a logical queue, has nothing to do with multiprocessing.
+        # process. 
         self.command_queue = []
 
         self.immediate_mode = False
 
         self.settings = SpectrometerSettings(self.device_id)
         self.summed_spectra         = None
         self.sum_count              = 0
@@ -109,14 +113,15 @@
                     log.error(f"Error loading {pathname}: {e}")
 
                 if self.driver is not None:
                     break
 
         if self.driver is None:
             log.error(f"could not find {filename} in search path: {dll_paths}")
+            # MZ: interesting that we don't return here
 
         # "serial_number", "model" etc are ambiguous in an Andor configuration 
         # file -- do they refer to the camera (Andor), or the spectrometer 
         # (Wasatch)?  Therefore, some Wasatch EEPROM fields get extra "wp_" 
         # prefixes in Andor configuration files to be clear.
         self.config_names_to_eeprom = {
             'wp_serial_number': 'serial_number',
@@ -138,15 +143,15 @@
 
         self.process_f = self._init_process_funcs()
 
     ###############################################################
     # Private Methods
     ###############################################################
 
-    def _init_process_funcs(self) -> dict[str, Callable[..., Any]]:
+    def _init_process_funcs(self): # -> dict[str, Callable[..., Any]] 
         process_f = {}
 
         process_f["connect"] = self.connect
         process_f["acquire_data"] = self.acquire_data
         process_f["set_shutter_enable"] = self.set_shutter_enable
         process_f["set_integration_time_ms"] = self.set_integration_time_ms
         process_f["get_serial_number"] = self.get_serial_number
@@ -166,77 +171,74 @@
         process_f["fan_enable"] = lambda x: self.set_fan_enable(bool(x))
         process_f["shutter_enable"] = lambda x: self.set_shutter_enable(bool(x))
         process_f["detector_tec_enable"]                = lambda x: self.toggle_tec(bool(x))
         process_f["detector_tec_setpoint_degC"]         = lambda x: self.set_tec_setpoint(int(round(x)))
 
         return process_f
 
-    def high_gain_mode_enable(self, enabled: bool) -> SpectrometerResponse:
+    def high_gain_mode_enable(self, enabled: bool): # -> SpectrometerResponse 
         if enabled:
             result = self.driver.SetPreAmpGain(self.gain_idx[-1])
             assert(self.SUCCESS == result), f"unable to set detector gain, got value of {result}"
             log.debug(f"for {enabled} setting gain to {self.gain_options[-1]}")
             return
         else:
             result = self.driver.SetPreAmpGain(self.gain_idx[0])
             assert(self.SUCCESS == result), f"unable to set detector gain, got value of {result}"
             log.debug(f"for {enabled} setting gain to {self.gain_options[0]}")
             return
 
-
-    def _update_wavelength_coeffs(self, coeffs: list[float]) -> None:
+    # MZ: nothing seems to call this?
+    def _update_wavelength_coeffs(self, coeffs: list[float]): # -> None 
         self.settings.eeprom.wavelength_coeffs = coeffs
         self.config_values['wavelength_coeffs'] = coeffs
         self.save_config()
 
-    def set_fan_enable(self, x: bool) -> SpectrometerResponse:
+    def set_fan_enable(self, x: bool): # -> SpectrometerResponse 
         self.check_result(self.driver.SetFanMode(int(x)), f"Andor Fan On {x}")
         return SpectrometerResponse()
 
-    def _get_default_data_dir(self) -> str:
+    def _get_default_data_dir(self): # -> str 
         if os.name == "nt":
             return os.path.join(os.path.expanduser("~"), "Documents", "EnlightenSpectra")
         return os.path.join(os.environ["HOME"], "EnlightenSpectra")
 
-    def _check_config_file(self) -> bool:
+    def _check_config_file(self): # -> bool 
         self.config_dir = os.path.join(self._get_default_data_dir(), 'config')
         self.config_file = os.path.join(self.config_dir, self.serial + '.json')
         if not os.path.exists(self.config_dir):
             os.makedirs(self.config_dir)
         return os.path.isfile(self.config_file)
 
-    def _get_spectrum_raw(self) -> list[float]:
-        log.debug("requesting spectrum");
-        #################
-        # read spectrum
-        #################
-        #int[] spec = new int[pixels];
+    def _get_spectrum_raw(self): # -> list[float] 
+        """
+        @todo missing bad-pixel correction
+        """
         spec_arr = c_long * self.pixels
         spec_init_vals = [0] * self.pixels
         spec = spec_arr(*spec_init_vals)
 
         # ask for spectrum then collect, NOT multithreaded (though we should look into that!), blocks
-        #spec = new int[pixels];     //defaults to all zeros
         self.driver.StartAcquisition();
         self.driver.WaitForAcquisition();
         success = self.driver.GetAcquiredData(spec, c_ulong(self.pixels));
 
         if (success != self.SUCCESS):
             log.debug(f"getting spectra did not succeed. Received code of {success}. Returning")
             return
 
+        # convert from wasatch.AndorDevice.c_long_Array_512
         convertedSpec = [x for x in spec]
 
-        #if (self.eeprom.featureMask.invertXAxis):
-         #   convertedSpec.reverse()
+        if (self.settings.eeprom.invert_x_axis):
+            convertedSpec.reverse()
 
-        log.debug(f"getSpectrumRaw: returning {len(spec)} pixels");
         return convertedSpec;
 
-    def _take_one_averaged_reading(self) -> SpectrometerResponse:
+    def _take_one_averaged_reading(self): # -> SpectrometerResponse 
         averaging_enabled = (self.settings.state.scans_to_average > 1)
 
         if averaging_enabled and not self.settings.state.free_running_mode:
             # collect the entire averaged spectrum at once (added for
             # BatchCollection with laser delay)
             #
             # So: we're NOT in "free-running" mode, so we're basically being
@@ -325,20 +327,20 @@
 
         log.debug("device.take_one_averaged_reading: returning %s", reading)
         if reading.spectrum is not None and reading.spectrum != []:
             self.failure_count = 0
         # reading.dump_area_scan()
         return SpectrometerResponse(data=reading)
 
-    def _close_ex_shutter(self) -> SpectrometerResponse:
+    def _close_ex_shutter(self): # -> SpectrometerResponse 
         self.check_result(self.driver.SetShutterEx(1, 1, self.SHUTTER_SPEED_MS, self.SHUTTER_SPEED_MS, 2), "SetShutterEx(2)")
         self.settings.state.shutter_enabled = False
         return SpectrometerResponse(True)
 
-    def _open_ex_shutter(self) -> SpectrometerResponse:
+    def _open_ex_shutter(self): # -> SpectrometerResponse 
         self.check_result(self.driver.SetShutterEx(1, 1, self.SHUTTER_SPEED_MS, self.SHUTTER_SPEED_MS, 1), "SetShutterEx(1)")
         self.settings.state.shutter_enabled = True
         return SpectrometerResponse(True)
 
     ###############################################################
     # Public Methods
     ###############################################################
@@ -347,56 +349,65 @@
         if result != self.SUCCESS:
             name = self.get_error_code(result)
             msg = f"error calling {func}: {result} ({name})"
             log.error(msg)
             raise RuntimeError(msg)
         log.debug(f"successfully called {func}")
 
-    def connect(self) -> SpectrometerResponse:
+    def connect(self): # -> SpectrometerResponse 
         if self.dll_fail:
             return SpectrometerResponse(False, error_msg="can't find Andor DLL; please confirm Andor Driver Pack 2 installed")
 
         cameraHandle = c_int()
-        self.check_result(self.driver.GetCameraHandle(self.spec_index, byref(cameraHandle)), "GetCameraHandle")
-        self.check_result(self.driver.SetCurrentCamera(cameraHandle.value), "SetCurrentCamera")
+        self.check_result(self.driver.GetCameraHandle(self.spec_index, byref(cameraHandle)), "GetCameraHandle") # step 1
+        self.check_result(self.driver.SetCurrentCamera(cameraHandle.value), "SetCurrentCamera") # step 2
 
         try:
             path_to_ini = create_string_buffer(b'\000' * 256) 
-            self.check_result(self.driver.Initialize(path_to_ini), "Initialize")
+            self.check_result(self.driver.Initialize(path_to_ini), "Initialize") # step 3
         except:
             log.error("Andor.Initialize failed", exc_info=1)
             return SpectrometerResponse(False, error_msg="Andor initialization failed")
 
-        self.get_serial_number()
-        self.init_tec_setpoint()
-        self.init_detector_area()
+        # @todo missing: step 4 capabilities
+
+        self.get_serial_number() # step 16
+        self.init_tec_setpoint() # step 5+6
+        self.init_detector_area() # step 7
 
         if not self._check_config_file():
             self.config_values = {
                 'detector_serial_number': self.serial,
                 'wavelength_coeffs': [0,1,0,0],
                 'excitation_nm_float': 0,
-                }
+                'raman_intensity_coeffs': [],
+                'raman_intensity_calibration_order': 0,
+                'invert_x_axis': False 
+            }
             log.debug(f"connect: config file not found, so defaulting to these: {self.config_values}")
             self.save_config()
         else:
             self._load_config_values()
             log.debug(f"connect: loaded config file: {self.config_values}")
 
-        self.check_result(self.driver.CoolerON(), "CoolerON")
-        self.check_result(self.driver.SetAcquisitionMode(1), "SetAcquisitionMode(single_scan)") 
-        self.check_result(self.driver.SetTriggerMode(0), "SetTriggerMode")
-        self.check_result(self.driver.SetReadMode(0), "SetReadMode(full_vertical_binning)")
+        self.check_result(self.driver.CoolerON(), "CoolerON") # step 8
+        self.check_result(self.driver.SetAcquisitionMode(1), "SetAcquisitionMode(single_scan)") # step 9
+        self.check_result(self.driver.SetTriggerMode(0), "SetTriggerMode") # step 10
+        self.check_result(self.driver.SetReadMode(0), "SetReadMode(full_vertical_binning)") # step 11
 
-        self.init_detector_speed()
+        self.init_detector_speed() # step 12+13
 
+        # step 14
         self.check_result(self.driver.SetShutterEx(1, 1, self.SHUTTER_SPEED_MS, self.SHUTTER_SPEED_MS, 0), "SetShutterEx(fully automatic external with internal always open)")
         self.settings.state.shutter_enabled = True
 
+        # step 15
         self.set_integration_time_ms(self.settings.eeprom.startup_integration_time_ms)
+
+        # step 17 (WasatchNET doesn't do this)
         self._obtain_gain_info()
 
         # success!
         log.info("AndorDevice successfully connected")
 
         self.connected = True
         self.settings.eeprom.active_pixels_horizontal = self.pixels 
@@ -433,74 +444,77 @@
             if k in self.config_values:
                 setattr(self.settings.eeprom, v, self.config_values[k])
 
         # same spelling
         for k in [ 'model', 
                    'detector', 
                    'serial_number', 
+                   'invert_x_axis',
                    'wavelength_coeffs', 
                    'excitation_nm_float',
+                   'raman_intensity_coeffs',
+                   'raman_intensity_calibration_order',
                    'startup_temp_degC', 
                    'startup_integration_time_ms' ]:
             if k in self.config_values:
                 setattr(self.settings.eeprom, k, self.config_values[k])
 
         # post-load initialization
         if 'startup_temp_degC' in self.config_values:
             self.set_tec_setpoint(self.settings.eeprom.startup_temp_degC)
 
-    def acquire_data(self) -> SpectrometerResponse:
+    def acquire_data(self): # -> SpectrometerResponse 
         reading = self._take_one_averaged_reading()
         return reading
 
-    def set_shutter_enable(self, enable: bool) -> SpectrometerResponse:
+    def set_shutter_enable(self, enable: bool): # -> SpectrometerResponse 
         if enable:
             return self._open_ex_shutter()
         else:
             return self._close_ex_shutter()
 
-    def set_integration_time_ms(self, ms: float) -> SpectrometerResponse:
+    def set_integration_time_ms(self, ms: float): # -> SpectrometerResponse 
         self.integration_time_ms = ms
         log.debug(f"setting integration time to {self.integration_time_ms}ms")
 
         exposure = c_float()
         accumulate = c_float()
         kinetic = c_float()
 
         sec = ms / 1000.0
         self.check_result(self.driver.SetExposureTime(c_float(sec)), f"SetExposureTime({sec})")
         self.check_result(self.driver.GetAcquisitionTimings(byref(exposure), byref(accumulate), byref(kinetic)), "GetAcquisitionTimings")
         log.debug(f"read integration time of {exposure.value:.3f}sec (expected {ms}ms)")
         return SpectrometerResponse(data=True)
 
-    def get_serial_number(self) -> SpectrometerResponse:
+    def get_serial_number(self): # -> SpectrometerResponse 
         sn = c_int()
         self.check_result(self.driver.GetCameraSerialNumber(byref(sn)), "GetCameraSerialNumber")
         self.serial = f"CCD-{sn.value}"
         self.settings.eeprom.serial_number = self.serial # temporary
         self.settings.eeprom.detector_serial_number = self.serial
         log.debug(f"get_serial_number: connected to {self.serial}")
         return SpectrometerResponse(True)
 
-    def init_tec_setpoint(self) -> SpectrometerResponse:
+    def init_tec_setpoint(self): # -> SpectrometerResponse 
         minTemp = c_int()
         maxTemp = c_int()
-        self.check_result(self.driver.GetTemperatureRange(byref(minTemp), byref(maxTemp)), "GetTemperatureRange")
+        self.check_result(self.driver.GetTemperatureRange(byref(minTemp), byref(maxTemp)), "GetTemperatureRange") # step 5
 
         self.settings.eeprom.max_temp_degC = maxTemp.value
         self.settings.eeprom.min_temp_degC = minTemp.value
 
         # commenting-out because Andor camera is reporting -120C for a device 
         # only rated at -60C...leaving hardcoded default for now
         #
         # self.settings.eeprom.startup_temp_degC = minTemp.value 
 
         # however the startup temperature was set (hardcode, JSON, clamped to min)...apply it
-        self.setpoint_deg_c = self.settings.eeprom.startup_temp_degC
-        self.check_result(self.driver.SetTemperature(self.setpoint_deg_c), f"SetTemperature({self.setpoint_deg_c})")
+        self.setpoint_deg_c = self.settings.eeprom.startup_temp_degC 
+        self.check_result(self.driver.SetTemperature(self.setpoint_deg_c), f"SetTemperature({self.setpoint_deg_c})") # step 6
         log.debug(f"set TEC to {self.setpoint_deg_c}C (range {self.settings.eeprom.min_temp_degC}, {self.settings.eeprom.max_temp_degC})")
 
         return SpectrometerResponse(True)
 
     def toggle_tec(self, toggle_state):
         c_toggle = c_int(toggle_state)
         self.toggle_state = c_toggle.value
@@ -520,20 +534,21 @@
         self.setpoint_deg_c = set_temp
         # I don't think CoolerON should need to be called, but I'm not seeing temperature changes
         # when it is not present here.
         self.check_result(self.driver.CoolerON(), "CoolerON")
         self.check_result(self.driver.SetTemperature(self.setpoint_deg_c), f"SetTemperature({self.setpoint_deg_c})")
         return SpectrometerResponse(True)
 
-    def init_detector_area(self) -> SpectrometerResponse:
+    def init_detector_area(self): # -> SpectrometerResponse 
         xPixels = c_int()
         yPixels = c_int()
         self.check_result(self.driver.GetDetector(byref(xPixels), byref(yPixels)), "GetDetector(x, y)")
         log.debug(f"detector {xPixels.value} width x {yPixels.value} height")
         self.pixels = xPixels.value
+        self.height = yPixels.value
         return SpectrometerResponse(True)
 
     def _obtain_gain_info(self):
         num_gains = c_int()
         result = self.driver.GetNumberPreAmpGains(byref(num_gains))
         assert(self.SUCCESS == result), f"unable to get number of gains. Got result {result}"
         log.debug(f"got number of gains is {num_gains.value}")
@@ -545,42 +560,46 @@
             assert(self.SUCCESS == result), f"unable to get gains index {i}. Got result {result}"
             self.gain_options.append(spec_gain_opt.value)
             self.gain_idx.append(i)
         self.gain_idx = self.gain_idx[::-1]
         self.gain_options = self.gain_options[::-1]
         log.debug(f"obtained gain options for spec, values were {self.gain_options}")
 
-    def init_detector_speed(self) -> SpectrometerResponse:
-        # set vertical to recommended
-        VSnumber = c_int()
+    def init_detector_speed(self): # -> SpectrometerResponse 
         speed = c_float()
-        self.check_result(self.driver.GetFastestRecommendedVSSpeed(byref(VSnumber), byref(speed)), "GetFastestRecommendedVSSpeed")
-        self.check_result(self.driver.SetVSSpeed(VSnumber.value), f"SetVSSpeed({VSnumber.value})")
+
+        # for CCDs, set vertical to recommended
+        if self.height > 1:
+            VSnumber = c_int()
+            self.check_result(self.driver.GetFastestRecommendedVSSpeed(byref(VSnumber), byref(speed)), "GetFastestRecommendedVSSpeed") # step 12
+            self.check_result(self.driver.SetVSSpeed(VSnumber.value), f"SetVSSpeed({VSnumber.value})")
+        else:
+            log.debug("vertical speed does not apply to linear array detectors")
 
         # set horizontal to max
         nAD = c_int()
         sIndex = c_int()
         STemp = 0.0
         HSnumber = 0
         ADnumber = 0
-        self.check_result(self.driver.GetNumberADChannels(byref(nAD)), "GetNumberADChannels")
+        self.check_result(self.driver.GetNumberADChannels(byref(nAD)), "GetNumberADChannels") # step 13.1
         for iAD in range(nAD.value):
-            self.check_result(self.driver.GetNumberHSSpeeds(iAD, 0, byref(sIndex)), f"GetNumberHSSpeeds({iAD})")
+            self.check_result(self.driver.GetNumberHSSpeeds(iAD, 0, byref(sIndex)), f"GetNumberHSSpeeds({iAD})") # step 13.2
             for iSpeed in range(sIndex.value):
-                self.check_result(self.driver.GetHSSpeed(iAD, 0, iSpeed, byref(speed)), f"GetHSSpeed(iAD {iAD}, iSpeed {iSpeed})")
+                self.check_result(self.driver.GetHSSpeed(iAD, 0, iSpeed, byref(speed)), f"GetHSSpeed(iAD {iAD}, iSpeed {iSpeed})") # step 13.3
                 if speed.value > STemp:
                     STemp = speed.value
                     HSnumber = iSpeed
                     ADnumber = iAD
-        self.check_result(self.driver.SetADChannel(ADnumber), f"SetADChannel({ADnumber})")
-        self.check_result(self.driver.SetHSSpeed(0, HSnumber), f"SetHSSpeed({HSnumber})")
+        self.check_result(self.driver.SetADChannel(ADnumber), f"SetADChannel({ADnumber})") # 13.4
+        self.check_result(self.driver.SetHSSpeed(0, HSnumber), f"SetHSSpeed({HSnumber})") # 13.5
         log.debug(f"set AD channel {ADnumber} with horizontal speed {HSnumber} ({STemp})")
         return SpectrometerResponse(True)
 
-    def scans_to_average(self, value: int) -> SpectrometerResponse:
+    def scans_to_average(self, value: int): # -> SpectrometerResponse 
         self.sum_count = 0
         self.settings.state.scans_to_average = int(value)
         return SpectrometerResponse(True)
 
     def get_error_code(self, code):
         if code in self.error_codes:
             return self.error_codes[code]
```

### Comparing `wasatch-2.1.24/wasatch/BLEDevice.py` & `wasatch-2.1.32/wasatch/BLEDevice.py`

 * *Files 2% similar despite different names*

```diff
@@ -107,15 +107,15 @@
     def __lt__(self, other):
         return str(self) < str(other)
 
     ###############################################################
     # Private Methods
     ###############################################################
 
-    def _init_process_funcs(self) -> dict[str, Callable[..., Any]]:
+    def _init_process_funcs(self): # -> dict[str, Callable[..., Any]] 
         process_f = {}
 
         process_f["connect"] = self.connect
         process_f["disconnect"] = self.close
         process_f["close"] = self.close
         process_f["acquire_data"] = self.acquire_data
         process_f["scans_to_average"] = self.scans_to_average
@@ -375,35 +375,35 @@
                 response = await self.client.read_gatt_char(READ_EEPROM_UUID)
                 for byte in response:
                     buf.append(byte)
             pages.append(buf)
         return pages
 
 
-    def _get_default_data_dir(self) -> str:
+    def _get_default_data_dir(self): # -> str 
         return os.getcwd()
 
     ###############################################################
     # Public Methods
     ###############################################################
 
-    def connect(self) -> SpectrometerResponse:
+    def connect(self): # -> SpectrometerResponse 
         self.thread = threading.Thread(target=self.loop.run_forever, daemon=True)
         self.thread.start()
         fut = asyncio.run_coroutine_threadsafe(self._connect_spec(), self.loop)
         log.debug("asyncio performing connection to device")
         fut.result()
         log.debug("BLEDevice succeeded in connection")
         fut = asyncio.run_coroutine_threadsafe(self._get_eeprom(), self.loop)
         self.settings.eeprom.parse(fut.result())
         self.settings.update_wavecal()
         self.label = f"{self.settings.eeprom.serial_number} ({self.settings.eeprom.model})"
         return SpectrometerResponse(True)
 
-    def acquire_data(self) -> SpectrometerResponse:
+    def acquire_data(self): # -> SpectrometerResponse 
         if self.performing_acquire:
             return SpectrometerResponse(True)
         if self.disconnect:
             log.debug("ble spec is set to disconnect, returning False")
             return SpectrometerResponse(False)
         self.performing_acquire = True
         self.session_reading_count += 1
@@ -411,40 +411,40 @@
         self.performing_acquire = False
         result = fut.result()
         return result
 
     # both this and change_setting are needed
     # change_device_setting is called by the controller
     # while change_setting is being called by the wrapper_worker
-    def change_device_setting(self, setting: str, value: int) -> None:
+    def change_device_setting(self, setting: str, value: int): # -> None 
         control_object = ControlObject(setting, value)
         log.debug("BLEDevice.change_setting: %s", control_object)
 
         # Since scan averaging lives in WasatchDevice, handle commands which affect
         # averaging at this level
         if control_object.setting == "scans_to_average":
             self.sum_count = 0
             self.settings.state.scans_to_average = int(value)
             return
         else:
             req = SpectrometerRequest(setting, args=[value])
             self.handle_requests([req])
 
-    def get_pid_hex(self) -> str:
+    def get_pid_hex(self): # -> str 
         return str(hex(self.pid))[2:]
 
-    def get_vid_hex(self) -> str:
+    def get_vid_hex(self): # -> str 
         return str(self.vid)
 
-    def to_dict(self) -> str:
+    def to_dict(self): # -> str 
         return str(self)
 
-    def scans_to_average(self, value: int) -> None:
+    def scans_to_average(self, value: int): # -> None 
         self.sum_count = 0
         self.settings.state.scans_to_average = int(value)
 
-    def close(self) -> None:
+    def close(self): # -> None 
         log.info("BLE close called, trying to disconnect spec")
         self.disconnect = True
         fut = asyncio.run_coroutine_threadsafe(self._disconnect_spec(), self.loop)
         result = fut.result()
         self.loop.stop()
```

### Comparing `wasatch-2.1.24/wasatch/BalanceAcquisition.py` & `wasatch-2.1.32/wasatch/BalanceAcquisition.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/CSVLoader.py` & `wasatch-2.1.32/wasatch/CSVLoader.py`

 * *Files 8% similar despite different names*

```diff
@@ -37,32 +37,39 @@
             "wavenumber": []
         }
 
         self.headers = []
         self.processed_reading = ProcessedReading()
         self.processed_reading.reading = Reading(device_id = "LOAD:" + pathname)
 
-    def parse_metadata(self, line):
+    def parse_metadata(self, line, scalar_metadata=False):
+        """
+        MZ: I'm not sure who is using this method and wants the metadata 
+        values to be returned as lists, but it unnecessarily complicates 
+        ColumnFileParser, so adding the scalar option.
+        """
         line = list(line)
         key   = line[0]
-        value = line[1:] # for lists with only one element this will give []
-                         # Useful for cases like Declared Match,,,,,,,,
-
+        if scalar_metadata:
+            value = line[1]
+        else:
+            value = line[1:] # for lists with only one element this will give []
+                             # Useful for cases like Declared Match,,,,,,,,
         self.metadata[key] = value
 
     def parse_header(self, line):
         self.headers = [ x.lower().strip() for x in line ] # force lowercase
         if "processed" in self.headers: self.processed_reading.processed = []
         if "raw"       in self.headers: self.processed_reading.raw       = []
         if "dark"      in self.headers: self.processed_reading.dark      = []
         if "reference" in self.headers: self.processed_reading.reference = []
         if "corrected" in self.headers: self.processed_reading.processed = []
         log.debug("parse_header: headers = %s", self.headers)
 
-    def load_data(self):
+    def load_data(self, scalar_metadata=False):
         state = "reading_metadata"
         data_rows_read = 0
         with open(self.pathname, "r", encoding=self.encoding) as infile:
             csv_lines = csv.reader(infile)
             for line in csv_lines:
                 # skip comments and blanks
                 log.debug(line)
@@ -72,36 +79,36 @@
                 # log.debug("load_data[%s]: %s", state, line)
 
                 line[-1] = line[-1].strip() # remove the \n
                 if state == "reading_metadata":
                     
                     # check for end of metadata (note trailing comma!)
                     cleanup_line = lambda x: x.strip().lower()
-                    line = [cleanup_line(part) for part in line]
-                    check_present = lambda x: x in line
+                    clean_line = [cleanup_line(part) for part in line]
+                    check_present = lambda x: x in clean_line
                     contains_header = [check_present(header) 
                                        for header in ["pixel", "wavelength", "wavenumber", "processed"]]
                     if any(contains_header):
                         self.parse_header(line)
                         state = "reading_data"
                     else:
                         # still in metadata
-                        self.parse_metadata(line)
+                        self.parse_metadata(line, scalar_metadata)
 
                 elif state == "reading_metadata_final":
-                    self.parse_metadata(line)
+                    self.parse_metadata(line, scalar_metadata)
                 
                 elif state == "reading_data":
                     values = [x.strip() for x in line]
 
                     # if we find more metadata after data ended, store it but 
                     # do not transition back
                     if not re.match(r'^[-+]?\d', values[0]):
                         state = "reading_metadata_final"
-                        self.parse_metadata(line)
+                        self.parse_metadata(line, scalar_metadata)
                         continue
 
                     # Assume each value read aligns with a known headers, but recognize that there
                     # could be more headers than there are values (some columns with headers may
                     # not actually have populated data, blank or otherwise).  This is the number of
                     # comma-delimited fields actually read (or the number of headers, if more values
                     # were read than had headers).
@@ -114,14 +121,18 @@
                         # if there are blanks (rather than '0' zeros) in the MIDDLE of a column, 
                         # the resulting spectral matrix will have different-length columns and
                         # improperly-associated "rows".
                         value = values[i]
                         if len(value) == 0:
                             continue
 
+                        # MZ: honestly not sure if we should skip these or treat as zero
+                        if value == "NA":
+                            value = 0
+
                         # add to array
                         array = None
                         if   header == "processed":  array = self.processed_reading.processed
                         elif header == "corrected":  array = self.processed_reading.processed 
                         elif header == "raw":        array = self.processed_reading.raw
                         elif header == "dark":       array = self.processed_reading.dark
                         elif header == "reference":  array = self.processed_reading.reference
```

### Comparing `wasatch-2.1.24/wasatch/CommandSettings.py` & `wasatch-2.1.32/wasatch/CommandSettings.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/ControlObject.py` & `wasatch-2.1.32/wasatch/ControlObject.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/DetectorROI.py` & `wasatch-2.1.32/wasatch/DetectorROI.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/DetectorRegions.py` & `wasatch-2.1.32/wasatch/DetectorRegions.py`

 * *Files 1% similar despite different names*

```diff
@@ -42,15 +42,15 @@
         else:
             region = roi
         self.regions.pop(region, None)
 
     def count(self):
         return len(self.regions)
 
-    def has_region(self, region):
+    def has_region(self, region): # -> bool 
         return region in self.regions
 
     def get_roi(self, region):
         return self.regions.get(region, None)
 
     ## guaranteed to be in the same order as split spectra
     def get_region_list(self):
```

### Comparing `wasatch-2.1.24/wasatch/DeviceFinderUSB.py` & `wasatch-2.1.32/wasatch/DeviceFinderUSB.py`

 * *Files 2% similar despite different names*

```diff
@@ -75,15 +75,15 @@
     
     ##
     # Iterates over each USB bus, and each device on the bus, retaining any
     # with a Wasatch Photonics VID and supported PID and instantiating a
     # DeviceID for each.  
     #
     # Note that DeviceID internally pulls more attributes from the Device object.
-    def bus_polling(self) -> list[DeviceID]:
+    def bus_polling(self): # -> list[DeviceID] 
         device_ids = []
         count = 0
         for device in usb.core.find(find_all=True, backend=libusb0.get_backend()):
             count += 1
             vid = int(device.idVendor)
             pid = int(device.idProduct)
             log.debug("DeviceListFID: discovered vid 0x%04x, pid 0x%04x (count %d), address %s", vid, pid, count, device.address)
@@ -94,15 +94,15 @@
             if vid == self.WASATCH_VID and pid not in [ self.WP_HAMA_SILICON_PID, self.WP_HAMA_INGAAS_PID, self.WP_ARM_PID ]:
                 continue
 
             device_id = DeviceID(device=device)
             device_ids.append(device_id)
         return device_ids
 
-    def linux_monitoring(self) -> list[DeviceID]:
+    def linux_monitoring(self): # -> list[DeviceID] 
         device_ids = []
         for device in iter(partial(self.monitor.poll, 0.001), None):
             # sometimes I see events with None for the vendor id, those should be skipped
             if device is not None and device.action == "add" and device.get('ID_VENDOR_ID') is not None:
                 device_ids.append(device)
                 log.debug(f"got a udev device add event")
         valid_devices = [dev for dev in device_ids if dev.get('ID_VENDOR_ID').lower() in self.STR_VALID_IDS]
@@ -119,15 +119,15 @@
     # I like this line but think it deserves a comment
     # map across the STR_VALID_IDS checking if it is in current id string, resulting in a bool array
     # if any true in that bool array then any() is true and thus it will be in the list
     def id_in_valid_ids(self, dev_id):
         valid_id_present = map(lambda valid: valid in dev_id, self.STR_VALID_IDS)
         return any(valid_id_present)
 
-    def windows_monitoring(self) -> list[DeviceID]:
+    def windows_monitoring(self): # -> list[DeviceID] 
         device_ids = []
         try:
             # the next event raises an error on timeout
             # so if a connection has occured then add it to device ids
             # when we stop seeing devices then pass on to the processing
             while True:
                 obj_received = self.obj_events.NextEvent(0.001)
```

### Comparing `wasatch-2.1.24/wasatch/DeviceID.py` & `wasatch-2.1.32/wasatch/DeviceID.py`

 * *Files 3% similar despite different names*

```diff
@@ -173,27 +173,27 @@
 
         # Give up.  Shouldn't be a problem unless we talking to multiple devices
         # with the same PID at once (Raman Rainbow etc).
         log.error("can't determine bus or address of USB device from:\n%s", s)
         self.bus = -1
         self.address = -1
 
-    def is_file(self):
+    def is_file(self): # -> bool 
         return self.type.upper() == "FILE"
 
-    def is_usb(self):
+    def is_usb(self): # -> bool 
         return self.type.upper() == "USB"
 
-    def is_mock(self):
+    def is_mock(self): # -> bool 
         return self.type.upper() == "MOCK"
 
-    def is_ble(self):
+    def is_ble(self): # -> bool 
         return self.type.upper() == "BLE"
 
-    def is_andor(self):
+    def is_andor(self): # -> bool 
         return self.vid == 0x136e
 
     # Surely there is a better way to obtain the 'bus' and 'address' attributes 
     # than rendering the usb.device as a string and then parsing it.  I tried 
     # dumping the __dict__ and didn't see the address anywhere...must be in a 
     # sub-object I didn't traverse.
     #
```

### Comparing `wasatch-2.1.24/wasatch/EEPROM.py` & `wasatch-2.1.32/wasatch/EEPROM.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,1154 +1,1173 @@
-import hashlib
-import logging
-import struct
-import array
-import math
-import copy
-import json
-import re
-
-from . import utils
-
-from .ROI import ROI
-
-log = logging.getLogger(__name__)
-
-##
-# This class encapsulates the post-read parsing, pre-write marshalling, and current
-# state of the 8-page EEPROM used to store non-volatile configuration data in Wasatch
-# Photonics spectrometers.  It is essential to keep this class synchronized (in naming,
-# datatype / datasize and sequence) with the ENG-0034 customer-facing documentation.
-#
-# This class is normally accessed as an attribute of SpectrometerSettings.
-#
-# @see ENG-0034
-# @see AT24C256C for ARM (32KB, http://ww1.microchip.com/downloads/en/DeviceDoc/20006270A.pdf)
-# @see 24LC128 for FX2 (16KB, https://www.microchip.com/en-us/product/24LC128)
-class EEPROM(object):
-
-    # This was mistakenly set to 15 earlier, probably out of confusion between 
-    # ENG-0001 vs ENG-0034 release level (the former WAS at 15, the latter is
-    # only now advancing to 15).  Leaving it alone for now.
-    LATEST_REV = 15 
-
-    MAX_PAGES = 8
-    PAGE_LENGTH = 64
-    SUBPAGE_COUNT = 4  # is this used for BLE?
-    MAX_RAMAN_INTENSITY_CALIBRATION_ORDER = 7
-
-    DEFAULT_LASER_WATCHDOG_SEC = 10
-
-    def __init__(self):
-        self.format = 0
-
-        self.model                       = None
-        self.serial_number               = None
-        self.baud_rate                   = 0
-        self.has_cooling                 = False
-        self.has_battery                 = False
-        self.has_laser                   = False
-        self.feature_mask                = 0
-        self.invert_x_axis               = False
-        self.bin_2x2                     = False
-        self.gen15                       = False
-        self.cutoff_filter_installed     = False
-        self.hardware_even_odd           = False
-        self.sig_laser_tec               = False
-        self.has_interlock_feedback      = False
-        self.has_shutter                 = False
-        self.excitation_nm               = 0.0
-        self.excitation_nm_float         = 0.0
-        self.slit_size_um                = 0
-        self.startup_integration_time_ms = 10
-        self.startup_temp_degC           = 15
-        self.startup_triggering_scheme   = 0
-        self.detector_gain               = 1.9
-        self.detector_offset             = 0
-        self.detector_gain_odd           = 1.9
-        self.detector_offset_odd         = 0
-        self.laser_warmup_sec            = 0
-        self.laser_watchdog_sec          = 0
-        self.light_source_type           = 0
-                                         
-        self.wavelength_coeffs           = []
-        self.degC_to_dac_coeffs          = []
-        self.adc_to_degC_coeffs          = []
-        self.max_temp_degC               = 20 
-        self.min_temp_degC               = 10
-        self.tec_r298                    = 0
-        self.tec_beta                    = 0
-        self.calibration_date            = None
-        self.calibrated_by               = None
-                                         
-        self.detector                    = None
-        self.detector_serial_number      = None
-        self.active_pixels_horizontal    = 1024
-        self.active_pixels_vertical      = 0
-        self.min_integration_time_ms     = 10
-        self.max_integration_time_ms     = 60000
-        self.actual_horizontal           = 0
-        self.actual_vertical             = 0     # not a real EEPROM field, though it should be
-        self.roi_horizontal_start        = 0
-        self.roi_horizontal_end          = 0
-        self.roi_vertical_region_1_start = 0
-        self.roi_vertical_region_1_end   = 0
-        self.roi_vertical_region_2_start = 0
-        self.roi_vertical_region_2_end   = 0
-        self.roi_vertical_region_3_start = 0
-        self.roi_vertical_region_3_end   = 0
-        self.linearity_coeffs            = []
-
-        self.max_laser_power_mW          = 0.0
-        self.min_laser_power_mW          = 0.0
-        self.laser_power_coeffs          = []
-        self.avg_resolution              = 0.0
-
-        self.user_data                   = None
-        self.user_text                   = None
-
-        self.bad_pixels                  = [] # should be set, not list (but this works with EEPROMEditor)
-        self.product_configuration       = None
-
-        self.format                      = 0
-        self.subformat                   = 0 # pages 6-7
-
-        self.buffers = []
-        self.write_buffers = []
-        self.digest = None
-
-        self.editable = [ "excitation_nm",
-                          "excitation_nm_float",
-                          "detector_gain",
-                          "detector_offset",
-                          "detector_gain_odd",
-                          "detector_offset_odd",
-                          "calibrated_by",
-                          "calibration_date", 
-                          "user_text",
-                          "wavelength_coeffs",
-                          "linearity_coeffs",
-                          "max_laser_power_mW",
-                          "min_laser_power_mW",
-                          "laser_power_coeffs",
-                          "bad_pixels",
-                          "bin_2x2",
-                          "gen15",
-                          "cutoff_filter_installed",
-                          "has_shutter",
-                          "laser_warmup_sec",
-                          "laser_watchdog_sec",
-                          "roi_horizontal_end",             
-                          "roi_horizontal_start",           
-                          "roi_vertical_region_1_end",      
-                          "roi_vertical_region_1_start",    
-                          "roi_vertical_region_2_end",      
-                          "roi_vertical_region_2_start",    
-                          "roi_vertical_region_3_end",      
-                          "roi_vertical_region_3_start",
-                          "raman_intensity_calibration_order",
-                          "raman_intensity_coeffs" ]
-
-        self.init_raman_intensity_calibration()
-        self.init_spline()
-        self.init_untethered()
-        self.init_regions()
-
-    ## whether the given field is normally editable by users via ENLIGHTEN
-    #
-    # @return False otherwise (don't trust in None's truthiness, as you can't 
-    #         pass None to Qt's setEnabled)
-    def is_editable(self, name):
-        s = name.lower()
-        for field in self.editable:
-            if s == field.lower():
-                return True
-        return False
-
-    ## 
-    # passed a temporary copy of another EEPROM object, copy-over any
-    # "editable" fields to this one
-    def update_editable(self, new_eeprom):
-        for field in self.editable:
-            old = getattr(self, field)
-            new = copy.deepcopy(getattr(new_eeprom, field))
-            if old == new:
-                log.debug("  %s: no change (%s == %s)", field, old, new)
-            else:
-                setattr(self, field, new)
-                log.debug("  %s: changed %s --> %s", field, old, new)
-
-    # ##########################################################################
-    #                                                                          #
-    #                               Read EEPROM                                #
-    #                                                                          #
-    # ##########################################################################
-
-    ## 
-    # given a set of the 8 buffers read from a spectrometer via USB,
-    # parse those into the approrpriate fields and datatypes
-    def parse(self, buffers) -> bool:
-        if len(buffers) < EEPROM.MAX_PAGES:
-            log.error("EEPROM.parse expects at least %d buffers", EEPROM.MAX_PAGES)
-            return False
-
-        # store these locally so self.unpack() can access them
-        self.buffers = buffers
-        self.digest = self.generate_digest()
-
-        # unpack all the fields we know about
-        try:
-            self.read_eeprom()
-            return True
-        except:
-            log.error("failed to parse EEPROM", exc_info=1)
-            return False
-
-    ## 
-    # Assuming a set of 8 buffers have been passed in via parse(), actually
-    # unpack (deserialize / unmarshall) the binary data into the appropriate
-    # fields and datatypes.
-    # 
-    # @see https://docs.python.org/2/library/struct.html#format-characters
-    # (capitals are unsigned)
-    def read_eeprom(self):
-        self.format = self.unpack((0, 63,  1), "B", "format")
-        log.debug("parsing EEPROM format %d", self.format)
-
-        # ######################################################################
-        # Page 0
-        # ######################################################################
-
-        self.model                           = self.unpack((0,  0, 16), "s", "model")
-        self.serial_number                   = self.unpack((0, 16, 16), "s", "serial")
-        self.baud_rate                       = self.unpack((0, 32,  4), "I", "baud")
-        self.has_cooling                     = self.unpack((0, 36,  1), "?", "cooling")
-        self.has_battery                     = self.unpack((0, 37,  1), "?", "battery")
-        self.has_laser                       = self.unpack((0, 38,  1), "?", "laser")
-        if self.format > 9:
-            self.feature_mask                = self.unpack((0, 39,  2), "H", "feature_mask")
-        elif self.format >= 3:
-            self.excitation_nm               = self.unpack((0, 39,  2), "H", "excitation_nm (unsigned)")
-        else:
-            self.excitation_nm               = self.unpack((0, 39,  2), "h", "excitation_nm (signed)")
-
-        if self.format >= 4:
-            self.slit_size_um                = self.unpack((0, 41,  2), "H", "slit (unsigned)")
-        else:
-            self.slit_size_um                = self.unpack((0, 41,  2), "h", "slit (signed)")
-
-        # NOTE: the new InGaAs detector gain/offset won't be usable from 
-        #       EEPROM until we start bumping production spectrometers to
-        #       EEPROM Page 0 Revision 3!
-        if self.format >= 3:
-            self.startup_integration_time_ms = self.unpack((0, 43,  2), "H", "start_integ")
-            self.startup_temp_degC           = self.unpack((0, 45,  2), "h", "start_temp")
-            self.startup_triggering_scheme   = self.unpack((0, 47,  1), "B", "start_trigger")
-            self.detector_gain               = self.unpack((0, 48,  4), "f", "gain") # "even pixels" for InGaAs
-            self.detector_offset             = self.unpack((0, 52,  2), "h", "offset") # "even pixels" for InGaAs
-            self.detector_gain_odd           = self.unpack((0, 54,  4), "f", "gain_odd") # InGaAs-only
-            self.detector_offset_odd         = self.unpack((0, 58,  2), "h", "offset_odd") # InGaAs-only
-
-        # ######################################################################
-        # Page 1
-        # ######################################################################
-
-        self.wavelength_coeffs = []
-        self.wavelength_coeffs         .append(self.unpack((1,  0,  4), "f", "wavecal_coeff_0"))
-        self.wavelength_coeffs         .append(self.unpack((1,  4,  4), "f"))
-        self.wavelength_coeffs         .append(self.unpack((1,  8,  4), "f"))
-        self.wavelength_coeffs         .append(self.unpack((1, 12,  4), "f"))
-        self.degC_to_dac_coeffs = []
-        self.degC_to_dac_coeffs        .append(self.unpack((1, 16,  4), "f", "degCtoDAC_coeff_0"))
-        self.degC_to_dac_coeffs        .append(self.unpack((1, 20,  4), "f"))
-        self.degC_to_dac_coeffs        .append(self.unpack((1, 24,  4), "f"))
-        self.max_temp_degC                   = self.unpack((1, 28,  2), "h", "max_temp")
-        self.min_temp_degC                   = self.unpack((1, 30,  2), "h", "min_temp")
-        self.adc_to_degC_coeffs = []
-        self.adc_to_degC_coeffs        .append(self.unpack((1, 32,  4), "f", "adcToDegC_coeff_0"))
-        self.adc_to_degC_coeffs        .append(self.unpack((1, 36,  4), "f"))
-        self.adc_to_degC_coeffs        .append(self.unpack((1, 40,  4), "f"))
-        self.tec_r298                        = self.unpack((1, 44,  2), "h", "r298")
-        self.tec_beta                        = self.unpack((1, 46,  2), "h", "beta")
-        self.calibration_date                = self.unpack((1, 48, 12), "s", "date")
-        self.calibrated_by                   = self.unpack((1, 60,  3), "s", "tech")
-                                    
-        # ######################################################################
-        # Page 2                    
-        # ######################################################################
-
-        self.detector                        = self.unpack((2,  0, 16), "s", "detector")
-        self.active_pixels_horizontal        = self.unpack((2, 16,  2), "H", "pixels")
-        if self.format >= 10:
-            self.laser_warmup_sec            = self.unpack((2, 18,  1), "B", "laser_warmup_sec")
-        self.active_pixels_vertical          = self.unpack((2, 19,  2), "H" if self.format >= 4 else "h")
-
-        if self.format >= 8:
-            self.wavelength_coeffs     .append(self.unpack((2, 21,  4), "f", "wavecal_coeff_4"))
-        else:
-            # just go ahead and initialize the 5th coeff to zero
-            self.wavelength_coeffs.append(0)
-            if self.format < 5:
-                self.min_integration_time_ms     = self.unpack((2, 21,  2), "H", "min_integ(ushort)")
-                self.max_integration_time_ms     = self.unpack((2, 23,  2), "H", "max_integ(ushort)") 
-
-        self.actual_horizontal               = self.unpack((2, 25,  2), "H" if self.format >= 4 else "h", "actual_horiz")
-        self.actual_vertical                 = self.active_pixels_vertical  # approximate for now
-        self.roi_horizontal_start            = self.unpack((2, 27,  2), "H" if self.format >= 4 else "h")
-        self.roi_horizontal_end              = self.unpack((2, 29,  2), "H" if self.format >= 4 else "h")
-        self.roi_vertical_region_1_start     = self.unpack((2, 31,  2), "H" if self.format >= 4 else "h")
-        self.roi_vertical_region_1_end       = self.unpack((2, 33,  2), "H" if self.format >= 4 else "h")
-        self.roi_vertical_region_2_start     = self.unpack((2, 35,  2), "H" if self.format >= 4 else "h")
-        self.roi_vertical_region_2_end       = self.unpack((2, 37,  2), "H" if self.format >= 4 else "h")
-        self.roi_vertical_region_3_start     = self.unpack((2, 39,  2), "H" if self.format >= 4 else "h")
-        self.roi_vertical_region_3_end       = self.unpack((2, 41,  2), "H" if self.format >= 4 else "h")
-        self.linearity_coeffs = []
-        self.linearity_coeffs          .append(self.unpack((2, 43,  4), "f", "linearity_coeff_0")) # overloading for secondary ADC
-        self.linearity_coeffs          .append(self.unpack((2, 47,  4), "f"))
-        self.linearity_coeffs          .append(self.unpack((2, 51,  4), "f"))
-        self.linearity_coeffs          .append(self.unpack((2, 55,  4), "f"))
-        self.linearity_coeffs          .append(self.unpack((2, 59,  4), "f"))
-
-        # ######################################################################
-        # Page 3
-        # ######################################################################
-        
-        self.laser_power_coeffs = []
-        self.laser_power_coeffs        .append(self.unpack((3, 12,  4), "f", "laser_power_coeff_0"))
-        self.laser_power_coeffs        .append(self.unpack((3, 16,  4), "f"))
-        self.laser_power_coeffs        .append(self.unpack((3, 20,  4), "f"))
-        self.laser_power_coeffs        .append(self.unpack((3, 24,  4), "f"))
-        self.max_laser_power_mW              = self.unpack((3, 28,  4), "f", "max_laser_mW")
-        self.min_laser_power_mW              = self.unpack((3, 32,  4), "f", "min_laser_mW")
-
-        if self.format >= 4:
-            self.excitation_nm_float         = self.unpack((3, 36,  4), "f", "excitation(float)")
-        else:
-            self.excitation_nm_float = self.excitation_nm
-
-        if self.format >= 5:
-            self.min_integration_time_ms     = self.unpack((3, 40,  4), "I", "min_integ(uint)")
-            self.max_integration_time_ms     = self.unpack((3, 44,  4), "I", "max_integ(uint)") 
-
-        if self.format >= 7:
-            self.avg_resolution              = self.unpack((3, 48,  4), "f", "avg_resolution")
-
-        if self.format >= 15:
-            self.laser_watchdog_sec          = self.unpack((3, 52,  2), "H", "laser_watchdog_sec")
-            self.light_source_type           = self.unpack((3, 54,  1), "B", "light_source_type")
-
-        # ######################################################################
-        # Page 4
-        # ######################################################################
-
-        self.user_data = self.buffers[4][:63]
-        self.user_text = self.printable(self.user_data)
-
-        # ######################################################################
-        # Page 5
-        # ######################################################################
-
-        bad = set()
-        for count in range(15):
-            pixel = self.unpack((5, count * 2, 2), "h")
-            if pixel != -1:
-                bad.add(pixel)
-        self.bad_pixels = list(bad)
-        self.bad_pixels.sort()
-
-        if self.format >= 5:
-            self.product_configuration       = self.unpack((5,  30, 16), "s", "product_config")
-        if self.format >= 7:
-            self.subformat                   = self.unpack((5,  63,  1), "B", "subformat")
-
-        # ######################################################################
-        # Page 6-7
-        # ######################################################################
-
-        if self.subformat == 0:
-            pass
-        elif self.subformat == 1:
-            self.read_raman_intensity_calibration()
-        elif self.subformat == 2:
-            self.read_spline()
-        elif self.subformat == 3:
-            self.read_untethered()
-        elif self.subformat == 4:
-            self.read_regions()
-        else:
-            log.debug(f"Unreadable EEPROM subformat {self.subformat}")
-        
-        # ######################################################################
-        # feature mask
-        # ######################################################################
-
-        if self.format >= 9:
-            self.invert_x_axis           = 0 != self.feature_mask & 0x0001
-            self.bin_2x2                 = 0 != self.feature_mask & 0x0002
-            self.gen15                   = 0 != self.feature_mask & 0x0004
-            self.cutoff_filter_installed = 0 != self.feature_mask & 0x0008
-            self.hardware_even_odd       = 0 != self.feature_mask & 0x0010
-            self.sig_laser_tec           = 0 != self.feature_mask & 0x0020
-            self.has_interlock_feedback  = 0 != self.feature_mask & 0x0040
-            self.has_shutter             = 0 != self.feature_mask & 0x0080
-        else:
-            self.invert_x_axis           = 0 
-            self.bin_2x2                 = 0
-            self.gen15                   = 0
-            self.cutoff_filter_installed = 0
-            self.hardware_even_odd       = 0
-            self.sig_laser_tec           = 0
-            self.has_interlock_feedback  = 0
-            self.has_shutter             = 0
-
-        # ######################################################################
-        # sanity checks
-        # ######################################################################
-
-        utils.clean_nan(self.wavelength_coeffs)
-
-        if self.min_integration_time_ms == 0xffff:
-            self.min_integration_time_ms = 1 
-            self.max_integration_time_ms = 60000
-
-        if self.min_integration_time_ms > self.max_integration_time_ms:
-            (self.min_integration_time_ms, self.max_integration_time_ms) = \
-            (self.max_integration_time_ms, self.min_integration_time_ms)
-
-        if self.startup_integration_time_ms < self.min_integration_time_ms:
-            self.startup_integration_time_ms = self.min_integration_time_ms
-
-        if self.min_temp_degC > self.max_temp_degC:
-            (self.min_temp_degC, self.max_temp_degC) = \
-            (self.max_temp_degC, self.min_temp_degC) 
-
-        if self.min_laser_power_mW > self.max_laser_power_mW:
-            (self.min_laser_power_mW, self.max_laser_power_mW) = \
-            (self.max_laser_power_mW, self.min_laser_power_mW)
-
-    ############################################################################
-    #                                                                          #
-    #                               Write EEPROM                               #
-    #                                                                          #
-    ############################################################################
-
-    def generate_feature_mask(self):
-        mask = 0
-        mask |= 0x0001 if self.invert_x_axis           else 0
-        mask |= 0x0002 if self.bin_2x2                 else 0
-        mask |= 0x0004 if self.gen15                   else 0
-        mask |= 0x0008 if self.cutoff_filter_installed else 0
-        mask |= 0x0010 if self.hardware_even_odd       else 0
-        mask |= 0x0020 if self.sig_laser_tec           else 0
-        mask |= 0x0040 if self.has_interlock_feedback  else 0
-        mask |= 0x0080 if self.has_shutter             else 0
-        return mask
-
-    ##
-    # Call this to populate an internal array of "write buffers" which may be written back
-    # to spectrometers (or used to generate the digest of what WOULD be written).
-    def generate_write_buffers(self):
-        # stub-out 8 blank buffers
-        self.write_buffers = []
-        for page in range(EEPROM.MAX_PAGES):
-            self.write_buffers.append(array.array('B', [0] * 64))
-
-        # Eventually we'll stop worrying about the legacy per-page format versions, but
-        # for now maximize compatibility with StrokerConsole/ModelConfigurationFormat.cs
-        # by making its expected format values the default for each page:
-        revs = { 0: 1,
-                 1: 1,
-                 2: 2, 
-                 3: 255,
-                 4: 1, 
-                 5: 1,
-                 6: 0 }
-        for page in list(revs.keys()):
-            self.write_buffers[page][63] = revs[page]
-
-        # ...but the truth is that we don't really care about the old per-page formats,
-        # and all modern code should just be looking at this one byte:
-        self.write_buffers[0][63] = EEPROM.LATEST_REV
-
-        # ######################################################################
-        # Page 0
-        # ######################################################################
-
-        self.pack((0,  0, 16), "s", self.model)
-        self.pack((0, 16, 16), "s", self.serial_number)
-        self.pack((0, 32,  4), "I", self.baud_rate)
-        self.pack((0, 36,  1), "?", self.has_cooling)
-        self.pack((0, 37,  1), "?", self.has_battery)
-        self.pack((0, 38,  1), "?", self.has_laser)
-        self.pack((0, 39,  2), "H", self.generate_feature_mask(), "FeatureMask")
-        self.pack((0, 41,  2), "H", self.slit_size_um)
-        self.pack((0, 43,  2), "H", self.startup_integration_time_ms)
-        self.pack((0, 45,  2), "h", self.startup_temp_degC)
-        self.pack((0, 47,  1), "B", self.startup_triggering_scheme)
-        self.pack((0, 48,  4), "f", self.detector_gain)
-        self.pack((0, 52,  2), "h", self.detector_offset)
-        self.pack((0, 54,  4), "f", self.detector_gain_odd)
-        self.pack((0, 58,  2), "h", self.detector_offset_odd)
-
-        # ######################################################################
-        # Page 1
-        # ######################################################################
-
-        if self.wavelength_coeffs is not None:
-            for i in range(min(4, len(self.wavelength_coeffs))):
-                self.pack((1,  0 + i * 4,  4), "f", self.wavelength_coeffs[i])
-                
-        if self.degC_to_dac_coeffs is not None:
-            for i in range(min(3, len(self.degC_to_dac_coeffs))):
-                self.pack((1, 16 + i * 4,  4), "f", self.degC_to_dac_coeffs[i])
-
-        if self.adc_to_degC_coeffs is not None:
-            for i in range(min(3, len(self.adc_to_degC_coeffs))):
-                self.pack((1, 32 + i * 4,  4), "f", self.adc_to_degC_coeffs[i])
-
-        self.pack((1, 28,  2), "h", self.max_temp_degC)
-        self.pack((1, 30,  2), "h", self.min_temp_degC)
-        self.pack((1, 44,  2), "h", self.tec_r298)
-        self.pack((1, 46,  2), "h", self.tec_beta)
-        self.pack((1, 48, 12), "s", self.calibration_date)
-        self.pack((1, 60,  3), "s", self.calibrated_by)
-                                    
-        # ######################################################################
-        # Page 2                    
-        # ######################################################################
-
-        self.pack((2,  0, 16), "s", self.detector)
-        self.pack((2, 16,  2), "H", self.active_pixels_horizontal)
-        self.pack((2, 18,  1), "B", self.laser_warmup_sec)
-        self.pack((2, 19,  2), "H", self.active_pixels_vertical)
-        if self.format < 7:
-            self.pack((2, 21,  2), "H", max(0xffff, self.min_integration_time_ms))
-            self.pack((2, 23,  2), "H", max(0xffff, self.max_integration_time_ms))
-        else:
-            coeff = 0.0
-            if len(self.wavelength_coeffs) > 4:
-                coeff = self.wavelength_coeffs[4]
-            self.pack((2, 21,  4), "f", coeff)
-        self.pack((2, 25,  2), "H", self.actual_horizontal)
-        self.pack((2, 27,  2), "H", self.roi_horizontal_start)
-        self.pack((2, 29,  2), "H", self.roi_horizontal_end)
-        self.pack((2, 31,  2), "H", self.roi_vertical_region_1_start)
-        self.pack((2, 33,  2), "H", self.roi_vertical_region_1_end)
-        self.pack((2, 35,  2), "H", self.roi_vertical_region_2_start)
-        self.pack((2, 37,  2), "H", self.roi_vertical_region_2_end)
-        self.pack((2, 39,  2), "H", self.roi_vertical_region_3_start)
-        self.pack((2, 41,  2), "H", self.roi_vertical_region_3_end)
-
-        if self.linearity_coeffs is not None:
-            for i in range(min(5, len(self.linearity_coeffs))):
-                self.pack((2, 43 + i * 4,  4), "f", self.linearity_coeffs[i])
-
-        # ######################################################################
-        # Page 3
-        # ######################################################################
-
-        if self.laser_power_coeffs is not None:
-            for i in range(min(4, len(self.laser_power_coeffs))):
-                self.pack((3, 12 + i * 4,  4), "f", self.laser_power_coeffs[i])
-
-        self.pack((3, 28,  4), "f", self.max_laser_power_mW)
-        self.pack((3, 32,  4), "f", self.min_laser_power_mW)
-        self.pack((3, 36,  4), "f", self.excitation_nm_float)
-        self.pack((3, 40,  4), "I", self.min_integration_time_ms)
-        self.pack((3, 44,  4), "I", self.max_integration_time_ms)
-        self.pack((3, 48,  4), "f", self.avg_resolution)
-        self.pack((3, 52,  2), "H", self.laser_watchdog_sec)
-        self.pack((3, 54,  1), "B", self.light_source_type)
-
-        # ######################################################################
-        # Page 4
-        # ######################################################################
-
-        self.pack((4,  0, 63), "s", self.user_text)
-
-        # ######################################################################
-        # Page 5
-        # ######################################################################
-
-        bad_pixel_set = set()
-        for i in self.bad_pixels:
-            if i >= 0:
-                bad_pixel_set.add(i)
-        bad_pixels = list(bad_pixel_set)
-        bad_pixels.sort()
-        for i in range(15):
-            if i < len(bad_pixels):
-                value = bad_pixels[i]
-            else:
-                value = -1
-            self.pack((5, i * 2, 2), "h", value)
-
-        self.pack((5, 30, 16), "s", self.product_configuration)
-        self.pack((5, 63,  1), "B", self.subformat)
-
-        # ######################################################################
-        # Page 6-7
-        # ######################################################################
-
-        if self.subformat == 0:
-            pass
-        elif self.subformat == 1:
-            self.write_raman_intensity_calibration()
-        elif self.subformat == 2:
-            self.write_spline()
-        elif self.subformat == 3:
-            self.write_untethered()
-        elif self.subformat == 4:
-            self.write_regions()
-        else:
-            log.error(f"Unwriteable EEPROM subformat {self.subformat}")
-
-    # ##########################################################################
-    #                                                                          #
-    #                             Utility methods                              #
-    #                                                                          #
-    # ##########################################################################
-
-    ## make a printable ASCII string out of possibly-binary data
-    def printable(self, buf):
-        s = ""
-        for c in buf:
-            if 31 < c < 127:
-                s += chr(c)
-            elif c == 0:
-                break
-            else:
-                s += '.'
-        return s
-
-    def set(self, name, value):
-        setattr(self, name, value)
-
-    ##
-    # Convert a floating-point value into the big-endian 16-bit "funky float" 
-    # used for detector gain in the FPGA on both Hamamatsu and IMX sensors.
-    #
-    # Note that this TRUNCATES (takes the floor) the fractional portion rather 
-    # than rounding, which I believe matches WasatchNET.FunkyFloat.fromFloat().
-    #
-    # Conversely, it DOES provide minor rounding on the INTEGRAL portion, to 
-    # avoid this problem:
-    #
-    # \verbatim
-    # dB = 0
-    # while dB < 2.1:
-    #     self.set_detector_gain(dB) # old code treats 1.0 as 0.0 because actually sends 0.99999999
-    #     dB += 0.1
-    # \endverbatim
-    #
-    # @see https://wasatchphotonics.com/api/Wasatch.NET/class_wasatch_n_e_t_1_1_funky_float.html
-    def float_to_uint16(self, gain):
-        msb = int(round(gain, 5)) & 0xff
-        # if self.format >= 13: lsb = round((gain - msb) * 256) & 0xff
-        lsb = int((gain - msb) * 256) & 0xff
-        raw = (msb << 8) | lsb
-        log.debug("float_to_uint16: %f -> 0x%04x", gain, raw)
-        return raw
-
-    ## 
-    # Unpack a single field at a given buffer offset of the given datatype.
-    #
-    # @param address    a tuple of the form (buf, offset, len)
-    # @param data_type  see https://docs.python.org/2/library/struct.html#format-characters
-    # @param label      if provided, is included in debug log output
-    def unpack(self, address, data_type, label=None):
-        page       = address[0]
-        start_byte = address[1]
-        length     = address[2]
-        end_byte   = start_byte + length
-
-        if page > len(self.buffers):
-            log.error("error unpacking EEPROM page %d, offset %d, len %d as %s: invalid page (label %s)", 
-                page, start_byte, length, data_type, label, exc_info=1)
-            return
-
-        buf = self.buffers[page]
-        if buf is None or end_byte > len(buf):
-            log.error("error unpacking EEPROM page %d, offset %d, len %d as %s: buf is %s (label %s)", 
-                page, start_byte, length, data_type, buf, label, exc_info=1)
-            return
-
-        if data_type == "s":
-            # This stops at the first NULL, so is not appropriate for binary data (user_data).
-            # OTOH, it doesn't currently enforce "printable" characters either (nor support Unicode).
-            unpack_result = ""
-            for c in buf[start_byte:end_byte]:
-                if c == 0:
-                    break
-                unpack_result += chr(c)
-        else:
-            unpack_result = 0
-            try:
-                unpack_result = struct.unpack(data_type, buf[start_byte:end_byte])[0]
-            except:
-                log.error("error unpacking EEPROM page %d, offset %d, len %d as %s", page, start_byte, length, data_type, exc_info=1)
-
-        if label is None:
-            log.debug("Unpacked [%s]: %s", data_type, unpack_result)
-        else:
-            log.debug("Unpacked [%s]: %s (%s)", data_type, unpack_result, label)
-        return unpack_result
-
-    ## 
-    # Marshall or serialize a single field at a given buffer offset of the given datatype.
-    #
-    # @param address    a tuple of the form (buf, offset, len)
-    # @param data_type  see https://docs.python.org/2/library/struct.html#format-characters
-    # @param value      value to serialize
-    def pack(self, address, data_type, value, label=None):
-        page       = address[0]
-        start_byte = address[1]
-        length     = address[2]
-        end_byte   = start_byte + length
-
-        if page > len(self.write_buffers):
-            log.error("error unpacking EEPROM page %d, offset %d, len %d as %s: invalid page (label %s)", 
-                page, start_byte, length, data_type, label, exc_info=1)
-            return
-
-        # don't try to write negatives to unsigned types
-        if data_type in ["H", "I"] and value < 0:
-            log.error("rounding negative to zero when writing to unsigned field (address %s, data_type %s, value %s)", address, data_type, value)
-            value = 0
-
-        buf = self.write_buffers[page]
-        if buf is None or end_byte > 64:
-            raise Exception("error packing EEPROM page %d, offset %2d, len %2d as %s: buf is %s" % (
-                page, start_byte, length, data_type, buf))
-
-        if data_type == "s":
-            if value is None:
-                value = ""
-            for i in range(min(length, len(value))):
-                if i < len(value):
-                    buf[start_byte + i] = ord(value[i])
-                else:
-                    buf[start_byte + i] = 0
-        else:
-            struct.pack_into(data_type, buf, start_byte, value)
-
-        extra = "" if label is None else (" (%s)" % label)
-        # log.debug("Packed (%d, %2d, %2d) '%s' value %s -> %s%s", 
-        #     page, start_byte, length, data_type, value, buf[start_byte:end_byte], extra)
-
-    ##
-    # If asked to regenerate, return a digest of the contents that WOULD BE 
-    # WRITTEN from current settings in memory.
-    def generate_digest(self, regenerate=False):
-        buffers = self.buffers
-        if regenerate:
-            self.generate_write_buffers()
-            buffers = self.write_buffers
-
-        h = hashlib.new("md5")
-        for buf in buffers:
-            h.update(bytes(buf))
-        digest = h.hexdigest()
-
-        log.debug("EEPROM MD5 digest = %s (regenerate = %s)", digest, regenerate)
-        return digest
-
-    def to_dict(self):
-        d = {}
-        for k, v in self.__dict__.items():
-            if k not in ["user_data", "buffers", "write_buffers", "editable"]:
-                d[k] = v
-        return d
-
-    ## render the attributes of this object as a JSON string
-    #
-    # @note some callers may prefer SpectrometerSettings.to_dict() or to_json()
-    def json(self, allow_nan=True):
-        tmp_buf  = self.buffers
-        tmp_data = self.user_data
-
-        self.buffers   = str(self.buffers)
-        self.user_data = str(self.user_data)
-
-        # this does take an allow_nan argument, but it throws an exception on NaN, 
-        # rather than replacing with null :-(
-        # https://stackoverflow.com/questions/6601812/sending-nan-in-json
-        s = json.dumps(self.__dict__, indent=2, sort_keys=True)
-        if not allow_nan:
-            s = re.sub(r"\bNaN\b", "null", s)
-
-        self.buffers   = tmp_buf
-        self.user_data = tmp_data
-
-        return s
-
-    ## log this object
-    def dump(self):
-        log.debug("EEPROM settings:")
-        log.debug("  Model:            %s", self.model)
-        log.debug("  Serial Number:    %s", self.serial_number)
-        log.debug("  Baud Rate:        %d", self.baud_rate)
-        log.debug("  Has Cooling:      %s", self.has_cooling)
-        log.debug("  Has Battery:      %s", self.has_battery)
-        log.debug("  Has Laser:        %s", self.has_laser)
-        log.debug("  Invert X-Axis:    %s", self.invert_x_axis)
-        log.debug("  Bin 2x2:          %s", self.bin_2x2)
-        log.debug("  Gen 1.5:          %s", self.gen15)
-        log.debug("  Cutoff Filter:    %s", self.cutoff_filter_installed)
-        log.debug("  HW Even/Odd:      %s", self.hardware_even_odd)
-        log.debug("  SiG Laser TEC:    %s", self.sig_laser_tec)
-        log.debug("  Int'Lck Feedback: %s", self.has_interlock_feedback)
-        log.debug("  Shutter:          %s", self.has_shutter)
-        log.debug("  Excitation:       %s nm", self.excitation_nm)
-        log.debug("  Excitation (f):   %.2f nm", self.excitation_nm_float)
-        log.debug("  Laser Warmup Sec: %d", self.laser_warmup_sec)
-        log.debug("  Laser Watchdog:   %d", self.laser_watchdog_sec)
-        log.debug("  Light Source:     %d", self.light_source_type)
-        log.debug("  Slit size:        %s um", self.slit_size_um)
-        log.debug("  Start Integ Time: %d ms", self.startup_integration_time_ms)
-        log.debug("  Start Temp:       %.2f degC", self.startup_temp_degC)
-        log.debug("  Start Triggering: 0x%04x", self.startup_triggering_scheme)
-        log.debug("  Det Gain:         %f", self.detector_gain)
-        log.debug("  Det Offset:       %d", self.detector_offset)
-        log.debug("  Det Gain Odd:     %f", self.detector_gain_odd)
-        log.debug("  Det Offset Odd:   %d", self.detector_offset_odd)
-        log.debug("")
-        log.debug("  Wavecal coeffs:   %s", self.wavelength_coeffs)
-        log.debug("  degCToDAC coeffs: %s", self.degC_to_dac_coeffs)
-        log.debug("  adcToDegC coeffs: %s", self.adc_to_degC_coeffs)
-        log.debug("  Det temp max:     %s degC", self.max_temp_degC)
-        log.debug("  Det temp min:     %s degC", self.min_temp_degC)
-        log.debug("  TEC R298:         %s", self.tec_r298)
-        log.debug("  TEC beta:         %s", self.tec_beta)
-        log.debug("  Calibration Date: %s", self.calibration_date)
-        log.debug("  Calibration By:   %s", self.calibrated_by)
-        log.debug("")
-        log.debug("  Detector name:    %s", self.detector)
-        log.debug("  Active horiz:     %d", self.active_pixels_horizontal)
-        log.debug("  Active vertical:  %d", self.active_pixels_vertical)
-        log.debug("  Min integration:  %d ms", self.min_integration_time_ms)
-        log.debug("  Max integration:  %d ms", self.max_integration_time_ms)
-        log.debug("  Actual Horiz:     %d", self.actual_horizontal)
-        log.debug("  ROI Horiz Start:  %d", self.roi_horizontal_start)
-        log.debug("  ROI Horiz End:    %d", self.roi_horizontal_end)
-        log.debug("  ROI Vert Reg 1:   (%d, %d)", self.roi_vertical_region_1_start, self.roi_vertical_region_1_end)
-        log.debug("  ROI Vert Reg 2:   (%d, %d)", self.roi_vertical_region_2_start, self.roi_vertical_region_2_end)
-        log.debug("  ROI Vert Reg 3:   (%d, %d)", self.roi_vertical_region_3_start, self.roi_vertical_region_3_end)
-        log.debug("  Linearity Coeffs: %s", self.linearity_coeffs)
-        log.debug("")
-        log.debug("  Laser coeffs:     %s", self.laser_power_coeffs)
-        log.debug("  Max Laser Power:  %s mW", self.max_laser_power_mW)
-        log.debug("  Min Laser Power:  %s mW", self.min_laser_power_mW)
-        log.debug("  Avg Resolution:   %.2f", self.avg_resolution)
-        log.debug("")
-        log.debug("  User Text:        %s", self.user_text)
-        log.debug("")
-        log.debug("  Bad Pixels:       %s", self.bad_pixels)
-        log.debug("  Product Config:   %s", self.product_configuration)
-
-        if self.subformat == 1:
-            self.dump_raman_intensity_calibration()
-        elif self.subformat == 2:
-            self.dump_spline()
-        elif self.subformat == 3:
-            self.dump_raman_intensity_calibration()
-            self.dump_untethered()
-        elif self.subformat == 4:
-            self.dump_regions()
-
-    # ##########################################################################
-    #                                                                          #
-    #                              Convenience accessors                       #
-    #                                                                          #
-    # ##########################################################################
-
-    def latest_rev(self):
-        return EEPROM.LATEST_REV
-
-    ## pixel frame (end is last index, not last+1),
-    def get_horizontal_roi(self):
-        start  = self.roi_horizontal_start
-        end    = self.roi_horizontal_end
-        pixels = self.active_pixels_horizontal
-
-        if 0 <= start and start < end and end < pixels:
-            return ROI(start, end)
-
-    ## 
-    # On a 1024-pixel detector, note the expected / correct result based on the 
-    # roi_horizontal_start/stop fields:
-    #
-    # - (0, 1024) FALSE (last pixel invalid)
-    # - (0, 1023) TRUE  (even though no vignetting is occuring)
-    # - (0, 1022) TRUE  (crops last pixel)
-    # - (1, 1023) TRUE  (crops first pixel)
-    # - (1, 1024) FALSE (last pixel invalid)
-    # - (1,    1) FALSE (start must < end)
-    # - (1,    2) TRUE  (valid 2-pixel spectrum)
-    # - (2,    1) FALSE (start must < end)
-    #   
-    # @return whether a valid horizontal ROI is configured
-    def has_horizontal_roi(self):
-        return self.get_horizontal_roi() is not None
-
-    def has_laser_power_calibration(self):
-        if self.max_laser_power_mW <= 0:
-            return False
-        return utils.coeffs_look_valid(self.laser_power_coeffs, count=4)
-
-    def has_raman_intensity_calibration(self):
-        if self.format < 6:
-            return False
-
-        if 0 < self.raman_intensity_calibration_order <= EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER:
-            return utils.coeffs_look_valid(self.raman_intensity_coeffs, count = self.raman_intensity_calibration_order + 1)
-        return False
-
-    ## convert the given laser output power from milliwatts to percentage
-    #  using the configured calibration
-    def laser_power_mW_to_percent(self, mW):
-        if not self.has_laser_power_calibration():
-            return 0
-
-        perc = self.laser_power_coeffs[0] \
-             + self.laser_power_coeffs[1] * mW \
-             + self.laser_power_coeffs[2] * mW * mW \
-             + self.laser_power_coeffs[3] * mW * mW * mW
-
-        return perc
-
-    # ##########################################################################
-    #                                                                          #
-    #                                 Subformats                               #
-    #                                                                          #
-    # ##########################################################################
-
-    # ##########################################################################
-    # Subformat: Raman Intensity Calibration
-    # ##########################################################################
-
-    def init_raman_intensity_calibration(self):
-        self.raman_intensity_calibration_order = 0
-        self.raman_intensity_coeffs      = []
-
-    def read_raman_intensity_calibration(self):
-        self.raman_intensity_coeffs = []
-        self.raman_intensity_calibration_order = self.unpack((6, 0, 1), "B", "raman_intensity_calibration_order")
-        if 0 == self.raman_intensity_calibration_order:
-            pass
-        elif self.raman_intensity_calibration_order <= EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER:
-            order = self.raman_intensity_calibration_order
-            terms = order + 1
-            for i in range(terms):
-                offset = i * 4 + 1
-                self.raman_intensity_coeffs.append(self.unpack((6, offset, 4), "f", "raman_intensity_coeff_%d" % i))
-        else:
-            log.error("Unsupported Raman Intensity Calibration order: %d", self.raman_intensity_calibration_order)
-
-    def write_raman_intensity_calibration(self):
-        self.pack((6, 0,  1), "B", self.raman_intensity_calibration_order)
-        if 0 <= self.raman_intensity_calibration_order <= EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER:
-            order = self.raman_intensity_calibration_order
-            terms = order + 1
-            for i in range(EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER + 1):
-                offset = i * 4 + 1
-                if i < terms and self.raman_intensity_coeffs is not None and i < len(self.raman_intensity_coeffs):
-                    coeff = self.raman_intensity_coeffs[i]
-                else:
-                    coeff = 0.0
-                # log.debug("packing raman_intensity_coeffs[%d] (offset %d, order %d, terms %d) => %e", i, offset, order, terms, coeff)
-                self.pack((6, offset, 4), "f", coeff)
-        else:
-            log.error("Unsupported Raman Intensity Calibration order: %d", self.raman_intensity_calibration_order)
-            for i in range(EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER + 1):
-                offset = i * 4 + 1
-                self.pack((6, offset, 4), "f", 0.0)
-
-    def dump_raman_intensity_calibration(self):
-        log.debug("Raman Intensity Calibration:")
-        log.debug("  Raman Int Order:  %d", self.raman_intensity_calibration_order)
-        log.debug("  Raman Int Coeffs: %s", self.raman_intensity_coeffs)
-
-    # ##########################################################################
-    # Subformat: Spline
-    # ##########################################################################
-
-    def init_spline(self):
-        self.spline_points               = 0
-        self.spline_min                  = 0
-        self.spline_max                  = 0
-        self.spline_wavelengths          = []
-        self.spline_y                    = []
-        self.spline_y2                   = []
-
-    ##
-    # @todo turn into EEPROMSpline
-    def read_spline(self):
-        self.spline_wavelengths = []
-        self.spline_y = []
-        self.splint_y2 = []
-
-        self.spline_points = self.unpack((6, 0, 1), "B", "spline.points")
-        if self.spline_points <= 0:
-            log.debug("empty spline")
-            return
-
-        if self.spline_points > 14:
-            log.error("invalid spline (%d points)", self.spline_points)
-            return
-
-        for i in len(range(self.spline_points)):
-            if i < 5:
-                page = 6
-                base = 4
-                first = 0
-            elif i < 10:
-                page = 7
-                base = 0
-                first = 5
-            else:
-                page = 4
-                base = 0
-                first = 10
-
-            offset = base + (i - first) * 12
-            wavelength = self.unpack((page, offset, 4), "f", "spline.wavelength[%d]" % i)
-            y  = self.unpack((page, offset + 4, 4), "f", "spline.y[%d]" % i)
-            y2 = self.unpack((page, offset + 8, 4), "f", "spline.y2[%d]" % i)
-
-            self.spline_wavelengths.append(wavelength)
-            self.spline_y.append(y)
-            self.spline_y2.append(y2)
-        
-        self.spline_min = self.unpack((4, 56, 4), "f", "spline_wavelength_min")
-        self.spline_max = self.unpack((4, 60, 4), "f", "spline_wavelength_max")
-        if lo >= hi:
-            log.error("invalid spline (min %f, max %f)", self.spline_min, self.spline_max)
-            return
-
-    def write_spline(self):
-        log.error("EEPROM.write_spline not implemented")
-
-    def dump_spline(self):
-        return # not implemented
-
-    # ##########################################################################
-    # Subformat: Untethered
-    # ##########################################################################
-
-    def init_untethered(self):
-        self.untethered_library_type     = 0
-        self.untethered_library_id       = 0
-        self.untethered_scans_to_average = 0
-        self.untethered_min_ramp_pixels  = 0
-        self.untethered_min_peak_height  = 0
-        self.untethered_match_threshold  = 0
-        self.untethered_library_count    = 0
-                                         
-    def read_untethered(self):
-        self.untethered_library_type     = self.unpack((7,  0,  1), "B", "library_type")
-        self.untethered_library_id       = self.unpack((7,  1,  2), "H", "library_id")
-        self.untethered_scans_to_average = self.unpack((7,  3,  1), "B", "scans_to_average")
-        self.untethered_min_ramp_pixels  = self.unpack((7,  4,  1), "B", "min_ramp_pixels")
-        self.untethered_min_peak_height  = self.unpack((7,  5,  2), "H", "min_peak_height")
-        self.untethered_match_threshold  = self.unpack((7,  7,  1), "B", "match_threshold")
-        self.untethered_library_count    = self.unpack((7,  8,  1), "B", "library_count")
-
-    def write_untethered(self):
-        self.pack((7, 0, 1), "B", self.untethered_library_type)
-        self.pack((7, 1, 2), "H", self.untethered_library_id)
-        self.pack((7, 3, 1), "B", self.untethered_scans_to_average)
-        self.pack((7, 4, 1), "B", self.untethered_min_ramp_pixels)
-        self.pack((7, 5, 2), "H", self.untethered_min_peak_height)
-        self.pack((7, 7, 1), "B", self.untethered_match_threshold)
-        self.pack((7, 8, 1), "B", self.untethered_library_count)
-
-    def dump_untethered(self):
-        log.debug("Untethered:")
-        log.debug("  Library Type:     %d", self.untethered_library_type)
-        log.debug("  Library ID:       %d", self.untethered_library_id)
-        log.debug("  Scans to Average: %d", self.untethered_scans_to_average)
-        log.debug("  Min Ramp Pixels:  %d", self.untethered_min_ramp_pixels)
-        log.debug("  Min Peak Height:  %d", self.untethered_min_peak_height)
-        log.debug("  Match Threshold:  %d", self.untethered_match_threshold)
-        log.debug("  Library Count:    %d", self.untethered_library_count)
-
-    # ##########################################################################
-    # Subformat: Regions
-    # ##########################################################################
-
-    # Already have names in standard format:
-    #
-    # -	R1C0-3: Wavecal Coeff 0-3       (Region 1)
-    # -	R1X0: ROI Horizontal Start      (Region 1)
-    # -	R1X1: ROI Horizontal End        (Region 1)
-    # -	R1Y0: ROI Vertical Region 1 Start
-    # -	R1Y1: ROI Vertical Region 1 End
-    # -	R2Y0: ROI Vertical Region 2 Start
-    # -	R2Y1: ROI Vertical Region 2 End
-    # -	R3Y0: ROI Vertical Region 3 Start
-    # -	R3Y1: ROI Vertical Region 3 End
-
-    def init_regions(self):
-        self.region_count                   = 0
-        self.roi_horiz_region_2_start       = 0
-        self.roi_horiz_region_2_end         = 0
-        self.roi_horiz_region_3_start       = 0
-        self.roi_horiz_region_3_end         = 0
-        self.roi_horiz_region_4_start       = 0
-        self.roi_horiz_region_4_end         = 0
-        self.roi_vertical_region_4_start    = 0
-        self.roi_vertical_region_4_end      = 0
-        self.roi_wavecal_region_2_coeffs    = [ 0, 1, 0, 0 ]
-        self.roi_wavecal_region_3_coeffs    = [ 0, 1, 0, 0 ]
-        self.roi_wavecal_region_4_coeffs    = [ 0, 1, 0, 0 ]
-
-    def read_regions(self):
-        log.debug("read_regions")
-        self.region_count = self.unpack((7, 0, 1), "B", "region_count")
-
-        self.roi_horiz_region_2_start       = self.unpack((6,  0, 2), "H", "roi_horiz_region_2_start")
-        self.roi_horiz_region_2_end         = self.unpack((6,  2, 2), "H", "roi_horiz_region_2_end")
-        self.roi_horiz_region_3_start       = self.unpack((6, 20, 2), "H", "roi_horiz_region_3_start")
-        self.roi_horiz_region_3_end         = self.unpack((6, 22, 2), "H", "roi_horiz_region_3_end")
-        self.roi_horiz_region_4_start       = self.unpack((6, 44, 2), "H", "roi_horiz_region_4_start")
-        self.roi_horiz_region_4_end         = self.unpack((6, 46, 2), "H", "roi_horiz_region_4_end")
-        self.roi_vertical_region_4_start    = self.unpack((6, 40, 2), "H", "roi_vertical_region_4_start")
-        self.roi_vertical_region_4_end      = self.unpack((6, 42, 2), "H", "roi_vertical_region_4_end")
-
-        for i in range(4):
-            self.roi_wavecal_region_2_coeffs[i] = self.unpack((6,  4 + i * 4, 4), "f", f"roi_wavecal_region_2_coeffs[{i}]")
-            self.roi_wavecal_region_3_coeffs[i] = self.unpack((6, 24 + i * 4, 4), "f", f"roi_wavecal_region_3_coeffs[{i}]")
-            self.roi_wavecal_region_4_coeffs[i] = self.unpack((6, 48 + i * 4, 4), "f", f"roi_wavecal_region_4_coeffs[{i}]")
-
-    def write_regions(self):
-        log.debug("write_regions")
-
-        self.pack((7,  0, 1), "B", self.region_count)
-        self.pack((6,  0, 2), "H", self.roi_horiz_region_2_start)
-        self.pack((6,  2, 2), "H", self.roi_horiz_region_2_end)
-        self.pack((6, 20, 2), "H", self.roi_horiz_region_3_start)
-        self.pack((6, 22, 2), "H", self.roi_horiz_region_3_end)
-        self.pack((6, 44, 2), "H", self.roi_horiz_region_4_start)
-        self.pack((6, 46, 2), "H", self.roi_horiz_region_4_end)
-        self.pack((6, 40, 2), "H", self.roi_vertical_region_4_start)
-        self.pack((6, 42, 2), "H", self.roi_vertical_region_4_end)
-                                    
-        for i in range(4):
-            self.pack((6,  4 + i * 4, 4), "f", self.roi_wavecal_region_2_coeffs[i])
-            self.pack((6, 24 + i * 4, 4), "f", self.roi_wavecal_region_3_coeffs[i])
-            self.pack((6, 48 + i * 4, 4), "f", self.roi_wavecal_region_4_coeffs[i])
-
-    def dump_regions(self):
-        log.debug("Regions:")
-        log.debug("  Region Count:             %d", self.region_count)
-        log.debug("  ROI Horiz Region 2 Start: %d", self.roi_horiz_region_2_start)
-        log.debug("  ROI Horiz Region 2 End:   %d", self.roi_horiz_region_2_end)
-        log.debug("  ROI Horiz Region 3 Start: %d", self.roi_horiz_region_3_start)
-        log.debug("  ROI Horiz Region 3 End:   %d", self.roi_horiz_region_3_end)
-        log.debug("  ROI Horiz Region 4 Start: %d", self.roi_horiz_region_4_start)
-        log.debug("  ROI Horiz Region 4 End:   %d", self.roi_horiz_region_4_end)
-        log.debug("  ROI Vert Region 4 Start:  %d", self.roi_vertical_region_4_start)
-        log.debug("  ROI Vert Region 4 End:    %d", self.roi_vertical_region_4_end)
-        log.debug("  Region 2 Wavecal:         %s", self.roi_wavecal_region_2_coeffs)
-        log.debug("  Region 3 Wavecal:         %s", self.roi_wavecal_region_3_coeffs)
-        log.debug("  Region 4 Wavecal:         %s", self.roi_wavecal_region_4_coeffs)
+import hashlib
+import logging
+import struct
+import array
+import math
+import copy
+import json
+import re
+
+from . import utils
+
+from .ROI import ROI
+
+log = logging.getLogger(__name__)
+
+##
+# This class encapsulates the post-read parsing, pre-write marshalling, and current
+# state of the 8-page EEPROM used to store non-volatile configuration data in Wasatch
+# Photonics spectrometers.  It is essential to keep this class synchronized (in naming,
+# datatype / datasize and sequence) with the ENG-0034 customer-facing documentation.
+#
+# This class is normally accessed as an attribute of SpectrometerSettings.
+#
+# @see ENG-0034
+# @see AT24C256C for ARM (32KB, http://ww1.microchip.com/downloads/en/DeviceDoc/20006270A.pdf)
+# @see 24LC128 for FX2 (16KB, https://www.microchip.com/en-us/product/24LC128)
+class EEPROM(object):
+
+    # This was mistakenly set to 15 earlier, probably out of confusion between 
+    # ENG-0001 vs ENG-0034 release level (the former WAS at 15, the latter is
+    # only now advancing to 15).  Leaving it alone for now.
+    LATEST_REV = 15 
+
+    MAX_PAGES = 8
+    PAGE_LENGTH = 64
+    SUBPAGE_COUNT = 4  # is this used for BLE?
+    MAX_RAMAN_INTENSITY_CALIBRATION_ORDER = 7
+
+    DEFAULT_LASER_WATCHDOG_SEC = 10
+
+    def __init__(self):
+        self.model                       = None
+        self.serial_number               = None
+        self.baud_rate                   = 0
+        self.has_cooling                 = False
+        self.has_battery                 = False
+        self.has_laser                   = False
+        self.feature_mask                = 0
+        self.invert_x_axis               = False
+        self.bin_2x2                     = False
+        self.gen15                       = False
+        self.cutoff_filter_installed     = False
+        self.hardware_even_odd           = False
+        self.sig_laser_tec               = False
+        self.has_interlock_feedback      = False
+        self.has_shutter                 = False
+        self.excitation_nm               = 0.0
+        self.excitation_nm_float         = 0.0
+        self.slit_size_um                = 0
+        self.startup_integration_time_ms = 10
+        self.startup_temp_degC           = 15
+        self.startup_triggering_scheme   = 0
+        self.detector_gain               = 1.9
+        self.detector_offset             = 0
+        self.detector_gain_odd           = 1.9
+        self.detector_offset_odd         = 0
+        self.laser_warmup_sec            = 0
+        self.laser_watchdog_sec          = 0
+        self.light_source_type           = 0
+                                         
+        self.wavelength_coeffs           = []
+        self.degC_to_dac_coeffs          = []
+        self.adc_to_degC_coeffs          = []
+        self.max_temp_degC               = 20 
+        self.min_temp_degC               = 10
+        self.tec_r298                    = 0
+        self.tec_beta                    = 0
+        self.calibration_date            = None
+        self.calibrated_by               = None
+                                         
+        self.detector                    = None
+        self.detector_serial_number      = None
+        self.active_pixels_horizontal    = 1024
+        self.active_pixels_vertical      = 0
+        self.min_integration_time_ms     = 10
+        self.max_integration_time_ms     = 60000
+        self.actual_horizontal           = 0
+        self.actual_vertical             = 0     # not a real EEPROM field, though it should be
+        self.roi_horizontal_start        = 0
+        self.roi_horizontal_end          = 0
+        self.roi_vertical_region_1_start = 0
+        self.roi_vertical_region_1_end   = 0
+        self.roi_vertical_region_2_start = 0
+        self.roi_vertical_region_2_end   = 0
+        self.roi_vertical_region_3_start = 0
+        self.roi_vertical_region_3_end   = 0
+        self.linearity_coeffs            = []
+
+        self.max_laser_power_mW          = 0.0
+        self.min_laser_power_mW          = 0.0
+        self.laser_power_coeffs          = []
+        self.avg_resolution              = 0.0
+
+        self.user_data                   = None
+        self.user_text                   = None
+
+        self.bad_pixels                  = [] # should be set, not list (but this works with EEPROMEditor)
+        self.product_configuration       = None
+
+        self.format                      = EEPROM.LATEST_REV
+        self.subformat                   = 0 # pages 6-7
+
+        self.buffers = []
+        self.write_buffers = []
+        self.digest = None
+
+        self.editable = [ "excitation_nm",
+                          "excitation_nm_float",
+                          "detector_gain",
+                          "detector_offset",
+                          "detector_gain_odd",
+                          "detector_offset_odd",
+                          "calibrated_by",
+                          "calibration_date", 
+                          "user_text",
+                          "wavelength_coeffs",
+                          "linearity_coeffs",
+                          "max_laser_power_mW",
+                          "min_laser_power_mW",
+                          "laser_power_coeffs",
+                          "bad_pixels",
+                          "bin_2x2",
+                          "gen15",
+                          "cutoff_filter_installed",
+                          "has_shutter",
+                          "laser_warmup_sec",
+                          "laser_watchdog_sec",
+                          "roi_horizontal_end",             
+                          "roi_horizontal_start",           
+                          "roi_vertical_region_1_end",      
+                          "roi_vertical_region_1_start",    
+                          "roi_vertical_region_2_end",      
+                          "roi_vertical_region_2_start",    
+                          "roi_vertical_region_3_end",      
+                          "roi_vertical_region_3_start",
+                          "raman_intensity_calibration_order",
+                          "raman_intensity_coeffs" ]
+
+        self.init_raman_intensity_calibration()
+        self.init_spline()
+        self.init_untethered()
+        self.init_regions()
+
+    ## whether the given field is normally editable by users via ENLIGHTEN
+    #
+    # @return False otherwise (don't trust in None's truthiness, as you can't 
+    #         pass None to Qt's setEnabled)
+    def is_editable(self, name): # -> bool 
+        s = name.lower()
+        for field in self.editable:
+            if s == field.lower():
+                return True
+        return False
+
+    ## 
+    # passed a temporary copy of another EEPROM object, copy-over any
+    # "editable" fields to this one
+    def update_editable(self, new_eeprom):
+        for field in self.editable:
+            old = getattr(self, field)
+            new = copy.deepcopy(getattr(new_eeprom, field))
+            if old == new:
+                log.debug("  %s: no change (%s == %s)", field, old, new)
+            else:
+                setattr(self, field, new)
+                log.debug("  %s: changed %s --> %s", field, old, new)
+
+    # ##########################################################################
+    #                                                                          #
+    #                               Read EEPROM                                #
+    #                                                                          #
+    # ##########################################################################
+
+    ## 
+    # given a set of the 8 buffers read from a spectrometer via USB,
+    # parse those into the approrpriate fields and datatypes
+    def parse(self, buffers): # -> bool 
+        if len(buffers) < EEPROM.MAX_PAGES:
+            log.error("EEPROM.parse expects at least %d buffers", EEPROM.MAX_PAGES)
+            return False
+
+        # store these locally so self.unpack() can access them
+        self.buffers = buffers
+        self.digest = self.generate_digest()
+
+        # unpack all the fields we know about
+        try:
+            self.read_eeprom()
+            return True
+        except:
+            log.error("failed to parse EEPROM", exc_info=1)
+            return False
+
+    ## 
+    # Assuming a set of 8 buffers have been passed in via parse(), actually
+    # unpack (deserialize / unmarshall) the binary data into the appropriate
+    # fields and datatypes.
+    # 
+    # @see https://docs.python.org/2/library/struct.html#format-characters
+    # (capitals are unsigned)
+    def read_eeprom(self):
+        self.format = self.unpack((0, 63,  1), "B", "format")
+        log.debug("parsing EEPROM format %d", self.format)
+
+        # ######################################################################
+        # Page 0
+        # ######################################################################
+
+        self.model                           = self.unpack((0,  0, 16), "s", "model")
+        self.serial_number                   = self.unpack((0, 16, 16), "s", "serial")
+        self.baud_rate                       = self.unpack((0, 32,  4), "I", "baud")
+        self.has_cooling                     = self.unpack((0, 36,  1), "?", "cooling")
+        self.has_battery                     = self.unpack((0, 37,  1), "?", "battery")
+        self.has_laser                       = self.unpack((0, 38,  1), "?", "laser")
+        if self.format > 9:
+            self.feature_mask                = self.unpack((0, 39,  2), "H", "feature_mask")
+        elif self.format >= 3:
+            self.excitation_nm               = self.unpack((0, 39,  2), "H", "excitation_nm (unsigned)")
+        else:
+            self.excitation_nm               = self.unpack((0, 39,  2), "h", "excitation_nm (signed)")
+
+        if self.format >= 4:
+            self.slit_size_um                = self.unpack((0, 41,  2), "H", "slit (unsigned)")
+        else:
+            self.slit_size_um                = self.unpack((0, 41,  2), "h", "slit (signed)")
+
+        # NOTE: the new InGaAs detector gain/offset won't be usable from 
+        #       EEPROM until we start bumping production spectrometers to
+        #       EEPROM Page 0 Revision 3!
+        if self.format >= 3:
+            self.startup_integration_time_ms = self.unpack((0, 43,  2), "H", "start_integ")
+            self.startup_temp_degC           = self.unpack((0, 45,  2), "h", "start_temp")
+            self.startup_triggering_scheme   = self.unpack((0, 47,  1), "B", "start_trigger")
+            self.detector_gain               = self.unpack((0, 48,  4), "f", "gain") # "even pixels" for InGaAs
+            self.detector_offset             = self.unpack((0, 52,  2), "h", "offset") # "even pixels" for InGaAs
+            self.detector_gain_odd           = self.unpack((0, 54,  4), "f", "gain_odd") # InGaAs-only
+            self.detector_offset_odd         = self.unpack((0, 58,  2), "h", "offset_odd") # InGaAs-only
+
+        # ######################################################################
+        # Page 1
+        # ######################################################################
+
+        self.wavelength_coeffs = []
+        self.wavelength_coeffs         .append(self.unpack((1,  0,  4), "f", "wavecal_coeff_0"))
+        self.wavelength_coeffs         .append(self.unpack((1,  4,  4), "f"))
+        self.wavelength_coeffs         .append(self.unpack((1,  8,  4), "f"))
+        self.wavelength_coeffs         .append(self.unpack((1, 12,  4), "f"))
+        self.degC_to_dac_coeffs = []
+        self.degC_to_dac_coeffs        .append(self.unpack((1, 16,  4), "f", "degCtoDAC_coeff_0"))
+        self.degC_to_dac_coeffs        .append(self.unpack((1, 20,  4), "f"))
+        self.degC_to_dac_coeffs        .append(self.unpack((1, 24,  4), "f"))
+        self.max_temp_degC                   = self.unpack((1, 28,  2), "h", "max_temp")
+        self.min_temp_degC                   = self.unpack((1, 30,  2), "h", "min_temp")
+        self.adc_to_degC_coeffs = []
+        self.adc_to_degC_coeffs        .append(self.unpack((1, 32,  4), "f", "adcToDegC_coeff_0"))
+        self.adc_to_degC_coeffs        .append(self.unpack((1, 36,  4), "f"))
+        self.adc_to_degC_coeffs        .append(self.unpack((1, 40,  4), "f"))
+        self.tec_r298                        = self.unpack((1, 44,  2), "h", "r298")
+        self.tec_beta                        = self.unpack((1, 46,  2), "h", "beta")
+        self.calibration_date                = self.unpack((1, 48, 12), "s", "date")
+        self.calibrated_by                   = self.unpack((1, 60,  3), "s", "tech")
+                                    
+        # ######################################################################
+        # Page 2                    
+        # ######################################################################
+
+        self.detector                        = self.unpack((2,  0, 16), "s", "detector")
+        self.active_pixels_horizontal        = self.unpack((2, 16,  2), "H", "pixels")
+        if self.format >= 10:
+            self.laser_warmup_sec            = self.unpack((2, 18,  1), "B", "laser_warmup_sec")
+        self.active_pixels_vertical          = self.unpack((2, 19,  2), "H" if self.format >= 4 else "h")
+
+        if self.format >= 8:
+            self.wavelength_coeffs     .append(self.unpack((2, 21,  4), "f", "wavecal_coeff_4"))
+        else:
+            # just go ahead and initialize the 5th coeff to zero
+            self.wavelength_coeffs.append(0)
+            if self.format < 5:
+                self.min_integration_time_ms     = self.unpack((2, 21,  2), "H", "min_integ(ushort)")
+                self.max_integration_time_ms     = self.unpack((2, 23,  2), "H", "max_integ(ushort)") 
+
+        self.actual_horizontal               = self.unpack((2, 25,  2), "H" if self.format >= 4 else "h", "actual_horiz")
+        self.actual_vertical                 = self.active_pixels_vertical  # approximate for now
+        self.roi_horizontal_start            = self.unpack((2, 27,  2), "H" if self.format >= 4 else "h")
+        self.roi_horizontal_end              = self.unpack((2, 29,  2), "H" if self.format >= 4 else "h")
+        self.roi_vertical_region_1_start     = self.unpack((2, 31,  2), "H" if self.format >= 4 else "h")
+        self.roi_vertical_region_1_end       = self.unpack((2, 33,  2), "H" if self.format >= 4 else "h")
+        self.roi_vertical_region_2_start     = self.unpack((2, 35,  2), "H" if self.format >= 4 else "h")
+        self.roi_vertical_region_2_end       = self.unpack((2, 37,  2), "H" if self.format >= 4 else "h")
+        self.roi_vertical_region_3_start     = self.unpack((2, 39,  2), "H" if self.format >= 4 else "h")
+        self.roi_vertical_region_3_end       = self.unpack((2, 41,  2), "H" if self.format >= 4 else "h")
+        self.linearity_coeffs = []
+        self.linearity_coeffs          .append(self.unpack((2, 43,  4), "f", "linearity_coeff_0")) # overloading for secondary ADC
+        self.linearity_coeffs          .append(self.unpack((2, 47,  4), "f"))
+        self.linearity_coeffs          .append(self.unpack((2, 51,  4), "f"))
+        self.linearity_coeffs          .append(self.unpack((2, 55,  4), "f"))
+        self.linearity_coeffs          .append(self.unpack((2, 59,  4), "f"))
+
+        # ######################################################################
+        # Page 3
+        # ######################################################################
+        
+        self.laser_power_coeffs = []
+        self.laser_power_coeffs        .append(self.unpack((3, 12,  4), "f", "laser_power_coeff_0"))
+        self.laser_power_coeffs        .append(self.unpack((3, 16,  4), "f"))
+        self.laser_power_coeffs        .append(self.unpack((3, 20,  4), "f"))
+        self.laser_power_coeffs        .append(self.unpack((3, 24,  4), "f"))
+        self.max_laser_power_mW              = self.unpack((3, 28,  4), "f", "max_laser_mW")
+        self.min_laser_power_mW              = self.unpack((3, 32,  4), "f", "min_laser_mW")
+
+        if self.format >= 4:
+            self.excitation_nm_float         = self.unpack((3, 36,  4), "f", "excitation(float)")
+        else:
+            self.excitation_nm_float = self.excitation_nm
+
+        if self.format >= 5:
+            self.min_integration_time_ms     = self.unpack((3, 40,  4), "I", "min_integ(uint)")
+            self.max_integration_time_ms     = self.unpack((3, 44,  4), "I", "max_integ(uint)") 
+
+        if self.format >= 7:
+            self.avg_resolution              = self.unpack((3, 48,  4), "f", "avg_resolution")
+
+        if self.format >= 15:
+            self.laser_watchdog_sec          = self.unpack((3, 52,  2), "H", "laser_watchdog_sec")
+            self.light_source_type           = self.unpack((3, 54,  1), "B", "light_source_type")
+
+        # ######################################################################
+        # Page 4
+        # ######################################################################
+
+        self.user_data = self.buffers[4][:63]
+        self.user_text = self.printable(self.user_data)
+
+        # ######################################################################
+        # Page 5
+        # ######################################################################
+
+        bad = set()
+        for count in range(15):
+            pixel = self.unpack((5, count * 2, 2), "h")
+            if pixel != -1:
+                bad.add(pixel)
+        self.bad_pixels = list(bad)
+        self.bad_pixels.sort()
+
+        if self.format >= 5:
+            self.product_configuration       = self.unpack((5,  30, 16), "s", "product_config")
+        if self.format >= 7:
+            self.subformat                   = self.unpack((5,  63,  1), "B", "subformat")
+
+        # ######################################################################
+        # Page 6-7
+        # ######################################################################
+
+        if self.subformat == 0:
+            pass
+        elif self.subformat == 1:
+            self.read_raman_intensity_calibration()
+        elif self.subformat == 2:
+            self.read_spline()
+        elif self.subformat == 3:
+            self.read_untethered()
+        elif self.subformat == 4:
+            self.read_regions()
+        else:
+            log.debug(f"Unreadable EEPROM subformat {self.subformat}")
+        
+        # ######################################################################
+        # feature mask
+        # ######################################################################
+
+        if self.format >= 9:
+            self.invert_x_axis           = 0 != self.feature_mask & 0x0001
+            self.bin_2x2                 = 0 != self.feature_mask & 0x0002
+            self.gen15                   = 0 != self.feature_mask & 0x0004
+            self.cutoff_filter_installed = 0 != self.feature_mask & 0x0008
+            self.hardware_even_odd       = 0 != self.feature_mask & 0x0010
+            self.sig_laser_tec           = 0 != self.feature_mask & 0x0020
+            self.has_interlock_feedback  = 0 != self.feature_mask & 0x0040
+            self.has_shutter             = 0 != self.feature_mask & 0x0080
+        else:
+            self.invert_x_axis           = 0 
+            self.bin_2x2                 = 0
+            self.gen15                   = 0
+            self.cutoff_filter_installed = 0
+            self.hardware_even_odd       = 0
+            self.sig_laser_tec           = 0
+            self.has_interlock_feedback  = 0
+            self.has_shutter             = 0
+
+        # ######################################################################
+        # sanity checks
+        # ######################################################################
+
+        utils.clean_nan(self.wavelength_coeffs)
+
+        if self.min_integration_time_ms == 0xffff:
+            self.min_integration_time_ms = 1 
+            self.max_integration_time_ms = 60000
+
+        if self.min_integration_time_ms > self.max_integration_time_ms:
+            (self.min_integration_time_ms, self.max_integration_time_ms) = \
+            (self.max_integration_time_ms, self.min_integration_time_ms)
+
+        if self.startup_integration_time_ms < self.min_integration_time_ms:
+            self.startup_integration_time_ms = self.min_integration_time_ms
+
+        if self.min_temp_degC > self.max_temp_degC:
+            (self.min_temp_degC, self.max_temp_degC) = \
+            (self.max_temp_degC, self.min_temp_degC) 
+
+        if self.min_laser_power_mW > self.max_laser_power_mW:
+            (self.min_laser_power_mW, self.max_laser_power_mW) = \
+            (self.max_laser_power_mW, self.min_laser_power_mW)
+
+    ############################################################################
+    #                                                                          #
+    #                               Write EEPROM                               #
+    #                                                                          #
+    ############################################################################
+
+    def generate_feature_mask(self):
+        mask = 0
+        mask |= 0x0001 if self.invert_x_axis           else 0
+        mask |= 0x0002 if self.bin_2x2                 else 0
+        mask |= 0x0004 if self.gen15                   else 0
+        mask |= 0x0008 if self.cutoff_filter_installed else 0
+        mask |= 0x0010 if self.hardware_even_odd       else 0
+        mask |= 0x0020 if self.sig_laser_tec           else 0
+        mask |= 0x0040 if self.has_interlock_feedback  else 0
+        mask |= 0x0080 if self.has_shutter             else 0
+        return mask
+
+    ##
+    # Call this to populate an internal array of "write buffers" which may be written back
+    # to spectrometers (or used to generate the digest of what WOULD be written).
+    def generate_write_buffers(self):
+        # stub-out 8 blank buffers
+        self.write_buffers = []
+        for page in range(EEPROM.MAX_PAGES):
+            self.write_buffers.append(array.array('B', [0] * 64))
+
+        # Eventually we'll stop worrying about the legacy per-page format versions, but
+        # for now maximize compatibility with StrokerConsole/ModelConfigurationFormat.cs
+        # by making its expected format values the default for each page:
+        revs = { 0: 1,
+                 1: 1,
+                 2: 2, 
+                 3: 255,
+                 4: 1, 
+                 5: 1,
+                 6: 0 }
+        for page in list(revs.keys()):
+            self.write_buffers[page][63] = revs[page]
+
+        # ...but the truth is that we don't really care about the old per-page formats,
+        # and all modern code should just be looking at this one byte:
+        self.write_buffers[0][63] = EEPROM.LATEST_REV
+
+        # ######################################################################
+        # Page 0
+        # ######################################################################
+
+        self.pack((0,  0, 16), "s", self.model)
+        self.pack((0, 16, 16), "s", self.serial_number)
+        self.pack((0, 32,  4), "I", self.baud_rate)
+        self.pack((0, 36,  1), "?", self.has_cooling)
+        self.pack((0, 37,  1), "?", self.has_battery)
+        self.pack((0, 38,  1), "?", self.has_laser)
+        self.pack((0, 39,  2), "H", self.generate_feature_mask(), "FeatureMask")
+        self.pack((0, 41,  2), "H", self.slit_size_um)
+        self.pack((0, 43,  2), "H", self.startup_integration_time_ms)
+        self.pack((0, 45,  2), "h", self.startup_temp_degC)
+        self.pack((0, 47,  1), "B", self.startup_triggering_scheme)
+        self.pack((0, 48,  4), "f", self.detector_gain)
+        self.pack((0, 52,  2), "h", self.detector_offset)
+        self.pack((0, 54,  4), "f", self.detector_gain_odd)
+        self.pack((0, 58,  2), "h", self.detector_offset_odd)
+
+        # ######################################################################
+        # Page 1
+        # ######################################################################
+
+        if self.wavelength_coeffs is not None:
+            for i in range(min(4, len(self.wavelength_coeffs))):
+                self.pack((1,  0 + i * 4,  4), "f", self.wavelength_coeffs[i])
+                
+        if self.degC_to_dac_coeffs is not None:
+            for i in range(min(3, len(self.degC_to_dac_coeffs))):
+                self.pack((1, 16 + i * 4,  4), "f", self.degC_to_dac_coeffs[i])
+
+        if self.adc_to_degC_coeffs is not None:
+            for i in range(min(3, len(self.adc_to_degC_coeffs))):
+                self.pack((1, 32 + i * 4,  4), "f", self.adc_to_degC_coeffs[i])
+
+        self.pack((1, 28,  2), "h", self.max_temp_degC)
+        self.pack((1, 30,  2), "h", self.min_temp_degC)
+        self.pack((1, 44,  2), "h", self.tec_r298)
+        self.pack((1, 46,  2), "h", self.tec_beta)
+        self.pack((1, 48, 12), "s", self.calibration_date)
+        self.pack((1, 60,  3), "s", self.calibrated_by)
+                                    
+        # ######################################################################
+        # Page 2                    
+        # ######################################################################
+
+        self.pack((2,  0, 16), "s", self.detector)
+        self.pack((2, 16,  2), "H", self.active_pixels_horizontal)
+        self.pack((2, 18,  1), "B", self.laser_warmup_sec)
+        self.pack((2, 19,  2), "H", self.active_pixels_vertical)
+        if self.format < 7:
+            self.pack((2, 21,  2), "H", max(0xffff, self.min_integration_time_ms))
+            self.pack((2, 23,  2), "H", max(0xffff, self.max_integration_time_ms))
+        else:
+            coeff = 0.0
+            if len(self.wavelength_coeffs) > 4:
+                coeff = self.wavelength_coeffs[4]
+            self.pack((2, 21,  4), "f", coeff)
+        self.pack((2, 25,  2), "H", self.actual_horizontal)
+        self.pack((2, 27,  2), "H", self.roi_horizontal_start)
+        self.pack((2, 29,  2), "H", self.roi_horizontal_end)
+        self.pack((2, 31,  2), "H", self.roi_vertical_region_1_start)
+        self.pack((2, 33,  2), "H", self.roi_vertical_region_1_end)
+        self.pack((2, 35,  2), "H", self.roi_vertical_region_2_start)
+        self.pack((2, 37,  2), "H", self.roi_vertical_region_2_end)
+        self.pack((2, 39,  2), "H", self.roi_vertical_region_3_start)
+        self.pack((2, 41,  2), "H", self.roi_vertical_region_3_end)
+
+        if self.linearity_coeffs is not None:
+            for i in range(min(5, len(self.linearity_coeffs))):
+                self.pack((2, 43 + i * 4,  4), "f", self.linearity_coeffs[i])
+
+        # ######################################################################
+        # Page 3
+        # ######################################################################
+
+        if self.laser_power_coeffs is not None:
+            for i in range(min(4, len(self.laser_power_coeffs))):
+                self.pack((3, 12 + i * 4,  4), "f", self.laser_power_coeffs[i])
+
+        self.pack((3, 28,  4), "f", self.max_laser_power_mW)
+        self.pack((3, 32,  4), "f", self.min_laser_power_mW)
+        self.pack((3, 36,  4), "f", self.excitation_nm_float)
+        self.pack((3, 40,  4), "I", self.min_integration_time_ms)
+        self.pack((3, 44,  4), "I", self.max_integration_time_ms)
+        self.pack((3, 48,  4), "f", self.avg_resolution)
+        self.pack((3, 52,  2), "H", self.laser_watchdog_sec)
+        self.pack((3, 54,  1), "B", self.light_source_type)
+
+        # ######################################################################
+        # Page 4
+        # ######################################################################
+
+        self.pack((4,  0, 63), "s", self.user_text)
+
+        # ######################################################################
+        # Page 5
+        # ######################################################################
+
+        bad_pixel_set = set()
+        for i in self.bad_pixels:
+            if i >= 0:
+                bad_pixel_set.add(i)
+        bad_pixels = list(bad_pixel_set)
+        bad_pixels.sort()
+        for i in range(15):
+            if i < len(bad_pixels):
+                value = bad_pixels[i]
+            else:
+                value = -1
+            self.pack((5, i * 2, 2), "h", value)
+
+        self.pack((5, 30, 16), "s", self.product_configuration)
+        self.pack((5, 63,  1), "B", self.subformat)
+
+        # ######################################################################
+        # Page 6-7
+        # ######################################################################
+
+        if self.subformat == 0:
+            pass
+        elif self.subformat == 1:
+            self.write_raman_intensity_calibration()
+        elif self.subformat == 2:
+            self.write_spline()
+        elif self.subformat == 3:
+            self.write_untethered()
+        elif self.subformat == 4:
+            self.write_regions()
+        else:
+            log.error(f"Unwriteable EEPROM subformat {self.subformat}")
+
+    # ##########################################################################
+    #                                                                          #
+    #                             Utility methods                              #
+    #                                                                          #
+    # ##########################################################################
+
+    ## make a printable ASCII string out of possibly-binary data
+    def printable(self, buf):
+        s = ""
+        for c in buf:
+            if 31 < c < 127:
+                s += chr(c)
+            elif c == 0:
+                break
+            else:
+                s += '.'
+        return s
+
+    def set(self, name, value):
+        setattr(self, name, value)
+
+    ##
+    # Convert a floating-point value into the big-endian 16-bit "funky float" 
+    # used for detector gain in the FPGA on both Hamamatsu and IMX sensors.
+    #
+    # Note that this TRUNCATES (takes the floor) the fractional portion rather 
+    # than rounding, which I believe matches WasatchNET.FunkyFloat.fromFloat().
+    #
+    # Conversely, it DOES provide minor rounding on the INTEGRAL portion, to 
+    # avoid this problem:
+    #
+    # \verbatim
+    # dB = 0
+    # while dB < 2.1:
+    #     self.set_detector_gain(dB) # old code treats 1.0 as 0.0 because actually sends 0.99999999
+    #     dB += 0.1
+    # \endverbatim
+    #
+    # @see https://wasatchphotonics.com/api/Wasatch.NET/class_wasatch_n_e_t_1_1_funky_float.html
+    def float_to_uint16(self, gain):
+        msb = int(round(gain, 5)) & 0xff
+        # if self.format >= 13: lsb = round((gain - msb) * 256) & 0xff
+        lsb = int((gain - msb) * 256) & 0xff
+        raw = (msb << 8) | lsb
+        log.debug("float_to_uint16: %f -> 0x%04x", gain, raw)
+        return raw
+
+    ## 
+    # Unpack a single field at a given buffer offset of the given datatype.
+    #
+    # @param address    a tuple of the form (buf, offset, len)
+    # @param data_type  see https://docs.python.org/2/library/struct.html#format-characters
+    # @param label      if provided, is included in debug log output
+    def unpack(self, address, data_type, label=None):
+        page       = address[0]
+        start_byte = address[1]
+        length     = address[2]
+        end_byte   = start_byte + length
+
+        if page > len(self.buffers):
+            log.error("error unpacking EEPROM page %d, offset %d, len %d as %s: invalid page (label %s)", 
+                page, start_byte, length, data_type, label, exc_info=1)
+            return
+
+        buf = self.buffers[page]
+        if buf is None or end_byte > len(buf):
+            log.error("error unpacking EEPROM page %d, offset %d, len %d as %s: buf is %s (label %s)", 
+                page, start_byte, length, data_type, buf, label, exc_info=1)
+            return
+
+        if data_type == "s":
+            # This stops at the first NULL, so is not appropriate for binary data (user_data).
+            # OTOH, it doesn't currently enforce "printable" characters either (nor support Unicode).
+            unpack_result = ""
+            for c in buf[start_byte:end_byte]:
+                if c == 0:
+                    break
+                unpack_result += chr(c)
+        else:
+            unpack_result = 0
+            try:
+                unpack_result = struct.unpack(data_type, buf[start_byte:end_byte])[0]
+            except:
+                log.error("error unpacking EEPROM page %d, offset %d, len %d as %s", page, start_byte, length, data_type, exc_info=1)
+
+        if label is None:
+            log.debug("Unpacked [%s]: %s", data_type, unpack_result)
+        else:
+            log.debug("Unpacked [%s]: %s (%s)", data_type, unpack_result, label)
+        return unpack_result
+
+    ## 
+    # Marshall or serialize a single field at a given buffer offset of the given datatype.
+    #
+    # @param address    a tuple of the form (buf, offset, len)
+    # @param data_type  see https://docs.python.org/2/library/struct.html#format-characters
+    # @param value      value to serialize
+    def pack(self, address, data_type, value, label=None):
+        page       = address[0]
+        start_byte = address[1]
+        length     = address[2]
+        end_byte   = start_byte + length
+
+        if page > len(self.write_buffers):
+            log.error("error unpacking EEPROM page %d, offset %d, len %d as %s: invalid page (label %s)", 
+                page, start_byte, length, data_type, label, exc_info=1)
+            return
+
+        # don't try to write negatives to unsigned types
+        if data_type in ["H", "I"] and value < 0:
+            log.error("rounding negative to zero when writing to unsigned field (address %s, data_type %s, value %s)", address, data_type, value)
+            value = 0
+
+        buf = self.write_buffers[page]
+        if buf is None or end_byte > 64:
+            raise Exception("error packing EEPROM page %d, offset %2d, len %2d as %s: buf is %s" % (
+                page, start_byte, length, data_type, buf))
+
+        if data_type == "s":
+            if value is None:
+                value = ""
+            for i in range(min(length, len(value))):
+                if i < len(value):
+                    buf[start_byte + i] = ord(value[i])
+                else:
+                    buf[start_byte + i] = 0
+        else:
+            struct.pack_into(data_type, buf, start_byte, value)
+
+        extra = "" if label is None else (" (%s)" % label)
+        # log.debug("Packed (%d, %2d, %2d) '%s' value %s -> %s%s", 
+        #     page, start_byte, length, data_type, value, buf[start_byte:end_byte], extra)
+
+    ##
+    # If asked to regenerate, return a digest of the contents that WOULD BE 
+    # WRITTEN from current settings in memory.
+    def generate_digest(self, regenerate=False):
+        buffers = self.buffers
+        if regenerate:
+            self.generate_write_buffers()
+            buffers = self.write_buffers
+
+        h = hashlib.new("md5")
+        for buf in buffers:
+            h.update(bytes(buf))
+        digest = h.hexdigest()
+
+        log.debug("EEPROM MD5 digest = %s (regenerate = %s)", digest, regenerate)
+        return digest
+
+    def to_dict(self):
+        d = {}
+        for k, v in self.__dict__.items():
+            if k not in ["user_data", "buffers", "write_buffers", "editable"]:
+                d[k] = v
+        return d
+
+    ## render the attributes of this object as a JSON string
+    #
+    # @note some callers may prefer SpectrometerSettings.to_dict() or to_json()
+    def json(self, allow_nan=True):
+        tmp_buf  = self.buffers
+        tmp_data = self.user_data
+
+        self.buffers   = str(self.buffers)
+        self.user_data = str(self.user_data)
+
+        # this does take an allow_nan argument, but it throws an exception on NaN, 
+        # rather than replacing with null :-(
+        # https://stackoverflow.com/questions/6601812/sending-nan-in-json
+        s = json.dumps(self.__dict__, indent=2, sort_keys=True)
+        if not allow_nan:
+            s = re.sub(r"\bNaN\b", "null", s)
+
+        self.buffers   = tmp_buf
+        self.user_data = tmp_data
+
+        return s
+
+    ## log this object
+    def dump(self):
+        log.debug("EEPROM settings:")
+        log.debug("  Model:            %s", self.model)
+        log.debug("  Serial Number:    %s", self.serial_number)
+        log.debug("  Baud Rate:        %d", self.baud_rate)
+        log.debug("  Has Cooling:      %s", self.has_cooling)
+        log.debug("  Has Battery:      %s", self.has_battery)
+        log.debug("  Has Laser:        %s", self.has_laser)
+        log.debug("  Invert X-Axis:    %s", self.invert_x_axis)
+        log.debug("  Bin 2x2:          %s", self.bin_2x2)
+        log.debug("  Gen 1.5:          %s", self.gen15)
+        log.debug("  Cutoff Filter:    %s", self.cutoff_filter_installed)
+        log.debug("  HW Even/Odd:      %s", self.hardware_even_odd)
+        log.debug("  SiG Laser TEC:    %s", self.sig_laser_tec)
+        log.debug("  Int'Lck Feedback: %s", self.has_interlock_feedback)
+        log.debug("  Shutter:          %s", self.has_shutter)
+        log.debug("  Excitation:       %s nm", self.excitation_nm)
+        log.debug("  Excitation (f):   %.2f nm", self.excitation_nm_float)
+        log.debug("  Laser Warmup Sec: %d", self.laser_warmup_sec)
+        log.debug("  Laser Watchdog:   %d", self.laser_watchdog_sec)
+        log.debug("  Light Source:     %d", self.light_source_type)
+        log.debug("  Slit size:        %s um", self.slit_size_um)
+        log.debug("  Start Integ Time: %d ms", self.startup_integration_time_ms)
+        log.debug("  Start Temp:       %.2f degC", self.startup_temp_degC)
+        log.debug("  Start Triggering: 0x%04x", self.startup_triggering_scheme)
+        log.debug("  Det Gain:         %f", self.detector_gain)
+        log.debug("  Det Offset:       %d", self.detector_offset)
+        log.debug("  Det Gain Odd:     %f", self.detector_gain_odd)
+        log.debug("  Det Offset Odd:   %d", self.detector_offset_odd)
+        log.debug("")
+        log.debug("  Wavecal coeffs:   %s", self.wavelength_coeffs)
+        log.debug("  degCToDAC coeffs: %s", self.degC_to_dac_coeffs)
+        log.debug("  adcToDegC coeffs: %s", self.adc_to_degC_coeffs)
+        log.debug("  Det temp max:     %s degC", self.max_temp_degC)
+        log.debug("  Det temp min:     %s degC", self.min_temp_degC)
+        log.debug("  TEC R298:         %s", self.tec_r298)
+        log.debug("  TEC beta:         %s", self.tec_beta)
+        log.debug("  Calibration Date: %s", self.calibration_date)
+        log.debug("  Calibration By:   %s", self.calibrated_by)
+        log.debug("")
+        log.debug("  Detector name:    %s", self.detector)
+        log.debug("  Active horiz:     %d", self.active_pixels_horizontal)
+        log.debug("  Active vertical:  %d", self.active_pixels_vertical)
+        log.debug("  Min integration:  %d ms", self.min_integration_time_ms)
+        log.debug("  Max integration:  %d ms", self.max_integration_time_ms)
+        log.debug("  Actual Horiz:     %d", self.actual_horizontal)
+        log.debug("  ROI Horiz Start:  %d", self.roi_horizontal_start)
+        log.debug("  ROI Horiz End:    %d", self.roi_horizontal_end)
+        log.debug("  ROI Vert Reg 1:   (%d, %d)", self.roi_vertical_region_1_start, self.roi_vertical_region_1_end)
+        log.debug("  ROI Vert Reg 2:   (%d, %d)", self.roi_vertical_region_2_start, self.roi_vertical_region_2_end)
+        log.debug("  ROI Vert Reg 3:   (%d, %d)", self.roi_vertical_region_3_start, self.roi_vertical_region_3_end)
+        log.debug("  Linearity Coeffs: %s", self.linearity_coeffs)
+        log.debug("")
+        log.debug("  Laser coeffs:     %s", self.laser_power_coeffs)
+        log.debug("  Max Laser Power:  %s mW", self.max_laser_power_mW)
+        log.debug("  Min Laser Power:  %s mW", self.min_laser_power_mW)
+        log.debug("  Avg Resolution:   %.2f", self.avg_resolution)
+        log.debug("")
+        log.debug("  User Text:        %s", self.user_text)
+        log.debug("")
+        log.debug("  Bad Pixels:       %s", self.bad_pixels)
+        log.debug("  Product Config:   %s", self.product_configuration)
+
+        if self.subformat == 1:
+            self.dump_raman_intensity_calibration()
+        elif self.subformat == 2:
+            self.dump_spline()
+        elif self.subformat == 3:
+            self.dump_raman_intensity_calibration()
+            self.dump_untethered()
+        elif self.subformat == 4:
+            self.dump_regions()
+
+    # ##########################################################################
+    #                                                                          #
+    #                              Convenience accessors                       #
+    #                                                                          #
+    # ##########################################################################
+
+    def latest_rev(self):
+        return EEPROM.LATEST_REV
+
+    ## pixel frame (end is last index, not last+1),
+    def get_horizontal_roi(self):
+        start  = self.roi_horizontal_start
+        end    = self.roi_horizontal_end
+        pixels = self.active_pixels_horizontal
+
+        if 0 <= start and start < end and end < pixels:
+            return ROI(start, end)
+
+    ## 
+    # On a 1024-pixel detector, note the expected / correct result based on the 
+    # roi_horizontal_start/stop fields:
+    #
+    # - (0, 1024) FALSE (last pixel invalid)
+    # - (0, 1023) TRUE  (even though no vignetting is occuring)
+    # - (0, 1022) TRUE  (crops last pixel)
+    # - (1, 1023) TRUE  (crops first pixel)
+    # - (1, 1024) FALSE (last pixel invalid)
+    # - (1,    1) FALSE (start must < end)
+    # - (1,    2) TRUE  (valid 2-pixel spectrum)
+    # - (2,    1) FALSE (start must < end)
+    #   
+    # @return whether a valid horizontal ROI is configured
+    def has_horizontal_roi(self): # -> bool 
+        return self.get_horizontal_roi() is not None
+
+    def has_laser_power_calibration(self): # -> bool 
+        if self.max_laser_power_mW <= 0:
+            return False
+        return utils.coeffs_look_valid(self.laser_power_coeffs, count=4)
+
+    def has_detector_tec_calibration(self): # -> bool 
+        """ simplified version of WasatchNET.Util.validTECCal """
+
+        if not utils.coeffs_look_valid(self.degC_to_dac_coeffs, count=3):
+            return False
+
+        # check it's not the "default"
+        if self.degC_to_dac_coeffs[0] == 2700 and \
+           self.degC_to_dac_coeffs[1] == 0 and \
+           self.degC_to_dac_coeffs[2] == 0:
+            return False
+
+        return True
+
+    def has_raman_intensity_calibration(self): # -> bool 
+        if self.format < 6:
+            log.debug(f"has_raman_intensity_calibration: false because format {self.format}")
+            return False
+
+        if not (0 < self.raman_intensity_calibration_order <= EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER):
+            log.debug(f"has_raman_intensity_calibration: false because invalid order {self.raman_intensity_calibration_order}")
+            return False
+            
+        if not utils.coeffs_look_valid(self.raman_intensity_coeffs, count = self.raman_intensity_calibration_order + 1):
+            log.debug(f"has_raman_intensity_calibration: false because coeffs look weird")
+            return False
+
+        return True
+
+    ## convert the given laser output power from milliwatts to percentage
+    #  using the configured calibration
+    def laser_power_mW_to_percent(self, mW):
+        if not self.has_laser_power_calibration():
+            return 0
+
+        perc = self.laser_power_coeffs[0] \
+             + self.laser_power_coeffs[1] * mW \
+             + self.laser_power_coeffs[2] * mW * mW \
+             + self.laser_power_coeffs[3] * mW * mW * mW
+
+        return perc
+
+    # ##########################################################################
+    #                                                                          #
+    #                                 Subformats                               #
+    #                                                                          #
+    # ##########################################################################
+
+    # ##########################################################################
+    # Subformat: Raman Intensity Calibration
+    # ##########################################################################
+
+    def init_raman_intensity_calibration(self):
+        self.raman_intensity_calibration_order = 0
+        self.raman_intensity_coeffs      = []
+
+    def read_raman_intensity_calibration(self):
+        self.raman_intensity_coeffs = []
+        self.raman_intensity_calibration_order = self.unpack((6, 0, 1), "B", "raman_intensity_calibration_order")
+        if 0 == self.raman_intensity_calibration_order:
+            pass
+        elif self.raman_intensity_calibration_order <= EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER:
+            order = self.raman_intensity_calibration_order
+            terms = order + 1
+            for i in range(terms):
+                offset = i * 4 + 1
+                self.raman_intensity_coeffs.append(self.unpack((6, offset, 4), "f", "raman_intensity_coeff_%d" % i))
+        else:
+            log.error("Unsupported Raman Intensity Calibration order: %d", self.raman_intensity_calibration_order)
+
+    def write_raman_intensity_calibration(self):
+        self.pack((6, 0,  1), "B", self.raman_intensity_calibration_order)
+        if 0 <= self.raman_intensity_calibration_order <= EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER:
+            order = self.raman_intensity_calibration_order
+            terms = order + 1
+            for i in range(EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER + 1):
+                offset = i * 4 + 1
+                if i < terms and self.raman_intensity_coeffs is not None and i < len(self.raman_intensity_coeffs):
+                    coeff = self.raman_intensity_coeffs[i]
+                else:
+                    coeff = 0.0
+                # log.debug("packing raman_intensity_coeffs[%d] (offset %d, order %d, terms %d) => %e", i, offset, order, terms, coeff)
+                self.pack((6, offset, 4), "f", coeff)
+        else:
+            log.error("Unsupported Raman Intensity Calibration order: %d", self.raman_intensity_calibration_order)
+            for i in range(EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER + 1):
+                offset = i * 4 + 1
+                self.pack((6, offset, 4), "f", 0.0)
+
+    def dump_raman_intensity_calibration(self):
+        log.debug("Raman Intensity Calibration:")
+        log.debug("  Raman Int Order:  %d", self.raman_intensity_calibration_order)
+        log.debug("  Raman Int Coeffs: %s", self.raman_intensity_coeffs)
+
+    # ##########################################################################
+    # Subformat: Spline
+    # ##########################################################################
+
+    def init_spline(self):
+        self.spline_points               = 0
+        self.spline_min                  = 0
+        self.spline_max                  = 0
+        self.spline_wavelengths          = []
+        self.spline_y                    = []
+        self.spline_y2                   = []
+
+    ##
+    # @todo turn into EEPROMSpline
+    def read_spline(self):
+        self.spline_wavelengths = []
+        self.spline_y = []
+        self.splint_y2 = []
+
+        self.spline_points = self.unpack((6, 0, 1), "B", "spline.points")
+        if self.spline_points <= 0:
+            log.debug("empty spline")
+            return
+
+        if self.spline_points > 14:
+            log.error("invalid spline (%d points)", self.spline_points)
+            return
+
+        for i in len(range(self.spline_points)):
+            if i < 5:
+                page = 6
+                base = 4
+                first = 0
+            elif i < 10:
+                page = 7
+                base = 0
+                first = 5
+            else:
+                page = 4
+                base = 0
+                first = 10
+
+            offset = base + (i - first) * 12
+            wavelength = self.unpack((page, offset, 4), "f", "spline.wavelength[%d]" % i)
+            y  = self.unpack((page, offset + 4, 4), "f", "spline.y[%d]" % i)
+            y2 = self.unpack((page, offset + 8, 4), "f", "spline.y2[%d]" % i)
+
+            self.spline_wavelengths.append(wavelength)
+            self.spline_y.append(y)
+            self.spline_y2.append(y2)
+        
+        self.spline_min = self.unpack((4, 56, 4), "f", "spline_wavelength_min")
+        self.spline_max = self.unpack((4, 60, 4), "f", "spline_wavelength_max")
+        if lo >= hi:
+            log.error("invalid spline (min %f, max %f)", self.spline_min, self.spline_max)
+            return
+
+    def write_spline(self):
+        log.error("EEPROM.write_spline not implemented")
+
+    def dump_spline(self):
+        return # not implemented
+
+    # ##########################################################################
+    # Subformat: Untethered
+    # ##########################################################################
+
+    def init_untethered(self):
+        self.untethered_library_type     = 0
+        self.untethered_library_id       = 0
+        self.untethered_scans_to_average = 0
+        self.untethered_min_ramp_pixels  = 0
+        self.untethered_min_peak_height  = 0
+        self.untethered_match_threshold  = 0
+        self.untethered_library_count    = 0
+                                         
+    def read_untethered(self):
+        self.untethered_library_type     = self.unpack((7,  0,  1), "B", "library_type")
+        self.untethered_library_id       = self.unpack((7,  1,  2), "H", "library_id")
+        self.untethered_scans_to_average = self.unpack((7,  3,  1), "B", "scans_to_average")
+        self.untethered_min_ramp_pixels  = self.unpack((7,  4,  1), "B", "min_ramp_pixels")
+        self.untethered_min_peak_height  = self.unpack((7,  5,  2), "H", "min_peak_height")
+        self.untethered_match_threshold  = self.unpack((7,  7,  1), "B", "match_threshold")
+        self.untethered_library_count    = self.unpack((7,  8,  1), "B", "library_count")
+
+    def write_untethered(self):
+        self.pack((7, 0, 1), "B", self.untethered_library_type)
+        self.pack((7, 1, 2), "H", self.untethered_library_id)
+        self.pack((7, 3, 1), "B", self.untethered_scans_to_average)
+        self.pack((7, 4, 1), "B", self.untethered_min_ramp_pixels)
+        self.pack((7, 5, 2), "H", self.untethered_min_peak_height)
+        self.pack((7, 7, 1), "B", self.untethered_match_threshold)
+        self.pack((7, 8, 1), "B", self.untethered_library_count)
+
+    def dump_untethered(self):
+        log.debug("Untethered:")
+        log.debug("  Library Type:     %d", self.untethered_library_type)
+        log.debug("  Library ID:       %d", self.untethered_library_id)
+        log.debug("  Scans to Average: %d", self.untethered_scans_to_average)
+        log.debug("  Min Ramp Pixels:  %d", self.untethered_min_ramp_pixels)
+        log.debug("  Min Peak Height:  %d", self.untethered_min_peak_height)
+        log.debug("  Match Threshold:  %d", self.untethered_match_threshold)
+        log.debug("  Library Count:    %d", self.untethered_library_count)
+
+    # ##########################################################################
+    # Subformat: Regions
+    # ##########################################################################
+
+    # Already have names in standard format:
+    #
+    # -	R1C0-3: Wavecal Coeff 0-3       (Region 1)
+    # -	R1X0: ROI Horizontal Start      (Region 1)
+    # -	R1X1: ROI Horizontal End        (Region 1)
+    # -	R1Y0: ROI Vertical Region 1 Start
+    # -	R1Y1: ROI Vertical Region 1 End
+    # -	R2Y0: ROI Vertical Region 2 Start
+    # -	R2Y1: ROI Vertical Region 2 End
+    # -	R3Y0: ROI Vertical Region 3 Start
+    # -	R3Y1: ROI Vertical Region 3 End
+
+    def init_regions(self):
+        self.region_count                   = 0
+        self.roi_horiz_region_2_start       = 0
+        self.roi_horiz_region_2_end         = 0
+        self.roi_horiz_region_3_start       = 0
+        self.roi_horiz_region_3_end         = 0
+        self.roi_horiz_region_4_start       = 0
+        self.roi_horiz_region_4_end         = 0
+        self.roi_vertical_region_4_start    = 0
+        self.roi_vertical_region_4_end      = 0
+        self.roi_wavecal_region_2_coeffs    = [ 0, 1, 0, 0 ]
+        self.roi_wavecal_region_3_coeffs    = [ 0, 1, 0, 0 ]
+        self.roi_wavecal_region_4_coeffs    = [ 0, 1, 0, 0 ]
+
+    def read_regions(self):
+        log.debug("read_regions")
+        self.region_count = self.unpack((7, 0, 1), "B", "region_count")
+
+        self.roi_horiz_region_2_start       = self.unpack((6,  0, 2), "H", "roi_horiz_region_2_start")
+        self.roi_horiz_region_2_end         = self.unpack((6,  2, 2), "H", "roi_horiz_region_2_end")
+        self.roi_horiz_region_3_start       = self.unpack((6, 20, 2), "H", "roi_horiz_region_3_start")
+        self.roi_horiz_region_3_end         = self.unpack((6, 22, 2), "H", "roi_horiz_region_3_end")
+        self.roi_horiz_region_4_start       = self.unpack((6, 44, 2), "H", "roi_horiz_region_4_start")
+        self.roi_horiz_region_4_end         = self.unpack((6, 46, 2), "H", "roi_horiz_region_4_end")
+        self.roi_vertical_region_4_start    = self.unpack((6, 40, 2), "H", "roi_vertical_region_4_start")
+        self.roi_vertical_region_4_end      = self.unpack((6, 42, 2), "H", "roi_vertical_region_4_end")
+
+        for i in range(4):
+            self.roi_wavecal_region_2_coeffs[i] = self.unpack((6,  4 + i * 4, 4), "f", f"roi_wavecal_region_2_coeffs[{i}]")
+            self.roi_wavecal_region_3_coeffs[i] = self.unpack((6, 24 + i * 4, 4), "f", f"roi_wavecal_region_3_coeffs[{i}]")
+            self.roi_wavecal_region_4_coeffs[i] = self.unpack((6, 48 + i * 4, 4), "f", f"roi_wavecal_region_4_coeffs[{i}]")
+
+    def write_regions(self):
+        log.debug("write_regions")
+
+        self.pack((7,  0, 1), "B", self.region_count)
+        self.pack((6,  0, 2), "H", self.roi_horiz_region_2_start)
+        self.pack((6,  2, 2), "H", self.roi_horiz_region_2_end)
+        self.pack((6, 20, 2), "H", self.roi_horiz_region_3_start)
+        self.pack((6, 22, 2), "H", self.roi_horiz_region_3_end)
+        self.pack((6, 44, 2), "H", self.roi_horiz_region_4_start)
+        self.pack((6, 46, 2), "H", self.roi_horiz_region_4_end)
+        self.pack((6, 40, 2), "H", self.roi_vertical_region_4_start)
+        self.pack((6, 42, 2), "H", self.roi_vertical_region_4_end)
+                                    
+        for i in range(4):
+            self.pack((6,  4 + i * 4, 4), "f", self.roi_wavecal_region_2_coeffs[i])
+            self.pack((6, 24 + i * 4, 4), "f", self.roi_wavecal_region_3_coeffs[i])
+            self.pack((6, 48 + i * 4, 4), "f", self.roi_wavecal_region_4_coeffs[i])
+
+    def dump_regions(self):
+        log.debug("Regions:")
+        log.debug("  Region Count:             %d", self.region_count)
+        log.debug("  ROI Horiz Region 2 Start: %d", self.roi_horiz_region_2_start)
+        log.debug("  ROI Horiz Region 2 End:   %d", self.roi_horiz_region_2_end)
+        log.debug("  ROI Horiz Region 3 Start: %d", self.roi_horiz_region_3_start)
+        log.debug("  ROI Horiz Region 3 End:   %d", self.roi_horiz_region_3_end)
+        log.debug("  ROI Horiz Region 4 Start: %d", self.roi_horiz_region_4_start)
+        log.debug("  ROI Horiz Region 4 End:   %d", self.roi_horiz_region_4_end)
+        log.debug("  ROI Vert Region 4 Start:  %d", self.roi_vertical_region_4_start)
+        log.debug("  ROI Vert Region 4 End:    %d", self.roi_vertical_region_4_end)
+        log.debug("  Region 2 Wavecal:         %s", self.roi_wavecal_region_2_coeffs)
+        log.debug("  Region 3 Wavecal:         %s", self.roi_wavecal_region_3_coeffs)
+        log.debug("  Region 4 Wavecal:         %s", self.roi_wavecal_region_4_coeffs)
```

### Comparing `wasatch-2.1.24/wasatch/EEPROM_multical.sav` & `wasatch-2.1.32/wasatch/EEPROM_multical.sav`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/FPGAOptions.py` & `wasatch-2.1.32/wasatch/FPGAOptions.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/FeatureIdentificationDevice.py` & `wasatch-2.1.32/wasatch/FeatureIdentificationDevice.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,8737 +1,9151 @@
 00000000: 696d 706f 7274 2073 7562 7072 6f63 6573  import subproces
-00000010: 730a 696d 706f 7274 2070 6c61 7466 6f72  s.import platfor
-00000020: 6d0a 696d 706f 7274 2064 6174 6574 696d  m.import datetim
-00000030: 650a 696d 706f 7274 206c 6f67 6769 6e67  e.import logging
-00000040: 0a69 6d70 6f72 7420 7261 6e64 6f6d 0a69  .import random.i
-00000050: 6d70 6f72 7420 636f 7079 0a69 6d70 6f72  mport copy.impor
-00000060: 7420 6d61 7468 0a69 6d70 6f72 7420 7573  t math.import us
-00000070: 620a 696d 706f 7274 2075 7362 2e63 6f72  b.import usb.cor
-00000080: 650a 696d 706f 7274 2075 7362 2e75 7469  e.import usb.uti
-00000090: 6c0a 696d 706f 7274 206f 730a 696d 706f  l.import os.impo
-000000a0: 7274 2072 650a 0a66 726f 6d20 7479 7069  rt re..from typi
-000000b0: 6e67 2069 6d70 6f72 7420 5479 7065 5661  ng import TypeVa
-000000c0: 722c 2041 6e79 2c20 4361 6c6c 6162 6c65  r, Any, Callable
-000000d0: 0a66 726f 6d20 7261 6e64 6f6d 2069 6d70  .from random imp
-000000e0: 6f72 7420 7261 6e64 696e 740a 6672 6f6d  ort randint.from
-000000f0: 2074 696d 6520 2020 696d 706f 7274 2073   time   import s
-00000100: 6c65 6570 0a0a 6672 6f6d 202e 2069 6d70  leep..from . imp
-00000110: 6f72 7420 7574 696c 730a 0a66 726f 6d20  ort utils..from 
-00000120: 2e53 7065 6374 726f 6d65 7465 7253 6574  .SpectrometerSet
-00000130: 7469 6e67 7320 696d 706f 7274 2053 7065  tings import Spe
-00000140: 6374 726f 6d65 7465 7253 6574 7469 6e67  ctrometerSetting
-00000150: 730a 6672 6f6d 202e 5370 6563 7472 6f6d  s.from .Spectrom
-00000160: 6574 6572 5265 7370 6f6e 7365 2069 6d70  eterResponse imp
-00000170: 6f72 7420 5370 6563 7472 6f6d 6574 6572  ort Spectrometer
-00000180: 5265 7370 6f6e 7365 0a66 726f 6d20 2e53  Response.from .S
-00000190: 7065 6374 726f 6d65 7465 7252 6571 7565  pectrometerReque
-000001a0: 7374 2020 696d 706f 7274 2053 7065 6374  st  import Spect
-000001b0: 726f 6d65 7465 7252 6571 7565 7374 0a66  rometerRequest.f
-000001c0: 726f 6d20 2e53 7065 6374 726f 6d65 7465  rom .Spectromete
-000001d0: 7252 6573 706f 6e73 6520 696d 706f 7274  rResponse import
-000001e0: 2045 7272 6f72 4c65 7665 6c0a 6672 6f6d   ErrorLevel.from
-000001f0: 202e 5370 6563 7472 6f6d 6574 6572 5374   .SpectrometerSt
-00000200: 6174 6520 2020 2069 6d70 6f72 7420 5370  ate    import Sp
-00000210: 6563 7472 6f6d 6574 6572 5374 6174 650a  ectrometerState.
-00000220: 6672 6f6d 202e 496e 7465 7266 6163 6544  from .InterfaceD
-00000230: 6576 6963 6520 2020 2020 2069 6d70 6f72  evice      impor
-00000240: 7420 496e 7465 7266 6163 6544 6576 6963  t InterfaceDevic
-00000250: 650a 6672 6f6d 202e 4465 7465 6374 6f72  e.from .Detector
-00000260: 5265 6769 6f6e 7320 2020 2020 2069 6d70  Regions      imp
-00000270: 6f72 7420 4465 7465 6374 6f72 5265 6769  ort DetectorRegi
-00000280: 6f6e 730a 6672 6f6d 202e 5374 6174 7573  ons.from .Status
-00000290: 4d65 7373 6167 6520 2020 2020 2020 2069  Message        i
-000002a0: 6d70 6f72 7420 5374 6174 7573 4d65 7373  mport StatusMess
-000002b0: 6167 650a 6672 6f6d 202e 5265 616c 5553  age.from .RealUS
-000002c0: 4244 6576 6963 6520 2020 2020 2020 2069  BDevice        i
-000002d0: 6d70 6f72 7420 5265 616c 5553 4244 6576  mport RealUSBDev
-000002e0: 6963 650a 6672 6f6d 202e 4d6f 636b 5553  ice.from .MockUS
-000002f0: 4244 6576 6963 6520 2020 2020 2020 2069  BDevice        i
-00000300: 6d70 6f72 7420 4d6f 636b 5553 4244 6576  mport MockUSBDev
-00000310: 6963 650a 6672 6f6d 202e 4465 7465 6374  ice.from .Detect
-00000320: 6f72 524f 4920 2020 2020 2020 2020 2069  orROI          i
-00000330: 6d70 6f72 7420 4465 7465 6374 6f72 524f  mport DetectorRO
-00000340: 490a 6672 6f6d 202e 4545 5052 4f4d 2020  I.from .EEPROM  
-00000350: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
-00000360: 6f72 7420 4545 5052 4f4d 0a0a 6c6f 6720  ort EEPROM..log 
-00000370: 3d20 6c6f 6767 696e 672e 6765 744c 6f67  = logging.getLog
-00000380: 6765 7228 5f5f 6e61 6d65 5f5f 290a 0a4d  ger(__name__)..M
-00000390: 4943 524f 5345 435f 544f 5f53 4543 203d  ICROSEC_TO_SEC =
-000003a0: 2030 2e30 3030 3030 310a 554e 494e 4954   0.000001.UNINIT
-000003b0: 4941 4c49 5a45 445f 5445 4d50 4552 4154  IALIZED_TEMPERAT
-000003c0: 5552 455f 4445 475f 4320 3d20 2d39 3939  URE_DEG_C = -999
-000003d0: 0a0a 636c 6173 7320 5370 6563 7472 756d  ..class Spectrum
-000003e0: 416e 6452 6f77 3a0a 2020 2020 6465 6620  AndRow:.    def 
-000003f0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
-00000400: 7065 6374 7275 6d3d 4e6f 6e65 2c20 726f  pectrum=None, ro
-00000410: 773d 2d31 293a 0a20 2020 2020 2020 2073  w=-1):.        s
-00000420: 656c 662e 7370 6563 7472 756d 203d 204e  elf.spectrum = N
-00000430: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-00000440: 2e72 6f77 203d 2072 6f77 0a0a 2020 2020  .row = row..    
-00000450: 2020 2020 6966 2073 7065 6374 7275 6d20      if spectrum 
-00000460: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00000470: 2020 2020 2020 2020 2073 656c 662e 7370           self.sp
-00000480: 6563 7472 756d 203d 2073 7065 6374 7275  ectrum = spectru
-00000490: 6d2e 636f 7079 2829 0a0a 636c 6173 7320  m.copy()..class 
-000004a0: 4665 6174 7572 6549 6465 6e74 6966 6963  FeatureIdentific
-000004b0: 6174 696f 6e44 6576 6963 6528 496e 7465  ationDevice(Inte
-000004c0: 7266 6163 6544 6576 6963 6529 3a0a 2020  rfaceDevice):.  
-000004d0: 2020 2222 220a 2020 2020 5468 6973 2069    """.    This i
-000004e0: 7320 7468 6520 6261 7369 6320 696d 706c  s the basic impl
-000004f0: 656d 656e 7461 7469 6f6e 206f 6620 6f75  ementation of ou
-00000500: 7220 4665 6174 7572 6549 6465 6e74 6966  r FeatureIdentif
-00000510: 6963 6174 696f 6e44 6576 6963 6520 2846  icationDevice (F
-00000520: 4944 290a 2020 2020 7370 6563 7472 6f6d  ID).    spectrom
-00000530: 6574 6572 2055 5342 2041 5049 2061 7320  eter USB API as 
-00000540: 6465 6669 6e65 6420 696e 2045 4e47 2d30  defined in ENG-0
-00000550: 3030 312e 0a20 2020 2054 6869 7320 636c  001..    This cl
-00000560: 6173 7320 6973 2072 6f75 6768 6c79 2063  ass is roughly c
-00000570: 6f6d 7061 7261 626c 6520 746f 2057 6173  omparable to Was
-00000580: 6174 6368 2e4e 4554 2773 2053 7065 6374  atch.NET's Spect
-00000590: 726f 6d65 7465 722e 6373 2e0a 2020 2020  rometer.cs..    
-000005a0: 0a20 2020 2054 6869 7320 636c 6173 7320  .    This class 
-000005b0: 6973 206e 6f72 6d61 6c6c 7920 6e6f 7420  is normally not 
-000005c0: 6163 6365 7373 6564 2064 6972 6563 746c  accessed directl
-000005d0: 792c 2062 7574 2074 6872 6f75 6768 2074  y, but through t
-000005e0: 6865 2068 6967 6865 722d 6c65 7665 6c0a  he higher-level.
-000005f0: 2020 2020 6162 7374 7261 6374 696f 6e20      abstraction 
-00000600: 5761 7361 7463 6844 6576 6963 652e 0a20  WasatchDevice.. 
-00000610: 2020 200a 2020 2020 4073 6565 2045 4e47     .    @see ENG
-00000620: 2d30 3030 310a 2020 2020 2323 2323 2323  -0001.    ######
-00000630: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000670: 2323 2323 0a20 2020 2054 6869 7320 636c  ####.    This cl
-00000680: 6173 7320 6164 6f70 7473 2074 6865 2065  ass adopts the e
-00000690: 7874 6572 6e61 6c20 6465 7669 6365 2069  xternal device i
-000006a0: 6e74 6572 6661 6365 2073 7472 7563 7475  nterface structu
-000006b0: 7265 0a20 2020 2054 6869 7320 696e 766c  re.    This invl
-000006c0: 6f76 6c65 7320 7265 6365 6976 696e 6720  ovles receiving 
-000006d0: 6120 7265 7175 6573 7420 7468 726f 7567  a request throug
-000006e0: 6820 7468 6520 6861 6e64 6c65 5f72 6571  h the handle_req
-000006f0: 7565 7374 2066 756e 6374 696f 6e0a 2020  uest function.  
-00000700: 2020 4120 7265 7175 6573 7420 6973 2070    A request is p
-00000710: 726f 6365 7373 6564 2062 6173 6564 206f  rocessed based o
-00000720: 6e20 7468 6520 6b65 7920 696e 2074 6865  n the key in the
-00000730: 2072 6571 7565 7374 0a20 2020 2054 6865   request.    The
-00000740: 2070 726f 6365 7373 696e 6720 6675 6e63   processing func
-00000750: 7469 6f6e 2070 6173 7365 7320 7468 6520  tion passes the 
-00000760: 636f 6d6d 616e 6473 2074 6f20 7468 6520  commands to the 
-00000770: 7265 7175 6573 7465 6420 6465 7669 6365  requested device
-00000780: 0a20 2020 204f 6e63 6520 6974 2072 6563  .    Once it rec
-00000790: 6576 6965 7320 6120 7265 7370 6f6e 7365  evies a response
-000007a0: 2066 726f 6d20 7468 6520 636f 6e6e 6563   from the connec
-000007b0: 7465 6420 6465 7669 6365 2069 7420 7468  ted device it th
-000007c0: 656e 2070 6173 7365 7320 7468 6174 0a20  en passes that. 
-000007d0: 2020 2062 6163 6b20 7570 2074 6865 2063     back up the c
-000007e0: 6861 696e 0a20 2020 2020 2020 2020 2020  hain.           
-000007f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000800: 2020 2020 456e 6c69 6768 7465 6e20 5265      Enlighten Re
-00000810: 7175 6573 740a 2020 2020 2020 2020 2020  quest.          
-00000820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000830: 2020 2020 2020 2020 2020 2020 207c 0a20               |. 
-00000840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000850: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00000860: 616e 646c 655f 7265 7175 6573 7473 0a20  andle_requests. 
-00000870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000010: 730d 0a69 6d70 6f72 7420 706c 6174 666f  s..import platfo
+00000020: 726d 0d0a 696d 706f 7274 2064 6174 6574  rm..import datet
+00000030: 696d 650d 0a69 6d70 6f72 7420 6c6f 6767  ime..import logg
+00000040: 696e 670d 0a69 6d70 6f72 7420 7261 6e64  ing..import rand
+00000050: 6f6d 0d0a 696d 706f 7274 2063 6f70 790d  om..import copy.
+00000060: 0a69 6d70 6f72 7420 6d61 7468 0d0a 696d  .import math..im
+00000070: 706f 7274 2075 7362 0d0a 696d 706f 7274  port usb..import
+00000080: 2075 7362 2e63 6f72 650d 0a69 6d70 6f72   usb.core..impor
+00000090: 7420 7573 622e 7574 696c 0d0a 696d 706f  t usb.util..impo
+000000a0: 7274 206f 730d 0a69 6d70 6f72 7420 7265  rt os..import re
+000000b0: 0d0a 0d0a 6672 6f6d 2074 7970 696e 6720  ....from typing 
+000000c0: 696d 706f 7274 2054 7970 6556 6172 2c20  import TypeVar, 
+000000d0: 416e 792c 2043 616c 6c61 626c 650d 0a66  Any, Callable..f
+000000e0: 726f 6d20 7261 6e64 6f6d 2069 6d70 6f72  rom random impor
+000000f0: 7420 7261 6e64 696e 740d 0a66 726f 6d20  t randint..from 
+00000100: 7469 6d65 2020 2069 6d70 6f72 7420 736c  time   import sl
+00000110: 6565 700d 0a0d 0a66 726f 6d20 2e20 696d  eep....from . im
+00000120: 706f 7274 2075 7469 6c73 0d0a 0d0a 6672  port utils....fr
+00000130: 6f6d 202e 5370 6563 7472 6f6d 6574 6572  om .Spectrometer
+00000140: 5365 7474 696e 6773 2069 6d70 6f72 7420  Settings import 
+00000150: 5370 6563 7472 6f6d 6574 6572 5365 7474  SpectrometerSett
+00000160: 696e 6773 0d0a 6672 6f6d 202e 5370 6563  ings..from .Spec
+00000170: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00000180: 2069 6d70 6f72 7420 5370 6563 7472 6f6d   import Spectrom
+00000190: 6574 6572 5265 7370 6f6e 7365 0d0a 6672  eterResponse..fr
+000001a0: 6f6d 202e 5370 6563 7472 6f6d 6574 6572  om .Spectrometer
+000001b0: 5265 7175 6573 7420 2069 6d70 6f72 7420  Request  import 
+000001c0: 5370 6563 7472 6f6d 6574 6572 5265 7175  SpectrometerRequ
+000001d0: 6573 740d 0a66 726f 6d20 2e53 7065 6374  est..from .Spect
+000001e0: 726f 6d65 7465 7252 6573 706f 6e73 6520  rometerResponse 
+000001f0: 696d 706f 7274 2045 7272 6f72 4c65 7665  import ErrorLeve
+00000200: 6c0d 0a66 726f 6d20 2e53 7065 6374 726f  l..from .Spectro
+00000210: 6d65 7465 7253 7461 7465 2020 2020 696d  meterState    im
+00000220: 706f 7274 2053 7065 6374 726f 6d65 7465  port Spectromete
+00000230: 7253 7461 7465 0d0a 6672 6f6d 202e 496e  rState..from .In
+00000240: 7465 7266 6163 6544 6576 6963 6520 2020  terfaceDevice   
+00000250: 2020 2069 6d70 6f72 7420 496e 7465 7266     import Interf
+00000260: 6163 6544 6576 6963 650d 0a66 726f 6d20  aceDevice..from 
+00000270: 2e44 6574 6563 746f 7252 6567 696f 6e73  .DetectorRegions
+00000280: 2020 2020 2020 696d 706f 7274 2044 6574        import Det
+00000290: 6563 746f 7252 6567 696f 6e73 0d0a 6672  ectorRegions..fr
+000002a0: 6f6d 202e 5374 6174 7573 4d65 7373 6167  om .StatusMessag
+000002b0: 6520 2020 2020 2020 2069 6d70 6f72 7420  e        import 
+000002c0: 5374 6174 7573 4d65 7373 6167 650d 0a66  StatusMessage..f
+000002d0: 726f 6d20 2e52 6561 6c55 5342 4465 7669  rom .RealUSBDevi
+000002e0: 6365 2020 2020 2020 2020 696d 706f 7274  ce        import
+000002f0: 2052 6561 6c55 5342 4465 7669 6365 0d0a   RealUSBDevice..
+00000300: 6672 6f6d 202e 4d6f 636b 5553 4244 6576  from .MockUSBDev
+00000310: 6963 6520 2020 2020 2020 2069 6d70 6f72  ice        impor
+00000320: 7420 4d6f 636b 5553 4244 6576 6963 650d  t MockUSBDevice.
+00000330: 0a66 726f 6d20 2e44 6574 6563 746f 7252  .from .DetectorR
+00000340: 4f49 2020 2020 2020 2020 2020 696d 706f  OI          impo
+00000350: 7274 2044 6574 6563 746f 7252 4f49 0d0a  rt DetectorROI..
+00000360: 6672 6f6d 202e 4545 5052 4f4d 2020 2020  from .EEPROM    
+00000370: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
+00000380: 7420 4545 5052 4f4d 0d0a 0d0a 6c6f 6720  t EEPROM....log 
+00000390: 3d20 6c6f 6767 696e 672e 6765 744c 6f67  = logging.getLog
+000003a0: 6765 7228 5f5f 6e61 6d65 5f5f 290d 0a0d  ger(__name__)...
+000003b0: 0a4d 4943 524f 5345 435f 544f 5f53 4543  .MICROSEC_TO_SEC
+000003c0: 203d 2030 2e30 3030 3030 310d 0a55 4e49   = 0.000001..UNI
+000003d0: 4e49 5449 414c 495a 4544 5f54 454d 5045  NITIALIZED_TEMPE
+000003e0: 5241 5455 5245 5f44 4547 5f43 203d 202d  RATURE_DEG_C = -
+000003f0: 3939 390d 0a0d 0a63 6c61 7373 2053 7065  999....class Spe
+00000400: 6374 7275 6d41 6e64 526f 773a 0d0a 2020  ctrumAndRow:..  
+00000410: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00000420: 656c 662c 2073 7065 6374 7275 6d3d 4e6f  elf, spectrum=No
+00000430: 6e65 2c20 726f 773d 2d31 293a 0d0a 2020  ne, row=-1):..  
+00000440: 2020 2020 2020 7365 6c66 2e73 7065 6374        self.spect
+00000450: 7275 6d20 3d20 4e6f 6e65 0d0a 2020 2020  rum = None..    
+00000460: 2020 2020 7365 6c66 2e72 6f77 203d 2072      self.row = r
+00000470: 6f77 0d0a 0d0a 2020 2020 2020 2020 6966  ow....        if
+00000480: 2073 7065 6374 7275 6d20 6973 206e 6f74   spectrum is not
+00000490: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+000004a0: 2020 2020 7365 6c66 2e73 7065 6374 7275      self.spectru
+000004b0: 6d20 3d20 7370 6563 7472 756d 2e63 6f70  m = spectrum.cop
+000004c0: 7928 290d 0a0d 0a63 6c61 7373 2046 6561  y()....class Fea
+000004d0: 7475 7265 4964 656e 7469 6669 6361 7469  tureIdentificati
+000004e0: 6f6e 4465 7669 6365 2849 6e74 6572 6661  onDevice(Interfa
+000004f0: 6365 4465 7669 6365 293a 0d0a 2020 2020  ceDevice):..    
+00000500: 2222 220d 0a20 2020 2054 6869 7320 6973  """..    This is
+00000510: 2074 6865 2062 6173 6963 2069 6d70 6c65   the basic imple
+00000520: 6d65 6e74 6174 696f 6e20 6f66 206f 7572  mentation of our
+00000530: 2046 6561 7475 7265 4964 656e 7469 6669   FeatureIdentifi
+00000540: 6361 7469 6f6e 4465 7669 6365 2028 4649  cationDevice (FI
+00000550: 4429 0d0a 2020 2020 7370 6563 7472 6f6d  D)..    spectrom
+00000560: 6574 6572 2055 5342 2041 5049 2061 7320  eter USB API as 
+00000570: 6465 6669 6e65 6420 696e 2045 4e47 2d30  defined in ENG-0
+00000580: 3030 312e 0d0a 2020 2020 5468 6973 2063  001...    This c
+00000590: 6c61 7373 2069 7320 726f 7567 686c 7920  lass is roughly 
+000005a0: 636f 6d70 6172 6162 6c65 2074 6f20 5761  comparable to Wa
+000005b0: 7361 7463 682e 4e45 5427 7320 5370 6563  satch.NET's Spec
+000005c0: 7472 6f6d 6574 6572 2e63 732e 0d0a 2020  trometer.cs...  
+000005d0: 2020 0d0a 2020 2020 5468 6973 2063 6c61    ..    This cla
+000005e0: 7373 2069 7320 6e6f 726d 616c 6c79 206e  ss is normally n
+000005f0: 6f74 2061 6363 6573 7365 6420 6469 7265  ot accessed dire
+00000600: 6374 6c79 2c20 6275 7420 7468 726f 7567  ctly, but throug
+00000610: 6820 7468 6520 6869 6768 6572 2d6c 6576  h the higher-lev
+00000620: 656c 0d0a 2020 2020 6162 7374 7261 6374  el..    abstract
+00000630: 696f 6e20 5761 7361 7463 6844 6576 6963  ion WasatchDevic
+00000640: 652e 0d0a 2020 2020 0d0a 2020 2020 4073  e...    ..    @s
+00000650: 6565 2045 4e47 2d30 3030 310d 0a20 2020  ee ENG-0001..   
+00000660: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00000670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000680: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000006a0: 2323 2323 2323 2323 2323 230d 0a20 2020  ###########..   
+000006b0: 2054 6869 7320 636c 6173 7320 6164 6f70   This class adop
+000006c0: 7473 2074 6865 2065 7874 6572 6e61 6c20  ts the external 
+000006d0: 6465 7669 6365 2069 6e74 6572 6661 6365  device interface
+000006e0: 2073 7472 7563 7475 7265 0d0a 2020 2020   structure..    
+000006f0: 5468 6973 2069 6e76 6c6f 766c 6573 2072  This invlovles r
+00000700: 6563 6569 7669 6e67 2061 2072 6571 7565  eceiving a reque
+00000710: 7374 2074 6872 6f75 6768 2074 6865 2068  st through the h
+00000720: 616e 646c 655f 7265 7175 6573 7420 6675  andle_request fu
+00000730: 6e63 7469 6f6e 0d0a 2020 2020 4120 7265  nction..    A re
+00000740: 7175 6573 7420 6973 2070 726f 6365 7373  quest is process
+00000750: 6564 2062 6173 6564 206f 6e20 7468 6520  ed based on the 
+00000760: 6b65 7920 696e 2074 6865 2072 6571 7565  key in the reque
+00000770: 7374 0d0a 2020 2020 5468 6520 7072 6f63  st..    The proc
+00000780: 6573 7369 6e67 2066 756e 6374 696f 6e20  essing function 
+00000790: 7061 7373 6573 2074 6865 2063 6f6d 6d61  passes the comma
+000007a0: 6e64 7320 746f 2074 6865 2072 6571 7565  nds to the reque
+000007b0: 7374 6564 2064 6576 6963 650d 0a20 2020  sted device..   
+000007c0: 204f 6e63 6520 6974 2072 6563 6576 6965   Once it recevie
+000007d0: 7320 6120 7265 7370 6f6e 7365 2066 726f  s a response fro
+000007e0: 6d20 7468 6520 636f 6e6e 6563 7465 6420  m the connected 
+000007f0: 6465 7669 6365 2069 7420 7468 656e 2070  device it then p
+00000800: 6173 7365 7320 7468 6174 0d0a 2020 2020  asses that..    
+00000810: 6261 636b 2075 7020 7468 6520 6368 6169  back up the chai
+00000820: 6e0d 0a20 2020 2020 2020 2020 2020 2020  n..             
+00000830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000840: 2020 456e 6c69 6768 7465 6e20 5265 7175    Enlighten Requ
+00000850: 6573 740d 0a20 2020 2020 2020 2020 2020  est..           
+00000860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000870: 2020 2020 2020 2020 2020 2020 7c0d 0a20              |.. 
 00000880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000890: 2020 2020 2020 7c0a 2020 2020 2020 2020        |.        
-000008a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000008b0: 2020 2020 2020 2020 202d 2d2d 2d2d 2d2d           -------
-000008c0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 2020  -----.          
-000008d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000008e0: 2020 2020 2020 2f20 2020 2f20 207c 2020        /   /  |  
-000008f0: 5c20 205c 0a20 2020 2020 2020 2020 2020  \  \.           
-00000900: 2020 7b20 6765 745f 6c61 7365 7220 7374    { get_laser st
-00000910: 6174 7573 2c20 6163 7175 6972 652c 2073  atus, acquire, s
-00000920: 6574 5f6c 6173 6572 5f77 6174 6368 646f  et_laser_watchdo
-00000930: 672c 2065 7463 2e2e 2e2e 7d0a 2020 2020  g, etc....}.    
-00000940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000950: 2020 2020 2020 2020 2020 2020 5c20 2020              \   
-00000960: 5c20 207c 2020 2f20 202f 0a20 2020 2020  \  |  /  /.     
-00000970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000980: 2020 2020 2020 2020 2020 2020 2d2d 2d2d              ----
-00000990: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-000009a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000009b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000009c0: 7c0a 2020 2020 2020 2020 2020 2020 2020  |.              
-000009d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000009e0: 2020 2020 205f 7365 6e64 5f63 6f64 650a       _send_code.
-000009f0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00000a00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000a10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000a20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000a30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000a40: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
+00000890: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000008a0: 616e 646c 655f 7265 7175 6573 7473 0d0a  andle_requests..
+000008b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000008c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000008d0: 2020 2020 2020 207c 0d0a 2020 2020 2020         |..      
+000008e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000008f0: 2020 2020 2020 2020 2020 202d 2d2d 2d2d             -----
+00000900: 2d2d 2d2d 2d2d 2d0d 0a20 2020 2020 2020  -------..       
+00000910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000920: 2020 2020 2020 2020 202f 2020 202f 2020           /   /  
+00000930: 7c20 205c 2020 5c0d 0a20 2020 2020 2020  |  \  \..       
+00000940: 2020 2020 2020 7b20 6765 745f 6c61 7365        { get_lase
+00000950: 7220 7374 6174 7573 2c20 6163 7175 6972  r status, acquir
+00000960: 652c 2073 6574 5f6c 6173 6572 5f77 6174  e, set_laser_wat
+00000970: 6368 646f 672c 2065 7463 2e2e 2e2e 7d0d  chdog, etc....}.
+00000980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000009a0: 205c 2020 205c 2020 7c20 202f 2020 2f0d   \   \  |  /  /.
+000009b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000009c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000009d0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0d0a    ------------..
+000009e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000009f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000a00: 2020 2020 2020 207c 0d0a 2020 2020 2020         |..      
+00000a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000a20: 2020 2020 2020 2020 2020 2020 205f 7365               _se
+00000a30: 6e64 5f63 6f64 650d 0a20 2020 2023 2323  nd_code..    ###
+00000a40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000a50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000a60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000a80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000a90: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-00000aa0: 204c 6966 6563 7963 6c65 0a20 2020 2023   Lifecycle.    #
-00000ab0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00000a80: 2323 2323 2323 2323 230d 0a20 2020 2022  #########..    "
+00000a90: 2222 0d0a 0d0a 2020 2020 2320 2323 2323  ""....    # ####
+00000aa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000ab0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000ac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000ad0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000ae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000af0: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-00000b00: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00000b10: 6c66 2c20 6465 7669 6365 5f69 643a 2073  lf, device_id: s
-00000b20: 7472 2c20 6d65 7373 6167 655f 7175 6575  tr, message_queu
-00000b30: 653a 206c 6973 7420 3d20 4e6f 6e65 2920  e: list = None) 
-00000b40: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00000b50: 2022 2222 0a20 2020 2020 2020 2049 6e73   """.        Ins
-00000b60: 7461 6e74 6961 7465 2061 2046 6561 7475  tantiate a Featu
-00000b70: 7265 4964 656e 7469 6669 6361 7469 6f6e  reIdentification
-00000b80: 4465 7669 6365 2077 6974 6820 6672 6f6d  Device with from
-00000b90: 2074 6865 2067 6976 656e 2064 6576 6963   the given devic
-00000ba0: 655f 6964 2e0a 2020 2020 2020 2020 4070  e_id..        @p
-00000bb0: 6172 616d 2064 6576 6963 655f 6964 205b  aram device_id [
-00000bc0: 696e 5d20 6465 7669 6365 2049 4420 2822  in] device ID ("
-00000bd0: 5553 423a 3078 3234 6161 3a30 7831 3030  USB:0x24aa:0x100
-00000be0: 303a 313a 3234 2229 0a20 2020 2020 2020  0:1:24").       
-00000bf0: 2040 7061 7261 6d20 6d65 7373 6167 655f   @param message_
-00000c00: 7175 6575 6520 5b6f 7574 5d20 6966 2070  queue [out] if p
-00000c10: 726f 7669 6465 642c 2070 726f 7669 6465  rovided, provide
-00000c20: 7320 616e 206f 7574 626f 756e 6420 2866  s an outbound (f
-00000c30: 726f 6d20 4649 4429 0a20 2020 2020 2020  rom FID).       
-00000c40: 2071 7565 7565 2066 6f72 2077 7269 7469   queue for writi
-00000c50: 6e67 2053 7461 7475 734d 6573 7361 6765  ng StatusMessage
-00000c60: 206f 626a 6563 7473 2075 7073 7472 6561   objects upstrea
-00000c70: 6d0a 2020 2020 2020 2020 2222 220a 2020  m.        """.  
-00000c80: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-00000c90: 696e 6974 5f5f 2829 0a20 2020 2020 2020  init__().       
-00000ca0: 2073 656c 662e 6465 7669 6365 5f69 6420   self.device_id 
-00000cb0: 3d20 6465 7669 6365 5f69 640a 2020 2020  = device_id.    
-00000cc0: 2020 2020 7365 6c66 2e6d 6573 7361 6765      self.message
-00000cd0: 5f71 7565 7565 203d 206d 6573 7361 6765  _queue = message
-00000ce0: 5f71 7565 7565 0a0a 2020 2020 2020 2020  _queue..        
-00000cf0: 7365 6c66 2e64 6576 6963 6520 3d20 4e6f  self.device = No
-00000d00: 6e65 0a20 2020 2020 2020 2069 6620 224d  ne.        if "M
-00000d10: 4f43 4b22 2069 6e20 7374 7228 6465 7669  OCK" in str(devi
-00000d20: 6365 5f69 6429 2e75 7070 6572 2829 3a0a  ce_id).upper():.
-00000d30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00000d40: 2e64 6576 6963 655f 7479 7065 203d 204d  .device_type = M
-00000d50: 6f63 6b55 5342 4465 7669 6365 2864 6576  ockUSBDevice(dev
-00000d60: 6963 655f 6964 2e6e 616d 652c 205c 0a20  ice_id.name, \. 
-00000d70: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00000d80: 6576 6963 655f 6964 2e64 6972 6563 746f  evice_id.directo
-00000d90: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-00000da0: 2020 2020 6465 7669 6365 5f69 642e 6f76      device_id.ov
-00000db0: 6572 7269 6465 732c 0a20 2020 2020 2020  errides,.       
-00000dc0: 2020 2020 2020 2020 2064 6576 6963 655f           device_
-00000dd0: 6964 2e73 7065 6374 7261 5f6f 7074 696f  id.spectra_optio
-00000de0: 6e73 290a 2020 2020 2020 2020 656c 7365  ns).        else
-00000df0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00000e00: 6c66 2e64 6576 6963 655f 7479 7065 203d  lf.device_type =
-00000e10: 2052 6561 6c55 5342 4465 7669 6365 2864   RealUSBDevice(d
-00000e20: 6576 6963 655f 6964 290a 0a20 2020 2020  evice_id)..     
-00000e30: 2020 2073 656c 662e 6c61 7374 5f75 7362     self.last_usb
-00000e40: 5f74 696d 6573 7461 6d70 203d 204e 6f6e  _timestamp = Non
-00000e50: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
-00000e60: 6c61 7365 725f 7465 6d70 6572 6174 7572  laser_temperatur
-00000e70: 655f 696e 7661 6c69 6420 3d20 4661 6c73  e_invalid = Fals
-00000e80: 650a 2020 2020 2020 2020 7365 6c66 2e63  e.        self.c
-00000e90: 6364 5f74 656d 7065 7261 7475 7265 5f69  cd_temperature_i
-00000ea0: 6e76 616c 6964 203d 2046 616c 7365 0a0a  nvalid = False..
-00000eb0: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-00000ec0: 7469 6e67 7320 3d20 5370 6563 7472 6f6d  tings = Spectrom
-00000ed0: 6574 6572 5365 7474 696e 6773 2864 6576  eterSettings(dev
-00000ee0: 6963 655f 6964 290a 2020 2020 2020 2020  ice_id).        
-00000ef0: 7365 6c66 2e65 6570 726f 6d5f 6261 636b  self.eeprom_back
-00000f00: 7570 203d 204e 6f6e 650a 0a20 2020 2020  up = None..     
-00000f10: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
-00000f20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000f30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000f40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000f50: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00000f60: 2020 2020 2320 7468 6573 6520 6172 6520      # these are 
-00000f70: 2264 7269 7665 7220 7374 6174 6522 2077  "driver state" w
-00000f80: 6974 6869 6e20 4665 6174 7572 6549 6465  ithin FeatureIde
-00000f90: 6e74 6966 6963 6174 696f 6e44 6576 6963  ntificationDevic
-00000fa0: 652c 2061 6e64 2064 6f6e 2774 0a20 2020  e, and don't.   
-00000fb0: 2020 2020 2023 2072 6561 6c6c 7920 7265       # really re
-00000fc0: 6c61 7465 2074 6f20 7468 6520 7370 6563  late to the spec
-00000fd0: 7472 6f6d 6574 6572 2068 6172 6477 6172  trometer hardwar
-00000fe0: 650a 2020 2020 2020 2020 2320 2323 2323  e.        # ####
-00000ff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001000: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001010: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001020: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001030: 2323 0a0a 2020 2020 2020 2020 7365 6c66  ##..        self
-00001040: 2e64 6574 6563 746f 725f 7465 635f 7365  .detector_tec_se
-00001050: 7470 6f69 6e74 5f68 6173 5f62 6565 6e5f  tpoint_has_been_
-00001060: 7365 7420 3d20 4661 6c73 650a 2020 2020  set = False.    
-00001070: 2020 2020 7365 6c66 2e6c 6173 745f 6170      self.last_ap
-00001080: 706c 6965 645f 6c61 7365 725f 706f 7765  plied_laser_powe
-00001090: 7220 3d20 302e 3020 2320 6c61 7374 2070  r = 0.0 # last p
-000010a0: 6f77 6572 206c 6576 656c 2041 5050 4c49  ower level APPLI
-000010b0: 4544 2074 6f20 6c61 7365 722c 2065 6974  ED to laser, eit
-000010c0: 6865 7220 6279 2074 7572 6e69 6e67 206f  her by turning o
-000010d0: 6666 2028 3029 206f 7220 6f6e 200a 2020  ff (0) or on .  
-000010e0: 2020 2020 2020 7365 6c66 2e6e 6578 745f        self.next_
-000010f0: 6170 706c 6965 645f 6c61 7365 725f 706f  applied_laser_po
-00001100: 7765 7220 3d20 4e6f 6e65 2023 2070 6f77  wer = None # pow
-00001110: 6572 206c 6576 656c 2074 6f20 6265 2061  er level to be a
-00001120: 7070 6c69 6564 204e 4558 5420 7469 6d65  pplied NEXT time
-00001130: 2074 6865 206c 6173 6572 2069 7320 656e   the laser is en
-00001140: 6162 6c65 640a 0a20 2020 2020 2020 2073  abled..        s
-00001150: 656c 662e 7261 6973 655f 6578 6365 7074  elf.raise_except
-00001160: 696f 6e73 203d 2046 616c 7365 0a20 2020  ions = False.   
-00001170: 2020 2020 2073 656c 662e 696e 6a65 6374       self.inject
-00001180: 5f72 616e 646f 6d5f 6572 726f 7273 203d  _random_errors =
-00001190: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
-000011a0: 656c 662e 7261 6e64 6f6d 5f65 7272 6f72  elf.random_error
-000011b0: 5f70 6572 6320 3d20 302e 3030 3120 2020  _perc = 0.001   
-000011c0: 2320 302e 3125 0a20 2020 2020 2020 2073  # 0.1%.        s
-000011d0: 656c 662e 616c 6c6f 775f 6465 6661 756c  elf.allow_defaul
-000011e0: 745f 6761 696e 5f72 6573 6574 203d 2054  t_gain_reset = T
-000011f0: 7275 650a 0a20 2020 2020 2020 2073 656c  rue..        sel
-00001200: 662e 636f 6e6e 6563 7465 6420 3d20 4661  f.connected = Fa
-00001210: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-00001220: 2e63 6f6e 6e65 6374 696e 6720 3d20 4661  .connecting = Fa
-00001230: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-00001240: 2e73 6875 7464 6f77 6e5f 7265 7175 6573  .shutdown_reques
-00001250: 7465 6420 3d20 4661 6c73 650a 0a20 2020  ted = False..   
-00001260: 2020 2020 2073 656c 662e 6c61 7374 5f73       self.last_s
-00001270: 7065 6374 7275 6d20 3d20 4e6f 6e65 0a20  pectrum = None. 
-00001280: 2020 2020 2020 2073 656c 662e 7370 6563         self.spec
-00001290: 7472 756d 5f63 6f75 6e74 203d 2030 0a20  trum_count = 0. 
-000012a0: 2020 2020 2020 2073 656c 662e 7072 6576         self.prev
-000012b0: 5f70 6978 656c 7320 3d20 4e6f 6e65 0a0a  _pixels = None..
-000012c0: 2020 2020 2020 2020 2320 696e 2063 6173          # in cas
-000012d0: 6520 6f66 2049 3243 2063 6f6c 6c69 7369  e of I2C collisi
-000012e0: 6f6e 7320 7769 7468 696e 2074 6865 2073  ons within the s
-000012f0: 7065 6374 726f 6d65 7465 722c 2065 2e67  pectrometer, e.g
-00001300: 2e20 6475 6520 746f 2062 6174 7465 7279  . due to battery
-00001310: 2d4c 4544 2073 7461 7475 730a 2020 2020  -LED status.    
-00001320: 2020 2020 7365 6c66 2e72 6574 7279 5f65      self.retry_e
-00001330: 6e61 626c 6564 203d 2054 7275 650a 2020  nabled = True.  
-00001340: 2020 2020 2020 7365 6c66 2e72 6574 7279        self.retry
-00001350: 5f6d 7320 3d20 350a 2020 2020 2020 2020  _ms = 5.        
-00001360: 7365 6c66 2e72 6574 7279 5f6d 6178 203d  self.retry_max =
-00001370: 2033 0a0a 2020 2020 2020 2020 7365 6c66   3..        self
-00001380: 2e70 726f 6365 7373 5f66 203d 2073 656c  .process_f = sel
-00001390: 662e 5f69 6e69 745f 7072 6f63 6573 735f  f._init_process_
-000013a0: 6675 6e63 7328 290a 0a20 2020 2064 6566  funcs()..    def
-000013b0: 2068 616e 646c 655f 7265 7175 6573 7473   handle_requests
-000013c0: 2873 656c 662c 2072 6571 7565 7374 733a  (self, requests:
-000013d0: 206c 6973 745b 5370 6563 7472 6f6d 6574   list[Spectromet
-000013e0: 6572 5265 7175 6573 745d 2920 2d3e 206c  erRequest]) -> l
-000013f0: 6973 745b 5370 6563 7472 6f6d 6574 6572  ist[Spectrometer
-00001400: 5265 7370 6f6e 7365 5d3a 0a20 2020 2020  Response]:.     
-00001410: 2020 2022 2222 0a20 2020 2020 2020 2040     """.        @
-00001420: 746f 646f 2063 6f6e 7369 6465 7220 6d61  todo consider ma
-00001430: 6b69 6e67 2027 7265 7175 6573 7473 2720  king 'requests' 
-00001440: 616e 206f 626a 6563 742c 2061 6e64 2064  an object, and d
-00001450: 796e 616d 6963 616c 6c79 2063 6865 636b  ynamically check
-00001460: 696e 6720 746f 200a 2020 2020 2020 2020  ing to .        
-00001470: 2020 2020 2020 7365 6520 6966 2069 7420        see if it 
-00001480: 6973 2061 2073 696e 676c 6520 5370 6563  is a single Spec
-00001490: 7472 6f6d 6574 6572 5265 7175 6573 7420  trometerRequest 
-000014a0: 6f72 2061 206c 6973 745b 5370 6563 7472  or a list[Spectr
-000014b0: 6f6d 6574 6572 5265 7175 6573 745d 3b0a  ometerRequest];.
-000014c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000014d0: 2074 6865 2066 6f72 6d65 722c 206f 6e6c   the former, onl
-000014e0: 7920 7265 7475 726e 2061 2073 696e 676c  y return a singl
-000014f0: 6520 5370 6563 7472 6f6d 6574 6572 5265  e SpectrometerRe
-00001500: 7370 6f6e 7365 2e0a 2020 2020 2020 2020  sponse..        
-00001510: 2222 220a 2020 2020 2020 2020 7265 7370  """.        resp
-00001520: 6f6e 7365 7320 3d20 5b5d 0a20 2020 2020  onses = [].     
-00001530: 2020 2066 6f72 2072 6571 7565 7374 2069     for request i
-00001540: 6e20 7265 7175 6573 7473 3a0a 2020 2020  n requests:.    
-00001550: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00001560: 2020 2020 2020 2020 2020 2020 2063 6d64               cmd
-00001570: 203d 2072 6571 7565 7374 2e63 6d64 0a20   = request.cmd. 
-00001580: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00001590: 726f 635f 6675 6e63 203d 2073 656c 662e  roc_func = self.
-000015a0: 7072 6f63 6573 735f 662e 6765 7428 636d  process_f.get(cm
-000015b0: 642c 204e 6f6e 6529 0a20 2020 2020 2020  d, None).       
-000015c0: 2020 2020 2020 2020 2069 6620 7072 6f63           if proc
-000015d0: 5f66 756e 6320 3d3d 204e 6f6e 653a 0a20  _func == None:. 
-000015e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000015f0: 2020 2072 6573 706f 6e73 6573 2e61 7070     responses.app
-00001600: 656e 6428 5370 6563 7472 6f6d 6574 6572  end(Spectrometer
-00001610: 5265 7370 6f6e 7365 2865 7272 6f72 5f6d  Response(error_m
-00001620: 7367 3d66 2275 6e73 7570 706f 7274 6564  sg=f"unsupported
-00001630: 2063 6d64 207b 7265 7175 6573 742e 636d   cmd {request.cm
-00001640: 647d 222c 2065 7272 6f72 5f6c 766c 3d45  d}", error_lvl=E
-00001650: 7272 6f72 4c65 7665 6c2e 6c6f 7729 290a  rrorLevel.low)).
-00001660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001670: 656c 6966 2072 6571 7565 7374 2e61 7267  elif request.arg
-00001680: 7320 3d3d 205b 5d20 616e 6420 7265 7175  s == [] and requ
-00001690: 6573 742e 6b77 6172 6773 203d 3d20 7b7d  est.kwargs == {}
-000016a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000016b0: 2020 2020 2020 7265 7370 6f6e 7365 732e        responses.
-000016c0: 6170 7065 6e64 2870 726f 635f 6675 6e63  append(proc_func
-000016d0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-000016e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000016f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00001700: 7370 6f6e 7365 732e 6170 7065 6e64 2870  sponses.append(p
-00001710: 726f 635f 6675 6e63 282a 7265 7175 6573  roc_func(*reques
-00001720: 742e 6172 6773 2c20 2a2a 7265 7175 6573  t.args, **reques
-00001730: 742e 6b77 6172 6773 2929 0a20 2020 2020  t.kwargs)).     
-00001740: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-00001750: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00001760: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00001770: 672e 6572 726f 7228 6622 6572 726f 7220  g.error(f"error 
-00001780: 696e 2068 616e 646c 696e 6720 7265 7175  in handling requ
-00001790: 6573 7420 7b72 6571 7565 7374 7d20 6f66  est {request} of
-000017a0: 207b 657d 2229 0a20 2020 2020 2020 2020   {e}").         
-000017b0: 2020 2020 2020 2072 6573 706f 6e73 6573         responses
-000017c0: 2e61 7070 656e 6428 5370 6563 7472 6f6d  .append(Spectrom
-000017d0: 6574 6572 5265 7370 6f6e 7365 2865 7272  eterResponse(err
-000017e0: 6f72 5f6d 7367 3d22 6572 726f 7220 7072  or_msg="error pr
-000017f0: 6f63 6573 7369 6e67 2063 6d64 222c 2065  ocessing cmd", e
-00001800: 7272 6f72 5f6c 766c 3d45 7272 6f72 4c65  rror_lvl=ErrorLe
-00001810: 7665 6c2e 6d65 6469 756d 2929 0a20 2020  vel.medium)).   
-00001820: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
-00001830: 6f6e 7365 730a 0a20 2020 2064 6566 2063  onses..    def c
-00001840: 6f6e 6e65 6374 2873 656c 662c 2072 6574  onnect(self, ret
-00001850: 7269 6573 3d30 2920 2d3e 2053 7065 6374  ries=0) -> Spect
-00001860: 726f 6d65 7465 7252 6573 706f 6e73 653a  rometerResponse:
-00001870: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00001880: 2020 2020 2043 6f6e 6e65 6374 2074 6f20       Connect to 
-00001890: 7468 6520 6465 7669 6365 2061 6e64 2069  the device and i
-000018a0: 6e69 7469 616c 697a 6520 6261 7369 6320  nitialize basic 
-000018b0: 7365 7474 696e 6773 2e0a 2020 2020 2020  settings..      
-000018c0: 2020 4077 6172 6e69 6e67 2074 6869 7320    @warning this 
-000018d0: 6361 7573 6573 2061 2070 726f 626c 656d  causes a problem
-000018e0: 2069 6e20 6e6f 6e2d 626c 6f63 6b69 6e67   in non-blocking
-000018f0: 206d 6f64 6520 2857 6173 6174 6368 4465   mode (WasatchDe
-00001900: 7669 6365 5772 6170 7065 7229 0a20 2020  viceWrapper).   
-00001910: 2020 2020 206f 6e20 4d61 634f 530a 2020       on MacOS.  
-00001920: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00001930: 2020 7365 6c66 2e63 6f6e 6e65 6374 696e    self.connectin
-00001940: 6720 3d20 5472 7565 0a0a 2020 2020 2020  g = True..      
-00001950: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
-00001960: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001970: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001980: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001990: 2323 2323 2323 2323 2323 0a20 2020 2020  ##########.     
-000019a0: 2020 2023 2055 5342 2043 6f6e 6e65 6374     # USB Connect
-000019b0: 696f 6e0a 2020 2020 2020 2020 2320 2323  ion.        # ##
-000019c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000019d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000019e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000019f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001a00: 2323 2323 0a0a 2020 2020 2020 2020 2320  ####..        # 
-00001a10: 4765 6e65 7261 7465 2061 2066 7265 7368  Generate a fresh
-00001a20: 206c 6973 7469 6e67 206f 6620 5553 4220   listing of USB 
-00001a30: 6465 7669 6365 7320 7769 7468 2074 6865  devices with the
-00001a40: 2072 6571 7565 7374 6564 2056 4944 2061   requested VID a
-00001a50: 6e64 2050 4944 2e0a 2020 2020 2020 2020  nd PID..        
-00001a60: 2320 4e6f 7465 2074 6861 7420 7468 6973  # Note that this
-00001a70: 2069 7320 4e4f 5420 686f 7720 5761 7361   is NOT how Wasa
-00001a80: 7463 6842 7573 2074 7261 7665 7273 6573  tchBus traverses
-00001a90: 2074 6865 206c 6973 742e 2020 4974 2061   the list.  It a
-00001aa0: 6374 7561 6c6c 790a 2020 2020 2020 2020  ctually.        
-00001ab0: 2320 6361 6c6c 7320 7573 622e 6275 7373  # calls usb.buss
-00001ac0: 6573 2829 2c20 7468 656e 2069 7465 7261  es(), then itera
-00001ad0: 7465 7320 6f76 6572 2062 7573 2e64 6576  tes over bus.dev
-00001ae0: 6963 6573 2c20 6275 7420 7468 6174 2773  ices, but that's
-00001af0: 2062 6563 6175 7365 0a20 2020 2020 2020   because.       
-00001b00: 2023 2069 7420 646f 6573 6e27 7420 6b6e   # it doesn't kn
-00001b10: 6f77 2077 6861 7420 5049 4473 2069 7420  ow what PIDs it 
-00001b20: 6d69 6768 7420 6265 206c 6f6f 6b69 6e67  might be looking
-00001b30: 2066 6f72 2e20 2057 6520 6b6e 6f77 2c20   for.  We know, 
-00001b40: 736f 206a 7573 740a 2020 2020 2020 2020  so just.        
-00001b50: 2320 6e61 7272 6f77 2064 6f77 6e20 7468  # narrow down th
-00001b60: 6520 7365 6172 6368 2074 6f20 7468 6f73  e search to thos
-00001b70: 6520 6465 7669 6365 732e 0a0a 2020 2020  e devices...    
-00001b80: 2020 2020 6c6f 672e 696e 666f 2866 2246      log.info(f"F
-00001b90: 4944 2e63 6f6e 6e65 6374 3a20 6173 6b65  ID.connect: aske
-00001ba0: 6420 746f 2063 6f6e 6e65 6374 2074 6f20  d to connect to 
-00001bb0: 6465 7669 6365 5f74 7970 6520 7b73 656c  device_type {sel
-00001bc0: 662e 6465 7669 6365 5f74 7970 657d 2229  f.device_type}")
-00001bd0: 0a20 2020 2020 2020 206c 6f67 2e69 6e66  .        log.inf
-00001be0: 6f28 6622 4649 442e 636f 6e6e 6563 743a  o(f"FID.connect:
-00001bf0: 2063 616c 6c69 6e67 2064 6576 6963 655f   calling device_
-00001c00: 7479 7065 2e66 696e 642c 206c 6f6f 6b69  type.find, looki
-00001c10: 6e67 2066 6f72 2056 4944 2030 787b 7365  ng for VID 0x{se
-00001c20: 6c66 2e64 6576 6963 655f 6964 2e76 6964  lf.device_id.vid
-00001c30: 3a30 3478 7d20 616e 6420 5049 4420 3078  :04x} and PID 0x
-00001c40: 7b73 656c 662e 6465 7669 6365 5f69 642e  {self.device_id.
-00001c50: 7069 643a 3034 787d 2229 0a20 2020 2020  pid:04x}").     
-00001c60: 2020 2064 6576 6963 6573 203d 2073 656c     devices = sel
-00001c70: 662e 6465 7669 6365 5f74 7970 652e 6669  f.device_type.fi
-00001c80: 6e64 2866 696e 645f 616c 6c3d 5472 7565  nd(find_all=True
-00001c90: 2c20 6964 5665 6e64 6f72 3d73 656c 662e  , idVendor=self.
-00001ca0: 6465 7669 6365 5f69 642e 7669 642c 2069  device_id.vid, i
-00001cb0: 6450 726f 6475 6374 3d73 656c 662e 6465  dProduct=self.de
-00001cc0: 7669 6365 5f69 642e 7069 6429 0a20 2020  vice_id.pid).   
-00001cd0: 2020 2020 206c 6f67 2e69 6e66 6f28 6622       log.info(f"
-00001ce0: 4649 442e 636f 6e6e 6563 743a 2066 6f75  FID.connect: fou
-00001cf0: 6e64 2064 6576 6963 6573 207b 6465 7669  nd devices {devi
-00001d00: 6365 737d 2229 0a20 2020 2020 2020 2064  ces}").        d
-00001d10: 6576 5f6c 6973 7420 3d20 6c69 7374 2864  ev_list = list(d
-00001d20: 6576 6963 6573 2920 2320 636f 6e76 6572  evices) # conver
-00001d30: 7420 6672 6f6d 2061 7272 6179 0a0a 2020  t from array..  
-00001d40: 2020 2020 2020 6465 7669 6365 203d 204e        device = N
-00001d50: 6f6e 650a 2020 2020 2020 2020 6c6f 672e  one.        log.
-00001d60: 696e 666f 2866 2273 6561 7263 6869 6e67  info(f"searching
-00001d70: 2066 6f72 2073 7065 6369 6669 6564 2064   for specified d
-00001d80: 6576 6963 6520 696e 2064 6576 5f6c 6973  evice in dev_lis
-00001d90: 7420 7b64 6576 5f6c 6973 747d 2229 0a20  t {dev_list}"). 
-00001da0: 2020 2020 2020 2066 6f72 2064 6576 2069         for dev i
-00001db0: 6e20 6465 765f 6c69 7374 3a0a 2020 2020  n dev_list:.    
-00001dc0: 2020 2020 2020 2020 6966 2064 6576 2e62          if dev.b
-00001dd0: 7573 2021 3d20 7365 6c66 2e64 6576 6963  us != self.devic
-00001de0: 655f 6964 2e62 7573 3a0a 2020 2020 2020  e_id.bus:.      
-00001df0: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
-00001e00: 6275 6728 2246 4944 2e63 6f6e 6e65 6374  bug("FID.connect
-00001e10: 3a20 7265 6a65 6374 696e 6720 6465 7669  : rejecting devi
-00001e20: 6365 2028 6275 7320 2564 2021 3d20 7265  ce (bus %d != re
-00001e30: 7175 6573 7465 6420 2564 2922 2c20 6465  quested %d)", de
-00001e40: 762e 6275 732c 2073 656c 662e 6465 7669  v.bus, self.devi
-00001e50: 6365 5f69 642e 6275 7329 0a20 2020 2020  ce_id.bus).     
-00001e60: 2020 2020 2020 2065 6c69 6620 6465 762e         elif dev.
-00001e70: 6164 6472 6573 7320 213d 2073 656c 662e  address != self.
-00001e80: 6465 7669 6365 5f69 642e 6164 6472 6573  device_id.addres
-00001e90: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00001ea0: 2020 206c 6f67 2e64 6562 7567 2822 4649     log.debug("FI
-00001eb0: 442e 636f 6e6e 6563 743a 2072 656a 6563  D.connect: rejec
-00001ec0: 7469 6e67 2064 6576 6963 6520 2861 6464  ting device (add
-00001ed0: 7265 7373 2025 6420 213d 2072 6571 7565  ress %d != reque
-00001ee0: 7374 6564 2025 6429 222c 2064 6576 2e61  sted %d)", dev.a
-00001ef0: 6464 7265 7373 2c20 7365 6c66 2e64 6576  ddress, self.dev
-00001f00: 6963 655f 6964 2e61 6464 7265 7373 290a  ice_id.address).
-00001f10: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00001f20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00001f30: 2020 6465 7669 6365 203d 2064 6576 0a20    device = dev. 
-00001f40: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00001f50: 7265 616b 0a0a 2020 2020 2020 2020 6966  reak..        if
-00001f60: 2064 6576 6963 6520 6973 204e 6f6e 653a   device is None:
-00001f70: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00001f80: 2e64 6562 7567 2866 2246 4944 2e63 6f6e  .debug(f"FID.con
-00001f90: 6e65 6374 3a20 756e 6162 6c65 2074 6f20  nect: unable to 
-00001fa0: 6669 6e64 2044 6576 6963 6549 4420 7b73  find DeviceID {s
-00001fb0: 656c 662e 6465 7669 6365 5f69 647d 2229  elf.device_id}")
-00001fc0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001fd0: 662e 636f 6e6e 6563 7469 6e67 203d 2046  f.connecting = F
-00001fe0: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00001ff0: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-00002000: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-00002010: 613d 4661 6c73 652c 2065 7272 6f72 5f6d  a=False, error_m
-00002020: 7367 3d66 2275 6e61 626c 6520 746f 2066  sg=f"unable to f
-00002030: 696e 6420 4465 7669 6365 4944 207b 7365  ind DeviceID {se
-00002040: 6c66 2e64 6576 6963 655f 6964 7d22 290a  lf.device_id}").
-00002050: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00002060: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
-00002070: 6275 6728 2246 4944 2e63 6f6e 6e65 6374  bug("FID.connect
-00002080: 3a20 6d61 7463 6865 6420 4465 7669 6365  : matched Device
-00002090: 4944 2025 7322 2c20 7374 7228 7365 6c66  ID %s", str(self
-000020a0: 2e64 6576 6963 655f 6964 2929 0a0a 2020  .device_id))..  
-000020b0: 2020 2020 2020 6966 206f 732e 6e61 6d65        if os.name
-000020c0: 2021 3d20 2270 6f73 6978 223a 0a20 2020   != "posix":.   
-000020d0: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
-000020e0: 7567 2822 6f6e 2057 696e 646f 7773 2c20  ug("on Windows, 
-000020f0: 736f 204e 4f54 2073 6574 7469 6e67 2063  so NOT setting c
-00002100: 6f6e 6669 6775 7261 7469 6f6e 2061 6e64  onfiguration and
-00002110: 2063 6c61 696d 696e 6720 696e 7465 7266   claiming interf
-00002120: 6163 6522 290a 2020 2020 2020 2020 656c  ace").        el
-00002130: 6966 2022 6d61 634f 5322 2069 6e20 706c  if "macOS" in pl
-00002140: 6174 666f 726d 2e70 6c61 7466 6f72 6d28  atform.platform(
-00002150: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-00002160: 6f67 2e64 6562 7567 2822 6f6e 204d 6163  og.debug("on Mac
-00002170: 4f53 2c20 736f 204e 4f54 2073 6574 7469  OS, so NOT setti
-00002180: 6e67 2063 6f6e 6669 6775 7261 7469 6f6e  ng configuration
-00002190: 2061 6e64 2063 6c61 696d 696e 6720 696e   and claiming in
-000021a0: 7465 7266 6163 6522 290a 2020 2020 2020  terface").      
-000021b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000021c0: 2020 2020 6c6f 672e 6465 6275 6728 226f      log.debug("o
-000021d0: 6e20 706f 7369 782c 2073 6f20 7365 7474  n posix, so sett
-000021e0: 696e 6720 636f 6e66 6967 7572 6174 696f  ing configuratio
-000021f0: 6e20 616e 6420 636c 6169 6d69 6e67 2069  n and claiming i
-00002200: 6e74 6572 6661 6365 2229 0a0a 2020 2020  nterface")..    
-00002210: 2020 2020 2020 2020 2320 696e 2074 6865          # in the
-00002220: 2066 6f6c 6c6f 7769 6e67 2c20 7265 7475   following, retu
-00002230: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-00002240: 6573 706f 6e73 6520 6f62 6a65 6374 7320  esponse objects 
-00002250: 7261 7468 6572 2074 6861 6e20 0a20 2020  rather than .   
-00002260: 2020 2020 2020 2020 2023 2072 6169 7369           # raisi
-00002270: 6e67 2065 7863 6570 7469 6f6e 7320 736f  ng exceptions so
-00002280: 2074 6865 2075 7365 7220 7769 6c6c 2068   the user will h
-00002290: 6176 6520 6120 6d6f 7265 2d75 7365 6675  ave a more-usefu
-000022a0: 6c20 6572 726f 7220 0a20 2020 2020 2020  l error .       
-000022b0: 2020 2020 2023 206d 6573 7361 6765 2074       # message t
-000022c0: 6f20 7265 706f 7274 206f 7220 7573 6520  o report or use 
-000022d0: 696e 2074 726f 7562 6c65 7368 6f6f 7469  in troubleshooti
-000022e0: 6e67 2028 6578 6365 7074 696f 6e20 7374  ng (exception st
-000022f0: 696c 6c20 6765 7473 0a20 2020 2020 2020  ill gets.       
-00002300: 2020 2020 2023 206c 6f67 6765 6429 0a20       # logged). 
-00002310: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00002320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002330: 6c6f 672e 6465 6275 6728 2273 6574 7469  log.debug("setti
-00002340: 6e67 2063 6f6e 6669 6775 7261 7469 6f6e  ng configuration
-00002350: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00002360: 2020 2072 6573 756c 7420 3d20 7365 6c66     result = self
-00002370: 2e64 6576 6963 655f 7479 7065 2e73 6574  .device_type.set
-00002380: 5f63 6f6e 6669 6775 7261 7469 6f6e 2864  _configuration(d
-00002390: 6576 6963 6529 0a20 2020 2020 2020 2020  evice).         
-000023a0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000023b0: 696f 6e20 6173 2065 7863 3a0a 2020 2020  ion as exc:.    
-000023c0: 2020 2020 2020 2020 2020 2020 2323 2323              ####
-000023d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000023e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000023f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002410: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002440: 230a 2020 2020 2020 2020 2020 2020 2020  #.              
-00002450: 2020 2320 5468 6973 2061 6464 6974 696f    # This additio
-00002460: 6e61 6c20 6966 2073 7461 7465 6d65 6e74  nal if statement
-00002470: 2069 7320 7072 6573 656e 7420 666f 7220   is present for 
-00002480: 7468 6520 5261 7370 6265 7272 7920 5069  the Raspberry Pi
-00002490: 2e20 5468 6572 6520 6973 2061 6e20 6973  . There is an is
-000024a0: 7375 6520 7769 7468 2072 6573 6f75 7263  sue with resourc
-000024b0: 6520 6275 7379 2065 7272 6f72 732e 0a20  e busy errors.. 
-000024c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000024d0: 2041 6464 696e 6720 6465 762e 7265 7365   Adding dev.rese
-000024e0: 7428 2920 736f 6c76 6573 2074 6869 732e  t() solves this.
-000024f0: 2053 6565 2068 7474 7073 3a2f 2f73 7461   See https://sta
-00002500: 636b 6f76 6572 666c 6f77 2e63 6f6d 2f71  ckoverflow.com/q
-00002510: 7565 7374 696f 6e73 2f32 3933 3435 3332  uestions/2934532
-00002520: 352f 7261 7370 6265 7272 792d 7079 7573  5/raspberry-pyus
-00002530: 622d 6765 7473 2d72 6573 6f75 7263 652d  b-gets-resource-
-00002540: 6275 7379 0a20 2020 2020 2020 2020 2020  busy.           
-00002550: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
-00002560: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002590: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000025a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000025b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000025c0: 2323 2323 2323 2323 2323 0a20 2020 2020  ##########.     
-000025d0: 2020 2020 2020 2020 2020 2069 6620 2252             if "R
-000025e0: 6573 6f75 7263 6520 6275 7379 2220 696e  esource busy" in
-000025f0: 2073 7472 2865 7863 2920 616e 6420 7265   str(exc) and re
-00002600: 7472 6965 7320 3c3d 2033 3a0a 2020 2020  tries <= 3:.    
-00002610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002620: 6c6f 672e 7761 726e 2822 4861 7264 7761  log.warn("Hardwa
-00002630: 7265 2046 6169 6c75 7265 2069 6e20 7365  re Failure in se
-00002640: 7443 6f6e 6669 6775 7261 7469 6f6e 2e20  tConfiguration. 
-00002650: 5265 736f 7572 6365 2062 7573 7920 6572  Resource busy er
-00002660: 726f 722e 2041 7474 656d 7074 696e 6720  ror. Attempting 
-00002670: 746f 2072 6561 7474 6163 6820 6472 6976  to reattach driv
-00002680: 6572 2062 7920 7265 7365 742e 2229 0a20  er by reset."). 
-00002690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000026a0: 2020 2073 656c 662e 6465 7669 6365 5f74     self.device_t
-000026b0: 7970 652e 7265 7365 7428 6465 7629 0a20  ype.reset(dev). 
-000026c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000026d0: 2020 2073 6c65 6570 5f6d 7320 3d20 3130     sleep_ms = 10
-000026e0: 202a 2a20 7265 7472 6965 7320 2320 3130   ** retries # 10
-000026f0: 5e33 206d 7320 3d20 3173 6563 206d 6178  ^3 ms = 1sec max
-00002700: 2064 656c 6179 0a20 2020 2020 2020 2020   delay.         
-00002710: 2020 2020 2020 2020 2020 2073 6c65 6570             sleep
-00002720: 2873 6c65 6570 5f6d 7320 2f20 3130 3030  (sleep_ms / 1000
-00002730: 2e30 2920 0a20 2020 2020 2020 2020 2020  .0) .           
-00002740: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00002750: 7365 6c66 2e63 6f6e 6e65 6374 2872 6574  self.connect(ret
-00002760: 7269 6573 3d72 6574 7269 6573 2b31 2920  ries=retries+1) 
-00002770: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00002780: 2020 7365 6c66 2e63 6f6e 6e65 6374 696e    self.connectin
-00002790: 6720 3d20 4661 6c73 650a 2020 2020 2020  g = False.      
-000027a0: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-000027b0: 6622 4861 7264 7761 7265 2046 6169 6c75  f"Hardware Failu
-000027c0: 7265 2069 6e20 7365 7443 6f6e 6669 6775  re in setConfigu
-000027d0: 7261 7469 6f6e 2c20 6769 7669 6e67 2075  ration, giving u
-000027e0: 7020 6166 7465 7220 7b72 6574 7269 6573  p after {retries
-000027f0: 7d20 7265 7472 6965 7322 0a20 2020 2020  } retries".     
-00002800: 2020 2020 2020 2020 2020 206c 6f67 2e63             log.c
-00002810: 7269 7469 6361 6c28 6d73 672c 2065 7863  ritical(msg, exc
-00002820: 5f69 6e66 6f3d 3129 0a20 2020 2020 2020  _info=1).       
-00002830: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00002840: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00002850: 6f6e 7365 2846 616c 7365 2c20 6572 726f  onse(False, erro
-00002860: 725f 6d73 673d 6d73 6729 0a0a 2020 2020  r_msg=msg)..    
-00002870: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00002880: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00002890: 2e64 6562 7567 2822 636c 6169 6d69 6e67  .debug("claiming
-000028a0: 2069 6e74 6572 6661 6365 2229 0a20 2020   interface").   
-000028b0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-000028c0: 756c 7420 3d20 7365 6c66 2e64 6576 6963  ult = self.devic
-000028d0: 655f 7479 7065 2e63 6c61 696d 5f69 6e74  e_type.claim_int
-000028e0: 6572 6661 6365 2864 6576 6963 652c 2030  erface(device, 0
-000028f0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-00002900: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00002910: 7320 6578 633a 0a20 2020 2020 2020 2020  s exc:.         
-00002920: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00002930: 6563 7469 6e67 203d 2046 616c 7365 0a20  ecting = False. 
-00002940: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00002950: 7367 203d 2022 4861 7264 7761 7265 2046  sg = "Hardware F
-00002960: 6169 6c75 7265 2069 6e20 636c 6169 6d49  ailure in claimI
-00002970: 6e74 6572 6661 6365 220a 2020 2020 2020  nterface".      
-00002980: 2020 2020 2020 2020 2020 6c6f 672e 6372            log.cr
-00002990: 6974 6963 616c 286d 7367 2c20 6578 635f  itical(msg, exc_
-000029a0: 696e 666f 3d31 290a 2020 2020 2020 2020  info=1).        
-000029b0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-000029c0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-000029d0: 6e73 6528 4661 6c73 652c 2065 7272 6f72  nse(False, error
-000029e0: 5f6d 7367 3d6d 7367 290a 0a20 2020 2020  _msg=msg)..     
-000029f0: 2020 2073 656c 662e 6465 7669 6365 203d     self.device =
-00002a00: 2064 6576 6963 650a 0a20 2020 2020 2020   device..       
-00002a10: 2072 6574 7572 6e20 7365 6c66 2e5f 706f   return self._po
-00002a20: 7374 5f63 6f6e 6e65 6374 2829 0a0a 2020  st_connect()..  
-00002a30: 2020 6465 6620 5f70 6f73 745f 636f 6e6e    def _post_conn
-00002a40: 6563 7428 7365 6c66 2920 2d3e 2053 7065  ect(self) -> Spe
-00002a50: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-00002a60: 653a 2020 2020 2020 2020 2020 2020 0a20  e:            . 
-00002a70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00002a80: 2020 2050 6572 666f 726d 2061 6464 6974     Perform addit
-00002a90: 696f 6e61 6c20 7365 7475 7020 6166 7465  ional setup afte
-00002aa0: 7220 696e 7374 616e 7469 6174 696e 6720  r instantiating 
-00002ab0: 4649 4420 6465 7669 6365 2e0a 2020 2020  FID device..    
-00002ac0: 2020 2020 5370 6c69 742d 6f75 7420 6672      Split-out fr
-00002ad0: 6f6d 2070 6879 7369 6361 6c20 2f20 6275  om physical / bu
-00002ae0: 7320 636f 6e6e 6563 7428 2920 746f 2073  s connect() to s
-00002af0: 696d 706c 6966 7920 4d6f 636b 5370 6563  implify MockSpec
-00002b00: 7472 6f6d 6574 6572 2e0a 2020 2020 2020  trometer..      
-00002b10: 2020 2222 220a 0a20 2020 2020 2020 2023    """..        #
-00002b20: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00002b30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002b40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002b50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002b60: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-00002b70: 2320 6d6f 6465 6c2d 7370 6563 6966 6963  # model-specific
-00002b80: 2073 6574 7469 6e67 730a 2020 2020 2020   settings.      
-00002b90: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
-00002ba0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002bb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002bc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002bd0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-00002be0: 2020 2020 6c6f 672e 6465 6275 6728 226d      log.debug("m
-00002bf0: 6f64 656c 2d73 7065 6369 6669 6320 7365  odel-specific se
-00002c00: 7474 696e 6773 2229 0a0a 2020 2020 2020  ttings")..      
-00002c10: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
-00002c20: 6773 2e69 735f 696e 6761 6173 2829 3a0a  gs.is_ingaas():.
-00002c30: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00002c40: 6973 206d 7573 7420 6265 2066 6f72 2073  is must be for s
-00002c50: 6f6d 6520 7665 7279 206f 6c64 2049 6e47  ome very old InG
-00002c60: 6141 7320 7370 6563 7472 6f6d 6574 6572  aAs spectrometer
-00002c70: 733f 0a20 2020 2020 2020 2020 2020 2023  s?.            #
-00002c80: 2057 696c 6c20 7072 6f62 6162 6c79 2077   Will probably w
-00002c90: 616e 7420 746f 2072 656d 6f76 6520 7468  ant to remove th
-00002ca0: 6973 2066 6f72 2053 6572 6965 732d 5853  is for Series-XS
-00002cb0: 2e2e 2e0a 2020 2020 2020 2020 2020 2020  ....            
-00002cc0: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
-00002cd0: 696e 6773 2e69 735f 6172 6d28 293a 0a20  ings.is_arm():. 
-00002ce0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00002cf0: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
-00002d00: 726f 6d2e 6163 7469 7665 5f70 6978 656c  rom.active_pixel
-00002d10: 735f 686f 7269 7a6f 6e74 616c 203d 2035  s_horizontal = 5
-00002d20: 3132 0a0a 2020 2020 2020 2020 2020 2020  12..            
-00002d30: 6966 206e 6f74 2073 656c 662e 6765 745f  if not self.get_
-00002d40: 6869 6768 5f67 6169 6e5f 6d6f 6465 5f65  high_gain_mode_e
-00002d50: 6e61 626c 6564 2829 3a0a 2020 2020 2020  nabled():.      
-00002d60: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00002d70: 6574 5f68 6967 685f 6761 696e 5f6d 6f64  et_high_gain_mod
-00002d80: 655f 656e 6162 6c65 2854 7275 6529 0a0a  e_enable(True)..
-00002d90: 2020 2020 2020 2020 2320 2323 2323 2323          # ######
+00000ae0: 2323 2323 2323 0d0a 2020 2020 2320 4c69  ######..    # Li
+00000af0: 6665 6379 636c 650d 0a20 2020 2023 2023  fecycle..    # #
+00000b00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000b10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000b20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000b30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000b40: 2323 2323 2323 2323 230d 0a0d 0a20 2020  #########....   
+00000b50: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00000b60: 6c66 2c20 6465 7669 6365 5f69 643a 2073  lf, device_id: s
+00000b70: 7472 2c20 6d65 7373 6167 655f 7175 6575  tr, message_queu
+00000b80: 653a 206c 6973 7420 3d20 4e6f 6e65 293a  e: list = None):
+00000b90: 2023 202d 3e20 4e6f 6e65 200d 0a20 2020   # -> None ..   
+00000ba0: 2020 2020 2022 2222 0d0a 2020 2020 2020       """..      
+00000bb0: 2020 496e 7374 616e 7469 6174 6520 6120    Instantiate a 
+00000bc0: 4665 6174 7572 6549 6465 6e74 6966 6963  FeatureIdentific
+00000bd0: 6174 696f 6e44 6576 6963 6520 7769 7468  ationDevice with
+00000be0: 2066 726f 6d20 7468 6520 6769 7665 6e20   from the given 
+00000bf0: 6465 7669 6365 5f69 642e 0d0a 2020 2020  device_id...    
+00000c00: 2020 2020 4070 6172 616d 2064 6576 6963      @param devic
+00000c10: 655f 6964 205b 696e 5d20 6465 7669 6365  e_id [in] device
+00000c20: 2049 4420 2822 5553 423a 3078 3234 6161   ID ("USB:0x24aa
+00000c30: 3a30 7831 3030 303a 313a 3234 2229 0d0a  :0x1000:1:24")..
+00000c40: 2020 2020 2020 2020 4070 6172 616d 206d          @param m
+00000c50: 6573 7361 6765 5f71 7565 7565 205b 6f75  essage_queue [ou
+00000c60: 745d 2069 6620 7072 6f76 6964 6564 2c20  t] if provided, 
+00000c70: 7072 6f76 6964 6573 2061 6e20 6f75 7462  provides an outb
+00000c80: 6f75 6e64 2028 6672 6f6d 2046 4944 290d  ound (from FID).
+00000c90: 0a20 2020 2020 2020 2071 7565 7565 2066  .        queue f
+00000ca0: 6f72 2077 7269 7469 6e67 2053 7461 7475  or writing Statu
+00000cb0: 734d 6573 7361 6765 206f 626a 6563 7473  sMessage objects
+00000cc0: 2075 7073 7472 6561 6d0d 0a20 2020 2020   upstream..     
+00000cd0: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+00000ce0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00000cf0: 2829 0d0a 2020 2020 2020 2020 7365 6c66  ()..        self
+00000d00: 2e64 6576 6963 655f 6964 203d 2064 6576  .device_id = dev
+00000d10: 6963 655f 6964 0d0a 2020 2020 2020 2020  ice_id..        
+00000d20: 7365 6c66 2e6d 6573 7361 6765 5f71 7565  self.message_que
+00000d30: 7565 203d 206d 6573 7361 6765 5f71 7565  ue = message_que
+00000d40: 7565 0d0a 0d0a 2020 2020 2020 2020 7365  ue....        se
+00000d50: 6c66 2e64 6576 6963 6520 3d20 4e6f 6e65  lf.device = None
+00000d60: 0d0a 2020 2020 2020 2020 6966 2022 4d4f  ..        if "MO
+00000d70: 434b 2220 696e 2073 7472 2864 6576 6963  CK" in str(devic
+00000d80: 655f 6964 292e 7570 7065 7228 293a 0d0a  e_id).upper():..
+00000d90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00000da0: 2e64 6576 6963 655f 7479 7065 203d 204d  .device_type = M
+00000db0: 6f63 6b55 5342 4465 7669 6365 2864 6576  ockUSBDevice(dev
+00000dc0: 6963 655f 6964 2e6e 616d 652c 205c 0d0a  ice_id.name, \..
+00000dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000de0: 6465 7669 6365 5f69 642e 6469 7265 6374  device_id.direct
+00000df0: 6f72 792c 0d0a 2020 2020 2020 2020 2020  ory,..          
+00000e00: 2020 2020 2020 6465 7669 6365 5f69 642e        device_id.
+00000e10: 6f76 6572 7269 6465 732c 0d0a 2020 2020  overrides,..    
+00000e20: 2020 2020 2020 2020 2020 2020 6465 7669              devi
+00000e30: 6365 5f69 642e 7370 6563 7472 615f 6f70  ce_id.spectra_op
+00000e40: 7469 6f6e 7329 0d0a 2020 2020 2020 2020  tions)..        
+00000e50: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+00000e60: 2020 2073 656c 662e 6465 7669 6365 5f74     self.device_t
+00000e70: 7970 6520 3d20 5265 616c 5553 4244 6576  ype = RealUSBDev
+00000e80: 6963 6528 6465 7669 6365 5f69 6429 0d0a  ice(device_id)..
+00000e90: 0d0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
+00000ea0: 6173 745f 7573 625f 7469 6d65 7374 616d  ast_usb_timestam
+00000eb0: 7020 3d20 4e6f 6e65 0d0a 0d0a 2020 2020  p = None....    
+00000ec0: 2020 2020 7365 6c66 2e6c 6173 6572 5f74      self.laser_t
+00000ed0: 656d 7065 7261 7475 7265 5f69 6e76 616c  emperature_inval
+00000ee0: 6964 203d 2046 616c 7365 0d0a 2020 2020  id = False..    
+00000ef0: 2020 2020 7365 6c66 2e63 6364 5f74 656d      self.ccd_tem
+00000f00: 7065 7261 7475 7265 5f69 6e76 616c 6964  perature_invalid
+00000f10: 203d 2046 616c 7365 0d0a 0d0a 2020 2020   = False....    
+00000f20: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
+00000f30: 7320 3d20 5370 6563 7472 6f6d 6574 6572  s = Spectrometer
+00000f40: 5365 7474 696e 6773 2864 6576 6963 655f  Settings(device_
+00000f50: 6964 290d 0a20 2020 2020 2020 2073 656c  id)..        sel
+00000f60: 662e 6565 7072 6f6d 5f62 6163 6b75 7020  f.eeprom_backup 
+00000f70: 3d20 4e6f 6e65 0d0a 0d0a 2020 2020 2020  = None....      
+00000f80: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
+00000f90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000fa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000fb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000fc0: 2323 2323 2323 2323 2323 0d0a 2020 2020  ##########..    
+00000fd0: 2020 2020 2320 7468 6573 6520 6172 6520      # these are 
+00000fe0: 2264 7269 7665 7220 7374 6174 6522 2077  "driver state" w
+00000ff0: 6974 6869 6e20 4665 6174 7572 6549 6465  ithin FeatureIde
+00001000: 6e74 6966 6963 6174 696f 6e44 6576 6963  ntificationDevic
+00001010: 652c 2061 6e64 2064 6f6e 2774 0d0a 2020  e, and don't..  
+00001020: 2020 2020 2020 2320 7265 616c 6c79 2072        # really r
+00001030: 656c 6174 6520 746f 2074 6865 2073 7065  elate to the spe
+00001040: 6374 726f 6d65 7465 7220 6861 7264 7761  ctrometer hardwa
+00001050: 7265 0d0a 2020 2020 2020 2020 2320 2323  re..        # ##
+00001060: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001090: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000010a0: 2323 2323 0d0a 0d0a 2020 2020 2020 2020  ####....        
+000010b0: 7365 6c66 2e64 6574 6563 746f 725f 7465  self.detector_te
+000010c0: 635f 7365 7470 6f69 6e74 5f68 6173 5f62  c_setpoint_has_b
+000010d0: 6565 6e5f 7365 7420 3d20 4661 6c73 650d  een_set = False.
+000010e0: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
+000010f0: 7374 5f61 7070 6c69 6564 5f6c 6173 6572  st_applied_laser
+00001100: 5f70 6f77 6572 203d 2030 2e30 2023 206c  _power = 0.0 # l
+00001110: 6173 7420 706f 7765 7220 6c65 7665 6c20  ast power level 
+00001120: 4150 504c 4945 4420 746f 206c 6173 6572  APPLIED to laser
+00001130: 2c20 6569 7468 6572 2062 7920 7475 726e  , either by turn
+00001140: 696e 6720 6f66 6620 2830 2920 6f72 206f  ing off (0) or o
+00001150: 6e20 0d0a 2020 2020 2020 2020 7365 6c66  n ..        self
+00001160: 2e6e 6578 745f 6170 706c 6965 645f 6c61  .next_applied_la
+00001170: 7365 725f 706f 7765 7220 3d20 4e6f 6e65  ser_power = None
+00001180: 2023 2070 6f77 6572 206c 6576 656c 2074   # power level t
+00001190: 6f20 6265 2061 7070 6c69 6564 204e 4558  o be applied NEX
+000011a0: 5420 7469 6d65 2074 6865 206c 6173 6572  T time the laser
+000011b0: 2069 7320 656e 6162 6c65 640d 0a0d 0a20   is enabled.... 
+000011c0: 2020 2020 2020 2073 656c 662e 7261 6973         self.rais
+000011d0: 655f 6578 6365 7074 696f 6e73 203d 2046  e_exceptions = F
+000011e0: 616c 7365 0d0a 2020 2020 2020 2020 7365  alse..        se
+000011f0: 6c66 2e69 6e6a 6563 745f 7261 6e64 6f6d  lf.inject_random
+00001200: 5f65 7272 6f72 7320 3d20 4661 6c73 650d  _errors = False.
+00001210: 0a20 2020 2020 2020 2073 656c 662e 7261  .        self.ra
+00001220: 6e64 6f6d 5f65 7272 6f72 5f70 6572 6320  ndom_error_perc 
+00001230: 3d20 302e 3030 3120 2020 2320 302e 3125  = 0.001   # 0.1%
+00001240: 0d0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+00001250: 6c6c 6f77 5f64 6566 6175 6c74 5f67 6169  llow_default_gai
+00001260: 6e5f 7265 7365 7420 3d20 5472 7565 0d0a  n_reset = True..
+00001270: 0d0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+00001280: 6f6e 6e65 6374 6564 203d 2046 616c 7365  onnected = False
+00001290: 0d0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+000012a0: 6f6e 6e65 6374 696e 6720 3d20 4661 6c73  onnecting = Fals
+000012b0: 650d 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+000012c0: 7368 7574 646f 776e 5f72 6571 7565 7374  shutdown_request
+000012d0: 6564 203d 2046 616c 7365 0d0a 0d0a 2020  ed = False....  
+000012e0: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
+000012f0: 7370 6563 7472 756d 203d 204e 6f6e 650d  spectrum = None.
+00001300: 0a20 2020 2020 2020 2073 656c 662e 7370  .        self.sp
+00001310: 6563 7472 756d 5f63 6f75 6e74 203d 2030  ectrum_count = 0
+00001320: 0d0a 2020 2020 2020 2020 7365 6c66 2e70  ..        self.p
+00001330: 7265 765f 7069 7865 6c73 203d 204e 6f6e  rev_pixels = Non
+00001340: 650d 0a0d 0a20 2020 2020 2020 2023 2069  e....        # i
+00001350: 6e20 6361 7365 206f 6620 4932 4320 636f  n case of I2C co
+00001360: 6c6c 6973 696f 6e73 2077 6974 6869 6e20  llisions within 
+00001370: 7468 6520 7370 6563 7472 6f6d 6574 6572  the spectrometer
+00001380: 2c20 652e 672e 2064 7565 2074 6f20 6261  , e.g. due to ba
+00001390: 7474 6572 792d 4c45 4420 7374 6174 7573  ttery-LED status
+000013a0: 0d0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+000013b0: 6574 7279 5f65 6e61 626c 6564 203d 2054  etry_enabled = T
+000013c0: 7275 650d 0a20 2020 2020 2020 2073 656c  rue..        sel
+000013d0: 662e 7265 7472 795f 6d73 203d 2035 0d0a  f.retry_ms = 5..
+000013e0: 2020 2020 2020 2020 7365 6c66 2e72 6574          self.ret
+000013f0: 7279 5f6d 6178 203d 2033 0d0a 0d0a 2020  ry_max = 3....  
+00001400: 2020 2020 2020 7365 6c66 2e70 726f 6365        self.proce
+00001410: 7373 5f66 203d 2073 656c 662e 5f69 6e69  ss_f = self._ini
+00001420: 745f 7072 6f63 6573 735f 6675 6e63 7328  t_process_funcs(
+00001430: 290d 0a0d 0a20 2020 2064 6566 2068 616e  )....    def han
+00001440: 646c 655f 7265 7175 6573 7473 2873 656c  dle_requests(sel
+00001450: 662c 2072 6571 7565 7374 733a 206c 6973  f, requests: lis
+00001460: 745b 5370 6563 7472 6f6d 6574 6572 5265  t[SpectrometerRe
+00001470: 7175 6573 745d 293a 2023 202d 3e20 6c69  quest]): # -> li
+00001480: 7374 5b53 7065 6374 726f 6d65 7465 7252  st[SpectrometerR
+00001490: 6573 706f 6e73 655d 200d 0a20 2020 2020  esponse] ..     
+000014a0: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+000014b0: 4074 6f64 6f20 636f 6e73 6964 6572 206d  @todo consider m
+000014c0: 616b 696e 6720 2772 6571 7565 7374 7327  aking 'requests'
+000014d0: 2061 6e20 6f62 6a65 6374 2c20 616e 6420   an object, and 
+000014e0: 6479 6e61 6d69 6361 6c6c 7920 6368 6563  dynamically chec
+000014f0: 6b69 6e67 2074 6f20 0d0a 2020 2020 2020  king to ..      
+00001500: 2020 2020 2020 2020 7365 6520 6966 2069          see if i
+00001510: 7420 6973 2061 2073 696e 676c 6520 5370  t is a single Sp
+00001520: 6563 7472 6f6d 6574 6572 5265 7175 6573  ectrometerReques
+00001530: 7420 6f72 2061 206c 6973 745b 5370 6563  t or a list[Spec
+00001540: 7472 6f6d 6574 6572 5265 7175 6573 745d  trometerRequest]
+00001550: 3b0d 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00001560: 2069 6620 7468 6520 666f 726d 6572 2c20   if the former, 
+00001570: 6f6e 6c79 2072 6574 7572 6e20 6120 7369  only return a si
+00001580: 6e67 6c65 2053 7065 6374 726f 6d65 7465  ngle Spectromete
+00001590: 7252 6573 706f 6e73 652e 0d0a 2020 2020  rResponse...    
+000015a0: 2020 2020 2222 220d 0a20 2020 2020 2020      """..       
+000015b0: 2072 6573 706f 6e73 6573 203d 205b 5d0d   responses = [].
+000015c0: 0a20 2020 2020 2020 2066 6f72 2072 6571  .        for req
+000015d0: 7565 7374 2069 6e20 7265 7175 6573 7473  uest in requests
+000015e0: 3a0d 0a20 2020 2020 2020 2020 2020 2074  :..            t
+000015f0: 7279 3a0d 0a20 2020 2020 2020 2020 2020  ry:..           
+00001600: 2020 2020 2063 6d64 203d 2072 6571 7565       cmd = reque
+00001610: 7374 2e63 6d64 0d0a 2020 2020 2020 2020  st.cmd..        
+00001620: 2020 2020 2020 2020 7072 6f63 5f66 756e          proc_fun
+00001630: 6320 3d20 7365 6c66 2e70 726f 6365 7373  c = self.process
+00001640: 5f66 2e67 6574 2863 6d64 2c20 4e6f 6e65  _f.get(cmd, None
+00001650: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00001660: 2020 2069 6620 7072 6f63 5f66 756e 6320     if proc_func 
+00001670: 3d3d 204e 6f6e 653a 0d0a 2020 2020 2020  == None:..      
+00001680: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00001690: 7370 6f6e 7365 732e 6170 7065 6e64 2853  sponses.append(S
+000016a0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+000016b0: 6e73 6528 6572 726f 725f 6d73 673d 6622  nse(error_msg=f"
+000016c0: 756e 7375 7070 6f72 7465 6420 636d 6420  unsupported cmd 
+000016d0: 7b72 6571 7565 7374 2e63 6d64 7d22 2c20  {request.cmd}", 
+000016e0: 6572 726f 725f 6c76 6c3d 4572 726f 724c  error_lvl=ErrorL
+000016f0: 6576 656c 2e6c 6f77 2929 0d0a 2020 2020  evel.low))..    
+00001700: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00001710: 2072 6571 7565 7374 2e61 7267 7320 3d3d   request.args ==
+00001720: 205b 5d20 616e 6420 7265 7175 6573 742e   [] and request.
+00001730: 6b77 6172 6773 203d 3d20 7b7d 3a0d 0a20  kwargs == {}:.. 
+00001740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001750: 2020 2072 6573 706f 6e73 6573 2e61 7070     responses.app
+00001760: 656e 6428 7072 6f63 5f66 756e 6328 2929  end(proc_func())
+00001770: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00001780: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+00001790: 2020 2020 2020 2020 2020 2020 2072 6573               res
+000017a0: 706f 6e73 6573 2e61 7070 656e 6428 7072  ponses.append(pr
+000017b0: 6f63 5f66 756e 6328 2a72 6571 7565 7374  oc_func(*request
+000017c0: 2e61 7267 732c 202a 2a72 6571 7565 7374  .args, **request
+000017d0: 2e6b 7761 7267 7329 290d 0a20 2020 2020  .kwargs))..     
+000017e0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+000017f0: 6365 7074 696f 6e20 6173 2065 3a0d 0a20  ception as e:.. 
+00001800: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00001810: 6f67 2e65 7272 6f72 2866 2265 7272 6f72  og.error(f"error
+00001820: 2069 6e20 6861 6e64 6c69 6e67 2072 6571   in handling req
+00001830: 7565 7374 207b 7265 7175 6573 747d 206f  uest {request} o
+00001840: 6620 7b65 7d22 290d 0a20 2020 2020 2020  f {e}")..       
+00001850: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+00001860: 6573 2e61 7070 656e 6428 5370 6563 7472  es.append(Spectr
+00001870: 6f6d 6574 6572 5265 7370 6f6e 7365 2865  ometerResponse(e
+00001880: 7272 6f72 5f6d 7367 3d22 6572 726f 7220  rror_msg="error 
+00001890: 7072 6f63 6573 7369 6e67 2063 6d64 222c  processing cmd",
+000018a0: 2065 7272 6f72 5f6c 766c 3d45 7272 6f72   error_lvl=Error
+000018b0: 4c65 7665 6c2e 6d65 6469 756d 2929 0d0a  Level.medium))..
+000018c0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+000018d0: 6573 706f 6e73 6573 0d0a 0d0a 2020 2020  esponses....    
+000018e0: 6465 6620 636f 6e6e 6563 7428 7365 6c66  def connect(self
+000018f0: 2c20 7265 7472 6965 733d 3029 3a20 2320  , retries=0): # 
+00001900: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+00001910: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+00001920: 2020 2222 220d 0a20 2020 2020 2020 2043    """..        C
+00001930: 6f6e 6e65 6374 2074 6f20 7468 6520 6465  onnect to the de
+00001940: 7669 6365 2061 6e64 2069 6e69 7469 616c  vice and initial
+00001950: 697a 6520 6261 7369 6320 7365 7474 696e  ize basic settin
+00001960: 6773 2e0d 0a20 2020 2020 2020 2040 7761  gs...        @wa
+00001970: 726e 696e 6720 7468 6973 2063 6175 7365  rning this cause
+00001980: 7320 6120 7072 6f62 6c65 6d20 696e 206e  s a problem in n
+00001990: 6f6e 2d62 6c6f 636b 696e 6720 6d6f 6465  on-blocking mode
+000019a0: 2028 5761 7361 7463 6844 6576 6963 6557   (WasatchDeviceW
+000019b0: 7261 7070 6572 290d 0a20 2020 2020 2020  rapper)..       
+000019c0: 206f 6e20 4d61 634f 530d 0a20 2020 2020   on MacOS..     
+000019d0: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+000019e0: 7365 6c66 2e63 6f6e 6e65 6374 696e 6720  self.connecting 
+000019f0: 3d20 5472 7565 0d0a 0d0a 2020 2020 2020  = True....      
+00001a00: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
+00001a10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001a20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001a30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001a40: 2323 2323 2323 2323 2323 0d0a 2020 2020  ##########..    
+00001a50: 2020 2020 2320 5553 4220 436f 6e6e 6563      # USB Connec
+00001a60: 7469 6f6e 0d0a 2020 2020 2020 2020 2320  tion..        # 
+00001a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001a80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001a90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001aa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001ab0: 2323 2323 2323 0d0a 0d0a 2020 2020 2020  ######....      
+00001ac0: 2020 2320 4765 6e65 7261 7465 2061 2066    # Generate a f
+00001ad0: 7265 7368 206c 6973 7469 6e67 206f 6620  resh listing of 
+00001ae0: 5553 4220 6465 7669 6365 7320 7769 7468  USB devices with
+00001af0: 2074 6865 2072 6571 7565 7374 6564 2056   the requested V
+00001b00: 4944 2061 6e64 2050 4944 2e0d 0a20 2020  ID and PID...   
+00001b10: 2020 2020 2023 204e 6f74 6520 7468 6174       # Note that
+00001b20: 2074 6869 7320 6973 204e 4f54 2068 6f77   this is NOT how
+00001b30: 2057 6173 6174 6368 4275 7320 7472 6176   WasatchBus trav
+00001b40: 6572 7365 7320 7468 6520 6c69 7374 2e20  erses the list. 
+00001b50: 2049 7420 6163 7475 616c 6c79 0d0a 2020   It actually..  
+00001b60: 2020 2020 2020 2320 6361 6c6c 7320 7573        # calls us
+00001b70: 622e 6275 7373 6573 2829 2c20 7468 656e  b.busses(), then
+00001b80: 2069 7465 7261 7465 7320 6f76 6572 2062   iterates over b
+00001b90: 7573 2e64 6576 6963 6573 2c20 6275 7420  us.devices, but 
+00001ba0: 7468 6174 2773 2062 6563 6175 7365 0d0a  that's because..
+00001bb0: 2020 2020 2020 2020 2320 6974 2064 6f65          # it doe
+00001bc0: 736e 2774 206b 6e6f 7720 7768 6174 2050  sn't know what P
+00001bd0: 4944 7320 6974 206d 6967 6874 2062 6520  IDs it might be 
+00001be0: 6c6f 6f6b 696e 6720 666f 722e 2020 5765  looking for.  We
+00001bf0: 206b 6e6f 772c 2073 6f20 6a75 7374 0d0a   know, so just..
+00001c00: 2020 2020 2020 2020 2320 6e61 7272 6f77          # narrow
+00001c10: 2064 6f77 6e20 7468 6520 7365 6172 6368   down the search
+00001c20: 2074 6f20 7468 6f73 6520 6465 7669 6365   to those device
+00001c30: 732e 0d0a 0d0a 2020 2020 2020 2020 6c6f  s.....        lo
+00001c40: 672e 696e 666f 2866 2246 4944 2e63 6f6e  g.info(f"FID.con
+00001c50: 6e65 6374 3a20 6173 6b65 6420 746f 2063  nect: asked to c
+00001c60: 6f6e 6e65 6374 2074 6f20 6465 7669 6365  onnect to device
+00001c70: 5f74 7970 6520 7b73 656c 662e 6465 7669  _type {self.devi
+00001c80: 6365 5f74 7970 657d 2229 0d0a 2020 2020  ce_type}")..    
+00001c90: 2020 2020 6c6f 672e 696e 666f 2866 2246      log.info(f"F
+00001ca0: 4944 2e63 6f6e 6e65 6374 3a20 6361 6c6c  ID.connect: call
+00001cb0: 696e 6720 6465 7669 6365 5f74 7970 652e  ing device_type.
+00001cc0: 6669 6e64 2c20 6c6f 6f6b 696e 6720 666f  find, looking fo
+00001cd0: 7220 5649 4420 3078 7b73 656c 662e 6465  r VID 0x{self.de
+00001ce0: 7669 6365 5f69 642e 7669 643a 3034 787d  vice_id.vid:04x}
+00001cf0: 2061 6e64 2050 4944 2030 787b 7365 6c66   and PID 0x{self
+00001d00: 2e64 6576 6963 655f 6964 2e70 6964 3a30  .device_id.pid:0
+00001d10: 3478 7d22 290d 0a20 2020 2020 2020 2064  4x}")..        d
+00001d20: 6576 6963 6573 203d 2073 656c 662e 6465  evices = self.de
+00001d30: 7669 6365 5f74 7970 652e 6669 6e64 2866  vice_type.find(f
+00001d40: 696e 645f 616c 6c3d 5472 7565 2c20 6964  ind_all=True, id
+00001d50: 5665 6e64 6f72 3d73 656c 662e 6465 7669  Vendor=self.devi
+00001d60: 6365 5f69 642e 7669 642c 2069 6450 726f  ce_id.vid, idPro
+00001d70: 6475 6374 3d73 656c 662e 6465 7669 6365  duct=self.device
+00001d80: 5f69 642e 7069 6429 0d0a 2020 2020 2020  _id.pid)..      
+00001d90: 2020 6c6f 672e 696e 666f 2866 2246 4944    log.info(f"FID
+00001da0: 2e63 6f6e 6e65 6374 3a20 666f 756e 6420  .connect: found 
+00001db0: 6465 7669 6365 7320 7b64 6576 6963 6573  devices {devices
+00001dc0: 7d22 290d 0a20 2020 2020 2020 2064 6576  }")..        dev
+00001dd0: 5f6c 6973 7420 3d20 6c69 7374 2864 6576  _list = list(dev
+00001de0: 6963 6573 2920 2320 636f 6e76 6572 7420  ices) # convert 
+00001df0: 6672 6f6d 2061 7272 6179 0d0a 0d0a 2020  from array....  
+00001e00: 2020 2020 2020 6465 7669 6365 203d 204e        device = N
+00001e10: 6f6e 650d 0a20 2020 2020 2020 206c 6f67  one..        log
+00001e20: 2e69 6e66 6f28 6622 7365 6172 6368 696e  .info(f"searchin
+00001e30: 6720 666f 7220 7370 6563 6966 6965 6420  g for specified 
+00001e40: 6465 7669 6365 2069 6e20 6465 765f 6c69  device in dev_li
+00001e50: 7374 207b 6465 765f 6c69 7374 7d22 290d  st {dev_list}").
+00001e60: 0a20 2020 2020 2020 2066 6f72 2064 6576  .        for dev
+00001e70: 2069 6e20 6465 765f 6c69 7374 3a0d 0a20   in dev_list:.. 
+00001e80: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00001e90: 762e 6275 7320 213d 2073 656c 662e 6465  v.bus != self.de
+00001ea0: 7669 6365 5f69 642e 6275 733a 0d0a 2020  vice_id.bus:..  
+00001eb0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00001ec0: 672e 6465 6275 6728 2246 4944 2e63 6f6e  g.debug("FID.con
+00001ed0: 6e65 6374 3a20 7265 6a65 6374 696e 6720  nect: rejecting 
+00001ee0: 6465 7669 6365 2028 6275 7320 2564 2021  device (bus %d !
+00001ef0: 3d20 7265 7175 6573 7465 6420 2564 2922  = requested %d)"
+00001f00: 2c20 6465 762e 6275 732c 2073 656c 662e  , dev.bus, self.
+00001f10: 6465 7669 6365 5f69 642e 6275 7329 0d0a  device_id.bus)..
+00001f20: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00001f30: 2064 6576 2e61 6464 7265 7373 2021 3d20   dev.address != 
+00001f40: 7365 6c66 2e64 6576 6963 655f 6964 2e61  self.device_id.a
+00001f50: 6464 7265 7373 3a0d 0a20 2020 2020 2020  ddress:..       
+00001f60: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
+00001f70: 7567 2822 4649 442e 636f 6e6e 6563 743a  ug("FID.connect:
+00001f80: 2072 656a 6563 7469 6e67 2064 6576 6963   rejecting devic
+00001f90: 6520 2861 6464 7265 7373 2025 6420 213d  e (address %d !=
+00001fa0: 2072 6571 7565 7374 6564 2025 6429 222c   requested %d)",
+00001fb0: 2064 6576 2e61 6464 7265 7373 2c20 7365   dev.address, se
+00001fc0: 6c66 2e64 6576 6963 655f 6964 2e61 6464  lf.device_id.add
+00001fd0: 7265 7373 290d 0a20 2020 2020 2020 2020  ress)..         
+00001fe0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00001ff0: 2020 2020 2020 2020 2020 6465 7669 6365            device
+00002000: 203d 2064 6576 0d0a 2020 2020 2020 2020   = dev..        
+00002010: 2020 2020 2020 2020 6272 6561 6b0d 0a0d          break...
+00002020: 0a20 2020 2020 2020 2069 6620 6465 7669  .        if devi
+00002030: 6365 2069 7320 4e6f 6e65 3a0d 0a20 2020  ce is None:..   
+00002040: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
+00002050: 7567 2866 2246 4944 2e63 6f6e 6e65 6374  ug(f"FID.connect
+00002060: 3a20 756e 6162 6c65 2074 6f20 6669 6e64  : unable to find
+00002070: 2044 6576 6963 6549 4420 7b73 656c 662e   DeviceID {self.
+00002080: 6465 7669 6365 5f69 647d 2229 0d0a 2020  device_id}")..  
+00002090: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+000020a0: 6f6e 6e65 6374 696e 6720 3d20 4661 6c73  onnecting = Fals
+000020b0: 650d 0a20 2020 2020 2020 2020 2020 2072  e..            r
+000020c0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+000020d0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+000020e0: 4661 6c73 652c 2065 7272 6f72 5f6d 7367  False, error_msg
+000020f0: 3d66 2275 6e61 626c 6520 746f 2066 696e  =f"unable to fin
+00002100: 6420 4465 7669 6365 4944 207b 7365 6c66  d DeviceID {self
+00002110: 2e64 6576 6963 655f 6964 7d22 290d 0a20  .device_id}").. 
+00002120: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+00002130: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+00002140: 6275 6728 2246 4944 2e63 6f6e 6e65 6374  bug("FID.connect
+00002150: 3a20 6d61 7463 6865 6420 4465 7669 6365  : matched Device
+00002160: 4944 2025 7322 2c20 7374 7228 7365 6c66  ID %s", str(self
+00002170: 2e64 6576 6963 655f 6964 2929 0d0a 0d0a  .device_id))....
+00002180: 2020 2020 2020 2020 6966 206f 732e 6e61          if os.na
+00002190: 6d65 2021 3d20 2270 6f73 6978 223a 0d0a  me != "posix":..
+000021a0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+000021b0: 6465 6275 6728 226f 6e20 5769 6e64 6f77  debug("on Window
+000021c0: 732c 2073 6f20 4e4f 5420 7365 7474 696e  s, so NOT settin
+000021d0: 6720 636f 6e66 6967 7572 6174 696f 6e20  g configuration 
+000021e0: 616e 6420 636c 6169 6d69 6e67 2069 6e74  and claiming int
+000021f0: 6572 6661 6365 2229 0d0a 2020 2020 2020  erface")..      
+00002200: 2020 656c 6966 2022 6d61 634f 5322 2069    elif "macOS" i
+00002210: 6e20 706c 6174 666f 726d 2e70 6c61 7466  n platform.platf
+00002220: 6f72 6d28 293a 0d0a 2020 2020 2020 2020  orm():..        
+00002230: 2020 2020 6c6f 672e 6465 6275 6728 226f      log.debug("o
+00002240: 6e20 4d61 634f 532c 2073 6f20 4e4f 5420  n MacOS, so NOT 
+00002250: 7365 7474 696e 6720 636f 6e66 6967 7572  setting configur
+00002260: 6174 696f 6e20 616e 6420 636c 6169 6d69  ation and claimi
+00002270: 6e67 2069 6e74 6572 6661 6365 2229 0d0a  ng interface")..
+00002280: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00002290: 2020 2020 2020 2020 2020 206c 6f67 2e64             log.d
+000022a0: 6562 7567 2822 6f6e 2070 6f73 6978 2c20  ebug("on posix, 
+000022b0: 736f 2073 6574 7469 6e67 2063 6f6e 6669  so setting confi
+000022c0: 6775 7261 7469 6f6e 2061 6e64 2063 6c61  guration and cla
+000022d0: 696d 696e 6720 696e 7465 7266 6163 6522  iming interface"
+000022e0: 290d 0a0d 0a20 2020 2020 2020 2020 2020  )....           
+000022f0: 2023 2069 6e20 7468 6520 666f 6c6c 6f77   # in the follow
+00002300: 696e 672c 2072 6574 7572 6e20 5370 6563  ing, return Spec
+00002310: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00002320: 206f 626a 6563 7473 2072 6174 6865 7220   objects rather 
+00002330: 7468 616e 200d 0a20 2020 2020 2020 2020  than ..         
+00002340: 2020 2023 2072 6169 7369 6e67 2065 7863     # raising exc
+00002350: 6570 7469 6f6e 7320 736f 2074 6865 2075  eptions so the u
+00002360: 7365 7220 7769 6c6c 2068 6176 6520 6120  ser will have a 
+00002370: 6d6f 7265 2d75 7365 6675 6c20 6572 726f  more-useful erro
+00002380: 7220 0d0a 2020 2020 2020 2020 2020 2020  r ..            
+00002390: 2320 6d65 7373 6167 6520 746f 2072 6570  # message to rep
+000023a0: 6f72 7420 6f72 2075 7365 2069 6e20 7472  ort or use in tr
+000023b0: 6f75 626c 6573 686f 6f74 696e 6720 2865  oubleshooting (e
+000023c0: 7863 6570 7469 6f6e 2073 7469 6c6c 2067  xception still g
+000023d0: 6574 730d 0a20 2020 2020 2020 2020 2020  ets..           
+000023e0: 2023 206c 6f67 6765 6429 0d0a 2020 2020   # logged)..    
+000023f0: 2020 2020 2020 2020 7472 793a 0d0a 2020          try:..  
+00002400: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00002410: 672e 6465 6275 6728 2273 6574 7469 6e67  g.debug("setting
+00002420: 2063 6f6e 6669 6775 7261 7469 6f6e 2229   configuration")
+00002430: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00002440: 2020 7265 7375 6c74 203d 2073 656c 662e    result = self.
+00002450: 6465 7669 6365 5f74 7970 652e 7365 745f  device_type.set_
+00002460: 636f 6e66 6967 7572 6174 696f 6e28 6465  configuration(de
+00002470: 7669 6365 290d 0a20 2020 2020 2020 2020  vice)..         
+00002480: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00002490: 696f 6e20 6173 2065 7863 3a0d 0a20 2020  ion as exc:..   
+000024a0: 2020 2020 2020 2020 2020 2020 2023 2323               ###
+000024b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000024c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000024d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000024e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000024f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002510: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002520: 2323 0d0a 2020 2020 2020 2020 2020 2020  ##..            
+00002530: 2020 2020 2320 5468 6973 2061 6464 6974      # This addit
+00002540: 696f 6e61 6c20 6966 2073 7461 7465 6d65  ional if stateme
+00002550: 6e74 2069 7320 7072 6573 656e 7420 666f  nt is present fo
+00002560: 7220 7468 6520 5261 7370 6265 7272 7920  r the Raspberry 
+00002570: 5069 2e20 5468 6572 6520 6973 2061 6e20  Pi. There is an 
+00002580: 6973 7375 6520 7769 7468 2072 6573 6f75  issue with resou
+00002590: 7263 6520 6275 7379 2065 7272 6f72 732e  rce busy errors.
+000025a0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000025b0: 2020 2320 4164 6469 6e67 2064 6576 2e72    # Adding dev.r
+000025c0: 6573 6574 2829 2073 6f6c 7665 7320 7468  eset() solves th
+000025d0: 6973 2e20 5365 6520 6874 7470 733a 2f2f  is. See https://
+000025e0: 7374 6163 6b6f 7665 7266 6c6f 772e 636f  stackoverflow.co
+000025f0: 6d2f 7175 6573 7469 6f6e 732f 3239 3334  m/questions/2934
+00002600: 3533 3235 2f72 6173 7062 6572 7279 2d70  5325/raspberry-p
+00002610: 7975 7362 2d67 6574 732d 7265 736f 7572  yusb-gets-resour
+00002620: 6365 2d62 7573 790d 0a20 2020 2020 2020  ce-busy..       
+00002630: 2020 2020 2020 2020 2023 2323 2323 2323           #######
+00002640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002680: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000026a0: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+000026b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000026c0: 6966 2022 5265 736f 7572 6365 2062 7573  if "Resource bus
+000026d0: 7922 2069 6e20 7374 7228 6578 6329 2061  y" in str(exc) a
+000026e0: 6e64 2072 6574 7269 6573 203c 3d20 333a  nd retries <= 3:
+000026f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00002700: 2020 2020 2020 6c6f 672e 7761 726e 2822        log.warn("
+00002710: 4861 7264 7761 7265 2046 6169 6c75 7265  Hardware Failure
+00002720: 2069 6e20 7365 7443 6f6e 6669 6775 7261   in setConfigura
+00002730: 7469 6f6e 2e20 5265 736f 7572 6365 2062  tion. Resource b
+00002740: 7573 7920 6572 726f 722e 2041 7474 656d  usy error. Attem
+00002750: 7074 696e 6720 746f 2072 6561 7474 6163  pting to reattac
+00002760: 6820 6472 6976 6572 2062 7920 7265 7365  h driver by rese
+00002770: 742e 2229 0d0a 2020 2020 2020 2020 2020  t.")..          
+00002780: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00002790: 6576 6963 655f 7479 7065 2e72 6573 6574  evice_type.reset
+000027a0: 2864 6576 290d 0a20 2020 2020 2020 2020  (dev)..         
+000027b0: 2020 2020 2020 2020 2020 2073 6c65 6570             sleep
+000027c0: 5f6d 7320 3d20 3130 202a 2a20 7265 7472  _ms = 10 ** retr
+000027d0: 6965 7320 2320 3130 5e33 206d 7320 3d20  ies # 10^3 ms = 
+000027e0: 3173 6563 206d 6178 2064 656c 6179 0d0a  1sec max delay..
+000027f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002800: 2020 2020 736c 6565 7028 736c 6565 705f      sleep(sleep_
+00002810: 6d73 202f 2031 3030 302e 3029 200d 0a20  ms / 1000.0) .. 
+00002820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002830: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00002840: 6f6e 6e65 6374 2872 6574 7269 6573 3d72  onnect(retries=r
+00002850: 6574 7269 6573 2b31 2920 0d0a 0d0a 2020  etries+1) ....  
+00002860: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00002870: 6c66 2e63 6f6e 6e65 6374 696e 6720 3d20  lf.connecting = 
+00002880: 4661 6c73 650d 0a20 2020 2020 2020 2020  False..         
+00002890: 2020 2020 2020 206d 7367 203d 2066 2248         msg = f"H
+000028a0: 6172 6477 6172 6520 4661 696c 7572 6520  ardware Failure 
+000028b0: 696e 2073 6574 436f 6e66 6967 7572 6174  in setConfigurat
+000028c0: 696f 6e2c 2067 6976 696e 6720 7570 2061  ion, giving up a
+000028d0: 6674 6572 207b 7265 7472 6965 737d 2072  fter {retries} r
+000028e0: 6574 7269 6573 220d 0a20 2020 2020 2020  etries"..       
+000028f0: 2020 2020 2020 2020 206c 6f67 2e63 7269           log.cri
+00002900: 7469 6361 6c28 6d73 672c 2065 7863 5f69  tical(msg, exc_i
+00002910: 6e66 6f3d 3129 0d0a 2020 2020 2020 2020  nfo=1)..        
+00002920: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00002930: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00002940: 6e73 6528 4661 6c73 652c 2065 7272 6f72  nse(False, error
+00002950: 5f6d 7367 3d6d 7367 290d 0a0d 0a20 2020  _msg=msg)....   
+00002960: 2020 2020 2020 2020 2074 7279 3a0d 0a20           try:.. 
+00002970: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00002980: 6f67 2e64 6562 7567 2822 636c 6169 6d69  og.debug("claimi
+00002990: 6e67 2069 6e74 6572 6661 6365 2229 0d0a  ng interface")..
+000029a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029b0: 7265 7375 6c74 203d 2073 656c 662e 6465  result = self.de
+000029c0: 7669 6365 5f74 7970 652e 636c 6169 6d5f  vice_type.claim_
+000029d0: 696e 7465 7266 6163 6528 6465 7669 6365  interface(device
+000029e0: 2c20 3029 0d0a 2020 2020 2020 2020 2020  , 0)..          
+000029f0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00002a00: 6f6e 2061 7320 6578 633a 0d0a 2020 2020  on as exc:..    
+00002a10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00002a20: 2e63 6f6e 6e65 6374 696e 6720 3d20 4661  .connecting = Fa
+00002a30: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
+00002a40: 2020 2020 206d 7367 203d 2022 4861 7264       msg = "Hard
+00002a50: 7761 7265 2046 6169 6c75 7265 2069 6e20  ware Failure in 
+00002a60: 636c 6169 6d49 6e74 6572 6661 6365 220d  claimInterface".
+00002a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002a80: 206c 6f67 2e63 7269 7469 6361 6c28 6d73   log.critical(ms
+00002a90: 672c 2065 7863 5f69 6e66 6f3d 3129 0d0a  g, exc_info=1)..
+00002aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ab0: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+00002ac0: 7465 7252 6573 706f 6e73 6528 4661 6c73  terResponse(Fals
+00002ad0: 652c 2065 7272 6f72 5f6d 7367 3d6d 7367  e, error_msg=msg
+00002ae0: 290d 0a0d 0a20 2020 2020 2020 2073 656c  )....        sel
+00002af0: 662e 6465 7669 6365 203d 2064 6576 6963  f.device = devic
+00002b00: 650d 0a0d 0a20 2020 2020 2020 2072 6574  e....        ret
+00002b10: 7572 6e20 7365 6c66 2e5f 706f 7374 5f63  urn self._post_c
+00002b20: 6f6e 6e65 6374 2829 0d0a 0d0a 2020 2020  onnect()....    
+00002b30: 6465 6620 5f70 6f73 745f 636f 6e6e 6563  def _post_connec
+00002b40: 7428 7365 6c66 293a 2023 202d 3e20 5370  t(self): # -> Sp
+00002b50: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00002b60: 7365 200d 0a20 2020 2020 2020 2022 2222  se ..        """
+00002b70: 0d0a 2020 2020 2020 2020 5065 7266 6f72  ..        Perfor
+00002b80: 6d20 6164 6469 7469 6f6e 616c 2073 6574  m additional set
+00002b90: 7570 2061 6674 6572 2069 6e73 7461 6e74  up after instant
+00002ba0: 6961 7469 6e67 2046 4944 2064 6576 6963  iating FID devic
+00002bb0: 652e 0d0a 2020 2020 2020 2020 5370 6c69  e...        Spli
+00002bc0: 742d 6f75 7420 6672 6f6d 2070 6879 7369  t-out from physi
+00002bd0: 6361 6c20 2f20 6275 7320 636f 6e6e 6563  cal / bus connec
+00002be0: 7428 2920 746f 2073 696d 706c 6966 7920  t() to simplify 
+00002bf0: 4d6f 636b 5370 6563 7472 6f6d 6574 6572  MockSpectrometer
+00002c00: 2e0d 0a20 2020 2020 2020 2022 2222 0d0a  ...        """..
+00002c10: 0d0a 2020 2020 2020 2020 2320 2323 2323  ..        # ####
+00002c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002c30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002c40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002c50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002c60: 2323 0d0a 2020 2020 2020 2020 2320 6d6f  ##..        # mo
+00002c70: 6465 6c2d 7370 6563 6966 6963 2073 6574  del-specific set
+00002c80: 7469 6e67 730d 0a20 2020 2020 2020 2023  tings..        #
+00002c90: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00002ca0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002cb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002cc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002cd0: 2323 2323 2323 230d 0a0d 0a20 2020 2020  #######....     
+00002ce0: 2020 206c 6f67 2e64 6562 7567 2822 6d6f     log.debug("mo
+00002cf0: 6465 6c2d 7370 6563 6966 6963 2073 6574  del-specific set
+00002d00: 7469 6e67 7322 290d 0a0d 0a20 2020 2020  tings")....     
+00002d10: 2020 2023 2064 6566 6175 6c74 2068 6967     # default hig
+00002d20: 682d 6761 696e 206d 6f64 6520 666f 7220  h-gain mode for 
+00002d30: 496e 4761 4173 0d0a 2020 2020 2020 2020  InGaAs..        
+00002d40: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+00002d50: 2e69 735f 696e 6761 6173 2829 3a0d 0a20  .is_ingaas():.. 
+00002d60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00002d70: 7365 745f 6869 6768 5f67 6169 6e5f 6d6f  set_high_gain_mo
+00002d80: 6465 5f65 6e61 626c 6528 5472 7565 290d  de_enable(True).
+00002d90: 0a0d 0a20 2020 2020 2020 2023 2023 2323  ...        # ###
 00002da0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002db0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002dc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002dd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002de0: 0a20 2020 2020 2020 2023 2045 4550 524f  .        # EEPRO
-00002df0: 4d0a 2020 2020 2020 2020 2320 2323 2323  M.        # ####
-00002e00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002de0: 2323 230d 0a20 2020 2020 2020 2023 2045  ###..        # E
+00002df0: 4550 524f 4d0d 0a20 2020 2020 2020 2023  EPROM..        #
+00002e00: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
 00002e10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002e20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002e30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002e40: 2323 0a0a 2020 2020 2020 2020 6c6f 672e  ##..        log.
-00002e50: 6465 6275 6728 2272 6561 6469 6e67 2045  debug("reading E
-00002e60: 4550 524f 4d22 290a 0a20 2020 2020 2020  EPROM")..       
-00002e70: 2072 6573 756c 7420 3d20 7365 6c66 2e5f   result = self._
-00002e80: 7265 6164 5f65 6570 726f 6d28 290a 2020  read_eeprom().  
-00002e90: 2020 2020 2020 6966 2072 6573 756c 742e        if result.
-00002ea0: 6461 7461 203d 3d20 4661 6c73 653a 0a20  data == False:. 
-00002eb0: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
-00002ec0: 7272 6f72 2866 2266 6169 6c65 6420 746f  rror(f"failed to
-00002ed0: 2072 6561 6420 4545 5052 4f4d 2c20 676f   read EEPROM, go
-00002ee0: 7420 6572 726f 7220 6d65 7373 6167 6520  t error message 
-00002ef0: 6f66 207b 7265 7375 6c74 2e65 7272 6f72  of {result.error
-00002f00: 5f6d 7367 7d22 290a 2020 2020 2020 2020  _msg}").        
-00002f10: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00002f20: 696e 6720 3d20 4661 6c73 650a 2020 2020  ing = False.    
-00002f30: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00002f40: 6573 756c 740a 0a20 2020 2020 2020 2023  esult..        #
-00002f50: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00002e40: 2323 2323 2323 230d 0a0d 0a20 2020 2020  #######....     
+00002e50: 2020 206c 6f67 2e64 6562 7567 2822 7265     log.debug("re
+00002e60: 6164 696e 6720 4545 5052 4f4d 2229 0d0a  ading EEPROM")..
+00002e70: 0d0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+00002e80: 203d 2073 656c 662e 5f72 6561 645f 6565   = self._read_ee
+00002e90: 7072 6f6d 2829 0d0a 2020 2020 2020 2020  prom()..        
+00002ea0: 6966 2072 6573 756c 742e 6461 7461 203d  if result.data =
+00002eb0: 3d20 4661 6c73 653a 0d0a 2020 2020 2020  = False:..      
+00002ec0: 2020 2020 2020 6c6f 672e 6572 726f 7228        log.error(
+00002ed0: 6622 6661 696c 6564 2074 6f20 7265 6164  f"failed to read
+00002ee0: 2045 4550 524f 4d2c 2067 6f74 2065 7272   EEPROM, got err
+00002ef0: 6f72 206d 6573 7361 6765 206f 6620 7b72  or message of {r
+00002f00: 6573 756c 742e 6572 726f 725f 6d73 677d  esult.error_msg}
+00002f10: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+00002f20: 7365 6c66 2e63 6f6e 6e65 6374 696e 6720  self.connecting 
+00002f30: 3d20 4661 6c73 650d 0a20 2020 2020 2020  = False..       
+00002f40: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+00002f50: 6c74 0d0a 0d0a 2020 2020 2020 2020 2320  lt....        # 
 00002f60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002f70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002f80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002f90: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-00002fa0: 2320 4c61 7365 720a 2020 2020 2020 2020  # Laser.        
-00002fb0: 2320 2323 2323 2323 2323 2323 2323 2323  # ##############
-00002fc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002f90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002fa0: 2323 2323 2323 0d0a 2020 2020 2020 2020  ######..        
+00002fb0: 2320 4c61 7365 720d 0a20 2020 2020 2020  # Laser..       
+00002fc0: 2023 2023 2323 2323 2323 2323 2323 2323   # #############
 00002fd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00002fe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00002ff0: 2323 2323 2323 2323 0a0a 2020 2020 2020  ########..      
-00003000: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
-00003010: 6773 2e65 6570 726f 6d2e 6861 735f 6c61  gs.eeprom.has_la
-00003020: 7365 723a 0a20 2020 2020 2020 2020 2020  ser:.           
-00003030: 2073 656c 662e 7365 745f 6c61 7365 725f   self.set_laser_
-00003040: 656e 6162 6c65 2846 616c 7365 290a 0a20  enable(False).. 
-00003050: 2020 2020 2020 2023 2023 2323 2323 2323         # #######
-00003060: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00002ff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003000: 2323 2323 2323 2323 230d 0a0d 0a20 2020  #########....   
+00003010: 2020 2020 2069 6620 7365 6c66 2e73 6574       if self.set
+00003020: 7469 6e67 732e 6565 7072 6f6d 2e68 6173  tings.eeprom.has
+00003030: 5f6c 6173 6572 3a0d 0a20 2020 2020 2020  _laser:..       
+00003040: 2020 2020 2073 656c 662e 7365 745f 6c61       self.set_la
+00003050: 7365 725f 656e 6162 6c65 2846 616c 7365  ser_enable(False
+00003060: 290d 0a0d 0a20 2020 2020 2020 2023 2023  )....        # #
 00003070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00003080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003090: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-000030a0: 2020 2020 2020 2020 2320 4465 7465 6374          # Detect
-000030b0: 6f72 2054 4543 0a20 2020 2020 2020 2023  or TEC.        #
-000030c0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-000030d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003090: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000030a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000030b0: 2323 2323 230d 0a20 2020 2020 2020 2023  #####..        #
+000030c0: 2044 6574 6563 746f 7220 5445 430d 0a20   Detector TEC.. 
+000030d0: 2020 2020 2020 2023 2023 2323 2323 2323         # #######
 000030e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000030f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003100: 2323 2323 2323 230a 0a20 2020 2020 2020  #######..       
-00003110: 2064 6567 4320 3d20 554e 494e 4954 4941   degC = UNINITIA
-00003120: 4c49 5a45 445f 5445 4d50 4552 4154 5552  LIZED_TEMPERATUR
-00003130: 455f 4445 475f 433b 0a20 2020 2020 2020  E_DEG_C;.       
-00003140: 2065 6570 726f 6d20 3d20 7365 6c66 2e73   eeprom = self.s
-00003150: 6574 7469 6e67 732e 6565 7072 6f6d 0a20  ettings.eeprom. 
-00003160: 2020 2020 2020 2069 6620 2865 6570 726f         if (eepro
-00003170: 6d2e 7374 6172 7475 705f 7465 6d70 5f64  m.startup_temp_d
-00003180: 6567 4320 3e3d 2065 6570 726f 6d2e 6d69  egC >= eeprom.mi
-00003190: 6e5f 7465 6d70 5f64 6567 4320 616e 6420  n_temp_degC and 
-000031a0: 0a20 2020 2020 2020 2020 2020 2065 6570  .            eep
-000031b0: 726f 6d2e 7374 6172 7475 705f 7465 6d70  rom.startup_temp
-000031c0: 5f64 6567 4320 3c3d 2065 6570 726f 6d2e  _degC <= eeprom.
-000031d0: 6d61 785f 7465 6d70 5f64 6567 4329 3a0a  max_temp_degC):.
-000031e0: 2020 2020 2020 2020 2020 2020 6465 6743              degC
-000031f0: 203d 2065 6570 726f 6d2e 7374 6172 7475   = eeprom.startu
-00003200: 705f 7465 6d70 5f64 6567 430a 2020 2020  p_temp_degC.    
-00003210: 2020 2020 656c 6966 2028 7265 2e6d 6174      elif (re.mat
-00003220: 6368 2872 2231 3031 3431 7c39 3231 3422  ch(r"10141|9214"
-00003230: 2c20 6565 7072 6f6d 2e64 6574 6563 746f  , eeprom.detecto
-00003240: 722c 2072 652e 4947 4e4f 5245 4341 5345  r, re.IGNORECASE
-00003250: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00003260: 6465 6743 203d 202d 3135 0a20 2020 2020  degC = -15.     
-00003270: 2020 2065 6c69 6620 2872 652e 6d61 7463     elif (re.matc
-00003280: 6828 7222 3131 3531 317c 3131 3835 307c  h(r"11511|11850|
-00003290: 3133 3937 317c 3730 3331 222c 2065 6570  13971|7031", eep
-000032a0: 726f 6d2e 6465 7465 6374 6f72 2c20 7265  rom.detector, re
-000032b0: 2e49 474e 4f52 4543 4153 4529 293a 0a20  .IGNORECASE)):. 
-000032c0: 2020 2020 2020 2020 2020 2064 6567 4320             degC 
-000032d0: 3d20 3130 0a0a 2020 2020 2020 2020 6966  = 10..        if
-000032e0: 2028 6565 7072 6f6d 2e68 6173 5f63 6f6f   (eeprom.has_coo
-000032f0: 6c69 6e67 2061 6e64 2064 6567 4320 213d  ling and degC !=
-00003300: 2055 4e49 4e49 5449 414c 495a 4544 5f54   UNINITIALIZED_T
-00003310: 454d 5045 5241 5455 5245 5f44 4547 5f43  EMPERATURE_DEG_C
-00003320: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-00003330: 5445 4320 646f 6573 6e27 7420 646f 2061  TEC doesn't do a
-00003340: 6e79 7468 696e 6720 756e 6c65 7373 2079  nything unless y
-00003350: 6f75 2067 6976 6520 6974 2061 2074 656d  ou give it a tem
-00003360: 7065 7261 7475 7265 2066 6972 7374 0a20  perature first. 
-00003370: 2020 2020 2020 2020 2020 206c 6f67 2e64             log.d
-00003380: 6562 7567 2866 2273 6574 7469 6e67 2054  ebug(f"setting T
-00003390: 4543 2073 6574 706f 696e 7420 746f 207b  EC setpoint to {
-000033a0: 6465 6743 7d20 6465 6720 4322 290a 2020  degC} deg C").  
-000033b0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-000033c0: 6574 6563 746f 725f 7465 635f 7365 7470  etector_tec_setp
-000033d0: 6f69 6e74 5f64 6567 4320 3d20 6465 6743  oint_degC = degC
-000033e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000033f0: 662e 7365 745f 6465 7465 6374 6f72 5f74  f.set_detector_t
-00003400: 6563 5f73 6574 706f 696e 745f 6465 6743  ec_setpoint_degC
-00003410: 2873 656c 662e 6465 7465 6374 6f72 5f74  (self.detector_t
-00003420: 6563 5f73 6574 706f 696e 745f 6465 6743  ec_setpoint_degC
-00003430: 290a 0a20 2020 2020 2020 2020 2020 206c  )..            l
-00003440: 6f67 2e64 6562 7567 2822 656e 6162 6c69  og.debug("enabli
-00003450: 6e67 2064 6574 6563 746f 7220 5445 4322  ng detector TEC"
-00003460: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00003470: 6c66 2e64 6574 6563 746f 725f 7465 635f  lf.detector_tec_
-00003480: 7365 7470 6f69 6e74 5f68 6173 5f62 6565  setpoint_has_bee
-00003490: 6e5f 7365 7420 3d20 5472 7565 0a20 2020  n_set = True.   
-000034a0: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
-000034b0: 745f 7465 635f 656e 6162 6c65 2854 7275  t_tec_enable(Tru
-000034c0: 6529 0a0a 2020 2020 2020 2020 2320 2323  e)..        # ##
-000034d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000034e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000034f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003100: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003110: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+00003120: 0a0d 0a20 2020 2020 2020 2064 6567 4320  ...        degC 
+00003130: 3d20 554e 494e 4954 4941 4c49 5a45 445f  = UNINITIALIZED_
+00003140: 5445 4d50 4552 4154 5552 455f 4445 475f  TEMPERATURE_DEG_
+00003150: 433b 0d0a 2020 2020 2020 2020 6565 7072  C;..        eepr
+00003160: 6f6d 203d 2073 656c 662e 7365 7474 696e  om = self.settin
+00003170: 6773 2e65 6570 726f 6d0d 0a20 2020 2020  gs.eeprom..     
+00003180: 2020 2069 6620 2865 6570 726f 6d2e 7374     if (eeprom.st
+00003190: 6172 7475 705f 7465 6d70 5f64 6567 4320  artup_temp_degC 
+000031a0: 3e3d 2065 6570 726f 6d2e 6d69 6e5f 7465  >= eeprom.min_te
+000031b0: 6d70 5f64 6567 4320 616e 6420 0d0a 2020  mp_degC and ..  
+000031c0: 2020 2020 2020 2020 2020 6565 7072 6f6d            eeprom
+000031d0: 2e73 7461 7274 7570 5f74 656d 705f 6465  .startup_temp_de
+000031e0: 6743 203c 3d20 6565 7072 6f6d 2e6d 6178  gC <= eeprom.max
+000031f0: 5f74 656d 705f 6465 6743 293a 0d0a 2020  _temp_degC):..  
+00003200: 2020 2020 2020 2020 2020 6465 6743 203d            degC =
+00003210: 2065 6570 726f 6d2e 7374 6172 7475 705f   eeprom.startup_
+00003220: 7465 6d70 5f64 6567 430d 0a20 2020 2020  temp_degC..     
+00003230: 2020 2065 6c69 6620 2872 652e 6d61 7463     elif (re.matc
+00003240: 6828 7222 3130 3134 317c 3932 3134 222c  h(r"10141|9214",
+00003250: 2065 6570 726f 6d2e 6465 7465 6374 6f72   eeprom.detector
+00003260: 2c20 7265 2e49 474e 4f52 4543 4153 4529  , re.IGNORECASE)
+00003270: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00003280: 6465 6743 203d 202d 3135 0d0a 2020 2020  degC = -15..    
+00003290: 2020 2020 656c 6966 2028 7265 2e6d 6174      elif (re.mat
+000032a0: 6368 2872 2231 3135 3131 7c31 3138 3530  ch(r"11511|11850
+000032b0: 7c31 3339 3731 7c37 3033 3122 2c20 6565  |13971|7031", ee
+000032c0: 7072 6f6d 2e64 6574 6563 746f 722c 2072  prom.detector, r
+000032d0: 652e 4947 4e4f 5245 4341 5345 2929 3a0d  e.IGNORECASE)):.
+000032e0: 0a20 2020 2020 2020 2020 2020 2064 6567  .            deg
+000032f0: 4320 3d20 3130 0d0a 0d0a 2020 2020 2020  C = 10....      
+00003300: 2020 6966 2028 6565 7072 6f6d 2e68 6173    if (eeprom.has
+00003310: 5f63 6f6f 6c69 6e67 2061 6e64 2064 6567  _cooling and deg
+00003320: 4320 213d 2055 4e49 4e49 5449 414c 495a  C != UNINITIALIZ
+00003330: 4544 5f54 454d 5045 5241 5455 5245 5f44  ED_TEMPERATURE_D
+00003340: 4547 5f43 293a 0d0a 2020 2020 2020 2020  EG_C):..        
+00003350: 2020 2020 2354 4543 2064 6f65 736e 2774      #TEC doesn't
+00003360: 2064 6f20 616e 7974 6869 6e67 2075 6e6c   do anything unl
+00003370: 6573 7320 796f 7520 6769 7665 2069 7420  ess you give it 
+00003380: 6120 7465 6d70 6572 6174 7572 6520 6669  a temperature fi
+00003390: 7273 740d 0a20 2020 2020 2020 2020 2020  rst..           
+000033a0: 206c 6f67 2e64 6562 7567 2866 2273 6574   log.debug(f"set
+000033b0: 7469 6e67 2054 4543 2073 6574 706f 696e  ting TEC setpoin
+000033c0: 7420 746f 207b 6465 6743 7d20 6465 6720  t to {degC} deg 
+000033d0: 4322 290d 0a20 2020 2020 2020 2020 2020  C")..           
+000033e0: 2073 656c 662e 6465 7465 6374 6f72 5f74   self.detector_t
+000033f0: 6563 5f73 6574 706f 696e 745f 6465 6743  ec_setpoint_degC
+00003400: 203d 2064 6567 430d 0a20 2020 2020 2020   = degC..       
+00003410: 2020 2020 2073 656c 662e 7365 745f 6465       self.set_de
+00003420: 7465 6374 6f72 5f74 6563 5f73 6574 706f  tector_tec_setpo
+00003430: 696e 745f 6465 6743 2873 656c 662e 6465  int_degC(self.de
+00003440: 7465 6374 6f72 5f74 6563 5f73 6574 706f  tector_tec_setpo
+00003450: 696e 745f 6465 6743 290d 0a0d 0a20 2020  int_degC)....   
+00003460: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
+00003470: 7567 2822 656e 6162 6c69 6e67 2064 6574  ug("enabling det
+00003480: 6563 746f 7220 5445 4322 290d 0a20 2020  ector TEC")..   
+00003490: 2020 2020 2020 2020 2073 656c 662e 6465           self.de
+000034a0: 7465 6374 6f72 5f74 6563 5f73 6574 706f  tector_tec_setpo
+000034b0: 696e 745f 6861 735f 6265 656e 5f73 6574  int_has_been_set
+000034c0: 203d 2054 7275 650d 0a20 2020 2020 2020   = True..       
+000034d0: 2020 2020 2073 656c 662e 7365 745f 7465       self.set_te
+000034e0: 635f 656e 6162 6c65 2854 7275 6529 0d0a  c_enable(True)..
+000034f0: 0d0a 2020 2020 2020 2020 2320 2323 2323  ..        # ####
 00003500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003510: 2323 2323 0a20 2020 2020 2020 2023 2046  ####.        # F
-00003520: 5047 410a 2020 2020 2020 2020 2320 2323  PGA.        # ##
+00003510: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003520: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00003530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003540: 2323 0d0a 2020 2020 2020 2020 2320 4650  ##..        # FP
+00003550: 4741 0d0a 2020 2020 2020 2020 2320 2323  GA..        # ##
 00003560: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003570: 2323 2323 0a0a 2020 2020 2020 2020 6c6f  ####..        lo
-00003580: 672e 6465 6275 6728 2272 6561 6469 6e67  g.debug("reading
-00003590: 2046 5047 4120 636f 6d70 696c 6174 696f   FPGA compilatio
-000035a0: 6e20 6f70 7469 6f6e 7322 290a 2020 2020  n options").    
-000035b0: 2020 2020 7365 6c66 2e5f 7265 6164 5f66      self._read_f
-000035c0: 7067 615f 636f 6d70 696c 6174 696f 6e5f  pga_compilation_
-000035d0: 6f70 7469 6f6e 7328 290a 0a20 2020 2020  options()..     
-000035e0: 2020 206c 6f67 2e64 6562 7567 2822 636f     log.debug("co
-000035f0: 6e66 6967 7572 696e 6720 4650 4741 2229  nfiguring FPGA")
-00003600: 0a0a 2020 2020 2020 2020 2320 6175 746f  ..        # auto
-00003610: 6d61 7469 6361 6c6c 7920 7075 7368 2045  matically push E
-00003620: 4550 524f 4d20 7661 6c75 6573 2074 6f20  EPROM values to 
-00003630: 7468 6520 4650 4741 2028 6f6e 206d 6f64  the FPGA (on mod
-00003640: 6572 6e20 4545 5052 4f4d 7329 0a20 2020  ern EEPROMs).   
-00003650: 2020 2020 2023 2028 7468 6973 2077 696c       # (this wil
-00003660: 6c20 776f 726b 206f 6e20 5365 7269 6573  l work on Series
-00003670: 2d58 5320 6173 2077 656c 6c2c 2065 7665  -XS as well, eve
-00003680: 6e20 6966 2077 6520 7375 6273 6571 7565  n if we subseque
-00003690: 6e74 6c79 2074 7261 636b 2069 7473 2067  ntly track its g
-000036a0: 6169 6e0a 2020 2020 2020 2020 2320 2073  ain.        #  s
-000036b0: 6f6d 6577 6861 7420 6469 6666 6572 656e  omewhat differen
-000036c0: 746c 7920 6173 2073 7461 7465 2e67 6169  tly as state.gai
-000036d0: 6e5f 6462 290a 2020 2020 2020 2020 6966  n_db).        if
-000036e0: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-000036f0: 6570 726f 6d2e 666f 726d 6174 203e 3d20  eprom.format >= 
-00003700: 343a 0a20 2020 2020 2020 2020 2020 206c  4:.            l
-00003710: 6f67 2e64 6562 7567 2822 7365 6e64 696e  og.debug("sendin
-00003720: 6720 6761 696e 2f6f 6666 7365 7420 746f  g gain/offset to
-00003730: 2046 5047 4122 290a 2020 2020 2020 2020   FPGA").        
-00003740: 2020 2020 7365 6c66 2e73 6574 5f64 6574      self.set_det
-00003750: 6563 746f 725f 6761 696e 2020 2020 2020  ector_gain      
-00003760: 2873 656c 662e 7365 7474 696e 6773 2e65  (self.settings.e
-00003770: 6570 726f 6d2e 6465 7465 6374 6f72 5f67  eprom.detector_g
-00003780: 6169 6e29 0a20 2020 2020 2020 2020 2020  ain).           
-00003790: 2073 656c 662e 7365 745f 6465 7465 6374   self.set_detect
-000037a0: 6f72 5f6f 6666 7365 7420 2020 2028 7365  or_offset    (se
-000037b0: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-000037c0: 6f6d 2e64 6574 6563 746f 725f 6f66 6673  om.detector_offs
-000037d0: 6574 290a 2020 2020 2020 2020 2020 2020  et).            
-000037e0: 7365 6c66 2e73 6574 5f64 6574 6563 746f  self.set_detecto
-000037f0: 725f 6761 696e 5f6f 6464 2020 2873 656c  r_gain_odd  (sel
-00003800: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-00003810: 6d2e 6465 7465 6374 6f72 5f67 6169 6e5f  m.detector_gain_
-00003820: 6f64 6429 0a20 2020 2020 2020 2020 2020  odd).           
-00003830: 2073 656c 662e 7365 745f 6465 7465 6374   self.set_detect
-00003840: 6f72 5f6f 6666 7365 745f 6f64 6428 7365  or_offset_odd(se
-00003850: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-00003860: 6f6d 2e64 6574 6563 746f 725f 6f66 6673  om.detector_offs
-00003870: 6574 5f6f 6464 290a 0a20 2020 2020 2020  et_odd)..       
-00003880: 2023 2069 6e69 7469 616c 697a 6520 7374   # initialize st
-00003890: 6174 652e 6761 696e 5f64 6220 6672 6f6d  ate.gain_db from
-000038a0: 2045 4550 524f 4d20 7374 6172 7475 7020   EEPROM startup 
-000038b0: 7661 6c75 650a 2020 2020 2020 2020 7365  value.        se
-000038c0: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
-000038d0: 652e 6761 696e 5f64 6220 3d20 7365 6c66  e.gain_db = self
-000038e0: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
-000038f0: 2e64 6574 6563 746f 725f 6761 696e 0a0a  .detector_gain..
-00003900: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00003910: 7365 7474 696e 6773 2e69 735f 6d69 6372  settings.is_micr
-00003920: 6f28 293a 0a20 2020 2020 2020 2020 2020  o():.           
-00003930: 2072 6f69 203d 2073 656c 662e 7365 7474   roi = self.sett
-00003940: 696e 6773 2e67 6574 5f76 6572 7469 6361  ings.get_vertica
-00003950: 6c5f 726f 6928 290a 2020 2020 2020 2020  l_roi().        
-00003960: 2020 2020 6966 2072 6f69 2069 7320 6e6f      if roi is no
-00003970: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00003980: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-00003990: 5f76 6572 7469 6361 6c5f 6269 6e6e 696e  _vertical_binnin
-000039a0: 6728 726f 6929 0a0a 2020 2020 2020 2020  g(roi)..        
-000039b0: 7365 6c66 2e73 6574 7469 6e67 732e 696e  self.settings.in
-000039c0: 6974 5f72 6567 696f 6e73 2829 2020 2020  it_regions()    
-000039d0: 2020 2020 0a0a 2020 2020 2020 2020 2320      ..        # 
-000039e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000039f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a20: 2323 2323 2323 0a20 2020 2020 2020 2023  ######.        #
-00003a30: 2070 6f73 742d 636f 6e6e 6563 7469 6f6e   post-connection
-00003a40: 2064 6566 6175 6c74 730a 2020 2020 2020   defaults.      
-00003a50: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
+00003570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003590: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000035a0: 2323 2323 0d0a 0d0a 2020 2020 2020 2020  ####....        
+000035b0: 6c6f 672e 6465 6275 6728 2272 6561 6469  log.debug("readi
+000035c0: 6e67 2046 5047 4120 636f 6d70 696c 6174  ng FPGA compilat
+000035d0: 696f 6e20 6f70 7469 6f6e 7322 290d 0a20  ion options").. 
+000035e0: 2020 2020 2020 2073 656c 662e 5f72 6561         self._rea
+000035f0: 645f 6670 6761 5f63 6f6d 7069 6c61 7469  d_fpga_compilati
+00003600: 6f6e 5f6f 7074 696f 6e73 2829 0d0a 0d0a  on_options()....
+00003610: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
+00003620: 6728 2263 6f6e 6669 6775 7269 6e67 2046  g("configuring F
+00003630: 5047 4122 290d 0a0d 0a20 2020 2020 2020  PGA")....       
+00003640: 2023 2061 7574 6f6d 6174 6963 616c 6c79   # automatically
+00003650: 2070 7573 6820 4545 5052 4f4d 2076 616c   push EEPROM val
+00003660: 7565 7320 746f 2074 6865 2046 5047 4120  ues to the FPGA 
+00003670: 286f 6e20 6d6f 6465 726e 2045 4550 524f  (on modern EEPRO
+00003680: 4d73 290d 0a20 2020 2020 2020 2023 2028  Ms)..        # (
+00003690: 7468 6973 2077 696c 6c20 776f 726b 206f  this will work o
+000036a0: 6e20 5365 7269 6573 2d58 5320 6173 2077  n Series-XS as w
+000036b0: 656c 6c2c 2065 7665 6e20 6966 2077 6520  ell, even if we 
+000036c0: 7375 6273 6571 7565 6e74 6c79 2074 7261  subsequently tra
+000036d0: 636b 2069 7473 2067 6169 6e0d 0a20 2020  ck its gain..   
+000036e0: 2020 2020 2023 2020 736f 6d65 7768 6174       #  somewhat
+000036f0: 2064 6966 6665 7265 6e74 6c79 2061 7320   differently as 
+00003700: 7374 6174 652e 6761 696e 5f64 6229 0d0a  state.gain_db)..
+00003710: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00003720: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+00003730: 666f 726d 6174 203e 3d20 343a 0d0a 2020  format >= 4:..  
+00003740: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+00003750: 6275 6728 2273 656e 6469 6e67 2067 6169  bug("sending gai
+00003760: 6e2f 6f66 6673 6574 2074 6f20 4650 4741  n/offset to FPGA
+00003770: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+00003780: 7365 6c66 2e73 6574 5f64 6574 6563 746f  self.set_detecto
+00003790: 725f 6761 696e 2020 2020 2020 2873 656c  r_gain      (sel
+000037a0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+000037b0: 6d2e 6465 7465 6374 6f72 5f67 6169 6e29  m.detector_gain)
+000037c0: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+000037d0: 6c66 2e73 6574 5f64 6574 6563 746f 725f  lf.set_detector_
+000037e0: 6f66 6673 6574 2020 2020 2873 656c 662e  offset    (self.
+000037f0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+00003800: 6465 7465 6374 6f72 5f6f 6666 7365 7429  detector_offset)
+00003810: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00003820: 6c66 2e73 6574 5f64 6574 6563 746f 725f  lf.set_detector_
+00003830: 6761 696e 5f6f 6464 2020 2873 656c 662e  gain_odd  (self.
+00003840: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+00003850: 6465 7465 6374 6f72 5f67 6169 6e5f 6f64  detector_gain_od
+00003860: 6429 0d0a 2020 2020 2020 2020 2020 2020  d)..            
+00003870: 7365 6c66 2e73 6574 5f64 6574 6563 746f  self.set_detecto
+00003880: 725f 6f66 6673 6574 5f6f 6464 2873 656c  r_offset_odd(sel
+00003890: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+000038a0: 6d2e 6465 7465 6374 6f72 5f6f 6666 7365  m.detector_offse
+000038b0: 745f 6f64 6429 0d0a 0d0a 2020 2020 2020  t_odd)....      
+000038c0: 2020 2320 696e 6974 6961 6c69 7a65 2073    # initialize s
+000038d0: 7461 7465 2e67 6169 6e5f 6462 2066 726f  tate.gain_db fro
+000038e0: 6d20 4545 5052 4f4d 2073 7461 7274 7570  m EEPROM startup
+000038f0: 2076 616c 7565 0d0a 2020 2020 2020 2020   value..        
+00003900: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
+00003910: 6174 652e 6761 696e 5f64 6220 3d20 7365  ate.gain_db = se
+00003920: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+00003930: 6f6d 2e64 6574 6563 746f 725f 6761 696e  om.detector_gain
+00003940: 0d0a 0d0a 2020 2020 2020 2020 6966 2073  ....        if s
+00003950: 656c 662e 7365 7474 696e 6773 2e69 735f  elf.settings.is_
+00003960: 6d69 6372 6f28 293a 0d0a 2020 2020 2020  micro():..      
+00003970: 2020 2020 2020 726f 6920 3d20 7365 6c66        roi = self
+00003980: 2e73 6574 7469 6e67 732e 6765 745f 7665  .settings.get_ve
+00003990: 7274 6963 616c 5f72 6f69 2829 0d0a 2020  rtical_roi()..  
+000039a0: 2020 2020 2020 2020 2020 6966 2072 6f69            if roi
+000039b0: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
+000039c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000039d0: 656c 662e 7365 745f 7665 7274 6963 616c  elf.set_vertical
+000039e0: 5f62 696e 6e69 6e67 2872 6f69 290d 0a0d  _binning(roi)...
+000039f0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00003a00: 7474 696e 6773 2e69 6e69 745f 7265 6769  ttings.init_regi
+00003a10: 6f6e 7328 2920 2020 2020 2020 200d 0a0d  ons()        ...
+00003a20: 0a20 2020 2020 2020 2023 2023 2323 2323  .        # #####
+00003a30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00003a60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a90: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-00003aa0: 2020 2020 2320 6465 6661 756c 7420 746f      # default to
-00003ab0: 2069 6e74 6572 6e61 6c20 7472 6967 6765   internal trigge
-00003ac0: 7269 6e67 0a20 2020 2020 2020 2073 656c  ring.        sel
-00003ad0: 662e 7365 745f 7472 6967 6765 725f 736f  f.set_trigger_so
-00003ae0: 7572 6365 2853 7065 6374 726f 6d65 7465  urce(Spectromete
-00003af0: 7253 7461 7465 2e54 5249 4747 4552 5f53  rState.TRIGGER_S
-00003b00: 4f55 5243 455f 494e 5445 524e 414c 290a  OURCE_INTERNAL).
-00003b10: 0a20 2020 2020 2020 2023 2070 726f 6261  .        # proba
-00003b20: 626c 7920 7468 6520 6465 6661 756c 742c  bly the default,
-00003b30: 2062 7574 206a 7573 7420 746f 2062 6520   but just to be 
-00003b40: 7375 7265 0a20 2020 2020 2020 2069 6620  sure.        if 
-00003b50: 7365 6c66 2e73 6574 7469 6e67 732e 6973  self.settings.is
-00003b60: 5f6d 6963 726f 2829 3a0a 0a20 2020 2020  _micro():..     
-00003b70: 2020 2020 2020 2023 2073 6f6d 6520 6b69         # some ki
-00003b80: 6e64 206f 6620 5365 7269 6573 2d58 530a  nd of Series-XS.
-00003b90: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00003ba0: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
-00003bb0: 726f 6d2e 6861 735f 6c61 7365 723a 0a20  rom.has_laser:. 
-00003bc0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00003bd0: 6f67 2e64 6562 7567 2822 6170 706c 7969  og.debug("applyi
-00003be0: 6e67 2053 6572 6965 732d 5853 2073 6574  ng Series-XS set
-00003bf0: 7469 6e67 7322 290a 2020 2020 2020 2020  tings").        
-00003c00: 2020 2020 2020 2020 7365 6320 3d20 7365          sec = se
-00003c10: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-00003c20: 6f6d 2e6c 6173 6572 5f77 6174 6368 646f  om.laser_watchdo
-00003c30: 675f 7365 630a 2020 2020 2020 2020 2020  g_sec.          
-00003c40: 2020 2020 2020 6966 2073 6563 203c 3d20        if sec <= 
-00003c50: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00003c60: 2020 2020 2020 2073 6563 203d 2045 4550         sec = EEP
-00003c70: 524f 4d2e 4445 4641 554c 545f 4c41 5345  ROM.DEFAULT_LASE
-00003c80: 525f 5741 5443 4844 4f47 5f53 4543 0a20  R_WATCHDOG_SEC. 
-00003c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ca0: 2020 206c 6f67 2e64 6562 7567 2866 2264     log.debug(f"d
-00003cb0: 6563 6c69 6e69 6e67 2074 6f20 6469 7361  eclining to disa
-00003cc0: 626c 6520 6c61 7365 7220 7761 7463 6864  ble laser watchd
-00003cd0: 6f67 2061 7420 636f 6e6e 6563 7469 6f6e  og at connection
-00003ce0: 2c20 6465 6661 756c 7469 6e67 2074 6f20  , defaulting to 
-00003cf0: 7b73 6563 7d73 6563 2229 0a20 2020 2020  {sec}sec").     
-00003d00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00003d10: 7365 745f 6c61 7365 725f 7761 7463 6864  set_laser_watchd
-00003d20: 6f67 5f73 6563 2873 6563 290a 2020 2020  og_sec(sec).    
-00003d30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00003d40: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00003d50: 672e 6465 6275 6728 2273 6b69 7070 696e  g.debug("skippin
-00003d60: 6720 6c61 7365 7220 6665 6174 7572 6573  g laser features
-00003d70: 2066 6f72 206e 6f6e 2d52 616d 616e 2053   for non-Raman S
-00003d80: 6572 6965 732d 5853 2229 0a0a 2020 2020  eries-XS")..    
-00003d90: 2020 2020 7365 6c66 2e73 6574 5f69 6e74      self.set_int
-00003da0: 6567 7261 7469 6f6e 5f74 696d 655f 6d73  egration_time_ms
-00003db0: 2873 656c 662e 7365 7474 696e 6773 2e65  (self.settings.e
-00003dc0: 6570 726f 6d2e 7374 6172 7475 705f 696e  eprom.startup_in
-00003dd0: 7465 6772 6174 696f 6e5f 7469 6d65 5f6d  tegration_time_m
-00003de0: 7329 0a0a 2020 2020 2020 2020 2320 666f  s)..        # fo
-00003df0: 7220 6e6f 772c 2065 6e61 626c 6520 4765  r now, enable Ge
-00003e00: 6e20 312e 3520 6163 6365 7373 6f72 7920  n 1.5 accessory 
-00003e10: 636f 6e6e 6563 746f 7220 6279 2064 6566  connector by def
-00003e20: 6175 6c74 0a20 2020 2020 2020 2069 6620  ault.        if 
-00003e30: 7365 6c66 2e73 6574 7469 6e67 732e 6973  self.settings.is
-00003e40: 5f67 656e 3135 2829 3a0a 2020 2020 2020  _gen15():.      
-00003e50: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-00003e60: 2265 6e61 626c 696e 6720 4765 6e20 312e  "enabling Gen 1.
-00003e70: 3520 6163 6365 7373 6f72 7920 636f 6e6e  5 accessory conn
-00003e80: 6563 746f 7222 290a 2020 2020 2020 2020  ector").        
-00003e90: 2020 2020 7365 6c66 2e73 6574 5f61 6363      self.set_acc
-00003ea0: 6573 736f 7279 5f65 6e61 626c 6528 5472  essory_enable(Tr
-00003eb0: 7565 290a 0a20 2020 2020 2020 2023 2023  ue)..        # #
-00003ec0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003ed0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003ee0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003ef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003f00: 2323 2323 230a 2020 2020 2020 2020 2320  #####.        # 
-00003f10: 446f 6e65 0a20 2020 2020 2020 2023 2023  Done.        # #
-00003f20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a70: 230d 0a20 2020 2020 2020 2023 2070 6f73  #..        # pos
+00003a80: 742d 636f 6e6e 6563 7469 6f6e 2064 6566  t-connection def
+00003a90: 6175 6c74 730d 0a20 2020 2020 2020 2023  aults..        #
+00003aa0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00003ab0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003ac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003ad0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003ae0: 2323 2323 2323 230d 0a0d 0a20 2020 2020  #######....     
+00003af0: 2020 2023 2064 6566 6175 6c74 2074 6f20     # default to 
+00003b00: 696e 7465 726e 616c 2074 7269 6767 6572  internal trigger
+00003b10: 696e 670d 0a20 2020 2020 2020 2073 656c  ing..        sel
+00003b20: 662e 7365 745f 7472 6967 6765 725f 736f  f.set_trigger_so
+00003b30: 7572 6365 2853 7065 6374 726f 6d65 7465  urce(Spectromete
+00003b40: 7253 7461 7465 2e54 5249 4747 4552 5f53  rState.TRIGGER_S
+00003b50: 4f55 5243 455f 494e 5445 524e 414c 290d  OURCE_INTERNAL).
+00003b60: 0a0d 0a20 2020 2020 2020 2023 2070 726f  ...        # pro
+00003b70: 6261 626c 7920 7468 6520 6465 6661 756c  bably the defaul
+00003b80: 742c 2062 7574 206a 7573 7420 746f 2062  t, but just to b
+00003b90: 6520 7375 7265 0d0a 2020 2020 2020 2020  e sure..        
+00003ba0: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+00003bb0: 2e69 735f 6d69 6372 6f28 293a 0d0a 0d0a  .is_micro():....
+00003bc0: 2020 2020 2020 2020 2020 2020 2320 736f              # so
+00003bd0: 6d65 206b 696e 6420 6f66 2053 6572 6965  me kind of Serie
+00003be0: 732d 5853 0d0a 2020 2020 2020 2020 2020  s-XS..          
+00003bf0: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
+00003c00: 6773 2e65 6570 726f 6d2e 6861 735f 6c61  gs.eeprom.has_la
+00003c10: 7365 723a 0d0a 2020 2020 2020 2020 2020  ser:..          
+00003c20: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+00003c30: 2261 7070 6c79 696e 6720 5365 7269 6573  "applying Series
+00003c40: 2d58 5320 7365 7474 696e 6773 2229 0d0a  -XS settings")..
+00003c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c60: 7365 6320 3d20 7365 6c66 2e73 6574 7469  sec = self.setti
+00003c70: 6e67 732e 6565 7072 6f6d 2e6c 6173 6572  ngs.eeprom.laser
+00003c80: 5f77 6174 6368 646f 675f 7365 630d 0a20  _watchdog_sec.. 
+00003c90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00003ca0: 6620 7365 6320 3c3d 2030 3a0d 0a20 2020  f sec <= 0:..   
+00003cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003cc0: 2073 6563 203d 2045 4550 524f 4d2e 4445   sec = EEPROM.DE
+00003cd0: 4641 554c 545f 4c41 5345 525f 5741 5443  FAULT_LASER_WATC
+00003ce0: 4844 4f47 5f53 4543 0d0a 2020 2020 2020  HDOG_SEC..      
+00003cf0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00003d00: 672e 6465 6275 6728 6622 6465 636c 696e  g.debug(f"declin
+00003d10: 696e 6720 746f 2064 6973 6162 6c65 206c  ing to disable l
+00003d20: 6173 6572 2077 6174 6368 646f 6720 6174  aser watchdog at
+00003d30: 2063 6f6e 6e65 6374 696f 6e2c 2064 6566   connection, def
+00003d40: 6175 6c74 696e 6720 746f 207b 7365 637d  aulting to {sec}
+00003d50: 7365 6322 290d 0a20 2020 2020 2020 2020  sec")..         
+00003d60: 2020 2020 2020 2073 656c 662e 7365 745f         self.set_
+00003d70: 6c61 7365 725f 7761 7463 6864 6f67 5f73  laser_watchdog_s
+00003d80: 6563 2873 6563 290d 0a20 2020 2020 2020  ec(sec)..       
+00003d90: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00003da0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+00003db0: 6465 6275 6728 2273 6b69 7070 696e 6720  debug("skipping 
+00003dc0: 6c61 7365 7220 6665 6174 7572 6573 2066  laser features f
+00003dd0: 6f72 206e 6f6e 2d52 616d 616e 2053 6572  or non-Raman Ser
+00003de0: 6965 732d 5853 2229 0d0a 0d0a 2020 2020  ies-XS")....    
+00003df0: 2020 2020 7365 6c66 2e73 6574 5f69 6e74      self.set_int
+00003e00: 6567 7261 7469 6f6e 5f74 696d 655f 6d73  egration_time_ms
+00003e10: 2873 656c 662e 7365 7474 696e 6773 2e65  (self.settings.e
+00003e20: 6570 726f 6d2e 7374 6172 7475 705f 696e  eprom.startup_in
+00003e30: 7465 6772 6174 696f 6e5f 7469 6d65 5f6d  tegration_time_m
+00003e40: 7329 0d0a 0d0a 2020 2020 2020 2020 2320  s)....        # 
+00003e50: 666f 7220 6e6f 772c 2065 6e61 626c 6520  for now, enable 
+00003e60: 4765 6e20 312e 3520 6163 6365 7373 6f72  Gen 1.5 accessor
+00003e70: 7920 636f 6e6e 6563 746f 7220 6279 2064  y connector by d
+00003e80: 6566 6175 6c74 0d0a 2020 2020 2020 2020  efault..        
+00003e90: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+00003ea0: 2e69 735f 6765 6e31 3528 293a 0d0a 2020  .is_gen15():..  
+00003eb0: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+00003ec0: 6275 6728 2265 6e61 626c 696e 6720 4765  bug("enabling Ge
+00003ed0: 6e20 312e 3520 6163 6365 7373 6f72 7920  n 1.5 accessory 
+00003ee0: 636f 6e6e 6563 746f 7222 290d 0a20 2020  connector")..   
+00003ef0: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
+00003f00: 745f 6163 6365 7373 6f72 795f 656e 6162  t_accessory_enab
+00003f10: 6c65 2854 7275 6529 0d0a 0d0a 2020 2020  le(True)....    
+00003f20: 2020 2020 2320 2323 2323 2323 2323 2323      # ##########
 00003f30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00003f40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00003f50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003f60: 2323 2323 230a 0a20 2020 2020 2020 206c  #####..        l
-00003f70: 6f67 2e64 6562 7567 2822 636f 6e6e 6563  og.debug("connec
-00003f80: 7469 6f6e 2073 7563 6365 7373 6675 6c22  tion successful"
-00003f90: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-00003fa0: 6f6e 6e65 6374 6564 203d 2054 7275 650a  onnected = True.
-00003fb0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00003fc0: 6e65 6374 696e 6720 3d20 4661 6c73 650a  necting = False.
-00003fd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00003fe0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00003ff0: 6f6e 7365 2873 656c 662e 636f 6e6e 6563  onse(self.connec
-00004000: 7465 6429 0a0a 2020 2020 6465 6620 6469  ted)..    def di
-00004010: 7363 6f6e 6e65 6374 2873 656c 6629 202d  sconnect(self) -
-00004020: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
-00004030: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
-00004040: 6966 2073 656c 662e 6c61 7374 5f61 7070  if self.last_app
-00004050: 6c69 6564 5f6c 6173 6572 5f70 6f77 6572  lied_laser_power
-00004060: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00004070: 672e 6465 6275 6728 2266 6964 2e64 6973  g.debug("fid.dis
-00004080: 636f 6e6e 6563 743a 2064 6973 6162 6c69  connect: disabli
-00004090: 6e67 206c 6173 6572 2229 0a20 2020 2020  ng laser").     
-000040a0: 2020 2020 2020 2073 656c 662e 5f73 6574         self._set
-000040b0: 5f6c 6173 6572 5f65 6e61 626c 655f 696d  _laser_enable_im
-000040c0: 6d65 6469 6174 6528 4661 6c73 6529 0a0a  mediate(False)..
-000040d0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-000040e0: 6e65 6374 6564 203d 2046 616c 7365 0a0a  nected = False..
-000040f0: 2020 2020 2020 2020 6c6f 672e 6372 6974          log.crit
-00004100: 6963 616c 2822 6669 642e 6469 7363 6f6e  ical("fid.discon
-00004110: 6e65 6374 3a20 7265 6c65 6173 696e 6720  nect: releasing 
-00004120: 696e 7465 7266 6163 6522 290a 2020 2020  interface").    
-00004130: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00004140: 2020 2020 2023 7265 7375 6c74 203d 2073       #result = s
-00004150: 656c 662e 6465 7669 6365 5f74 7970 652e  elf.device_type.
-00004160: 7265 6c65 6173 655f 696e 7465 7266 6163  release_interfac
-00004170: 6528 7365 6c66 2e64 6576 6963 652c 2030  e(self.device, 0
-00004180: 290a 2020 2020 2020 2020 2020 2020 7472  ).            tr
-00004190: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-000041a0: 2020 2073 656c 662e 6465 7669 6365 5f74     self.device_t
-000041b0: 7970 652e 7265 7365 7428 7365 6c66 2e64  ype.reset(self.d
-000041c0: 6576 6963 6529 0a20 2020 2020 2020 2020  evice).         
-000041d0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-000041e0: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
-000041f0: 7272 6f72 2822 436f 756c 646e 2774 2072  rror("Couldn't r
-00004200: 6573 6574 2064 6576 6963 6522 290a 2020  eset device").  
-00004210: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00004220: 6570 7469 6f6e 2061 7320 6578 633a 0a20  eption as exc:. 
-00004230: 2020 2020 2020 2020 2020 206c 6f67 2e77             log.w
-00004240: 6172 6e28 2246 6169 6c75 7265 2069 6e20  arn("Failure in 
-00004250: 7265 6c65 6173 6520 696e 7465 7266 6163  release interfac
-00004260: 6522 2c20 6578 635f 696e 666f 3d31 290a  e", exc_info=1).
-00004270: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00004280: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-00004290: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-000042a0: 706f 6e73 6528 5472 7565 290a 0a20 2020  ponse(True)..   
-000042b0: 2064 6566 205f 7363 6865 6475 6c65 5f64   def _schedule_d
-000042c0: 6973 636f 6e6e 6563 7428 7365 6c66 2c20  isconnect(self, 
-000042d0: 6578 6329 202d 3e20 4e6f 6e65 3a0a 2020  exc) -> None:.  
-000042e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000042f0: 2020 536f 6d65 7468 696e 6720 696e 2074    Something in t
-00004300: 6865 2064 7269 7665 7220 6861 7320 6361  he driver has ca
-00004310: 7573 6564 2069 7420 746f 2072 6571 7565  used it to reque
-00004320: 7374 2074 6865 2063 6f6e 7472 6f6c 6c69  st the controlli
-00004330: 6e67 0a20 2020 2020 2020 2061 7070 6c69  ng.        appli
-00004340: 6361 7469 6f6e 2074 6f20 636c 6f73 6520  cation to close 
-00004350: 7468 6520 7065 7269 7068 6572 616c 2e20  the peripheral. 
-00004360: 2054 6865 206e 6578 7420 7469 6d65 0a20   The next time. 
-00004370: 2020 2020 2020 2057 6173 6174 6368 4465         WasatchDe
-00004380: 7669 6365 2e61 6371 7569 7265 5f64 6174  vice.acquire_dat
-00004390: 6120 6973 2063 616c 6c65 642c 2069 7420  a is called, it 
-000043a0: 7769 6c6c 2070 6173 7320 6120 2270 6f69  will pass a "poi
-000043b0: 736f 6e20 7069 6c6c 2220 6261 636b 0a20  son pill" back. 
-000043c0: 2020 2020 2020 2075 7020 7468 6520 7265         up the re
-000043d0: 7370 6f6e 7365 2071 7565 7565 2e0a 2020  sponse queue..  
-000043e0: 2020 2020 2020 416c 7465 726e 6174 656c        Alternatel
-000043f0: 792c 206e 6f6e 2d45 4e4c 4947 4854 454e  y, non-ENLIGHTEN
-00004400: 2063 616c 6c65 7273 2063 616e 2073 6574   callers can set
-00004410: 2022 7261 6973 655f 6578 6365 7074 696f   "raise_exceptio
-00004420: 6e73 2220 2d3e 2054 7275 6520 666f 720a  ns" -> True for.
-00004430: 2020 2020 2020 2020 696e 2d70 726f 6365          in-proce
-00004440: 7373 2065 7863 6570 7469 6f6e 2d68 616e  ss exception-han
-00004450: 646c 696e 672e 0a20 2020 2020 2020 2022  dling..        "
-00004460: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
-00004470: 6c66 2e72 6169 7365 5f65 7863 6570 7469  lf.raise_excepti
-00004480: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-00004490: 206c 6f67 2e63 7269 7469 6361 6c28 225f   log.critical("_
-000044a0: 7363 6865 6475 6c65 5f64 6973 636f 6e6e  schedule_disconn
-000044b0: 6563 743a 2072 6169 7369 6e67 2065 7863  ect: raising exc
-000044c0: 6570 7469 6f6e 2025 7322 2c20 6578 6329  eption %s", exc)
-000044d0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000044e0: 7365 2065 7863 0a20 2020 2020 2020 2065  se exc.        e
-000044f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00004500: 206c 6f67 2e63 7269 7469 6361 6c28 2272   log.critical("r
-00004510: 6571 7565 7374 696e 6720 7368 7574 646f  equesting shutdo
-00004520: 776e 2064 7565 2074 6f20 6578 6365 7074  wn due to except
-00004530: 696f 6e20 2573 222c 2065 7863 290a 2020  ion %s", exc).  
-00004540: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00004550: 6875 7464 6f77 6e5f 7265 7175 6573 7465  hutdown_requeste
-00004560: 6420 3d20 5472 7565 0a0a 2020 2020 6465  d = True..    de
-00004570: 6620 7265 7365 7428 7365 6c66 2c20 2a61  f reset(self, *a
-00004580: 7267 7329 202d 3e20 4e6f 6e65 3a0a 2020  rgs) -> None:.  
-00004590: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-000045a0: 2246 4944 2070 6572 666f 726d 696e 6720  "FID performing 
-000045b0: 6465 7669 6365 2072 6573 6574 2229 0a20  device reset"). 
-000045c0: 2020 2020 2020 2023 7365 6c66 2e64 6576         #self.dev
-000045d0: 6963 655f 7479 7065 2e72 656c 6561 7365  ice_type.release
-000045e0: 5f69 6e74 6572 6661 6365 2873 656c 662e  _interface(self.
-000045f0: 6465 7669 6365 2c20 3029 0a20 2020 2020  device, 0).     
-00004600: 2020 2073 656c 662e 6465 7669 6365 5f74     self.device_t
-00004610: 7970 652e 7265 7365 7428 7365 6c66 2e64  ype.reset(self.d
-00004620: 6576 6963 6529 0a20 2020 2020 2020 206c  evice).        l
-00004630: 6f67 2e64 6562 7567 2866 2266 7265 6564  og.debug(f"freed
-00004640: 2069 6e74 6572 6661 6365 2229 0a20 2020   interface").   
-00004650: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-00004660: 2070 7975 7362 5f64 6576 6963 6573 203d   pyusb_devices =
-00004670: 206c 6973 7428 7365 6c66 2e64 6576 6963   list(self.devic
-00004680: 655f 7479 7065 2e66 696e 6428 6669 6e64  e_type.find(find
-00004690: 5f61 6c6c 3d54 7275 652c 200a 2020 2020  _all=True, .    
-000046a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046c0: 2020 2020 2020 2020 2020 6964 5665 6e64            idVend
-000046d0: 6f72 3d73 656c 662e 6465 7669 6365 5f69  or=self.device_i
-000046e0: 642e 7669 642c 200a 2020 2020 2020 2020  d.vid, .        
-000046f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004710: 2020 2020 2020 6964 5072 6f64 7563 743d        idProduct=
-00004720: 7365 6c66 2e64 6576 6963 655f 6964 2e70  self.device_id.p
-00004730: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00003f60: 2323 2323 2323 2323 2323 2323 0d0a 2020  ############..  
+00003f70: 2020 2020 2020 2320 446f 6e65 0d0a 2020        # Done..  
+00003f80: 2020 2020 2020 2320 2323 2323 2323 2323        # ########
+00003f90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003fa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003fb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003fc0: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+00003fd0: 0d0a 2020 2020 2020 2020 6c6f 672e 6465  ..        log.de
+00003fe0: 6275 6728 2263 6f6e 6e65 6374 696f 6e20  bug("connection 
+00003ff0: 7375 6363 6573 7366 756c 2229 0d0a 2020  successful")..  
+00004000: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00004010: 6374 6564 203d 2054 7275 650d 0a20 2020  cted = True..   
+00004020: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00004030: 7469 6e67 203d 2046 616c 7365 0d0a 0d0a  ting = False....
+00004040: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00004050: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00004060: 6e73 6528 7365 6c66 2e63 6f6e 6e65 6374  nse(self.connect
+00004070: 6564 290d 0a0d 0a20 2020 2064 6566 2064  ed)....    def d
+00004080: 6973 636f 6e6e 6563 7428 7365 6c66 293a  isconnect(self):
+00004090: 2023 202d 3e20 5370 6563 7472 6f6d 6574   # -> Spectromet
+000040a0: 6572 5265 7370 6f6e 7365 200d 0a20 2020  erResponse ..   
+000040b0: 2020 2020 2069 6620 7365 6c66 2e6c 6173       if self.las
+000040c0: 745f 6170 706c 6965 645f 6c61 7365 725f  t_applied_laser_
+000040d0: 706f 7765 723a 0d0a 2020 2020 2020 2020  power:..        
+000040e0: 2020 2020 6c6f 672e 6465 6275 6728 2266      log.debug("f
+000040f0: 6964 2e64 6973 636f 6e6e 6563 743a 2064  id.disconnect: d
+00004100: 6973 6162 6c69 6e67 206c 6173 6572 2229  isabling laser")
+00004110: 0d0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00004120: 6c66 2e5f 7365 745f 6c61 7365 725f 656e  lf._set_laser_en
+00004130: 6162 6c65 5f69 6d6d 6564 6961 7465 2846  able_immediate(F
+00004140: 616c 7365 290d 0a0d 0a20 2020 2020 2020  alse)....       
+00004150: 2073 656c 662e 636f 6e6e 6563 7465 6420   self.connected 
+00004160: 3d20 4661 6c73 650d 0a0d 0a20 2020 2020  = False....     
+00004170: 2020 206c 6f67 2e63 7269 7469 6361 6c28     log.critical(
+00004180: 2266 6964 2e64 6973 636f 6e6e 6563 743a  "fid.disconnect:
+00004190: 2072 656c 6561 7369 6e67 2069 6e74 6572   releasing inter
+000041a0: 6661 6365 2229 0d0a 2020 2020 2020 2020  face")..        
+000041b0: 7472 793a 0d0a 2020 2020 2020 2020 2020  try:..          
+000041c0: 2020 2372 6573 756c 7420 3d20 7365 6c66    #result = self
+000041d0: 2e64 6576 6963 655f 7479 7065 2e72 656c  .device_type.rel
+000041e0: 6561 7365 5f69 6e74 6572 6661 6365 2873  ease_interface(s
+000041f0: 656c 662e 6465 7669 6365 2c20 3029 0d0a  elf.device, 0)..
+00004200: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00004210: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00004220: 2020 7365 6c66 2e64 6576 6963 655f 7479    self.device_ty
+00004230: 7065 2e72 6573 6574 2873 656c 662e 6465  pe.reset(self.de
+00004240: 7669 6365 290d 0a20 2020 2020 2020 2020  vice)..         
+00004250: 2020 2065 7863 6570 743a 0d0a 2020 2020     except:..    
+00004260: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+00004270: 6572 726f 7228 2243 6f75 6c64 6e27 7420  error("Couldn't 
+00004280: 7265 7365 7420 6465 7669 6365 2229 0d0a  reset device")..
+00004290: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+000042a0: 7863 6570 7469 6f6e 2061 7320 6578 633a  xception as exc:
+000042b0: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+000042c0: 672e 7761 726e 2822 4661 696c 7572 6520  g.warn("Failure 
+000042d0: 696e 2072 656c 6561 7365 2069 6e74 6572  in release inter
+000042e0: 6661 6365 222c 2065 7863 5f69 6e66 6f3d  face", exc_info=
+000042f0: 3129 0d0a 2020 2020 2020 2020 2020 2020  1)..            
+00004300: 7261 6973 650d 0a20 2020 2020 2020 2072  raise..        r
+00004310: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+00004320: 6572 5265 7370 6f6e 7365 2854 7275 6529  erResponse(True)
+00004330: 0d0a 0d0a 2020 2020 6465 6620 5f73 6368  ....    def _sch
+00004340: 6564 756c 655f 6469 7363 6f6e 6e65 6374  edule_disconnect
+00004350: 2873 656c 662c 2065 7863 293a 2023 202d  (self, exc): # -
+00004360: 3e20 4e6f 6e65 200d 0a20 2020 2020 2020  > None ..       
+00004370: 2022 2222 0d0a 2020 2020 2020 2020 536f   """..        So
+00004380: 6d65 7468 696e 6720 696e 2074 6865 2064  mething in the d
+00004390: 7269 7665 7220 6861 7320 6361 7573 6564  river has caused
+000043a0: 2069 7420 746f 2072 6571 7565 7374 2074   it to request t
+000043b0: 6865 2063 6f6e 7472 6f6c 6c69 6e67 0d0a  he controlling..
+000043c0: 2020 2020 2020 2020 6170 706c 6963 6174          applicat
+000043d0: 696f 6e20 746f 2063 6c6f 7365 2074 6865  ion to close the
+000043e0: 2070 6572 6970 6865 7261 6c2e 2020 5468   peripheral.  Th
+000043f0: 6520 6e65 7874 2074 696d 650d 0a20 2020  e next time..   
+00004400: 2020 2020 2057 6173 6174 6368 4465 7669       WasatchDevi
+00004410: 6365 2e61 6371 7569 7265 5f64 6174 6120  ce.acquire_data 
+00004420: 6973 2063 616c 6c65 642c 2069 7420 7769  is called, it wi
+00004430: 6c6c 2070 6173 7320 6120 2270 6f69 736f  ll pass a "poiso
+00004440: 6e20 7069 6c6c 2220 6261 636b 0d0a 2020  n pill" back..  
+00004450: 2020 2020 2020 7570 2074 6865 2072 6573        up the res
+00004460: 706f 6e73 6520 7175 6575 652e 0d0a 2020  ponse queue...  
+00004470: 2020 2020 2020 416c 7465 726e 6174 656c        Alternatel
+00004480: 792c 206e 6f6e 2d45 4e4c 4947 4854 454e  y, non-ENLIGHTEN
+00004490: 2063 616c 6c65 7273 2063 616e 2073 6574   callers can set
+000044a0: 2022 7261 6973 655f 6578 6365 7074 696f   "raise_exceptio
+000044b0: 6e73 2220 2d3e 2054 7275 6520 666f 720d  ns" -> True for.
+000044c0: 0a20 2020 2020 2020 2069 6e2d 7072 6f63  .        in-proc
+000044d0: 6573 7320 6578 6365 7074 696f 6e2d 6861  ess exception-ha
+000044e0: 6e64 6c69 6e67 2e0d 0a20 2020 2020 2020  ndling...       
+000044f0: 2022 2222 0d0a 2020 2020 2020 2020 6966   """..        if
+00004500: 2073 656c 662e 7261 6973 655f 6578 6365   self.raise_exce
+00004510: 7074 696f 6e73 3a0d 0a20 2020 2020 2020  ptions:..       
+00004520: 2020 2020 206c 6f67 2e63 7269 7469 6361       log.critica
+00004530: 6c28 225f 7363 6865 6475 6c65 5f64 6973  l("_schedule_dis
+00004540: 636f 6e6e 6563 743a 2072 6169 7369 6e67  connect: raising
+00004550: 2065 7863 6570 7469 6f6e 2025 7322 2c20   exception %s", 
+00004560: 6578 6329 0d0a 2020 2020 2020 2020 2020  exc)..          
+00004570: 2020 7261 6973 6520 6578 630d 0a20 2020    raise exc..   
+00004580: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00004590: 2020 2020 2020 2020 6c6f 672e 6372 6974          log.crit
+000045a0: 6963 616c 2822 7265 7175 6573 7469 6e67  ical("requesting
+000045b0: 2073 6875 7464 6f77 6e20 6475 6520 746f   shutdown due to
+000045c0: 2065 7863 6570 7469 6f6e 2025 7322 2c20   exception %s", 
+000045d0: 6578 6329 0d0a 2020 2020 2020 2020 2020  exc)..          
+000045e0: 2020 7365 6c66 2e73 6875 7464 6f77 6e5f    self.shutdown_
+000045f0: 7265 7175 6573 7465 6420 3d20 5472 7565  requested = True
+00004600: 0d0a 0d0a 2020 2020 6465 6620 7265 7365  ....    def rese
+00004610: 7428 7365 6c66 2c20 2a61 7267 7329 3a20  t(self, *args): 
+00004620: 2320 2d3e 204e 6f6e 6520 0d0a 2020 2020  # -> None ..    
+00004630: 2020 2020 6c6f 672e 6465 6275 6728 2246      log.debug("F
+00004640: 4944 2070 6572 666f 726d 696e 6720 6465  ID performing de
+00004650: 7669 6365 2072 6573 6574 2229 0d0a 2020  vice reset")..  
+00004660: 2020 2020 2020 2373 656c 662e 6465 7669        #self.devi
+00004670: 6365 5f74 7970 652e 7265 6c65 6173 655f  ce_type.release_
+00004680: 696e 7465 7266 6163 6528 7365 6c66 2e64  interface(self.d
+00004690: 6576 6963 652c 2030 290d 0a20 2020 2020  evice, 0)..     
+000046a0: 2020 2073 656c 662e 6465 7669 6365 5f74     self.device_t
+000046b0: 7970 652e 7265 7365 7428 7365 6c66 2e64  ype.reset(self.d
+000046c0: 6576 6963 6529 0d0a 2020 2020 2020 2020  evice)..        
+000046d0: 6c6f 672e 6465 6275 6728 6622 6672 6565  log.debug(f"free
+000046e0: 6420 696e 7465 7266 6163 6522 290d 0a20  d interface").. 
+000046f0: 2020 2020 2020 2027 2727 0d0a 2020 2020         '''..    
+00004700: 2020 2020 7079 7573 625f 6465 7669 6365      pyusb_device
+00004710: 7320 3d20 6c69 7374 2873 656c 662e 6465  s = list(self.de
+00004720: 7669 6365 5f74 7970 652e 6669 6e64 2866  vice_type.find(f
+00004730: 696e 645f 616c 6c3d 5472 7565 2c20 0d0a  ind_all=True, ..
 00004740: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004760: 2020 6375 7374 6f6d 5f6d 6174 6368 203d    custom_match =
-00004770: 206c 616d 6264 6120 643a 2064 2e61 6464   lambda d: d.add
-00004780: 7265 7373 203d 3d20 7365 6c66 2e64 6576  ress == self.dev
-00004790: 6963 655f 6964 2e61 6464 7265 7373 2061  ice_id.address a
-000047a0: 6e64 2064 2e62 7573 203d 3d20 7365 6c66  nd d.bus == self
-000047b0: 2e64 6576 6963 655f 6964 2e62 7573 2929  .device_id.bus))
-000047c0: 0a20 2020 2020 2020 2023 2061 2063 6f75  .        # a cou
-000047d0: 706c 6520 6e6f 7465 732c 0a20 2020 2020  ple notes,.     
-000047e0: 2020 2023 2057 6865 6e20 796f 7520 7365     # When you se
-000047f0: 6172 6368 2068 6f77 2074 6f20 646f 2061  arch how to do a
-00004800: 2072 6573 6574 2062 7920 656e 6162 6c65   reset by enable
-00004810: 2f64 6973 6162 6c65 206f 6e20 7769 6e64  /disable on wind
-00004820: 6f77 7320 7768 6174 2063 6f6d 6573 2075  ows what comes u
-00004830: 7020 6973 2064 6576 636f 6e0a 2020 2020  p is devcon.    
-00004840: 2020 2020 2320 6465 7663 6f6e 206c 696e      # devcon lin
-00004850: 6b73 2074 6f20 706e 7075 7469 6c20 6173  ks to pnputil as
-00004860: 2074 6865 2072 6563 6f6d 6d65 6e64 6564   the recommended
-00004870: 2074 6f6f 6c20 746f 2075 7365 2061 6e64   tool to use and
-00004880: 2063 6f6d 6573 2070 7265 696e 7374 616c   comes preinstal
-00004890: 6c65 6420 6f6e 2077 696e 646f 7773 0a20  led on windows. 
-000048a0: 2020 2020 2020 2023 2070 6e70 7574 696c         # pnputil
-000048b0: 206e 6565 6473 2074 6865 2069 6e73 7461   needs the insta
-000048c0: 6e63 6520 4944 2c20 7768 6963 6820 6973  nce ID, which is
-000048d0: 2070 7265 7474 7920 7765 6c6c 2068 6964   pretty well hid
-000048e0: 6465 6e20 696e 2070 7975 7362 0a20 2020  den in pyusb.   
-000048f0: 2020 2020 2023 2049 2068 6164 2074 6f20       # I had to 
-00004900: 6c6f 6f6b 2061 7420 7468 6520 6675 6c6c  look at the full
-00004910: 2063 6f6e 6669 6775 7261 7469 6f6e 2073   configuration s
-00004920: 7472 696e 6720 616e 6420 7361 7720 7468  tring and saw th
-00004930: 6174 2074 6865 2077 6179 2074 6f20 6765  at the way to ge
-00004940: 7420 7468 6520 696e 7374 616e 6365 2069  t the instance i
-00004950: 6420 7761 7320 7468 6520 666f 6c6c 6f77  d was the follow
-00004960: 696e 670a 2020 2020 2020 2020 2320 7573  ing.        # us
-00004970: 696e 6720 5f74 7279 5f67 6574 5f73 7472  ing _try_get_str
-00004980: 696e 6720 6874 7470 733a 2f2f 6769 7468  ing https://gith
-00004990: 7562 2e63 6f6d 2f70 7975 7362 2f70 7975  ub.com/pyusb/pyu
-000049a0: 7362 2f62 6c6f 622f 6d61 7374 6572 2f75  sb/blob/master/u
-000049b0: 7362 2f63 6f72 652e 7079 234c 3132 3231  sb/core.py#L1221
-000049c0: 0a20 2020 2020 2020 2023 2073 6f20 7465  .        # so te
-000049d0: 6368 696e 6361 6c6c 7920 7765 2073 686f  chincally we sho
-000049e0: 756c 646e 2774 2064 6f20 7468 6973 2062  uldn't do this b
-000049f0: 7920 7468 6520 5f20 6d65 616e 696e 6720  y the _ meaning 
-00004a00: 6974 2073 686f 756c 6420 6265 2070 7269  it should be pri
-00004a10: 7661 7465 2c20 6275 7420 6974 2773 2074  vate, but it's t
-00004a20: 6865 206f 6e6c 7920 7761 7920 4920 7365  he only way I se
-00004a30: 650a 2020 2020 2020 2020 6465 7669 6365  e.        device
-00004a40: 5f69 6e73 7461 6e63 655f 6964 203d 2066  _instance_id = f
-00004a50: 2755 5342 5c56 4944 5f7b 7365 6c66 2e64  'USB\VID_{self.d
-00004a60: 6576 6963 655f 6964 2e76 6964 3a30 3458  evice_id.vid:04X
-00004a70: 7d26 5049 445f 7b73 656c 662e 6465 7669  }&PID_{self.devi
-00004a80: 6365 5f69 642e 7069 643a 3034 587d 5c7b  ce_id.pid:04X}\{
-00004a90: 7573 622e 636f 7265 2e5f 7472 795f 6765  usb.core._try_ge
-00004aa0: 745f 7374 7269 6e67 2870 7975 7362 5f64  t_string(pyusb_d
-00004ab0: 6576 6963 6573 5b30 5d2c 2070 7975 7362  evices[0], pyusb
-00004ac0: 5f64 6576 6963 6573 5b30 5d2e 6953 6572  _devices[0].iSer
-00004ad0: 6961 6c4e 756d 6265 7229 7d27 0a20 2020  ialNumber)}'.   
-00004ae0: 2020 2020 206c 6f67 2e64 6562 7567 2866       log.debug(f
-00004af0: 2249 6e20 7265 7365 7420 616e 6420 7265  "In reset and re
-00004b00: 7374 6172 7420 7472 7969 6e67 2074 6f20  start trying to 
-00004b10: 7265 7365 7420 696e 7374 616e 6365 2069  reset instance i
-00004b20: 6420 7b64 6576 6963 655f 696e 7374 616e  d {device_instan
-00004b30: 6365 5f69 647d 2229 0a20 2020 2020 2020  ce_id}").       
-00004b40: 2073 7562 7072 6f63 6573 732e 7275 6e28   subprocess.run(
-00004b50: 5b22 706e 7075 7469 6c22 2c20 7222 2f72  ["pnputil", r"/r
-00004b60: 6562 6f6f 7422 2c20 7222 2f64 6973 6162  eboot", r"/disab
-00004b70: 6c65 2d64 6576 6963 6522 2c20 6465 7669  le-device", devi
-00004b80: 6365 5f69 6e73 7461 6e63 655f 6964 5d29  ce_instance_id])
-00004b90: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-00004ba0: 6573 732e 7275 6e28 5b22 706e 7075 7469  ess.run(["pnputi
-00004bb0: 6c22 2c20 7222 2f72 6562 6f6f 7422 2c20  l", r"/reboot", 
-00004bc0: 7222 2f65 6e61 626c 652d 6465 7669 6365  r"/enable-device
-00004bd0: 222c 2064 6576 6963 655f 696e 7374 616e  ", device_instan
-00004be0: 6365 5f69 645d 290a 2727 270a 2020 2020  ce_id]).'''.    
-00004bf0: 2320 2323 2323 2323 2323 2323 2323 2323  # ##############
-00004c00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c30: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
-00004c40: 2023 2055 7469 6c69 7479 204d 6574 686f   # Utility Metho
-00004c50: 6473 0a20 2020 2023 2023 2323 2323 2323  ds.    # #######
-00004c60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004ca0: 2323 230a 0a20 200a 2020 2020 6465 6620  ###..  .    def 
-00004cb0: 5f74 6f34 3062 6974 2873 656c 662c 2076  _to40bit(self, v
-00004cc0: 616c 293a 0a20 2020 2020 2020 2022 2222  al):.        """
-00004cd0: 0a20 2020 2020 2020 204c 6173 6572 206d  .        Laser m
-00004ce0: 6f64 756c 6174 696f 6e20 616e 6420 636f  odulation and co
-00004cf0: 6e74 696e 756f 7573 2d73 7472 6f62 6520  ntinuous-strobe 
-00004d00: 636f 6d6d 616e 6473 2074 616b 6520 6172  commands take ar
-00004d10: 6775 6d65 6e74 7320 696e 206d 6963 726f  guments in micro
-00004d20: 2d0a 2020 2020 2020 2020 7365 636f 6e64  -.        second
-00004d30: 7320 6173 2034 302d 6269 7420 7661 6c75  s as 40-bit valu
-00004d40: 6573 2c20 7768 6572 6520 7468 6520 6c65  es, where the le
-00004d50: 6173 742d 7369 676e 6966 6963 616e 7420  ast-significant 
-00004d60: 3136 2062 6974 7320 6172 6520 7061 7373  16 bits are pass
-00004d70: 6564 0a20 2020 2020 2020 2061 7320 7756  ed.        as wV
-00004d80: 616c 7565 2c20 7468 6520 6e65 7874 2d73  alue, the next-s
-00004d90: 6967 6e69 6669 6361 6e74 2031 3620 6173  ignificant 16 as
-00004da0: 2077 496e 6465 782c 2061 6e64 2074 6865   wIndex, and the
-00004db0: 206d 6f73 742d 7369 676e 6966 6963 616e   most-significan
-00004dc0: 740a 2020 2020 2020 2020 6173 2061 2073  t.        as a s
-00004dd0: 696e 676c 6520 6279 7465 206f 6620 7061  ingle byte of pa
-00004de0: 796c 6f61 642e 2020 5468 6973 2066 756e  yload.  This fun
-00004df0: 6374 696f 6e20 7461 6b65 7320 616e 2075  ction takes an u
-00004e00: 6e73 6967 6e65 6420 696e 7465 6772 616c  nsigned integral
-00004e10: 0a20 2020 2020 2020 2076 616c 7565 2028  .        value (
-00004e20: 7072 6573 756d 6162 6c79 206d 6963 726f  presumably micro
-00004e30: 7365 636f 6e64 7329 2061 6e64 2072 6574  seconds) and ret
-00004e40: 7572 6e73 2061 2074 7570 6c65 206f 6620  urns a tuple of 
-00004e50: 7756 616c 7565 2c20 7749 6e64 6578 0a20  wValue, wIndex. 
-00004e60: 2020 2020 2020 2061 6e64 2061 2062 7566         and a buf
-00004e70: 6665 7220 746f 2070 6173 7320 6173 2070  fer to pass as p
-00004e80: 6179 6c6f 6164 2e0a 2020 2020 2020 2020  ayload..        
-00004e90: 2222 220a 2020 2020 2020 2020 6c73 7720  """.        lsw 
-00004ea0: 3d20 7661 6c20 2620 3078 6666 6666 0a20  = val & 0xffff. 
-00004eb0: 2020 2020 2020 206d 7377 203d 2028 7661         msw = (va
-00004ec0: 6c20 3e3e 2031 3629 2026 2030 7866 6666  l >> 16) & 0xfff
-00004ed0: 660a 2020 2020 2020 2020 6275 6620 3d20  f.        buf = 
-00004ee0: 5b20 2876 616c 203e 3e20 3332 2920 2620  [ (val >> 32) & 
-00004ef0: 3078 6666 2c20 3020 2a20 3720 5d0a 2020  0xff, 0 * 7 ].  
-00004f00: 2020 2020 2020 7265 7475 726e 2028 6c73        return (ls
-00004f10: 772c 206d 7377 2c20 6275 6629 0a0a 2020  w, msw, buf)..  
-00004f20: 2020 6465 6620 5f77 6169 745f 666f 725f    def _wait_for_
-00004f30: 7573 625f 6176 6169 6c61 626c 6528 7365  usb_available(se
-00004f40: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-00004f50: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00004f60: 2057 6169 7420 756e 7469 6c20 616e 7920   Wait until any 
-00004f70: 656e 666f 7263 6564 2055 5342 2070 6163  enforced USB pac
-00004f80: 6b65 7420 696e 7465 7276 616c 7320 6861  ket intervals ha
-00004f90: 7665 2065 6c61 7073 6564 2e20 5468 6973  ve elapsed. This
-00004fa0: 2064 6f65 730a 2020 2020 2020 2020 6e6f   does.        no
-00004fb0: 7468 696e 6720 696e 206d 6f73 7420 6361  thing in most ca
-00004fc0: 7365 7320 2d20 7468 6520 6675 6e63 7469  ses - the functi
-00004fd0: 6f6e 2069 7320 6e6f 726d 616c 6c79 2061  on is normally a
-00004fe0: 206e 6f2d 6f70 2e0a 2020 2020 2020 2020   no-op..        
-00004ff0: 486f 7765 7665 722c 2069 6620 7468 6520  However, if the 
-00005000: 6170 706c 6963 6174 696f 6e20 6861 7320  application has 
-00005010: 6465 6669 6e65 6420 6d69 6e2f 6d61 785f  defined min/max_
-00005020: 7573 625f 696e 7465 7276 616c 5f6d 7320  usb_interval_ms 
-00005030: 2873 6179 0a20 2020 2020 2020 2028 3230  (say.        (20
-00005040: 2c20 3530 6d73 292c 2074 6865 6e20 7069  , 50ms), then pi
-00005050: 636b 2061 2072 616e 646f 6d20 6465 6c61  ck a random dela
-00005060: 7920 696e 2074 6865 2064 6566 696e 6564  y in the defined
-00005070: 2077 696e 646f 7720 2865 2e67 2e20 3337   window (e.g. 37
-00005080: 6d73 290a 2020 2020 2020 2020 616e 6420  ms).        and 
-00005090: 736c 6565 7020 756e 7469 6c20 6974 2068  sleep until it h
-000050a0: 6173 2062 6565 6e20 6174 206c 6561 7374  as been at least
-000050b0: 2074 6861 7420 6c6f 6e67 2073 696e 6365   that long since
-000050c0: 2074 6865 206c 6173 7420 5553 420a 2020   the last USB.  
-000050d0: 2020 2020 2020 6578 6368 616e 6765 2e0a        exchange..
-000050e0: 2020 2020 2020 2020 5468 6520 7075 7270          The purp
-000050f0: 6f73 6520 6f66 2074 6869 7320 6675 6e63  ose of this func
-00005100: 7469 6f6e 2077 6173 2074 6f20 7772 696e  tion was to wrin
-00005110: 672d 6f75 7420 736f 6d65 2065 6172 6c79  g-out some early
-00005120: 2041 524d 206d 6963 726f 2d0a 2020 2020   ARM micro-.    
-00005130: 2020 2020 636f 6e74 726f 6c6c 6572 7320      controllers 
-00005140: 7769 7468 2061 7070 6172 656e 7420 7469  with apparent ti
-00005150: 6d69 6e67 2069 7373 7565 7320 756e 6465  ming issues unde
-00005160: 7220 6869 6768 2d73 7065 6564 2055 5342  r high-speed USB
-00005170: 2032 2e30 2c20 746f 2073 6565 0a20 2020   2.0, to see.   
-00005180: 2020 2020 2069 6620 636f 6d6d 756e 6963       if communic
-00005190: 6174 696f 6e73 2069 7373 7565 7320 6469  ations issues di
-000051a0: 7361 7070 6561 7265 6420 6966 2077 6520  sappeared if we 
-000051b0: 656e 666f 7263 6564 2061 2063 6f6d 6d75  enforced a commu
-000051c0: 6e69 6361 7469 6f6e 0a20 2020 2020 2020  nication.       
-000051d0: 206c 6174 656e 6379 2066 726f 6d20 7468   latency from th
-000051e0: 6520 736f 6674 7761 7265 2073 6964 652e  e software side.
-000051f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00005200: 2020 2020 2069 6620 7365 6c66 2e73 6574       if self.set
-00005210: 7469 6e67 732e 7374 6174 652e 6d61 785f  tings.state.max_
-00005220: 7573 625f 696e 7465 7276 616c 5f6d 7320  usb_interval_ms 
-00005230: 3c3d 2030 3a0a 2020 2020 2020 2020 2020  <= 0:.          
-00005240: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00005250: 2020 6966 2073 656c 662e 6c61 7374 5f75    if self.last_u
-00005260: 7362 5f74 696d 6573 7461 6d70 2069 7320  sb_timestamp is 
-00005270: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00005280: 2020 2020 2020 6465 6c61 795f 6d73 203d        delay_ms =
-00005290: 2072 616e 6469 6e74 2873 656c 662e 7365   randint(self.se
-000052a0: 7474 696e 6773 2e73 7461 7465 2e6d 696e  ttings.state.min
-000052b0: 5f75 7362 5f69 6e74 6572 7661 6c5f 6d73  _usb_interval_ms
-000052c0: 2c20 7365 6c66 2e73 6574 7469 6e67 732e  , self.settings.
-000052d0: 7374 6174 652e 6d61 785f 7573 625f 696e  state.max_usb_in
-000052e0: 7465 7276 616c 5f6d 7329 0a20 2020 2020  terval_ms).     
-000052f0: 2020 2020 2020 206e 6578 745f 7573 625f         next_usb_
-00005300: 7469 6d65 7374 616d 7020 3d20 7365 6c66  timestamp = self
-00005310: 2e6c 6173 745f 7573 625f 7469 6d65 7374  .last_usb_timest
-00005320: 616d 7020 2b20 6461 7465 7469 6d65 2e74  amp + datetime.t
-00005330: 696d 6564 656c 7461 286d 696c 6c69 7365  imedelta(millise
-00005340: 636f 6e64 733d 6465 6c61 795f 6d73 290a  conds=delay_ms).
-00005350: 2020 2020 2020 2020 2020 2020 6e6f 7720              now 
-00005360: 3d20 6461 7465 7469 6d65 2e64 6174 6574  = datetime.datet
-00005370: 696d 652e 6e6f 7728 290a 2020 2020 2020  ime.now().      
-00005380: 2020 2020 2020 6966 206e 6f77 203c 206e        if now < n
-00005390: 6578 745f 7573 625f 7469 6d65 7374 616d  ext_usb_timestam
-000053a0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-000053b0: 2020 2073 6c65 6570 5f73 6563 203d 2028     sleep_sec = (
-000053c0: 6e65 7874 5f75 7362 5f74 696d 6573 7461  next_usb_timesta
-000053d0: 6d70 202d 206e 6f77 292e 746f 7461 6c5f  mp - now).total_
-000053e0: 7365 636f 6e64 7328 290a 2020 2020 2020  seconds().      
-000053f0: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
-00005400: 6275 6728 2266 6964 3a20 736c 6565 7069  bug("fid: sleepi
-00005410: 6e67 2025 2e33 6620 7365 6320 746f 2065  ng %.3f sec to e
-00005420: 6e66 6f72 6365 2025 6420 6d73 2055 5342  nforce %d ms USB
-00005430: 2069 6e74 6572 7661 6c22 2c20 736c 6565   interval", slee
-00005440: 705f 7365 632c 2064 656c 6179 5f6d 7329  p_sec, delay_ms)
-00005450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005460: 2073 6c65 6570 2873 6c65 6570 5f73 6563   sleep(sleep_sec
-00005470: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
-00005480: 6173 745f 7573 625f 7469 6d65 7374 616d  ast_usb_timestam
-00005490: 7020 3d20 6461 7465 7469 6d65 2e64 6174  p = datetime.dat
-000054a0: 6574 696d 652e 6e6f 7728 290a 0a20 2020  etime.now()..   
-000054b0: 2064 6566 205f 6368 6563 6b5f 666f 725f   def _check_for_
-000054c0: 7261 6e64 6f6d 5f65 7272 6f72 2873 656c  random_error(sel
-000054d0: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
-000054e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000054f0: 5468 6973 2066 756e 6374 696f 6e20 6973  This function is
-00005500: 2070 726f 7669 6465 6420 746f 2073 696d   provided to sim
-00005510: 756c 6174 6520 7261 6e64 6f6d 2055 5342  ulate random USB
-00005520: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2065   communication e
-00005530: 7272 6f72 730a 2020 2020 2020 2020 6475  rrors.        du
-00005540: 7269 6e67 2072 6567 7265 7373 696f 6e20  ring regression 
-00005550: 7465 7374 696e 672c 2061 6e64 2069 7320  testing, and is 
-00005560: 6e6f 726d 616c 6c79 2061 206e 6f2d 6f70  normally a no-op
-00005570: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00005580: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00005590: 662e 696e 6a65 6374 5f72 616e 646f 6d5f  f.inject_random_
-000055a0: 6572 726f 7273 3a0a 2020 2020 2020 2020  errors:.        
-000055b0: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-000055c0: 0a0a 2020 2020 2020 2020 6966 2072 616e  ..        if ran
-000055d0: 646f 6d2e 7261 6e64 6f6d 2829 203c 3d20  dom.random() <= 
-000055e0: 7365 6c66 2e72 616e 646f 6d5f 6572 726f  self.random_erro
-000055f0: 725f 7065 7263 3a0a 2020 2020 2020 2020  r_perc:.        
-00005600: 2020 2020 6c6f 672e 6372 6974 6963 616c      log.critical
-00005610: 2822 5261 6e64 6f6d 6c79 2d69 6e6a 6563  ("Randomly-injec
-00005620: 7465 6420 6572 726f 7222 290a 2020 2020  ted error").    
-00005630: 2020 2020 2020 2020 7365 6c66 2e5f 7363          self._sc
-00005640: 6865 6475 6c65 5f64 6973 636f 6e6e 6563  hedule_disconnec
-00005650: 7428 4578 6365 7074 696f 6e28 2252 616e  t(Exception("Ran
-00005660: 646f 6d6c 792d 696e 6a65 6374 6564 2065  domly-injected e
-00005670: 7272 6f72 2229 290a 2020 2020 2020 2020  rror")).        
-00005680: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-00005690: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-000056a0: 616c 7365 0a0a 2020 2020 2323 0a20 2020  alse..    ##.   
-000056b0: 2023 2055 6e74 696c 2073 7570 706f 7274   # Until support
-000056c0: 2066 6f72 2065 7665 6e2f 6f64 6420 496e   for even/odd In
-000056d0: 4761 4173 2067 6169 6e20 616e 6420 6f66  GaAs gain and of
-000056e0: 6673 6574 2068 6176 6520 6265 656e 2061  fset have been a
-000056f0: 6464 6564 2074 6f20 7468 650a 2020 2020  dded to the.    
-00005700: 2320 6669 726d 7761 7265 2c20 6170 706c  # firmware, appl
-00005710: 7920 7468 6520 636f 7272 6563 7469 6f6e  y the correction
-00005720: 2069 6e20 736f 6674 7761 7265 2e0a 2020   in software..  
-00005730: 2020 6465 6620 5f63 6f72 7265 6374 5f69    def _correct_i
-00005740: 6e67 6161 735f 6761 696e 5f61 6e64 5f6f  ngaas_gain_and_o
-00005750: 6666 7365 7428 7365 6c66 2c20 7370 6563  ffset(self, spec
-00005760: 7472 756d 3a20 6c69 7374 5b66 6c6f 6174  trum: list[float
-00005770: 5d29 202d 3e20 626f 6f6c 3a0a 2020 2020  ]) -> bool:.    
-00005780: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00005790: 7365 7474 696e 6773 2e69 735f 696e 6761  settings.is_inga
-000057a0: 6173 2829 206f 7220 7365 6c66 2e73 6574  as() or self.set
-000057b0: 7469 6e67 732e 6565 7072 6f6d 2e68 6172  tings.eeprom.har
-000057c0: 6477 6172 655f 6576 656e 5f6f 6464 3a0a  dware_even_odd:.
-000057d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000057e0: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
-000057f0: 2020 2320 6966 2065 7665 6e20 616e 6420    # if even and 
-00005800: 6f64 6420 7069 7865 6c73 2068 6176 6520  odd pixels have 
-00005810: 7468 6520 7361 6d65 2073 6574 7469 6e67  the same setting
-00005820: 732c 2074 6865 7265 2773 206e 6f20 706f  s, there's no po
-00005830: 696e 7420 696e 2064 6f69 6e67 2061 6e79  int in doing any
-00005840: 7468 696e 670a 2020 2020 2020 2020 6966  thing.        if
-00005850: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-00005860: 6570 726f 6d2e 6465 7465 6374 6f72 5f67  eprom.detector_g
-00005870: 6169 6e5f 6f64 6420 2020 3d3d 2073 656c  ain_odd   == sel
-00005880: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-00005890: 6d2e 6465 7465 6374 6f72 5f67 6169 6e20  m.detector_gain 
-000058a0: 616e 6420 5c0a 2020 2020 2020 2020 2020  and \.          
-000058b0: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-000058c0: 6570 726f 6d2e 6465 7465 6374 6f72 5f6f  eprom.detector_o
-000058d0: 6666 7365 745f 6f64 6420 3d3d 2073 656c  ffset_odd == sel
-000058e0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-000058f0: 6d2e 6465 7465 6374 6f72 5f6f 6666 7365  m.detector_offse
-00005900: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-00005910: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-00005920: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-00005930: 7265 7363 616c 696e 6720 496e 4761 4173  rescaling InGaAs
-00005940: 206f 6464 2070 6978 656c 7320 6672 6f6d   odd pixels from
-00005950: 2065 7665 6e20 6761 696e 2025 2e34 662c   even gain %.4f,
-00005960: 206f 6666 7365 7420 2564 2074 6f20 6f64   offset %d to od
-00005970: 6420 6761 696e 2025 2e34 662c 206f 6666  d gain %.4f, off
-00005980: 7365 7420 2564 222c 0a20 2020 2020 2020  set %d",.       
-00005990: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-000059a0: 6773 2e65 6570 726f 6d2e 6465 7465 6374  gs.eeprom.detect
-000059b0: 6f72 5f67 6169 6e2c 0a20 2020 2020 2020  or_gain,.       
-000059c0: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-000059d0: 6773 2e65 6570 726f 6d2e 6465 7465 6374  gs.eeprom.detect
-000059e0: 6f72 5f6f 6666 7365 742c 0a20 2020 2020  or_offset,.     
-000059f0: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
-00005a00: 696e 6773 2e65 6570 726f 6d2e 6465 7465  ings.eeprom.dete
-00005a10: 6374 6f72 5f67 6169 6e5f 6f64 642c 0a20  ctor_gain_odd,. 
-00005a20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005a30: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
-00005a40: 6465 7465 6374 6f72 5f6f 6666 7365 745f  detector_offset_
-00005a50: 6f64 6429 0a0a 2020 2020 2020 2020 6c6f  odd)..        lo
-00005a60: 672e 6465 6275 6728 2262 6566 6f72 653a  g.debug("before:
-00005a70: 2025 642c 2025 642c 2025 642c 2025 642c   %d, %d, %d, %d,
-00005a80: 2025 6422 2c20 7370 6563 7472 756d 5b30   %d", spectrum[0
-00005a90: 5d2c 2073 7065 6374 7275 6d5b 315d 2c20  ], spectrum[1], 
-00005aa0: 7370 6563 7472 756d 5b32 5d2c 2073 7065  spectrum[2], spe
-00005ab0: 6374 7275 6d5b 335d 2c20 7370 6563 7472  ctrum[3], spectr
-00005ac0: 756d 5b34 5d29 0a0a 2020 2020 2020 2020  um[4])..        
-00005ad0: 2320 6974 6572 6174 6520 6f76 6572 2074  # iterate over t
-00005ae0: 6865 204f 4444 2070 6978 656c 7320 6f66  he ODD pixels of
-00005af0: 2074 6865 2073 7065 6374 7275 6d0a 2020   the spectrum.  
-00005b00: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-00005b10: 616e 6765 2831 2c20 6c65 6e28 7370 6563  ange(1, len(spec
-00005b20: 7472 756d 292c 2032 293a 0a0a 2020 2020  trum), 2):..    
-00005b30: 2020 2020 2020 2020 2320 6261 636b 2d6f          # back-o
-00005b40: 7574 2074 6865 2069 6e63 6f72 7265 6374  ut the incorrect
-00005b50: 6c79 2061 7070 6c69 6564 2022 6576 656e  ly applied "even
-00005b60: 2220 6761 696e 2061 6e64 206f 6666 7365  " gain and offse
-00005b70: 740a 2020 2020 2020 2020 2020 2020 6f6c  t.            ol
-00005b80: 6420 3d20 666c 6f61 7428 7370 6563 7472  d = float(spectr
-00005b90: 756d 5b69 5d29 0a20 2020 2020 2020 2020  um[i]).         
-00005ba0: 2020 2072 6177 203d 2028 6f6c 6420 2d20     raw = (old - 
-00005bb0: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
-00005bc0: 7072 6f6d 2e64 6574 6563 746f 725f 6f66  prom.detector_of
-00005bd0: 6673 6574 2920 2f20 7365 6c66 2e73 6574  fset) / self.set
-00005be0: 7469 6e67 732e 6565 7072 6f6d 2e64 6574  tings.eeprom.det
-00005bf0: 6563 746f 725f 6761 696e 0a0a 2020 2020  ector_gain..    
-00005c00: 2020 2020 2020 2020 2320 6170 706c 7920          # apply 
-00005c10: 7468 6520 636f 7272 6563 7420 226f 6464  the correct "odd
-00005c20: 2220 6761 696e 2061 6e64 206f 6666 7365  " gain and offse
-00005c30: 740a 2020 2020 2020 2020 2020 2020 7370  t.            sp
-00005c40: 6563 7472 756d 5b69 5d20 3d20 2872 6177  ectrum[i] = (raw
-00005c50: 202a 2073 656c 662e 7365 7474 696e 6773   * self.settings
-00005c60: 2e65 6570 726f 6d2e 6465 7465 6374 6f72  .eeprom.detector
-00005c70: 5f67 6169 6e5f 6f64 6429 202b 2073 656c  _gain_odd) + sel
-00005c80: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-00005c90: 6d2e 6465 7465 6374 6f72 5f6f 6666 7365  m.detector_offse
-00005ca0: 745f 6f64 640a 0a20 2020 2020 2020 2020  t_odd..         
-00005cb0: 2020 2069 6620 6920 3c20 3520 6f72 2069     if i < 5 or i
-00005cc0: 203e 206c 656e 2873 7065 6374 7275 6d29   > len(spectrum)
-00005cd0: 202d 2035 3a0a 2020 2020 2020 2020 2020   - 5:.          
-00005ce0: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-00005cf0: 2220 2070 6978 656c 2025 3464 3a20 6f6c  "  pixel %4d: ol
-00005d00: 6420 252e 3266 2072 6177 2025 2e32 6620  d %.2f raw %.2f 
-00005d10: 6e65 7720 252e 3266 222c 2069 2c20 6f6c  new %.2f", i, ol
-00005d20: 642c 2072 6177 2c20 7370 6563 7472 756d  d, raw, spectrum
-00005d30: 5b69 5d29 0a0a 2020 2020 2020 2020 6c6f  [i])..        lo
-00005d40: 672e 6465 6275 6728 2261 6674 6572 3a20  g.debug("after: 
-00005d50: 2564 2c20 2564 2c20 2564 2c20 2564 2c20  %d, %d, %d, %d, 
-00005d60: 2564 222c 2073 7065 6374 7275 6d5b 305d  %d", spectrum[0]
-00005d70: 2c20 7370 6563 7472 756d 5b31 5d2c 2073  , spectrum[1], s
-00005d80: 7065 6374 7275 6d5b 325d 2c20 7370 6563  pectrum[2], spec
-00005d90: 7472 756d 5b33 5d2c 2073 7065 6374 7275  trum[3], spectru
-00005da0: 6d5b 345d 290a 0a20 2020 2020 2020 2072  m[4])..        r
-00005db0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-00005dc0: 6465 6620 5f61 7070 6c79 5f32 7832 5f62  def _apply_2x2_b
-00005dd0: 696e 6e69 6e67 2873 656c 662c 2073 7065  inning(self, spe
-00005de0: 6374 7275 6d3a 206c 6973 745b 666c 6f61  ctrum: list[floa
-00005df0: 745d 2920 2d3e 206c 6973 745b 666c 6f61  t]) -> list[floa
-00005e00: 745d 3a0a 2020 2020 2020 2020 6966 206e  t]:.        if n
-00005e10: 6f74 2073 656c 662e 7365 7474 696e 6773  ot self.settings
-00005e20: 2e65 6570 726f 6d2e 6269 6e5f 3278 323a  .eeprom.bin_2x2:
-00005e30: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00005e40: 7572 6e20 7370 6563 7472 756d 0a0a 2020  urn spectrum..  
-00005e50: 2020 2020 2020 6465 6620 6269 6e32 7832        def bin2x2
-00005e60: 2861 293a 0a20 2020 2020 2020 2020 2020  (a):.           
-00005e70: 2069 6620 6120 6973 204e 6f6e 6520 6f72   if a is None or
-00005e80: 206c 656e 2861 2920 3d3d 2030 3a0a 2020   len(a) == 0:.  
-00005e90: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00005ea0: 7475 726e 2061 0a20 2020 2020 2020 2020  turn a.         
-00005eb0: 2020 2062 696e 6e65 6420 3d20 5b5d 0a20     binned = []. 
-00005ec0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00005ed0: 2069 6e20 7261 6e67 6528 6c65 6e28 6129   in range(len(a)
-00005ee0: 2d31 293a 0a20 2020 2020 2020 2020 2020  -1):.           
-00005ef0: 2020 2020 2062 696e 6e65 642e 6170 7065       binned.appe
-00005f00: 6e64 2828 615b 695d 202b 2061 5b69 2b31  nd((a[i] + a[i+1
-00005f10: 5d29 202f 2032 2e30 290a 2020 2020 2020  ]) / 2.0).      
-00005f20: 2020 2020 2020 6269 6e6e 6564 2e61 7070        binned.app
-00005f30: 656e 6428 615b 2d31 5d29 0a20 2020 2020  end(a[-1]).     
-00005f40: 2020 2020 2020 2072 6574 7572 6e20 6269         return bi
-00005f50: 6e6e 6564 0a0a 2020 2020 2020 2020 6966  nned..        if
-00005f60: 2073 656c 662e 7365 7474 696e 6773 2e73   self.settings.s
-00005f70: 7461 7465 2e64 6574 6563 746f 725f 7265  tate.detector_re
-00005f80: 6769 6f6e 7320 6973 204e 6f6e 653a 0a20  gions is None:. 
-00005f90: 2020 2020 2020 2020 2020 206c 6f67 2e64             log.d
-00005fa0: 6562 7567 2822 6170 706c 7969 6e67 2062  ebug("applying b
-00005fb0: 696e 5f32 7832 2229 0a20 2020 2020 2020  in_2x2").       
-00005fc0: 2020 2020 2072 6574 7572 6e20 6269 6e32       return bin2
-00005fd0: 7832 2873 7065 6374 7275 6d29 0a0a 2020  x2(spectrum)..  
-00005fe0: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-00005ff0: 2261 7070 6c79 696e 6720 6269 6e5f 3278  "applying bin_2x
-00006000: 3220 746f 2072 6567 696f 6e73 2229 0a20  2 to regions"). 
-00006010: 2020 2020 2020 2063 6f6d 6269 6e65 6420         combined 
-00006020: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00006030: 2073 7562 7370 6563 7472 756d 2069 6e20   subspectrum in 
-00006040: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
-00006050: 6174 652e 6465 7465 6374 6f72 5f72 6567  ate.detector_reg
-00006060: 696f 6e73 2e73 706c 6974 2873 7065 6374  ions.split(spect
-00006070: 7275 6d29 3a0a 2020 2020 2020 2020 2020  rum):.          
-00006080: 2020 636f 6d62 696e 6564 2e65 7874 656e    combined.exten
-00006090: 6428 6269 6e32 7832 2873 7562 7370 6563  d(bin2x2(subspec
-000060a0: 7472 756d 2929 0a20 2020 2020 2020 2072  trum)).        r
-000060b0: 6574 7572 6e20 636f 6d62 696e 6564 0a0a  eturn combined..
-000060c0: 2020 2020 6465 6620 5f63 6f72 7265 6374      def _correct
-000060d0: 5f62 6164 5f70 6978 656c 7328 7365 6c66  _bad_pixels(self
-000060e0: 2c20 7370 6563 7472 756d 3a20 6c69 7374  , spectrum: list
-000060f0: 5b66 6c6f 6174 5d29 202d 3e20 626f 6f6c  [float]) -> bool
-00006100: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00006110: 2020 2020 2020 4966 2061 2073 7065 6374        If a spect
-00006120: 726f 6d65 7465 7220 6861 7320 6261 645f  rometer has bad_
-00006130: 7069 7865 6c73 2063 6f6e 6669 6775 7265  pixels configure
-00006140: 6420 696e 2074 6865 2045 4550 524f 4d2c  d in the EEPROM,
-00006150: 2074 6865 6e20 6176 6572 6167 650a 2020   then average.  
-00006160: 2020 2020 2020 6f76 6572 2074 6865 6d20        over them 
-00006170: 696e 2074 6865 2064 7269 7665 722e 0a20  in the driver.. 
-00006180: 2020 2020 2020 204e 6f74 6520 7468 6973         Note this
-00006190: 2066 756e 6374 696f 6e20 6d6f 6469 6669   function modifi
-000061a0: 6573 2074 6865 2070 6173 7365 6420 6172  es the passed ar
-000061b0: 7261 7920 696e 2d70 6c61 6365 2c20 7261  ray in-place, ra
-000061c0: 7468 6572 2074 6861 6e0a 2020 2020 2020  ther than.      
-000061d0: 2020 7265 7475 726e 696e 6720 6120 6d6f    returning a mo
-000061e0: 6469 6669 6564 2063 6f70 792e 0a20 2020  dified copy..   
-000061f0: 2020 2020 2040 6e6f 7465 2061 7373 756d       @note assum
-00006200: 6573 2062 6164 5f70 6978 656c 7320 6973  es bad_pixels is
-00006210: 2070 7265 7669 6f75 736c 7920 736f 7274   previously sort
-00006220: 6564 0a20 2020 2020 2020 2022 2222 0a0a  ed.        """..
-00006230: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00006240: 7365 7474 696e 6773 2069 7320 4e6f 6e65  settings is None
-00006250: 206f 7220 5c0a 2020 2020 2020 2020 2020   or \.          
-00006260: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-00006270: 6e67 732e 6565 7072 6f6d 2069 7320 4e6f  ngs.eeprom is No
-00006280: 6e65 206f 7220 5c0a 2020 2020 2020 2020  ne or \.        
-00006290: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-000062a0: 7469 6e67 732e 6565 7072 6f6d 2e62 6164  tings.eeprom.bad
-000062b0: 5f70 6978 656c 7320 6973 204e 6f6e 6520  _pixels is None 
-000062c0: 6f72 205c 0a20 2020 2020 2020 2020 2020  or \.           
-000062d0: 2020 2020 206c 656e 2873 656c 662e 7365       len(self.se
-000062e0: 7474 696e 6773 2e65 6570 726f 6d2e 6261  ttings.eeprom.ba
-000062f0: 645f 7069 7865 6c73 2920 3d3d 2030 206f  d_pixels) == 0 o
-00006300: 7220 5c0a 2020 2020 2020 2020 2020 2020  r \.            
-00006310: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
-00006320: 732e 7374 6174 652e 6465 7465 6374 6f72  s.state.detector
-00006330: 5f72 6567 696f 6e73 2069 7320 6e6f 7420  _regions is not 
-00006340: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00006350: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00006360: 2020 2020 2020 2020 6966 2073 7065 6374          if spect
-00006370: 7275 6d20 6973 204e 6f6e 6520 6f72 206c  rum is None or l
-00006380: 656e 2873 7065 6374 7275 6d29 203d 3d20  en(spectrum) == 
-00006390: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-000063a0: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-000063b0: 2020 2020 2070 6978 656c 7320 3d20 6c65       pixels = le
-000063c0: 6e28 7370 6563 7472 756d 290a 2020 2020  n(spectrum).    
-000063d0: 2020 2020 6261 645f 7069 7865 6c73 203d      bad_pixels =
-000063e0: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-000063f0: 6570 726f 6d2e 6261 645f 7069 7865 6c73  eprom.bad_pixels
-00006400: 0a0a 2020 2020 2020 2020 2320 6974 6572  ..        # iter
-00006410: 6174 6520 6f76 6572 2065 6163 6820 6261  ate over each ba
-00006420: 6420 7069 7865 6c0a 2020 2020 2020 2020  d pixel.        
-00006430: 6920 3d20 300a 2020 2020 2020 2020 7768  i = 0.        wh
-00006440: 696c 6520 6920 3c20 6c65 6e28 6261 645f  ile i < len(bad_
-00006450: 7069 7865 6c73 293a 0a0a 2020 2020 2020  pixels):..      
-00006460: 2020 2020 2020 6261 645f 7069 7820 3d20        bad_pix = 
-00006470: 6261 645f 7069 7865 6c73 5b69 5d0a 0a20  bad_pixels[i].. 
-00006480: 2020 2020 2020 2020 2020 2069 6620 6261             if ba
-00006490: 645f 7069 7820 3d3d 2030 3a0a 2020 2020  d_pix == 0:.    
-000064a0: 2020 2020 2020 2020 2020 2020 2320 6861              # ha
-000064b0: 6e64 6c65 2074 6865 206c 6566 7420 6564  ndle the left ed
-000064c0: 6765 0a20 2020 2020 2020 2020 2020 2020  ge.             
-000064d0: 2020 206e 6578 745f 676f 6f64 203d 2062     next_good = b
-000064e0: 6164 5f70 6978 202b 2031 0a20 2020 2020  ad_pix + 1.     
-000064f0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-00006500: 206e 6578 745f 676f 6f64 2069 6e20 6261   next_good in ba
-00006510: 645f 7069 7865 6c73 2061 6e64 206e 6578  d_pixels and nex
-00006520: 745f 676f 6f64 203c 2070 6978 656c 733a  t_good < pixels:
-00006530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006540: 2020 2020 206e 6578 745f 676f 6f64 202b       next_good +
-00006550: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00006560: 2020 2020 2020 2020 6920 2b3d 2031 0a20          i += 1. 
-00006570: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00006580: 6620 6e65 7874 5f67 6f6f 6420 3c20 7069  f next_good < pi
-00006590: 7865 6c73 3a0a 2020 2020 2020 2020 2020  xels:.          
-000065a0: 2020 2020 2020 2020 2020 666f 7220 6a20            for j 
-000065b0: 696e 2072 616e 6765 286e 6578 745f 676f  in range(next_go
-000065c0: 6f64 293a 0a20 2020 2020 2020 2020 2020  od):.           
-000065d0: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-000065e0: 6374 7275 6d5b 6a5d 203d 2073 7065 6374  ctrum[j] = spect
-000065f0: 7275 6d5b 6e65 7874 5f67 6f6f 645d 0a20  rum[next_good]. 
-00006600: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00006610: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006620: 2020 2320 6669 6e64 2070 7265 7669 6f75    # find previou
-00006630: 7320 676f 6f64 2070 6978 656c 0a20 2020  s good pixel.   
-00006640: 2020 2020 2020 2020 2020 2020 2070 7265               pre
-00006650: 765f 676f 6f64 203d 2062 6164 5f70 6978  v_good = bad_pix
-00006660: 202d 2031 0a20 2020 2020 2020 2020 2020   - 1.           
-00006670: 2020 2020 2077 6869 6c65 2070 7265 765f       while prev_
-00006680: 676f 6f64 2069 6e20 6261 645f 7069 7865  good in bad_pixe
-00006690: 6c73 2061 6e64 2070 7265 765f 676f 6f64  ls and prev_good
-000066a0: 203e 3d20 303a 0a20 2020 2020 2020 2020   >= 0:.         
-000066b0: 2020 2020 2020 2020 2020 2070 7265 765f             prev_
-000066c0: 676f 6f64 202d 3d20 310a 0a20 2020 2020  good -= 1..     
-000066d0: 2020 2020 2020 2020 2020 2069 6620 7072             if pr
-000066e0: 6576 5f67 6f6f 6420 3e3d 2030 3a0a 2020  ev_good >= 0:.  
-000066f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006700: 2020 2320 6669 6e64 206e 6578 7420 676f    # find next go
-00006710: 6f64 2070 6978 656c 0a20 2020 2020 2020  od pixel.       
-00006720: 2020 2020 2020 2020 2020 2020 206e 6578               nex
-00006730: 745f 676f 6f64 203d 2062 6164 5f70 6978  t_good = bad_pix
-00006740: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
-00006750: 2020 2020 2020 2020 2077 6869 6c65 206e           while n
-00006760: 6578 745f 676f 6f64 2069 6e20 6261 645f  ext_good in bad_
-00006770: 7069 7865 6c73 2061 6e64 206e 6578 745f  pixels and next_
-00006780: 676f 6f64 203c 2070 6978 656c 733a 0a20  good < pixels:. 
-00006790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067a0: 2020 2020 2020 206e 6578 745f 676f 6f64         next_good
-000067b0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-000067c0: 2020 2020 2020 2020 2020 2020 2020 6920                i 
-000067d0: 2b3d 2031 0a0a 2020 2020 2020 2020 2020  += 1..          
-000067e0: 2020 2020 2020 2020 2020 6966 206e 6578            if nex
-000067f0: 745f 676f 6f64 203c 2070 6978 656c 733a  t_good < pixels:
-00006800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006810: 2020 2020 2020 2020 2023 2066 6f72 206e           # for n
-00006820: 6f77 2c20 6472 6177 2061 206c 696e 6520  ow, draw a line 
-00006830: 6265 7477 6565 6e20 7072 6576 696f 7573  between previous
-00006840: 2061 6e64 206e 6578 745f 676f 6f64 2070   and next_good p
-00006850: 6978 656c 730a 2020 2020 2020 2020 2020  ixels.          
-00006860: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00006870: 544f 444f 3a20 636f 6e73 6964 6572 2073  TODO: consider s
-00006880: 6f6d 6520 6b69 6e64 206f 6620 6375 7276  ome kind of curv
-00006890: 652d 6669 740a 2020 2020 2020 2020 2020  e-fit.          
-000068a0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-000068b0: 6c74 6120 3d20 666c 6f61 7428 7370 6563  lta = float(spec
-000068c0: 7472 756d 5b6e 6578 745f 676f 6f64 5d20  trum[next_good] 
-000068d0: 2d20 7370 6563 7472 756d 5b70 7265 765f  - spectrum[prev_
-000068e0: 676f 6f64 5d29 0a20 2020 2020 2020 2020  good]).         
-000068f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00006900: 6e67 2020 203d 206e 6578 745f 676f 6f64  ng   = next_good
-00006910: 202d 2070 7265 765f 676f 6f64 0a20 2020   - prev_good.   
+00004760: 2020 2020 2020 2020 2020 2020 2020 6964                id
+00004770: 5665 6e64 6f72 3d73 656c 662e 6465 7669  Vendor=self.devi
+00004780: 6365 5f69 642e 7669 642c 200d 0a20 2020  ce_id.vid, ..   
+00004790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000047a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000047b0: 2020 2020 2020 2020 2020 2069 6450 726f             idPro
+000047c0: 6475 6374 3d73 656c 662e 6465 7669 6365  duct=self.device
+000047d0: 5f69 642e 7069 642c 0d0a 2020 2020 2020  _id.pid,..      
+000047e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000047f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004800: 2020 2020 2020 2020 6375 7374 6f6d 5f6d          custom_m
+00004810: 6174 6368 203d 206c 616d 6264 6120 643a  atch = lambda d:
+00004820: 2064 2e61 6464 7265 7373 203d 3d20 7365   d.address == se
+00004830: 6c66 2e64 6576 6963 655f 6964 2e61 6464  lf.device_id.add
+00004840: 7265 7373 2061 6e64 2064 2e62 7573 203d  ress and d.bus =
+00004850: 3d20 7365 6c66 2e64 6576 6963 655f 6964  = self.device_id
+00004860: 2e62 7573 2929 0d0a 2020 2020 2020 2020  .bus))..        
+00004870: 2320 6120 636f 7570 6c65 206e 6f74 6573  # a couple notes
+00004880: 2c0d 0a20 2020 2020 2020 2023 2057 6865  ,..        # Whe
+00004890: 6e20 796f 7520 7365 6172 6368 2068 6f77  n you search how
+000048a0: 2074 6f20 646f 2061 2072 6573 6574 2062   to do a reset b
+000048b0: 7920 656e 6162 6c65 2f64 6973 6162 6c65  y enable/disable
+000048c0: 206f 6e20 7769 6e64 6f77 7320 7768 6174   on windows what
+000048d0: 2063 6f6d 6573 2075 7020 6973 2064 6576   comes up is dev
+000048e0: 636f 6e0d 0a20 2020 2020 2020 2023 2064  con..        # d
+000048f0: 6576 636f 6e20 6c69 6e6b 7320 746f 2070  evcon links to p
+00004900: 6e70 7574 696c 2061 7320 7468 6520 7265  nputil as the re
+00004910: 636f 6d6d 656e 6465 6420 746f 6f6c 2074  commended tool t
+00004920: 6f20 7573 6520 616e 6420 636f 6d65 7320  o use and comes 
+00004930: 7072 6569 6e73 7461 6c6c 6564 206f 6e20  preinstalled on 
+00004940: 7769 6e64 6f77 730d 0a20 2020 2020 2020  windows..       
+00004950: 2023 2070 6e70 7574 696c 206e 6565 6473   # pnputil needs
+00004960: 2074 6865 2069 6e73 7461 6e63 6520 4944   the instance ID
+00004970: 2c20 7768 6963 6820 6973 2070 7265 7474  , which is prett
+00004980: 7920 7765 6c6c 2068 6964 6465 6e20 696e  y well hidden in
+00004990: 2070 7975 7362 0d0a 2020 2020 2020 2020   pyusb..        
+000049a0: 2320 4920 6861 6420 746f 206c 6f6f 6b20  # I had to look 
+000049b0: 6174 2074 6865 2066 756c 6c20 636f 6e66  at the full conf
+000049c0: 6967 7572 6174 696f 6e20 7374 7269 6e67  iguration string
+000049d0: 2061 6e64 2073 6177 2074 6861 7420 7468   and saw that th
+000049e0: 6520 7761 7920 746f 2067 6574 2074 6865  e way to get the
+000049f0: 2069 6e73 7461 6e63 6520 6964 2077 6173   instance id was
+00004a00: 2074 6865 2066 6f6c 6c6f 7769 6e67 0d0a   the following..
+00004a10: 2020 2020 2020 2020 2320 7573 696e 6720          # using 
+00004a20: 5f74 7279 5f67 6574 5f73 7472 696e 6720  _try_get_string 
+00004a30: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+00004a40: 6f6d 2f70 7975 7362 2f70 7975 7362 2f62  om/pyusb/pyusb/b
+00004a50: 6c6f 622f 6d61 7374 6572 2f75 7362 2f63  lob/master/usb/c
+00004a60: 6f72 652e 7079 234c 3132 3231 0d0a 2020  ore.py#L1221..  
+00004a70: 2020 2020 2020 2320 736f 2074 6563 6869        # so techi
+00004a80: 6e63 616c 6c79 2077 6520 7368 6f75 6c64  ncally we should
+00004a90: 6e27 7420 646f 2074 6869 7320 6279 2074  n't do this by t
+00004aa0: 6865 205f 206d 6561 6e69 6e67 2069 7420  he _ meaning it 
+00004ab0: 7368 6f75 6c64 2062 6520 7072 6976 6174  should be privat
+00004ac0: 652c 2062 7574 2069 7427 7320 7468 6520  e, but it's the 
+00004ad0: 6f6e 6c79 2077 6179 2049 2073 6565 0d0a  only way I see..
+00004ae0: 2020 2020 2020 2020 6465 7669 6365 5f69          device_i
+00004af0: 6e73 7461 6e63 655f 6964 203d 2066 2755  nstance_id = f'U
+00004b00: 5342 5c56 4944 5f7b 7365 6c66 2e64 6576  SB\VID_{self.dev
+00004b10: 6963 655f 6964 2e76 6964 3a30 3458 7d26  ice_id.vid:04X}&
+00004b20: 5049 445f 7b73 656c 662e 6465 7669 6365  PID_{self.device
+00004b30: 5f69 642e 7069 643a 3034 587d 5c7b 7573  _id.pid:04X}\{us
+00004b40: 622e 636f 7265 2e5f 7472 795f 6765 745f  b.core._try_get_
+00004b50: 7374 7269 6e67 2870 7975 7362 5f64 6576  string(pyusb_dev
+00004b60: 6963 6573 5b30 5d2c 2070 7975 7362 5f64  ices[0], pyusb_d
+00004b70: 6576 6963 6573 5b30 5d2e 6953 6572 6961  evices[0].iSeria
+00004b80: 6c4e 756d 6265 7229 7d27 0d0a 2020 2020  lNumber)}'..    
+00004b90: 2020 2020 6c6f 672e 6465 6275 6728 6622      log.debug(f"
+00004ba0: 496e 2072 6573 6574 2061 6e64 2072 6573  In reset and res
+00004bb0: 7461 7274 2074 7279 696e 6720 746f 2072  tart trying to r
+00004bc0: 6573 6574 2069 6e73 7461 6e63 6520 6964  eset instance id
+00004bd0: 207b 6465 7669 6365 5f69 6e73 7461 6e63   {device_instanc
+00004be0: 655f 6964 7d22 290d 0a20 2020 2020 2020  e_id}")..       
+00004bf0: 2073 7562 7072 6f63 6573 732e 7275 6e28   subprocess.run(
+00004c00: 5b22 706e 7075 7469 6c22 2c20 7222 2f72  ["pnputil", r"/r
+00004c10: 6562 6f6f 7422 2c20 7222 2f64 6973 6162  eboot", r"/disab
+00004c20: 6c65 2d64 6576 6963 6522 2c20 6465 7669  le-device", devi
+00004c30: 6365 5f69 6e73 7461 6e63 655f 6964 5d29  ce_instance_id])
+00004c40: 0d0a 2020 2020 2020 2020 7375 6270 726f  ..        subpro
+00004c50: 6365 7373 2e72 756e 285b 2270 6e70 7574  cess.run(["pnput
+00004c60: 696c 222c 2072 222f 7265 626f 6f74 222c  il", r"/reboot",
+00004c70: 2072 222f 656e 6162 6c65 2d64 6576 6963   r"/enable-devic
+00004c80: 6522 2c20 6465 7669 6365 5f69 6e73 7461  e", device_insta
+00004c90: 6e63 655f 6964 5d29 0d0a 2727 270d 0a20  nce_id])..'''.. 
+00004ca0: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
+00004cb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004cc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004cd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004ce0: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+00004cf0: 0a20 2020 2023 2055 7469 6c69 7479 204d  .    # Utility M
+00004d00: 6574 686f 6473 0d0a 2020 2020 2320 2323  ethods..    # ##
+00004d10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004d20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004d30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004d40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004d50: 2323 2323 2323 2323 0d0a 0d0a 2020 0d0a  ########....  ..
+00004d60: 2020 2020 6465 6620 5f74 6f34 3062 6974      def _to40bit
+00004d70: 2873 656c 662c 2076 616c 293a 0d0a 2020  (self, val):..  
+00004d80: 2020 2020 2020 2222 220d 0a20 2020 2020        """..     
+00004d90: 2020 204c 6173 6572 206d 6f64 756c 6174     Laser modulat
+00004da0: 696f 6e20 616e 6420 636f 6e74 696e 756f  ion and continuo
+00004db0: 7573 2d73 7472 6f62 6520 636f 6d6d 616e  us-strobe comman
+00004dc0: 6473 2074 616b 6520 6172 6775 6d65 6e74  ds take argument
+00004dd0: 7320 696e 206d 6963 726f 2d0d 0a20 2020  s in micro-..   
+00004de0: 2020 2020 2073 6563 6f6e 6473 2061 7320       seconds as 
+00004df0: 3430 2d62 6974 2076 616c 7565 732c 2077  40-bit values, w
+00004e00: 6865 7265 2074 6865 206c 6561 7374 2d73  here the least-s
+00004e10: 6967 6e69 6669 6361 6e74 2031 3620 6269  ignificant 16 bi
+00004e20: 7473 2061 7265 2070 6173 7365 640d 0a20  ts are passed.. 
+00004e30: 2020 2020 2020 2061 7320 7756 616c 7565         as wValue
+00004e40: 2c20 7468 6520 6e65 7874 2d73 6967 6e69  , the next-signi
+00004e50: 6669 6361 6e74 2031 3620 6173 2077 496e  ficant 16 as wIn
+00004e60: 6465 782c 2061 6e64 2074 6865 206d 6f73  dex, and the mos
+00004e70: 742d 7369 676e 6966 6963 616e 740d 0a20  t-significant.. 
+00004e80: 2020 2020 2020 2061 7320 6120 7369 6e67         as a sing
+00004e90: 6c65 2062 7974 6520 6f66 2070 6179 6c6f  le byte of paylo
+00004ea0: 6164 2e20 2054 6869 7320 6675 6e63 7469  ad.  This functi
+00004eb0: 6f6e 2074 616b 6573 2061 6e20 756e 7369  on takes an unsi
+00004ec0: 676e 6564 2069 6e74 6567 7261 6c0d 0a20  gned integral.. 
+00004ed0: 2020 2020 2020 2076 616c 7565 2028 7072         value (pr
+00004ee0: 6573 756d 6162 6c79 206d 6963 726f 7365  esumably microse
+00004ef0: 636f 6e64 7329 2061 6e64 2072 6574 7572  conds) and retur
+00004f00: 6e73 2061 2074 7570 6c65 206f 6620 7756  ns a tuple of wV
+00004f10: 616c 7565 2c20 7749 6e64 6578 0d0a 2020  alue, wIndex..  
+00004f20: 2020 2020 2020 616e 6420 6120 6275 6666        and a buff
+00004f30: 6572 2074 6f20 7061 7373 2061 7320 7061  er to pass as pa
+00004f40: 796c 6f61 642e 0d0a 2020 2020 2020 2020  yload...        
+00004f50: 2222 220d 0a20 2020 2020 2020 206c 7377  """..        lsw
+00004f60: 203d 2076 616c 2026 2030 7866 6666 660d   = val & 0xffff.
+00004f70: 0a20 2020 2020 2020 206d 7377 203d 2028  .        msw = (
+00004f80: 7661 6c20 3e3e 2031 3629 2026 2030 7866  val >> 16) & 0xf
+00004f90: 6666 660d 0a20 2020 2020 2020 2062 7566  fff..        buf
+00004fa0: 203d 205b 2028 7661 6c20 3e3e 2033 3229   = [ (val >> 32)
+00004fb0: 2026 2030 7866 662c 2030 202a 2037 205d   & 0xff, 0 * 7 ]
+00004fc0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00004fd0: 2028 6c73 772c 206d 7377 2c20 6275 6629   (lsw, msw, buf)
+00004fe0: 0d0a 0d0a 2020 2020 6465 6620 5f77 6169  ....    def _wai
+00004ff0: 745f 666f 725f 7573 625f 6176 6169 6c61  t_for_usb_availa
+00005000: 626c 6528 7365 6c66 293a 2023 202d 3e20  ble(self): # -> 
+00005010: 4e6f 6e65 200d 0a20 2020 2020 2020 2022  None ..        "
+00005020: 2222 0d0a 2020 2020 2020 2020 5761 6974  ""..        Wait
+00005030: 2075 6e74 696c 2061 6e79 2065 6e66 6f72   until any enfor
+00005040: 6365 6420 5553 4220 7061 636b 6574 2069  ced USB packet i
+00005050: 6e74 6572 7661 6c73 2068 6176 6520 656c  ntervals have el
+00005060: 6170 7365 642e 2054 6869 7320 646f 6573  apsed. This does
+00005070: 0d0a 2020 2020 2020 2020 6e6f 7468 696e  ..        nothin
+00005080: 6720 696e 206d 6f73 7420 6361 7365 7320  g in most cases 
+00005090: 2d20 7468 6520 6675 6e63 7469 6f6e 2069  - the function i
+000050a0: 7320 6e6f 726d 616c 6c79 2061 206e 6f2d  s normally a no-
+000050b0: 6f70 2e0d 0a20 2020 2020 2020 2048 6f77  op...        How
+000050c0: 6576 6572 2c20 6966 2074 6865 2061 7070  ever, if the app
+000050d0: 6c69 6361 7469 6f6e 2068 6173 2064 6566  lication has def
+000050e0: 696e 6564 206d 696e 2f6d 6178 5f75 7362  ined min/max_usb
+000050f0: 5f69 6e74 6572 7661 6c5f 6d73 2028 7361  _interval_ms (sa
+00005100: 790d 0a20 2020 2020 2020 2028 3230 2c20  y..        (20, 
+00005110: 3530 6d73 292c 2074 6865 6e20 7069 636b  50ms), then pick
+00005120: 2061 2072 616e 646f 6d20 6465 6c61 7920   a random delay 
+00005130: 696e 2074 6865 2064 6566 696e 6564 2077  in the defined w
+00005140: 696e 646f 7720 2865 2e67 2e20 3337 6d73  indow (e.g. 37ms
+00005150: 290d 0a20 2020 2020 2020 2061 6e64 2073  )..        and s
+00005160: 6c65 6570 2075 6e74 696c 2069 7420 6861  leep until it ha
+00005170: 7320 6265 656e 2061 7420 6c65 6173 7420  s been at least 
+00005180: 7468 6174 206c 6f6e 6720 7369 6e63 6520  that long since 
+00005190: 7468 6520 6c61 7374 2055 5342 0d0a 2020  the last USB..  
+000051a0: 2020 2020 2020 6578 6368 616e 6765 2e0d        exchange..
+000051b0: 0a20 2020 2020 2020 2054 6865 2070 7572  .        The pur
+000051c0: 706f 7365 206f 6620 7468 6973 2066 756e  pose of this fun
+000051d0: 6374 696f 6e20 7761 7320 746f 2077 7269  ction was to wri
+000051e0: 6e67 2d6f 7574 2073 6f6d 6520 6561 726c  ng-out some earl
+000051f0: 7920 4152 4d20 6d69 6372 6f2d 0d0a 2020  y ARM micro-..  
+00005200: 2020 2020 2020 636f 6e74 726f 6c6c 6572        controller
+00005210: 7320 7769 7468 2061 7070 6172 656e 7420  s with apparent 
+00005220: 7469 6d69 6e67 2069 7373 7565 7320 756e  timing issues un
+00005230: 6465 7220 6869 6768 2d73 7065 6564 2055  der high-speed U
+00005240: 5342 2032 2e30 2c20 746f 2073 6565 0d0a  SB 2.0, to see..
+00005250: 2020 2020 2020 2020 6966 2063 6f6d 6d75          if commu
+00005260: 6e69 6361 7469 6f6e 7320 6973 7375 6573  nications issues
+00005270: 2064 6973 6170 7065 6172 6564 2069 6620   disappeared if 
+00005280: 7765 2065 6e66 6f72 6365 6420 6120 636f  we enforced a co
+00005290: 6d6d 756e 6963 6174 696f 6e0d 0a20 2020  mmunication..   
+000052a0: 2020 2020 206c 6174 656e 6379 2066 726f       latency fro
+000052b0: 6d20 7468 6520 736f 6674 7761 7265 2073  m the software s
+000052c0: 6964 652e 0d0a 2020 2020 2020 2020 2222  ide...        ""
+000052d0: 220d 0a20 2020 2020 2020 2069 6620 7365  "..        if se
+000052e0: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
+000052f0: 652e 6d61 785f 7573 625f 696e 7465 7276  e.max_usb_interv
+00005300: 616c 5f6d 7320 3c3d 2030 3a0d 0a20 2020  al_ms <= 0:..   
+00005310: 2020 2020 2020 2020 2072 6574 7572 6e0d           return.
+00005320: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
+00005330: 6c66 2e6c 6173 745f 7573 625f 7469 6d65  lf.last_usb_time
+00005340: 7374 616d 7020 6973 206e 6f74 204e 6f6e  stamp is not Non
+00005350: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00005360: 6465 6c61 795f 6d73 203d 2072 616e 6469  delay_ms = randi
+00005370: 6e74 2873 656c 662e 7365 7474 696e 6773  nt(self.settings
+00005380: 2e73 7461 7465 2e6d 696e 5f75 7362 5f69  .state.min_usb_i
+00005390: 6e74 6572 7661 6c5f 6d73 2c20 7365 6c66  nterval_ms, self
+000053a0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
+000053b0: 6d61 785f 7573 625f 696e 7465 7276 616c  max_usb_interval
+000053c0: 5f6d 7329 0d0a 2020 2020 2020 2020 2020  _ms)..          
+000053d0: 2020 6e65 7874 5f75 7362 5f74 696d 6573    next_usb_times
+000053e0: 7461 6d70 203d 2073 656c 662e 6c61 7374  tamp = self.last
+000053f0: 5f75 7362 5f74 696d 6573 7461 6d70 202b  _usb_timestamp +
+00005400: 2064 6174 6574 696d 652e 7469 6d65 6465   datetime.timede
+00005410: 6c74 6128 6d69 6c6c 6973 6563 6f6e 6473  lta(milliseconds
+00005420: 3d64 656c 6179 5f6d 7329 0d0a 2020 2020  =delay_ms)..    
+00005430: 2020 2020 2020 2020 6e6f 7720 3d20 6461          now = da
+00005440: 7465 7469 6d65 2e64 6174 6574 696d 652e  tetime.datetime.
+00005450: 6e6f 7728 290d 0a20 2020 2020 2020 2020  now()..         
+00005460: 2020 2069 6620 6e6f 7720 3c20 6e65 7874     if now < next
+00005470: 5f75 7362 5f74 696d 6573 7461 6d70 3a0d  _usb_timestamp:.
+00005480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005490: 2073 6c65 6570 5f73 6563 203d 2028 6e65   sleep_sec = (ne
+000054a0: 7874 5f75 7362 5f74 696d 6573 7461 6d70  xt_usb_timestamp
+000054b0: 202d 206e 6f77 292e 746f 7461 6c5f 7365   - now).total_se
+000054c0: 636f 6e64 7328 290d 0a20 2020 2020 2020  conds()..       
+000054d0: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
+000054e0: 7567 2822 6669 643a 2073 6c65 6570 696e  ug("fid: sleepin
+000054f0: 6720 252e 3366 2073 6563 2074 6f20 656e  g %.3f sec to en
+00005500: 666f 7263 6520 2564 206d 7320 5553 4220  force %d ms USB 
+00005510: 696e 7465 7276 616c 222c 2073 6c65 6570  interval", sleep
+00005520: 5f73 6563 2c20 6465 6c61 795f 6d73 290d  _sec, delay_ms).
+00005530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005540: 2073 6c65 6570 2873 6c65 6570 5f73 6563   sleep(sleep_sec
+00005550: 290d 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00005560: 6c61 7374 5f75 7362 5f74 696d 6573 7461  last_usb_timesta
+00005570: 6d70 203d 2064 6174 6574 696d 652e 6461  mp = datetime.da
+00005580: 7465 7469 6d65 2e6e 6f77 2829 0d0a 0d0a  tetime.now()....
+00005590: 2020 2020 6465 6620 5f63 6865 636b 5f66      def _check_f
+000055a0: 6f72 5f72 616e 646f 6d5f 6572 726f 7228  or_random_error(
+000055b0: 7365 6c66 293a 2023 202d 3e20 626f 6f6c  self): # -> bool
+000055c0: 200d 0a20 2020 2020 2020 2022 2222 0d0a   ..        """..
+000055d0: 2020 2020 2020 2020 5468 6973 2066 756e          This fun
+000055e0: 6374 696f 6e20 6973 2070 726f 7669 6465  ction is provide
+000055f0: 6420 746f 2073 696d 756c 6174 6520 7261  d to simulate ra
+00005600: 6e64 6f6d 2055 5342 2063 6f6d 6d75 6e69  ndom USB communi
+00005610: 6361 7469 6f6e 2065 7272 6f72 730d 0a20  cation errors.. 
+00005620: 2020 2020 2020 2064 7572 696e 6720 7265         during re
+00005630: 6772 6573 7369 6f6e 2074 6573 7469 6e67  gression testing
+00005640: 2c20 616e 6420 6973 206e 6f72 6d61 6c6c  , and is normall
+00005650: 7920 6120 6e6f 2d6f 702e 0d0a 2020 2020  y a no-op...    
+00005660: 2020 2020 2222 220d 0a20 2020 2020 2020      """..       
+00005670: 2069 6620 6e6f 7420 7365 6c66 2e69 6e6a   if not self.inj
+00005680: 6563 745f 7261 6e64 6f6d 5f65 7272 6f72  ect_random_error
+00005690: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+000056a0: 7265 7475 726e 2046 616c 7365 0d0a 0d0a  return False....
+000056b0: 2020 2020 2020 2020 6966 2072 616e 646f          if rando
+000056c0: 6d2e 7261 6e64 6f6d 2829 203c 3d20 7365  m.random() <= se
+000056d0: 6c66 2e72 616e 646f 6d5f 6572 726f 725f  lf.random_error_
+000056e0: 7065 7263 3a0d 0a20 2020 2020 2020 2020  perc:..         
+000056f0: 2020 206c 6f67 2e63 7269 7469 6361 6c28     log.critical(
+00005700: 2252 616e 646f 6d6c 792d 696e 6a65 6374  "Randomly-inject
+00005710: 6564 2065 7272 6f72 2229 0d0a 2020 2020  ed error")..    
+00005720: 2020 2020 2020 2020 7365 6c66 2e5f 7363          self._sc
+00005730: 6865 6475 6c65 5f64 6973 636f 6e6e 6563  hedule_disconnec
+00005740: 7428 4578 6365 7074 696f 6e28 2252 616e  t(Exception("Ran
+00005750: 646f 6d6c 792d 696e 6a65 6374 6564 2065  domly-injected e
+00005760: 7272 6f72 2229 290d 0a20 2020 2020 2020  rror"))..       
+00005770: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00005780: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00005790: 2046 616c 7365 0d0a 0d0a 2020 2020 2323   False....    ##
+000057a0: 0d0a 2020 2020 2320 556e 7469 6c20 7375  ..    # Until su
+000057b0: 7070 6f72 7420 666f 7220 6576 656e 2f6f  pport for even/o
+000057c0: 6464 2049 6e47 6141 7320 6761 696e 2061  dd InGaAs gain a
+000057d0: 6e64 206f 6666 7365 7420 6861 7665 2062  nd offset have b
+000057e0: 6565 6e20 6164 6465 6420 746f 2074 6865  een added to the
+000057f0: 0d0a 2020 2020 2320 6669 726d 7761 7265  ..    # firmware
+00005800: 2c20 6170 706c 7920 7468 6520 636f 7272  , apply the corr
+00005810: 6563 7469 6f6e 2069 6e20 736f 6674 7761  ection in softwa
+00005820: 7265 2e0d 0a20 2020 2064 6566 205f 636f  re...    def _co
+00005830: 7272 6563 745f 696e 6761 6173 5f67 6169  rrect_ingaas_gai
+00005840: 6e5f 616e 645f 6f66 6673 6574 2873 656c  n_and_offset(sel
+00005850: 662c 2073 7065 6374 7275 6d3a 206c 6973  f, spectrum: lis
+00005860: 745b 666c 6f61 745d 293a 2023 202d 3e20  t[float]): # -> 
+00005870: 626f 6f6c 200d 0a20 2020 2020 2020 2069  bool ..        i
+00005880: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
+00005890: 6e67 732e 6973 5f69 6e67 6161 7328 2920  ngs.is_ingaas() 
+000058a0: 6f72 2073 656c 662e 7365 7474 696e 6773  or self.settings
+000058b0: 2e65 6570 726f 6d2e 6861 7264 7761 7265  .eeprom.hardware
+000058c0: 5f65 7665 6e5f 6f64 643a 0d0a 2020 2020  _even_odd:..    
+000058d0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+000058e0: 616c 7365 0d0a 0d0a 2020 2020 2020 2020  alse....        
+000058f0: 2320 6966 2065 7665 6e20 616e 6420 6f64  # if even and od
+00005900: 6420 7069 7865 6c73 2068 6176 6520 7468  d pixels have th
+00005910: 6520 7361 6d65 2073 6574 7469 6e67 732c  e same settings,
+00005920: 2074 6865 7265 2773 206e 6f20 706f 696e   there's no poin
+00005930: 7420 696e 2064 6f69 6e67 2061 6e79 7468  t in doing anyth
+00005940: 696e 670d 0a20 2020 2020 2020 2069 6620  ing..        if 
+00005950: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00005960: 7072 6f6d 2e64 6574 6563 746f 725f 6761  prom.detector_ga
+00005970: 696e 5f6f 6464 2020 203d 3d20 7365 6c66  in_odd   == self
+00005980: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00005990: 2e64 6574 6563 746f 725f 6761 696e 2061  .detector_gain a
+000059a0: 6e64 205c 0d0a 2020 2020 2020 2020 2020  nd \..          
+000059b0: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
+000059c0: 6570 726f 6d2e 6465 7465 6374 6f72 5f6f  eprom.detector_o
+000059d0: 6666 7365 745f 6f64 6420 3d3d 2073 656c  ffset_odd == sel
+000059e0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+000059f0: 6d2e 6465 7465 6374 6f72 5f6f 6666 7365  m.detector_offse
+00005a00: 743a 0d0a 2020 2020 2020 2020 2020 2020  t:..            
+00005a10: 7265 7475 726e 2046 616c 7365 0d0a 0d0a  return False....
+00005a20: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
+00005a30: 6728 2272 6573 6361 6c69 6e67 2049 6e47  g("rescaling InG
+00005a40: 6141 7320 6f64 6420 7069 7865 6c73 2066  aAs odd pixels f
+00005a50: 726f 6d20 6576 656e 2067 6169 6e20 252e  rom even gain %.
+00005a60: 3466 2c20 6f66 6673 6574 2025 6420 746f  4f, offset %d to
+00005a70: 206f 6464 2067 6169 6e20 252e 3466 2c20   odd gain %.4f, 
+00005a80: 6f66 6673 6574 2025 6422 2c0d 0a20 2020  offset %d",..   
+00005a90: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
+00005aa0: 7474 696e 6773 2e65 6570 726f 6d2e 6465  ttings.eeprom.de
+00005ab0: 7465 6374 6f72 5f67 6169 6e2c 0d0a 2020  tector_gain,..  
+00005ac0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00005ad0: 6574 7469 6e67 732e 6565 7072 6f6d 2e64  ettings.eeprom.d
+00005ae0: 6574 6563 746f 725f 6f66 6673 6574 2c0d  etector_offset,.
+00005af0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00005b00: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+00005b10: 6d2e 6465 7465 6374 6f72 5f67 6169 6e5f  m.detector_gain_
+00005b20: 6f64 642c 0d0a 2020 2020 2020 2020 2020  odd,..          
+00005b30: 2020 7365 6c66 2e73 6574 7469 6e67 732e    self.settings.
+00005b40: 6565 7072 6f6d 2e64 6574 6563 746f 725f  eeprom.detector_
+00005b50: 6f66 6673 6574 5f6f 6464 290d 0a0d 0a20  offset_odd).... 
+00005b60: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
+00005b70: 2822 6265 666f 7265 3a20 2564 2c20 2564  ("before: %d, %d
+00005b80: 2c20 2564 2c20 2564 2c20 2564 222c 2073  , %d, %d, %d", s
+00005b90: 7065 6374 7275 6d5b 305d 2c20 7370 6563  pectrum[0], spec
+00005ba0: 7472 756d 5b31 5d2c 2073 7065 6374 7275  trum[1], spectru
+00005bb0: 6d5b 325d 2c20 7370 6563 7472 756d 5b33  m[2], spectrum[3
+00005bc0: 5d2c 2073 7065 6374 7275 6d5b 345d 290d  ], spectrum[4]).
+00005bd0: 0a0d 0a20 2020 2020 2020 2023 2069 7465  ...        # ite
+00005be0: 7261 7465 206f 7665 7220 7468 6520 4f44  rate over the OD
+00005bf0: 4420 7069 7865 6c73 206f 6620 7468 6520  D pixels of the 
+00005c00: 7370 6563 7472 756d 0d0a 2020 2020 2020  spectrum..      
+00005c10: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00005c20: 2831 2c20 6c65 6e28 7370 6563 7472 756d  (1, len(spectrum
+00005c30: 292c 2032 293a 0d0a 0d0a 2020 2020 2020  ), 2):....      
+00005c40: 2020 2020 2020 2320 6261 636b 2d6f 7574        # back-out
+00005c50: 2074 6865 2069 6e63 6f72 7265 6374 6c79   the incorrectly
+00005c60: 2061 7070 6c69 6564 2022 6576 656e 2220   applied "even" 
+00005c70: 6761 696e 2061 6e64 206f 6666 7365 740d  gain and offset.
+00005c80: 0a20 2020 2020 2020 2020 2020 206f 6c64  .            old
+00005c90: 203d 2066 6c6f 6174 2873 7065 6374 7275   = float(spectru
+00005ca0: 6d5b 695d 290d 0a20 2020 2020 2020 2020  m[i])..         
+00005cb0: 2020 2072 6177 203d 2028 6f6c 6420 2d20     raw = (old - 
+00005cc0: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00005cd0: 7072 6f6d 2e64 6574 6563 746f 725f 6f66  prom.detector_of
+00005ce0: 6673 6574 2920 2f20 7365 6c66 2e73 6574  fset) / self.set
+00005cf0: 7469 6e67 732e 6565 7072 6f6d 2e64 6574  tings.eeprom.det
+00005d00: 6563 746f 725f 6761 696e 0d0a 0d0a 2020  ector_gain....  
+00005d10: 2020 2020 2020 2020 2020 2320 6170 706c            # appl
+00005d20: 7920 7468 6520 636f 7272 6563 7420 226f  y the correct "o
+00005d30: 6464 2220 6761 696e 2061 6e64 206f 6666  dd" gain and off
+00005d40: 7365 740d 0a20 2020 2020 2020 2020 2020  set..           
+00005d50: 2073 7065 6374 7275 6d5b 695d 203d 2028   spectrum[i] = (
+00005d60: 7261 7720 2a20 7365 6c66 2e73 6574 7469  raw * self.setti
+00005d70: 6e67 732e 6565 7072 6f6d 2e64 6574 6563  ngs.eeprom.detec
+00005d80: 746f 725f 6761 696e 5f6f 6464 2920 2b20  tor_gain_odd) + 
+00005d90: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00005da0: 7072 6f6d 2e64 6574 6563 746f 725f 6f66  prom.detector_of
+00005db0: 6673 6574 5f6f 6464 0d0a 0d0a 2020 2020  fset_odd....    
+00005dc0: 2020 2020 2020 2020 6966 2069 203c 2035          if i < 5
+00005dd0: 206f 7220 6920 3e20 6c65 6e28 7370 6563   or i > len(spec
+00005de0: 7472 756d 2920 2d20 353a 0d0a 2020 2020  trum) - 5:..    
+00005df0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+00005e00: 6465 6275 6728 2220 2070 6978 656c 2025  debug("  pixel %
+00005e10: 3464 3a20 6f6c 6420 252e 3266 2072 6177  4d: old %.2f raw
+00005e20: 2025 2e32 6620 6e65 7720 252e 3266 222c   %.2f new %.2f",
+00005e30: 2069 2c20 6f6c 642c 2072 6177 2c20 7370   i, old, raw, sp
+00005e40: 6563 7472 756d 5b69 5d29 0d0a 0d0a 2020  ectrum[i])....  
+00005e50: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+00005e60: 2261 6674 6572 3a20 2564 2c20 2564 2c20  "after: %d, %d, 
+00005e70: 2564 2c20 2564 2c20 2564 222c 2073 7065  %d, %d, %d", spe
+00005e80: 6374 7275 6d5b 305d 2c20 7370 6563 7472  ctrum[0], spectr
+00005e90: 756d 5b31 5d2c 2073 7065 6374 7275 6d5b  um[1], spectrum[
+00005ea0: 325d 2c20 7370 6563 7472 756d 5b33 5d2c  2], spectrum[3],
+00005eb0: 2073 7065 6374 7275 6d5b 345d 290d 0a0d   spectrum[4])...
+00005ec0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00005ed0: 5472 7565 0d0a 0d0a 2020 2020 6465 6620  True....    def 
+00005ee0: 5f61 7070 6c79 5f32 7832 5f62 696e 6e69  _apply_2x2_binni
+00005ef0: 6e67 2873 656c 662c 2073 7065 6374 7275  ng(self, spectru
+00005f00: 6d3a 206c 6973 745b 666c 6f61 745d 293a  m: list[float]):
+00005f10: 2023 202d 3e20 6c69 7374 5b66 6c6f 6174   # -> list[float
+00005f20: 5d20 0d0a 2020 2020 2020 2020 6966 206e  ] ..        if n
+00005f30: 6f74 2073 656c 662e 7365 7474 696e 6773  ot self.settings
+00005f40: 2e65 6570 726f 6d2e 6269 6e5f 3278 323a  .eeprom.bin_2x2:
+00005f50: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00005f60: 7475 726e 2073 7065 6374 7275 6d0d 0a0d  turn spectrum...
+00005f70: 0a20 2020 2020 2020 2064 6566 2062 696e  .        def bin
+00005f80: 3278 3228 6129 3a0d 0a20 2020 2020 2020  2x2(a):..       
+00005f90: 2020 2020 2069 6620 6120 6973 204e 6f6e       if a is Non
+00005fa0: 6520 6f72 206c 656e 2861 2920 3d3d 2030  e or len(a) == 0
+00005fb0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00005fc0: 2020 2072 6574 7572 6e20 610d 0a20 2020     return a..   
+00005fd0: 2020 2020 2020 2020 2062 696e 6e65 6420           binned 
+00005fe0: 3d20 5b5d 0d0a 2020 2020 2020 2020 2020  = []..          
+00005ff0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00006000: 286c 656e 2861 292d 3129 3a0d 0a20 2020  (len(a)-1):..   
+00006010: 2020 2020 2020 2020 2020 2020 2062 696e               bin
+00006020: 6e65 642e 6170 7065 6e64 2828 615b 695d  ned.append((a[i]
+00006030: 202b 2061 5b69 2b31 5d29 202f 2032 2e30   + a[i+1]) / 2.0
+00006040: 290d 0a20 2020 2020 2020 2020 2020 2062  )..            b
+00006050: 696e 6e65 642e 6170 7065 6e64 2861 5b2d  inned.append(a[-
+00006060: 315d 290d 0a20 2020 2020 2020 2020 2020  1])..           
+00006070: 2072 6574 7572 6e20 6269 6e6e 6564 0d0a   return binned..
+00006080: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00006090: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
+000060a0: 2e64 6574 6563 746f 725f 7265 6769 6f6e  .detector_region
+000060b0: 7320 6973 204e 6f6e 653a 0d0a 2020 2020  s is None:..    
+000060c0: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
+000060d0: 6728 2261 7070 6c79 696e 6720 6269 6e5f  g("applying bin_
+000060e0: 3278 3222 290d 0a20 2020 2020 2020 2020  2x2")..         
+000060f0: 2020 2072 6574 7572 6e20 6269 6e32 7832     return bin2x2
+00006100: 2873 7065 6374 7275 6d29 0d0a 0d0a 2020  (spectrum)....  
+00006110: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+00006120: 2261 7070 6c79 696e 6720 6269 6e5f 3278  "applying bin_2x
+00006130: 3220 746f 2072 6567 696f 6e73 2229 0d0a  2 to regions")..
+00006140: 2020 2020 2020 2020 636f 6d62 696e 6564          combined
+00006150: 203d 205b 5d0d 0a20 2020 2020 2020 2066   = []..        f
+00006160: 6f72 2073 7562 7370 6563 7472 756d 2069  or subspectrum i
+00006170: 6e20 7365 6c66 2e73 6574 7469 6e67 732e  n self.settings.
+00006180: 7374 6174 652e 6465 7465 6374 6f72 5f72  state.detector_r
+00006190: 6567 696f 6e73 2e73 706c 6974 2873 7065  egions.split(spe
+000061a0: 6374 7275 6d29 3a0d 0a20 2020 2020 2020  ctrum):..       
+000061b0: 2020 2020 2063 6f6d 6269 6e65 642e 6578       combined.ex
+000061c0: 7465 6e64 2862 696e 3278 3228 7375 6273  tend(bin2x2(subs
+000061d0: 7065 6374 7275 6d29 290d 0a20 2020 2020  pectrum))..     
+000061e0: 2020 2072 6574 7572 6e20 636f 6d62 696e     return combin
+000061f0: 6564 0d0a 0d0a 2020 2020 6465 6620 5f63  ed....    def _c
+00006200: 6f72 7265 6374 5f62 6164 5f70 6978 656c  orrect_bad_pixel
+00006210: 7328 7365 6c66 2c20 7370 6563 7472 756d  s(self, spectrum
+00006220: 3a20 6c69 7374 5b66 6c6f 6174 5d29 3a20  : list[float]): 
+00006230: 2320 2d3e 2062 6f6f 6c20 0d0a 2020 2020  # -> bool ..    
+00006240: 2020 2020 2222 220d 0a20 2020 2020 2020      """..       
+00006250: 2049 6620 6120 7370 6563 7472 6f6d 6574   If a spectromet
+00006260: 6572 2068 6173 2062 6164 5f70 6978 656c  er has bad_pixel
+00006270: 7320 636f 6e66 6967 7572 6564 2069 6e20  s configured in 
+00006280: 7468 6520 4545 5052 4f4d 2c20 7468 656e  the EEPROM, then
+00006290: 2061 7665 7261 6765 0d0a 2020 2020 2020   average..      
+000062a0: 2020 6f76 6572 2074 6865 6d20 696e 2074    over them in t
+000062b0: 6865 2064 7269 7665 722e 0d0a 2020 2020  he driver...    
+000062c0: 2020 2020 4e6f 7465 2074 6869 7320 6675      Note this fu
+000062d0: 6e63 7469 6f6e 206d 6f64 6966 6965 7320  nction modifies 
+000062e0: 7468 6520 7061 7373 6564 2061 7272 6179  the passed array
+000062f0: 2069 6e2d 706c 6163 652c 2072 6174 6865   in-place, rathe
+00006300: 7220 7468 616e 0d0a 2020 2020 2020 2020  r than..        
+00006310: 7265 7475 726e 696e 6720 6120 6d6f 6469  returning a modi
+00006320: 6669 6564 2063 6f70 792e 0d0a 2020 2020  fied copy...    
+00006330: 2020 2020 406e 6f74 6520 6173 7375 6d65      @note assume
+00006340: 7320 6261 645f 7069 7865 6c73 2069 7320  s bad_pixels is 
+00006350: 7072 6576 696f 7573 6c79 2073 6f72 7465  previously sorte
+00006360: 640d 0a20 2020 2020 2020 2022 2222 0d0a  d..        """..
+00006370: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00006380: 662e 7365 7474 696e 6773 2069 7320 4e6f  f.settings is No
+00006390: 6e65 206f 7220 5c0d 0a20 2020 2020 2020  ne or \..       
+000063a0: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
+000063b0: 7474 696e 6773 2e65 6570 726f 6d20 6973  ttings.eeprom is
+000063c0: 204e 6f6e 6520 6f72 205c 0d0a 2020 2020   None or \..    
+000063d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000063e0: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+000063f0: 2e62 6164 5f70 6978 656c 7320 6973 204e  .bad_pixels is N
+00006400: 6f6e 6520 6f72 205c 0d0a 2020 2020 2020  one or \..      
+00006410: 2020 2020 2020 2020 2020 6c65 6e28 7365            len(se
+00006420: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+00006430: 6f6d 2e62 6164 5f70 6978 656c 7329 203d  om.bad_pixels) =
+00006440: 3d20 3020 6f72 205c 0d0a 2020 2020 2020  = 0 or \..      
+00006450: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00006460: 6574 7469 6e67 732e 7374 6174 652e 6465  ettings.state.de
+00006470: 7465 6374 6f72 5f72 6567 696f 6e73 2069  tector_regions i
+00006480: 7320 6e6f 7420 4e6f 6e65 3a0d 0a20 2020  s not None:..   
+00006490: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000064a0: 4661 6c73 650d 0a0d 0a20 2020 2020 2020  False....       
+000064b0: 2069 6620 7370 6563 7472 756d 2069 7320   if spectrum is 
+000064c0: 4e6f 6e65 206f 7220 6c65 6e28 7370 6563  None or len(spec
+000064d0: 7472 756d 2920 3d3d 2030 3a0d 0a20 2020  trum) == 0:..   
+000064e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000064f0: 4661 6c73 650d 0a0d 0a20 2020 2020 2020  False....       
+00006500: 2070 6978 656c 7320 3d20 6c65 6e28 7370   pixels = len(sp
+00006510: 6563 7472 756d 290d 0a20 2020 2020 2020  ectrum)..       
+00006520: 2062 6164 5f70 6978 656c 7320 3d20 7365   bad_pixels = se
+00006530: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+00006540: 6f6d 2e62 6164 5f70 6978 656c 730d 0a0d  om.bad_pixels...
+00006550: 0a20 2020 2020 2020 2023 2069 7465 7261  .        # itera
+00006560: 7465 206f 7665 7220 6561 6368 2062 6164  te over each bad
+00006570: 2070 6978 656c 0d0a 2020 2020 2020 2020   pixel..        
+00006580: 6920 3d20 300d 0a20 2020 2020 2020 2077  i = 0..        w
+00006590: 6869 6c65 2069 203c 206c 656e 2862 6164  hile i < len(bad
+000065a0: 5f70 6978 656c 7329 3a0d 0a0d 0a20 2020  _pixels):....   
+000065b0: 2020 2020 2020 2020 2062 6164 5f70 6978           bad_pix
+000065c0: 203d 2062 6164 5f70 6978 656c 735b 695d   = bad_pixels[i]
+000065d0: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+000065e0: 6966 2062 6164 5f70 6978 203d 3d20 303a  if bad_pix == 0:
+000065f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006600: 2020 2320 6861 6e64 6c65 2074 6865 206c    # handle the l
+00006610: 6566 7420 6564 6765 0d0a 2020 2020 2020  eft edge..      
+00006620: 2020 2020 2020 2020 2020 6e65 7874 5f67            next_g
+00006630: 6f6f 6420 3d20 6261 645f 7069 7820 2b20  ood = bad_pix + 
+00006640: 310d 0a20 2020 2020 2020 2020 2020 2020  1..             
+00006650: 2020 2077 6869 6c65 206e 6578 745f 676f     while next_go
+00006660: 6f64 2069 6e20 6261 645f 7069 7865 6c73  od in bad_pixels
+00006670: 2061 6e64 206e 6578 745f 676f 6f64 203c   and next_good <
+00006680: 2070 6978 656c 733a 0d0a 2020 2020 2020   pixels:..      
+00006690: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+000066a0: 7874 5f67 6f6f 6420 2b3d 2031 0d0a 2020  xt_good += 1..  
+000066b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000066c0: 2020 6920 2b3d 2031 0d0a 2020 2020 2020    i += 1..      
+000066d0: 2020 2020 2020 2020 2020 6966 206e 6578            if nex
+000066e0: 745f 676f 6f64 203c 2070 6978 656c 733a  t_good < pixels:
+000066f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006700: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
+00006710: 616e 6765 286e 6578 745f 676f 6f64 293a  ange(next_good):
+00006720: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006730: 2020 2020 2020 2020 2020 7370 6563 7472            spectr
+00006740: 756d 5b6a 5d20 3d20 7370 6563 7472 756d  um[j] = spectrum
+00006750: 5b6e 6578 745f 676f 6f64 5d0d 0a20 2020  [next_good]..   
+00006760: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+00006770: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006780: 2020 2320 6669 6e64 2070 7265 7669 6f75    # find previou
+00006790: 7320 676f 6f64 2070 6978 656c 0d0a 2020  s good pixel..  
+000067a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000067b0: 6576 5f67 6f6f 6420 3d20 6261 645f 7069  ev_good = bad_pi
+000067c0: 7820 2d20 310d 0a20 2020 2020 2020 2020  x - 1..         
+000067d0: 2020 2020 2020 2077 6869 6c65 2070 7265         while pre
+000067e0: 765f 676f 6f64 2069 6e20 6261 645f 7069  v_good in bad_pi
+000067f0: 7865 6c73 2061 6e64 2070 7265 765f 676f  xels and prev_go
+00006800: 6f64 203e 3d20 303a 0d0a 2020 2020 2020  od >= 0:..      
+00006810: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00006820: 6576 5f67 6f6f 6420 2d3d 2031 0d0a 0d0a  ev_good -= 1....
+00006830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006840: 6966 2070 7265 765f 676f 6f64 203e 3d20  if prev_good >= 
+00006850: 303a 0d0a 2020 2020 2020 2020 2020 2020  0:..            
+00006860: 2020 2020 2020 2020 2320 6669 6e64 206e          # find n
+00006870: 6578 7420 676f 6f64 2070 6978 656c 0d0a  ext good pixel..
+00006880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006890: 2020 2020 6e65 7874 5f67 6f6f 6420 3d20      next_good = 
+000068a0: 6261 645f 7069 7820 2b20 310d 0a20 2020  bad_pix + 1..   
+000068b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000068c0: 2077 6869 6c65 206e 6578 745f 676f 6f64   while next_good
+000068d0: 2069 6e20 6261 645f 7069 7865 6c73 2061   in bad_pixels a
+000068e0: 6e64 206e 6578 745f 676f 6f64 203c 2070  nd next_good < p
+000068f0: 6978 656c 733a 0d0a 2020 2020 2020 2020  ixels:..        
+00006900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006910: 6e65 7874 5f67 6f6f 6420 2b3d 2031 0d0a  next_good += 1..
 00006920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006930: 2020 2020 2073 7465 7020 203d 2064 656c       step  = del
-00006940: 7461 202f 2072 6e67 0a20 2020 2020 2020  ta / rng.       
-00006950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006960: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
-00006970: 726e 6720 2d20 3129 3a0a 2020 2020 2020  rng - 1):.      
-00006980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006990: 2020 2020 2020 7370 6563 7472 756d 5b70        spectrum[p
-000069a0: 7265 765f 676f 6f64 202b 206a 202b 2031  rev_good + j + 1
-000069b0: 5d20 3d20 7370 6563 7472 756d 5b70 7265  ] = spectrum[pre
-000069c0: 765f 676f 6f64 5d20 2b20 7374 6570 202a  v_good] + step *
-000069d0: 2028 6a20 2b20 3129 0a20 2020 2020 2020   (j + 1).       
-000069e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000069f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00006a00: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
-00006a10: 7261 6e20 6f66 6620 7468 6520 6869 6768  ran off the high
-00006a20: 2065 6e64 2c20 736f 2063 6f70 792d 7269   end, so copy-ri
-00006a30: 6768 740a 2020 2020 2020 2020 2020 2020  ght.            
-00006a40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00006a50: 6a20 696e 2072 616e 6765 2862 6164 5f70  j in range(bad_p
-00006a60: 6978 2c20 7069 7865 6c73 293a 0a20 2020  ix, pixels):.   
-00006a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a80: 2020 2020 2020 2020 2073 7065 6374 7275           spectru
-00006a90: 6d5b 6a5d 203d 2073 7065 6374 7275 6d5b  m[j] = spectrum[
-00006aa0: 7072 6576 5f67 6f6f 645d 0a0a 2020 2020  prev_good]..    
-00006ab0: 2020 2020 2020 2020 2320 6164 7661 6e63          # advanc
-00006ac0: 6520 746f 206e 6578 7420 6261 6420 7069  e to next bad pi
-00006ad0: 7865 6c0a 2020 2020 2020 2020 2020 2020  xel.            
-00006ae0: 6920 2b3d 2031 0a20 2020 2020 2020 2072  i += 1.        r
-00006af0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-00006b00: 6465 6620 5f73 656e 645f 636f 6465 2873  def _send_code(s
-00006b10: 656c 662c 200a 2020 2020 2020 2020 2020  elf, .          
-00006b20: 2020 2020 2020 2020 6252 6571 7565 7374          bRequest
-00006b30: 3a20 696e 742c 200a 2020 2020 2020 2020  : int, .        
-00006b40: 2020 2020 2020 2020 2020 7756 616c 7565            wValue
-00006b50: 3a20 696e 7420 3d20 302c 200a 2020 2020  : int = 0, .    
-00006b60: 2020 2020 2020 2020 2020 2020 2020 7749                wI
-00006b70: 6e64 6578 3a20 696e 7420 3d20 302c 200a  ndex: int = 0, .
-00006b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b90: 2020 6461 7461 5f6f 725f 774c 656e 6774    data_or_wLengt
-00006ba0: 683a 2069 6e74 203d 204e 6f6e 652c 200a  h: int = None, .
+00006930: 2020 2020 2020 2020 6920 2b3d 2031 0d0a          i += 1..
+00006940: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006950: 2020 2020 2020 6966 206e 6578 745f 676f        if next_go
+00006960: 6f64 203c 2070 6978 656c 733a 0d0a 2020  od < pixels:..  
+00006970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006980: 2020 2020 2020 2320 666f 7220 6e6f 772c        # for now,
+00006990: 2064 7261 7720 6120 6c69 6e65 2062 6574   draw a line bet
+000069a0: 7765 656e 2070 7265 7669 6f75 7320 616e  ween previous an
+000069b0: 6420 6e65 7874 5f67 6f6f 6420 7069 7865  d next_good pixe
+000069c0: 6c73 0d0a 2020 2020 2020 2020 2020 2020  ls..            
+000069d0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+000069e0: 444f 3a20 636f 6e73 6964 6572 2073 6f6d  DO: consider som
+000069f0: 6520 6b69 6e64 206f 6620 6375 7276 652d  e kind of curve-
+00006a00: 6669 740d 0a20 2020 2020 2020 2020 2020  fit..           
+00006a10: 2020 2020 2020 2020 2020 2020 2064 656c               del
+00006a20: 7461 203d 2066 6c6f 6174 2873 7065 6374  ta = float(spect
+00006a30: 7275 6d5b 6e65 7874 5f67 6f6f 645d 202d  rum[next_good] -
+00006a40: 2073 7065 6374 7275 6d5b 7072 6576 5f67   spectrum[prev_g
+00006a50: 6f6f 645d 290d 0a20 2020 2020 2020 2020  ood])..         
+00006a60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00006a70: 6e67 2020 203d 206e 6578 745f 676f 6f64  ng   = next_good
+00006a80: 202d 2070 7265 765f 676f 6f64 0d0a 2020   - prev_good..  
+00006a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006aa0: 2020 2020 2020 7374 6570 2020 3d20 6465        step  = de
+00006ab0: 6c74 6120 2f20 726e 670d 0a20 2020 2020  lta / rng..     
+00006ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ad0: 2020 2066 6f72 206a 2069 6e20 7261 6e67     for j in rang
+00006ae0: 6528 726e 6720 2d20 3129 3a0d 0a20 2020  e(rng - 1):..   
+00006af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b00: 2020 2020 2020 2020 2073 7065 6374 7275           spectru
+00006b10: 6d5b 7072 6576 5f67 6f6f 6420 2b20 6a20  m[prev_good + j 
+00006b20: 2b20 315d 203d 2073 7065 6374 7275 6d5b  + 1] = spectrum[
+00006b30: 7072 6576 5f67 6f6f 645d 202b 2073 7465  prev_good] + ste
+00006b40: 7020 2a20 286a 202b 2031 290d 0a20 2020  p * (j + 1)..   
+00006b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b60: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+00006b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b80: 2320 7765 2072 616e 206f 6666 2074 6865  # we ran off the
+00006b90: 2068 6967 6820 656e 642c 2073 6f20 636f   high end, so co
+00006ba0: 7079 2d72 6967 6874 0d0a 2020 2020 2020  py-right..      
 00006bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bc0: 2020 6c61 6265 6c3a 2073 7472 203d 2022    label: str = "
-00006bd0: 222c 200a 2020 2020 2020 2020 2020 2020  ", .            
-00006be0: 2020 2020 2020 6472 795f 7275 6e3a 2062        dry_run: b
-00006bf0: 6f6f 6c20 3d20 4661 6c73 652c 200a 2020  ool = False, .  
-00006c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c10: 7265 7472 795f 6f6e 5f65 7272 6f72 3a20  retry_on_error: 
-00006c20: 626f 6f6c 203d 2046 616c 7365 2c20 0a20  bool = False, . 
-00006c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c40: 2073 7563 6365 7373 5f72 6573 756c 743a   success_result:
-00006c50: 2069 6e74 203d 2030 7830 3029 202d 3e20   int = 0x00) -> 
-00006c60: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00006c70: 6f6e 7365 3a0a 2020 2020 2020 2020 6966  onse:.        if
-00006c80: 2073 656c 662e 7368 7574 646f 776e 5f72   self.shutdown_r
-00006c90: 6571 7565 7374 6564 206f 7220 286e 6f74  equested or (not
-00006ca0: 2073 656c 662e 636f 6e6e 6563 7465 6420   self.connected 
-00006cb0: 616e 6420 6e6f 7420 7365 6c66 2e63 6f6e  and not self.con
-00006cc0: 6e65 6374 696e 6729 3a0a 2020 2020 2020  necting):.      
-00006cd0: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-00006ce0: 225f 7365 6e64 5f63 6f64 653a 206e 6f74  "_send_code: not
-00006cf0: 2061 7474 656d 7074 696e 6720 6265 6361   attempting beca
-00006d00: 7573 6520 6e6f 7420 636f 6e6e 6563 7465  use not connecte
-00006d10: 6422 290a 2020 2020 2020 2020 2020 2020  d").            
-00006d20: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-00006d30: 7465 7252 6573 706f 6e73 6528 4661 6c73  terResponse(Fals
-00006d40: 6529 0a0a 2020 2020 2020 2020 7072 6566  e)..        pref
-00006d50: 6978 203d 2022 2220 6966 206e 6f74 206c  ix = "" if not l
-00006d60: 6162 656c 2065 6c73 6520 2822 2573 3a20  abel else ("%s: 
-00006d70: 2220 2520 6c61 6265 6c29 0a20 2020 2020  " % label).     
-00006d80: 2020 2072 6573 756c 7420 3d20 4e6f 6e65     result = None
-00006d90: 0a0a 2020 2020 2020 2020 6966 2064 6174  ..        if dat
-00006da0: 615f 6f72 5f77 4c65 6e67 7468 2069 7320  a_or_wLength is 
-00006db0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00006dc0: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
-00006dd0: 6773 2e69 735f 6172 6d28 293a 0a20 2020  gs.is_arm():.   
-00006de0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00006df0: 615f 6f72 5f77 4c65 6e67 7468 203d 205b  a_or_wLength = [
-00006e00: 305d 202a 2038 0a20 2020 2020 2020 2020  0] * 8.         
-00006e10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00006e20: 2020 2020 2020 2020 2064 6174 615f 6f72           data_or
-00006e30: 5f77 4c65 6e67 7468 203d 2030 0a0a 2020  _wLength = 0..  
-00006e40: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-00006e50: 2225 735f 7365 6e64 5f63 6f64 653a 2072  "%s_send_code: r
-00006e60: 6571 7565 7374 2030 7825 3032 7820 7661  equest 0x%02x va
-00006e70: 6c75 6520 3078 2530 3478 2069 6e64 6578  lue 0x%04x index
-00006e80: 2030 7825 3034 7820 6461 7461 2f6c 656e   0x%04x data/len
-00006e90: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
-00006ea0: 2020 7072 6566 6978 2c20 6252 6571 7565    prefix, bReque
-00006eb0: 7374 2c20 7756 616c 7565 2c20 7749 6e64  st, wValue, wInd
-00006ec0: 6578 2c20 6461 7461 5f6f 725f 774c 656e  ex, data_or_wLen
-00006ed0: 6774 6829 0a0a 2020 2020 2020 2020 6966  gth)..        if
-00006ee0: 2064 7279 5f72 756e 3a0a 2020 2020 2020   dry_run:.      
-00006ef0: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
-00006f00: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-00006f10: 6528 6b65 6570 5f61 6c69 7665 3d54 7275  e(keep_alive=Tru
-00006f20: 6529 0a0a 2020 2020 2020 2020 6966 2073  e)..        if s
-00006f30: 656c 662e 5f63 6865 636b 5f66 6f72 5f72  elf._check_for_r
-00006f40: 616e 646f 6d5f 6572 726f 7228 293a 0a20  andom_error():. 
-00006f50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00006f60: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-00006f70: 7370 6f6e 7365 2870 6f69 736f 6e5f 7069  sponse(poison_pi
-00006f80: 6c6c 3d46 616c 7365 290a 0a20 2020 2020  ll=False)..     
-00006f90: 2020 2072 6574 7279 5f63 6f75 6e74 203d     retry_count =
-00006fa0: 2030 0a20 2020 2020 2020 2077 6869 6c65   0.        while
-00006fb0: 2054 7275 653a 0a20 2020 2020 2020 2020   True:.         
-00006fc0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00006fd0: 2020 2020 2020 2020 7365 6c66 2e5f 7761          self._wa
-00006fe0: 6974 5f66 6f72 5f75 7362 5f61 7661 696c  it_for_usb_avail
-00006ff0: 6162 6c65 2829 0a20 2020 2020 2020 2020  able().         
-00007000: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00007010: 7365 6c66 2e64 6576 6963 655f 7479 7065  self.device_type
-00007020: 2e63 7472 6c5f 7472 616e 7366 6572 2873  .ctrl_transfer(s
-00007030: 656c 662e 6465 7669 6365 2c0a 2020 2020  elf.device,.    
-00007040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007060: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00007070: 7834 302c 2020 2020 2020 2020 2320 484f  x40,        # HO
-00007080: 5354 5f54 4f5f 4445 5649 4345 0a20 2020  ST_TO_DEVICE.   
-00007090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070c0: 6252 6571 7565 7374 2c0a 2020 2020 2020  bRequest,.      
-000070d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070f0: 2020 2020 2020 2020 2020 2020 2077 5661               wVa
-00007100: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-00007110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007130: 2020 2020 2020 2020 7749 6e64 6578 2c0a          wIndex,.
-00007140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007170: 2020 2064 6174 615f 6f72 5f77 4c65 6e67     data_or_wLeng
-00007180: 7468 2920 2320 6164 6420 5449 4d45 4f55  th) # add TIMEOU
-00007190: 545f 4d53 2070 6172 616d 6574 6572 3f0a  T_MS parameter?.
-000071a0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000071b0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-000071c0: 6578 633a 0a20 2020 2020 2020 2020 2020  exc:.           
-000071d0: 2020 2020 206c 6f67 2e63 7269 7469 6361       log.critica
-000071e0: 6c28 2248 6172 6477 6172 6520 4661 696c  l("Hardware Fail
-000071f0: 7572 6520 4649 4420 5365 6e64 2043 6f64  ure FID Send Cod
-00007200: 6520 5072 6f62 6c65 6d20 7769 7468 2063  e Problem with c
-00007210: 7472 6c20 7472 616e 7366 6572 222c 2065  trl transfer", e
-00007220: 7863 5f69 6e66 6f3d 3129 0a20 2020 2020  xc_info=1).     
-00007230: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00007240: 5f73 6368 6564 756c 655f 6469 7363 6f6e  _schedule_discon
-00007250: 6e65 6374 2865 7863 290a 2020 2020 2020  nect(exc).      
-00007260: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00007270: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-00007280: 706f 6e73 6528 706f 6973 6f6e 5f70 696c  ponse(poison_pil
-00007290: 6c3d 5472 7565 290a 0a20 2020 2020 2020  l=True)..       
-000072a0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-000072b0: 2573 5f73 656e 645f 636f 6465 3a20 7265  %s_send_code: re
-000072c0: 7175 6573 7420 3078 2530 3278 2076 616c  quest 0x%02x val
-000072d0: 7565 2030 7825 3034 7820 696e 6465 7820  ue 0x%04x index 
-000072e0: 3078 2530 3478 2064 6174 612f 6c65 6e20  0x%04x data/len 
-000072f0: 2573 3a20 7265 7375 6c74 2025 7322 2c0a  %s: result %s",.
+00006bc0: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
+00006bd0: 2862 6164 5f70 6978 2c20 7069 7865 6c73  (bad_pix, pixels
+00006be0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00006bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c00: 7370 6563 7472 756d 5b6a 5d20 3d20 7370  spectrum[j] = sp
+00006c10: 6563 7472 756d 5b70 7265 765f 676f 6f64  ectrum[prev_good
+00006c20: 5d0d 0a0d 0a20 2020 2020 2020 2020 2020  ]....           
+00006c30: 2023 2061 6476 616e 6365 2074 6f20 6e65   # advance to ne
+00006c40: 7874 2062 6164 2070 6978 656c 0d0a 2020  xt bad pixel..  
+00006c50: 2020 2020 2020 2020 2020 6920 2b3d 2031            i += 1
+00006c60: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00006c70: 2054 7275 650d 0a0d 0a20 2020 2064 6566   True....    def
+00006c80: 205f 7365 6e64 5f63 6f64 6528 7365 6c66   _send_code(self
+00006c90: 2c20 0d0a 2020 2020 2020 2020 2020 2020  , ..            
+00006ca0: 2020 2020 2020 6252 6571 7565 7374 3a20        bRequest: 
+00006cb0: 696e 742c 200d 0a20 2020 2020 2020 2020  int, ..         
+00006cc0: 2020 2020 2020 2020 2077 5661 6c75 653a           wValue:
+00006cd0: 2069 6e74 203d 2030 2c20 0d0a 2020 2020   int = 0, ..    
+00006ce0: 2020 2020 2020 2020 2020 2020 2020 7749                wI
+00006cf0: 6e64 6578 3a20 696e 7420 3d20 302c 200d  ndex: int = 0, .
+00006d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006d10: 2020 2064 6174 615f 6f72 5f77 4c65 6e67     data_or_wLeng
+00006d20: 7468 3a20 696e 7420 3d20 4e6f 6e65 2c20  th: int = None, 
+00006d30: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006d40: 2020 2020 6c61 6265 6c3a 2073 7472 203d      label: str =
+00006d50: 2022 222c 200d 0a20 2020 2020 2020 2020   "", ..         
+00006d60: 2020 2020 2020 2020 2064 7279 5f72 756e           dry_run
+00006d70: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
+00006d80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006d90: 2020 2020 7265 7472 795f 6f6e 5f65 7272      retry_on_err
+00006da0: 6f72 3a20 626f 6f6c 203d 2046 616c 7365  or: bool = False
+00006db0: 2c20 0d0a 2020 2020 2020 2020 2020 2020  , ..            
+00006dc0: 2020 2020 2020 7375 6363 6573 735f 7265        success_re
+00006dd0: 7375 6c74 3a20 696e 7420 3d20 3078 3030  sult: int = 0x00
+00006de0: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
+00006df0: 7252 6573 706f 6e73 653a 0d0a 2020 2020  rResponse:..    
+00006e00: 2020 2020 6966 2073 656c 662e 7368 7574      if self.shut
+00006e10: 646f 776e 5f72 6571 7565 7374 6564 206f  down_requested o
+00006e20: 7220 286e 6f74 2073 656c 662e 636f 6e6e  r (not self.conn
+00006e30: 6563 7465 6420 616e 6420 6e6f 7420 7365  ected and not se
+00006e40: 6c66 2e63 6f6e 6e65 6374 696e 6729 3a0d  lf.connecting):.
+00006e50: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00006e60: 2e64 6562 7567 2822 5f73 656e 645f 636f  .debug("_send_co
+00006e70: 6465 3a20 6e6f 7420 6174 7465 6d70 7469  de: not attempti
+00006e80: 6e67 2062 6563 6175 7365 206e 6f74 2063  ng because not c
+00006e90: 6f6e 6e65 6374 6564 2229 0d0a 2020 2020  onnected")..    
+00006ea0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00006eb0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00006ec0: 6e73 6528 4661 6c73 6529 0d0a 0d0a 2020  nse(False)....  
+00006ed0: 2020 2020 2020 7072 6566 6978 203d 2022        prefix = "
+00006ee0: 2220 6966 206e 6f74 206c 6162 656c 2065  " if not label e
+00006ef0: 6c73 6520 2822 2573 3a20 2220 2520 6c61  lse ("%s: " % la
+00006f00: 6265 6c29 0d0a 2020 2020 2020 2020 7265  bel)..        re
+00006f10: 7375 6c74 203d 204e 6f6e 650d 0a0d 0a20  sult = None.... 
+00006f20: 2020 2020 2020 2069 6620 6461 7461 5f6f         if data_o
+00006f30: 725f 774c 656e 6774 6820 6973 204e 6f6e  r_wLength is Non
+00006f40: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00006f50: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+00006f60: 2e69 735f 6172 6d28 293a 0d0a 2020 2020  .is_arm():..    
+00006f70: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00006f80: 5f6f 725f 774c 656e 6774 6820 3d20 5b30  _or_wLength = [0
+00006f90: 5d20 2a20 380d 0a20 2020 2020 2020 2020  ] * 8..         
+00006fa0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00006fb0: 2020 2020 2020 2020 2020 6461 7461 5f6f            data_o
+00006fc0: 725f 774c 656e 6774 6820 3d20 300d 0a0d  r_wLength = 0...
+00006fd0: 0a20 2020 2020 2020 206c 6f67 2e64 6562  .        log.deb
+00006fe0: 7567 2822 2573 5f73 656e 645f 636f 6465  ug("%s_send_code
+00006ff0: 3a20 7265 7175 6573 7420 3078 2530 3278  : request 0x%02x
+00007000: 2076 616c 7565 2030 7825 3034 7820 696e   value 0x%04x in
+00007010: 6465 7820 3078 2530 3478 2064 6174 612f  dex 0x%04x data/
+00007020: 6c65 6e20 2573 222c 0d0a 2020 2020 2020  len %s",..      
+00007030: 2020 2020 2020 7072 6566 6978 2c20 6252        prefix, bR
+00007040: 6571 7565 7374 2c20 7756 616c 7565 2c20  equest, wValue, 
+00007050: 7749 6e64 6578 2c20 6461 7461 5f6f 725f  wIndex, data_or_
+00007060: 774c 656e 6774 6829 0d0a 0d0a 2020 2020  wLength)....    
+00007070: 2020 2020 6966 2064 7279 5f72 756e 3a0d      if dry_run:.
+00007080: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00007090: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+000070a0: 5265 7370 6f6e 7365 286b 6565 705f 616c  Response(keep_al
+000070b0: 6976 653d 5472 7565 290d 0a0d 0a20 2020  ive=True)....   
+000070c0: 2020 2020 2069 6620 7365 6c66 2e5f 6368       if self._ch
+000070d0: 6563 6b5f 666f 725f 7261 6e64 6f6d 5f65  eck_for_random_e
+000070e0: 7272 6f72 2829 3a0d 0a20 2020 2020 2020  rror():..       
+000070f0: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
+00007100: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00007110: 2870 6f69 736f 6e5f 7069 6c6c 3d46 616c  (poison_pill=Fal
+00007120: 7365 290d 0a0d 0a20 2020 2020 2020 2072  se)....        r
+00007130: 6574 7279 5f63 6f75 6e74 203d 2030 0d0a  etry_count = 0..
+00007140: 2020 2020 2020 2020 7768 696c 6520 5472          while Tr
+00007150: 7565 3a0d 0a20 2020 2020 2020 2020 2020  ue:..           
+00007160: 2074 7279 3a0d 0a20 2020 2020 2020 2020   try:..         
+00007170: 2020 2020 2020 2073 656c 662e 5f77 6169         self._wai
+00007180: 745f 666f 725f 7573 625f 6176 6169 6c61  t_for_usb_availa
+00007190: 626c 6528 290d 0a20 2020 2020 2020 2020  ble()..         
+000071a0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+000071b0: 7365 6c66 2e64 6576 6963 655f 7479 7065  self.device_type
+000071c0: 2e63 7472 6c5f 7472 616e 7366 6572 2873  .ctrl_transfer(s
+000071d0: 656c 662e 6465 7669 6365 2c0d 0a20 2020  elf.device,..   
+000071e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007210: 3078 3430 2c20 2020 2020 2020 2023 2048  0x40,        # H
+00007220: 4f53 545f 544f 5f44 4556 4943 450d 0a20  OST_TO_DEVICE.. 
+00007230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007260: 2020 6252 6571 7565 7374 2c0d 0a20 2020    bRequest,..   
+00007270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072a0: 7756 616c 7565 2c0d 0a20 2020 2020 2020  wValue,..       
+000072b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072d0: 2020 2020 2020 2020 2020 2020 7749 6e64              wInd
+000072e0: 6578 2c0d 0a20 2020 2020 2020 2020 2020  ex,..           
+000072f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00007300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007310: 7072 6566 6978 2c20 6252 6571 7565 7374  prefix, bRequest
-00007320: 2c20 7756 616c 7565 2c20 7749 6e64 6578  , wValue, wIndex
-00007330: 2c20 6461 7461 5f6f 725f 774c 656e 6774  , data_or_wLengt
-00007340: 682c 2072 6573 756c 7429 0a0a 2020 2020  h, result)..    
-00007350: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
-00007360: 6574 7279 5f6f 6e5f 6572 726f 723a 0a20  etry_on_error:. 
-00007370: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00007380: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-00007390: 6572 5265 7370 6f6e 7365 286b 6565 705f  erResponse(keep_
-000073a0: 616c 6976 653d 5472 7565 290a 0a20 2020  alive=True)..   
-000073b0: 2020 2020 2020 2020 2023 2072 6574 7279           # retry
-000073c0: 206c 6f67 6963 2065 6e61 626c 6564 2c20   logic enabled, 
-000073d0: 736f 2063 6f6d 7061 7265 2072 6573 756c  so compare resul
-000073e0: 7420 746f 2065 7870 6563 7465 640a 2020  t to expected.  
-000073f0: 2020 2020 2020 2020 2020 6d61 7463 6865            matche
-00007400: 645f 6578 7065 6374 6564 203d 2054 7275  d_expected = Tru
-00007410: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00007420: 206c 656e 2873 7563 6365 7373 5f72 6573   len(success_res
-00007430: 756c 7429 203c 206c 656e 2872 6573 756c  ult) < len(resul
-00007440: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00007450: 2020 2020 6d61 7463 6865 645f 6578 7065      matched_expe
-00007460: 6374 6564 203d 2046 616c 7365 0a20 2020  cted = False.   
-00007470: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00007480: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00007490: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-000074a0: 6e28 7375 6363 6573 735f 7265 7375 6c74  n(success_result
-000074b0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000074c0: 2020 2020 2020 2020 6966 2072 6573 756c          if resul
-000074d0: 745b 695d 2021 3d20 7375 6363 6573 735f  t[i] != success_
-000074e0: 7265 7375 6c74 5b69 5d3a 0a20 2020 2020  result[i]:.     
-000074f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007500: 2020 206d 6174 6368 6564 5f65 7870 6563     matched_expec
-00007510: 7465 6420 3d20 4661 6c73 650a 2020 2020  ted = False.    
-00007520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007530: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-00007540: 2020 2020 2020 2069 6620 6d61 7463 6865         if matche
-00007550: 645f 6578 7065 6374 6564 3a0a 2020 2020  d_expected:.    
-00007560: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00007570: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-00007580: 6573 706f 6e73 6528 6b65 6570 5f61 6c69  esponse(keep_ali
-00007590: 7665 3d54 7275 6529 0a0a 2020 2020 2020  ve=True)..      
-000075a0: 2020 2020 2020 2320 6170 7061 7265 6e74        # apparent
-000075b0: 6c79 2069 7420 6469 646e 2774 206d 6174  ly it didn't mat
-000075c0: 6368 2065 7870 6563 7465 640a 2020 2020  ch expected.    
-000075d0: 2020 2020 2020 2020 7265 7472 795f 636f          retry_co
-000075e0: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-000075f0: 2020 2020 2069 6620 7265 7472 795f 636f       if retry_co
-00007600: 756e 7420 3e20 7365 6c66 2e72 6574 7279  unt > self.retry
-00007610: 5f6d 6178 3a0a 2020 2020 2020 2020 2020  _max:.          
-00007620: 2020 2020 2020 6c6f 672e 6572 726f 7228        log.error(
-00007630: 2267 6976 696e 6720 7570 2061 6674 6572  "giving up after
-00007640: 2025 6420 7265 7472 6965 7322 2c20 7265   %d retries", re
-00007650: 7472 795f 636f 756e 7429 0a20 2020 2020  try_count).     
-00007660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00007670: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-00007680: 7370 6f6e 7365 2870 6f69 736f 6e5f 7069  sponse(poison_pi
-00007690: 6c6c 3d54 7275 6529 0a0a 2020 2020 2020  ll=True)..      
-000076a0: 2020 2020 2020 2320 7472 7920 6167 6169        # try agai
-000076b0: 6e0a 2020 2020 2020 2020 2020 2020 6c6f  n.            lo
-000076c0: 672e 6572 726f 7228 2272 6574 7279 696e  g.error("retryin
-000076d0: 6720 2861 7474 656d 7074 2025 6429 222c  g (attempt %d)",
-000076e0: 2072 6574 7279 5f63 6f75 6e74 202b 2031   retry_count + 1
-000076f0: 290a 0a20 2020 2023 2320 406e 6f74 6520  )..    ## @note 
-00007700: 7765 6972 6420 7468 6174 2073 6f20 6665  weird that so fe
-00007710: 7720 6361 6c6c 7320 746f 2074 6869 7320  w calls to this 
-00007720: 6675 6e63 7469 6f6e 206f 7665 7272 6964  function overrid
-00007730: 6520 7468 6520 6465 6661 756c 7420 774c  e the default wL
-00007740: 656e 6774 680a 2020 2020 2320 4074 6f64  ength.    # @tod
-00007750: 6f20 636f 6e73 6964 6572 2061 6464 696e  o consider addin
-00007760: 6720 7265 7472 7920 6c6f 6769 6320 6173  g retry logic as
-00007770: 2077 656c 6c0a 2020 2020 6465 6620 5f67   well.    def _g
-00007780: 6574 5f63 6f64 6528 7365 6c66 2c20 0a20  et_code(self, . 
-00007790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077a0: 2062 5265 7175 6573 743a 2069 6e74 2c20   bRequest: int, 
-000077b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000077c0: 2020 2077 5661 6c75 653a 2069 6e74 203d     wValue: int =
-000077d0: 2030 2c20 0a20 2020 2020 2020 2020 2020   0, .           
-000077e0: 2020 2020 2020 2077 496e 6465 783a 2069         wIndex: i
-000077f0: 6e74 203d 2030 2c20 0a20 2020 2020 2020  nt = 0, .       
-00007800: 2020 2020 2020 2020 2020 2077 4c65 6e67             wLeng
-00007810: 7468 3a20 696e 7420 3d20 3634 2c20 0a20  th: int = 64, . 
-00007820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007830: 206c 6162 656c 3a20 7374 7220 3d20 2222   label: str = ""
-00007840: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00007850: 2020 2020 206d 7362 5f6c 656e 3a20 696e       msb_len: in
-00007860: 7420 3d20 4e6f 6e65 2c20 0a20 2020 2020  t = None, .     
-00007870: 2020 2020 2020 2020 2020 2020 206c 7362               lsb
-00007880: 5f6c 656e 3a20 696e 7420 3d20 4e6f 6e65  _len: int = None
-00007890: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-000078a0: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-000078b0: 2020 2070 7265 6669 7820 3d20 2222 2069     prefix = "" i
-000078c0: 6620 6e6f 7420 6c61 6265 6c20 656c 7365  f not label else
-000078d0: 2028 2225 733a 2022 2025 206c 6162 656c   ("%s: " % label
-000078e0: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
-000078f0: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-00007900: 2069 6620 7365 6c66 2e73 6875 7464 6f77   if self.shutdow
-00007910: 6e5f 7265 7175 6573 7465 6420 6f72 2028  n_requested or (
-00007920: 6e6f 7420 7365 6c66 2e63 6f6e 6e65 6374  not self.connect
-00007930: 6564 2061 6e64 206e 6f74 2073 656c 662e  ed and not self.
-00007940: 636f 6e6e 6563 7469 6e67 293a 0a20 2020  connecting):.   
-00007950: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
-00007960: 7567 2822 5f67 6574 5f63 6f64 653a 206e  ug("_get_code: n
-00007970: 6f74 2061 7474 656d 7074 696e 6720 6265  ot attempting be
-00007980: 6361 7573 6520 6e6f 7420 636f 6e6e 6563  cause not connec
-00007990: 7465 6422 290a 2020 2020 2020 2020 2020  ted").          
-000079a0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-000079b0: 6d65 7465 7252 6573 706f 6e73 6528 290a  meterResponse().
-000079c0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000079d0: 2e5f 6368 6563 6b5f 666f 725f 7261 6e64  ._check_for_rand
-000079e0: 6f6d 5f65 7272 6f72 2829 3a0a 2020 2020  om_error():.    
-000079f0: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-00007a00: 6728 2272 616e 646f 6d20 6572 726f 7222  g("random error"
-00007a10: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00007a20: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
-00007a30: 7252 6573 706f 6e73 6528 706f 6973 6f6e  rResponse(poison
-00007a40: 5f70 696c 6c3d 5472 7565 290a 0a20 2020  _pill=True)..   
-00007a50: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00007a60: 2020 2020 2020 7365 6c66 2e5f 7761 6974        self._wait
-00007a70: 5f66 6f72 5f75 7362 5f61 7661 696c 6162  _for_usb_availab
-00007a80: 6c65 2829 0a20 2020 2020 2020 2020 2020  le().           
-00007a90: 2072 6573 756c 7420 3d20 7365 6c66 2e64   result = self.d
-00007aa0: 6576 6963 655f 7479 7065 2e63 7472 6c5f  evice_type.ctrl_
-00007ab0: 7472 616e 7366 6572 2873 656c 662e 6465  transfer(self.de
-00007ac0: 7669 6365 2c0a 2020 2020 2020 2020 2020  vice,.          
-00007ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007af0: 2020 2020 2030 7863 302c 2020 2020 2020       0xc0,      
-00007b00: 2020 2320 4445 5649 4345 5f54 4f5f 484f    # DEVICE_TO_HO
-00007b10: 5354 0a20 2020 2020 2020 2020 2020 2020  ST.             
-00007b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b40: 2020 6252 6571 7565 7374 2c0a 2020 2020    bRequest,.    
-00007b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b70: 2020 2020 2020 2020 2020 2077 5661 6c75             wValu
-00007b80: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00007b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007bb0: 2020 7749 6e64 6578 2c0a 2020 2020 2020    wIndex,.      
-00007bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007be0: 2020 2020 2020 2020 2077 4c65 6e67 7468           wLength
-00007bf0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00007c00: 2045 7863 6570 7469 6f6e 2061 7320 6578   Exception as ex
-00007c10: 633a 0a20 2020 2020 2020 2020 2020 206c  c:.            l
-00007c20: 6f67 2e63 7269 7469 6361 6c28 2248 6172  og.critical("Har
-00007c30: 6477 6172 6520 4661 696c 7572 6520 4649  dware Failure FI
-00007c40: 4420 4765 7420 436f 6465 2050 726f 626c  D Get Code Probl
-00007c50: 656d 2077 6974 6820 6374 726c 2074 7261  em with ctrl tra
-00007c60: 6e73 6665 7222 2c20 6578 635f 696e 666f  nsfer", exc_info
-00007c70: 3d31 290a 2020 2020 2020 2020 2020 2020  =1).            
-00007c80: 7365 6c66 2e5f 7363 6865 6475 6c65 5f64  self._schedule_d
-00007c90: 6973 636f 6e6e 6563 7428 6578 6329 0a20  isconnect(exc). 
-00007ca0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00007cb0: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-00007cc0: 7370 6f6e 7365 2870 6f69 736f 6e5f 7069  sponse(poison_pi
-00007cd0: 6c6c 3d54 7275 6529 0a0a 2020 2020 2020  ll=True)..      
-00007ce0: 2020 6c6f 672e 6465 6275 6728 2225 735f    log.debug("%s_
-00007cf0: 6765 745f 636f 6465 3a20 7265 7175 6573  get_code: reques
-00007d00: 7420 3078 2530 3278 2076 616c 7565 2030  t 0x%02x value 0
-00007d10: 7825 3034 7820 696e 6465 7820 3078 2530  x%04x index 0x%0
-00007d20: 3478 203d 205b 2573 5d22 2c0a 2020 2020  4x = [%s]",.    
-00007d30: 2020 2020 2020 2020 7072 6566 6978 2c20          prefix, 
-00007d40: 6252 6571 7565 7374 2c20 7756 616c 7565  bRequest, wValue
-00007d50: 2c20 7749 6e64 6578 2c20 7265 7375 6c74  , wIndex, result
-00007d60: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
-00007d70: 7375 6c74 2069 7320 4e6f 6e65 3a0a 2020  sult is None:.  
-00007d80: 2020 2020 2020 2020 2020 6c6f 672e 6372            log.cr
-00007d90: 6974 6963 616c 2822 5f67 6574 5f63 6f64  itical("_get_cod
-00007da0: 655b 2573 2c20 2573 5d3a 2072 6563 6569  e[%s, %s]: recei
-00007db0: 7665 6420 6e75 6c6c 222c 206c 6162 656c  ved null", label
-00007dc0: 2c20 7365 6c66 2e64 6576 6963 655f 6964  , self.device_id
-00007dd0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00007de0: 6c66 2e5f 7363 6865 6475 6c65 5f64 6973  lf._schedule_dis
-00007df0: 636f 6e6e 6563 7428 6578 6329 0a20 2020  connect(exc).   
-00007e00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00007e10: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00007e20: 6f6e 7365 286b 6565 705f 616c 6976 653d  onse(keep_alive=
-00007e30: 5472 7565 290a 0a20 2020 2020 2020 2023  True)..        #
-00007e40: 2064 656d 6172 7368 616c 6c20 6f72 2072   demarshall or r
-00007e50: 6574 7572 6e20 7261 7720 6172 7261 790a  eturn raw array.
-00007e60: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
-00007e70: 300a 2020 2020 2020 2020 6966 206d 7362  0.        if msb
-00007e80: 5f6c 656e 2069 7320 6e6f 7420 4e6f 6e65  _len is not None
-00007e90: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00007ea0: 7220 6920 696e 2072 616e 6765 286d 7362  r i in range(msb
-00007eb0: 5f6c 656e 293a 0a20 2020 2020 2020 2020  _len):.         
-00007ec0: 2020 2020 2020 2076 616c 7565 203d 2076         value = v
-00007ed0: 616c 7565 203c 3c20 3820 7c20 7265 7375  alue << 8 | resu
-00007ee0: 6c74 5b69 5d0a 2020 2020 2020 2020 2020  lt[i].          
-00007ef0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-00007f00: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-00007f10: 7461 3d76 616c 7565 290a 2020 2020 2020  ta=value).      
-00007f20: 2020 656c 6966 206c 7362 5f6c 656e 2069    elif lsb_len i
-00007f30: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00007f40: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-00007f50: 2072 616e 6765 286c 7362 5f6c 656e 293a   range(lsb_len):
-00007f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007f70: 2076 616c 7565 203d 2028 7265 7375 6c74   value = (result
-00007f80: 5b69 5d20 3c3c 2028 3820 2a20 6929 2920  [i] << (8 * i)) 
-00007f90: 7c20 7661 6c75 650a 2020 2020 2020 2020  | value.        
-00007fa0: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-00007fb0: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-00007fc0: 6461 7461 3d76 616c 7565 290a 2020 2020  data=value).    
-00007fd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00007fe0: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
-00007ff0: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-00008000: 6528 6461 7461 3d72 6573 756c 7429 0a0a  e(data=result)..
-00008010: 2020 2020 6465 6620 6765 745f 7570 7065      def get_uppe
-00008020: 725f 636f 6465 2873 656c 662c 200a 2020  r_code(self, .  
-00008030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008040: 2020 2020 2077 5661 6c75 653a 2069 6e74       wValue: int
-00008050: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00008060: 2020 2020 2020 2020 2020 7749 6e64 6578            wIndex
-00008070: 3a20 696e 7420 3d20 302c 200a 2020 2020  : int = 0, .    
-00008080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008090: 2020 2077 4c65 6e67 7468 3a20 696e 7420     wLength: int 
-000080a0: 3d20 3634 2c20 0a20 2020 2020 2020 2020  = 64, .         
-000080b0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-000080c0: 6265 6c3a 2073 7472 203d 2022 222c 200a  bel: str = "", .
-000080d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080e0: 2020 2020 2020 206d 7362 5f6c 656e 3a20         msb_len: 
-000080f0: 696e 7420 3d20 4e6f 6e65 2c20 0a20 2020  int = None, .   
-00008100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008110: 2020 2020 6c73 625f 6c65 6e3a 2069 6e74      lsb_len: int
-00008120: 203d 204e 6f6e 6529 202d 3e20 5370 6563   = None) -> Spec
-00008130: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-00008140: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00008150: 2073 656c 662e 5f67 6574 5f63 6f64 6528   self._get_code(
-00008160: 3078 6666 2c20 7756 616c 7565 2c20 7749  0xff, wValue, wI
-00008170: 6e64 6578 2c20 774c 656e 6774 682c 206c  ndex, wLength, l
-00008180: 6162 656c 3d6c 6162 656c 2c20 6d73 625f  abel=label, msb_
-00008190: 6c65 6e3d 6d73 625f 6c65 6e2c 206c 7362  len=msb_len, lsb
-000081a0: 5f6c 656e 3d6c 7362 5f6c 656e 290a 0a20  _len=lsb_len).. 
-000081b0: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
-000081c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000081d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000081e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000081f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00008200: 2020 2020 2320 696e 6974 6961 6c69 7a61      # initializa
-00008210: 7469 6f6e 0a20 2020 2023 2023 2323 2323  tion.    # #####
-00008220: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008230: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008250: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008260: 2323 2323 230a 0a20 2020 2064 6566 205f  #####..    def _
-00008270: 7265 6164 5f65 6570 726f 6d28 7365 6c66  read_eeprom(self
-00008280: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-00008290: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-000082a0: 2020 2062 7566 6665 7273 203d 205b 5d0a     buffers = [].
-000082b0: 2020 2020 2020 2020 666f 7220 7061 6765          for page
-000082c0: 2069 6e20 7261 6e67 6528 4545 5052 4f4d   in range(EEPROM
-000082d0: 2e4d 4158 5f50 4147 4553 293a 0a20 2020  .MAX_PAGES):.   
-000082e0: 2020 2020 2020 2020 2062 7566 203d 204e           buf = N
-000082f0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00008300: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00008310: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00008320: 7365 6c66 2e67 6574 5f75 7070 6572 5f63  self.get_upper_c
-00008330: 6f64 6528 3078 3031 2c20 7061 6765 2c20  ode(0x01, page, 
-00008340: 6c61 6265 6c3d 2247 4554 5f4d 4f44 454c  label="GET_MODEL
-00008350: 5f43 4f4e 4649 4728 2564 2922 2025 2070  _CONFIG(%d)" % p
-00008360: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
-00008370: 2020 2020 2062 7566 203d 2072 6573 706f       buf = respo
-00008380: 6e73 652e 6461 7461 0a20 2020 2020 2020  nse.data.       
-00008390: 2020 2020 2020 2020 2069 6620 7265 7370           if resp
-000083a0: 6f6e 7365 2e65 7272 6f72 5f6c 766c 2021  onse.error_lvl !
-000083b0: 3d20 4572 726f 724c 6576 656c 2e6f 6b3a  = ErrorLevel.ok:
-000083c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000083d0: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
-000083e0: 6f6e 7365 0a20 2020 2020 2020 2020 2020  onse.           
-000083f0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-00008400: 2020 2020 2020 2020 206c 6f67 2e65 7272           log.err
-00008410: 6f72 2822 6578 6365 7074 696f 6e20 7265  or("exception re
-00008420: 6164 696e 6720 7570 7065 725f 636f 6465  ading upper_code
-00008430: 2030 7830 3120 7769 7468 2070 6167 6520   0x01 with page 
-00008440: 2564 222c 2070 6167 652c 2065 7863 5f69  %d", page, exc_i
-00008450: 6e66 6f3d 3129 0a20 2020 2020 2020 2020  nfo=1).         
-00008460: 2020 2062 7566 5f6c 656e 203d 2030 2069     buf_len = 0 i
-00008470: 6620 6275 6620 6973 204e 6f6e 6520 656c  f buf is None el
-00008480: 7365 206c 656e 2862 7566 290a 2020 2020  se len(buf).    
-00008490: 2020 2020 2020 2020 6966 2062 7566 2069          if buf i
-000084a0: 7320 4e6f 6e65 206f 7220 6c65 6e28 6275  s None or len(bu
-000084b0: 6629 203c 2036 343a 0a20 2020 2020 2020  f) < 64:.       
-000084c0: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
-000084d0: 2275 6e61 626c 6520 746f 2072 6561 6420  "unable to read 
-000084e0: 4545 5052 4f4d 2072 6563 6569 7665 6420  EEPROM received 
-000084f0: 6275 6620 6f66 207b 6275 667d 2061 6e64  buf of {buf} and
-00008500: 206c 656e 207b 6c65 6e28 6275 6629 7d22   len {len(buf)}"
-00008510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008520: 206c 6f67 2e65 7272 6f72 286d 7367 290a   log.error(msg).
-00008530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008540: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-00008550: 7465 7252 6573 706f 6e73 6528 4661 6c73  terResponse(Fals
-00008560: 652c 2065 7272 6f72 5f6c 766c 3d45 7272  e, error_lvl=Err
-00008570: 6f72 4c65 7665 6c2e 6d65 6469 756d 2c65  orLevel.medium,e
-00008580: 7272 6f72 5f6d 7367 3d6d 7367 290a 2020  rror_msg=msg).  
-00008590: 2020 2020 2020 2020 2020 6275 6666 6572            buffer
-000085a0: 732e 6170 7065 6e64 2862 7566 290a 0a20  s.append(buf).. 
-000085b0: 2020 2020 2020 2066 6c61 745f 6275 6666         flat_buff
-000085c0: 6572 735f 616c 6c5f 6f6e 6573 203d 2054  ers_all_ones = T
-000085d0: 7275 650a 2020 2020 2020 2020 666f 7220  rue.        for 
-000085e0: 7061 6765 2069 6e20 6275 6666 6572 733a  page in buffers:
-000085f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00008600: 2062 7974 6520 696e 2070 6167 653a 0a20   byte in page:. 
-00008610: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00008620: 6c61 745f 6275 6666 6572 735f 616c 6c5f  lat_buffers_all_
-00008630: 6f6e 6573 203d 2066 6c61 745f 6275 6666  ones = flat_buff
-00008640: 6572 735f 616c 6c5f 6f6e 6573 2061 6e64  ers_all_ones and
-00008650: 2028 6279 7465 203d 3d20 3078 4646 290a   (byte == 0xFF).
-00008660: 0a20 2020 2020 2020 2069 6620 666c 6174  .        if flat
-00008670: 5f62 7566 6665 7273 5f61 6c6c 5f6f 6e65  _buffers_all_one
-00008680: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00008690: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-000086a0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-000086b0: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
-000086c0: 2253 6177 2061 6c6c 2046 7320 666f 7220  "Saw all Fs for 
-000086d0: 4545 5052 4f4d 2e20 4368 6563 6b20 4545  EEPROM. Check EE
-000086e0: 5052 4f4d 2050 726f 6772 616d 6d65 642e  PROM Programmed.
-000086f0: 222c 6572 726f 725f 6c76 6c3d 4572 726f  ",error_lvl=Erro
-00008700: 724c 6576 656c 2e6c 6f77 290a 2020 2020  rLevel.low).    
-00008710: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-00008720: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-00008730: 6461 7461 3d73 656c 662e 7365 7474 696e  data=self.settin
-00008740: 6773 2e65 6570 726f 6d2e 7061 7273 6528  gs.eeprom.parse(
-00008750: 6275 6666 6572 7329 290a 0a20 2020 2064  buffers))..    d
-00008760: 6566 2068 6173 5f6c 696e 6561 7269 7479  ef has_linearity
-00008770: 5f63 6f65 6666 7328 7365 6c66 2920 2d3e  _coeffs(self) ->
-00008780: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
-00008790: 2222 0a20 2020 2020 2020 2041 7420 6c65  "".        At le
-000087a0: 6173 7420 6f6e 6520 6c69 6e65 6172 6974  ast one linearit
-000087b0: 7920 636f 6566 6620 6973 206f 7468 6572  y coeff is other
-000087c0: 2074 6861 6e20 3020 6f72 202d 3120 2861   than 0 or -1 (a
-000087d0: 6e64 206e 6f20 4e61 4e29 2e0a 0a20 2020  nd no NaN)...   
-000087e0: 2020 2020 2050 7562 6c69 6320 6265 6361       Public beca
-000087f0: 7573 6520 7573 6564 2062 7920 7761 7361  use used by wasa
-00008800: 7463 682d 7368 656c 6c2e 0a20 2020 2020  tch-shell..     
-00008810: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00008820: 6620 7365 6c66 2e73 6574 7469 6e67 732e  f self.settings.
-00008830: 6565 7072 6f6d 2e6c 696e 6561 7269 7479  eeprom.linearity
-00008840: 5f63 6f65 6666 733a 0a20 2020 2020 2020  _coeffs:.       
-00008850: 2020 2020 2066 6f72 2063 2069 6e20 7365       for c in se
-00008860: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-00008870: 6f6d 2e6c 696e 6561 7269 7479 5f63 6f65  om.linearity_coe
-00008880: 6666 733a 0a20 2020 2020 2020 2020 2020  ffs:.           
-00008890: 2020 2020 2069 6620 6d61 7468 2e69 736e       if math.isn
-000088a0: 616e 2863 293a 0a20 2020 2020 2020 2020  an(c):.         
-000088b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000088c0: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-000088d0: 2020 2020 666f 7220 6320 696e 2073 656c      for c in sel
-000088e0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-000088f0: 6d2e 6c69 6e65 6172 6974 795f 636f 6566  m.linearity_coef
-00008900: 6673 3a0a 2020 2020 2020 2020 2020 2020  fs:.            
-00008910: 2020 2020 6966 2063 2021 3d20 3020 616e      if c != 0 an
-00008920: 6420 6320 213d 202d 313a 0a20 2020 2020  d c != -1:.     
-00008930: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00008940: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
-00008950: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-00008960: 0a20 2020 2064 6566 205f 7265 6164 5f66  .    def _read_f
-00008970: 7067 615f 636f 6d70 696c 6174 696f 6e5f  pga_compilation_
-00008980: 6f70 7469 6f6e 7328 7365 6c66 2920 2d3e  options(self) ->
-00008990: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
-000089a0: 6573 706f 6e73 6520 3d20 7365 6c66 2e67  esponse = self.g
-000089b0: 6574 5f75 7070 6572 5f63 6f64 6528 3078  et_upper_code(0x
-000089c0: 3034 2c20 6c61 6265 6c3d 2252 4541 445f  04, label="READ_
-000089d0: 434f 4d50 494c 4154 494f 4e5f 4f50 5449  COMPILATION_OPTI
-000089e0: 4f4e 5322 2c20 6c73 625f 6c65 6e3d 3229  ONS", lsb_len=2)
-000089f0: 0a20 2020 2020 2020 2077 6f72 6420 3d20  .        word = 
-00008a00: 7265 7370 6f6e 7365 2e64 6174 610a 2020  response.data.  
-00008a10: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-00008a20: 6e67 732e 6670 6761 5f6f 7074 696f 6e73  ngs.fpga_options
-00008a30: 2e70 6172 7365 2877 6f72 6429 0a0a 2020  .parse(word)..  
-00008a40: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
-00008a50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008a60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008a80: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-00008a90: 2020 2023 2041 6363 6573 736f 7273 0a20     # Accessors. 
-00008aa0: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
-00008ab0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008ac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008ad0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00008ae0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00008af0: 0a20 2020 2023 2040 746f 646f 2074 6573  .    # @todo tes
-00008b00: 7420 656e 6469 616e 206f 7264 6572 2028  t endian order (
-00008b10: 696e 2061 6e64 206f 7574 290a 2020 2020  in and out).    
-00008b20: 6465 6620 6765 745f 6261 7474 6572 795f  def get_battery_
-00008b30: 7265 6769 7374 6572 2873 656c 662c 2072  register(self, r
-00008b40: 6567 3a20 696e 7429 202d 3e20 5370 6563  eg: int) -> Spec
-00008b50: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-00008b60: 3a0a 2020 2020 2020 2020 7265 6720 3d20  :.        reg = 
-00008b70: 7265 6720 2620 3078 6666 6666 0a20 2020  reg & 0xffff.   
-00008b80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00008b90: 2e67 6574 5f75 7070 6572 5f63 6f64 6528  .get_upper_code(
-00008ba0: 3078 3134 2c20 7749 6e64 6578 3d72 6567  0x14, wIndex=reg
-00008bb0: 2c20 6c61 6265 6c3d 2247 4554 5f42 4154  , label="GET_BAT
-00008bc0: 5445 5259 5f52 4547 222c 206d 7362 5f6c  TERY_REG", msb_l
-00008bd0: 656e 3d32 290a 0a20 2020 2064 6566 2067  en=2)..    def g
-00008be0: 6574 5f62 6174 7465 7279 5f73 7461 7465  et_battery_state
-00008bf0: 5f72 6177 2873 656c 6629 202d 3e20 5370  _raw(self) -> Sp
-00008c00: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-00008c10: 7365 3a0a 2020 2020 2020 2020 2222 2252  se:.        """R
-00008c20: 6574 7269 6576 6573 2074 6865 2072 6177  etrieves the raw
-00008c30: 2062 6174 7465 7279 2072 6561 6469 6e67   battery reading
-00008c40: 2061 6e64 2074 6865 6e20 6361 6368 6573   and then caches
-00008c50: 2069 7420 666f 7220 3120 7365 6322 2222   it for 1 sec"""
-00008c60: 0a20 2020 2020 2020 206e 6f77 203d 2064  .        now = d
-00008c70: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
-00008c80: 2e6e 6f77 2829 0a20 2020 2020 2020 2069  .now().        i
-00008c90: 6620 2873 656c 662e 7365 7474 696e 6773  f (self.settings
-00008ca0: 2e73 7461 7465 2e62 6174 7465 7279 5f74  .state.battery_t
-00008cb0: 696d 6573 7461 6d70 2069 7320 6e6f 7420  imestamp is not 
-00008cc0: 4e6f 6e65 2061 6e64 206e 6f77 203c 2073  None and now < s
-00008cd0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
-00008ce0: 7465 2e62 6174 7465 7279 5f74 696d 6573  te.battery_times
-00008cf0: 7461 6d70 202b 2064 6174 6574 696d 652e  tamp + datetime.
-00008d00: 7469 6d65 6465 6c74 6128 7365 636f 6e64  timedelta(second
-00008d10: 733d 3129 293a 0a20 2020 2020 2020 2020  s=1)):.         
-00008d20: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-00008d30: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-00008d40: 6174 613d 7365 6c66 2e73 6574 7469 6e67  ata=self.setting
-00008d50: 732e 7374 6174 652e 6261 7474 6572 795f  s.state.battery_
-00008d60: 7261 7729 0a0a 2020 2020 2020 2020 7365  raw)..        se
-00008d70: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
-00008d80: 652e 6261 7474 6572 795f 7469 6d65 7374  e.battery_timest
-00008d90: 616d 7020 3d20 6e6f 770a 2020 2020 2020  amp = now.      
-00008da0: 2020 7265 7370 6f6e 7365 203d 2073 656c    response = sel
-00008db0: 662e 6765 745f 7570 7065 725f 636f 6465  f.get_upper_code
-00008dc0: 2830 7831 332c 206c 6162 656c 3d22 4745  (0x13, label="GE
-00008dd0: 545f 4241 5454 4552 595f 5354 4154 4522  T_BATTERY_STATE"
-00008de0: 2c20 6d73 625f 6c65 6e3d 3329 0a20 2020  , msb_len=3).   
-00008df0: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-00008e00: 6773 2e73 7461 7465 2e62 6174 7465 7279  gs.state.battery
-00008e10: 5f72 6177 203d 2072 6573 706f 6e73 652e  _raw = response.
-00008e20: 6461 7461 0a0a 2020 2020 2020 2020 6c6f  data..        lo
-00008e30: 672e 6465 6275 6728 2262 6174 7465 7279  g.debug("battery
-00008e40: 5f73 7461 7465 5f72 6177 3a20 7b73 656c  _state_raw: {sel
-00008e50: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-00008e60: 2e62 6174 7465 7279 5f72 6177 7d22 290a  .battery_raw}").
-00008e70: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-00008e80: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-00008e90: 6e73 6528 6461 7461 3d73 656c 662e 7365  nse(data=self.se
-00008ea0: 7474 696e 6773 2e73 7461 7465 2e62 6174  ttings.state.bat
-00008eb0: 7465 7279 5f72 6177 290a 0a20 2020 2064  tery_raw)..    d
-00008ec0: 6566 2067 6574 5f62 6174 7465 7279 5f70  ef get_battery_p
-00008ed0: 6572 6365 6e74 6167 6528 7365 6c66 2920  ercentage(self) 
-00008ee0: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-00008ef0: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-00008f00: 2072 6573 706f 6e73 6520 3d20 7365 6c66   response = self
-00008f10: 2e67 6574 5f62 6174 7465 7279 5f73 7461  .get_battery_sta
-00008f20: 7465 5f72 6177 2829 0a20 2020 2020 2020  te_raw().       
-00008f30: 2077 6f72 6420 3d20 7265 7370 6f6e 7365   word = response
-00008f40: 2e64 6174 610a 2020 2020 2020 2020 6c73  .data.        ls
-00008f50: 6220 3d20 2877 6f72 6420 3e3e 2031 3629  b = (word >> 16)
-00008f60: 2026 2030 7866 660a 2020 2020 2020 2020   & 0xff.        
-00008f70: 6d73 6220 3d20 2877 6f72 6420 3e3e 2020  msb = (word >>  
-00008f80: 3829 2026 2030 7866 660a 2020 2020 2020  8) & 0xff.      
-00008f90: 2020 7065 7263 203d 206d 7362 202b 2028    perc = msb + (
-00008fa0: 312e 3020 2a20 6c73 6220 2f20 3235 362e  1.0 * lsb / 256.
-00008fb0: 3029 0a20 2020 2020 2020 206c 6f67 2e64  0).        log.d
-00008fc0: 6562 7567 2822 6261 7474 6572 795f 7065  ebug("battery_pe
-00008fd0: 7263 3a20 252e 3266 2525 222c 2070 6572  rc: %.2f%%", per
-00008fe0: 6329 0a20 2020 2020 2020 2072 6574 7572  c).        retur
-00008ff0: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-00009000: 7370 6f6e 7365 2864 6174 613d 7065 7263  sponse(data=perc
-00009010: 290a 0a20 2020 2064 6566 2067 6574 5f62  )..    def get_b
-00009020: 6174 7465 7279 5f63 6861 7267 696e 6728  attery_charging(
-00009030: 7365 6c66 2920 2d3e 2053 7065 6374 726f  self) -> Spectro
-00009040: 6d65 7465 7252 6573 706f 6e73 653a 0a20  meterResponse:. 
-00009050: 2020 2020 2020 2072 6573 203d 2073 656c         res = sel
-00009060: 662e 6765 745f 6261 7474 6572 795f 7374  f.get_battery_st
-00009070: 6174 655f 7261 7728 290a 2020 2020 2020  ate_raw().      
-00009080: 2020 776f 7264 203d 2072 6573 2e64 6174    word = res.dat
-00009090: 610a 2020 2020 2020 2020 6368 6172 6769  a.        chargi
-000090a0: 6e67 203d 2028 3020 213d 2028 776f 7264  ng = (0 != (word
-000090b0: 2026 2030 7866 6629 290a 2020 2020 2020   & 0xff)).      
-000090c0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-000090d0: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-000090e0: 7461 3d63 6861 7267 696e 6729 0a0a 2020  ta=charging)..  
-000090f0: 2020 6465 6620 6765 745f 696e 7465 6772    def get_integr
-00009100: 6174 696f 6e5f 7469 6d65 5f6d 7328 7365  ation_time_ms(se
-00009110: 6c66 2920 2d3e 2053 7065 6374 726f 6d65  lf) -> Spectrome
-00009120: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-00009130: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00009140: 7365 6c66 2e5f 6765 745f 636f 6465 2830  self._get_code(0
-00009150: 7862 662c 206c 6162 656c 3d22 4745 545f  xbf, label="GET_
-00009160: 494e 5445 4752 4154 494f 4e5f 5449 4d45  INTEGRATION_TIME
-00009170: 5f4d 5322 2c20 6c73 625f 6c65 6e3d 3329  _MS", lsb_len=3)
-00009180: 0a20 2020 2020 2020 206d 7320 3d20 7265  .        ms = re
-00009190: 7370 6f6e 7365 2e64 6174 610a 0a20 2020  sponse.data..   
-000091a0: 2020 2020 2069 6620 7365 6c66 2e73 6574       if self.set
-000091b0: 7469 6e67 732e 7374 6174 652e 696e 7465  tings.state.inte
-000091c0: 6772 6174 696f 6e5f 7469 6d65 5f6d 7320  gration_time_ms 
-000091d0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-000091e0: 206c 6f67 2e64 6562 7567 2866 2247 4554   log.debug(f"GET
-000091f0: 5f49 4e54 4547 5241 5449 4f4e 5f54 494d  _INTEGRATION_TIM
-00009200: 455f 4d53 3a20 6e6f 7720 7b6d 737d 2229  E_MS: now {ms}")
-00009210: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00009220: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-00009230: 2e69 6e74 6567 7261 7469 6f6e 5f74 696d  .integration_tim
-00009240: 655f 6d73 203d 206d 730a 2020 2020 2020  e_ms = ms.      
-00009250: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00009260: 2020 2020 6c6f 672e 6465 6275 6728 2264      log.debug("d
-00009270: 6563 6c69 6e69 6e67 2074 6f20 696e 6974  eclining to init
-00009280: 6961 6c69 7a65 2073 6573 7369 6f6e 2069  ialize session i
-00009290: 6e74 6567 7261 7469 6f6e 5f74 696d 655f  ntegration_time_
-000092a0: 6d73 2066 726f 6d20 7370 6563 7472 6f6d  ms from spectrom
-000092b0: 6574 6572 2229 0a0a 2020 2020 2020 2020  eter")..        
-000092c0: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-000092d0: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
-000092e0: 3d6d 7329 0a0a 2020 2020 6465 6620 7365  =ms)..    def se
-000092f0: 745f 6466 755f 656e 6162 6c65 2873 656c  t_dfu_enable(sel
-00009300: 6629 202d 3e20 5370 6563 7472 6f6d 6574  f) -> Spectromet
-00009310: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-00009320: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00009330: 5075 7473 2041 524d 2d62 6173 6564 2073  Puts ARM-based s
-00009340: 7065 6374 726f 6d65 7465 7273 2069 6e74  pectrometers int
-00009350: 6f20 4465 7669 6365 2046 6972 6d77 6172  o Device Firmwar
-00009360: 6520 5570 6461 7465 2028 4446 5529 206d  e Update (DFU) m
-00009370: 6f64 652e 0a20 2020 2020 2020 2040 7761  ode..        @wa
-00009380: 726e 696e 6720 7265 666c 6173 6869 6e67  rning reflashing
-00009390: 2073 7065 6374 726f 6d65 7465 7220 6669   spectrometer fi
-000093a0: 726d 7761 7265 2077 6974 686f 7574 2073  rmware without s
-000093b0: 7065 6369 6669 6320 696e 7374 7275 6374  pecific instruct
-000093c0: 696f 6e20 616e 640a 2020 2020 2020 2020  ion and.        
-000093d0: 7375 7070 6f72 7420 6672 6f6d 2057 6173  support from Was
-000093e0: 6174 6368 2050 686f 746f 6e69 6373 2077  atch Photonics w
-000093f0: 696c 6c20 766f 6964 2079 6f75 7220 7761  ill void your wa
-00009400: 7272 616e 7479 0a20 2020 2020 2020 2022  rranty.        "
-00009410: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-00009420: 7420 7365 6c66 2e73 6574 7469 6e67 732e  t self.settings.
-00009430: 6973 5f61 726d 2829 3a0a 2020 2020 2020  is_arm():.      
-00009440: 2020 2020 2020 6d73 6720 3d20 2244 4655        msg = "DFU
-00009450: 206d 6f64 6520 6f6e 6c79 2073 7570 706f   mode only suppo
-00009460: 7274 6564 2066 6f72 2041 524d 2d62 6173  rted for ARM-bas
-00009470: 6564 2073 7065 6374 726f 6d65 7465 7273  ed spectrometers
-00009480: 220a 2020 2020 2020 2020 2020 2020 6c6f  ".            lo
-00009490: 672e 6572 726f 7228 6d73 6729 0a20 2020  g.error(msg).   
-000094a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000094b0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-000094c0: 6f6e 7365 2865 7272 6f72 5f6c 766c 3d45  onse(error_lvl=E
-000094d0: 7272 6f72 4c65 7665 6c2e 6c6f 772c 6572  rrorLevel.low,er
-000094e0: 726f 725f 6d73 673d 6d73 672c 206b 6565  ror_msg=msg, kee
-000094f0: 705f 616c 6976 653d 5472 7565 290a 0a20  p_alive=True).. 
-00009500: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00009510: 7365 6c66 2e5f 7365 6e64 5f63 6f64 6528  self._send_code(
-00009520: 3078 6665 2c20 6c61 6265 6c3d 2253 4554  0xfe, label="SET
-00009530: 5f44 4655 5f45 4e41 424c 4522 290a 0a20  _DFU_ENABLE").. 
-00009540: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
-00009550: 655f 6d65 7373 6167 6528 226d 6172 7175  e_message("marqu
-00009560: 6565 5f69 6e66 6f22 2c20 2225 7320 696e  ee_info", "%s in
-00009570: 2044 4655 206d 6f64 6522 2025 2073 656c   DFU mode" % sel
-00009580: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-00009590: 6d2e 7365 7269 616c 5f6e 756d 6265 7229  m.serial_number)
-000095a0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-000095b0: 7363 6865 6475 6c65 5f64 6973 636f 6e6e  schedule_disconn
-000095c0: 6563 7428 4578 6365 7074 696f 6e28 2244  ect(Exception("D
-000095d0: 4655 204d 6f64 6522 2929 0a20 2020 2020  FU Mode")).     
-000095e0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-000095f0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-00009600: 6174 613d 7265 7375 6c74 290a 0a20 2020  ata=result)..   
-00009610: 2064 6566 2073 6574 5f64 6574 6563 746f   def set_detecto
-00009620: 725f 6f66 6673 6574 2873 656c 662c 2076  r_offset(self, v
-00009630: 616c 7565 3a20 696e 7429 202d 3e20 5370  alue: int) -> Sp
-00009640: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-00009650: 7365 3a0a 2020 2020 2020 2020 776f 7264  se:.        word
-00009660: 203d 2075 7469 6c73 2e63 6c61 6d70 5f74   = utils.clamp_t
-00009670: 6f5f 696e 7431 3628 7661 6c75 6529 0a20  o_int16(value). 
-00009680: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
-00009690: 696e 6773 2e65 6570 726f 6d2e 6465 7465  ings.eeprom.dete
-000096a0: 6374 6f72 5f6f 6666 7365 7420 3d20 776f  ctor_offset = wo
-000096b0: 7264 0a20 2020 2020 2020 2023 206c 6f67  rd.        # log
-000096c0: 2e64 6562 7567 2822 7661 6c75 6520 2564  .debug("value %d
-000096d0: 2028 2573 2920 3d20 3078 2530 3478 2028   (%s) = 0x%04x (
-000096e0: 2573 2922 2c20 7661 6c75 652c 2066 6f72  %s)", value, for
-000096f0: 6d61 7428 7661 6c75 652c 2027 6227 292c  mat(value, 'b'),
-00009700: 2077 6f72 642c 2066 6f72 6d61 7428 776f   word, format(wo
-00009710: 7264 2c20 2762 2729 290a 2020 2020 2020  rd, 'b')).      
-00009720: 2020 7265 7475 726e 2073 656c 662e 5f73    return self._s
-00009730: 656e 645f 636f 6465 2830 7862 362c 2077  end_code(0xb6, w
-00009740: 6f72 642c 206c 6162 656c 3d22 5345 545f  ord, label="SET_
-00009750: 4445 5445 4354 4f52 5f4f 4646 5345 5422  DETECTOR_OFFSET"
-00009760: 290a 0a20 2020 2064 6566 2073 6574 5f64  )..    def set_d
-00009770: 6574 6563 746f 725f 6f66 6673 6574 5f6f  etector_offset_o
-00009780: 6464 2873 656c 662c 2076 616c 7565 3a20  dd(self, value: 
-00009790: 696e 7429 202d 3e20 5370 6563 7472 6f6d  int) -> Spectrom
-000097a0: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-000097b0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-000097c0: 662e 7365 7474 696e 6773 2e69 735f 696e  f.settings.is_in
-000097d0: 6761 6173 2829 3a0a 2020 2020 2020 2020  gaas():.        
-000097e0: 2020 2020 6c6f 672e 6465 6275 6728 2253      log.debug("S
-000097f0: 4554 5f44 4554 4543 544f 525f 4f46 4653  ET_DETECTOR_OFFS
-00009800: 4554 5f4f 4444 206f 6e6c 7920 7375 7070  ET_ODD only supp
-00009810: 6f72 7465 6420 6f6e 2049 6e47 6141 7322  orted on InGaAs"
-00009820: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00009830: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
-00009840: 7252 6573 706f 6e73 6528 6b65 6570 5f61  rResponse(keep_a
-00009850: 6c69 7665 3d54 7275 652c 6572 726f 725f  live=True,error_
-00009860: 6c76 6c3d 4572 726f 724c 6576 656c 2e6c  lvl=ErrorLevel.l
-00009870: 6f77 290a 0a20 2020 2020 2020 2077 6f72  ow)..        wor
-00009880: 6420 3d20 7574 696c 732e 636c 616d 705f  d = utils.clamp_
-00009890: 746f 5f69 6e74 3136 2876 616c 7565 290a  to_int16(value).
-000098a0: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-000098b0: 7469 6e67 732e 6565 7072 6f6d 2e64 6574  tings.eeprom.det
-000098c0: 6563 746f 725f 6f66 6673 6574 5f6f 6464  ector_offset_odd
-000098d0: 203d 2077 6f72 640a 0a20 2020 2020 2020   = word..       
-000098e0: 2072 6574 7572 6e20 7365 6c66 2e5f 7365   return self._se
-000098f0: 6e64 5f63 6f64 6528 3078 3963 2c20 776f  nd_code(0x9c, wo
-00009900: 7264 2c20 6c61 6265 6c3d 2253 4554 5f44  rd, label="SET_D
-00009910: 4554 4543 544f 525f 4f46 4653 4554 5f4f  ETECTOR_OFFSET_O
-00009920: 4444 2229 0a0a 2020 2020 6465 6620 6765  DD")..    def ge
-00009930: 745f 6465 7465 6374 6f72 5f67 6169 6e28  t_detector_gain(
-00009940: 7365 6c66 2c20 7570 6461 7465 5f73 6573  self, update_ses
-00009950: 7369 6f6e 5f65 6570 726f 6d3a 2062 6f6f  sion_eeprom: boo
-00009960: 6c20 3d20 4661 6c73 6529 202d 3e20 5370  l = False) -> Sp
-00009970: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-00009980: 7365 3a0a 2020 2020 2020 2020 2222 220a  se:.        """.
-00009990: 2020 2020 2020 2020 5265 6164 2074 6865          Read the
-000099a0: 2064 6576 6963 6520 7374 6f72 6564 2067   device stored g
-000099b0: 6169 6e2e 2020 436f 6e76 6572 7420 6672  ain.  Convert fr
-000099c0: 6f6d 2062 696e 6172 7920 2268 616c 662d  om binary "half-
-000099d0: 7072 6563 6973 696f 6e22 2066 6c6f 6174  precision" float
-000099e0: 2e0a 2020 2020 2020 2020 2d20 3173 7420  ..        - 1st 
-000099f0: 6279 7465 2028 4c53 4229 2069 7320 6269  byte (LSB) is bi
-00009a00: 6e61 7279 2065 6e63 6f64 6564 3a20 6269  nary encoded: bi
-00009a10: 7420 3020 3d20 312f 322c 2062 6974 2031  t 0 = 1/2, bit 1
-00009a20: 203d 2031 2f34 2c20 6269 7420 3220 3d20   = 1/4, bit 2 = 
-00009a30: 312f 3820 6574 632e 0a20 2020 2020 2020  1/8 etc..       
-00009a40: 202d 2032 6e64 2062 7974 6520 284d 5342   - 2nd byte (MSB
-00009a50: 2920 6973 2074 6865 2069 6e74 6567 7261  ) is the integra
-00009a60: 6c20 7061 7274 2074 6f20 7468 6520 6c65  l part to the le
-00009a70: 6674 206f 6620 7468 6520 6465 6369 6d61  ft of the decima
-00009a80: 6c0a 2020 2020 2020 2020 452e 672e 2c20  l.        E.g., 
-00009a90: 3233 3120 6465 6320 3d3d 2030 7830 3165  231 dec == 0x01e
-00009aa0: 3720 3d3d 2031 2e39 3032 3334 3337 350a  7 == 1.90234375.
-00009ab0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00009ac0: 2020 2020 7265 7320 3d20 7365 6c66 2e5f      res = self._
-00009ad0: 6765 745f 636f 6465 2830 7863 352c 206c  get_code(0xc5, l
-00009ae0: 6162 656c 3d22 4745 545f 4445 5445 4354  abel="GET_DETECT
-00009af0: 4f52 5f47 4149 4e22 290a 2020 2020 2020  OR_GAIN").      
-00009b00: 2020 7265 7375 6c74 203d 2072 6573 2e64    result = res.d
-00009b10: 6174 610a 0a20 2020 2020 2020 2069 6620  ata..        if 
-00009b20: 7265 7375 6c74 2069 7320 4e6f 6e65 3a0a  result is None:.
-00009b30: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00009b40: 3d20 2247 4554 5f44 4554 4543 544f 525f  = "GET_DETECTOR_
-00009b50: 4741 494e 2072 6574 7572 6e65 6420 4e55  GAIN returned NU
-00009b60: 4c4c 2122 0a20 2020 2020 2020 2020 2020  LL!".           
-00009b70: 206c 6f67 2e65 7272 6f72 286d 7367 290a   log.error(msg).
-00009b80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00009b90: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-00009ba0: 6573 706f 6e73 6528 6572 726f 725f 6c76  esponse(error_lv
-00009bb0: 6c3d 4572 726f 724c 6576 656c 2e6d 6564  l=ErrorLevel.med
-00009bc0: 6975 6d2c 6572 726f 725f 6d73 673d 6d73  ium,error_msg=ms
-00009bd0: 672c 6b65 6570 5f61 6c69 7665 3d54 7275  g,keep_alive=Tru
-00009be0: 6529 0a0a 2020 2020 2020 2020 6c73 6220  e)..        lsb 
-00009bf0: 3d20 7265 7375 6c74 5b30 5d20 2320 4c53  = result[0] # LS
-00009c00: 422d 4d53 420a 2020 2020 2020 2020 6d73  B-MSB.        ms
-00009c10: 6220 3d20 7265 7375 6c74 5b31 5d0a 2020  b = result[1].  
-00009c20: 2020 2020 2020 7261 7720 3d20 286d 7362        raw = (msb
-00009c30: 203c 3c20 3829 207c 206c 7362 0a0a 2020   << 8) | lsb..  
-00009c40: 2020 2020 2020 6761 696e 203d 206d 7362        gain = msb
-00009c50: 202b 206c 7362 202f 2032 3536 2e30 0a20   + lsb / 256.0. 
-00009c60: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
-00009c70: 2822 6765 745f 6465 7465 6374 6f72 5f67  ("get_detector_g
-00009c80: 6169 6e3a 2025 6620 2872 6177 2030 7825  ain: %f (raw 0x%
-00009c90: 3034 7829 2028 7365 7373 696f 6e20 6565  04x) (session ee
-00009ca0: 7072 6f6d 2025 6629 2220 2520 280a 2020  prom %f)" % (.  
-00009cb0: 2020 2020 2020 2020 2020 6761 696e 2c20            gain, 
-00009cc0: 7261 772c 2073 656c 662e 7365 7474 696e  raw, self.settin
-00009cd0: 6773 2e65 6570 726f 6d2e 6465 7465 6374  gs.eeprom.detect
-00009ce0: 6f72 5f67 6169 6e29 290a 0a20 2020 2020  or_gain))..     
-00009cf0: 2020 2069 6620 7570 6461 7465 5f73 6573     if update_ses
-00009d00: 7369 6f6e 5f65 6570 726f 6d3a 0a20 2020  sion_eeprom:.   
-00009d10: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
-00009d20: 7474 696e 6773 2e65 6570 726f 6d2e 6465  ttings.eeprom.de
-00009d30: 7465 6374 6f72 5f67 6169 6e20 3d20 6761  tector_gain = ga
-00009d40: 696e 0a0a 2020 2020 2020 2020 6966 2073  in..        if s
-00009d50: 656c 662e 7365 7474 696e 6773 2e69 735f  elf.settings.is_
-00009d60: 6d69 6372 6f28 293a 0a20 2020 2020 2020  micro():.       
-00009d70: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-00009d80: 6773 2e73 7461 7465 2e67 6169 6e5f 6462  gs.state.gain_db
-00009d90: 203d 2067 6169 6e0a 0a20 2020 2020 2020   = gain..       
-00009da0: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-00009db0: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-00009dc0: 613d 6761 696e 290a 0a20 2020 2064 6566  a=gain)..    def
-00009dd0: 2067 6574 5f64 6574 6563 746f 725f 6761   get_detector_ga
-00009de0: 696e 5f6f 6464 2873 656c 662c 2075 7064  in_odd(self, upd
-00009df0: 6174 655f 7365 7373 696f 6e5f 6565 7072  ate_session_eepr
-00009e00: 6f6d 3a20 626f 6f6c 203d 2046 616c 7365  om: bool = False
-00009e10: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-00009e20: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-00009e30: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
-00009e40: 6574 7469 6e67 732e 6973 5f69 6e67 6161  ettings.is_ingaa
-00009e50: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00009e60: 206c 6f67 2e64 6562 7567 2822 4745 545f   log.debug("GET_
-00009e70: 4445 5445 4354 4f52 5f47 4149 4e5f 4f44  DETECTOR_GAIN_OD
-00009e80: 4420 6f6e 6c79 2073 7570 706f 7274 6564  D only supported
-00009e90: 206f 6e20 496e 4761 4173 2229 0a20 2020   on InGaAs").   
-00009ea0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00009eb0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00009ec0: 6f6e 7365 2864 6174 613d 7365 6c66 2e73  onse(data=self.s
-00009ed0: 6574 7469 6e67 732e 6565 7072 6f6d 2e64  ettings.eeprom.d
-00009ee0: 6574 6563 746f 725f 6761 696e 5f6f 6464  etector_gain_odd
-00009ef0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-00009f00: 7420 3d20 7365 6c66 2e5f 6765 745f 636f  t = self._get_co
-00009f10: 6465 2830 7839 662c 206c 6162 656c 3d22  de(0x9f, label="
-00009f20: 4745 545f 4445 5445 4354 4f52 5f47 4149  GET_DETECTOR_GAI
-00009f30: 4e5f 4f44 4422 290a 0a20 2020 2020 2020  N_ODD")..       
-00009f40: 206c 7362 203d 2072 6573 756c 745b 305d   lsb = result[0]
-00009f50: 2023 204c 5342 2d4d 5342 0a20 2020 2020   # LSB-MSB.     
-00009f60: 2020 206d 7362 203d 2072 6573 756c 745b     msb = result[
-00009f70: 315d 0a20 2020 2020 2020 2072 6177 203d  1].        raw =
-00009f80: 2028 6d73 6220 3c3c 2038 2920 7c20 6c73   (msb << 8) | ls
-00009f90: 620a 0a20 2020 2020 2020 2067 6169 6e20  b..        gain 
-00009fa0: 3d20 6d73 6220 2b20 6c73 6220 2f20 3235  = msb + lsb / 25
-00009fb0: 362e 300a 2020 2020 2020 2020 6c6f 672e  6.0.        log.
-00009fc0: 6465 6275 6728 2267 6574 5f64 6574 6563  debug("get_detec
-00009fd0: 746f 725f 6761 696e 5f6f 6464 3a20 2566  tor_gain_odd: %f
-00009fe0: 2028 3078 2530 3478 2920 2873 6573 7369   (0x%04x) (sessi
-00009ff0: 6f6e 2065 6570 726f 6d20 2566 2922 2025  on eeprom %f)" %
-0000a000: 2028 0a20 2020 2020 2020 2020 2020 2067   (.            g
-0000a010: 6169 6e2c 2072 6177 2c20 7365 6c66 2e73  ain, raw, self.s
-0000a020: 6574 7469 6e67 732e 6565 7072 6f6d 2e64  ettings.eeprom.d
-0000a030: 6574 6563 746f 725f 6761 696e 5f6f 6464  etector_gain_odd
-0000a040: 2929 0a20 2020 2020 2020 2069 6620 7570  )).        if up
-0000a050: 6461 7465 5f73 6573 7369 6f6e 5f65 6570  date_session_eep
-0000a060: 726f 6d3a 0a20 2020 2020 2020 2020 2020  rom:.           
-0000a070: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-0000a080: 6570 726f 6d2e 6465 7465 6374 6f72 5f67  eprom.detector_g
-0000a090: 6169 6e5f 6f64 6420 3d20 6761 696e 0a20  ain_odd = gain. 
-0000a0a0: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
-0000a0b0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0000a0c0: 7365 2864 6174 613d 6761 696e 290a 0a20  se(data=gain).. 
-0000a0d0: 2020 2023 230a 2020 2020 2320 4e6f 7465     ##.    # Note
-0000a0e0: 2074 6861 7420 7468 6973 2069 7320 7573   that this is us
-0000a0f0: 6564 2066 6f72 2064 6574 6563 746f 7220  ed for detector 
-0000a100: 7479 7065 732c 2069 6e63 6c75 6469 6e67  types, including
-0000a110: 3a0a 2020 2020 230a 2020 2020 2320 2d20  :.    #.    # - 
-0000a120: 4861 6d61 6d61 7473 7520 7369 6c69 636f  Hamamatsu silico
-0000a130: 6e20 2853 3136 3031 302d 2a2c 2053 3136  n (S16010-*, S16
-0000a140: 3031 312d 2a2c 2065 7463 290a 2020 2020  011-*, etc).    
-0000a150: 2320 2d20 4861 6d61 6d61 7473 7520 496e  # - Hamamatsu In
-0000a160: 4761 4173 2028 4739 3231 3420 6574 6329  GaAs (G9214 etc)
-0000a170: 0a20 2020 2023 202d 2053 6f6e 7920 494d  .    # - Sony IM
-0000a180: 5820 2849 4d58 3338 3520 6574 6329 0a20  X (IMX385 etc). 
-0000a190: 2020 2023 0a20 2020 2023 2049 7420 6973     #.    # It is
-0000a1a0: 2069 6d70 6f72 7461 6e74 2074 6f20 756e   important to un
-0000a1b0: 6465 7273 7461 6e64 2074 6861 7420 7468  derstand that th
-0000a1c0: 6520 554e 4954 206f 6620 7468 6973 2076  e UNIT of this v
-0000a1d0: 616c 7565 2063 6861 6e67 6573 2062 6574  alue changes bet
-0000a1e0: 7765 656e 0a20 2020 2023 2048 616d 616d  ween.    # Hamam
-0000a1f0: 6174 7375 2061 6e64 2049 4d58 2064 6574  atsu and IMX det
-0000a200: 6563 746f 7273 2c20 6275 7420 7468 6520  ectors, but the 
-0000a210: 4441 5441 5459 5045 2064 6f65 7320 6e6f  DATATYPE does no
-0000a220: 742e 0a20 2020 2023 0a20 2020 2023 2052  t..    #.    # R
-0000a230: 6561 736f 6e61 626c 6520 6761 696e 206c  easonable gain l
-0000a240: 6576 656c 7320 666f 7220 4861 6d61 6d61  evels for Hamama
-0000a250: 7473 7520 6172 6520 6120 666c 6f61 7469  tsu are a floati
-0000a260: 6e67 2d70 6f69 6e74 2073 6361 6c61 722c  ng-point scalar,
-0000a270: 206c 6974 6572 616c 6c79 0a20 2020 2023   literally.    #
-0000a280: 2075 7365 6420 746f 2073 6361 6c65 2028   used to scale (
-0000a290: 6761 696e 2920 7468 6520 7369 676e 616c  gain) the signal
-0000a2a0: 2c20 616e 6420 6172 6520 7573 7561 6c6c  , and are usuall
-0000a2b0: 7920 696e 2074 6865 2072 616e 6765 2028  y in the range (
-0000a2c0: 302e 3820 2e2e 2031 2e32 290a 2020 2020  0.8 .. 1.2).    
-0000a2d0: 2320 6f72 2074 6865 7265 6162 6f75 7473  # or thereabouts
-0000a2e0: 2e0a 2020 2020 230a 2020 2020 2320 5265  ..    #.    # Re
-0000a2f0: 6173 6f6e 6162 6c65 206c 6576 656c 7320  asonable levels 
-0000a300: 666f 7220 494d 5820 7365 6e73 6f72 7320  for IMX sensors 
-0000a310: 6172 6520 696e 2064 4220 616e 6420 7661  are in dB and va
-0000a320: 7279 2062 7920 6465 7465 6374 6f72 2c20  ry by detector, 
-0000a330: 6275 7420 6172 650a 2020 2020 2320 7573  but are.    # us
-0000a340: 7561 6c6c 7920 696e 2074 6865 2072 616e  ually in the ran
-0000a350: 6765 2028 302e 3020 2e2e 2033 312e 3029  ge (0.0 .. 31.0)
-0000a360: 2c20 7769 7468 2065 7861 6374 6c79 2030  , with exactly 0
-0000a370: 2e31 6442 2070 7265 6369 7369 6f6e 2e20  .1dB precision. 
-0000a380: 2054 6865 0a20 2020 2023 2073 7065 6374   The.    # spect
-0000a390: 726f 6d65 7465 7227 7320 4657 2077 696c  rometer's FW wil
-0000a3a0: 6c20 726f 756e 6420 746f 2074 6865 206e  l round to the n
-0000a3b0: 6561 7265 7374 2073 6574 7469 6e67 2028  earest setting (
-0000a3c0: 312e 3233 2077 696c 6c20 6265 2072 6f75  1.23 will be rou
-0000a3d0: 6e64 6564 0a20 2020 2023 2074 6f20 312e  nded.    # to 1.
-0000a3e0: 3229 2e20 2049 4d58 2073 656e 736f 7273  2).  IMX sensors
-0000a3f0: 2073 7769 7463 6820 6672 6f6d 2022 616e   switch from "an
-0000a400: 616c 6f67 2067 6169 6e22 2074 6f20 2264  alog gain" to "d
-0000a410: 6967 6974 616c 2067 6169 6e22 2061 626f  igital gain" abo
-0000a420: 7665 0a20 2020 2023 2061 2067 6976 656e  ve.    # a given
-0000a430: 2074 6872 6573 686f 6c64 2e2e 2e6f 6e20   threshold...on 
-0000a440: 7468 6520 494d 5831 3233 2c20 616e 616c  the IMX123, anal
-0000a450: 6f67 2067 6169 6e20 6973 2030 2e30 202d  og gain is 0.0 -
-0000a460: 2033 312e 302c 2061 6e64 2064 6967 6974   31.0, and digit
-0000a470: 616c 0a20 2020 2023 2069 7320 3331 2e31  al.    # is 31.1
-0000a480: 202d 2037 322e 3020 2849 2074 6869 6e6b   - 72.0 (I think
-0000a490: 292e 0a20 2020 2023 0a20 2020 2023 2040  )..    #.    # @
-0000a4a0: 7365 6520 6874 7470 733a 2f2f 7761 7361  see https://wasa
-0000a4b0: 7463 6870 686f 746f 6e69 6373 2e63 6f6d  tchphotonics.com
-0000a4c0: 2f61 7069 2f57 6173 6174 6368 2e4e 4554  /api/Wasatch.NET
-0000a4d0: 2f63 6c61 7373 5f77 6173 6174 6368 5f6e  /class_wasatch_n
-0000a4e0: 5f65 5f74 5f31 5f31 5f66 756e 6b79 5f66  _e_t_1_1_funky_f
-0000a4f0: 6c6f 6174 2e68 746d 6c0a 2020 2020 6465  loat.html.    de
-0000a500: 6620 7365 745f 6465 7465 6374 6f72 5f67  f set_detector_g
-0000a510: 6169 6e28 7365 6c66 2c20 6761 696e 3a20  ain(self, gain: 
-0000a520: 666c 6f61 7429 202d 3e20 5370 6563 7472  float) -> Spectr
-0000a530: 6f6d 6574 6572 5265 7370 6f6e 7365 3a0a  ometerResponse:.
-0000a540: 2020 2020 2020 2020 7261 7720 3d20 7365          raw = se
-0000a550: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-0000a560: 6f6d 2e66 6c6f 6174 5f74 6f5f 7569 6e74  om.float_to_uint
-0000a570: 3136 2867 6169 6e29 0a0a 2020 2020 2020  16(gain)..      
-0000a580: 2020 2320 4d5a 3a20 6e6f 7465 2074 6861    # MZ: note tha
-0000a590: 7420 7765 2053 454e 4420 6761 696e 204d  t we SEND gain M
-0000a5a0: 5342 2d4c 5342 2c20 6275 7420 7765 2052  SB-LSB, but we R
-0000a5b0: 4541 4420 6761 696e 204c 5342 2d4d 5342  EAD gain LSB-MSB
-0000a5c0: 3f21 0a20 2020 2020 2020 206c 6f67 2e64  ?!.        log.d
-0000a5d0: 6562 7567 2822 5365 6e64 2044 6574 6563  ebug("Send Detec
-0000a5e0: 746f 7220 4761 696e 3a20 3078 2530 3478  tor Gain: 0x%04x
-0000a5f0: 2028 2573 2922 2c20 7261 772c 2067 6169   (%s)", raw, gai
-0000a600: 6e29 0a20 2020 2020 2020 2073 656c 662e  n).        self.
-0000a610: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
-0000a620: 6465 7465 6374 6f72 5f67 6169 6e20 3d20  detector_gain = 
-0000a630: 6761 696e 0a20 2020 2020 2020 2072 6574  gain.        ret
-0000a640: 7572 6e20 7365 6c66 2e5f 7365 6e64 5f63  urn self._send_c
-0000a650: 6f64 6528 3078 6237 2c20 7261 772c 206c  ode(0xb7, raw, l
-0000a660: 6162 656c 3d22 5345 545f 4445 5445 4354  abel="SET_DETECT
-0000a670: 4f52 5f47 4149 4e22 290a 0a20 2020 2064  OR_GAIN")..    d
-0000a680: 6566 2073 6574 5f64 6574 6563 746f 725f  ef set_detector_
-0000a690: 6761 696e 5f6f 6464 2873 656c 662c 2067  gain_odd(self, g
-0000a6a0: 6169 6e3a 2066 6c6f 6174 2920 2d3e 2053  ain: float) -> S
-0000a6b0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0000a6c0: 6e73 653a 0a20 2020 2020 2020 2069 6620  nse:.        if 
-0000a6d0: 6e6f 7420 7365 6c66 2e73 6574 7469 6e67  not self.setting
-0000a6e0: 732e 6973 5f69 6e67 6161 7328 293a 0a20  s.is_ingaas():. 
-0000a6f0: 2020 2020 2020 2020 2020 206c 6f67 2e64             log.d
-0000a700: 6562 7567 2822 5345 545f 4445 5445 4354  ebug("SET_DETECT
-0000a710: 4f52 5f47 4149 4e5f 4f44 4420 6f6e 6c79  OR_GAIN_ODD only
-0000a720: 2073 7570 706f 7274 6564 206f 6e20 496e   supported on In
-0000a730: 4761 4173 2229 0a20 2020 2020 2020 2020  GaAs").         
-0000a740: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-0000a750: 6f6d 6574 6572 5265 7370 6f6e 7365 2865  ometerResponse(e
-0000a760: 7272 6f72 5f6c 766c 3d45 7272 6f72 4c65  rror_lvl=ErrorLe
-0000a770: 7665 6c2e 6c6f 772c 2065 7272 6f72 5f6d  vel.low, error_m
-0000a780: 7367 3d22 5345 545f 4445 5445 4354 4f52  sg="SET_DETECTOR
-0000a790: 5f47 4149 4e5f 4f44 4420 6f6e 6c79 2073  _GAIN_ODD only s
-0000a7a0: 7570 706f 7274 6564 206f 6e20 496e 4761  upported on InGa
-0000a7b0: 4173 2229 0a0a 2020 2020 2020 2020 7261  As")..        ra
-0000a7c0: 7720 3d20 7365 6c66 2e73 6574 7469 6e67  w = self.setting
-0000a7d0: 732e 6565 7072 6f6d 2e66 6c6f 6174 5f74  s.eeprom.float_t
-0000a7e0: 6f5f 7569 6e74 3136 2867 6169 6e29 0a0a  o_uint16(gain)..
-0000a7f0: 2020 2020 2020 2020 2320 4d5a 3a20 6e6f          # MZ: no
-0000a800: 7465 2074 6861 7420 7765 2053 454e 4420  te that we SEND 
-0000a810: 6761 696e 204d 5342 2d4c 5342 2c20 6275  gain MSB-LSB, bu
-0000a820: 7420 7765 2052 4541 4420 6761 696e 204c  t we READ gain L
-0000a830: 5342 2d4d 5342 3f21 0a20 2020 2020 2020  SB-MSB?!.       
-0000a840: 206c 6f67 2e64 6562 7567 2822 5365 6e64   log.debug("Send
-0000a850: 2044 6574 6563 746f 7220 4761 696e 204f   Detector Gain O
-0000a860: 6464 3a20 3078 2530 3478 2028 2573 2922  dd: 0x%04x (%s)"
-0000a870: 2c20 7261 772c 2067 6169 6e29 0a20 2020  , raw, gain).   
-0000a880: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-0000a890: 6773 2e65 6570 726f 6d2e 6465 7465 6374  gs.eeprom.detect
-0000a8a0: 6f72 5f67 6169 6e5f 6f64 6420 3d20 6761  or_gain_odd = ga
-0000a8b0: 696e 0a20 2020 2020 2020 2072 6574 7572  in.        retur
-0000a8c0: 6e20 7365 6c66 2e5f 7365 6e64 5f63 6f64  n self._send_cod
-0000a8d0: 6528 3078 3964 2c20 7261 772c 206c 6162  e(0x9d, raw, lab
-0000a8e0: 656c 3d22 5345 545f 4445 5445 4354 4f52  el="SET_DETECTOR
-0000a8f0: 5f47 4149 4e5f 4f44 4422 290a 0a20 2020  _GAIN_ODD")..   
-0000a900: 2023 230a 2020 2020 2320 4869 7374 6f72   ##.    # Histor
-0000a910: 6963 616c 6c79 2c20 7468 6973 206f 7063  ically, this opc
-0000a920: 6f64 6520 6d6f 7665 6420 6172 6f75 6e64  ode moved around
-0000a930: 2061 2062 6974 2e20 2041 7420 6f6e 6520   a bit.  At one 
-0000a940: 706f 696e 7420 6974 2077 6173 2030 7865  point it was 0xe
-0000a950: 620a 2020 2020 2320 2861 6e64 2069 7320  b.    # (and is 
-0000a960: 6e6f 7720 6167 6169 6e29 2c20 7768 6963  now again), whic
-0000a970: 6820 636f 6e66 6c69 6374 7320 7769 7468  h conflicts with
-0000a980: 2043 465f 5345 4c45 4354 292e 2020 4174   CF_SELECT).  At
-0000a990: 206f 7468 6572 2074 696d 6573 2069 740a   other times it.
-0000a9a0: 2020 2020 2320 7761 7320 3078 6539 2c20      # was 0xe9, 
-0000a9b0: 7768 6963 6820 636f 6e66 6c69 6374 6564  which conflicted
-0000a9c0: 2077 6974 6820 4c41 5345 525f 5241 4d50   with LASER_RAMP
-0000a9d0: 5f45 4e41 424c 452e 2020 5468 6973 2073  _ENABLE.  This s
-0000a9e0: 6565 6d73 2074 6f20 6265 2077 6861 740a  eems to be what.
-0000a9f0: 2020 2020 2320 7765 2772 6520 7374 616e      # we're stan
-0000aa00: 6461 7264 697a 696e 6720 6f6e 2068 656e  dardizing on hen
-0000aa10: 6365 666f 7274 682e 0a20 2020 2064 6566  ceforth..    def
-0000aa20: 2073 6574 5f61 7265 615f 7363 616e 5f65   set_area_scan_e
-0000aa30: 6e61 626c 6528 7365 6c66 2c20 666c 6167  nable(self, flag
-0000aa40: 3a20 626f 6f6c 2920 2d3e 2053 7065 6374  : bool) -> Spect
-0000aa50: 726f 6d65 7465 7252 6573 706f 6e73 653a  rometerResponse:
-0000aa60: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000aa70: 2e73 6574 7469 6e67 732e 6973 5f69 6e67  .settings.is_ing
-0000aa80: 6161 7328 293a 0a20 2020 2020 2020 2020  aas():.         
-0000aa90: 2020 206c 6f67 2e65 7272 6f72 2822 6172     log.error("ar
-0000aaa0: 6561 2073 6361 6e20 6973 206e 6f74 2073  ea scan is not s
-0000aab0: 7570 706f 7274 6564 206f 6e20 496e 4761  upported on InGa
-0000aac0: 4173 2064 6574 6563 746f 7273 2028 7369  As detectors (si
-0000aad0: 6e67 6c65 206c 696e 6520 6172 7261 7929  ngle line array)
-0000aae0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-0000aaf0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-0000ab00: 6572 5265 7370 6f6e 7365 2865 7272 6f72  erResponse(error
-0000ab10: 5f6c 766c 3d45 7272 6f72 4c65 7665 6c2e  _lvl=ErrorLevel.
-0000ab20: 6c6f 772c 2065 7272 6f72 5f6d 7367 3d22  low, error_msg="
-0000ab30: 6172 6561 2073 6361 6e20 6973 206e 6f74  area scan is not
-0000ab40: 2073 7570 706f 7274 6564 206f 6e20 496e   supported on In
-0000ab50: 4761 4173 2064 6574 6563 746f 7273 2028  GaAs detectors (
-0000ab60: 7369 6e67 6c65 206c 696e 6520 6172 7261  single line arra
-0000ab70: 7929 2229 0a0a 2020 2020 2020 2020 7661  y)")..        va
-0000ab80: 6c75 6520 3d20 3120 6966 2066 6c61 6720  lue = 1 if flag 
-0000ab90: 656c 7365 2030 0a20 2020 2020 2020 2073  else 0.        s
-0000aba0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
-0000abb0: 7465 2e61 7265 615f 7363 616e 5f65 6e61  te.area_scan_ena
-0000abc0: 626c 6564 203d 2066 6c61 670a 2020 2020  bled = flag.    
-0000abd0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000abe0: 5f73 656e 645f 636f 6465 2830 7865 622c  _send_code(0xeb,
-0000abf0: 2076 616c 7565 2c20 6c61 6265 6c3d 2253   value, label="S
-0000ac00: 4554 5f41 5245 415f 5343 414e 5f45 4e41  ET_AREA_SCAN_ENA
-0000ac10: 424c 4522 290a 0a20 2020 2064 6566 2067  BLE")..    def g
-0000ac20: 6574 5f73 656e 736f 725f 6c69 6e65 5f6c  et_sensor_line_l
-0000ac30: 656e 6774 6828 7365 6c66 2920 2d3e 2053  ength(self) -> S
-0000ac40: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0000ac50: 6e73 653a 0a20 2020 2020 2020 2076 616c  nse:.        val
-0000ac60: 7565 203d 2073 656c 662e 6765 745f 7570  ue = self.get_up
-0000ac70: 7065 725f 636f 6465 2830 7830 332c 206c  per_code(0x03, l
-0000ac80: 6162 656c 3d22 4745 545f 4c49 4e45 5f4c  abel="GET_LINE_L
-0000ac90: 454e 4754 4822 2c20 6c73 625f 6c65 6e3d  ENGTH", lsb_len=
-0000aca0: 3229 0a20 2020 2020 2020 2069 6620 7661  2).        if va
-0000acb0: 6c75 6520 213d 2073 656c 662e 7365 7474  lue != self.sett
-0000acc0: 696e 6773 2e70 6978 656c 7328 293a 0a20  ings.pixels():. 
-0000acd0: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
-0000ace0: 7272 6f72 2822 4745 545f 4c49 4e45 5f4c  rror("GET_LINE_L
-0000acf0: 454e 4754 4820 6f70 636f 6465 2072 6573  ENGTH opcode res
-0000ad00: 756c 7420 2564 2021 3d20 5370 6563 7472  ult %d != Spectr
-0000ad10: 6f6d 6574 6572 5365 7474 696e 6773 2e70  ometerSettings.p
-0000ad20: 6978 656c 7320 2564 2028 7573 696e 6720  ixels %d (using 
-0000ad30: 6f70 636f 6465 2072 6573 756c 7429 222c  opcode result)",
-0000ad40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ad50: 2076 616c 7565 2c20 7365 6c66 2e73 6574   value, self.set
-0000ad60: 7469 6e67 732e 7069 7865 6c73 2829 290a  tings.pixels()).
-0000ad70: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-0000ad80: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0000ad90: 6e73 6528 6461 7461 3d76 616c 7565 290a  nse(data=value).
-0000ada0: 0a20 2020 2064 6566 2067 6574 5f6d 6963  .    def get_mic
-0000adb0: 726f 636f 6e74 726f 6c6c 6572 5f66 6972  rocontroller_fir
-0000adc0: 6d77 6172 655f 7665 7273 696f 6e28 7365  mware_version(se
-0000add0: 6c66 2920 2d3e 2053 7065 6374 726f 6d65  lf) -> Spectrome
-0000ade0: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-0000adf0: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
-0000ae00: 5f67 6574 5f63 6f64 6528 3078 6330 2c20  _get_code(0xc0, 
-0000ae10: 6c61 6265 6c3d 2247 4554 5f43 4f44 455f  label="GET_CODE_
-0000ae20: 5245 5649 5349 4f4e 2229 0a20 2020 2020  REVISION").     
-0000ae30: 2020 2072 6573 756c 7420 3d20 7265 732e     result = res.
-0000ae40: 6461 7461 0a20 2020 2020 2020 2076 6572  data.        ver
-0000ae50: 7369 6f6e 203d 2022 3f2e 3f2e 3f2e 3f22  sion = "?.?.?.?"
-0000ae60: 0a20 2020 2020 2020 2069 6620 7265 7375  .        if resu
-0000ae70: 6c74 2069 7320 6e6f 7420 4e6f 6e65 2061  lt is not None a
-0000ae80: 6e64 206c 656e 2872 6573 756c 7429 203e  nd len(result) >
-0000ae90: 3d20 343a 0a20 2020 2020 2020 2020 2020  = 4:.           
-0000aea0: 2076 6572 7369 6f6e 203d 2022 2564 2e25   version = "%d.%
-0000aeb0: 642e 2564 2e25 6422 2025 2028 7265 7375  d.%d.%d" % (resu
-0000aec0: 6c74 5b33 5d2c 2072 6573 756c 745b 325d  lt[3], result[2]
-0000aed0: 2c20 7265 7375 6c74 5b31 5d2c 2072 6573  , result[1], res
-0000aee0: 756c 745b 305d 2920 2320 4d53 422d 4c53  ult[0]) # MSB-LS
-0000aef0: 420a 2020 2020 2020 2020 7365 6c66 2e73  B.        self.s
-0000af00: 6574 7469 6e67 732e 6d69 6372 6f63 6f6e  ettings.microcon
-0000af10: 7472 6f6c 6c65 725f 6669 726d 7761 7265  troller_firmware
-0000af20: 5f76 6572 7369 6f6e 203d 2076 6572 7369  _version = versi
-0000af30: 6f6e 0a20 2020 2020 2020 2072 6574 7572  on.        retur
-0000af40: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-0000af50: 7370 6f6e 7365 2864 6174 613d 7665 7273  sponse(data=vers
-0000af60: 696f 6e29 0a0a 2020 2020 6465 6620 6765  ion)..    def ge
-0000af70: 745f 6670 6761 5f66 6972 6d77 6172 655f  t_fpga_firmware_
-0000af80: 7665 7273 696f 6e28 7365 6c66 2920 2d3e  version(self) ->
-0000af90: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0000afa0: 706f 6e73 653a 0a20 2020 2020 2020 2073  ponse:.        s
-0000afb0: 203d 2022 220a 2020 2020 2020 2020 7265   = "".        re
-0000afc0: 7320 3d20 7365 6c66 2e5f 6765 745f 636f  s = self._get_co
-0000afd0: 6465 2830 7862 342c 206c 6162 656c 3d22  de(0xb4, label="
-0000afe0: 4745 545f 4650 4741 5f52 4556 2229 0a20  GET_FPGA_REV"). 
-0000aff0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0000b000: 7265 732e 6461 7461 0a20 2020 2020 2020  res.data.       
-0000b010: 2069 6620 7265 7375 6c74 2069 7320 6e6f   if result is no
-0000b020: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000b030: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0000b040: 6765 286c 656e 2872 6573 756c 7429 293a  ge(len(result)):
-0000b050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b060: 2063 203d 2072 6573 756c 745b 695d 0a20   c = result[i]. 
-0000b070: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b080: 6620 3078 3230 203c 3d20 6320 3c20 3078  f 0x20 <= c < 0x
-0000b090: 3766 3a20 2320 7669 7369 626c 6520 4153  7f: # visible AS
-0000b0a0: 4349 490a 2020 2020 2020 2020 2020 2020  CII.            
-0000b0b0: 2020 2020 2020 2020 7320 2b3d 2063 6872          s += chr
-0000b0c0: 2863 290a 2020 2020 2020 2020 7365 6c66  (c).        self
-0000b0d0: 2e73 6574 7469 6e67 732e 6670 6761 5f66  .settings.fpga_f
-0000b0e0: 6972 6d77 6172 655f 7665 7273 696f 6e20  irmware_version 
-0000b0f0: 3d20 730a 2020 2020 2020 2020 7265 7475  = s.        retu
-0000b100: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-0000b110: 6573 706f 6e73 6528 6461 7461 3d73 290a  esponse(data=s).
-0000b120: 0a20 2020 2064 6566 2067 6574 5f6c 696e  .    def get_lin
-0000b130: 6528 7365 6c66 2c20 7472 6967 6765 723a  e(self, trigger:
-0000b140: 2062 6f6f 6c20 3d20 5472 7565 2920 2d3e   bool = True) ->
-0000b150: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0000b160: 706f 6e73 653a 0a20 2020 2020 2020 2022  ponse:.        "
-0000b170: 2222 0a20 2020 2020 2020 2053 656e 6420  "".        Send 
-0000b180: 2261 6371 7569 7265 222c 2074 6865 6e20  "acquire", then 
-0000b190: 696d 6d65 6469 6174 656c 7920 7265 6164  immediately read
-0000b1a0: 2074 6865 2062 756c 6b20 656e 6470 6f69   the bulk endpoi
-0000b1b0: 6e74 2873 292e 0a20 2020 2020 2020 2050  nt(s)..        P
-0000b1c0: 726f 6261 626c 7920 7468 6520 6d6f 7374  robably the most
-0000b1d0: 2069 6d70 6f72 7461 6e74 206d 6574 686f   important metho
-0000b1e0: 6420 696e 2074 6869 7320 636c 6173 732c  d in this class,
-0000b1f0: 206d 6f72 6520 636f 6d6d 6f6e 6c79 2063   more commonly c
-0000b200: 616c 6c65 640a 2020 2020 2020 2020 2267  alled.        "g
-0000b210: 6574 5370 6563 7472 756d 2220 696e 206d  etSpectrum" in m
-0000b220: 6f73 7420 6472 6976 6572 732e 0a20 2020  ost drivers..   
-0000b230: 2020 2020 2040 7061 7261 6d20 7472 6967       @param trig
-0000b240: 6765 7220 2849 6e70 7574 2920 7365 6e64  ger (Input) send
-0000b250: 2061 6e20 696e 6974 6961 6c20 4143 5155   an initial ACQU
-0000b260: 4952 450a 2020 2020 2020 2020 4072 6574  IRE.        @ret
-0000b270: 7572 6e73 2074 7570 6c65 206f 6620 2873  urns tuple of (s
-0000b280: 7065 6374 7275 6d5b 5d2c 2061 7265 615f  pectrum[], area_
-0000b290: 7363 616e 5f72 6f77 5f63 6f75 6e74 2920  scan_row_count) 
-0000b2a0: 666f 7220 7375 6363 6573 730a 2020 2020  for success.    
-0000b2b0: 2020 2020 4072 6574 7572 6e73 204e 6f6e      @returns Non
-0000b2c0: 6520 7768 656e 2069 7420 7469 6d65 732d  e when it times-
-0000b2d0: 6f75 7420 7768 696c 6520 7761 6974 696e  out while waitin
-0000b2e0: 6720 666f 7220 616e 2065 7874 6572 6e61  g for an externa
-0000b2f0: 6c20 7472 6967 6765 720a 2020 2020 2020  l trigger.      
-0000b300: 2020 2020 2020 2020 2020 2028 696e 7465             (inte
-0000b310: 7270 7265 7420 6173 2c20 2264 6964 6e27  rpret as, "didn'
-0000b320: 7420 6669 6e64 2061 6e79 2066 6973 6820  t find any fish 
-0000b330: 7468 6973 2074 696d 652c 2074 7279 2061  this time, try a
-0000b340: 6761 696e 2069 6e20 6120 6269 7422 290a  gain in a bit").
-0000b350: 2020 2020 2020 2020 4072 6574 7572 6e73          @returns
-0000b360: 2046 616c 7365 2028 626f 6f6c 2920 7768   False (bool) wh
-0000b370: 656e 2069 7420 7469 6d65 732d 6f75 7420  en it times-out 
-0000b380: 6f72 2065 6e63 6f75 6e74 6572 7320 616e  or encounters an
-0000b390: 2065 7863 6570 7469 6f6e 0a20 2020 2020   exception.     
-0000b3a0: 2020 2020 2020 2020 2020 2020 7768 656e              when
-0000b3b0: 204e 4f54 2069 6e20 6578 7465 726e 616c   NOT in external
-0000b3c0: 2d74 7269 6767 6572 6564 206d 6f64 650a  -triggered mode.
-0000b3d0: 2020 2020 2020 2020 4074 6872 6f77 7320          @throws 
-0000b3e0: 6578 6365 7074 696f 6e20 6f6e 2074 696d  exception on tim
-0000b3f0: 656f 7574 2028 756e 6c65 7373 2065 7874  eout (unless ext
-0000b400: 6572 6e61 6c20 7472 6967 6765 7269 6e67  ernal triggering
-0000b410: 2065 6e61 626c 6564 290a 2020 2020 2020   enabled).      
-0000b420: 2020 2222 220a 0a20 2020 2020 2020 2023    """..        #
-0000b430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b470: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-0000b480: 2320 7365 6e64 2074 6865 2041 4351 5549  # send the ACQUI
-0000b490: 5245 0a20 2020 2020 2020 2023 2323 2323  RE.        #####
-0000b4a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b4b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b4c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b4d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b4e0: 2323 230a 2020 2020 2020 2020 7265 7370  ###.        resp
-0000b4f0: 6f6e 7365 203d 2053 7065 6374 726f 6d65  onse = Spectrome
-0000b500: 7465 7252 6573 706f 6e73 6528 290a 0a20  terResponse().. 
-0000b510: 2020 2020 2020 2023 206d 6169 6e20 7573         # main us
-0000b520: 652d 6361 7365 2066 6f72 204e 4f54 2073  e-case for NOT s
-0000b530: 656e 6469 6e67 2061 2074 7269 6767 6572  ending a trigger
-0000b540: 2077 6f75 6c64 2062 6520 7768 656e 2072   would be when r
-0000b550: 6561 6469 6e67 0a20 2020 2020 2020 2023  eading.        #
-0000b560: 2073 7562 7365 7175 656e 7420 6c69 6e65   subsequent line
-0000b570: 7320 6f66 2064 6174 6120 6672 6f6d 2061  s of data from a
-0000b580: 7265 6120 7363 616e 2022 6661 7374 2220  rea scan "fast" 
-0000b590: 6d6f 6465 0a0a 2020 2020 2020 2020 6163  mode..        ac
-0000b5a0: 7175 6973 6974 696f 6e5f 7469 6d65 7374  quisition_timest
-0000b5b0: 616d 7020 3d20 6461 7465 7469 6d65 2e64  amp = datetime.d
-0000b5c0: 6174 6574 696d 652e 6e6f 7728 290a 2020  atetime.now().  
-0000b5d0: 2020 2020 2020 6966 2074 7269 6767 6572        if trigger
-0000b5e0: 2061 6e64 2073 656c 662e 7365 7474 696e   and self.settin
-0000b5f0: 6773 2e73 7461 7465 2e74 7269 6767 6572  gs.state.trigger
-0000b600: 5f73 6f75 7263 6520 3d3d 2053 7065 6374  _source == Spect
-0000b610: 726f 6d65 7465 7253 7461 7465 2e54 5249  rometerState.TRI
-0000b620: 4747 4552 5f53 4f55 5243 455f 494e 5445  GGER_SOURCE_INTE
-0000b630: 524e 414c 3a0a 2020 2020 2020 2020 2020  RNAL:.          
-0000b640: 2020 2320 4f6e 6c79 2073 656e 6420 4143    # Only send AC
-0000b650: 5155 4952 4520 2869 6e74 6572 6e61 6c20  QUIRE (internal 
-0000b660: 5357 2074 7269 6767 6572 2920 6966 2065  SW trigger) if e
-0000b670: 7874 6572 6e61 6c20 4857 2074 7269 6767  xternal HW trigg
-0000b680: 6572 2069 7320 6469 7361 626c 6564 2028  er is disabled (
-0000b690: 6465 6661 756c 7429 0a20 2020 2020 2020  default).       
-0000b6a0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-0000b6b0: 6765 745f 6c69 6e65 3a20 7265 7175 6573  get_line: reques
-0000b6c0: 7469 6e67 2073 7065 6374 7275 6d22 290a  ting spectrum").
-0000b6d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000b6e0: 2e5f 7365 6e64 5f63 6f64 6528 3078 6164  ._send_code(0xad
-0000b6f0: 2c20 6c61 6265 6c3d 2241 4351 5549 5245  , label="ACQUIRE
-0000b700: 5f53 5045 4354 5255 4d22 290a 0a20 2020  _SPECTRUM")..   
-0000b710: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
-0000b720: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b730: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b740: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b750: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-0000b760: 2020 2020 2020 2320 7072 6570 6172 6520        # prepare 
-0000b770: 746f 2072 6561 6420 7370 6563 7472 756d  to read spectrum
-0000b780: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
-0000b790: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b7a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b7b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b7c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b7d0: 230a 0a20 2020 2020 2020 2070 6978 656c  #..        pixel
-0000b7e0: 7320 3d20 7365 6c66 2e73 6574 7469 6e67  s = self.setting
-0000b7f0: 732e 7069 7865 6c73 2829 0a0a 2020 2020  s.pixels()..    
-0000b800: 2020 2020 2320 7768 656e 2063 6861 6e67      # when chang
-0000b810: 696e 6720 6465 7465 6374 6f72 2052 4f49  ing detector ROI
-0000b820: 2c20 6578 6163 746c 7920 4f4e 4520 5245  , exactly ONE RE
-0000b830: 4144 2073 686f 756c 6420 6265 2061 7420  AD should be at 
-0000b840: 7468 6520 7072 6576 696f 7573 206c 656e  the previous len
-0000b850: 6774 680a 2020 2020 2020 2020 2320 6966  gth.        # if
-0000b860: 2073 656c 662e 7072 6576 5f70 6978 656c   self.prev_pixel
-0000b870: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-0000b880: 2020 2020 2020 2023 2020 2020 206c 6f67         #     log
-0000b890: 2e64 6562 7567 2866 2267 6574 5f6c 696e  .debug(f"get_lin
-0000b8a0: 653a 2075 7369 6e67 206f 6e65 2d74 696d  e: using one-tim
-0000b8b0: 6520 7072 6576 5f70 6978 656c 7320 7661  e prev_pixels va
-0000b8c0: 6c75 6520 6f66 207b 7365 6c66 2e70 7265  lue of {self.pre
-0000b8d0: 765f 7069 7865 6c73 7d20 7261 7468 6572  v_pixels} rather
-0000b8e0: 2074 6861 6e20 7b70 6978 656c 737d 2229   than {pixels}")
-0000b8f0: 0a20 2020 2020 2020 2023 2020 2020 2070  .        #     p
-0000b900: 6978 656c 7320 3d20 7365 6c66 2e70 7265  ixels = self.pre
-0000b910: 765f 7069 7865 6c73 0a20 2020 2020 2020  v_pixels.       
-0000b920: 2023 2020 2020 2073 656c 662e 7072 6576   #     self.prev
-0000b930: 5f70 6978 656c 7320 3d20 4e6f 6e65 0a0a  _pixels = None..
-0000b940: 2020 2020 2020 2020 2320 616c 6c20 6d6f          # all mo
-0000b950: 6465 6c73 2072 6574 7572 6e20 7370 6563  dels return spec
-0000b960: 7472 6120 6173 205b 7569 6e74 3136 5d0a  tra as [uint16].
-0000b970: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
-0000b980: 7320 3d20 5b30 7838 325d 0a20 2020 2020  s = [0x82].     
-0000b990: 2020 2062 6c6f 636b 5f6c 656e 5f62 7974     block_len_byt
-0000b9a0: 6573 203d 2070 6978 656c 7320 2a20 320a  es = pixels * 2.
-0000b9b0: 2020 2020 2020 2020 6966 2070 6978 656c          if pixel
-0000b9c0: 7320 3d3d 2032 3034 3820 616e 6420 6e6f  s == 2048 and no
-0000b9d0: 7420 7365 6c66 2e73 6574 7469 6e67 732e  t self.settings.
-0000b9e0: 6973 5f61 726d 2829 3a0a 2020 2020 2020  is_arm():.      
-0000b9f0: 2020 2020 2020 656e 6470 6f69 6e74 7320        endpoints 
-0000ba00: 3d20 5b30 7838 322c 2030 7838 365d 0a20  = [0x82, 0x86]. 
-0000ba10: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-0000ba20: 5f6c 656e 5f62 7974 6573 203d 2032 3034  _len_bytes = 204
-0000ba30: 3820 2320 3130 3234 2070 6978 656c 7320  8 # 1024 pixels 
-0000ba40: 6170 6965 6365 2066 726f 6d20 7477 6f20  apiece from two 
-0000ba50: 656e 6470 6f69 6e74 730a 0a20 2020 2020  endpoints..     
-0000ba60: 2020 2069 6620 7365 6c66 2e73 6574 7469     if self.setti
-0000ba70: 6e67 732e 6973 5f6d 6963 726f 2829 3a0a  ngs.is_micro():.
-0000ba80: 2020 2020 2020 2020 2020 2020 2320 7765              # we
-0000ba90: 2068 6176 6520 6e6f 2069 6465 6120 6966   have no idea if
-0000baa0: 2053 6572 6965 732d 5853 2068 6173 2074   Series-XS has t
-0000bab0: 6f20 2277 616b 6520 7570 2220 7468 6520  o "wake up" the 
-0000bac0: 7365 6e73 6f72 2c20 736f 2077 6169 740a  sensor, so wait.
-0000bad0: 2020 2020 2020 2020 2020 2020 2320 6c6f              # lo
-0000bae0: 6e67 2065 6e6f 7567 6820 666f 7220 3620  ng enough for 6 
-0000baf0: 7468 726f 7761 7761 7920 6672 616d 6573  throwaway frames
-0000bb00: 2069 6620 6e65 6564 2062 650a 2020 2020   if need be.    
-0000bb10: 2020 2020 2020 2020 7469 6d65 6f75 745f          timeout_
-0000bb20: 6d73 203d 2073 656c 662e 7365 7474 696e  ms = self.settin
-0000bb30: 6773 2e73 7461 7465 2e69 6e74 6567 7261  gs.state.integra
-0000bb40: 7469 6f6e 5f74 696d 655f 6d73 202a 2038  tion_time_ms * 8
-0000bb50: 202b 2035 3030 202a 2073 656c 662e 7365   + 500 * self.se
-0000bb60: 7474 696e 6773 2e6e 756d 5f63 6f6e 6e65  ttings.num_conne
-0000bb70: 6374 6564 5f64 6576 6963 6573 0a20 2020  cted_devices.   
-0000bb80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000bb90: 2020 2020 2020 2074 696d 656f 7574 5f6d         timeout_m
-0000bba0: 7320 3d20 7365 6c66 2e73 6574 7469 6e67  s = self.setting
-0000bbb0: 732e 7374 6174 652e 696e 7465 6772 6174  s.state.integrat
-0000bbc0: 696f 6e5f 7469 6d65 5f6d 7320 2a20 3220  ion_time_ms * 2 
-0000bbd0: 2b20 3130 3030 202a 2073 656c 662e 7365  + 1000 * self.se
-0000bbe0: 7474 696e 6773 2e6e 756d 5f63 6f6e 6e65  ttings.num_conne
-0000bbf0: 6374 6564 5f64 6576 6963 6573 0a0a 2020  cted_devices..  
-0000bc00: 2020 2020 2020 2320 6475 6520 746f 2061        # due to a
-0000bc10: 6464 6974 696f 6e61 6c20 6669 726d 7761  dditional firmwa
-0000bc20: 7265 2070 726f 6365 7373 696e 6720 7469  re processing ti
-0000bc30: 6d65 2066 6f72 2061 7265 6120 7363 616e  me for area scan
-0000bc40: 3f0a 2020 2020 2020 2020 6966 2073 656c  ?.        if sel
-0000bc50: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-0000bc60: 2e61 7265 615f 7363 616e 5f65 6e61 626c  .area_scan_enabl
-0000bc70: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0000bc80: 6966 2074 7269 6767 6572 3a0a 2020 2020  if trigger:.    
-0000bc90: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000bca0: 6f75 745f 6d73 202b 3d20 3235 300a 2020  out_ms += 250.  
-0000bcb0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bcd0: 2320 6b6c 7564 6765 3a20 6a75 7374 2075  # kludge: just u
-0000bce0: 7365 2074 7269 706c 6520 7468 6520 696e  se triple the in
-0000bcf0: 7472 612d 6c69 6e65 2064 656c 6179 0a20  tra-line delay. 
-0000bd00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000bd10: 696d 656f 7574 5f6d 7320 3d20 7365 6c66  imeout_ms = self
-0000bd20: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
-0000bd30: 2e64 6574 6563 746f 725f 6f66 6673 6574  .detector_offset
-0000bd40: 202a 2033 0a0a 2020 2020 2020 2020 7365   * 3..        se
-0000bd50: 6c66 2e5f 7761 6974 5f66 6f72 5f75 7362  lf._wait_for_usb
-0000bd60: 5f61 7661 696c 6162 6c65 2829 0a0a 2020  _available()..  
-0000bd70: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
-0000bd80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000bd90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000bda0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000bdb0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0000bdc0: 2020 2020 2020 2023 2072 6561 6420 7468         # read th
-0000bdd0: 6520 6461 7461 2066 726f 6d20 6275 6c6b  e data from bulk
-0000bde0: 2065 6e64 706f 696e 7428 7329 0a20 2020   endpoint(s).   
-0000bdf0: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
-0000be00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000be10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000be20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000be30: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
-0000be40: 2020 2020 2020 2073 7065 6374 7275 6d20         spectrum 
-0000be50: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0000be60: 2065 6e64 706f 696e 7420 696e 2065 6e64   endpoint in end
-0000be70: 706f 696e 7473 3a0a 2020 2020 2020 2020  points:.        
-0000be80: 2020 2020 6461 7461 203d 204e 6f6e 650a      data = None.
-0000be90: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-0000bea0: 6520 6461 7461 2069 7320 4e6f 6e65 3a0a  e data is None:.
-0000beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bec0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000bed0: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
-0000bee0: 7567 2822 7761 6974 696e 6720 666f 7220  ug("waiting for 
-0000bef0: 2564 2062 7974 6573 2028 7469 6d65 6f75  %d bytes (timeou
-0000bf00: 7420 2564 6d73 2922 2c20 626c 6f63 6b5f  t %dms)", block_
-0000bf10: 6c65 6e5f 6279 7465 732c 2074 696d 656f  len_bytes, timeo
-0000bf20: 7574 5f6d 7329 0a20 2020 2020 2020 2020  ut_ms).         
-0000bf30: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-0000bf40: 3d20 7365 6c66 2e64 6576 6963 655f 7479  = self.device_ty
-0000bf50: 7065 2e72 6561 6428 7365 6c66 2e64 6576  pe.read(self.dev
-0000bf60: 6963 652c 2065 6e64 706f 696e 742c 2062  ice, endpoint, b
-0000bf70: 6c6f 636b 5f6c 656e 5f62 7974 6573 2c20  lock_len_bytes, 
-0000bf80: 7469 6d65 6f75 743d 7469 6d65 6f75 745f  timeout=timeout_
-0000bf90: 6d73 290a 2020 2020 2020 2020 2020 2020  ms).            
-0000bfa0: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-0000bfb0: 6728 2272 6561 6420 2564 2062 7974 6573  g("read %d bytes
-0000bfc0: 222c 206c 656e 2864 6174 6129 290a 2020  ", len(data)).  
-0000bfd0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000bfe0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-0000bff0: 7320 6578 633a 0a20 2020 2020 2020 2020  s exc:.         
-0000c000: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0000c010: 6c66 2e64 6576 6963 655f 7479 7065 2069  lf.device_type i
-0000c020: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c040: 6c6f 672e 6572 726f 7228 6622 4e6f 2064  log.error(f"No d
-0000c050: 6576 6963 655f 7479 7065 2229 0a20 2020  evice_type").   
-0000c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c070: 2020 2020 2072 6573 706f 6e73 652e 6572       response.er
-0000c080: 726f 725f 6d73 6720 3d20 6622 456e 636f  ror_msg = f"Enco
-0000c090: 756e 7465 7265 6420 6572 726f 7220 6f6e  untered error on
-0000c0a0: 2072 6561 6422 0a20 2020 2020 2020 2020   read".         
-0000c0b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c0c0: 6573 706f 6e73 652e 6572 726f 725f 6c76  esponse.error_lv
-0000c0d0: 6c20 3d20 4572 726f 724c 6576 656c 2e68  l = ErrorLevel.h
-0000c0e0: 6967 680a 2020 2020 2020 2020 2020 2020  igh.            
-0000c0f0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0000c100: 6f6e 7365 2e70 6f69 736f 6e5f 7069 6c6c  onse.poison_pill
-0000c110: 203d 2054 7275 6520 2320 756e 7265 636f   = True # unreco
-0000c120: 7665 7261 626c 650a 2020 2020 2020 2020  verable.        
-0000c130: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0000c140: 2073 656c 662e 7365 7474 696e 6773 2e73   self.settings.s
-0000c150: 7461 7465 2e74 7269 6767 6572 5f73 6f75  tate.trigger_sou
-0000c160: 7263 6520 3d3d 2053 7065 6374 726f 6d65  rce == Spectrome
-0000c170: 7465 7253 7461 7465 2e54 5249 4747 4552  terState.TRIGGER
-0000c180: 5f53 4f55 5243 455f 4558 5445 524e 414c  _SOURCE_EXTERNAL
-0000c190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c1a0: 2020 2020 2020 2020 2020 2320 7765 2064            # we d
-0000c1b0: 6f6e 2774 206b 6e6f 7720 686f 7720 6c6f  on't know how lo
-0000c1c0: 6e67 2077 6527 6c6c 2068 6176 6520 746f  ng we'll have to
-0000c1d0: 2077 6169 7420 666f 7220 7468 6520 7472   wait for the tr
-0000c1e0: 6967 6765 722c 2073 6f0a 2020 2020 2020  igger, so.      
-0000c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c200: 2020 2320 6a75 7374 206c 6f6f 7020 616e    # just loop an
-0000c210: 6420 686f 7065 0a20 2020 2020 2020 2020  d hope.         
-0000c220: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000c230: 206c 6f67 2e64 6562 7567 2822 7374 696c   log.debug("stil
-0000c240: 6c20 7761 6974 696e 6720 666f 7220 6578  l waiting for ex
-0000c250: 7465 726e 616c 2074 7269 6767 6572 2229  ternal trigger")
-0000c260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c270: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-0000c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c290: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2b0: 6c6f 672e 6572 726f 7228 6622 456e 636f  log.error(f"Enco
-0000c2c0: 756e 7465 7265 6420 6572 726f 7220 6f6e  untered error on
-0000c2d0: 2072 6561 6420 6f66 207b 6578 637d 2229   read of {exc}")
-0000c2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c2f0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-0000c300: 652e 6572 726f 725f 6d73 6720 3d20 6622  e.error_msg = f"
-0000c310: 456e 636f 756e 7465 7265 6420 6572 726f  Encountered erro
-0000c320: 7220 6f6e 2072 6561 6422 0a20 2020 2020  r on read".     
-0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c340: 2020 2072 6573 706f 6e73 652e 6572 726f     response.erro
-0000c350: 725f 6c76 6c20 3d20 4572 726f 724c 6576  r_lvl = ErrorLev
-0000c360: 656c 2e68 6967 680a 2020 2020 2020 2020  el.high.        
-0000c370: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000c380: 726e 2072 6573 706f 6e73 650a 0a20 2020  rn response..   
-0000c390: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
-0000c3a0: 6973 2061 2063 6f6e 766f 6c75 7465 6420  is a convoluted 
-0000c3b0: 7761 7920 746f 2069 7465 7261 7465 2061  way to iterate a
-0000c3c0: 6372 6f73 7320 7468 6520 7265 6365 6976  cross the receiv
-0000c3d0: 6564 2062 7974 6573 2069 6e20 2764 6174  ed bytes in 'dat
-0000c3e0: 6127 2061 730a 2020 2020 2020 2020 2020  a' as.          
-0000c3f0: 2020 2320 7477 6f20 696e 7465 726c 6561    # two interlea
-0000c400: 7665 6420 6172 7261 7973 2c20 626f 7468  ved arrays, both
-0000c410: 206f 6e6c 7920 7072 6f63 6573 7369 6e67   only processing
-0000c420: 2061 6c74 6572 6e61 7469 6e67 2062 7974   alternating byt
-0000c430: 6573 2c20 6275 7420 6f6e 6520 2869 290a  es, but one (i).
-0000c440: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-0000c450: 6172 7469 6e67 2061 7420 7a65 726f 2028  arting at zero (
-0000c460: 6576 656e 2062 7974 6573 2920 616e 6420  even bytes) and 
-0000c470: 7468 6520 6f74 6865 7220 286a 2920 7374  the other (j) st
-0000c480: 6172 7469 6e67 2061 7420 3120 286f 6464  arting at 1 (odd
-0000c490: 2062 7974 6573 292e 0a20 2020 2020 2020   bytes)..       
-0000c4a0: 2020 2020 2073 7562 7370 6563 7472 756d       subspectrum
-0000c4b0: 203d 205b 696e 7428 6920 7c20 286a 203c   = [int(i | (j <
-0000c4c0: 3c20 3829 2920 666f 7220 692c 206a 2069  < 8)) for i, j i
-0000c4d0: 6e20 7a69 7028 6461 7461 5b3a 3a32 5d2c  n zip(data[::2],
-0000c4e0: 2064 6174 615b 313a 3a32 5d29 5d20 2320   data[1::2])] # 
-0000c4f0: 4c53 422d 4d53 420a 0a20 2020 2020 2020  LSB-MSB..       
-0000c500: 2020 2020 2073 7065 6374 7275 6d2e 6578       spectrum.ex
-0000c510: 7465 6e64 2873 7562 7370 6563 7472 756d  tend(subspectrum
-0000c520: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0000c530: 2065 6d70 6972 6963 616c 6c79 2064 6574   empirically det
-0000c540: 6572 6d69 6e65 6420 6e65 6564 2066 6f72  ermined need for
-0000c550: 2035 6d73 2064 656c 6179 2077 6865 6e20   5ms delay when 
-0000c560: 7377 6974 6368 696e 6720 656e 6470 6f69  switching endpoi
-0000c570: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
-0000c580: 2320 6f6e 2032 3034 3870 7820 6465 7465  # on 2048px dete
-0000c590: 6374 6f72 7320 6475 7269 6e67 2061 7265  ctors during are
-0000c5a0: 6120 7363 616e 0a20 2020 2020 2020 2020  a scan.         
-0000c5b0: 2020 2069 6620 7365 6c66 2e73 6574 7469     if self.setti
-0000c5c0: 6e67 732e 7374 6174 652e 6172 6561 5f73  ngs.state.area_s
-0000c5d0: 6361 6e5f 656e 6162 6c65 6420 616e 6420  can_enabled and 
-0000c5e0: 7069 7865 6c73 203d 3d20 3230 3438 3a20  pixels == 2048: 
-0000c5f0: 2320 616e 6420 656e 6470 6f69 6e74 203d  # and endpoint =
-0000c600: 3d20 3078 3832 3a0a 2020 2020 2020 2020  = 0x82:.        
-0000c610: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-0000c620: 6728 2273 6c65 6570 696e 6720 356d 7320  g("sleeping 5ms 
-0000c630: 6265 7477 6565 6e20 656e 6470 6f69 6e74  between endpoint
-0000c640: 7322 290a 2020 2020 2020 2020 2020 2020  s").            
-0000c650: 2020 2020 736c 6565 7028 302e 3030 3529      sleep(0.005)
-0000c660: 0a0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
-0000c670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000c680: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000c690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000c6a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000c6b0: 2323 0a20 2020 2020 2020 2023 2065 7272  ##.        # err
-0000c6c0: 6f72 2d63 6865 636b 2074 6865 2072 6563  or-check the rec
-0000c6d0: 6569 7665 6420 7370 6563 7472 756d 0a20  eived spectrum. 
-0000c6e0: 2020 2020 2020 2023 2323 2323 2323 2323         #########
-0000c6f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000c700: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000c710: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000c720: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0000c730: 0a20 2020 2020 2020 206c 6f67 2e64 6562  .        log.deb
-0000c740: 7567 2822 6765 745f 6c69 6e65 3a20 636f  ug("get_line: co
-0000c750: 6d70 6c65 7465 6420 696e 2025 2e32 6620  mpleted in %.2f 
-0000c760: 7365 6320 2876 7320 696e 7465 6772 6174  sec (vs integrat
-0000c770: 696f 6e20 7469 6d65 2025 6420 6d73 2922  ion time %d ms)"
-0000c780: 2c0a 2020 2020 2020 2020 2020 2020 2864  ,.            (d
-0000c790: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
-0000c7a0: 2e6e 6f77 2829 202d 2061 6371 7569 7369  .now() - acquisi
-0000c7b0: 7469 6f6e 5f74 696d 6573 7461 6d70 292e  tion_timestamp).
-0000c7c0: 746f 7461 6c5f 7365 636f 6e64 7328 292c  total_seconds(),
-0000c7d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000c7e0: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-0000c7f0: 2e69 6e74 6567 7261 7469 6f6e 5f74 696d  .integration_tim
-0000c800: 655f 6d73 290a 0a20 2020 2020 2020 206c  e_ms)..        l
-0000c810: 6f67 2e64 6562 7567 2822 6765 745f 6c69  og.debug("get_li
-0000c820: 6e65 3a20 7069 7865 6c73 2025 642c 2065  ne: pixels %d, e
-0000c830: 6e64 706f 696e 7473 2025 732c 2062 6c6f  ndpoints %s, blo
-0000c840: 636b 2025 642c 2073 7065 6374 7275 6d20  ck %d, spectrum 
-0000c850: 2573 202e 2e2e 222c 0a20 2020 2020 2020  %s ...",.       
-0000c860: 2020 2020 206c 656e 2873 7065 6374 7275       len(spectru
-0000c870: 6d29 2c20 656e 6470 6f69 6e74 732c 2062  m), endpoints, b
-0000c880: 6c6f 636b 5f6c 656e 5f62 7974 6573 2c20  lock_len_bytes, 
-0000c890: 7370 6563 7472 756d 5b30 3a39 5d29 0a0a  spectrum[0:9])..
-0000c8a0: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-0000c8b0: 7065 6374 7275 6d29 2021 3d20 7069 7865  pectrum) != pixe
-0000c8c0: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-0000c8d0: 6c6f 672e 6572 726f 7228 2267 6574 5f6c  log.error("get_l
-0000c8e0: 696e 6520 7265 6164 2077 726f 6e67 206e  ine read wrong n
-0000c8f0: 756d 6265 7220 6f66 2070 6978 656c 7320  umber of pixels 
-0000c900: 2865 7870 6563 7465 6420 2564 2c20 7265  (expected %d, re
-0000c910: 6164 2025 6429 222c 2070 6978 656c 732c  ad %d)", pixels,
-0000c920: 206c 656e 2873 7065 6374 7275 6d29 290a   len(spectrum)).
-0000c930: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-0000c940: 6f6e 7365 2e65 7272 6f72 5f6d 7367 203d  onse.error_msg =
-0000c950: 2066 2267 6574 5f6c 696e 6520 7265 6164   f"get_line read
-0000c960: 2077 726f 6e67 206e 756d 6265 7220 6f66   wrong number of
-0000c970: 2070 6978 656c 7320 2865 7870 6563 7465   pixels (expecte
-0000c980: 6420 7b70 6978 656c 737d 2c20 7265 6164  d {pixels}, read
-0000c990: 207b 6c65 6e28 7370 6563 7472 756d 297d   {len(spectrum)}
-0000c9a0: 2922 0a20 2020 2020 2020 2020 2020 2072  )".            r
-0000c9b0: 6573 706f 6e73 652e 6572 726f 725f 6c76  esponse.error_lv
-0000c9c0: 6c20 3d20 4572 726f 724c 6576 656c 2e6c  l = ErrorLevel.l
-0000c9d0: 6f77 0a20 2020 2020 2020 2020 2020 2072  ow.            r
-0000c9e0: 6573 706f 6e73 652e 6b65 6570 5f61 6c69  esponse.keep_ali
-0000c9f0: 7665 203d 2054 7275 650a 2020 2020 2020  ve = True.      
-0000ca00: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0000ca10: 706f 6e73 650a 2020 2020 2020 2020 2020  ponse.          
-0000ca20: 2020 2320 6966 206c 656e 2873 7065 6374    # if len(spect
-0000ca30: 7275 6d29 203c 2070 6978 656c 733a 0a20  rum) < pixels:. 
-0000ca40: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-0000ca50: 2073 7065 6374 7275 6d2e 6578 7465 6e64   spectrum.extend
-0000ca60: 285b 305d 202a 2028 7069 7865 6c73 202d  ([0] * (pixels -
-0000ca70: 206c 656e 2873 7065 6374 7275 6d29 2929   len(spectrum)))
-0000ca80: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
-0000ca90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000caa0: 2023 2020 2020 2073 7065 6374 7275 6d20   #     spectrum 
-0000cab0: 3d20 7370 6563 7472 756d 5b3a 2d70 6978  = spectrum[:-pix
-0000cac0: 656c 735d 0a0a 2020 2020 2020 2020 2323  els]..        ##
-0000cad0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00007310: 2020 2020 2020 2020 6461 7461 5f6f 725f          data_or_
+00007320: 774c 656e 6774 6829 2023 2061 6464 2054  wLength) # add T
+00007330: 494d 454f 5554 5f4d 5320 7061 7261 6d65  IMEOUT_MS parame
+00007340: 7465 723f 0d0a 2020 2020 2020 2020 2020  ter?..          
+00007350: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00007360: 6f6e 2061 7320 6578 633a 0d0a 2020 2020  on as exc:..    
+00007370: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+00007380: 6372 6974 6963 616c 2822 4861 7264 7761  critical("Hardwa
+00007390: 7265 2046 6169 6c75 7265 2046 4944 2053  re Failure FID S
+000073a0: 656e 6420 436f 6465 2050 726f 626c 656d  end Code Problem
+000073b0: 2077 6974 6820 6374 726c 2074 7261 6e73   with ctrl trans
+000073c0: 6665 7222 2c20 6578 635f 696e 666f 3d31  fer", exc_info=1
+000073d0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+000073e0: 2020 2073 656c 662e 5f73 6368 6564 756c     self._schedul
+000073f0: 655f 6469 7363 6f6e 6e65 6374 2865 7863  e_disconnect(exc
+00007400: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00007410: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+00007420: 6f6d 6574 6572 5265 7370 6f6e 7365 2870  ometerResponse(p
+00007430: 6f69 736f 6e5f 7069 6c6c 3d54 7275 6529  oison_pill=True)
+00007440: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00007450: 6c6f 672e 6465 6275 6728 2225 735f 7365  log.debug("%s_se
+00007460: 6e64 5f63 6f64 653a 2072 6571 7565 7374  nd_code: request
+00007470: 2030 7825 3032 7820 7661 6c75 6520 3078   0x%02x value 0x
+00007480: 2530 3478 2069 6e64 6578 2030 7825 3034  %04x index 0x%04
+00007490: 7820 6461 7461 2f6c 656e 2025 733a 2072  x data/len %s: r
+000074a0: 6573 756c 7420 2573 222c 0d0a 2020 2020  esult %s",..    
+000074b0: 2020 2020 2020 2020 2020 2020 7072 6566              pref
+000074c0: 6978 2c20 6252 6571 7565 7374 2c20 7756  ix, bRequest, wV
+000074d0: 616c 7565 2c20 7749 6e64 6578 2c20 6461  alue, wIndex, da
+000074e0: 7461 5f6f 725f 774c 656e 6774 682c 2072  ta_or_wLength, r
+000074f0: 6573 756c 7429 0d0a 0d0a 2020 2020 2020  esult)....      
+00007500: 2020 2020 2020 6966 206e 6f74 2072 6574        if not ret
+00007510: 7279 5f6f 6e5f 6572 726f 723a 0d0a 2020  ry_on_error:..  
+00007520: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00007530: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+00007540: 7252 6573 706f 6e73 6528 6b65 6570 5f61  rResponse(keep_a
+00007550: 6c69 7665 3d54 7275 6529 0d0a 0d0a 2020  live=True)....  
+00007560: 2020 2020 2020 2020 2020 2320 7265 7472            # retr
+00007570: 7920 6c6f 6769 6320 656e 6162 6c65 642c  y logic enabled,
+00007580: 2073 6f20 636f 6d70 6172 6520 7265 7375   so compare resu
+00007590: 6c74 2074 6f20 6578 7065 6374 6564 0d0a  lt to expected..
+000075a0: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
+000075b0: 6865 645f 6578 7065 6374 6564 203d 2054  hed_expected = T
+000075c0: 7275 650d 0a20 2020 2020 2020 2020 2020  rue..           
+000075d0: 2069 6620 6c65 6e28 7375 6363 6573 735f   if len(success_
+000075e0: 7265 7375 6c74 2920 3c20 6c65 6e28 7265  result) < len(re
+000075f0: 7375 6c74 293a 0d0a 2020 2020 2020 2020  sult):..        
+00007600: 2020 2020 2020 2020 6d61 7463 6865 645f          matched_
+00007610: 6578 7065 6374 6564 203d 2046 616c 7365  expected = False
+00007620: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00007630: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00007640: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+00007650: 6e67 6528 6c65 6e28 7375 6363 6573 735f  nge(len(success_
+00007660: 7265 7375 6c74 2929 3a0d 0a20 2020 2020  result)):..     
+00007670: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00007680: 6620 7265 7375 6c74 5b69 5d20 213d 2073  f result[i] != s
+00007690: 7563 6365 7373 5f72 6573 756c 745b 695d  uccess_result[i]
+000076a0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000076b0: 2020 2020 2020 2020 2020 206d 6174 6368             match
+000076c0: 6564 5f65 7870 6563 7465 6420 3d20 4661  ed_expected = Fa
+000076d0: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
+000076e0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+000076f0: 616b 0d0a 0d0a 2020 2020 2020 2020 2020  ak....          
+00007700: 2020 6966 206d 6174 6368 6564 5f65 7870    if matched_exp
+00007710: 6563 7465 643a 0d0a 2020 2020 2020 2020  ected:..        
+00007720: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00007730: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00007740: 6e73 6528 6b65 6570 5f61 6c69 7665 3d54  nse(keep_alive=T
+00007750: 7275 6529 0d0a 0d0a 2020 2020 2020 2020  rue)....        
+00007760: 2020 2020 2320 6170 7061 7265 6e74 6c79      # apparently
+00007770: 2069 7420 6469 646e 2774 206d 6174 6368   it didn't match
+00007780: 2065 7870 6563 7465 640d 0a20 2020 2020   expected..     
+00007790: 2020 2020 2020 2072 6574 7279 5f63 6f75         retry_cou
+000077a0: 6e74 202b 3d20 310d 0a20 2020 2020 2020  nt += 1..       
+000077b0: 2020 2020 2069 6620 7265 7472 795f 636f       if retry_co
+000077c0: 756e 7420 3e20 7365 6c66 2e72 6574 7279  unt > self.retry
+000077d0: 5f6d 6178 3a0d 0a20 2020 2020 2020 2020  _max:..         
+000077e0: 2020 2020 2020 206c 6f67 2e65 7272 6f72         log.error
+000077f0: 2822 6769 7669 6e67 2075 7020 6166 7465  ("giving up afte
+00007800: 7220 2564 2072 6574 7269 6573 222c 2072  r %d retries", r
+00007810: 6574 7279 5f63 6f75 6e74 290d 0a20 2020  etry_count)..   
+00007820: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00007830: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00007840: 5265 7370 6f6e 7365 2870 6f69 736f 6e5f  Response(poison_
+00007850: 7069 6c6c 3d54 7275 6529 0d0a 0d0a 2020  pill=True)....  
+00007860: 2020 2020 2020 2020 2020 2320 7472 7920            # try 
+00007870: 6167 6169 6e0d 0a20 2020 2020 2020 2020  again..         
+00007880: 2020 206c 6f67 2e65 7272 6f72 2822 7265     log.error("re
+00007890: 7472 7969 6e67 2028 6174 7465 6d70 7420  trying (attempt 
+000078a0: 2564 2922 2c20 7265 7472 795f 636f 756e  %d)", retry_coun
+000078b0: 7420 2b20 3129 0d0a 0d0a 2020 2020 2323  t + 1)....    ##
+000078c0: 2040 6e6f 7465 2077 6569 7264 2074 6861   @note weird tha
+000078d0: 7420 736f 2066 6577 2063 616c 6c73 2074  t so few calls t
+000078e0: 6f20 7468 6973 2066 756e 6374 696f 6e20  o this function 
+000078f0: 6f76 6572 7269 6465 2074 6865 2064 6566  override the def
+00007900: 6175 6c74 2077 4c65 6e67 7468 0d0a 2020  ault wLength..  
+00007910: 2020 2320 4074 6f64 6f20 636f 6e73 6964    # @todo consid
+00007920: 6572 2061 6464 696e 6720 7265 7472 7920  er adding retry 
+00007930: 6c6f 6769 6320 6173 2077 656c 6c0d 0a20  logic as well.. 
+00007940: 2020 2064 6566 205f 6765 745f 636f 6465     def _get_code
+00007950: 2873 656c 662c 200d 0a20 2020 2020 2020  (self, ..       
+00007960: 2020 2020 2020 2020 2020 2062 5265 7175             bRequ
+00007970: 6573 743a 2069 6e74 2c20 0d0a 2020 2020  est: int, ..    
+00007980: 2020 2020 2020 2020 2020 2020 2020 7756                wV
+00007990: 616c 7565 3a20 696e 7420 3d20 302c 200d  alue: int = 0, .
+000079a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000079b0: 2020 2077 496e 6465 783a 2069 6e74 203d     wIndex: int =
+000079c0: 2030 2c20 0d0a 2020 2020 2020 2020 2020   0, ..          
+000079d0: 2020 2020 2020 2020 774c 656e 6774 683a          wLength:
+000079e0: 2069 6e74 203d 2036 342c 200d 0a20 2020   int = 64, ..   
+000079f0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00007a00: 6162 656c 3a20 7374 7220 3d20 2222 2c20  abel: str = "", 
+00007a10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00007a20: 2020 2020 6d73 625f 6c65 6e3a 2069 6e74      msb_len: int
+00007a30: 203d 204e 6f6e 652c 200d 0a20 2020 2020   = None, ..     
+00007a40: 2020 2020 2020 2020 2020 2020 206c 7362               lsb
+00007a50: 5f6c 656e 3a20 696e 7420 3d20 4e6f 6e65  _len: int = None
+00007a60: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
+00007a70: 7252 6573 706f 6e73 653a 0d0a 2020 2020  rResponse:..    
+00007a80: 2020 2020 7072 6566 6978 203d 2022 2220      prefix = "" 
+00007a90: 6966 206e 6f74 206c 6162 656c 2065 6c73  if not label els
+00007aa0: 6520 2822 2573 3a20 2220 2520 6c61 6265  e ("%s: " % labe
+00007ab0: 6c29 0d0a 2020 2020 2020 2020 7265 7375  l)..        resu
+00007ac0: 6c74 203d 204e 6f6e 650d 0a0d 0a20 2020  lt = None....   
+00007ad0: 2020 2020 2069 6620 7365 6c66 2e73 6875       if self.shu
+00007ae0: 7464 6f77 6e5f 7265 7175 6573 7465 6420  tdown_requested 
+00007af0: 6f72 2028 6e6f 7420 7365 6c66 2e63 6f6e  or (not self.con
+00007b00: 6e65 6374 6564 2061 6e64 206e 6f74 2073  nected and not s
+00007b10: 656c 662e 636f 6e6e 6563 7469 6e67 293a  elf.connecting):
+00007b20: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+00007b30: 672e 6465 6275 6728 225f 6765 745f 636f  g.debug("_get_co
+00007b40: 6465 3a20 6e6f 7420 6174 7465 6d70 7469  de: not attempti
+00007b50: 6e67 2062 6563 6175 7365 206e 6f74 2063  ng because not c
+00007b60: 6f6e 6e65 6374 6564 2229 0d0a 2020 2020  onnected")..    
+00007b70: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00007b80: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00007b90: 6e73 6528 290d 0a0d 0a20 2020 2020 2020  nse()....       
+00007ba0: 2069 6620 7365 6c66 2e5f 6368 6563 6b5f   if self._check_
+00007bb0: 666f 725f 7261 6e64 6f6d 5f65 7272 6f72  for_random_error
+00007bc0: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
+00007bd0: 206c 6f67 2e64 6562 7567 2822 7261 6e64   log.debug("rand
+00007be0: 6f6d 2065 7272 6f72 2229 0d0a 2020 2020  om error")..    
+00007bf0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00007c00: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00007c10: 6e73 6528 706f 6973 6f6e 5f70 696c 6c3d  nse(poison_pill=
+00007c20: 5472 7565 290d 0a0d 0a20 2020 2020 2020  True)....       
+00007c30: 2074 7279 3a0d 0a20 2020 2020 2020 2020   try:..         
+00007c40: 2020 2073 656c 662e 5f77 6169 745f 666f     self._wait_fo
+00007c50: 725f 7573 625f 6176 6169 6c61 626c 6528  r_usb_available(
+00007c60: 290d 0a20 2020 2020 2020 2020 2020 2072  )..            r
+00007c70: 6573 756c 7420 3d20 7365 6c66 2e64 6576  esult = self.dev
+00007c80: 6963 655f 7479 7065 2e63 7472 6c5f 7472  ice_type.ctrl_tr
+00007c90: 616e 7366 6572 2873 656c 662e 6465 7669  ansfer(self.devi
+00007ca0: 6365 2c0d 0a20 2020 2020 2020 2020 2020  ce,..           
+00007cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cd0: 2020 2020 3078 6330 2c20 2020 2020 2020      0xc0,       
+00007ce0: 2023 2044 4556 4943 455f 544f 5f48 4f53   # DEVICE_TO_HOS
+00007cf0: 540d 0a20 2020 2020 2020 2020 2020 2020  T..             
+00007d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d20: 2020 6252 6571 7565 7374 2c0d 0a20 2020    bRequest,..   
+00007d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d50: 2020 2020 2020 2020 2020 2020 7756 616c              wVal
+00007d60: 7565 2c0d 0a20 2020 2020 2020 2020 2020  ue,..           
+00007d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d90: 2020 2020 7749 6e64 6578 2c0d 0a20 2020      wIndex,..   
+00007da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007dc0: 2020 2020 2020 2020 2020 2020 774c 656e              wLen
+00007dd0: 6774 6829 0d0a 2020 2020 2020 2020 6578  gth)..        ex
+00007de0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00007df0: 7320 6578 633a 0d0a 2020 2020 2020 2020  s exc:..        
+00007e00: 2020 2020 6c6f 672e 6372 6974 6963 616c      log.critical
+00007e10: 2822 4861 7264 7761 7265 2046 6169 6c75  ("Hardware Failu
+00007e20: 7265 2046 4944 2047 6574 2043 6f64 6520  re FID Get Code 
+00007e30: 5072 6f62 6c65 6d20 7769 7468 2063 7472  Problem with ctr
+00007e40: 6c20 7472 616e 7366 6572 222c 2065 7863  l transfer", exc
+00007e50: 5f69 6e66 6f3d 3129 0d0a 2020 2020 2020  _info=1)..      
+00007e60: 2020 2020 2020 7365 6c66 2e5f 7363 6865        self._sche
+00007e70: 6475 6c65 5f64 6973 636f 6e6e 6563 7428  dule_disconnect(
+00007e80: 6578 6329 0d0a 2020 2020 2020 2020 2020  exc)..          
+00007e90: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+00007ea0: 6d65 7465 7252 6573 706f 6e73 6528 706f  meterResponse(po
+00007eb0: 6973 6f6e 5f70 696c 6c3d 5472 7565 290d  ison_pill=True).
+00007ec0: 0a0d 0a20 2020 2020 2020 206c 6f67 2e64  ...        log.d
+00007ed0: 6562 7567 2822 2573 5f67 6574 5f63 6f64  ebug("%s_get_cod
+00007ee0: 653a 2072 6571 7565 7374 2030 7825 3032  e: request 0x%02
+00007ef0: 7820 7661 6c75 6520 3078 2530 3478 2069  x value 0x%04x i
+00007f00: 6e64 6578 2030 7825 3034 7820 3d20 5b25  ndex 0x%04x = [%
+00007f10: 735d 222c 0d0a 2020 2020 2020 2020 2020  s]",..          
+00007f20: 2020 7072 6566 6978 2c20 6252 6571 7565    prefix, bReque
+00007f30: 7374 2c20 7756 616c 7565 2c20 7749 6e64  st, wValue, wInd
+00007f40: 6578 2c20 7265 7375 6c74 290d 0a0d 0a20  ex, result).... 
+00007f50: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
+00007f60: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
+00007f70: 2020 2020 2020 206c 6f67 2e63 7269 7469         log.criti
+00007f80: 6361 6c28 225f 6765 745f 636f 6465 5b25  cal("_get_code[%
+00007f90: 732c 2025 735d 3a20 7265 6365 6976 6564  s, %s]: received
+00007fa0: 206e 756c 6c22 2c20 6c61 6265 6c2c 2073   null", label, s
+00007fb0: 656c 662e 6465 7669 6365 5f69 6429 0d0a  elf.device_id)..
+00007fc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00007fd0: 2e5f 7363 6865 6475 6c65 5f64 6973 636f  ._schedule_disco
+00007fe0: 6e6e 6563 7428 6578 6329 0d0a 2020 2020  nnect(exc)..    
+00007ff0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00008000: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00008010: 6e73 6528 6b65 6570 5f61 6c69 7665 3d54  nse(keep_alive=T
+00008020: 7275 6529 0d0a 0d0a 2020 2020 2020 2020  rue)....        
+00008030: 2320 6465 6d61 7273 6861 6c6c 206f 7220  # demarshall or 
+00008040: 7265 7475 726e 2072 6177 2061 7272 6179  return raw array
+00008050: 0d0a 2020 2020 2020 2020 7661 6c75 6520  ..        value 
+00008060: 3d20 300d 0a20 2020 2020 2020 2069 6620  = 0..        if 
+00008070: 6d73 625f 6c65 6e20 6973 206e 6f74 204e  msb_len is not N
+00008080: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
+00008090: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+000080a0: 286d 7362 5f6c 656e 293a 0d0a 2020 2020  (msb_len):..    
+000080b0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+000080c0: 6520 3d20 7661 6c75 6520 3c3c 2038 207c  e = value << 8 |
+000080d0: 2072 6573 756c 745b 695d 0d0a 2020 2020   result[i]..    
+000080e0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+000080f0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00008100: 6e73 6528 6461 7461 3d76 616c 7565 290d  nse(data=value).
+00008110: 0a20 2020 2020 2020 2065 6c69 6620 6c73  .        elif ls
+00008120: 625f 6c65 6e20 6973 206e 6f74 204e 6f6e  b_len is not Non
+00008130: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00008140: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
+00008150: 7362 5f6c 656e 293a 0d0a 2020 2020 2020  sb_len):..      
+00008160: 2020 2020 2020 2020 2020 7661 6c75 6520            value 
+00008170: 3d20 2872 6573 756c 745b 695d 203c 3c20  = (result[i] << 
+00008180: 2838 202a 2069 2929 207c 2076 616c 7565  (8 * i)) | value
+00008190: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+000081a0: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+000081b0: 7252 6573 706f 6e73 6528 6461 7461 3d76  rResponse(data=v
+000081c0: 616c 7565 290d 0a20 2020 2020 2020 2065  alue)..        e
+000081d0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+000081e0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+000081f0: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+00008200: 7461 3d72 6573 756c 7429 0d0a 0d0a 2020  ta=result)....  
+00008210: 2020 6465 6620 6765 745f 7570 7065 725f    def get_upper_
+00008220: 636f 6465 2873 656c 662c 200d 0a20 2020  code(self, ..   
+00008230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008240: 2020 2020 7756 616c 7565 3a20 696e 742c      wValue: int,
+00008250: 200d 0a20 2020 2020 2020 2020 2020 2020   ..             
+00008260: 2020 2020 2020 2020 2020 7749 6e64 6578            wIndex
+00008270: 3a20 696e 7420 3d20 302c 200d 0a20 2020  : int = 0, ..   
+00008280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008290: 2020 2020 774c 656e 6774 683a 2069 6e74      wLength: int
+000082a0: 203d 2036 342c 200d 0a20 2020 2020 2020   = 64, ..       
+000082b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082c0: 6c61 6265 6c3a 2073 7472 203d 2022 222c  label: str = "",
+000082d0: 200d 0a20 2020 2020 2020 2020 2020 2020   ..             
+000082e0: 2020 2020 2020 2020 2020 6d73 625f 6c65            msb_le
+000082f0: 6e3a 2069 6e74 203d 204e 6f6e 652c 200d  n: int = None, .
+00008300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008310: 2020 2020 2020 2020 6c73 625f 6c65 6e3a          lsb_len:
+00008320: 2069 6e74 203d 204e 6f6e 6529 202d 3e20   int = None) -> 
+00008330: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+00008340: 6f6e 7365 3a0d 0a20 2020 2020 2020 2072  onse:..        r
+00008350: 6574 7572 6e20 7365 6c66 2e5f 6765 745f  eturn self._get_
+00008360: 636f 6465 2830 7866 662c 2077 5661 6c75  code(0xff, wValu
+00008370: 652c 2077 496e 6465 782c 2077 4c65 6e67  e, wIndex, wLeng
+00008380: 7468 2c20 6c61 6265 6c3d 6c61 6265 6c2c  th, label=label,
+00008390: 206d 7362 5f6c 656e 3d6d 7362 5f6c 656e   msb_len=msb_len
+000083a0: 2c20 6c73 625f 6c65 6e3d 6c73 625f 6c65  , lsb_len=lsb_le
+000083b0: 6e29 0d0a 0d0a 2020 2020 2320 2323 2323  n)....    # ####
+000083c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000083d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000083e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000083f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008400: 2323 2323 2323 0d0a 2020 2020 2320 696e  ######..    # in
+00008410: 6974 6961 6c69 7a61 7469 6f6e 0d0a 2020  itialization..  
+00008420: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
+00008430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008460: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+00008470: 0d0a 2020 2020 6465 6620 5f72 6561 645f  ..    def _read_
+00008480: 6565 7072 6f6d 2873 656c 6629 3a20 2320  eeprom(self): # 
+00008490: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+000084a0: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+000084b0: 2020 6275 6666 6572 7320 3d20 5b5d 0d0a    buffers = []..
+000084c0: 2020 2020 2020 2020 666f 7220 7061 6765          for page
+000084d0: 2069 6e20 7261 6e67 6528 4545 5052 4f4d   in range(EEPROM
+000084e0: 2e4d 4158 5f50 4147 4553 293a 0d0a 2020  .MAX_PAGES):..  
+000084f0: 2020 2020 2020 2020 2020 6275 6620 3d20            buf = 
+00008500: 4e6f 6e65 0d0a 2020 2020 2020 2020 2020  None..          
+00008510: 2020 7472 793a 0d0a 2020 2020 2020 2020    try:..        
+00008520: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00008530: 203d 2073 656c 662e 6765 745f 7570 7065   = self.get_uppe
+00008540: 725f 636f 6465 2830 7830 312c 2070 6167  r_code(0x01, pag
+00008550: 652c 206c 6162 656c 3d22 4745 545f 4d4f  e, label="GET_MO
+00008560: 4445 4c5f 434f 4e46 4947 2825 6429 2220  DEL_CONFIG(%d)" 
+00008570: 2520 7061 6765 290d 0a20 2020 2020 2020  % page)..       
+00008580: 2020 2020 2020 2020 2062 7566 203d 2072           buf = r
+00008590: 6573 706f 6e73 652e 6461 7461 0d0a 2020  esponse.data..  
+000085a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000085b0: 2072 6573 706f 6e73 652e 6572 726f 725f   response.error_
+000085c0: 6c76 6c20 213d 2045 7272 6f72 4c65 7665  lvl != ErrorLeve
+000085d0: 6c2e 6f6b 3a0d 0a20 2020 2020 2020 2020  l.ok:..         
+000085e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000085f0: 6e20 7265 7370 6f6e 7365 0d0a 2020 2020  n response..    
+00008600: 2020 2020 2020 2020 6578 6365 7074 3a0d          except:.
+00008610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008620: 206c 6f67 2e65 7272 6f72 2822 6578 6365   log.error("exce
+00008630: 7074 696f 6e20 7265 6164 696e 6720 7570  ption reading up
+00008640: 7065 725f 636f 6465 2030 7830 3120 7769  per_code 0x01 wi
+00008650: 7468 2070 6167 6520 2564 222c 2070 6167  th page %d", pag
+00008660: 652c 2065 7863 5f69 6e66 6f3d 3129 0d0a  e, exc_info=1)..
+00008670: 2020 2020 2020 2020 2020 2020 6275 665f              buf_
+00008680: 6c65 6e20 3d20 3020 6966 2062 7566 2069  len = 0 if buf i
+00008690: 7320 4e6f 6e65 2065 6c73 6520 6c65 6e28  s None else len(
+000086a0: 6275 6629 0d0a 2020 2020 2020 2020 2020  buf)..          
+000086b0: 2020 6966 2062 7566 2069 7320 4e6f 6e65    if buf is None
+000086c0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+000086d0: 2020 206d 7367 203d 2022 756e 6162 6c65     msg = "unable
+000086e0: 2074 6f20 7265 6164 2045 4550 524f 4d20   to read EEPROM 
+000086f0: 286e 756c 6c20 6275 6629 220d 0a20 2020  (null buf)"..   
+00008700: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00008710: 2e65 7272 6f72 286d 7367 290d 0a20 2020  .error(msg)..   
+00008720: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00008730: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00008740: 5265 7370 6f6e 7365 2846 616c 7365 2c20  Response(False, 
+00008750: 6572 726f 725f 6c76 6c3d 4572 726f 724c  error_lvl=ErrorL
+00008760: 6576 656c 2e6d 6564 6975 6d2c 6572 726f  evel.medium,erro
+00008770: 725f 6d73 673d 6d73 6729 0d0a 2020 2020  r_msg=msg)..    
+00008780: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
+00008790: 2862 7566 2920 3c20 3634 3a0d 0a20 2020  (buf) < 64:..   
+000087a0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+000087b0: 203d 2066 2275 6e61 626c 6520 746f 2072   = f"unable to r
+000087c0: 6561 6420 4545 5052 4f4d 2072 6563 6569  ead EEPROM recei
+000087d0: 7665 6420 6275 6620 6f66 207b 6275 667d  ved buf of {buf}
+000087e0: 2061 6e64 206c 656e 207b 6c65 6e28 6275   and len {len(bu
+000087f0: 6629 7d22 0d0a 2020 2020 2020 2020 2020  f)}"..          
+00008800: 2020 2020 2020 6c6f 672e 6572 726f 7228        log.error(
+00008810: 6d73 6729 0d0a 2020 2020 2020 2020 2020  msg)..          
+00008820: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
+00008830: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+00008840: 6528 4661 6c73 652c 2065 7272 6f72 5f6c  e(False, error_l
+00008850: 766c 3d45 7272 6f72 4c65 7665 6c2e 6d65  vl=ErrorLevel.me
+00008860: 6469 756d 2c65 7272 6f72 5f6d 7367 3d6d  dium,error_msg=m
+00008870: 7367 290d 0a20 2020 2020 2020 2020 2020  sg)..           
+00008880: 2062 7566 6665 7273 2e61 7070 656e 6428   buffers.append(
+00008890: 6275 6629 0d0a 0d0a 2020 2020 2020 2020  buf)....        
+000088a0: 666c 6174 5f62 7566 6665 7273 5f61 6c6c  flat_buffers_all
+000088b0: 5f6f 6e65 7320 3d20 5472 7565 0d0a 2020  _ones = True..  
+000088c0: 2020 2020 2020 666f 7220 7061 6765 2069        for page i
+000088d0: 6e20 6275 6666 6572 733a 0d0a 2020 2020  n buffers:..    
+000088e0: 2020 2020 2020 2020 666f 7220 6279 7465          for byte
+000088f0: 2069 6e20 7061 6765 3a0d 0a20 2020 2020   in page:..     
+00008900: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
+00008910: 6275 6666 6572 735f 616c 6c5f 6f6e 6573  buffers_all_ones
+00008920: 203d 2066 6c61 745f 6275 6666 6572 735f   = flat_buffers_
+00008930: 616c 6c5f 6f6e 6573 2061 6e64 2028 6279  all_ones and (by
+00008940: 7465 203d 3d20 3078 4646 290d 0a0d 0a20  te == 0xFF).... 
+00008950: 2020 2020 2020 2069 6620 666c 6174 5f62         if flat_b
+00008960: 7566 6665 7273 5f61 6c6c 5f6f 6e65 733a  uffers_all_ones:
+00008970: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00008980: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+00008990: 7252 6573 706f 6e73 6528 6461 7461 3d46  rResponse(data=F
+000089a0: 616c 7365 2c65 7272 6f72 5f6d 7367 3d22  alse,error_msg="
+000089b0: 5361 7720 616c 6c20 4673 2066 6f72 2045  Saw all Fs for E
+000089c0: 4550 524f 4d2e 2043 6865 636b 2045 4550  EPROM. Check EEP
+000089d0: 524f 4d20 5072 6f67 7261 6d6d 6564 2e22  ROM Programmed."
+000089e0: 2c65 7272 6f72 5f6c 766c 3d45 7272 6f72  ,error_lvl=Error
+000089f0: 4c65 7665 6c2e 6c6f 7729 0d0a 2020 2020  Level.low)..    
+00008a00: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
+00008a10: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
+00008a20: 6461 7461 3d73 656c 662e 7365 7474 696e  data=self.settin
+00008a30: 6773 2e65 6570 726f 6d2e 7061 7273 6528  gs.eeprom.parse(
+00008a40: 6275 6666 6572 7329 290d 0a0d 0a20 2020  buffers))....   
+00008a50: 2064 6566 2068 6173 5f6c 696e 6561 7269   def has_lineari
+00008a60: 7479 5f63 6f65 6666 7328 7365 6c66 293a  ty_coeffs(self):
+00008a70: 2023 202d 3e20 626f 6f6c 200d 0a20 2020   # -> bool ..   
+00008a80: 2020 2020 2022 2222 0d0a 2020 2020 2020       """..      
+00008a90: 2020 4174 206c 6561 7374 206f 6e65 206c    At least one l
+00008aa0: 696e 6561 7269 7479 2063 6f65 6666 2069  inearity coeff i
+00008ab0: 7320 6f74 6865 7220 7468 616e 2030 206f  s other than 0 o
+00008ac0: 7220 2d31 2028 616e 6420 6e6f 204e 614e  r -1 (and no NaN
+00008ad0: 292e 0d0a 0d0a 2020 2020 2020 2020 5075  ).....        Pu
+00008ae0: 626c 6963 2062 6563 6175 7365 2075 7365  blic because use
+00008af0: 6420 6279 2077 6173 6174 6368 2d73 6865  d by wasatch-she
+00008b00: 6c6c 2e0d 0a20 2020 2020 2020 2022 2222  ll...        """
+00008b10: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00008b20: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+00008b30: 6d2e 6c69 6e65 6172 6974 795f 636f 6566  m.linearity_coef
+00008b40: 6673 3a0d 0a20 2020 2020 2020 2020 2020  fs:..           
+00008b50: 2066 6f72 2063 2069 6e20 7365 6c66 2e73   for c in self.s
+00008b60: 6574 7469 6e67 732e 6565 7072 6f6d 2e6c  ettings.eeprom.l
+00008b70: 696e 6561 7269 7479 5f63 6f65 6666 733a  inearity_coeffs:
+00008b80: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00008b90: 2020 6966 206d 6174 682e 6973 6e61 6e28    if math.isnan(
+00008ba0: 6329 3a0d 0a20 2020 2020 2020 2020 2020  c):..           
+00008bb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00008bc0: 4661 6c73 650d 0a20 2020 2020 2020 2020  False..         
+00008bd0: 2020 2066 6f72 2063 2069 6e20 7365 6c66     for c in self
+00008be0: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00008bf0: 2e6c 696e 6561 7269 7479 5f63 6f65 6666  .linearity_coeff
+00008c00: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
+00008c10: 2020 2020 6966 2063 2021 3d20 3020 616e      if c != 0 an
+00008c20: 6420 6320 213d 202d 313a 0d0a 2020 2020  d c != -1:..    
+00008c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c40: 7265 7475 726e 2054 7275 650d 0a20 2020  return True..   
+00008c50: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+00008c60: 650d 0a0d 0a20 2020 2064 6566 205f 7265  e....    def _re
+00008c70: 6164 5f66 7067 615f 636f 6d70 696c 6174  ad_fpga_compilat
+00008c80: 696f 6e5f 6f70 7469 6f6e 7328 7365 6c66  ion_options(self
+00008c90: 293a 2023 202d 3e20 4e6f 6e65 200d 0a20  ): # -> None .. 
+00008ca0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00008cb0: 3d20 7365 6c66 2e67 6574 5f75 7070 6572  = self.get_upper
+00008cc0: 5f63 6f64 6528 3078 3034 2c20 6c61 6265  _code(0x04, labe
+00008cd0: 6c3d 2252 4541 445f 434f 4d50 494c 4154  l="READ_COMPILAT
+00008ce0: 494f 4e5f 4f50 5449 4f4e 5322 2c20 6c73  ION_OPTIONS", ls
+00008cf0: 625f 6c65 6e3d 3229 0d0a 2020 2020 2020  b_len=2)..      
+00008d00: 2020 776f 7264 203d 2072 6573 706f 6e73    word = respons
+00008d10: 652e 6461 7461 0d0a 2020 2020 2020 2020  e.data..        
+00008d20: 7365 6c66 2e73 6574 7469 6e67 732e 6670  self.settings.fp
+00008d30: 6761 5f6f 7074 696f 6e73 2e70 6172 7365  ga_options.parse
+00008d40: 2877 6f72 6429 0d0a 0d0a 2020 2020 2320  (word)....    # 
+00008d50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008d60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008d70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008d80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008d90: 2323 2323 2323 2323 2323 0d0a 2020 2020  ##########..    
+00008da0: 2320 4163 6365 7373 6f72 730d 0a20 2020  # Accessors..   
+00008db0: 2023 2023 2323 2323 2323 2323 2323 2323   # #############
+00008dc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008dd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008de0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00008df0: 2323 2323 2323 2323 2323 2323 230d 0a0d  #############...
+00008e00: 0a20 2020 2023 2040 746f 646f 2074 6573  .    # @todo tes
+00008e10: 7420 656e 6469 616e 206f 7264 6572 2028  t endian order (
+00008e20: 696e 2061 6e64 206f 7574 290d 0a20 2020  in and out)..   
+00008e30: 2064 6566 2067 6574 5f62 6174 7465 7279   def get_battery
+00008e40: 5f72 6567 6973 7465 7228 7365 6c66 2c20  _register(self, 
+00008e50: 7265 673a 2069 6e74 293a 2023 202d 3e20  reg: int): # -> 
+00008e60: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+00008e70: 6f6e 7365 200d 0a20 2020 2020 2020 2072  onse ..        r
+00008e80: 6567 203d 2072 6567 2026 2030 7866 6666  eg = reg & 0xfff
+00008e90: 660d 0a20 2020 2020 2020 2072 6574 7572  f..        retur
+00008ea0: 6e20 7365 6c66 2e67 6574 5f75 7070 6572  n self.get_upper
+00008eb0: 5f63 6f64 6528 3078 3134 2c20 7749 6e64  _code(0x14, wInd
+00008ec0: 6578 3d72 6567 2c20 6c61 6265 6c3d 2247  ex=reg, label="G
+00008ed0: 4554 5f42 4154 5445 5259 5f52 4547 222c  ET_BATTERY_REG",
+00008ee0: 206d 7362 5f6c 656e 3d32 290d 0a0d 0a20   msb_len=2).... 
+00008ef0: 2020 2064 6566 2067 6574 5f62 6174 7465     def get_batte
+00008f00: 7279 5f73 7461 7465 5f72 6177 2873 656c  ry_state_raw(sel
+00008f10: 6629 3a20 2320 2d3e 2053 7065 6374 726f  f): # -> Spectro
+00008f20: 6d65 7465 7252 6573 706f 6e73 6520 0d0a  meterResponse ..
+00008f30: 2020 2020 2020 2020 2222 2252 6574 7269          """Retri
+00008f40: 6576 6573 2074 6865 2072 6177 2062 6174  eves the raw bat
+00008f50: 7465 7279 2072 6561 6469 6e67 2061 6e64  tery reading and
+00008f60: 2074 6865 6e20 6361 6368 6573 2069 7420   then caches it 
+00008f70: 666f 7220 3120 7365 6322 2222 0d0a 2020  for 1 sec"""..  
+00008f80: 2020 2020 2020 6e6f 7720 3d20 6461 7465        now = date
+00008f90: 7469 6d65 2e64 6174 6574 696d 652e 6e6f  time.datetime.no
+00008fa0: 7728 290d 0a20 2020 2020 2020 2069 6620  w()..        if 
+00008fb0: 2873 656c 662e 7365 7474 696e 6773 2e73  (self.settings.s
+00008fc0: 7461 7465 2e62 6174 7465 7279 5f74 696d  tate.battery_tim
+00008fd0: 6573 7461 6d70 2069 7320 6e6f 7420 4e6f  estamp is not No
+00008fe0: 6e65 2061 6e64 206e 6f77 203c 2073 656c  ne and now < sel
+00008ff0: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
+00009000: 2e62 6174 7465 7279 5f74 696d 6573 7461  .battery_timesta
+00009010: 6d70 202b 2064 6174 6574 696d 652e 7469  mp + datetime.ti
+00009020: 6d65 6465 6c74 6128 7365 636f 6e64 733d  medelta(seconds=
+00009030: 3129 293a 0d0a 2020 2020 2020 2020 2020  1)):..          
+00009040: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+00009050: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+00009060: 7461 3d73 656c 662e 7365 7474 696e 6773  ta=self.settings
+00009070: 2e73 7461 7465 2e62 6174 7465 7279 5f72  .state.battery_r
+00009080: 6177 290d 0a0d 0a20 2020 2020 2020 2073  aw)....        s
+00009090: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+000090a0: 7465 2e62 6174 7465 7279 5f74 696d 6573  te.battery_times
+000090b0: 7461 6d70 203d 206e 6f77 0d0a 2020 2020  tamp = now..    
+000090c0: 2020 2020 7265 7370 6f6e 7365 203d 2073      response = s
+000090d0: 656c 662e 6765 745f 7570 7065 725f 636f  elf.get_upper_co
+000090e0: 6465 2830 7831 332c 206c 6162 656c 3d22  de(0x13, label="
+000090f0: 4745 545f 4241 5454 4552 595f 5354 4154  GET_BATTERY_STAT
+00009100: 4522 2c20 6d73 625f 6c65 6e3d 3329 0d0a  E", msb_len=3)..
+00009110: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
+00009120: 7469 6e67 732e 7374 6174 652e 6261 7474  tings.state.batt
+00009130: 6572 795f 7261 7720 3d20 7265 7370 6f6e  ery_raw = respon
+00009140: 7365 2e64 6174 610d 0a0d 0a20 2020 2020  se.data....     
+00009150: 2020 206c 6f67 2e64 6562 7567 2822 6261     log.debug("ba
+00009160: 7474 6572 795f 7374 6174 655f 7261 773a  ttery_state_raw:
+00009170: 207b 7365 6c66 2e73 6574 7469 6e67 732e   {self.settings.
+00009180: 7374 6174 652e 6261 7474 6572 795f 7261  state.battery_ra
+00009190: 777d 2229 0d0a 2020 2020 2020 2020 7265  w}")..        re
+000091a0: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+000091b0: 7252 6573 706f 6e73 6528 6461 7461 3d73  rResponse(data=s
+000091c0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+000091d0: 7465 2e62 6174 7465 7279 5f72 6177 290d  te.battery_raw).
+000091e0: 0a0d 0a20 2020 2064 6566 2067 6574 5f62  ...    def get_b
+000091f0: 6174 7465 7279 5f70 6572 6365 6e74 6167  attery_percentag
+00009200: 6528 7365 6c66 293a 2023 202d 3e20 5370  e(self): # -> Sp
+00009210: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00009220: 7365 200d 0a20 2020 2020 2020 2072 6573  se ..        res
+00009230: 706f 6e73 6520 3d20 7365 6c66 2e67 6574  ponse = self.get
+00009240: 5f62 6174 7465 7279 5f73 7461 7465 5f72  _battery_state_r
+00009250: 6177 2829 0d0a 2020 2020 2020 2020 776f  aw()..        wo
+00009260: 7264 203d 2072 6573 706f 6e73 652e 6461  rd = response.da
+00009270: 7461 0d0a 2020 2020 2020 2020 6c73 6220  ta..        lsb 
+00009280: 3d20 2877 6f72 6420 3e3e 2031 3629 2026  = (word >> 16) &
+00009290: 2030 7866 660d 0a20 2020 2020 2020 206d   0xff..        m
+000092a0: 7362 203d 2028 776f 7264 203e 3e20 2038  sb = (word >>  8
+000092b0: 2920 2620 3078 6666 0d0a 2020 2020 2020  ) & 0xff..      
+000092c0: 2020 7065 7263 203d 206d 7362 202b 2028    perc = msb + (
+000092d0: 312e 3020 2a20 6c73 6220 2f20 3235 362e  1.0 * lsb / 256.
+000092e0: 3029 0d0a 2020 2020 2020 2020 6c6f 672e  0)..        log.
+000092f0: 6465 6275 6728 2262 6174 7465 7279 5f70  debug("battery_p
+00009300: 6572 633a 2025 2e32 6625 2522 2c20 7065  erc: %.2f%%", pe
+00009310: 7263 290d 0a20 2020 2020 2020 2072 6574  rc)..        ret
+00009320: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00009330: 5265 7370 6f6e 7365 2864 6174 613d 7065  Response(data=pe
+00009340: 7263 290d 0a0d 0a20 2020 2064 6566 2067  rc)....    def g
+00009350: 6574 5f62 6174 7465 7279 5f63 6861 7267  et_battery_charg
+00009360: 696e 6728 7365 6c66 293a 2023 202d 3e20  ing(self): # -> 
+00009370: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+00009380: 6f6e 7365 200d 0a20 2020 2020 2020 2072  onse ..        r
+00009390: 6573 203d 2073 656c 662e 6765 745f 6261  es = self.get_ba
+000093a0: 7474 6572 795f 7374 6174 655f 7261 7728  ttery_state_raw(
+000093b0: 290d 0a20 2020 2020 2020 2077 6f72 6420  )..        word 
+000093c0: 3d20 7265 732e 6461 7461 0d0a 2020 2020  = res.data..    
+000093d0: 2020 2020 6368 6172 6769 6e67 203d 2028      charging = (
+000093e0: 3020 213d 2028 776f 7264 2026 2030 7866  0 != (word & 0xf
+000093f0: 6629 290d 0a20 2020 2020 2020 2072 6574  f))..        ret
+00009400: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00009410: 5265 7370 6f6e 7365 2864 6174 613d 6368  Response(data=ch
+00009420: 6172 6769 6e67 290d 0a0d 0a20 2020 2064  arging)....    d
+00009430: 6566 2067 6574 5f69 6e74 6567 7261 7469  ef get_integrati
+00009440: 6f6e 5f74 696d 655f 6d73 2873 656c 6629  on_time_ms(self)
+00009450: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+00009460: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+00009470: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+00009480: 2073 656c 662e 5f67 6574 5f63 6f64 6528   self._get_code(
+00009490: 3078 6266 2c20 6c61 6265 6c3d 2247 4554  0xbf, label="GET
+000094a0: 5f49 4e54 4547 5241 5449 4f4e 5f54 494d  _INTEGRATION_TIM
+000094b0: 455f 4d53 222c 206c 7362 5f6c 656e 3d33  E_MS", lsb_len=3
+000094c0: 290d 0a20 2020 2020 2020 206d 7320 3d20  )..        ms = 
+000094d0: 7265 7370 6f6e 7365 2e64 6174 610d 0a0d  response.data...
+000094e0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000094f0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
+00009500: 696e 7465 6772 6174 696f 6e5f 7469 6d65  integration_time
+00009510: 5f6d 7320 3e20 303a 0d0a 2020 2020 2020  _ms > 0:..      
+00009520: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+00009530: 6622 4745 545f 494e 5445 4752 4154 494f  f"GET_INTEGRATIO
+00009540: 4e5f 5449 4d45 5f4d 533a 206e 6f77 207b  N_TIME_MS: now {
+00009550: 6d73 7d22 290d 0a20 2020 2020 2020 2020  ms}")..         
+00009560: 2020 2073 656c 662e 7365 7474 696e 6773     self.settings
+00009570: 2e73 7461 7465 2e69 6e74 6567 7261 7469  .state.integrati
+00009580: 6f6e 5f74 696d 655f 6d73 203d 206d 730d  on_time_ms = ms.
+00009590: 0a20 2020 2020 2020 2065 6c73 653a 0d0a  .        else:..
+000095a0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+000095b0: 6465 6275 6728 2264 6563 6c69 6e69 6e67  debug("declining
+000095c0: 2074 6f20 696e 6974 6961 6c69 7a65 2073   to initialize s
+000095d0: 6573 7369 6f6e 2069 6e74 6567 7261 7469  ession integrati
+000095e0: 6f6e 5f74 696d 655f 6d73 2066 726f 6d20  on_time_ms from 
+000095f0: 7370 6563 7472 6f6d 6574 6572 2229 0d0a  spectrometer")..
+00009600: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00009610: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+00009620: 706f 6e73 6528 6461 7461 3d6d 7329 0d0a  ponse(data=ms)..
+00009630: 0d0a 2020 2020 6465 6620 7365 745f 6466  ..    def set_df
+00009640: 755f 656e 6162 6c65 2873 656c 6629 3a20  u_enable(self): 
+00009650: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+00009660: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+00009670: 2020 2020 2222 220d 0a20 2020 2020 2020      """..       
+00009680: 2050 7574 7320 4152 4d2d 6261 7365 6420   Puts ARM-based 
+00009690: 7370 6563 7472 6f6d 6574 6572 7320 696e  spectrometers in
+000096a0: 746f 2044 6576 6963 6520 4669 726d 7761  to Device Firmwa
+000096b0: 7265 2055 7064 6174 6520 2844 4655 2920  re Update (DFU) 
+000096c0: 6d6f 6465 2e0d 0a20 2020 2020 2020 2040  mode...        @
+000096d0: 7761 726e 696e 6720 7265 666c 6173 6869  warning reflashi
+000096e0: 6e67 2073 7065 6374 726f 6d65 7465 7220  ng spectrometer 
+000096f0: 6669 726d 7761 7265 2077 6974 686f 7574  firmware without
+00009700: 2073 7065 6369 6669 6320 696e 7374 7275   specific instru
+00009710: 6374 696f 6e20 616e 640d 0a20 2020 2020  ction and..     
+00009720: 2020 2073 7570 706f 7274 2066 726f 6d20     support from 
+00009730: 5761 7361 7463 6820 5068 6f74 6f6e 6963  Wasatch Photonic
+00009740: 7320 7769 6c6c 2076 6f69 6420 796f 7572  s will void your
+00009750: 2077 6172 7261 6e74 790d 0a20 2020 2020   warranty..     
+00009760: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+00009770: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
+00009780: 696e 6773 2e69 735f 6172 6d28 293a 0d0a  ings.is_arm():..
+00009790: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+000097a0: 3d20 2244 4655 206d 6f64 6520 6f6e 6c79  = "DFU mode only
+000097b0: 2073 7570 706f 7274 6564 2066 6f72 2041   supported for A
+000097c0: 524d 2d62 6173 6564 2073 7065 6374 726f  RM-based spectro
+000097d0: 6d65 7465 7273 220d 0a20 2020 2020 2020  meters"..       
+000097e0: 2020 2020 206c 6f67 2e65 7272 6f72 286d       log.error(m
+000097f0: 7367 290d 0a20 2020 2020 2020 2020 2020  sg)..           
+00009800: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+00009810: 6574 6572 5265 7370 6f6e 7365 2865 7272  eterResponse(err
+00009820: 6f72 5f6c 766c 3d45 7272 6f72 4c65 7665  or_lvl=ErrorLeve
+00009830: 6c2e 6c6f 772c 6572 726f 725f 6d73 673d  l.low,error_msg=
+00009840: 6d73 672c 206b 6565 705f 616c 6976 653d  msg, keep_alive=
+00009850: 5472 7565 290d 0a0d 0a20 2020 2020 2020  True)....       
+00009860: 2072 6573 756c 7420 3d20 7365 6c66 2e5f   result = self._
+00009870: 7365 6e64 5f63 6f64 6528 3078 6665 2c20  send_code(0xfe, 
+00009880: 6c61 6265 6c3d 2253 4554 5f44 4655 5f45  label="SET_DFU_E
+00009890: 4e41 424c 4522 290d 0a0d 0a20 2020 2020  NABLE")....     
+000098a0: 2020 2073 656c 662e 7175 6575 655f 6d65     self.queue_me
+000098b0: 7373 6167 6528 226d 6172 7175 6565 5f69  ssage("marquee_i
+000098c0: 6e66 6f22 2c20 2225 7320 696e 2044 4655  nfo", "%s in DFU
+000098d0: 206d 6f64 6522 2025 2073 656c 662e 7365   mode" % self.se
+000098e0: 7474 696e 6773 2e65 6570 726f 6d2e 7365  ttings.eeprom.se
+000098f0: 7269 616c 5f6e 756d 6265 7229 0d0a 0d0a  rial_number)....
+00009900: 2020 2020 2020 2020 7365 6c66 2e5f 7363          self._sc
+00009910: 6865 6475 6c65 5f64 6973 636f 6e6e 6563  hedule_disconnec
+00009920: 7428 4578 6365 7074 696f 6e28 2244 4655  t(Exception("DFU
+00009930: 204d 6f64 6522 2929 0d0a 2020 2020 2020   Mode"))..      
+00009940: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+00009950: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+00009960: 7461 3d72 6573 756c 7429 0d0a 0d0a 2020  ta=result)....  
+00009970: 2020 6465 6620 7365 745f 6465 7465 6374    def set_detect
+00009980: 6f72 5f6f 6666 7365 7428 7365 6c66 2c20  or_offset(self, 
+00009990: 7661 6c75 653a 2069 6e74 293a 2023 202d  value: int): # -
+000099a0: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+000099b0: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+000099c0: 2077 6f72 6420 3d20 7574 696c 732e 636c   word = utils.cl
+000099d0: 616d 705f 746f 5f69 6e74 3136 2876 616c  amp_to_int16(val
+000099e0: 7565 290d 0a20 2020 2020 2020 2073 656c  ue)..        sel
+000099f0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+00009a00: 6d2e 6465 7465 6374 6f72 5f6f 6666 7365  m.detector_offse
+00009a10: 7420 3d20 776f 7264 0d0a 2020 2020 2020  t = word..      
+00009a20: 2020 2320 6c6f 672e 6465 6275 6728 2276    # log.debug("v
+00009a30: 616c 7565 2025 6420 2825 7329 203d 2030  alue %d (%s) = 0
+00009a40: 7825 3034 7820 2825 7329 222c 2076 616c  x%04x (%s)", val
+00009a50: 7565 2c20 666f 726d 6174 2876 616c 7565  ue, format(value
+00009a60: 2c20 2762 2729 2c20 776f 7264 2c20 666f  , 'b'), word, fo
+00009a70: 726d 6174 2877 6f72 642c 2027 6227 2929  rmat(word, 'b'))
+00009a80: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00009a90: 2073 656c 662e 5f73 656e 645f 636f 6465   self._send_code
+00009aa0: 2830 7862 362c 2077 6f72 642c 206c 6162  (0xb6, word, lab
+00009ab0: 656c 3d22 5345 545f 4445 5445 4354 4f52  el="SET_DETECTOR
+00009ac0: 5f4f 4646 5345 5422 290d 0a0d 0a20 2020  _OFFSET")....   
+00009ad0: 2064 6566 2073 6574 5f64 6574 6563 746f   def set_detecto
+00009ae0: 725f 6f66 6673 6574 5f6f 6464 2873 656c  r_offset_odd(sel
+00009af0: 662c 2076 616c 7565 3a20 696e 7429 3a20  f, value: int): 
+00009b00: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+00009b10: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+00009b20: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00009b30: 7365 7474 696e 6773 2e69 735f 696e 6761  settings.is_inga
+00009b40: 6173 2829 3a0d 0a20 2020 2020 2020 2020  as():..         
+00009b50: 2020 206c 6f67 2e64 6562 7567 2822 5345     log.debug("SE
+00009b60: 545f 4445 5445 4354 4f52 5f4f 4646 5345  T_DETECTOR_OFFSE
+00009b70: 545f 4f44 4420 6f6e 6c79 2073 7570 706f  T_ODD only suppo
+00009b80: 7274 6564 206f 6e20 496e 4761 4173 2229  rted on InGaAs")
+00009b90: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00009ba0: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+00009bb0: 7252 6573 706f 6e73 6528 6b65 6570 5f61  rResponse(keep_a
+00009bc0: 6c69 7665 3d54 7275 652c 6572 726f 725f  live=True,error_
+00009bd0: 6c76 6c3d 4572 726f 724c 6576 656c 2e6c  lvl=ErrorLevel.l
+00009be0: 6f77 290d 0a0d 0a20 2020 2020 2020 2077  ow)....        w
+00009bf0: 6f72 6420 3d20 7574 696c 732e 636c 616d  ord = utils.clam
+00009c00: 705f 746f 5f69 6e74 3136 2876 616c 7565  p_to_int16(value
+00009c10: 290d 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00009c20: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+00009c30: 6465 7465 6374 6f72 5f6f 6666 7365 745f  detector_offset_
+00009c40: 6f64 6420 3d20 776f 7264 0d0a 0d0a 2020  odd = word....  
+00009c50: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00009c60: 662e 5f73 656e 645f 636f 6465 2830 7839  f._send_code(0x9
+00009c70: 632c 2077 6f72 642c 206c 6162 656c 3d22  c, word, label="
+00009c80: 5345 545f 4445 5445 4354 4f52 5f4f 4646  SET_DETECTOR_OFF
+00009c90: 5345 545f 4f44 4422 290d 0a0d 0a20 2020  SET_ODD")....   
+00009ca0: 2064 6566 2067 6574 5f64 6574 6563 746f   def get_detecto
+00009cb0: 725f 6761 696e 2873 656c 662c 2075 7064  r_gain(self, upd
+00009cc0: 6174 655f 7365 7373 696f 6e5f 6565 7072  ate_session_eepr
+00009cd0: 6f6d 3a20 626f 6f6c 203d 2046 616c 7365  om: bool = False
+00009ce0: 293a 2023 202d 3e20 5370 6563 7472 6f6d  ): # -> Spectrom
+00009cf0: 6574 6572 5265 7370 6f6e 7365 200d 0a20  eterResponse .. 
+00009d00: 2020 2020 2020 2022 2222 0d0a 2020 2020         """..    
+00009d10: 2020 2020 5265 6164 2074 6865 2064 6576      Read the dev
+00009d20: 6963 6520 7374 6f72 6564 2067 6169 6e2e  ice stored gain.
+00009d30: 2020 436f 6e76 6572 7420 6672 6f6d 2062    Convert from b
+00009d40: 696e 6172 7920 2268 616c 662d 7072 6563  inary "half-prec
+00009d50: 6973 696f 6e22 2066 6c6f 6174 2e0d 0a20  ision" float... 
+00009d60: 2020 2020 2020 202d 2031 7374 2062 7974         - 1st byt
+00009d70: 6520 284c 5342 2920 6973 2062 696e 6172  e (LSB) is binar
+00009d80: 7920 656e 636f 6465 643a 2062 6974 2030  y encoded: bit 0
+00009d90: 203d 2031 2f32 2c20 6269 7420 3120 3d20   = 1/2, bit 1 = 
+00009da0: 312f 342c 2062 6974 2032 203d 2031 2f38  1/4, bit 2 = 1/8
+00009db0: 2065 7463 2e0d 0a20 2020 2020 2020 202d   etc...        -
+00009dc0: 2032 6e64 2062 7974 6520 284d 5342 2920   2nd byte (MSB) 
+00009dd0: 6973 2074 6865 2069 6e74 6567 7261 6c20  is the integral 
+00009de0: 7061 7274 2074 6f20 7468 6520 6c65 6674  part to the left
+00009df0: 206f 6620 7468 6520 6465 6369 6d61 6c0d   of the decimal.
+00009e00: 0a20 2020 2020 2020 2045 2e67 2e2c 2032  .        E.g., 2
+00009e10: 3331 2064 6563 203d 3d20 3078 3031 6537  31 dec == 0x01e7
+00009e20: 203d 3d20 312e 3930 3233 3433 3735 0d0a   == 1.90234375..
+00009e30: 2020 2020 2020 2020 2222 220d 0a20 2020          """..   
+00009e40: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
+00009e50: 5f67 6574 5f63 6f64 6528 3078 6335 2c20  _get_code(0xc5, 
+00009e60: 6c61 6265 6c3d 2247 4554 5f44 4554 4543  label="GET_DETEC
+00009e70: 544f 525f 4741 494e 2229 0d0a 2020 2020  TOR_GAIN")..    
+00009e80: 2020 2020 7265 7375 6c74 203d 2072 6573      result = res
+00009e90: 2e64 6174 610d 0a0d 0a20 2020 2020 2020  .data....       
+00009ea0: 2069 6620 7265 7375 6c74 2069 7320 4e6f   if result is No
+00009eb0: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+00009ec0: 206d 7367 203d 2022 4745 545f 4445 5445   msg = "GET_DETE
+00009ed0: 4354 4f52 5f47 4149 4e20 7265 7475 726e  CTOR_GAIN return
+00009ee0: 6564 204e 554c 4c21 220d 0a20 2020 2020  ed NULL!"..     
+00009ef0: 2020 2020 2020 206c 6f67 2e65 7272 6f72         log.error
+00009f00: 286d 7367 290d 0a20 2020 2020 2020 2020  (msg)..         
+00009f10: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+00009f20: 6f6d 6574 6572 5265 7370 6f6e 7365 2865  ometerResponse(e
+00009f30: 7272 6f72 5f6c 766c 3d45 7272 6f72 4c65  rror_lvl=ErrorLe
+00009f40: 7665 6c2e 6d65 6469 756d 2c65 7272 6f72  vel.medium,error
+00009f50: 5f6d 7367 3d6d 7367 2c6b 6565 705f 616c  _msg=msg,keep_al
+00009f60: 6976 653d 5472 7565 290d 0a0d 0a20 2020  ive=True)....   
+00009f70: 2020 2020 206c 7362 203d 2072 6573 756c       lsb = resul
+00009f80: 745b 305d 2023 204c 5342 2d4d 5342 0d0a  t[0] # LSB-MSB..
+00009f90: 2020 2020 2020 2020 6d73 6220 3d20 7265          msb = re
+00009fa0: 7375 6c74 5b31 5d0d 0a20 2020 2020 2020  sult[1]..       
+00009fb0: 2072 6177 203d 2028 6d73 6220 3c3c 2038   raw = (msb << 8
+00009fc0: 2920 7c20 6c73 620d 0a0d 0a20 2020 2020  ) | lsb....     
+00009fd0: 2020 2067 6169 6e20 3d20 6d73 6220 2b20     gain = msb + 
+00009fe0: 6c73 6220 2f20 3235 362e 300d 0a20 2020  lsb / 256.0..   
+00009ff0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
+0000a000: 6765 745f 6465 7465 6374 6f72 5f67 6169  get_detector_gai
+0000a010: 6e3a 2025 6620 2872 6177 2030 7825 3034  n: %f (raw 0x%04
+0000a020: 7829 2028 7365 7373 696f 6e20 6565 7072  x) (session eepr
+0000a030: 6f6d 2025 6629 2220 2520 280d 0a20 2020  om %f)" % (..   
+0000a040: 2020 2020 2020 2020 2067 6169 6e2c 2072           gain, r
+0000a050: 6177 2c20 7365 6c66 2e73 6574 7469 6e67  aw, self.setting
+0000a060: 732e 6565 7072 6f6d 2e64 6574 6563 746f  s.eeprom.detecto
+0000a070: 725f 6761 696e 2929 0d0a 0d0a 2020 2020  r_gain))....    
+0000a080: 2020 2020 6966 2075 7064 6174 655f 7365      if update_se
+0000a090: 7373 696f 6e5f 6565 7072 6f6d 3a0d 0a20  ssion_eeprom:.. 
+0000a0a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000a0b0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+0000a0c0: 6465 7465 6374 6f72 5f67 6169 6e20 3d20  detector_gain = 
+0000a0d0: 6761 696e 0d0a 0d0a 2020 2020 2020 2020  gain....        
+0000a0e0: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+0000a0f0: 2e69 735f 6d69 6372 6f28 293a 0d0a 2020  .is_micro():..  
+0000a100: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0000a110: 6574 7469 6e67 732e 7374 6174 652e 6761  ettings.state.ga
+0000a120: 696e 5f64 6220 3d20 6761 696e 0d0a 0d0a  in_db = gain....
+0000a130: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+0000a140: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0000a150: 6e73 6528 6461 7461 3d67 6169 6e29 0d0a  nse(data=gain)..
+0000a160: 0d0a 2020 2020 6465 6620 6765 745f 6465  ..    def get_de
+0000a170: 7465 6374 6f72 5f67 6169 6e5f 6f64 6428  tector_gain_odd(
+0000a180: 7365 6c66 2c20 7570 6461 7465 5f73 6573  self, update_ses
+0000a190: 7369 6f6e 5f65 6570 726f 6d3a 2062 6f6f  sion_eeprom: boo
+0000a1a0: 6c20 3d20 4661 6c73 6529 3a20 2320 2d3e  l = False): # ->
+0000a1b0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0000a1c0: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0000a1d0: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
+0000a1e0: 696e 6773 2e69 735f 696e 6761 6173 2829  ings.is_ingaas()
+0000a1f0: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
+0000a200: 6f67 2e64 6562 7567 2822 4745 545f 4445  og.debug("GET_DE
+0000a210: 5445 4354 4f52 5f47 4149 4e5f 4f44 4420  TECTOR_GAIN_ODD 
+0000a220: 6f6e 6c79 2073 7570 706f 7274 6564 206f  only supported o
+0000a230: 6e20 496e 4761 4173 2229 0d0a 2020 2020  n InGaAs")..    
+0000a240: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+0000a250: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0000a260: 6e73 6528 6461 7461 3d73 656c 662e 7365  nse(data=self.se
+0000a270: 7474 696e 6773 2e65 6570 726f 6d2e 6465  ttings.eeprom.de
+0000a280: 7465 6374 6f72 5f67 6169 6e5f 6f64 6429  tector_gain_odd)
+0000a290: 0d0a 0d0a 2020 2020 2020 2020 7265 7375  ....        resu
+0000a2a0: 6c74 203d 2073 656c 662e 5f67 6574 5f63  lt = self._get_c
+0000a2b0: 6f64 6528 3078 3966 2c20 6c61 6265 6c3d  ode(0x9f, label=
+0000a2c0: 2247 4554 5f44 4554 4543 544f 525f 4741  "GET_DETECTOR_GA
+0000a2d0: 494e 5f4f 4444 2229 0d0a 0d0a 2020 2020  IN_ODD")....    
+0000a2e0: 2020 2020 6c73 6220 3d20 7265 7375 6c74      lsb = result
+0000a2f0: 5b30 5d20 2320 4c53 422d 4d53 420d 0a20  [0] # LSB-MSB.. 
+0000a300: 2020 2020 2020 206d 7362 203d 2072 6573         msb = res
+0000a310: 756c 745b 315d 0d0a 2020 2020 2020 2020  ult[1]..        
+0000a320: 7261 7720 3d20 286d 7362 203c 3c20 3829  raw = (msb << 8)
+0000a330: 207c 206c 7362 0d0a 0d0a 2020 2020 2020   | lsb....      
+0000a340: 2020 6761 696e 203d 206d 7362 202b 206c    gain = msb + l
+0000a350: 7362 202f 2032 3536 2e30 0d0a 2020 2020  sb / 256.0..    
+0000a360: 2020 2020 6c6f 672e 6465 6275 6728 2267      log.debug("g
+0000a370: 6574 5f64 6574 6563 746f 725f 6761 696e  et_detector_gain
+0000a380: 5f6f 6464 3a20 2566 2028 3078 2530 3478  _odd: %f (0x%04x
+0000a390: 2920 2873 6573 7369 6f6e 2065 6570 726f  ) (session eepro
+0000a3a0: 6d20 2566 2922 2025 2028 0d0a 2020 2020  m %f)" % (..    
+0000a3b0: 2020 2020 2020 2020 6761 696e 2c20 7261          gain, ra
+0000a3c0: 772c 2073 656c 662e 7365 7474 696e 6773  w, self.settings
+0000a3d0: 2e65 6570 726f 6d2e 6465 7465 6374 6f72  .eeprom.detector
+0000a3e0: 5f67 6169 6e5f 6f64 6429 290d 0a20 2020  _gain_odd))..   
+0000a3f0: 2020 2020 2069 6620 7570 6461 7465 5f73       if update_s
+0000a400: 6573 7369 6f6e 5f65 6570 726f 6d3a 0d0a  ession_eeprom:..
+0000a410: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000a420: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+0000a430: 2e64 6574 6563 746f 725f 6761 696e 5f6f  .detector_gain_o
+0000a440: 6464 203d 2067 6169 6e0d 0a20 2020 2020  dd = gain..     
+0000a450: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+0000a460: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+0000a470: 6174 613d 6761 696e 290d 0a0d 0a20 2020  ata=gain)....   
+0000a480: 2023 230d 0a20 2020 2023 204e 6f74 6520   ##..    # Note 
+0000a490: 7468 6174 2074 6869 7320 6973 2075 7365  that this is use
+0000a4a0: 6420 666f 7220 6465 7465 6374 6f72 2074  d for detector t
+0000a4b0: 7970 6573 2c20 696e 636c 7564 696e 673a  ypes, including:
+0000a4c0: 0d0a 2020 2020 230d 0a20 2020 2023 202d  ..    #..    # -
+0000a4d0: 2048 616d 616d 6174 7375 2073 696c 6963   Hamamatsu silic
+0000a4e0: 6f6e 2028 5331 3630 3130 2d2a 2c20 5331  on (S16010-*, S1
+0000a4f0: 3630 3131 2d2a 2c20 6574 6329 0d0a 2020  6011-*, etc)..  
+0000a500: 2020 2320 2d20 4861 6d61 6d61 7473 7520    # - Hamamatsu 
+0000a510: 496e 4761 4173 2028 4739 3231 3420 6574  InGaAs (G9214 et
+0000a520: 6329 0d0a 2020 2020 2320 2d20 536f 6e79  c)..    # - Sony
+0000a530: 2049 4d58 2028 494d 5833 3835 2065 7463   IMX (IMX385 etc
+0000a540: 290d 0a20 2020 2023 0d0a 2020 2020 2320  )..    #..    # 
+0000a550: 4974 2069 7320 696d 706f 7274 616e 7420  It is important 
+0000a560: 746f 2075 6e64 6572 7374 616e 6420 7468  to understand th
+0000a570: 6174 2074 6865 2055 4e49 5420 6f66 2074  at the UNIT of t
+0000a580: 6869 7320 7661 6c75 6520 6368 616e 6765  his value change
+0000a590: 7320 6265 7477 6565 6e0d 0a20 2020 2023  s between..    #
+0000a5a0: 2048 616d 616d 6174 7375 2061 6e64 2049   Hamamatsu and I
+0000a5b0: 4d58 2064 6574 6563 746f 7273 2c20 6275  MX detectors, bu
+0000a5c0: 7420 7468 6520 4441 5441 5459 5045 2064  t the DATATYPE d
+0000a5d0: 6f65 7320 6e6f 742e 0d0a 2020 2020 230d  oes not...    #.
+0000a5e0: 0a20 2020 2023 2052 6561 736f 6e61 626c  .    # Reasonabl
+0000a5f0: 6520 6761 696e 206c 6576 656c 7320 666f  e gain levels fo
+0000a600: 7220 4861 6d61 6d61 7473 7520 6172 6520  r Hamamatsu are 
+0000a610: 6120 666c 6f61 7469 6e67 2d70 6f69 6e74  a floating-point
+0000a620: 2073 6361 6c61 722c 206c 6974 6572 616c   scalar, literal
+0000a630: 6c79 0d0a 2020 2020 2320 7573 6564 2074  ly..    # used t
+0000a640: 6f20 7363 616c 6520 2867 6169 6e29 2074  o scale (gain) t
+0000a650: 6865 2073 6967 6e61 6c2c 2061 6e64 2061  he signal, and a
+0000a660: 7265 2075 7375 616c 6c79 2069 6e20 7468  re usually in th
+0000a670: 6520 7261 6e67 6520 2830 2e38 202e 2e20  e range (0.8 .. 
+0000a680: 312e 3229 0d0a 2020 2020 2320 6f72 2074  1.2)..    # or t
+0000a690: 6865 7265 6162 6f75 7473 2e0d 0a20 2020  hereabouts...   
+0000a6a0: 2023 0d0a 2020 2020 2320 5265 6173 6f6e   #..    # Reason
+0000a6b0: 6162 6c65 206c 6576 656c 7320 666f 7220  able levels for 
+0000a6c0: 494d 5820 7365 6e73 6f72 7320 6172 6520  IMX sensors are 
+0000a6d0: 696e 2064 4220 616e 6420 7661 7279 2062  in dB and vary b
+0000a6e0: 7920 6465 7465 6374 6f72 2c20 6275 7420  y detector, but 
+0000a6f0: 6172 650d 0a20 2020 2023 2075 7375 616c  are..    # usual
+0000a700: 6c79 2069 6e20 7468 6520 7261 6e67 6520  ly in the range 
+0000a710: 2830 2e30 202e 2e20 3331 2e30 292c 2077  (0.0 .. 31.0), w
+0000a720: 6974 6820 6578 6163 746c 7920 302e 3164  ith exactly 0.1d
+0000a730: 4220 7072 6563 6973 696f 6e2e 2020 5468  B precision.  Th
+0000a740: 650d 0a20 2020 2023 2073 7065 6374 726f  e..    # spectro
+0000a750: 6d65 7465 7227 7320 4657 2077 696c 6c20  meter's FW will 
+0000a760: 726f 756e 6420 746f 2074 6865 206e 6561  round to the nea
+0000a770: 7265 7374 2073 6574 7469 6e67 2028 312e  rest setting (1.
+0000a780: 3233 2077 696c 6c20 6265 2072 6f75 6e64  23 will be round
+0000a790: 6564 0d0a 2020 2020 2320 746f 2031 2e32  ed..    # to 1.2
+0000a7a0: 292e 2020 494d 5820 7365 6e73 6f72 7320  ).  IMX sensors 
+0000a7b0: 7377 6974 6368 2066 726f 6d20 2261 6e61  switch from "ana
+0000a7c0: 6c6f 6720 6761 696e 2220 746f 2022 6469  log gain" to "di
+0000a7d0: 6769 7461 6c20 6761 696e 2220 6162 6f76  gital gain" abov
+0000a7e0: 650d 0a20 2020 2023 2061 2067 6976 656e  e..    # a given
+0000a7f0: 2074 6872 6573 686f 6c64 2e2e 2e6f 6e20   threshold...on 
+0000a800: 7468 6520 494d 5831 3233 2c20 616e 616c  the IMX123, anal
+0000a810: 6f67 2067 6169 6e20 6973 2030 2e30 202d  og gain is 0.0 -
+0000a820: 2033 312e 302c 2061 6e64 2064 6967 6974   31.0, and digit
+0000a830: 616c 0d0a 2020 2020 2320 6973 2033 312e  al..    # is 31.
+0000a840: 3120 2d20 3732 2e30 2028 4920 7468 696e  1 - 72.0 (I thin
+0000a850: 6b29 2e0d 0a20 2020 2023 0d0a 2020 2020  k)...    #..    
+0000a860: 2320 4073 6565 2068 7474 7073 3a2f 2f77  # @see https://w
+0000a870: 6173 6174 6368 7068 6f74 6f6e 6963 732e  asatchphotonics.
+0000a880: 636f 6d2f 6170 692f 5761 7361 7463 682e  com/api/Wasatch.
+0000a890: 4e45 542f 636c 6173 735f 7761 7361 7463  NET/class_wasatc
+0000a8a0: 685f 6e5f 655f 745f 315f 315f 6675 6e6b  h_n_e_t_1_1_funk
+0000a8b0: 795f 666c 6f61 742e 6874 6d6c 0d0a 2020  y_float.html..  
+0000a8c0: 2020 6465 6620 7365 745f 6465 7465 6374    def set_detect
+0000a8d0: 6f72 5f67 6169 6e28 7365 6c66 2c20 6761  or_gain(self, ga
+0000a8e0: 696e 3a20 666c 6f61 7429 3a20 2320 2d3e  in: float): # ->
+0000a8f0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0000a900: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0000a910: 7261 7720 3d20 7365 6c66 2e73 6574 7469  raw = self.setti
+0000a920: 6e67 732e 6565 7072 6f6d 2e66 6c6f 6174  ngs.eeprom.float
+0000a930: 5f74 6f5f 7569 6e74 3136 2867 6169 6e29  _to_uint16(gain)
+0000a940: 0d0a 0d0a 2020 2020 2020 2020 2320 4d5a  ....        # MZ
+0000a950: 3a20 6e6f 7465 2074 6861 7420 7765 2053  : note that we S
+0000a960: 454e 4420 6761 696e 204d 5342 2d4c 5342  END gain MSB-LSB
+0000a970: 2c20 6275 7420 7765 2052 4541 4420 6761  , but we READ ga
+0000a980: 696e 204c 5342 2d4d 5342 3f21 0d0a 2020  in LSB-MSB?!..  
+0000a990: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+0000a9a0: 2253 656e 6420 4465 7465 6374 6f72 2047  "Send Detector G
+0000a9b0: 6169 6e3a 2030 7825 3034 7820 2825 7329  ain: 0x%04x (%s)
+0000a9c0: 222c 2072 6177 2c20 6761 696e 290d 0a20  ", raw, gain).. 
+0000a9d0: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
+0000a9e0: 696e 6773 2e65 6570 726f 6d2e 6465 7465  ings.eeprom.dete
+0000a9f0: 6374 6f72 5f67 6169 6e20 3d20 6761 696e  ctor_gain = gain
+0000aa00: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000aa10: 2073 656c 662e 5f73 656e 645f 636f 6465   self._send_code
+0000aa20: 2830 7862 372c 2072 6177 2c20 6c61 6265  (0xb7, raw, labe
+0000aa30: 6c3d 2253 4554 5f44 4554 4543 544f 525f  l="SET_DETECTOR_
+0000aa40: 4741 494e 2229 0d0a 0d0a 2020 2020 6465  GAIN")....    de
+0000aa50: 6620 7365 745f 6465 7465 6374 6f72 5f67  f set_detector_g
+0000aa60: 6169 6e5f 6f64 6428 7365 6c66 2c20 6761  ain_odd(self, ga
+0000aa70: 696e 3a20 666c 6f61 7429 3a20 2320 2d3e  in: float): # ->
+0000aa80: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0000aa90: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0000aaa0: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
+0000aab0: 696e 6773 2e69 735f 696e 6761 6173 2829  ings.is_ingaas()
+0000aac0: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
+0000aad0: 6f67 2e64 6562 7567 2822 5345 545f 4445  og.debug("SET_DE
+0000aae0: 5445 4354 4f52 5f47 4149 4e5f 4f44 4420  TECTOR_GAIN_ODD 
+0000aaf0: 6f6e 6c79 2073 7570 706f 7274 6564 206f  only supported o
+0000ab00: 6e20 496e 4761 4173 2229 0d0a 2020 2020  n InGaAs")..    
+0000ab10: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+0000ab20: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0000ab30: 6e73 6528 6572 726f 725f 6c76 6c3d 4572  nse(error_lvl=Er
+0000ab40: 726f 724c 6576 656c 2e6c 6f77 2c20 6572  rorLevel.low, er
+0000ab50: 726f 725f 6d73 673d 2253 4554 5f44 4554  ror_msg="SET_DET
+0000ab60: 4543 544f 525f 4741 494e 5f4f 4444 206f  ECTOR_GAIN_ODD o
+0000ab70: 6e6c 7920 7375 7070 6f72 7465 6420 6f6e  nly supported on
+0000ab80: 2049 6e47 6141 7322 290d 0a0d 0a20 2020   InGaAs")....   
+0000ab90: 2020 2020 2072 6177 203d 2073 656c 662e       raw = self.
+0000aba0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+0000abb0: 666c 6f61 745f 746f 5f75 696e 7431 3628  float_to_uint16(
+0000abc0: 6761 696e 290d 0a0d 0a20 2020 2020 2020  gain)....       
+0000abd0: 2023 204d 5a3a 206e 6f74 6520 7468 6174   # MZ: note that
+0000abe0: 2077 6520 5345 4e44 2067 6169 6e20 4d53   we SEND gain MS
+0000abf0: 422d 4c53 422c 2062 7574 2077 6520 5245  B-LSB, but we RE
+0000ac00: 4144 2067 6169 6e20 4c53 422d 4d53 423f  AD gain LSB-MSB?
+0000ac10: 210d 0a20 2020 2020 2020 206c 6f67 2e64  !..        log.d
+0000ac20: 6562 7567 2822 5365 6e64 2044 6574 6563  ebug("Send Detec
+0000ac30: 746f 7220 4761 696e 204f 6464 3a20 3078  tor Gain Odd: 0x
+0000ac40: 2530 3478 2028 2573 2922 2c20 7261 772c  %04x (%s)", raw,
+0000ac50: 2067 6169 6e29 0d0a 2020 2020 2020 2020   gain)..        
+0000ac60: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+0000ac70: 7072 6f6d 2e64 6574 6563 746f 725f 6761  prom.detector_ga
+0000ac80: 696e 5f6f 6464 203d 2067 6169 6e0d 0a20  in_odd = gain.. 
+0000ac90: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000aca0: 6c66 2e5f 7365 6e64 5f63 6f64 6528 3078  lf._send_code(0x
+0000acb0: 3964 2c20 7261 772c 206c 6162 656c 3d22  9d, raw, label="
+0000acc0: 5345 545f 4445 5445 4354 4f52 5f47 4149  SET_DETECTOR_GAI
+0000acd0: 4e5f 4f44 4422 290d 0a0d 0a20 2020 2023  N_ODD")....    #
+0000ace0: 230d 0a20 2020 2023 2048 6973 746f 7269  #..    # Histori
+0000acf0: 6361 6c6c 792c 2074 6869 7320 6f70 636f  cally, this opco
+0000ad00: 6465 206d 6f76 6564 2061 726f 756e 6420  de moved around 
+0000ad10: 6120 6269 742e 2020 4174 206f 6e65 2070  a bit.  At one p
+0000ad20: 6f69 6e74 2069 7420 7761 7320 3078 6562  oint it was 0xeb
+0000ad30: 0d0a 2020 2020 2320 2861 6e64 2069 7320  ..    # (and is 
+0000ad40: 6e6f 7720 6167 6169 6e29 2c20 7768 6963  now again), whic
+0000ad50: 6820 636f 6e66 6c69 6374 7320 7769 7468  h conflicts with
+0000ad60: 2043 465f 5345 4c45 4354 292e 2020 4174   CF_SELECT).  At
+0000ad70: 206f 7468 6572 2074 696d 6573 2069 740d   other times it.
+0000ad80: 0a20 2020 2023 2077 6173 2030 7865 392c  .    # was 0xe9,
+0000ad90: 2077 6869 6368 2063 6f6e 666c 6963 7465   which conflicte
+0000ada0: 6420 7769 7468 204c 4153 4552 5f52 414d  d with LASER_RAM
+0000adb0: 505f 454e 4142 4c45 2e20 2054 6869 7320  P_ENABLE.  This 
+0000adc0: 7365 656d 7320 746f 2062 6520 7768 6174  seems to be what
+0000add0: 0d0a 2020 2020 2320 7765 2772 6520 7374  ..    # we're st
+0000ade0: 616e 6461 7264 697a 696e 6720 6f6e 2068  andardizing on h
+0000adf0: 656e 6365 666f 7274 682e 0d0a 2020 2020  enceforth...    
+0000ae00: 6465 6620 7365 745f 6172 6561 5f73 6361  def set_area_sca
+0000ae10: 6e5f 656e 6162 6c65 2873 656c 662c 2066  n_enable(self, f
+0000ae20: 6c61 673a 2062 6f6f 6c29 3a20 2320 2d3e  lag: bool): # ->
+0000ae30: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0000ae40: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0000ae50: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+0000ae60: 2e69 735f 696e 6761 6173 2829 3a0d 0a20  .is_ingaas():.. 
+0000ae70: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
+0000ae80: 7272 6f72 2822 6172 6561 2073 6361 6e20  rror("area scan 
+0000ae90: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+0000aea0: 206f 6e20 496e 4761 4173 2064 6574 6563   on InGaAs detec
+0000aeb0: 746f 7273 2028 7369 6e67 6c65 206c 696e  tors (single lin
+0000aec0: 6520 6172 7261 7929 2229 0d0a 2020 2020  e array)")..    
+0000aed0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+0000aee0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0000aef0: 6e73 6528 6572 726f 725f 6c76 6c3d 4572  nse(error_lvl=Er
+0000af00: 726f 724c 6576 656c 2e6c 6f77 2c20 6572  rorLevel.low, er
+0000af10: 726f 725f 6d73 673d 2261 7265 6120 7363  ror_msg="area sc
+0000af20: 616e 2069 7320 6e6f 7420 7375 7070 6f72  an is not suppor
+0000af30: 7465 6420 6f6e 2049 6e47 6141 7320 6465  ted on InGaAs de
+0000af40: 7465 6374 6f72 7320 2873 696e 676c 6520  tectors (single 
+0000af50: 6c69 6e65 2061 7272 6179 2922 290d 0a0d  line array)")...
+0000af60: 0a20 2020 2020 2020 2076 616c 7565 203d  .        value =
+0000af70: 2031 2069 6620 666c 6167 2065 6c73 6520   1 if flag else 
+0000af80: 300d 0a20 2020 2020 2020 2073 656c 662e  0..        self.
+0000af90: 7365 7474 696e 6773 2e73 7461 7465 2e61  settings.state.a
+0000afa0: 7265 615f 7363 616e 5f65 6e61 626c 6564  rea_scan_enabled
+0000afb0: 203d 2066 6c61 670d 0a20 2020 2020 2020   = flag..       
+0000afc0: 2072 6574 7572 6e20 7365 6c66 2e5f 7365   return self._se
+0000afd0: 6e64 5f63 6f64 6528 3078 6562 2c20 7661  nd_code(0xeb, va
+0000afe0: 6c75 652c 206c 6162 656c 3d22 5345 545f  lue, label="SET_
+0000aff0: 4152 4541 5f53 4341 4e5f 454e 4142 4c45  AREA_SCAN_ENABLE
+0000b000: 2229 0d0a 0d0a 2020 2020 6465 6620 6765  ")....    def ge
+0000b010: 745f 7365 6e73 6f72 5f6c 696e 655f 6c65  t_sensor_line_le
+0000b020: 6e67 7468 2873 656c 6629 3a20 2320 2d3e  ngth(self): # ->
+0000b030: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0000b040: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0000b050: 7661 6c75 6520 3d20 7365 6c66 2e67 6574  value = self.get
+0000b060: 5f75 7070 6572 5f63 6f64 6528 3078 3033  _upper_code(0x03
+0000b070: 2c20 6c61 6265 6c3d 2247 4554 5f4c 494e  , label="GET_LIN
+0000b080: 455f 4c45 4e47 5448 222c 206c 7362 5f6c  E_LENGTH", lsb_l
+0000b090: 656e 3d32 290d 0a20 2020 2020 2020 2069  en=2)..        i
+0000b0a0: 6620 7661 6c75 6520 213d 2073 656c 662e  f value != self.
+0000b0b0: 7365 7474 696e 6773 2e70 6978 656c 7328  settings.pixels(
+0000b0c0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+0000b0d0: 6c6f 672e 6572 726f 7228 2247 4554 5f4c  log.error("GET_L
+0000b0e0: 494e 455f 4c45 4e47 5448 206f 7063 6f64  INE_LENGTH opcod
+0000b0f0: 6520 7265 7375 6c74 2025 6420 213d 2053  e result %d != S
+0000b100: 7065 6374 726f 6d65 7465 7253 6574 7469  pectrometerSetti
+0000b110: 6e67 732e 7069 7865 6c73 2025 6420 2875  ngs.pixels %d (u
+0000b120: 7369 6e67 206f 7063 6f64 6520 7265 7375  sing opcode resu
+0000b130: 6c74 2922 2c0d 0a20 2020 2020 2020 2020  lt)",..         
+0000b140: 2020 2020 2020 2076 616c 7565 2c20 7365         value, se
+0000b150: 6c66 2e73 6574 7469 6e67 732e 7069 7865  lf.settings.pixe
+0000b160: 6c73 2829 290d 0a20 2020 2020 2020 2072  ls())..        r
+0000b170: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+0000b180: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+0000b190: 7661 6c75 6529 0d0a 0d0a 2020 2020 6465  value)....    de
+0000b1a0: 6620 6765 745f 6d69 6372 6f63 6f6e 7472  f get_microcontr
+0000b1b0: 6f6c 6c65 725f 6669 726d 7761 7265 5f76  oller_firmware_v
+0000b1c0: 6572 7369 6f6e 2873 656c 6629 3a20 2320  ersion(self): # 
+0000b1d0: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+0000b1e0: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+0000b1f0: 2020 7265 7320 3d20 7365 6c66 2e5f 6765    res = self._ge
+0000b200: 745f 636f 6465 2830 7863 302c 206c 6162  t_code(0xc0, lab
+0000b210: 656c 3d22 4745 545f 434f 4445 5f52 4556  el="GET_CODE_REV
+0000b220: 4953 494f 4e22 290d 0a20 2020 2020 2020  ISION")..       
+0000b230: 2072 6573 756c 7420 3d20 7265 732e 6461   result = res.da
+0000b240: 7461 0d0a 2020 2020 2020 2020 7665 7273  ta..        vers
+0000b250: 696f 6e20 3d20 223f 2e3f 2e3f 2e3f 220d  ion = "?.?.?.?".
+0000b260: 0a20 2020 2020 2020 2069 6620 7265 7375  .        if resu
+0000b270: 6c74 2069 7320 6e6f 7420 4e6f 6e65 2061  lt is not None a
+0000b280: 6e64 206c 656e 2872 6573 756c 7429 203e  nd len(result) >
+0000b290: 3d20 343a 0d0a 2020 2020 2020 2020 2020  = 4:..          
+0000b2a0: 2020 7665 7273 696f 6e20 3d20 2225 642e    version = "%d.
+0000b2b0: 2564 2e25 642e 2564 2220 2520 2872 6573  %d.%d.%d" % (res
+0000b2c0: 756c 745b 335d 2c20 7265 7375 6c74 5b32  ult[3], result[2
+0000b2d0: 5d2c 2072 6573 756c 745b 315d 2c20 7265  ], result[1], re
+0000b2e0: 7375 6c74 5b30 5d29 2023 204d 5342 2d4c  sult[0]) # MSB-L
+0000b2f0: 5342 0d0a 2020 2020 2020 2020 7365 6c66  SB..        self
+0000b300: 2e73 6574 7469 6e67 732e 6d69 6372 6f63  .settings.microc
+0000b310: 6f6e 7472 6f6c 6c65 725f 6669 726d 7761  ontroller_firmwa
+0000b320: 7265 5f76 6572 7369 6f6e 203d 2076 6572  re_version = ver
+0000b330: 7369 6f6e 0d0a 2020 2020 2020 2020 7265  sion..        re
+0000b340: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+0000b350: 7252 6573 706f 6e73 6528 6461 7461 3d76  rResponse(data=v
+0000b360: 6572 7369 6f6e 290d 0a0d 0a20 2020 2064  ersion)....    d
+0000b370: 6566 2067 6574 5f66 7067 615f 6669 726d  ef get_fpga_firm
+0000b380: 7761 7265 5f76 6572 7369 6f6e 2873 656c  ware_version(sel
+0000b390: 6629 3a20 2320 2d3e 2053 7065 6374 726f  f): # -> Spectro
+0000b3a0: 6d65 7465 7252 6573 706f 6e73 6520 0d0a  meterResponse ..
+0000b3b0: 2020 2020 2020 2020 7320 3d20 2222 0d0a          s = ""..
+0000b3c0: 2020 2020 2020 2020 7265 7320 3d20 7365          res = se
+0000b3d0: 6c66 2e5f 6765 745f 636f 6465 2830 7862  lf._get_code(0xb
+0000b3e0: 342c 206c 6162 656c 3d22 4745 545f 4650  4, label="GET_FP
+0000b3f0: 4741 5f52 4556 2229 0d0a 2020 2020 2020  GA_REV")..      
+0000b400: 2020 7265 7375 6c74 203d 2072 6573 2e64    result = res.d
+0000b410: 6174 610d 0a20 2020 2020 2020 2069 6620  ata..        if 
+0000b420: 7265 7375 6c74 2069 7320 6e6f 7420 4e6f  result is not No
+0000b430: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+0000b440: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0000b450: 6c65 6e28 7265 7375 6c74 2929 3a0d 0a20  len(result)):.. 
+0000b460: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000b470: 203d 2072 6573 756c 745b 695d 0d0a 2020   = result[i]..  
+0000b480: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000b490: 2030 7832 3020 3c3d 2063 203c 2030 7837   0x20 <= c < 0x7
+0000b4a0: 663a 2023 2076 6973 6962 6c65 2041 5343  f: # visible ASC
+0000b4b0: 4949 0d0a 2020 2020 2020 2020 2020 2020  II..            
+0000b4c0: 2020 2020 2020 2020 7320 2b3d 2063 6872          s += chr
+0000b4d0: 2863 290d 0a20 2020 2020 2020 2073 656c  (c)..        sel
+0000b4e0: 662e 7365 7474 696e 6773 2e66 7067 615f  f.settings.fpga_
+0000b4f0: 6669 726d 7761 7265 5f76 6572 7369 6f6e  firmware_version
+0000b500: 203d 2073 0d0a 2020 2020 2020 2020 7265   = s..        re
+0000b510: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+0000b520: 7252 6573 706f 6e73 6528 6461 7461 3d73  rResponse(data=s
+0000b530: 290d 0a0d 0a20 2020 2064 6566 2067 6574  )....    def get
+0000b540: 5f6c 696e 6528 7365 6c66 2c20 7472 6967  _line(self, trig
+0000b550: 6765 723a 2062 6f6f 6c20 3d20 5472 7565  ger: bool = True
+0000b560: 293a 2023 202d 3e20 5370 6563 7472 6f6d  ): # -> Spectrom
+0000b570: 6574 6572 5265 7370 6f6e 7365 200d 0a20  eterResponse .. 
+0000b580: 2020 2020 2020 2022 2222 0d0a 2020 2020         """..    
+0000b590: 2020 2020 5365 6e64 2022 6163 7175 6972      Send "acquir
+0000b5a0: 6522 2c20 7468 656e 2069 6d6d 6564 6961  e", then immedia
+0000b5b0: 7465 6c79 2072 6561 6420 7468 6520 6275  tely read the bu
+0000b5c0: 6c6b 2065 6e64 706f 696e 7428 7329 2e0d  lk endpoint(s)..
+0000b5d0: 0a20 2020 2020 2020 2050 726f 6261 626c  .        Probabl
+0000b5e0: 7920 7468 6520 6d6f 7374 2069 6d70 6f72  y the most impor
+0000b5f0: 7461 6e74 206d 6574 686f 6420 696e 2074  tant method in t
+0000b600: 6869 7320 636c 6173 732c 206d 6f72 6520  his class, more 
+0000b610: 636f 6d6d 6f6e 6c79 2063 616c 6c65 640d  commonly called.
+0000b620: 0a20 2020 2020 2020 2022 6765 7453 7065  .        "getSpe
+0000b630: 6374 7275 6d22 2069 6e20 6d6f 7374 2064  ctrum" in most d
+0000b640: 7269 7665 7273 2e0d 0a20 2020 2020 2020  rivers...       
+0000b650: 2040 7061 7261 6d20 7472 6967 6765 7220   @param trigger 
+0000b660: 2849 6e70 7574 2920 7365 6e64 2061 6e20  (Input) send an 
+0000b670: 696e 6974 6961 6c20 4143 5155 4952 450d  initial ACQUIRE.
+0000b680: 0a20 2020 2020 2020 2040 7265 7475 726e  .        @return
+0000b690: 7320 7475 706c 6520 6f66 2028 7370 6563  s tuple of (spec
+0000b6a0: 7472 756d 5b5d 2c20 6172 6561 5f73 6361  trum[], area_sca
+0000b6b0: 6e5f 726f 775f 636f 756e 7429 2066 6f72  n_row_count) for
+0000b6c0: 2073 7563 6365 7373 0d0a 2020 2020 2020   success..      
+0000b6d0: 2020 4072 6574 7572 6e73 204e 6f6e 6520    @returns None 
+0000b6e0: 7768 656e 2069 7420 7469 6d65 732d 6f75  when it times-ou
+0000b6f0: 7420 7768 696c 6520 7761 6974 696e 6720  t while waiting 
+0000b700: 666f 7220 616e 2065 7874 6572 6e61 6c20  for an external 
+0000b710: 7472 6967 6765 720d 0a20 2020 2020 2020  trigger..       
+0000b720: 2020 2020 2020 2020 2020 2869 6e74 6572            (inter
+0000b730: 7072 6574 2061 732c 2022 6469 646e 2774  pret as, "didn't
+0000b740: 2066 696e 6420 616e 7920 6669 7368 2074   find any fish t
+0000b750: 6869 7320 7469 6d65 2c20 7472 7920 6167  his time, try ag
+0000b760: 6169 6e20 696e 2061 2062 6974 2229 0d0a  ain in a bit")..
+0000b770: 2020 2020 2020 2020 4072 6574 7572 6e73          @returns
+0000b780: 2046 616c 7365 2028 626f 6f6c 2920 7768   False (bool) wh
+0000b790: 656e 2069 7420 7469 6d65 732d 6f75 7420  en it times-out 
+0000b7a0: 6f72 2065 6e63 6f75 6e74 6572 7320 616e  or encounters an
+0000b7b0: 2065 7863 6570 7469 6f6e 0d0a 2020 2020   exception..    
+0000b7c0: 2020 2020 2020 2020 2020 2020 2077 6865               whe
+0000b7d0: 6e20 4e4f 5420 696e 2065 7874 6572 6e61  n NOT in externa
+0000b7e0: 6c2d 7472 6967 6765 7265 6420 6d6f 6465  l-triggered mode
+0000b7f0: 0d0a 2020 2020 2020 2020 4074 6872 6f77  ..        @throw
+0000b800: 7320 6578 6365 7074 696f 6e20 6f6e 2074  s exception on t
+0000b810: 696d 656f 7574 2028 756e 6c65 7373 2065  imeout (unless e
+0000b820: 7874 6572 6e61 6c20 7472 6967 6765 7269  xternal triggeri
+0000b830: 6e67 2065 6e61 626c 6564 290d 0a20 2020  ng enabled)..   
+0000b840: 2020 2020 2022 2222 0d0a 0d0a 2020 2020       """....    
+0000b850: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+0000b860: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b870: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b880: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b890: 2323 2323 2323 2323 2323 2323 0d0a 2020  ############..  
+0000b8a0: 2020 2020 2020 2320 7365 6e64 2074 6865        # send the
+0000b8b0: 2041 4351 5549 5245 0d0a 2020 2020 2020   ACQUIRE..      
+0000b8c0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0000b8d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b8e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b8f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b900: 2323 2323 2323 2323 2323 0d0a 2020 2020  ##########..    
+0000b910: 2020 2020 7265 7370 6f6e 7365 203d 2053      response = S
+0000b920: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0000b930: 6e73 6528 290d 0a0d 0a20 2020 2020 2020  nse()....       
+0000b940: 2023 206d 6169 6e20 7573 652d 6361 7365   # main use-case
+0000b950: 2066 6f72 204e 4f54 2073 656e 6469 6e67   for NOT sending
+0000b960: 2061 2074 7269 6767 6572 2077 6f75 6c64   a trigger would
+0000b970: 2062 6520 7768 656e 2072 6561 6469 6e67   be when reading
+0000b980: 0d0a 2020 2020 2020 2020 2320 7375 6273  ..        # subs
+0000b990: 6571 7565 6e74 206c 696e 6573 206f 6620  equent lines of 
+0000b9a0: 6461 7461 2066 726f 6d20 6172 6561 2073  data from area s
+0000b9b0: 6361 6e20 2266 6173 7422 206d 6f64 650d  can "fast" mode.
+0000b9c0: 0a0d 0a20 2020 2020 2020 2061 6371 7569  ...        acqui
+0000b9d0: 7369 7469 6f6e 5f74 696d 6573 7461 6d70  sition_timestamp
+0000b9e0: 203d 2064 6174 6574 696d 652e 6461 7465   = datetime.date
+0000b9f0: 7469 6d65 2e6e 6f77 2829 0d0a 2020 2020  time.now()..    
+0000ba00: 2020 2020 6966 2074 7269 6767 6572 2061      if trigger a
+0000ba10: 6e64 2073 656c 662e 7365 7474 696e 6773  nd self.settings
+0000ba20: 2e73 7461 7465 2e74 7269 6767 6572 5f73  .state.trigger_s
+0000ba30: 6f75 7263 6520 3d3d 2053 7065 6374 726f  ource == Spectro
+0000ba40: 6d65 7465 7253 7461 7465 2e54 5249 4747  meterState.TRIGG
+0000ba50: 4552 5f53 4f55 5243 455f 494e 5445 524e  ER_SOURCE_INTERN
+0000ba60: 414c 3a0d 0a20 2020 2020 2020 2020 2020  AL:..           
+0000ba70: 2023 204f 6e6c 7920 7365 6e64 2041 4351   # Only send ACQ
+0000ba80: 5549 5245 2028 696e 7465 726e 616c 2053  UIRE (internal S
+0000ba90: 5720 7472 6967 6765 7229 2069 6620 6578  W trigger) if ex
+0000baa0: 7465 726e 616c 2048 5720 7472 6967 6765  ternal HW trigge
+0000bab0: 7220 6973 2064 6973 6162 6c65 6420 2864  r is disabled (d
+0000bac0: 6566 6175 6c74 290d 0a20 2020 2020 2020  efault)..       
+0000bad0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
+0000bae0: 6765 745f 6c69 6e65 3a20 7265 7175 6573  get_line: reques
+0000baf0: 7469 6e67 2073 7065 6374 7275 6d22 290d  ting spectrum").
+0000bb00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000bb10: 662e 5f73 656e 645f 636f 6465 2830 7861  f._send_code(0xa
+0000bb20: 642c 206c 6162 656c 3d22 4143 5155 4952  d, label="ACQUIR
+0000bb30: 455f 5350 4543 5452 554d 2229 0d0a 0d0a  E_SPECTRUM")....
+0000bb40: 2020 2020 2020 2020 2323 2323 2323 2323          ########
+0000bb50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bb60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bb70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bb80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bb90: 0d0a 2020 2020 2020 2020 2320 7072 6570  ..        # prep
+0000bba0: 6172 6520 746f 2072 6561 6420 7370 6563  are to read spec
+0000bbb0: 7472 756d 0d0a 2020 2020 2020 2020 2323  trum..        ##
+0000bbc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bbd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bbe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bbf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bc00: 2323 2323 2323 0d0a 0d0a 2020 2020 2020  ######....      
+0000bc10: 2020 7069 7865 6c73 203d 2073 656c 662e    pixels = self.
+0000bc20: 7365 7474 696e 6773 2e70 6978 656c 7328  settings.pixels(
+0000bc30: 290d 0a0d 0a20 2020 2020 2020 2023 2077  )....        # w
+0000bc40: 6865 6e20 6368 616e 6769 6e67 2064 6574  hen changing det
+0000bc50: 6563 746f 7220 524f 492c 2065 7861 6374  ector ROI, exact
+0000bc60: 6c79 204f 4e45 2052 4541 4420 7368 6f75  ly ONE READ shou
+0000bc70: 6c64 2062 6520 6174 2074 6865 2070 7265  ld be at the pre
+0000bc80: 7669 6f75 7320 6c65 6e67 7468 0d0a 2020  vious length..  
+0000bc90: 2020 2020 2020 2320 6966 2073 656c 662e        # if self.
+0000bca0: 7072 6576 5f70 6978 656c 7320 6973 206e  prev_pixels is n
+0000bcb0: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
+0000bcc0: 2020 2320 2020 2020 6c6f 672e 6465 6275    #     log.debu
+0000bcd0: 6728 6622 6765 745f 6c69 6e65 3a20 7573  g(f"get_line: us
+0000bce0: 696e 6720 6f6e 652d 7469 6d65 2070 7265  ing one-time pre
+0000bcf0: 765f 7069 7865 6c73 2076 616c 7565 206f  v_pixels value o
+0000bd00: 6620 7b73 656c 662e 7072 6576 5f70 6978  f {self.prev_pix
+0000bd10: 656c 737d 2072 6174 6865 7220 7468 616e  els} rather than
+0000bd20: 207b 7069 7865 6c73 7d22 290d 0a20 2020   {pixels}")..   
+0000bd30: 2020 2020 2023 2020 2020 2070 6978 656c       #     pixel
+0000bd40: 7320 3d20 7365 6c66 2e70 7265 765f 7069  s = self.prev_pi
+0000bd50: 7865 6c73 0d0a 2020 2020 2020 2020 2320  xels..        # 
+0000bd60: 2020 2020 7365 6c66 2e70 7265 765f 7069      self.prev_pi
+0000bd70: 7865 6c73 203d 204e 6f6e 650d 0a0d 0a20  xels = None.... 
+0000bd80: 2020 2020 2020 2023 2061 6c6c 206d 6f64         # all mod
+0000bd90: 656c 7320 7265 7475 726e 2073 7065 6374  els return spect
+0000bda0: 7261 2061 7320 5b75 696e 7431 365d 0d0a  ra as [uint16]..
+0000bdb0: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
+0000bdc0: 7320 3d20 5b30 7838 325d 0d0a 2020 2020  s = [0x82]..    
+0000bdd0: 2020 2020 626c 6f63 6b5f 6c65 6e5f 6279      block_len_by
+0000bde0: 7465 7320 3d20 7069 7865 6c73 202a 2032  tes = pixels * 2
+0000bdf0: 0d0a 2020 2020 2020 2020 6966 2070 6978  ..        if pix
+0000be00: 656c 7320 3d3d 2032 3034 3820 616e 6420  els == 2048 and 
+0000be10: 6e6f 7420 7365 6c66 2e73 6574 7469 6e67  not self.setting
+0000be20: 732e 6973 5f61 726d 2829 3a0d 0a20 2020  s.is_arm():..   
+0000be30: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
+0000be40: 7473 203d 205b 3078 3832 2c20 3078 3836  ts = [0x82, 0x86
+0000be50: 5d0d 0a20 2020 2020 2020 2020 2020 2062  ]..            b
+0000be60: 6c6f 636b 5f6c 656e 5f62 7974 6573 203d  lock_len_bytes =
+0000be70: 2032 3034 3820 2320 3130 3234 2070 6978   2048 # 1024 pix
+0000be80: 656c 7320 6170 6965 6365 2066 726f 6d20  els apiece from 
+0000be90: 7477 6f20 656e 6470 6f69 6e74 730d 0a0d  two endpoints...
+0000bea0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000beb0: 2e73 6574 7469 6e67 732e 6973 5f6d 6963  .settings.is_mic
+0000bec0: 726f 2829 3a0d 0a20 2020 2020 2020 2020  ro():..         
+0000bed0: 2020 2023 2077 6520 6861 7665 206e 6f20     # we have no 
+0000bee0: 6964 6561 2069 6620 5365 7269 6573 2d58  idea if Series-X
+0000bef0: 5320 6861 7320 746f 2022 7761 6b65 2075  S has to "wake u
+0000bf00: 7022 2074 6865 2073 656e 736f 722c 2073  p" the sensor, s
+0000bf10: 6f20 7761 6974 0d0a 2020 2020 2020 2020  o wait..        
+0000bf20: 2020 2020 2320 6c6f 6e67 2065 6e6f 7567      # long enoug
+0000bf30: 6820 666f 7220 3620 7468 726f 7761 7761  h for 6 throwawa
+0000bf40: 7920 6672 616d 6573 2069 6620 6e65 6564  y frames if need
+0000bf50: 2062 650d 0a20 2020 2020 2020 2020 2020   be..           
+0000bf60: 2074 696d 656f 7574 5f6d 7320 3d20 7365   timeout_ms = se
+0000bf70: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
+0000bf80: 652e 696e 7465 6772 6174 696f 6e5f 7469  e.integration_ti
+0000bf90: 6d65 5f6d 7320 2a20 3820 2b20 3530 3020  me_ms * 8 + 500 
+0000bfa0: 2a20 7365 6c66 2e73 6574 7469 6e67 732e  * self.settings.
+0000bfb0: 6e75 6d5f 636f 6e6e 6563 7465 645f 6465  num_connected_de
+0000bfc0: 7669 6365 730d 0a20 2020 2020 2020 2065  vices..        e
+0000bfd0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+0000bfe0: 2020 7469 6d65 6f75 745f 6d73 203d 2073    timeout_ms = s
+0000bff0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+0000c000: 7465 2e69 6e74 6567 7261 7469 6f6e 5f74  te.integration_t
+0000c010: 696d 655f 6d73 202a 2032 202b 2031 3030  ime_ms * 2 + 100
+0000c020: 3020 2a20 7365 6c66 2e73 6574 7469 6e67  0 * self.setting
+0000c030: 732e 6e75 6d5f 636f 6e6e 6563 7465 645f  s.num_connected_
+0000c040: 6465 7669 6365 730d 0a0d 0a20 2020 2020  devices....     
+0000c050: 2020 2023 2064 7565 2074 6f20 6164 6469     # due to addi
+0000c060: 7469 6f6e 616c 2066 6972 6d77 6172 6520  tional firmware 
+0000c070: 7072 6f63 6573 7369 6e67 2074 696d 6520  processing time 
+0000c080: 666f 7220 6172 6561 2073 6361 6e3f 0d0a  for area scan?..
+0000c090: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000c0a0: 7365 7474 696e 6773 2e73 7461 7465 2e61  settings.state.a
+0000c0b0: 7265 615f 7363 616e 5f65 6e61 626c 6564  rea_scan_enabled
+0000c0c0: 3a0d 0a20 2020 2020 2020 2020 2020 2069  :..            i
+0000c0d0: 6620 7472 6967 6765 723a 0d0a 2020 2020  f trigger:..    
+0000c0e0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+0000c0f0: 6f75 745f 6d73 202b 3d20 3235 300d 0a20  out_ms += 250.. 
+0000c100: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000c110: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000c120: 2020 2320 6b6c 7564 6765 3a20 6a75 7374    # kludge: just
+0000c130: 2075 7365 2074 7269 706c 6520 7468 6520   use triple the 
+0000c140: 696e 7472 612d 6c69 6e65 2064 656c 6179  intra-line delay
+0000c150: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000c160: 2020 7469 6d65 6f75 745f 6d73 203d 2073    timeout_ms = s
+0000c170: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
+0000c180: 726f 6d2e 6465 7465 6374 6f72 5f6f 6666  rom.detector_off
+0000c190: 7365 7420 2a20 330d 0a0d 0a20 2020 2020  set * 3....     
+0000c1a0: 2020 2073 656c 662e 5f77 6169 745f 666f     self._wait_fo
+0000c1b0: 725f 7573 625f 6176 6169 6c61 626c 6528  r_usb_available(
+0000c1c0: 290d 0a0d 0a20 2020 2020 2020 2023 2323  )....        ###
+0000c1d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c1e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c1f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c210: 2323 2323 230d 0a20 2020 2020 2020 2023  #####..        #
+0000c220: 2072 6561 6420 7468 6520 6461 7461 2066   read the data f
+0000c230: 726f 6d20 6275 6c6b 2065 6e64 706f 696e  rom bulk endpoin
+0000c240: 7428 7329 0d0a 2020 2020 2020 2020 2323  t(s)..        ##
+0000c250: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c260: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c270: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c280: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000c290: 2323 2323 2323 0d0a 0d0a 2020 2020 2020  ######....      
+0000c2a0: 2020 7370 6563 7472 756d 203d 205b 5d0d    spectrum = [].
+0000c2b0: 0a20 2020 2020 2020 2066 6f72 2065 6e64  .        for end
+0000c2c0: 706f 696e 7420 696e 2065 6e64 706f 696e  point in endpoin
+0000c2d0: 7473 3a0d 0a20 2020 2020 2020 2020 2020  ts:..           
+0000c2e0: 2064 6174 6120 3d20 4e6f 6e65 0d0a 2020   data = None..  
+0000c2f0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+0000c300: 6461 7461 2069 7320 4e6f 6e65 3a0d 0a20  data is None:.. 
+0000c310: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000c320: 7279 3a0d 0a20 2020 2020 2020 2020 2020  ry:..           
+0000c330: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
+0000c340: 7567 2822 7761 6974 696e 6720 666f 7220  ug("waiting for 
+0000c350: 2564 2062 7974 6573 2028 7469 6d65 6f75  %d bytes (timeou
+0000c360: 7420 2564 6d73 2922 2c20 626c 6f63 6b5f  t %dms)", block_
+0000c370: 6c65 6e5f 6279 7465 732c 2074 696d 656f  len_bytes, timeo
+0000c380: 7574 5f6d 7329 0d0a 2020 2020 2020 2020  ut_ms)..        
+0000c390: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000c3a0: 203d 2073 656c 662e 6465 7669 6365 5f74   = self.device_t
+0000c3b0: 7970 652e 7265 6164 2873 656c 662e 6465  ype.read(self.de
+0000c3c0: 7669 6365 2c20 656e 6470 6f69 6e74 2c20  vice, endpoint, 
+0000c3d0: 626c 6f63 6b5f 6c65 6e5f 6279 7465 732c  block_len_bytes,
+0000c3e0: 2074 696d 656f 7574 3d74 696d 656f 7574   timeout=timeout
+0000c3f0: 5f6d 7329 0d0a 2020 2020 2020 2020 2020  _ms)..          
+0000c400: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+0000c410: 6275 6728 2272 6561 6420 2564 2062 7974  bug("read %d byt
+0000c420: 6573 222c 206c 656e 2864 6174 6129 290d  es", len(data)).
+0000c430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c440: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000c450: 6e20 6173 2065 7863 3a0d 0a20 2020 2020  n as exc:..     
+0000c460: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c470: 6620 7365 6c66 2e64 6576 6963 655f 7479  f self.device_ty
+0000c480: 7065 2069 7320 4e6f 6e65 3a0d 0a20 2020  pe is None:..   
+0000c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4a0: 2020 2020 206c 6f67 2e65 7272 6f72 2866       log.error(f
+0000c4b0: 224e 6f20 6465 7669 6365 5f74 7970 6522  "No device_type"
+0000c4c0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000c4d0: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+0000c4e0: 6e73 652e 6572 726f 725f 6d73 6720 3d20  nse.error_msg = 
+0000c4f0: 6622 456e 636f 756e 7465 7265 6420 6572  f"Encountered er
+0000c500: 726f 7220 6f6e 2072 6561 6422 0d0a 2020  ror on read"..  
+0000c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c520: 2020 2020 2020 7265 7370 6f6e 7365 2e65        response.e
+0000c530: 7272 6f72 5f6c 766c 203d 2045 7272 6f72  rror_lvl = Error
+0000c540: 4c65 7665 6c2e 6869 6768 0d0a 2020 2020  Level.high..    
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c560: 2020 2020 7265 7370 6f6e 7365 2e70 6f69      response.poi
+0000c570: 736f 6e5f 7069 6c6c 203d 2054 7275 6520  son_pill = True 
+0000c580: 2320 756e 7265 636f 7665 7261 626c 650d  # unrecoverable.
+0000c590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c5a0: 2020 2020 2065 6c69 6620 7365 6c66 2e73       elif self.s
+0000c5b0: 6574 7469 6e67 732e 7374 6174 652e 7472  ettings.state.tr
+0000c5c0: 6967 6765 725f 736f 7572 6365 203d 3d20  igger_source == 
+0000c5d0: 5370 6563 7472 6f6d 6574 6572 5374 6174  SpectrometerStat
+0000c5e0: 652e 5452 4947 4745 525f 534f 5552 4345  e.TRIGGER_SOURCE
+0000c5f0: 5f45 5854 4552 4e41 4c3a 0d0a 2020 2020  _EXTERNAL:..    
+0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c610: 2020 2020 2320 7765 2064 6f6e 2774 206b      # we don't k
+0000c620: 6e6f 7720 686f 7720 6c6f 6e67 2077 6527  now how long we'
+0000c630: 6c6c 2068 6176 6520 746f 2077 6169 7420  ll have to wait 
+0000c640: 666f 7220 7468 6520 7472 6967 6765 722c  for the trigger,
+0000c650: 2073 6f0d 0a20 2020 2020 2020 2020 2020   so..           
+0000c660: 2020 2020 2020 2020 2020 2020 2023 206a               # j
+0000c670: 7573 7420 6c6f 6f70 2061 6e64 2068 6f70  ust loop and hop
+0000c680: 650d 0a20 2020 2020 2020 2020 2020 2020  e..             
+0000c690: 2020 2020 2020 2020 2020 2023 206c 6f67             # log
+0000c6a0: 2e64 6562 7567 2822 7374 696c 6c20 7761  .debug("still wa
+0000c6b0: 6974 696e 6720 666f 7220 6578 7465 726e  iting for extern
+0000c6c0: 616c 2074 7269 6767 6572 2229 0d0a 2020  al trigger")..  
+0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6e0: 2020 2020 2020 7061 7373 0d0a 2020 2020        pass..    
+0000c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c700: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+0000c710: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000c720: 6f67 2e65 7272 6f72 2866 2245 6e63 6f75  og.error(f"Encou
+0000c730: 6e74 6572 6564 2065 7272 6f72 206f 6e20  ntered error on 
+0000c740: 7265 6164 206f 6620 7b65 7863 7d22 290d  read of {exc}").
+0000c750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c760: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+0000c770: 652e 6572 726f 725f 6d73 6720 3d20 6622  e.error_msg = f"
+0000c780: 456e 636f 756e 7465 7265 6420 6572 726f  Encountered erro
+0000c790: 7220 6f6e 2072 6561 6422 0d0a 2020 2020  r on read"..    
+0000c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7b0: 2020 2020 7265 7370 6f6e 7365 2e65 7272      response.err
+0000c7c0: 6f72 5f6c 766c 203d 2045 7272 6f72 4c65  or_lvl = ErrorLe
+0000c7d0: 7665 6c2e 6869 6768 0d0a 2020 2020 2020  vel.high..      
+0000c7e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000c7f0: 7475 726e 2072 6573 706f 6e73 650d 0a0d  turn response...
+0000c800: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000c810: 6869 7320 6973 2061 2063 6f6e 766f 6c75  his is a convolu
+0000c820: 7465 6420 7761 7920 746f 2069 7465 7261  ted way to itera
+0000c830: 7465 2061 6372 6f73 7320 7468 6520 7265  te across the re
+0000c840: 6365 6976 6564 2062 7974 6573 2069 6e20  ceived bytes in 
+0000c850: 2764 6174 6127 2061 730d 0a20 2020 2020  'data' as..     
+0000c860: 2020 2020 2020 2023 2074 776f 2069 6e74         # two int
+0000c870: 6572 6c65 6176 6564 2061 7272 6179 732c  erleaved arrays,
+0000c880: 2062 6f74 6820 6f6e 6c79 2070 726f 6365   both only proce
+0000c890: 7373 696e 6720 616c 7465 726e 6174 696e  ssing alternatin
+0000c8a0: 6720 6279 7465 732c 2062 7574 206f 6e65  g bytes, but one
+0000c8b0: 2028 6929 0d0a 2020 2020 2020 2020 2020   (i)..          
+0000c8c0: 2020 2320 7374 6172 7469 6e67 2061 7420    # starting at 
+0000c8d0: 7a65 726f 2028 6576 656e 2062 7974 6573  zero (even bytes
+0000c8e0: 2920 616e 6420 7468 6520 6f74 6865 7220  ) and the other 
+0000c8f0: 286a 2920 7374 6172 7469 6e67 2061 7420  (j) starting at 
+0000c900: 3120 286f 6464 2062 7974 6573 292e 0d0a  1 (odd bytes)...
+0000c910: 2020 2020 2020 2020 2020 2020 7375 6273              subs
+0000c920: 7065 6374 7275 6d20 3d20 5b69 6e74 2869  pectrum = [int(i
+0000c930: 207c 2028 6a20 3c3c 2038 2929 2066 6f72   | (j << 8)) for
+0000c940: 2069 2c20 6a20 696e 207a 6970 2864 6174   i, j in zip(dat
+0000c950: 615b 3a3a 325d 2c20 6461 7461 5b31 3a3a  a[::2], data[1::
+0000c960: 325d 295d 2023 204c 5342 2d4d 5342 0d0a  2])] # LSB-MSB..
+0000c970: 0d0a 2020 2020 2020 2020 2020 2020 7370  ..            sp
+0000c980: 6563 7472 756d 2e65 7874 656e 6428 7375  ectrum.extend(su
+0000c990: 6273 7065 6374 7275 6d29 0d0a 0d0a 2020  bspectrum)....  
+0000c9a0: 2020 2020 2020 2020 2020 2320 656d 7069            # empi
+0000c9b0: 7269 6361 6c6c 7920 6465 7465 726d 696e  rically determin
+0000c9c0: 6564 206e 6565 6420 666f 7220 356d 7320  ed need for 5ms 
+0000c9d0: 6465 6c61 7920 7768 656e 2073 7769 7463  delay when switc
+0000c9e0: 6869 6e67 2065 6e64 706f 696e 7473 0d0a  hing endpoints..
+0000c9f0: 2020 2020 2020 2020 2020 2020 2320 6f6e              # on
+0000ca00: 2032 3034 3870 7820 6465 7465 6374 6f72   2048px detector
+0000ca10: 7320 6475 7269 6e67 2061 7265 6120 7363  s during area sc
+0000ca20: 616e 0d0a 2020 2020 2020 2020 2020 2020  an..            
+0000ca30: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+0000ca40: 2e73 7461 7465 2e61 7265 615f 7363 616e  .state.area_scan
+0000ca50: 5f65 6e61 626c 6564 2061 6e64 2070 6978  _enabled and pix
+0000ca60: 656c 7320 3d3d 2032 3034 383a 2023 2061  els == 2048: # a
+0000ca70: 6e64 2065 6e64 706f 696e 7420 3d3d 2030  nd endpoint == 0
+0000ca80: 7838 323a 0d0a 2020 2020 2020 2020 2020  x82:..          
+0000ca90: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+0000caa0: 2273 6c65 6570 696e 6720 356d 7320 6265  "sleeping 5ms be
+0000cab0: 7477 6565 6e20 656e 6470 6f69 6e74 7322  tween endpoints"
+0000cac0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000cad0: 2020 2073 6c65 6570 2830 2e30 3035 290d     sleep(0.005).
+0000cae0: 0a0d 0a20 2020 2020 2020 2023 2323 2323  ...        #####
 0000caf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000cb00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cb10: 2323 2323 2323 0a20 2020 2020 2020 2023  ######.        #
-0000cb20: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
-0000cb30: 2020 2020 2020 2020 2020 2020 2070 6f73               pos
-0000cb40: 742d 7072 6f63 6573 7320 7468 6520 7370  t-process the sp
-0000cb50: 6563 7472 756d 0a20 2020 2020 2020 2023  ectrum.        #
-0000cb60: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+0000cb10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000cb20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000cb30: 2323 230d 0a20 2020 2020 2020 2023 2065  ###..        # e
+0000cb40: 7272 6f72 2d63 6865 636b 2074 6865 2072  rror-check the r
+0000cb50: 6563 6569 7665 6420 7370 6563 7472 756d  eceived spectrum
+0000cb60: 0d0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
 0000cb70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000cb80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000cb90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000cba0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cbb0: 230a 0a20 2020 2020 2020 2023 2323 2323  #..        #####
-0000cbc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cbd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cbe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cbf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cc00: 2323 230a 2020 2020 2020 2020 2320 4170  ###.        # Ap
-0000cc10: 706c 7920 496e 4761 4173 2065 7665 6e2f  ply InGaAs even/
-0000cc20: 6f64 6420 6761 696e 2f6f 6666 7365 7420  odd gain/offset 
-0000cc30: 696e 2073 6f66 7477 6172 650a 2020 2020  in software.    
-0000cc40: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-0000cc50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cc60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cc70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cc80: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
-0000cc90: 2020 2020 2020 2320 2862 6566 6f72 6520        # (before 
-0000cca0: 782d 6178 6973 2069 6e76 6572 7369 6f6e  x-axis inversion
-0000ccb0: 2062 6563 6175 7365 2074 6869 7320 6973   because this is
-0000ccc0: 2077 6865 7265 2046 5047 4120 7769 6c6c   where FPGA will
-0000ccd0: 2064 6f20 6974 290a 0a20 2020 2020 2020   do it)..       
-0000cce0: 2023 2074 6869 7320 7368 6f75 6c64 2062   # this should b
-0000ccf0: 6520 646f 6e65 2069 6e20 7468 6520 4650  e done in the FP
-0000cd00: 4741 2c20 6275 7420 6f6c 6465 7220 4657  GA, but older FW
-0000cd10: 2064 6964 6e27 7420 6861 7665 2074 6861   didn't have tha
-0000cd20: 740a 2020 2020 2020 2020 2320 696d 706c  t.        # impl
-0000cd30: 656d 656e 7465 642c 2073 6f20 6669 7820  emented, so fix 
-0000cd40: 696e 2053 5720 756e 6c65 7373 2045 4550  in SW unless EEP
-0000cd50: 524f 4d20 696e 6469 6361 7465 7320 2261  ROM indicates "a
-0000cd60: 6c72 6561 6479 2068 616e 646c 6564 220a  lready handled".
-0000cd70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000cd80: 7365 7474 696e 6773 2e69 735f 696e 6761  settings.is_inga
-0000cd90: 6173 2829 2061 6e64 206e 6f74 2073 656c  as() and not sel
-0000cda0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-0000cdb0: 6d2e 6861 7264 7761 7265 5f65 7665 6e5f  m.hardware_even_
-0000cdc0: 6f64 643a 0a20 2020 2020 2020 2020 2020  odd:.           
-0000cdd0: 2073 656c 662e 5f63 6f72 7265 6374 5f69   self._correct_i
-0000cde0: 6e67 6161 735f 6761 696e 5f61 6e64 5f6f  ngaas_gain_and_o
-0000cdf0: 6666 7365 7428 7370 6563 7472 756d 290a  ffset(spectrum).
-0000ce00: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
-0000ce10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ce20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ce30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ce40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ce50: 230a 2020 2020 2020 2020 2320 4172 6561  #.        # Area
-0000ce60: 2053 6361 6e20 2872 6172 6529 0a20 2020   Scan (rare).   
-0000ce70: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
-0000ce80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ce90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000cea0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ceb0: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
-0000cec0: 2020 2020 2020 2023 2028 6265 666f 7265         # (before
-0000ced0: 2078 2d61 7869 7320 696e 7665 7273 696f   x-axis inversio
-0000cee0: 6e20 6265 6361 7573 6520 6c69 6e65 2069  n because line i
-0000cef0: 6e64 6578 2061 7420 4650 4741 2070 6978  ndex at FPGA pix
-0000cf00: 656c 2030 290a 0a20 2020 2020 2020 2023  el 0)..        #
-0000cf10: 2049 6620 7765 2772 6520 696e 2061 7265   If we're in are
-0000cf20: 6120 7363 616e 206d 6f64 652c 2075 7365  a scan mode, use
-0000cf30: 2066 6972 7374 2070 6978 656c 2061 7320   first pixel as 
-0000cf40: 726f 7720 696e 6465 7820 286c 6561 7665  row index (leave
-0000cf50: 2070 6978 656c 200a 2020 2020 2020 2020   pixel .        
-0000cf60: 2320 696e 2073 7065 6374 7275 6d29 2e20  # in spectrum). 
-0000cf70: 2044 6f20 7468 6973 2062 6566 6f72 6520   Do this before 
-0000cf80: 616e 7920 686f 7269 7a6f 6e74 616c 2061  any horizontal a
-0000cf90: 7665 7261 6769 6e67 2077 6869 6368 206d  veraging which m
-0000cfa0: 6967 6874 200a 2020 2020 2020 2020 2320  ight .        # 
-0000cfb0: 636f 7272 7570 7420 6669 7273 7420 7069  corrupt first pi
-0000cfc0: 7865 6c29 2e20 204e 6f74 6520 7468 6174  xel).  Note that
-0000cfd0: 2049 6e47 6141 7320 646f 6e27 7420 7375   InGaAs don't su
-0000cfe0: 7070 6f72 7420 4465 7465 6374 6f72 5265  pport DetectorRe
-0000cff0: 6769 6f6e 732e 0a20 2020 2020 2020 2061  gions..        a
-0000d000: 7265 615f 7363 616e 5f72 6f77 5f63 6f75  rea_scan_row_cou
-0000d010: 6e74 203d 202d 310a 2020 2020 2020 2020  nt = -1.        
-0000d020: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
-0000d030: 2e73 7461 7465 2e61 7265 615f 7363 616e  .state.area_scan
-0000d040: 5f65 6e61 626c 6564 3a0a 2020 2020 2020  _enabled:.      
-0000d050: 2020 2020 2020 6172 6561 5f73 6361 6e5f        area_scan_
-0000d060: 726f 775f 636f 756e 7420 3d20 7370 6563  row_count = spec
-0000d070: 7472 756d 5b30 5d0a 0a20 2020 2020 2020  trum[0]..       
-0000d080: 2020 2020 2023 2066 6f72 2069 2069 6e20       # for i in 
-0000d090: 7261 6e67 6528 3429 3a0a 2020 2020 2020  range(4):.      
-0000d0a0: 2020 2020 2020 2320 2020 2020 7370 6563        #     spec
-0000d0b0: 7472 756d 5b69 5d20 3d20 7370 6563 7472  trum[i] = spectr
-0000d0c0: 756d 5b34 5d20 2320 4b4c 5544 4745 3a20  um[4] # KLUDGE: 
-0000d0d0: 4e52 442d 6475 616c 0a0a 2020 2020 2020  NRD-dual..      
-0000d0e0: 2020 2020 2020 2320 4c65 6176 6520 7468        # Leave th
-0000d0f0: 6520 726f 7720 636f 756e 7465 7220 696e  e row counter in
-0000d100: 2070 6c61 6365 2069 6620 7765 2772 6520   place if we're 
-0000d110: 696e 2022 4661 7374 2220 4172 6561 2053  in "Fast" Area S
-0000d120: 6361 6e20 6d6f 6465 2c0a 2020 2020 2020  can mode,.      
-0000d130: 2020 2020 2020 2320 7369 6e63 6520 646f        # since do
-0000d140: 776e 7374 7265 616d 2073 6f66 7477 6172  wnstream softwar
-0000d150: 6520 6361 6e20 7573 6520 6974 2074 6f20  e can use it to 
-0000d160: 6173 7365 6d62 6c65 2074 6865 2066 696e  assemble the fin
-0000d170: 616c 2069 6d61 6765 2e0a 2020 2020 2020  al image..      
-0000d180: 2020 2020 2020 2320 2822 536c 6f77 2220        # ("Slow" 
-0000d190: 4172 6561 2053 6361 6e20 6d6f 6465 2073  Area Scan mode s
-0000d1a0: 656e 7420 7468 6973 2076 616c 7565 2062  ent this value b
-0000d1b0: 6163 6b20 6173 2061 2073 6570 6172 6174  ack as a separat
-0000d1c0: 6520 6669 656c 6420 696e 0a20 2020 2020  e field in.     
-0000d1d0: 2020 2020 2020 2023 2074 6865 2052 6561         # the Rea
-0000d1e0: 6469 6e67 2c20 6275 7420 7468 6973 2069  ding, but this i
-0000d1f0: 736e 2774 2070 6f73 7369 626c 6520 696e  sn't possible in
-0000d200: 2046 6173 7420 6d6f 6465 2e20 204a 7573   Fast mode.  Jus
-0000d210: 7420 6465 6c65 7465 0a20 2020 2020 2020  t delete.       
-0000d220: 2020 2020 2023 2053 6c6f 7720 6d6f 6465       # Slow mode
-0000d230: 2077 6865 6e20 4661 7374 2069 7320 7769   when Fast is wi
-0000d240: 6465 6c79 2064 6570 6c6f 7965 642e 290a  dely deployed.).
-0000d250: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
-0000d260: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0000d270: 2073 656c 662e 7365 7474 696e 6773 2e73   self.settings.s
-0000d280: 7461 7465 2e61 7265 615f 7363 616e 5f66  tate.area_scan_f
-0000d290: 6173 743a 0a20 2020 2020 2020 2020 2020  ast:.           
-0000d2a0: 2020 2020 2073 7065 6374 7275 6d5b 305d       spectrum[0]
-0000d2b0: 203d 2073 7065 6374 7275 6d5b 315d 0a0a   = spectrum[1]..
-0000d2c0: 2020 2020 2020 2020 2323 2323 2323 2323          ########
+0000cbb0: 2323 0d0a 0d0a 2020 2020 2020 2020 6c6f  ##....        lo
+0000cbc0: 672e 6465 6275 6728 2267 6574 5f6c 696e  g.debug("get_lin
+0000cbd0: 653a 2063 6f6d 706c 6574 6564 2069 6e20  e: completed in 
+0000cbe0: 252e 3266 2073 6563 2028 7673 2069 6e74  %.2f sec (vs int
+0000cbf0: 6567 7261 7469 6f6e 2074 696d 6520 2564  egration time %d
+0000cc00: 206d 7329 222c 0d0a 2020 2020 2020 2020   ms)",..        
+0000cc10: 2020 2020 2864 6174 6574 696d 652e 6461      (datetime.da
+0000cc20: 7465 7469 6d65 2e6e 6f77 2829 202d 2061  tetime.now() - a
+0000cc30: 6371 7569 7369 7469 6f6e 5f74 696d 6573  cquisition_times
+0000cc40: 7461 6d70 292e 746f 7461 6c5f 7365 636f  tamp).total_seco
+0000cc50: 6e64 7328 292c 0d0a 2020 2020 2020 2020  nds(),..        
+0000cc60: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
+0000cc70: 732e 7374 6174 652e 696e 7465 6772 6174  s.state.integrat
+0000cc80: 696f 6e5f 7469 6d65 5f6d 7329 0d0a 0d0a  ion_time_ms)....
+0000cc90: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
+0000cca0: 6728 2267 6574 5f6c 696e 653a 2070 6978  g("get_line: pix
+0000ccb0: 656c 7320 2564 2c20 656e 6470 6f69 6e74  els %d, endpoint
+0000ccc0: 7320 2573 2c20 626c 6f63 6b20 2564 2c20  s %s, block %d, 
+0000ccd0: 7370 6563 7472 756d 2025 7320 2e2e 2e22  spectrum %s ..."
+0000cce0: 2c0d 0a20 2020 2020 2020 2020 2020 206c  ,..            l
+0000ccf0: 656e 2873 7065 6374 7275 6d29 2c20 656e  en(spectrum), en
+0000cd00: 6470 6f69 6e74 732c 2062 6c6f 636b 5f6c  dpoints, block_l
+0000cd10: 656e 5f62 7974 6573 2c20 7370 6563 7472  en_bytes, spectr
+0000cd20: 756d 5b30 3a39 5d29 0d0a 0d0a 2020 2020  um[0:9])....    
+0000cd30: 2020 2020 6966 206c 656e 2873 7065 6374      if len(spect
+0000cd40: 7275 6d29 2021 3d20 7069 7865 6c73 3a0d  rum) != pixels:.
+0000cd50: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0000cd60: 2e65 7272 6f72 2822 6765 745f 6c69 6e65  .error("get_line
+0000cd70: 2072 6561 6420 7772 6f6e 6720 6e75 6d62   read wrong numb
+0000cd80: 6572 206f 6620 7069 7865 6c73 2028 6578  er of pixels (ex
+0000cd90: 7065 6374 6564 2025 642c 2072 6561 6420  pected %d, read 
+0000cda0: 2564 2922 2c20 7069 7865 6c73 2c20 6c65  %d)", pixels, le
+0000cdb0: 6e28 7370 6563 7472 756d 2929 0d0a 2020  n(spectrum))..  
+0000cdc0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+0000cdd0: 7365 2e65 7272 6f72 5f6d 7367 203d 2066  se.error_msg = f
+0000cde0: 2267 6574 5f6c 696e 6520 7265 6164 2077  "get_line read w
+0000cdf0: 726f 6e67 206e 756d 6265 7220 6f66 2070  rong number of p
+0000ce00: 6978 656c 7320 2865 7870 6563 7465 6420  ixels (expected 
+0000ce10: 7b70 6978 656c 737d 2c20 7265 6164 207b  {pixels}, read {
+0000ce20: 6c65 6e28 7370 6563 7472 756d 297d 2922  len(spectrum)})"
+0000ce30: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0000ce40: 7370 6f6e 7365 2e65 7272 6f72 5f6c 766c  sponse.error_lvl
+0000ce50: 203d 2045 7272 6f72 4c65 7665 6c2e 6c6f   = ErrorLevel.lo
+0000ce60: 770d 0a20 2020 2020 2020 2020 2020 2072  w..            r
+0000ce70: 6573 706f 6e73 652e 6b65 6570 5f61 6c69  esponse.keep_ali
+0000ce80: 7665 203d 2054 7275 650d 0a20 2020 2020  ve = True..     
+0000ce90: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0000cea0: 7370 6f6e 7365 0d0a 2020 2020 2020 2020  sponse..        
+0000ceb0: 2020 2020 2320 6966 206c 656e 2873 7065      # if len(spe
+0000cec0: 6374 7275 6d29 203c 2070 6978 656c 733a  ctrum) < pixels:
+0000ced0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000cee0: 2020 2020 7370 6563 7472 756d 2e65 7874      spectrum.ext
+0000cef0: 656e 6428 5b30 5d20 2a20 2870 6978 656c  end([0] * (pixel
+0000cf00: 7320 2d20 6c65 6e28 7370 6563 7472 756d  s - len(spectrum
+0000cf10: 2929 290d 0a20 2020 2020 2020 2020 2020  )))..           
+0000cf20: 2023 2065 6c73 653a 0d0a 2020 2020 2020   # else:..      
+0000cf30: 2020 2020 2020 2320 2020 2020 7370 6563        #     spec
+0000cf40: 7472 756d 203d 2073 7065 6374 7275 6d5b  trum = spectrum[
+0000cf50: 3a2d 7069 7865 6c73 5d0d 0a0d 0a20 2020  :-pixels]....   
+0000cf60: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+0000cf70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000cf80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000cf90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000cfa0: 2323 2323 2323 2323 2323 2323 230d 0a20  #############.. 
+0000cfb0: 2020 2020 2020 2023 0d0a 2020 2020 2020         #..      
+0000cfc0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+0000cfd0: 2020 2020 2020 706f 7374 2d70 726f 6365        post-proce
+0000cfe0: 7373 2074 6865 2073 7065 6374 7275 6d0d  ss the spectrum.
+0000cff0: 0a20 2020 2020 2020 2023 0d0a 2020 2020  .        #..    
+0000d000: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+0000d010: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d020: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d030: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d040: 2323 2323 2323 2323 2323 2323 0d0a 0d0a  ############....
+0000d050: 2020 2020 2020 2020 2323 2323 2323 2323          ########
+0000d060: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d090: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d0a0: 0d0a 2020 2020 2020 2020 2320 4170 706c  ..        # Appl
+0000d0b0: 7920 496e 4761 4173 2065 7665 6e2f 6f64  y InGaAs even/od
+0000d0c0: 6420 6761 696e 2f6f 6666 7365 7420 696e  d gain/offset in
+0000d0d0: 2073 6f66 7477 6172 650d 0a20 2020 2020   software..     
+0000d0e0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+0000d0f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d100: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d120: 2323 2323 2323 2323 2323 230d 0a0d 0a20  ###########.... 
+0000d130: 2020 2020 2020 2023 2028 6265 666f 7265         # (before
+0000d140: 2078 2d61 7869 7320 696e 7665 7273 696f   x-axis inversio
+0000d150: 6e20 6265 6361 7573 6520 7468 6973 2069  n because this i
+0000d160: 7320 7768 6572 6520 4650 4741 2077 696c  s where FPGA wil
+0000d170: 6c20 646f 2069 7429 0d0a 0d0a 2020 2020  l do it)....    
+0000d180: 2020 2020 2320 7468 6973 2073 686f 756c      # this shoul
+0000d190: 6420 6265 2064 6f6e 6520 696e 2074 6865  d be done in the
+0000d1a0: 2046 5047 412c 2062 7574 206f 6c64 6572   FPGA, but older
+0000d1b0: 2046 5720 6469 646e 2774 2068 6176 6520   FW didn't have 
+0000d1c0: 7468 6174 0d0a 2020 2020 2020 2020 2320  that..        # 
+0000d1d0: 696d 706c 656d 656e 7465 642c 2073 6f20  implemented, so 
+0000d1e0: 6669 7820 696e 2053 5720 756e 6c65 7373  fix in SW unless
+0000d1f0: 2045 4550 524f 4d20 696e 6469 6361 7465   EEPROM indicate
+0000d200: 7320 2261 6c72 6561 6479 2068 616e 646c  s "already handl
+0000d210: 6564 220d 0a20 2020 2020 2020 2069 6620  ed"..        if 
+0000d220: 7365 6c66 2e73 6574 7469 6e67 732e 6973  self.settings.is
+0000d230: 5f69 6e67 6161 7328 2920 616e 6420 6e6f  _ingaas() and no
+0000d240: 7420 7365 6c66 2e73 6574 7469 6e67 732e  t self.settings.
+0000d250: 6565 7072 6f6d 2e68 6172 6477 6172 655f  eeprom.hardware_
+0000d260: 6576 656e 5f6f 6464 3a0d 0a20 2020 2020  even_odd:..     
+0000d270: 2020 2020 2020 2073 656c 662e 5f63 6f72         self._cor
+0000d280: 7265 6374 5f69 6e67 6161 735f 6761 696e  rect_ingaas_gain
+0000d290: 5f61 6e64 5f6f 6666 7365 7428 7370 6563  _and_offset(spec
+0000d2a0: 7472 756d 290d 0a0d 0a20 2020 2020 2020  trum)....       
+0000d2b0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+0000d2c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000d2d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000d2e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d2f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d300: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d310: 0a20 2020 2020 2020 2023 2053 7461 7274  .        # Start
-0000d320: 2d6f 662d 5370 6563 7472 756d 204d 6172  -of-Spectrum Mar
-0000d330: 6b65 7220 2872 6172 6529 0a20 2020 2020  ker (rare).     
-0000d340: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+0000d2f0: 2323 2323 2323 2323 230d 0a20 2020 2020  #########..     
+0000d300: 2020 2023 2041 7265 6120 5363 616e 2028     # Area Scan (
+0000d310: 7261 7265 290d 0a20 2020 2020 2020 2023  rare)..        #
+0000d320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000d350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d370: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d380: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-0000d390: 2020 2020 2023 2028 6265 666f 7265 2078       # (before x
-0000d3a0: 2d61 7869 7320 696e 7665 7273 696f 6e20  -axis inversion 
-0000d3b0: 6265 6361 7573 6520 6d61 726b 6572 2061  because marker a
-0000d3c0: 7420 4650 4741 2070 6978 656c 2030 290a  t FPGA pixel 0).
-0000d3d0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-0000d3e0: 2061 6e64 2074 7261 636b 2074 6865 2022   and track the "
-0000d3f0: 7374 6172 7420 6f66 2073 7065 6374 7275  start of spectru
-0000d400: 6d22 206d 6172 6b65 722e 2020 5468 6973  m" marker.  This
-0000d410: 2069 7320 7665 7279 2072 6172 6520 616e   is very rare an
-0000d420: 640a 2020 2020 2020 2020 2320 6f6e 6c79  d.        # only
-0000d430: 2066 6f72 2065 7870 6572 696d 656e 7461   for experimenta
-0000d440: 6c20 756e 6974 732e 2020 4375 7272 656e  l units.  Curren
-0000d450: 746c 7920 5761 7361 7463 6820 646f 6573  tly Wasatch does
-0000d460: 206e 6f74 2068 6176 6520 616e 790a 2020   not have any.  
-0000d470: 2020 2020 2020 2320 2273 7461 6e64 6172        # "standar
-0000d480: 6422 2073 7065 6374 7275 6d20 6672 616d  d" spectrum fram
-0000d490: 696e 6720 6461 7461 2c20 616c 7468 6f75  ing data, althou
-0000d4a0: 6768 2073 7563 6820 776f 756c 6420 6265  gh such would be
-0000d4b0: 2075 7365 6675 6c2e 2054 6869 730a 2020   useful. This.  
-0000d4c0: 2020 2020 2020 2320 6973 206f 6e6c 7920        # is only 
-0000d4d0: 656e 6162 6c65 6420 696e 2046 5047 4173  enabled in FPGAs
-0000d4e0: 2077 6865 6e20 7472 7969 6e67 2074 6f20   when trying to 
-0000d4f0: 6465 6275 6720 7261 7265 2074 696d 696e  debug rare timin
-0000d500: 6720 6973 7375 6573 2e20 5468 650a 2020  g issues. The.  
-0000d510: 2020 2020 2020 2320 224d 6172 6b65 7222        # "Marker"
-0000d520: 2069 7320 7369 6d70 6c79 2061 2070 6978   is simply a pix
-0000d530: 656c 2077 6974 6820 7468 6520 7661 6c75  el with the valu
-0000d540: 6520 3078 6666 6666 2e20 204f 6e20 4650  e 0xffff.  On FP
-0000d550: 4741 2046 5720 7768 6572 6520 7468 650a  GA FW where the.
-0000d560: 2020 2020 2020 2020 2320 6d61 726b 6572          # marker
-0000d570: 2069 7320 656e 6162 6c65 642c 2073 7065   is enabled, spe
-0000d580: 6374 7261 6c20 6461 7461 2069 7320 636c  ctral data is cl
-0000d590: 616d 7065 6420 746f 2030 7866 6666 652c  amped to 0xfffe,
-0000d5a0: 206d 6561 6e69 6e67 2073 7563 680a 2020   meaning such.  
-0000d5b0: 2020 2020 2020 2320 6d61 726b 6572 7320        # markers 
-0000d5c0: 6361 6e20 4f4e 4c59 2061 7070 6561 7220  can ONLY appear 
-0000d5d0: 6173 2074 6865 2066 6972 7374 2070 6978  as the first pix
-0000d5e0: 656c 2069 6e20 6120 7370 6563 7472 756d  el in a spectrum
-0000d5f0: 2e0a 2020 2020 2020 2020 230a 2020 2020  ..        #.    
-0000d600: 2020 2020 2320 576f 756c 6420 6e65 6564      # Would need
-0000d610: 2075 7064 6174 6564 2074 6f20 776f 726b   updated to work
-0000d620: 2077 6974 6820 4465 7465 6374 6f72 5265   with DetectorRe
-0000d630: 6769 6f6e 732e 0a20 2020 2020 2020 2069  gions..        i
-0000d640: 6620 7365 6c66 2e73 6574 7469 6e67 732e  f self.settings.
-0000d650: 6861 735f 6d61 726b 6572 2829 2061 6e64  has_marker() and
-0000d660: 206e 6f74 2073 656c 662e 7365 7474 696e   not self.settin
-0000d670: 6773 2e73 7461 7465 2e61 7265 615f 7363  gs.state.area_sc
-0000d680: 616e 5f65 6e61 626c 6564 3a0a 2020 2020  an_enabled:.    
-0000d690: 2020 2020 2020 2020 6d61 726b 6572 203d          marker =
-0000d6a0: 2030 7866 6666 660a 2020 2020 2020 2020   0xffff.        
-0000d6b0: 2020 2020 6966 2073 7065 6374 7275 6d5b      if spectrum[
-0000d6c0: 305d 203d 3d20 6d61 726b 6572 3a0a 2020  0] == marker:.  
-0000d6d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000d6e0: 6d61 726b 6572 2066 6f75 6e64 2077 6865  marker found whe
-0000d6f0: 7265 2065 7870 6563 7465 642c 2073 6f20  re expected, so 
-0000d700: 616c 6c20 6973 2067 6f6f 6420 286f 7665  all is good (ove
-0000d710: 7277 7269 7465 2066 6f72 2061 0a20 2020  rwrite for a.   
-0000d720: 2020 2020 2020 2020 2020 2020 2023 2063               # c
-0000d730: 6c65 616e 2067 7261 7068 290a 2020 2020  lean graph).    
-0000d740: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-0000d750: 7472 756d 5b30 5d20 3d20 7370 6563 7472  trum[0] = spectr
-0000d760: 756d 5b31 5d0a 2020 2020 2020 2020 2020  um[1].          
-0000d770: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000d780: 2020 2020 2020 2020 2320 7765 2044 4944          # we DID
-0000d790: 4e27 5420 6669 6e64 2074 6865 206d 6172  N'T find the mar
-0000d7a0: 6b65 7220 7768 6572 6520 6974 2077 6173  ker where it was
-0000d7b0: 2065 7870 6563 7465 642c 2073 6f20 666c   expected, so fl
-0000d7c0: 6167 2061 6e64 0a20 2020 2020 2020 2020  ag and.         
-0000d7d0: 2020 2020 2020 2023 2067 6f20 6875 6e74         # go hunt
-0000d7e0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0000d7f0: 2020 2020 6c6f 672e 6572 726f 7228 2267      log.error("g
-0000d800: 6574 5f6c 696e 653a 206d 6973 7369 6e67  et_line: missing
-0000d810: 206d 6172 6b65 7222 290a 2020 2020 2020   marker").      
-0000d820: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-0000d830: 696e 2072 616e 6765 2870 6978 656c 7329  in range(pixels)
-0000d840: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d850: 2020 2020 2020 6966 2073 7065 6374 7275        if spectru
-0000d860: 6d5b 695d 203d 3d20 6d61 726b 6572 3a0a  m[i] == marker:.
-0000d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d880: 2020 2020 2020 2020 6c6f 672e 6572 726f          log.erro
-0000d890: 7228 2267 6574 5f6c 696e 653a 206d 6172  r("get_line: mar
-0000d8a0: 6b65 7220 666f 756e 6420 6174 2070 6978  ker found at pix
-0000d8b0: 656c 2025 6422 2c20 6929 0a0a 2020 2020  el %d", i)..    
-0000d8c0: 2020 2020 2320 636f 6e73 6964 6572 2073      # consider s
-0000d8d0: 6b69 7070 696e 6720 6d75 6368 206f 6620  kipping much of 
-0000d8e0: 7468 6520 666f 6c6c 6f77 696e 6720 6966  the following if
-0000d8f0: 2069 6e20 6172 6561 2073 6361 6e20 6d6f   in area scan mo
-0000d900: 6465 0a0a 2020 2020 2020 2020 2323 2323  de..        ####
-0000d910: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d920: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d930: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d940: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d950: 2323 2323 0a20 2020 2020 2020 2023 2053  ####.        # S
-0000d960: 746f 6d70 2061 7272 6179 2065 6e64 730a  tomp array ends.
-0000d970: 2020 2020 2020 2020 2323 2323 2323 2323          ########
-0000d980: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d990: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d9a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d9b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d9c0: 0a0a 2020 2020 2020 2020 2320 2862 6566  ..        # (bef
-0000d9d0: 6f72 6520 782d 6178 6973 2069 6e76 6572  ore x-axis inver
-0000d9e0: 7369 6f6e 2062 6563 6175 7365 206f 7074  sion because opt
-0000d9f0: 6963 616c 6c79 206d 6173 6b65 6420 7069  ically masked pi
-0000da00: 7865 6c73 2061 7265 2070 6879 7369 6361  xels are physica
-0000da10: 6c29 0a0a 2020 2020 2020 2020 2320 736f  l)..        # so
-0000da20: 6d65 2064 6574 6563 746f 7273 2068 6176  me detectors hav
-0000da30: 6520 2267 6172 6261 6765 2220 7069 7865  e "garbage" pixe
-0000da40: 6c73 2061 7420 7468 6520 6672 6f6e 7420  ls at the front 
-0000da50: 6f72 2065 6e64 206f 6620 6576 6572 790a  or end of every.
-0000da60: 2020 2020 2020 2020 2320 7370 6563 7472          # spectr
-0000da70: 756d 2028 7379 6e63 2062 7974 6573 2061  um (sync bytes a
-0000da80: 6e64 2077 6861 742d 6e6f 7429 0a20 2020  nd what-not).   
-0000da90: 2020 2020 2069 6620 7365 6c66 2e73 6574       if self.set
-0000daa0: 7469 6e67 732e 6973 5f6d 6963 726f 2829  tings.is_micro()
-0000dab0: 2061 6e64 2073 656c 662e 7365 7474 696e   and self.settin
-0000dac0: 6773 2e73 7461 7465 2e64 6574 6563 746f  gs.state.detecto
-0000dad0: 725f 7265 6769 6f6e 7320 6973 204e 6f6e  r_regions is Non
-0000dae0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0000daf0: 6620 7365 6c66 2e73 6574 7469 6e67 732e  f self.settings.
-0000db00: 6973 5f69 6d78 3339 3228 293a 0a20 2020  is_imx392():.   
-0000db10: 2020 2020 2020 2020 2020 2020 2075 7469               uti
-0000db20: 6c73 2e73 746f 6d70 5f66 6972 7374 2873  ls.stomp_first(s
-0000db30: 7065 6374 7275 6d2c 2033 290a 2020 2020  pectrum, 3).    
-0000db40: 2020 2020 2020 2020 2020 2020 7574 696c              util
-0000db50: 732e 7374 6f6d 705f 6c61 7374 2028 7370  s.stomp_last (sp
-0000db60: 6563 7472 756d 2c20 3137 290a 2020 2020  ectrum, 17).    
-0000db70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000db80: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000db90: 7072 6573 756d 6162 6c79 2049 4d58 3338  presumably IMX38
-0000dba0: 350a 2020 2020 2020 2020 2020 2020 2020  5.              
-0000dbb0: 2020 7574 696c 732e 7374 6f6d 705f 6669    utils.stomp_fi
-0000dbc0: 7273 7428 7370 6563 7472 756d 2c20 3329  rst(spectrum, 3)
-0000dbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dbe0: 2075 7469 6c73 2e73 746f 6d70 5f6c 6173   utils.stomp_las
-0000dbf0: 7420 2873 7065 6374 7275 6d2c 2031 290a  t (spectrum, 1).
-0000dc00: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
-0000dc10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dc20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dc30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dc40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dc50: 230a 2020 2020 2020 2020 2320 496e 7665  #.        # Inve
-0000dc60: 7274 2058 2d41 7869 730a 2020 2020 2020  rt X-Axis.      
-0000dc70: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-0000dc80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dc90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dca0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dcb0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-0000dcc0: 2020 2020 2320 466f 7220 6265 6e63 6865      # For benche
-0000dcd0: 7320 7768 6572 6520 7468 6520 6465 7465  s where the dete
-0000dce0: 6374 6f72 2069 7320 6573 7365 6e74 6961  ctor is essentia
-0000dcf0: 6c6c 7920 726f 7461 7465 6420 3138 302d  lly rotated 180-
-0000dd00: 6465 6720 6672 6f6d 206f 7572 0a20 2020  deg from our.   
-0000dd10: 2020 2020 2023 2074 7970 6963 616c 206f       # typical o
-0000dd20: 7269 656e 7461 7469 6f6e 2077 6974 6820  rientation with 
-0000dd30: 7265 6761 7264 2074 6f20 7468 6520 6772  regard to the gr
-0000dd40: 6174 696e 6720 2865 2e67 2e20 496e 4761  ating (e.g. InGa
-0000dd50: 4173 204f 454d 0a20 2020 2020 2020 2023  As OEM.        #
-0000dd60: 2062 656e 6368 6573 2c20 7768 6572 6520   benches, where 
-0000dd70: 7265 6420 7761 7665 6c65 6e67 7468 7320  red wavelengths 
-0000dd80: 6172 6520 6469 6666 7261 6374 6564 2074  are diffracted t
-0000dd90: 6f77 6172 6420 7069 7865 6c20 302c 2061  oward pixel 0, a
-0000dda0: 6e64 2062 6c75 650a 2020 2020 2020 2020  nd blue.        
-0000ddb0: 2320 7761 7665 6c65 6e67 7468 7320 746f  # wavelengths to
-0000ddc0: 7761 7264 2070 6978 656c 2035 3131 292e  ward pixel 511).
-0000ddd0: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
-0000dde0: 2020 2023 204e 6f74 6520 7468 6973 2073     # Note this s
-0000ddf0: 696d 706c 7920 7065 7266 6f72 6d73 2061  imply performs a
-0000de00: 2068 6f72 697a 6f6e 7461 6c20 464c 4950   horizontal FLIP
-0000de10: 2028 6d69 7272 6f72 2920 6f66 2074 6865   (mirror) of the
-0000de20: 2076 6572 7469 6361 6c6c 792d 0a20 2020   vertically-.   
-0000de30: 2020 2020 2023 2062 696e 6e65 6420 312d       # binned 1-
-0000de40: 4420 7370 6563 7472 612c 2061 6e64 2069  D spectra, and i
-0000de50: 7320 4e4f 5420 7375 6666 6963 6965 6e74  s NOT sufficient
-0000de60: 2074 6f20 7065 7266 6f72 6d20 6120 6765   to perform a ge
-0000de70: 6e75 696e 6520 3138 302d 0a20 2020 2020  nuine 180-.     
-0000de80: 2020 2023 2064 6567 7265 6520 726f 7461     # degree rota
-0000de90: 7469 6f6e 206f 6620 322d 4420 696d 6167  tion of 2-D imag
-0000dea0: 696e 6720 6d6f 6465 3b20 6966 2022 6175  ing mode; if "au
-0000deb0: 7468 656e 7469 6322 2061 7265 6120 7363  thentic" area sc
-0000dec0: 616e 2069 730a 2020 2020 2020 2020 2320  an is.        # 
-0000ded0: 6465 7369 7265 642c 2074 6865 2063 616c  desired, the cal
-0000dee0: 6c65 7220 776f 756c 6420 6c69 6b65 7769  ler would likewi
-0000def0: 7365 206e 6565 6420 746f 2072 6576 6572  se need to rever
-0000df00: 7365 2074 6865 2064 6973 706c 6179 206f  se the display o
-0000df10: 7264 6572 206f 660a 2020 2020 2020 2020  rder of.        
-0000df20: 2320 7468 6520 726f 7773 2e0a 2020 2020  # the rows..    
-0000df30: 2020 2020 230a 2020 2020 2020 2020 2320      #.        # 
-0000df40: 2020 2020 2020 2020 2020 4974 2069 7320            It is 
-0000df50: 5649 5441 4c4c 5920 494d 504f 5254 414e  VITALLY IMPORTAN
-0000df60: 5420 7468 6174 2061 6c6c 2064 7269 7665  T that all drive
-0000df70: 7273 2061 6772 6565 0a20 2020 2020 2020  rs agree.       
-0000df80: 2023 2020 2020 2020 2020 2020 2020 6f6e   #            on
-0000df90: 2077 6865 6e20 746f 2070 6572 666f 726d   when to perform
-0000dfa0: 2058 2d41 7869 7320 696e 7665 7273 696f   X-Axis inversio
-0000dfb0: 6e20 696e 2074 6865 0a20 2020 2020 2020  n in the.       
-0000dfc0: 2023 2020 2020 2020 2020 2020 2020 2020   #              
-0000dfd0: 2020 2020 2020 2020 2020 4f72 6465 7220            Order 
-0000dfe0: 6f66 204f 7065 7261 7469 6f6e 732e 0a20  of Operations.. 
-0000dff0: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-0000e000: 2069 6620 7365 6c66 2e73 6574 7469 6e67   if self.setting
-0000e010: 732e 6565 7072 6f6d 2e69 6e76 6572 745f  s.eeprom.invert_
-0000e020: 785f 6178 6973 2061 6e64 206e 6f74 2073  x_axis and not s
-0000e030: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
-0000e040: 7465 2e61 7265 615f 7363 616e 5f65 6e61  te.area_scan_ena
-0000e050: 626c 6564 3a0a 2020 2020 2020 2020 2020  bled:.          
-0000e060: 2020 7370 6563 7472 756d 2e72 6576 6572    spectrum.rever
-0000e070: 7365 2829 0a0a 2020 2020 2020 2020 2323  se()..        ##
-0000e080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e090: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e0a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e0b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e0c0: 2323 2323 2323 0a20 2020 2020 2020 2023  ######.        #
-0000e0d0: 2042 6164 2050 6978 656c 2043 6f72 7265   Bad Pixel Corre
-0000e0e0: 6374 696f 6e0a 2020 2020 2020 2020 2323  ction.        ##
-0000e0f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d360: 2323 2323 2323 230d 0a0d 0a20 2020 2020  #######....     
+0000d370: 2020 2023 2028 6265 666f 7265 2078 2d61     # (before x-a
+0000d380: 7869 7320 696e 7665 7273 696f 6e20 6265  xis inversion be
+0000d390: 6361 7573 6520 6c69 6e65 2069 6e64 6578  cause line index
+0000d3a0: 2061 7420 4650 4741 2070 6978 656c 2030   at FPGA pixel 0
+0000d3b0: 290d 0a0d 0a20 2020 2020 2020 2023 2049  )....        # I
+0000d3c0: 6620 7765 2772 6520 696e 2061 7265 6120  f we're in area 
+0000d3d0: 7363 616e 206d 6f64 652c 2075 7365 2066  scan mode, use f
+0000d3e0: 6972 7374 2070 6978 656c 2061 7320 726f  irst pixel as ro
+0000d3f0: 7720 696e 6465 7820 286c 6561 7665 2070  w index (leave p
+0000d400: 6978 656c 200d 0a20 2020 2020 2020 2023  ixel ..        #
+0000d410: 2069 6e20 7370 6563 7472 756d 292e 2020   in spectrum).  
+0000d420: 446f 2074 6869 7320 6265 666f 7265 2061  Do this before a
+0000d430: 6e79 2068 6f72 697a 6f6e 7461 6c20 6176  ny horizontal av
+0000d440: 6572 6167 696e 6720 7768 6963 6820 6d69  eraging which mi
+0000d450: 6768 7420 0d0a 2020 2020 2020 2020 2320  ght ..        # 
+0000d460: 636f 7272 7570 7420 6669 7273 7420 7069  corrupt first pi
+0000d470: 7865 6c29 2e20 204e 6f74 6520 7468 6174  xel).  Note that
+0000d480: 2049 6e47 6141 7320 646f 6e27 7420 7375   InGaAs don't su
+0000d490: 7070 6f72 7420 4465 7465 6374 6f72 5265  pport DetectorRe
+0000d4a0: 6769 6f6e 732e 0d0a 2020 2020 2020 2020  gions...        
+0000d4b0: 6172 6561 5f73 6361 6e5f 726f 775f 636f  area_scan_row_co
+0000d4c0: 756e 7420 3d20 2d31 0d0a 2020 2020 2020  unt = -1..      
+0000d4d0: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
+0000d4e0: 6773 2e73 7461 7465 2e61 7265 615f 7363  gs.state.area_sc
+0000d4f0: 616e 5f65 6e61 626c 6564 3a0d 0a20 2020  an_enabled:..   
+0000d500: 2020 2020 2020 2020 2061 7265 615f 7363           area_sc
+0000d510: 616e 5f72 6f77 5f63 6f75 6e74 203d 2073  an_row_count = s
+0000d520: 7065 6374 7275 6d5b 305d 0d0a 0d0a 2020  pectrum[0]....  
+0000d530: 2020 2020 2020 2020 2020 2320 666f 7220            # for 
+0000d540: 6920 696e 2072 616e 6765 2834 293a 0d0a  i in range(4):..
+0000d550: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000d560: 2020 7370 6563 7472 756d 5b69 5d20 3d20    spectrum[i] = 
+0000d570: 7370 6563 7472 756d 5b34 5d20 2320 4b4c  spectrum[4] # KL
+0000d580: 5544 4745 3a20 4e52 442d 6475 616c 0d0a  UDGE: NRD-dual..
+0000d590: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000d5a0: 4c65 6176 6520 7468 6520 726f 7720 636f  Leave the row co
+0000d5b0: 756e 7465 7220 696e 2070 6c61 6365 2069  unter in place i
+0000d5c0: 6620 7765 2772 6520 696e 2022 4661 7374  f we're in "Fast
+0000d5d0: 2220 4172 6561 2053 6361 6e20 6d6f 6465  " Area Scan mode
+0000d5e0: 2c0d 0a20 2020 2020 2020 2020 2020 2023  ,..            #
+0000d5f0: 2073 696e 6365 2064 6f77 6e73 7472 6561   since downstrea
+0000d600: 6d20 736f 6674 7761 7265 2063 616e 2075  m software can u
+0000d610: 7365 2069 7420 746f 2061 7373 656d 626c  se it to assembl
+0000d620: 6520 7468 6520 6669 6e61 6c20 696d 6167  e the final imag
+0000d630: 652e 0d0a 2020 2020 2020 2020 2020 2020  e...            
+0000d640: 2320 2822 536c 6f77 2220 4172 6561 2053  # ("Slow" Area S
+0000d650: 6361 6e20 6d6f 6465 2073 656e 7420 7468  can mode sent th
+0000d660: 6973 2076 616c 7565 2062 6163 6b20 6173  is value back as
+0000d670: 2061 2073 6570 6172 6174 6520 6669 656c   a separate fiel
+0000d680: 6420 696e 0d0a 2020 2020 2020 2020 2020  d in..          
+0000d690: 2020 2320 7468 6520 5265 6164 696e 672c    # the Reading,
+0000d6a0: 2062 7574 2074 6869 7320 6973 6e27 7420   but this isn't 
+0000d6b0: 706f 7373 6962 6c65 2069 6e20 4661 7374  possible in Fast
+0000d6c0: 206d 6f64 652e 2020 4a75 7374 2064 656c   mode.  Just del
+0000d6d0: 6574 650d 0a20 2020 2020 2020 2020 2020  ete..           
+0000d6e0: 2023 2053 6c6f 7720 6d6f 6465 2077 6865   # Slow mode whe
+0000d6f0: 6e20 4661 7374 2069 7320 7769 6465 6c79  n Fast is widely
+0000d700: 2064 6570 6c6f 7965 642e 290d 0a20 2020   deployed.)..   
+0000d710: 2020 2020 2020 2020 2023 0d0a 2020 2020           #..    
+0000d720: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0000d730: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+0000d740: 7465 2e61 7265 615f 7363 616e 5f66 6173  te.area_scan_fas
+0000d750: 743a 0d0a 2020 2020 2020 2020 2020 2020  t:..            
+0000d760: 2020 2020 7370 6563 7472 756d 5b30 5d20      spectrum[0] 
+0000d770: 3d20 7370 6563 7472 756d 5b31 5d0d 0a0d  = spectrum[1]...
+0000d780: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+0000d790: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d7a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d7b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d7c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d7d0: 230d 0a20 2020 2020 2020 2023 2053 7461  #..        # Sta
+0000d7e0: 7274 2d6f 662d 5370 6563 7472 756d 204d  rt-of-Spectrum M
+0000d7f0: 6172 6b65 7220 2872 6172 6529 0d0a 2020  arker (rare)..  
+0000d800: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
+0000d810: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d820: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d830: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d840: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+0000d850: 0d0a 2020 2020 2020 2020 2320 2862 6566  ..        # (bef
+0000d860: 6f72 6520 782d 6178 6973 2069 6e76 6572  ore x-axis inver
+0000d870: 7369 6f6e 2062 6563 6175 7365 206d 6172  sion because mar
+0000d880: 6b65 7220 6174 2046 5047 4120 7069 7865  ker at FPGA pixe
+0000d890: 6c20 3029 0d0a 0d0a 2020 2020 2020 2020  l 0)....        
+0000d8a0: 2320 4368 6563 6b20 616e 6420 7472 6163  # Check and trac
+0000d8b0: 6b20 7468 6520 2273 7461 7274 206f 6620  k the "start of 
+0000d8c0: 7370 6563 7472 756d 2220 6d61 726b 6572  spectrum" marker
+0000d8d0: 2e20 2054 6869 7320 6973 2076 6572 7920  .  This is very 
+0000d8e0: 7261 7265 2061 6e64 0d0a 2020 2020 2020  rare and..      
+0000d8f0: 2020 2320 6f6e 6c79 2066 6f72 2065 7870    # only for exp
+0000d900: 6572 696d 656e 7461 6c20 756e 6974 732e  erimental units.
+0000d910: 2020 4375 7272 656e 746c 7920 5761 7361    Currently Wasa
+0000d920: 7463 6820 646f 6573 206e 6f74 2068 6176  tch does not hav
+0000d930: 6520 616e 790d 0a20 2020 2020 2020 2023  e any..        #
+0000d940: 2022 7374 616e 6461 7264 2220 7370 6563   "standard" spec
+0000d950: 7472 756d 2066 7261 6d69 6e67 2064 6174  trum framing dat
+0000d960: 612c 2061 6c74 686f 7567 6820 7375 6368  a, although such
+0000d970: 2077 6f75 6c64 2062 6520 7573 6566 756c   would be useful
+0000d980: 2e20 5468 6973 0d0a 2020 2020 2020 2020  . This..        
+0000d990: 2320 6973 206f 6e6c 7920 656e 6162 6c65  # is only enable
+0000d9a0: 6420 696e 2046 5047 4173 2077 6865 6e20  d in FPGAs when 
+0000d9b0: 7472 7969 6e67 2074 6f20 6465 6275 6720  trying to debug 
+0000d9c0: 7261 7265 2074 696d 696e 6720 6973 7375  rare timing issu
+0000d9d0: 6573 2e20 5468 650d 0a20 2020 2020 2020  es. The..       
+0000d9e0: 2023 2022 4d61 726b 6572 2220 6973 2073   # "Marker" is s
+0000d9f0: 696d 706c 7920 6120 7069 7865 6c20 7769  imply a pixel wi
+0000da00: 7468 2074 6865 2076 616c 7565 2030 7866  th the value 0xf
+0000da10: 6666 662e 2020 4f6e 2046 5047 4120 4657  fff.  On FPGA FW
+0000da20: 2077 6865 7265 2074 6865 0d0a 2020 2020   where the..    
+0000da30: 2020 2020 2320 6d61 726b 6572 2069 7320      # marker is 
+0000da40: 656e 6162 6c65 642c 2073 7065 6374 7261  enabled, spectra
+0000da50: 6c20 6461 7461 2069 7320 636c 616d 7065  l data is clampe
+0000da60: 6420 746f 2030 7866 6666 652c 206d 6561  d to 0xfffe, mea
+0000da70: 6e69 6e67 2073 7563 680d 0a20 2020 2020  ning such..     
+0000da80: 2020 2023 206d 6172 6b65 7273 2063 616e     # markers can
+0000da90: 204f 4e4c 5920 6170 7065 6172 2061 7320   ONLY appear as 
+0000daa0: 7468 6520 6669 7273 7420 7069 7865 6c20  the first pixel 
+0000dab0: 696e 2061 2073 7065 6374 7275 6d2e 0d0a  in a spectrum...
+0000dac0: 2020 2020 2020 2020 230d 0a20 2020 2020          #..     
+0000dad0: 2020 2023 2057 6f75 6c64 206e 6565 6420     # Would need 
+0000dae0: 7570 6461 7465 6420 746f 2077 6f72 6b20  updated to work 
+0000daf0: 7769 7468 2044 6574 6563 746f 7252 6567  with DetectorReg
+0000db00: 696f 6e73 2e0d 0a20 2020 2020 2020 2069  ions...        i
+0000db10: 6620 7365 6c66 2e73 6574 7469 6e67 732e  f self.settings.
+0000db20: 6861 735f 6d61 726b 6572 2829 2061 6e64  has_marker() and
+0000db30: 206e 6f74 2073 656c 662e 7365 7474 696e   not self.settin
+0000db40: 6773 2e73 7461 7465 2e61 7265 615f 7363  gs.state.area_sc
+0000db50: 616e 5f65 6e61 626c 6564 3a0d 0a20 2020  an_enabled:..   
+0000db60: 2020 2020 2020 2020 206d 6172 6b65 7220           marker 
+0000db70: 3d20 3078 6666 6666 0d0a 2020 2020 2020  = 0xffff..      
+0000db80: 2020 2020 2020 6966 2073 7065 6374 7275        if spectru
+0000db90: 6d5b 305d 203d 3d20 6d61 726b 6572 3a0d  m[0] == marker:.
+0000dba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dbb0: 2023 206d 6172 6b65 7220 666f 756e 6420   # marker found 
+0000dbc0: 7768 6572 6520 6578 7065 6374 6564 2c20  where expected, 
+0000dbd0: 736f 2061 6c6c 2069 7320 676f 6f64 2028  so all is good (
+0000dbe0: 6f76 6572 7772 6974 6520 666f 7220 610d  overwrite for a.
+0000dbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc00: 2023 2063 6c65 616e 2067 7261 7068 290d   # clean graph).
+0000dc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc20: 2073 7065 6374 7275 6d5b 305d 203d 2073   spectrum[0] = s
+0000dc30: 7065 6374 7275 6d5b 315d 0d0a 2020 2020  pectrum[1]..    
+0000dc40: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+0000dc50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000dc60: 2077 6520 4449 444e 2754 2066 696e 6420   we DIDN'T find 
+0000dc70: 7468 6520 6d61 726b 6572 2077 6865 7265  the marker where
+0000dc80: 2069 7420 7761 7320 6578 7065 6374 6564   it was expected
+0000dc90: 2c20 736f 2066 6c61 6720 616e 640d 0a20  , so flag and.. 
+0000dca0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000dcb0: 2067 6f20 6875 6e74 696e 670d 0a20 2020   go hunting..   
+0000dcc0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0000dcd0: 2e65 7272 6f72 2822 6765 745f 6c69 6e65  .error("get_line
+0000dce0: 3a20 6d69 7373 696e 6720 6d61 726b 6572  : missing marker
+0000dcf0: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+0000dd00: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000dd10: 6765 2870 6978 656c 7329 3a0d 0a20 2020  ge(pixels):..   
+0000dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd30: 2069 6620 7370 6563 7472 756d 5b69 5d20   if spectrum[i] 
+0000dd40: 3d3d 206d 6172 6b65 723a 0d0a 2020 2020  == marker:..    
+0000dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd60: 2020 2020 6c6f 672e 6572 726f 7228 2267      log.error("g
+0000dd70: 6574 5f6c 696e 653a 206d 6172 6b65 7220  et_line: marker 
+0000dd80: 666f 756e 6420 6174 2070 6978 656c 2025  found at pixel %
+0000dd90: 6422 2c20 6929 0d0a 0d0a 2020 2020 2020  d", i)....      
+0000dda0: 2020 2320 636f 6e73 6964 6572 2073 6b69    # consider ski
+0000ddb0: 7070 696e 6720 6d75 6368 206f 6620 7468  pping much of th
+0000ddc0: 6520 666f 6c6c 6f77 696e 6720 6966 2069  e following if i
+0000ddd0: 6e20 6172 6561 2073 6361 6e20 6d6f 6465  n area scan mode
+0000dde0: 0d0a 0d0a 2020 2020 2020 2020 2323 2323  ....        ####
+0000ddf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000de00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000de10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000de20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000de30: 2323 2323 0d0a 2020 2020 2020 2020 2320  ####..        # 
+0000de40: 5374 6f6d 7020 6172 7261 7920 656e 6473  Stomp array ends
+0000de50: 0d0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
+0000de60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000de70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000de80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000de90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000dea0: 2323 0d0a 0d0a 2020 2020 2020 2020 2320  ##....        # 
+0000deb0: 2862 6566 6f72 6520 782d 6178 6973 2069  (before x-axis i
+0000dec0: 6e76 6572 7369 6f6e 2062 6563 6175 7365  nversion because
+0000ded0: 206f 7074 6963 616c 6c79 206d 6173 6b65   optically maske
+0000dee0: 6420 7069 7865 6c73 2061 7265 2070 6879  d pixels are phy
+0000def0: 7369 6361 6c29 0d0a 0d0a 2020 2020 2020  sical)....      
+0000df00: 2020 2320 736f 6d65 2064 6574 6563 746f    # some detecto
+0000df10: 7273 2068 6176 6520 2267 6172 6261 6765  rs have "garbage
+0000df20: 2220 7069 7865 6c73 2061 7420 7468 6520  " pixels at the 
+0000df30: 6672 6f6e 7420 6f72 2065 6e64 206f 6620  front or end of 
+0000df40: 6576 6572 790d 0a20 2020 2020 2020 2023  every..        #
+0000df50: 2073 7065 6374 7275 6d20 2873 796e 6320   spectrum (sync 
+0000df60: 6279 7465 7320 616e 6420 7768 6174 2d6e  bytes and what-n
+0000df70: 6f74 290d 0a20 2020 2020 2020 2069 6620  ot)..        if 
+0000df80: 7365 6c66 2e73 6574 7469 6e67 732e 6973  self.settings.is
+0000df90: 5f6d 6963 726f 2829 2061 6e64 2073 656c  _micro() and sel
+0000dfa0: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
+0000dfb0: 2e64 6574 6563 746f 725f 7265 6769 6f6e  .detector_region
+0000dfc0: 7320 6973 204e 6f6e 653a 0d0a 2020 2020  s is None:..    
+0000dfd0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000dfe0: 7365 7474 696e 6773 2e69 735f 696d 7833  settings.is_imx3
+0000dff0: 3932 2829 3a0d 0a20 2020 2020 2020 2020  92():..         
+0000e000: 2020 2020 2020 2075 7469 6c73 2e73 746f         utils.sto
+0000e010: 6d70 5f66 6972 7374 2873 7065 6374 7275  mp_first(spectru
+0000e020: 6d2c 2033 290d 0a20 2020 2020 2020 2020  m, 3)..         
+0000e030: 2020 2020 2020 2075 7469 6c73 2e73 746f         utils.sto
+0000e040: 6d70 5f6c 6173 7420 2873 7065 6374 7275  mp_last (spectru
+0000e050: 6d2c 2031 3729 0d0a 2020 2020 2020 2020  m, 17)..        
+0000e060: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+0000e070: 2020 2020 2020 2020 2020 2023 2070 7265             # pre
+0000e080: 7375 6d61 626c 7920 494d 5833 3835 0d0a  sumably IMX385..
+0000e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0a0: 7574 696c 732e 7374 6f6d 705f 6669 7273  utils.stomp_firs
+0000e0b0: 7428 7370 6563 7472 756d 2c20 3329 0d0a  t(spectrum, 3)..
+0000e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0d0: 7574 696c 732e 7374 6f6d 705f 6c61 7374  utils.stomp_last
+0000e0e0: 2028 7370 6563 7472 756d 2c20 3129 0d0a   (spectrum, 1)..
+0000e0f0: 0d0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
 0000e100: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000e110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000e120: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e130: 2323 2323 2323 0a0a 2020 2020 2020 2020  ######..        
-0000e140: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
-0000e150: 2e73 7461 7465 2e62 6164 5f70 6978 656c  .state.bad_pixel
-0000e160: 5f6d 6f64 6520 3d3d 2053 7065 6374 726f  _mode == Spectro
-0000e170: 6d65 7465 7253 7461 7465 2e42 4144 5f50  meterState.BAD_P
-0000e180: 4958 454c 5f4d 4f44 455f 4156 4552 4147  IXEL_MODE_AVERAG
-0000e190: 453a 0a20 2020 2020 2020 2020 2020 2073  E:.            s
-0000e1a0: 656c 662e 5f63 6f72 7265 6374 5f62 6164  elf._correct_bad
-0000e1b0: 5f70 6978 656c 7328 7370 6563 7472 756d  _pixels(spectrum
-0000e1c0: 290a 0a20 2020 2020 2020 2023 2323 2323  )..        #####
-0000e1d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e1e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e1f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e210: 2323 230a 2020 2020 2020 2020 2320 5377  ###.        # Sw
-0000e220: 6170 2041 6c74 6572 6e61 7469 6e67 2050  ap Alternating P
-0000e230: 6978 656c 7320 2876 6572 7920 7261 7265  ixels (very rare
-0000e240: 290a 2020 2020 2020 2020 2323 2323 2323  ).        ######
-0000e250: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e260: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e270: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e280: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e290: 2323 0a0a 2020 2020 2020 2020 2320 6120  ##..        # a 
-0000e2a0: 7072 6f74 6f74 7970 6520 6d6f 6465 6c20  prototype model 
-0000e2b0: 6f75 7470 7574 2073 7065 6374 7261 2077  output spectra w
-0000e2c0: 6974 6820 616c 7465 726e 6174 696e 6720  ith alternating 
-0000e2d0: 7069 7865 6c73 2073 7761 7070 6564 2c20  pixels swapped, 
-0000e2e0: 616e 640a 2020 2020 2020 2020 2320 7468  and.        # th
-0000e2f0: 6973 2077 6173 2071 7569 636b 6572 2074  is was quicker t
-0000e300: 6861 6e20 6368 616e 6769 6e67 2069 6e20  han changing in 
-0000e310: 6669 726d 7761 7265 0a0a 2020 2020 2020  firmware..      
-0000e320: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
-0000e330: 6773 2e73 7461 7465 2e73 7761 705f 616c  gs.state.swap_al
-0000e340: 7465 726e 6174 696e 675f 7069 7865 6c73  ternating_pixels
-0000e350: 2061 6e64 2073 656c 662e 7365 7474 696e   and self.settin
-0000e360: 6773 2e73 7461 7465 2e64 6574 6563 746f  gs.state.detecto
-0000e370: 725f 7265 6769 6f6e 7320 6973 204e 6f6e  r_regions is Non
-0000e380: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-0000e390: 6f67 2e64 6562 7567 2822 7377 6170 7069  og.debug("swappi
-0000e3a0: 6e67 2061 6c74 6572 6e61 7469 6e67 2070  ng alternating p
-0000e3b0: 6978 656c 733a 2073 7065 6374 7275 6d20  ixels: spectrum 
-0000e3c0: 3d20 2573 222c 2073 7065 6374 7275 6d5b  = %s", spectrum[
-0000e3d0: 3a31 305d 290a 2020 2020 2020 2020 2020  :10]).          
-0000e3e0: 2020 636f 7272 6563 7465 6420 3d20 5b5d    corrected = []
-0000e3f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000e400: 2061 2c20 6220 696e 207a 6970 2873 7065   a, b in zip(spe
-0000e410: 6374 7275 6d5b 303a 3a32 5d2c 2073 7065  ctrum[0::2], spe
-0000e420: 6374 7275 6d5b 313a 3a32 5d29 3a0a 2020  ctrum[1::2]):.  
-0000e430: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000e440: 7272 6563 7465 642e 6578 7465 6e64 285b  rrected.extend([
-0000e450: 622c 2061 5d29 0a20 2020 2020 2020 2020  b, a]).         
-0000e460: 2020 2073 7065 6374 7275 6d20 3d20 636f     spectrum = co
-0000e470: 7272 6563 7465 640a 2020 2020 2020 2020  rrected.        
-0000e480: 2020 2020 6c6f 672e 6465 6275 6728 2273      log.debug("s
-0000e490: 7761 7070 6564 2061 6c74 6572 6e61 7469  wapped alternati
-0000e4a0: 6e67 2070 6978 656c 733a 2073 7065 6374  ng pixels: spect
-0000e4b0: 7275 6d20 3d20 2573 222c 2073 7065 6374  rum = %s", spect
-0000e4c0: 7275 6d5b 3a31 305d 290a 0a20 2020 2020  rum[:10])..     
-0000e4d0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-0000e4e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e4f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e510: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-0000e520: 2020 2020 2320 3278 3220 6269 6e6e 696e      # 2x2 binnin
-0000e530: 670a 2020 2020 2020 2020 2323 2323 2323  g.        ######
-0000e540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e560: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e580: 2323 0a0a 2020 2020 2020 2020 2320 6170  ##..        # ap
-0000e590: 706c 7920 736f 2d63 616c 6c65 6420 2232  ply so-called "2
-0000e5a0: 7832 2070 6978 656c 2062 696e 6e69 6e67  x2 pixel binning
-0000e5b0: 2220 0a20 2020 2020 2020 2073 7065 6374  " .        spect
-0000e5c0: 7275 6d20 3d20 7365 6c66 2e5f 6170 706c  rum = self._appl
-0000e5d0: 795f 3278 325f 6269 6e6e 696e 6728 7370  y_2x2_binning(sp
-0000e5e0: 6563 7472 756d 290a 0a20 2020 2020 2020  ectrum)..       
-0000e5f0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+0000e130: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e140: 2323 0d0a 2020 2020 2020 2020 2320 496e  ##..        # In
+0000e150: 7665 7274 2058 2d41 7869 730d 0a20 2020  vert X-Axis..   
+0000e160: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+0000e170: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e180: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e190: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e1a0: 2323 2323 2323 2323 2323 2323 230d 0a0d  #############...
+0000e1b0: 0a20 2020 2020 2020 2023 2046 6f72 2062  .        # For b
+0000e1c0: 656e 6368 6573 2077 6865 7265 2074 6865  enches where the
+0000e1d0: 2064 6574 6563 746f 7220 6973 2065 7373   detector is ess
+0000e1e0: 656e 7469 616c 6c79 2072 6f74 6174 6564  entially rotated
+0000e1f0: 2031 3830 2d64 6567 2066 726f 6d20 6f75   180-deg from ou
+0000e200: 720d 0a20 2020 2020 2020 2023 2074 7970  r..        # typ
+0000e210: 6963 616c 206f 7269 656e 7461 7469 6f6e  ical orientation
+0000e220: 2077 6974 6820 7265 6761 7264 2074 6f20   with regard to 
+0000e230: 7468 6520 6772 6174 696e 6720 2865 2e67  the grating (e.g
+0000e240: 2e20 496e 4761 4173 204f 454d 0d0a 2020  . InGaAs OEM..  
+0000e250: 2020 2020 2020 2320 6265 6e63 6865 732c        # benches,
+0000e260: 2077 6865 7265 2072 6564 2077 6176 656c   where red wavel
+0000e270: 656e 6774 6873 2061 7265 2064 6966 6672  engths are diffr
+0000e280: 6163 7465 6420 746f 7761 7264 2070 6978  acted toward pix
+0000e290: 656c 2030 2c20 616e 6420 626c 7565 0d0a  el 0, and blue..
+0000e2a0: 2020 2020 2020 2020 2320 7761 7665 6c65          # wavele
+0000e2b0: 6e67 7468 7320 746f 7761 7264 2070 6978  ngths toward pix
+0000e2c0: 656c 2035 3131 292e 0d0a 2020 2020 2020  el 511)...      
+0000e2d0: 2020 230d 0a20 2020 2020 2020 2023 204e    #..        # N
+0000e2e0: 6f74 6520 7468 6973 2073 696d 706c 7920  ote this simply 
+0000e2f0: 7065 7266 6f72 6d73 2061 2068 6f72 697a  performs a horiz
+0000e300: 6f6e 7461 6c20 464c 4950 2028 6d69 7272  ontal FLIP (mirr
+0000e310: 6f72 2920 6f66 2074 6865 2076 6572 7469  or) of the verti
+0000e320: 6361 6c6c 792d 0d0a 2020 2020 2020 2020  cally-..        
+0000e330: 2320 6269 6e6e 6564 2031 2d44 2073 7065  # binned 1-D spe
+0000e340: 6374 7261 2c20 616e 6420 6973 204e 4f54  ctra, and is NOT
+0000e350: 2073 7566 6669 6369 656e 7420 746f 2070   sufficient to p
+0000e360: 6572 666f 726d 2061 2067 656e 7569 6e65  erform a genuine
+0000e370: 2031 3830 2d0d 0a20 2020 2020 2020 2023   180-..        #
+0000e380: 2064 6567 7265 6520 726f 7461 7469 6f6e   degree rotation
+0000e390: 206f 6620 322d 4420 696d 6167 696e 6720   of 2-D imaging 
+0000e3a0: 6d6f 6465 3b20 6966 2022 6175 7468 656e  mode; if "authen
+0000e3b0: 7469 6322 2061 7265 6120 7363 616e 2069  tic" area scan i
+0000e3c0: 730d 0a20 2020 2020 2020 2023 2064 6573  s..        # des
+0000e3d0: 6972 6564 2c20 7468 6520 6361 6c6c 6572  ired, the caller
+0000e3e0: 2077 6f75 6c64 206c 696b 6577 6973 6520   would likewise 
+0000e3f0: 6e65 6564 2074 6f20 7265 7665 7273 6520  need to reverse 
+0000e400: 7468 6520 6469 7370 6c61 7920 6f72 6465  the display orde
+0000e410: 7220 6f66 0d0a 2020 2020 2020 2020 2320  r of..        # 
+0000e420: 7468 6520 726f 7773 2e0d 0a20 2020 2020  the rows...     
+0000e430: 2020 2023 0d0a 2020 2020 2020 2020 2320     #..        # 
+0000e440: 2020 2020 2020 2020 2020 4974 2069 7320            It is 
+0000e450: 5649 5441 4c4c 5920 494d 504f 5254 414e  VITALLY IMPORTAN
+0000e460: 5420 7468 6174 2061 6c6c 2064 7269 7665  T that all drive
+0000e470: 7273 2061 6772 6565 0d0a 2020 2020 2020  rs agree..      
+0000e480: 2020 2320 2020 2020 2020 2020 2020 206f    #            o
+0000e490: 6e20 7768 656e 2074 6f20 7065 7266 6f72  n when to perfor
+0000e4a0: 6d20 582d 4178 6973 2069 6e76 6572 7369  m X-Axis inversi
+0000e4b0: 6f6e 2069 6e20 7468 650d 0a20 2020 2020  on in the..     
+0000e4c0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+0000e4d0: 2020 2020 2020 2020 2020 2020 4f72 6465              Orde
+0000e4e0: 7220 6f66 204f 7065 7261 7469 6f6e 732e  r of Operations.
+0000e4f0: 0d0a 2020 2020 2020 2020 230d 0a20 2020  ..        #..   
+0000e500: 2020 2020 2069 6620 7365 6c66 2e73 6574       if self.set
+0000e510: 7469 6e67 732e 6565 7072 6f6d 2e69 6e76  tings.eeprom.inv
+0000e520: 6572 745f 785f 6178 6973 2061 6e64 206e  ert_x_axis and n
+0000e530: 6f74 2073 656c 662e 7365 7474 696e 6773  ot self.settings
+0000e540: 2e73 7461 7465 2e61 7265 615f 7363 616e  .state.area_scan
+0000e550: 5f65 6e61 626c 6564 3a0d 0a20 2020 2020  _enabled:..     
+0000e560: 2020 2020 2020 2073 7065 6374 7275 6d2e         spectrum.
+0000e570: 7265 7665 7273 6528 290d 0a0d 0a20 2020  reverse()....   
+0000e580: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+0000e590: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e5a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e5b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e5c0: 2323 2323 2323 2323 2323 2323 230d 0a20  #############.. 
+0000e5d0: 2020 2020 2020 2023 2042 6164 2050 6978         # Bad Pix
+0000e5e0: 656c 2043 6f72 7265 6374 696f 6e0d 0a20  el Correction.. 
+0000e5f0: 2020 2020 2020 2023 2323 2323 2323 2323         #########
 0000e600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000e610: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000e620: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e630: 2323 2323 2323 2323 230a 2020 2020 2020  #########.      
-0000e640: 2020 2320 4772 6170 6820 416c 7465 726e    # Graph Altern
-0000e650: 6174 696e 6720 5069 7865 6c73 0a20 2020  ating Pixels.   
-0000e660: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
-0000e670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e680: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e6a0: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
-0000e6b0: 2020 2020 2020 2023 2057 6865 6e20 696e         # When in
-0000e6c0: 7465 6772 6174 696e 6720 6e65 7720 7365  tegrating new se
-0000e6d0: 6e73 6f72 732c 206f 7220 7465 7374 696e  nsors, or testin
-0000e6e0: 6720 2269 6e74 6572 6c65 6176 6564 2220  g "interleaved" 
-0000e6f0: 6465 7465 6374 6f72 7320 6c69 6b65 0a20  detectors like. 
-0000e700: 2020 2020 2020 2023 2074 6865 2049 6e47         # the InG
-0000e710: 6141 732c 2073 6f6d 6574 696d 6573 2077  aAs, sometimes w
-0000e720: 6520 7761 6e74 2074 6f20 6f6e 6c79 206c  e want to only l
-0000e730: 6f6f 6b20 6174 2022 6576 6572 7920 6f74  ook at "every ot
-0000e740: 6865 7222 2070 6978 656c 2074 6f0a 2020  her" pixel to.  
-0000e750: 2020 2020 2020 2320 666c 6174 7465 6e2d        # flatten-
-0000e760: 6f75 7420 6972 7265 6775 6c61 7269 7469  out irregulariti
-0000e770: 6573 2069 6e20 4261 7965 7220 6669 6c74  es in Bayer filt
-0000e780: 6572 7320 6f72 2070 686f 746f 6469 6f64  ers or photodiod
-0000e790: 6520 6172 7261 7973 2e0a 2020 2020 2020  e arrays..      
-0000e7a0: 2020 2320 486f 7765 7665 722c 2077 6520    # However, we 
-0000e7b0: 646f 6e27 7420 7761 6e74 2074 6f20 6469  don't want to di
-0000e7c0: 7372 7570 7420 7468 6520 6578 7065 6374  srupt the expect
-0000e7d0: 6564 2070 6978 656c 2d63 6f75 6e74 2c20  ed pixel-count, 
-0000e7e0: 736f 206a 7573 740a 2020 2020 2020 2020  so just.        
-0000e7f0: 2320 6176 6572 6167 652d 6f76 6572 2074  # average-over t
-0000e800: 6865 2073 6b69 7070 6564 2070 6978 656c  he skipped pixel
-0000e810: 732e 0a20 2020 2020 2020 2023 0a20 2020  s..        #.   
-0000e820: 2020 2020 2023 204e 6f74 2069 6d70 6f72       # Not impor
-0000e830: 7461 6e74 2065 6e6f 7567 6820 746f 2075  tant enough to u
-0000e840: 7064 6174 6520 666f 7220 4465 7465 6374  pdate for Detect
-0000e850: 6f72 5265 6769 6f6e 730a 2020 2020 2020  orRegions.      
-0000e860: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
-0000e870: 6773 2e73 7461 7465 2e67 7261 7068 5f61  gs.state.graph_a
-0000e880: 6c74 6572 6e61 7469 6e67 5f70 6978 656c  lternating_pixel
-0000e890: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
-0000e8a0: 6f67 2e64 6562 7567 2822 6170 706c 7969  og.debug("applyi
-0000e8b0: 6e67 2067 7261 7068 5f61 6c74 6572 6e61  ng graph_alterna
-0000e8c0: 7469 6e67 5f70 6978 656c 7322 290a 2020  ting_pixels").  
-0000e8d0: 2020 2020 2020 2020 2020 736d 6f6f 7468            smooth
-0000e8e0: 6564 203d 205b 5d0a 2020 2020 2020 2020  ed = [].        
-0000e8f0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0000e900: 6765 286c 656e 2873 7065 6374 7275 6d29  ge(len(spectrum)
-0000e910: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000e920: 2020 2069 6620 6920 2520 3220 3d3d 2030     if i % 2 == 0
-0000e930: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e940: 2020 2020 2020 736d 6f6f 7468 6564 2e61        smoothed.a
-0000e950: 7070 656e 6428 7370 6563 7472 756d 5b69  ppend(spectrum[i
-0000e960: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-0000e970: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000e980: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000e990: 6920 2b20 3120 3c20 6c65 6e28 7370 6563  i + 1 < len(spec
-0000e9a0: 7472 756d 293a 0a20 2020 2020 2020 2020  trum):.         
-0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000e9c0: 7665 7261 6765 6420 3d20 2873 7065 6374  veraged = (spect
-0000e9d0: 7275 6d5b 692d 315d 202b 2073 7065 6374  rum[i-1] + spect
-0000e9e0: 7275 6d5b 692b 315d 2920 2f20 322e 300a  rum[i+1]) / 2.0.
-0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea20: 2020 6176 6572 6167 6564 203d 2073 7065    averaged = spe
-0000ea30: 6374 7275 6d5b 6920 2d20 315d 0a20 2020  ctrum[i - 1].   
-0000ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea50: 2073 6d6f 6f74 6865 642e 6170 7065 6e64   smoothed.append
-0000ea60: 2861 7665 7261 6765 6429 0a20 2020 2020  (averaged).     
-0000ea70: 2020 2020 2020 2073 7065 6374 7275 6d20         spectrum 
-0000ea80: 3d20 736d 6f6f 7468 6564 0a0a 2020 2020  = smoothed..    
-0000ea90: 2020 2020 2320 536f 6d65 7768 6174 206f      # Somewhat o
-0000eaa0: 6464 6c79 2c20 7765 2772 6520 6375 7272  ddly, we're curr
-0000eab0: 656e 746c 7920 7265 7475 726e 696e 6720  ently returning 
-0000eac0: 6120 5455 504c 4520 6f66 2074 6865 2073  a TUPLE of the s
-0000ead0: 7065 6374 7275 6d20 616e 640a 2020 2020  pectrum and.    
-0000eae0: 2020 2020 2320 7468 6520 6172 6561 2073      # the area s
-0000eaf0: 6361 6e20 726f 7720 636f 756e 742e 2020  can row count.  
-0000eb00: 5768 656e 2022 4661 7374 2220 4172 6561  When "Fast" Area
-0000eb10: 2053 6361 6e20 6973 206d 6f72 6520 636f   Scan is more co
-0000eb20: 6d6d 6f6e 706c 6163 6520 0a20 2020 2020  mmonplace .     
-0000eb30: 2020 2023 2077 6527 6c6c 2063 6861 6e67     # we'll chang
-0000eb40: 6520 7468 6973 2062 6163 6b20 746f 206a  e this back to j
-0000eb50: 7573 7420 7265 7475 726e 696e 6720 7468  ust returning th
-0000eb60: 6520 7370 6563 7472 756d 2061 7272 6179  e spectrum array
-0000eb70: 2064 6972 6563 746c 792e 0a20 2020 2020   directly..     
-0000eb80: 2020 2072 6573 706f 6e73 652e 6461 7461     response.data
-0000eb90: 203d 2053 7065 6374 7275 6d41 6e64 526f   = SpectrumAndRo
-0000eba0: 7728 7370 6563 7472 756d 2c20 6172 6561  w(spectrum, area
-0000ebb0: 5f73 6361 6e5f 726f 775f 636f 756e 7429  _scan_row_count)
-0000ebc0: 200a 2020 2020 2020 2020 7265 7475 726e   .        return
-0000ebd0: 2072 6573 706f 6e73 650a 0a20 2020 2064   response..    d
-0000ebe0: 6566 2073 6574 5f69 6e74 6567 7261 7469  ef set_integrati
-0000ebf0: 6f6e 5f74 696d 655f 6d73 2873 656c 662c  on_time_ms(self,
-0000ec00: 206d 733a 2066 6c6f 6174 2920 2d3e 2053   ms: float) -> S
-0000ec10: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0000ec20: 6e73 653a 0a20 2020 2020 2020 2022 2222  nse:.        """
-0000ec30: 0a20 2020 2020 2020 2053 656e 6420 7468  .        Send th
-0000ec40: 6520 7570 6461 7465 6420 696e 7465 6772  e updated integr
-0000ec50: 6174 696f 6e20 7469 6d65 2069 6e20 6120  ation time in a 
-0000ec60: 636f 6e74 726f 6c20 6d65 7373 6167 6520  control message 
-0000ec70: 746f 2074 6865 2064 6576 6963 650a 2020  to the device.  
-0000ec80: 2020 2020 2020 4077 6172 6e69 6e67 2064        @warning d
-0000ec90: 6973 6162 6c65 6420 4545 5052 4f4d 2072  isabled EEPROM r
-0000eca0: 616e 6765 2d63 6865 636b 696e 6720 6279  ange-checking by
-0000ecb0: 2063 7573 746f 6d65 720a 2020 2020 2020   customer.      
-0000ecc0: 2020 2020 2020 2072 6571 7565 7374 3b20         request; 
-0000ecd0: 7261 6e67 6520 6c69 6d69 7473 2069 6e20  range limits in 
-0000ece0: 4545 5052 4f4d 2061 7265 2064 6566 696e  EEPROM are defin
-0000ecf0: 6564 2061 7320 3136 2d62 6974 0a20 2020  ed as 16-bit.   
-0000ed00: 2020 2020 2020 2020 2020 7661 6c75 6573            values
-0000ed10: 2c20 7768 696c 6520 696e 7465 6772 6174  , while integrat
-0000ed20: 696f 6e20 7469 6d65 2069 7320 6163 7475  ion time is actu
-0000ed30: 616c 6c79 2061 2032 342d 6269 7420 7661  ally a 24-bit va
-0000ed40: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-0000ed50: 2020 7375 6368 2074 6861 7420 7468 6520    such that the 
-0000ed60: 4545 5052 4f4d 2069 7320 6172 7469 6669  EEPROM is artifi
-0000ed70: 6369 616c 6c79 206c 696d 6974 696e 6720  cially limiting 
-0000ed80: 6f75 7220 7261 6e67 652e 0a20 2020 2020  our range..     
-0000ed90: 2020 2022 2222 0a20 2020 2020 2020 206d     """.        m
-0000eda0: 7320 3d20 6d61 7828 312c 2069 6e74 2872  s = max(1, int(r
-0000edb0: 6f75 6e64 286d 7329 2929 0a0a 2020 2020  ound(ms)))..    
-0000edc0: 2020 2020 6c73 7720 3d20 206d 7320 2020      lsw =  ms   
-0000edd0: 2020 2020 2026 2030 7866 6666 660a 2020       & 0xffff.  
-0000ede0: 2020 2020 2020 6d73 7720 3d20 286d 7320        msw = (ms 
-0000edf0: 3e3e 2031 3629 2026 2030 7830 3066 660a  >> 16) & 0x00ff.
-0000ee00: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-0000ee10: 3d20 7365 6c66 2e5f 7365 6e64 5f63 6f64  = self._send_cod
-0000ee20: 6528 3078 4232 2c20 6c73 772c 206d 7377  e(0xB2, lsw, msw
-0000ee30: 2c20 6c61 6265 6c3d 2253 4554 5f49 4e54  , label="SET_INT
-0000ee40: 4547 5241 5449 4f4e 5f54 494d 455f 4d53  EGRATION_TIME_MS
-0000ee50: 2229 0a20 2020 2020 2020 206c 6f67 2e64  ").        log.d
-0000ee60: 6562 7567 2822 5345 545f 494e 5445 4752  ebug("SET_INTEGR
-0000ee70: 4154 494f 4e5f 5449 4d45 5f4d 533a 206e  ATION_TIME_MS: n
-0000ee80: 6f77 2025 6422 2c20 6d73 290a 2020 2020  ow %d", ms).    
-0000ee90: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
-0000eea0: 732e 7374 6174 652e 696e 7465 6772 6174  s.state.integrat
-0000eeb0: 696f 6e5f 7469 6d65 5f6d 7320 3d20 6d73  ion_time_ms = ms
-0000eec0: 0a0a 2020 2020 2020 2020 2320 636f 6e73  ..        # cons
-0000eed0: 6369 6f75 736c 7920 6275 7420 6361 7574  ciously but caut
-0000eee0: 696f 7573 6c79 2064 6973 6162 6c69 6e67  iously disabling
-0000eef0: 2074 6869 7320 6675 6e63 7469 6f6e 616c   this functional
-0000ef00: 6974 790a 2020 2020 2020 2020 2320 6966  ity.        # if
-0000ef10: 2073 656c 662e 7365 7474 696e 6773 2e69   self.settings.i
-0000ef20: 735f 6d69 6372 6f28 293a 0a20 2020 2020  s_micro():.     
-0000ef30: 2020 2023 2020 2020 2073 656c 662e 7570     #     self.up
-0000ef40: 6461 7465 5f6c 6173 6572 5f77 6174 6368  date_laser_watch
-0000ef50: 646f 6728 293b 0a0a 2020 2020 2020 2020  dog();..        
-0000ef60: 7265 7475 726e 2072 6573 756c 740a 0a20  return result.. 
-0000ef70: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
-0000ef80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ef90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000efa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000efb0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0000efc0: 2020 2020 2320 5465 6d70 6572 6174 7572      # Temperatur
-0000efd0: 650a 2020 2020 2320 2323 2323 2323 2323  e.    # ########
-0000efe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000eff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000f000: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000f010: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000f020: 2323 0a0a 2020 2020 6465 6620 7365 6c65  ##..    def sele
-0000f030: 6374 5f61 6463 2873 656c 662c 206e 3a20  ct_adc(self, n: 
-0000f040: 696e 7429 202d 3e20 5370 6563 7472 6f6d  int) -> Spectrom
-0000f050: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-0000f060: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-0000f070: 2273 656c 6563 745f 6164 6320 2d3e 2025  "select_adc -> %
-0000f080: 6422 2c20 6e29 0a20 2020 2020 2020 2073  d", n).        s
-0000f090: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
-0000f0a0: 7465 2e73 656c 6563 7465 645f 6164 6320  te.selected_adc 
-0000f0b0: 3d20 6e0a 2020 2020 2020 2020 7265 7375  = n.        resu
-0000f0c0: 6c74 203d 2073 656c 662e 5f73 656e 645f  lt = self._send_
-0000f0d0: 636f 6465 2830 7865 642c 206e 2c20 6c61  code(0xed, n, la
-0000f0e0: 6265 6c3d 2253 454c 4543 545f 4144 4322  bel="SELECT_ADC"
-0000f0f0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-0000f100: 6765 745f 636f 6465 2830 7864 352c 2077  get_code(0xd5, w
-0000f110: 4c65 6e67 7468 3d32 2c20 6c61 6265 6c3d  Length=2, label=
-0000f120: 2247 4554 5f41 4443 2028 7468 726f 7761  "GET_ADC (throwa
-0000f130: 7761 7929 2229 2023 2073 7461 6269 6c69  way)") # stabili
-0000f140: 7a61 7469 6f6e 2072 6561 640a 2020 2020  zation read.    
-0000f150: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0000f160: 740a 0a20 2020 2064 6566 2067 6574 5f73  t..    def get_s
-0000f170: 6563 6f6e 6461 7279 5f61 6463 5f63 616c  econdary_adc_cal
-0000f180: 6962 7261 7465 6428 7365 6c66 2c20 7261  ibrated(self, ra
-0000f190: 773a 2066 6c6f 6174 203d 204e 6f6e 6529  w: float = None)
-0000f1a0: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
-0000f1b0: 5265 7370 6f6e 7365 3a0a 2020 2020 2020  Response:.      
-0000f1c0: 2020 7265 7370 6f6e 7365 203d 2053 7065    response = Spe
-0000f1d0: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-0000f1e0: 6528 290a 2020 2020 2020 2020 6966 206e  e().        if n
-0000f1f0: 6f74 2073 656c 662e 6861 735f 6c69 6e65  ot self.has_line
-0000f200: 6172 6974 795f 636f 6566 6673 2829 3a0a  arity_coeffs():.
-0000f210: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
-0000f220: 6465 6275 6728 2273 6563 6f6e 6461 7279  debug("secondary
-0000f230: 5f61 6463 5f63 616c 6962 7261 7465 643a  _adc_calibrated:
-0000f240: 206e 6f20 6361 6c69 6272 6174 696f 6e22   no calibration"
-0000f250: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0000f260: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
-0000f270: 7252 6573 706f 6e73 6528 6461 7461 3d4e  rResponse(data=N
-0000f280: 6f6e 652c 2065 7272 6f72 5f6c 766c 3d45  one, error_lvl=E
-0000f290: 7272 6f72 4c65 7665 6c2e 6c6f 772c 2065  rrorLevel.low, e
-0000f2a0: 7272 6f72 5f6d 7367 3d22 7365 636f 6e64  rror_msg="second
-0000f2b0: 6172 795f 6164 635f 6361 6c69 6272 6174  ary_adc_calibrat
-0000f2c0: 6564 3a20 6e6f 2063 616c 6962 7261 7469  ed: no calibrati
-0000f2d0: 6f6e 2229 0a0a 2020 2020 2020 2020 6966  on")..        if
-0000f2e0: 2072 6177 2069 7320 4e6f 6e65 3a0a 2020   raw is None:.  
-0000f2f0: 2020 2020 2020 2020 2020 7261 775f 7265            raw_re
-0000f300: 7320 3d20 7365 6c66 2e67 6574 5f73 6563  s = self.get_sec
-0000f310: 6f6e 6461 7279 5f61 6463 5f72 6177 2829  ondary_adc_raw()
-0000f320: 0a20 2020 2020 2020 2069 6620 7261 775f  .        if raw_
-0000f330: 7265 732e 6461 7461 2069 7320 4e6f 6e65  res.data is None
-0000f340: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000f350: 7475 726e 2072 6177 5f72 6573 0a0a 2020  turn raw_res..  
-0000f360: 2020 2020 2020 7261 7720 3d20 666c 6f61        raw = floa
-0000f370: 7428 7261 775f 7265 732e 6461 7461 290a  t(raw_res.data).
-0000f380: 0a20 2020 2020 2020 2023 2075 7365 2074  .        # use t
-0000f390: 6865 2066 6972 7374 2034 206c 696e 6561  he first 4 linea
-0000f3a0: 7269 7479 2063 6f65 6666 6963 6965 6e74  rity coefficient
-0000f3b0: 7320 6173 2061 2033 7264 2d6f 7264 6572  s as a 3rd-order
-0000f3c0: 2070 6f6c 796e 6f6d 6961 6c0a 2020 2020   polynomial.    
-0000f3d0: 2020 2020 6361 6c69 6272 6174 6564 203d      calibrated =
-0000f3e0: 2066 6c6f 6174 2873 656c 662e 7365 7474   float(self.sett
-0000f3f0: 696e 6773 2e65 6570 726f 6d2e 6c69 6e65  ings.eeprom.line
-0000f400: 6172 6974 795f 636f 6566 6673 5b30 5d29  arity_coeffs[0])
-0000f410: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-0000f420: 2020 2020 2020 2b20 666c 6f61 7428 7365        + float(se
-0000f430: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-0000f440: 6f6d 2e6c 696e 6561 7269 7479 5f63 6f65  om.linearity_coe
-0000f450: 6666 735b 315d 2920 2a20 7261 7720 5c0a  ffs[1]) * raw \.
-0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f470: 2020 202b 2066 6c6f 6174 2873 656c 662e     + float(self.
-0000f480: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
-0000f490: 6c69 6e65 6172 6974 795f 636f 6566 6673  linearity_coeffs
-0000f4a0: 5b32 5d29 202a 2072 6177 202a 2072 6177  [2]) * raw * raw
-0000f4b0: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-0000f4c0: 2020 2020 2020 2b20 666c 6f61 7428 7365        + float(se
-0000f4d0: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-0000f4e0: 6f6d 2e6c 696e 6561 7269 7479 5f63 6f65  om.linearity_coe
-0000f4f0: 6666 735b 335d 2920 2a20 7261 7720 2a20  ffs[3]) * raw * 
-0000f500: 7261 7720 2a20 7261 770a 2020 2020 2020  raw * raw.      
-0000f510: 2020 6c6f 672e 6465 6275 6728 2273 6563    log.debug("sec
-0000f520: 6f6e 6461 7279 5f61 6463 5f63 616c 6962  ondary_adc_calib
-0000f530: 7261 7465 643a 2025 6622 2c20 6361 6c69  rated: %f", cali
-0000f540: 6272 6174 6564 290a 2020 2020 2020 2020  brated).        
-0000f550: 7265 7370 6f6e 7365 2e74 7261 6e73 6665  response.transfe
-0000f560: 725f 7265 7370 6f6e 7365 2872 6177 5f72  r_response(raw_r
-0000f570: 6573 290a 2020 2020 2020 2020 7265 7370  es).        resp
-0000f580: 6f6e 7365 2e64 6174 6120 3d20 6361 6c69  onse.data = cali
-0000f590: 6272 6174 6564 0a20 2020 2020 2020 2072  brated.        r
-0000f5a0: 6574 7572 6e20 7265 7370 6f6e 7365 0a0a  eturn response..
-0000f5b0: 2020 2020 6465 6620 6765 745f 7365 636f      def get_seco
-0000f5c0: 6e64 6172 795f 6164 635f 7261 7728 7365  ndary_adc_raw(se
-0000f5d0: 6c66 2920 2d3e 2053 7065 6374 726f 6d65  lf) -> Spectrome
-0000f5e0: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-0000f5f0: 2020 2020 2023 2066 6c69 7020 746f 2073       # flip to s
-0000f600: 6563 6f6e 6461 7279 2041 4443 2069 6620  econdary ADC if 
-0000f610: 6e65 6564 6564 0a20 2020 2020 2020 2069  needed.        i
-0000f620: 6620 7365 6c66 2e73 6574 7469 6e67 732e  f self.settings.
-0000f630: 7374 6174 652e 7365 6c65 6374 6564 5f61  state.selected_a
-0000f640: 6463 2069 7320 4e6f 6e65 206f 7220 7365  dc is None or se
-0000f650: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
-0000f660: 652e 7365 6c65 6374 6564 5f61 6463 2021  e.selected_adc !
-0000f670: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-0000f680: 2073 656c 662e 7365 6c65 6374 5f61 6463   self.select_adc
-0000f690: 2831 290a 0a20 2020 2020 2020 2076 616c  (1)..        val
-0000f6a0: 7565 203d 2073 656c 662e 5f67 6574 5f63  ue = self._get_c
-0000f6b0: 6f64 6528 3078 6435 2c20 774c 656e 6774  ode(0xd5, wLengt
-0000f6c0: 683d 322c 206c 6162 656c 3d22 4745 545f  h=2, label="GET_
-0000f6d0: 4144 4322 2c20 6c73 625f 6c65 6e3d 3229  ADC", lsb_len=2)
-0000f6e0: 2026 2030 7866 6666 0a20 2020 2020 2020   & 0xfff.       
-0000f6f0: 206c 6f67 2e64 6562 7567 2822 7365 636f   log.debug("seco
-0000f700: 6e64 6172 795f 6164 635f 7261 773a 2030  ndary_adc_raw: 0
-0000f710: 7825 3034 7822 2c20 7661 6c75 6529 0a20  x%04x", value). 
-0000f720: 2020 2020 2020 2072 6574 7572 6e20 7661         return va
-0000f730: 6c75 650a 0a20 2020 2023 230a 2020 2020  lue..    ##.    
-0000f740: 2320 4c61 7365 7220 7465 6d70 6572 6174  # Laser temperat
-0000f750: 7572 6520 636f 6e76 6572 7369 6f6e 2064  ure conversion d
-0000f760: 6f65 736e 2774 2075 7365 2045 4550 524f  oesn't use EEPRO
-0000f770: 4d20 636f 6566 6673 2061 7420 616c 6c2e  M coeffs at all.
-0000f780: 0a20 2020 2023 204d 6f73 7420 5761 7361  .    # Most Wasa
-0000f790: 7463 6820 5261 6d61 6e20 7379 7374 656d  tch Raman system
-0000f7a0: 7320 7573 6520 616e 2049 5053 2057 6176  s use an IPS Wav
-0000f7b0: 656c 656e 6774 682d 5374 6162 696c 697a  elength-Stabiliz
-0000f7c0: 6564 2054 4f2d 3536 0a20 2020 2023 206c  ed TO-56.    # l
-0000f7d0: 6173 6572 2c20 7768 6963 6820 696e 7465  aser, which inte
-0000f7e0: 726e 616c 6c79 2075 7365 7320 6120 4265  rnally uses a Be
-0000f7f0: 7461 7468 6572 6d20 3130 4b33 4347 3320  tatherm 10K3CG3 
-0000f800: 7468 6572 6d69 7374 6f72 2e0a 2020 2020  thermistor..    
-0000f810: 230a 2020 2020 2320 4073 6565 2068 7474  #.    # @see htt
-0000f820: 7073 3a2f 2f77 7777 2e69 7073 6c61 7365  ps://www.ipslase
-0000f830: 7273 2e63 6f6d 2f64 6174 612d 7368 6565  rs.com/data-shee
-0000f840: 7473 2f53 4d2d 544f 2d35 362d 4461 7461  ts/SM-TO-56-Data
-0000f850: 2d53 6865 6574 2d49 5053 2e70 6466 0a20  -Sheet-IPS.pdf. 
-0000f860: 2020 2023 0a20 2020 2023 2054 6865 206f     #.    # The o
-0000f870: 6666 6963 6961 6c20 636f 6e76 6572 7369  fficial conversi
-0000f880: 6f6e 2066 726f 6d20 7468 6572 6d69 7374  on from thermist
-0000f890: 6f72 2072 6573 6973 7461 6e63 6520 2869  or resistance (i
-0000f8a0: 6e20 6f68 6d73 2920 746f 2064 6567 4320  n ohms) to degC 
-0000f8b0: 6973 3a0a 2020 2020 230a 2020 2020 2320  is:.    #.    # 
-0000f8c0: 5c76 6572 6261 7469 6d0a 2020 2020 2320  \verbatim.    # 
-0000f8d0: 3120 2f20 2820 2020 4331 0a20 2020 2023  1 / (   C1.    #
-0000f8e0: 2020 2020 2020 202b 2043 3220 2a20 6c6e         + C2 * ln
-0000f8f0: 286f 686d 7329 0a20 2020 2023 2020 2020  (ohms).    #    
-0000f900: 2020 202b 2043 3320 2a20 706f 7728 6c6e     + C3 * pow(ln
-0000f910: 286f 686d 7329 2c20 3329 0a20 2020 2023  (ohms), 3).    #
-0000f920: 2020 2020 2029 0a20 2020 2023 202d 2032       ).    # - 2
-0000f930: 3733 2e31 350a 2020 2020 230a 2020 2020  73.15.    #.    
-0000f940: 2320 5768 6572 653a 2043 3120 3d20 302e  # Where: C1 = 0.
-0000f950: 3030 3131 330a 2020 2020 2320 2020 2020  00113.    #     
-0000f960: 2020 2043 3220 3d20 302e 3030 3032 3334     C2 = 0.000234
-0000f970: 0a20 2020 2023 2020 2020 2020 2020 4333  .    #        C3
-0000f980: 203d 2038 2e37 3865 2d38 0a20 2020 2023   = 8.78e-8.    #
-0000f990: 205c 656e 6476 6572 6261 7469 6d0a 2020   \endverbatim.  
-0000f9a0: 2020 230a 2020 2020 2320 4070 6172 616d    #.    # @param
-0000f9b0: 2072 6177 2020 2020 7468 6520 7661 6c75   raw    the valu
-0000f9c0: 6520 7265 6164 2066 726f 6d20 7468 6520  e read from the 
-0000f9d0: 7468 6572 6d69 7374 6f72 2773 2031 322d  thermistor's 12-
-0000f9e0: 6269 7420 4144 4320 2873 686f 756c 6420  bit ADC (should 
-0000f9f0: 6265 200a 2020 2020 2320 2020 2020 2020  be .    #       
-0000fa00: 2020 2020 2020 2020 7569 6e74 3132 2c20          uint12, 
-0000fa10: 6275 7420 6170 7061 7265 6e74 6c79 2063  but apparently c
-0000fa20: 616e 2062 6520 5370 6563 7472 6f6d 6574  an be Spectromet
-0000fa30: 6572 5265 7370 6f6e 7365 3f29 0a20 2020  erResponse?).   
-0000fa40: 2064 6566 2067 6574 5f6c 6173 6572 5f74   def get_laser_t
-0000fa50: 656d 7065 7261 7475 7265 5f64 6567 4328  emperature_degC(
-0000fa60: 7365 6c66 2c20 7261 773a 2069 6e74 203d  self, raw: int =
-0000fa70: 204e 6f6e 6529 202d 3e20 5370 6563 7472   None) -> Spectr
-0000fa80: 6f6d 6574 6572 5265 7370 6f6e 7365 3a0a  ometerResponse:.
-0000fa90: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0000faa0: 7369 6e73 7461 6e63 6528 7261 772c 2053  sinstance(raw, S
-0000fab0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0000fac0: 6e73 6529 3a0a 2020 2020 2020 2020 2020  nse):.          
-0000fad0: 2020 7261 7720 3d20 5370 6563 7472 6f6d    raw = Spectrom
-0000fae0: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-0000faf0: 613d 7261 7729 0a20 2020 2020 2020 2069  a=raw).        i
-0000fb00: 6620 7261 7720 6973 204e 6f6e 653a 0a20  f raw is None:. 
-0000fb10: 2020 2020 2020 2020 2020 2072 6177 203d             raw =
-0000fb20: 2073 656c 662e 6765 745f 6c61 7365 725f   self.get_laser_
-0000fb30: 7465 6d70 6572 6174 7572 655f 7261 7728  temperature_raw(
-0000fb40: 290a 0a20 2020 2020 2020 2069 6620 7261  )..        if ra
-0000fb50: 772e 6461 7461 2069 7320 4e6f 6e65 3a0a  w.data is None:.
-0000fb60: 2020 2020 2020 2020 2020 2020 6d73 673d              msg=
-0000fb70: 2267 6574 5f6c 6173 6572 5f74 656d 7065  "get_laser_tempe
-0000fb80: 7261 7475 7265 5f64 6567 433a 2065 7272  rature_degC: err
-0000fb90: 6f72 2072 6561 6469 6e67 2072 6177 206c  or reading raw l
-0000fba0: 6173 6572 2074 656d 7065 7261 7475 7265  aser temperature
-0000fbb0: 220a 2020 2020 2020 2020 2020 2020 6c6f  ".            lo
-0000fbc0: 672e 6572 726f 7228 6d73 6729 0a20 2020  g.error(msg).   
-0000fbd0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000fbe0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0000fbf0: 6f6e 7365 2865 7272 6f72 5f6c 766c 3d45  onse(error_lvl=E
-0000fc00: 7272 6f72 4c65 7665 6c2e 6c6f 772c 2065  rrorLevel.low, e
-0000fc10: 7272 6f72 5f6d 7367 3d6d 7367 290a 0a20  rror_msg=msg).. 
-0000fc20: 2020 2020 2020 2069 6620 7261 772e 6461         if raw.da
-0000fc30: 7461 203e 2030 7866 6666 3a0a 2020 2020  ta > 0xfff:.    
-0000fc40: 2020 2020 2020 2020 6d73 6720 3d20 2267          msg = "g
-0000fc50: 6574 5f6c 6173 6572 5f74 656d 7065 7261  et_laser_tempera
-0000fc60: 7475 7265 5f64 6567 433a 2072 6177 2076  ture_degC: raw v
-0000fc70: 616c 7565 2030 7825 3034 7820 6578 6365  alue 0x%04x exce
-0000fc80: 6564 7320 3132 2062 6974 7322 2025 2072  eds 12 bits" % r
-0000fc90: 6177 2e64 6174 610a 2020 2020 2020 2020  aw.data.        
-0000fca0: 2020 2020 6c6f 672e 6572 726f 7228 6d73      log.error(ms
-0000fcb0: 6729 0a20 2020 2020 2020 2020 2020 2072  g).            r
-0000fcc0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-0000fcd0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-0000fce0: 4e6f 6e65 2c20 6572 726f 725f 6c76 6c3d  None, error_lvl=
-0000fcf0: 4572 726f 724c 6576 656c 2e6c 6f77 2c20  ErrorLevel.low, 
-0000fd00: 6572 726f 725f 6d73 673d 6d73 6729 0a0a  error_msg=msg)..
-0000fd10: 2020 2020 2020 2020 6966 2072 6177 2e64          if raw.d
-0000fd20: 6174 6120 3d3d 2030 3a0a 2020 2020 2020  ata == 0:.      
-0000fd30: 2020 2020 2020 6d73 6720 3d20 2267 6574        msg = "get
-0000fd40: 5f6c 6173 6572 5f74 656d 7065 7261 7475  _laser_temperatu
-0000fd50: 7265 5f64 6567 433a 2063 616e 2774 2074  re_degC: can't t
-0000fd60: 616b 6520 6c6f 6720 6f66 2072 6177 2041  ake log of raw A
-0000fd70: 4443 2076 616c 7565 2030 220a 2020 2020  DC value 0".    
-0000fd80: 2020 2020 2020 2020 6c6f 672e 6572 726f          log.erro
-0000fd90: 7228 6d73 6729 0a20 2020 2020 2020 2020  r(msg).         
-0000fda0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-0000fdb0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-0000fdc0: 6174 613d 4e6f 6e65 2920 2320 6e6f 7420  ata=None) # not 
-0000fdd0: 7072 6f70 6f67 6174 696e 6720 6572 726f  propogating erro
-0000fde0: 725f 6d73 6720 666f 7220 6e6f 770a 0a20  r_msg for now.. 
-0000fdf0: 2020 2020 2020 2064 6567 4320 3d20 300a         degC = 0.
-0000fe00: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000fe10: 2020 2020 2020 2020 2076 6f6c 7461 6765           voltage
-0000fe20: 2020 2020 3d20 322e 3520 2a20 7261 772e      = 2.5 * raw.
-0000fe30: 6461 7461 202f 2034 3039 360a 2020 2020  data / 4096.    
-0000fe40: 2020 2020 2020 2020 7265 7369 7374 616e          resistan
-0000fe50: 6365 203d 2032 3134 3530 2e30 202a 2076  ce = 21450.0 * v
-0000fe60: 6f6c 7461 6765 202f 2028 322e 3520 2d20  oltage / (2.5 - 
-0000fe70: 766f 6c74 6167 6529 2023 204c 4220 636f  voltage) # LB co
-0000fe80: 6e66 6972 6d65 640a 0a20 2020 2020 2020  nfirmed..       
-0000fe90: 2020 2020 2069 6620 7265 7369 7374 616e       if resistan
-0000fea0: 6365 203c 2030 3a0a 2020 2020 2020 2020  ce < 0:.        
-0000feb0: 2020 2020 2020 2020 6d73 673d 2267 6574          msg="get
-0000fec0: 5f6c 6173 6572 5f74 656d 7065 7261 7475  _laser_temperatu
-0000fed0: 7265 5f64 6567 433a 2063 616e 2774 2063  re_degC: can't c
-0000fee0: 6f6d 7075 7465 2064 6567 433a 2072 6177  ompute degC: raw
-0000fef0: 203d 2030 7825 3034 782c 2076 6f6c 7461   = 0x%04x, volta
-0000ff00: 6765 203d 2025 662c 2072 6573 6973 7461  ge = %f, resista
-0000ff10: 6e63 6520 3d20 2566 2220 2520 280a 2020  nce = %f" % (.  
-0000ff20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff30: 2020 7261 772e 6461 7461 2c20 766f 6c74    raw.data, volt
-0000ff40: 6167 652c 2072 6573 6973 7461 6e63 6529  age, resistance)
-0000ff50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ff60: 206c 6f67 2e65 7272 6f72 286d 7367 290a   log.error(msg).
-0000ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff80: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-0000ff90: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
-0000ffa0: 3d4e 6f6e 652c 2065 7272 6f72 5f6c 6576  =None, error_lev
-0000ffb0: 656c 3d45 7272 6f72 4c65 7665 6c2e 6c6f  el=ErrorLevel.lo
-0000ffc0: 772c 2065 7272 6f72 5f6d 7367 3d6d 7367  w, error_msg=msg
-0000ffd0: 290a 0a20 2020 2020 2020 2020 2020 206c  )..            l
-0000ffe0: 6f67 5661 6c20 2020 2020 3d20 6d61 7468  ogVal     = math
-0000fff0: 2e6c 6f67 2872 6573 6973 7461 6e63 6520  .log(resistance 
-00010000: 2f20 3130 3030 302e 3029 0a20 2020 2020  / 10000.0).     
-00010010: 2020 2020 2020 2069 6e73 6964 654d 6169         insideMai
-00010020: 6e20 3d20 6c6f 6756 616c 202b 2033 3937  n = logVal + 397
-00010030: 372e 3020 2f20 2832 3520 2b20 3237 332e  7.0 / (25 + 273.
-00010040: 3029 0a20 2020 2020 2020 2020 2020 2064  0).            d
-00010050: 6567 4320 2020 2020 2020 3d20 3339 3737  egC       = 3977
-00010060: 2e30 202f 2069 6e73 6964 654d 6169 6e20  .0 / insideMain 
-00010070: 2d20 3237 332e 300a 0a20 2020 2020 2020  - 273.0..       
-00010080: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-00010090: 4c61 7365 7220 7465 6d70 6572 6174 7572  Laser temperatur
-000100a0: 653a 2025 2e32 6620 6465 6720 4320 2830  e: %.2f deg C (0
-000100b0: 7825 3034 7820 7261 7729 2220 2520 2864  x%04x raw)" % (d
-000100c0: 6567 432c 2072 6177 2e64 6174 6129 290a  egC, raw.data)).
-000100d0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-000100e0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-000100f0: 3d20 2265 7863 6570 7469 6f6e 2063 6f6d  = "exception com
-00010100: 7075 7469 6e67 206c 6173 6572 2074 656d  puting laser tem
-00010110: 7065 7261 7475 7265 220a 2020 2020 2020  perature".      
-00010120: 2020 2020 2020 6c6f 672e 6572 726f 7228        log.error(
-00010130: 6d73 672c 2065 7863 5f69 6e66 6f3d 3129  msg, exc_info=1)
-00010140: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00010150: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
-00010160: 5265 7370 6f6e 7365 2864 6174 613d 4e6f  Response(data=No
-00010170: 6e65 2c20 6572 726f 725f 6c65 7665 6c3d  ne, error_level=
-00010180: 4572 726f 724c 6576 656c 2e6c 6f77 2c20  ErrorLevel.low, 
-00010190: 6572 726f 725f 6d73 673d 6d73 6729 0a0a  error_msg=msg)..
-000101a0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-000101b0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-000101c0: 6e73 6528 6461 7461 3d64 6567 4329 0a0a  nse(data=degC)..
-000101d0: 2020 2020 2323 2040 6e6f 7465 2062 6967      ## @note big
-000101e0: 2d65 6e64 6961 6e2c 2072 6576 6572 7365  -endian, reverse
-000101f0: 206f 6620 6765 745f 6c61 7365 725f 7465   of get_laser_te
-00010200: 6d70 6572 6174 7572 655f 7261 770a 2020  mperature_raw.  
-00010210: 2020 6465 6620 6765 745f 6465 7465 6374    def get_detect
-00010220: 6f72 5f74 656d 7065 7261 7475 7265 5f72  or_temperature_r
-00010230: 6177 2873 656c 6629 202d 3e20 5370 6563  aw(self) -> Spec
-00010240: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-00010250: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00010260: 2073 656c 662e 5f67 6574 5f63 6f64 6528   self._get_code(
-00010270: 3078 6437 2c20 6c61 6265 6c3d 2247 4554  0xd7, label="GET
-00010280: 5f43 4344 5f54 454d 5022 2c20 6d73 625f  _CCD_TEMP", msb_
-00010290: 6c65 6e3d 3229 0a0a 2020 2020 6465 6620  len=2)..    def 
-000102a0: 6765 745f 6465 7465 6374 6f72 5f74 656d  get_detector_tem
-000102b0: 7065 7261 7475 7265 5f64 6567 4328 7365  perature_degC(se
-000102c0: 6c66 2c20 7261 773a 2066 6c6f 6174 203d  lf, raw: float =
-000102d0: 204e 6f6e 6529 202d 3e20 5370 6563 7472   None) -> Spectr
-000102e0: 6f6d 6574 6572 5265 7370 6f6e 7365 3a0a  ometerResponse:.
-000102f0: 2020 2020 2020 2020 6966 2072 6177 2069          if raw i
-00010300: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00010310: 2020 2020 7261 7720 3d20 7365 6c66 2e67      raw = self.g
-00010320: 6574 5f64 6574 6563 746f 725f 7465 6d70  et_detector_temp
-00010330: 6572 6174 7572 655f 7261 7728 292e 6461  erature_raw().da
-00010340: 7461 0a0a 2020 2020 2020 2020 6966 2072  ta..        if r
-00010350: 6177 2069 7320 4e6f 6e65 3a0a 2020 2020  aw is None:.    
-00010360: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00010370: 6177 0a0a 2020 2020 2020 2020 6465 6743  aw..        degC
-00010380: 203d 2073 656c 662e 7365 7474 696e 6773   = self.settings
-00010390: 2e65 6570 726f 6d2e 6164 635f 746f 5f64  .eeprom.adc_to_d
-000103a0: 6567 435f 636f 6566 6673 5b30 5d20 2020  egC_coeffs[0]   
-000103b0: 2020 2020 2020 2020 2020 5c0a 2020 2020            \.    
-000103c0: 2020 2020 2020 2020 202b 2073 656c 662e           + self.
-000103d0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
-000103e0: 6164 635f 746f 5f64 6567 435f 636f 6566  adc_to_degC_coef
-000103f0: 6673 5b31 5d20 2a20 7261 7720 2020 2020  fs[1] * raw     
-00010400: 2020 5c0a 2020 2020 2020 2020 2020 2020    \.            
-00010410: 202b 2073 656c 662e 7365 7474 696e 6773   + self.settings
-00010420: 2e65 6570 726f 6d2e 6164 635f 746f 5f64  .eeprom.adc_to_d
-00010430: 6567 435f 636f 6566 6673 5b32 5d20 2a20  egC_coeffs[2] * 
-00010440: 7261 7720 2a20 7261 770a 2020 2020 2020  raw * raw.      
-00010450: 2020 6c6f 672e 6465 6275 6728 2244 6574    log.debug("Det
-00010460: 6563 746f 7220 7465 6d70 6572 6174 7572  ector temperatur
-00010470: 653a 2025 2e32 6620 6465 6720 4320 2830  e: %.2f deg C (0
-00010480: 7825 3034 7820 7261 7729 2220 2520 2864  x%04x raw)" % (d
-00010490: 6567 432c 2072 6177 2929 0a20 2020 2020  egC, raw)).     
-000104a0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-000104b0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-000104c0: 6174 613d 6465 6743 290a 0a20 2020 2064  ata=degC)..    d
-000104d0: 6566 2073 6574 5f64 6574 6563 746f 725f  ef set_detector_
-000104e0: 7465 635f 7365 7470 6f69 6e74 5f64 6567  tec_setpoint_deg
-000104f0: 4328 7365 6c66 2c20 6465 6743 3a20 666c  C(self, degC: fl
-00010500: 6f61 7429 202d 3e20 5370 6563 7472 6f6d  oat) -> Spectrom
-00010510: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-00010520: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00010530: 2020 4174 7465 6d70 7420 746f 2073 6574    Attempt to set
-00010540: 2074 6865 2043 4344 2063 6f6f 6c65 7220   the CCD cooler 
-00010550: 7365 7470 6f69 6e74 2e20 5665 7269 6679  setpoint. Verify
-00010560: 2074 6861 7420 6974 2069 7320 7769 7468   that it is with
-00010570: 696e 2061 6e0a 2020 2020 2020 2020 6163  in an.        ac
-00010580: 6365 7074 6162 6c65 2072 616e 6765 2e20  ceptable range. 
-00010590: 4964 6561 6c6c 7920 7468 6973 2069 7320  Ideally this is 
-000105a0: 746f 2070 7265 7665 6e74 2063 6f6e 6465  to prevent conde
-000105b0: 6e73 6174 696f 6e20 616e 6420 6f74 6865  nsation and othe
-000105c0: 720a 2020 2020 2020 2020 6973 7375 6573  r.        issues
-000105d0: 2e20 5468 6973 2076 616c 7565 2069 7320  . This value is 
-000105e0: 6120 6465 6661 756c 7420 616e 6420 6973  a default and is
-000105f0: 2068 7567 656c 7920 6465 7065 6e64 656e   hugely dependen
-00010600: 7420 6f6e 2074 6865 0a20 2020 2020 2020  t on the.       
-00010610: 2065 6e76 6972 6f6e 6d65 6e74 616c 2063   environmental c
-00010620: 6f6e 6469 7469 6f6e 732e 0a20 2020 2020  onditions..     
-00010630: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00010640: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
-00010650: 6e67 732e 6565 7072 6f6d 2e68 6173 5f63  ngs.eeprom.has_c
-00010660: 6f6f 6c69 6e67 3a0a 2020 2020 2020 2020  ooling:.        
-00010670: 2020 2020 6c6f 672e 6572 726f 7228 2275      log.error("u
-00010680: 6e61 626c 6520 746f 2063 6f6e 7472 6f6c  nable to control
-00010690: 2054 4543 3a20 4545 5052 4f4d 2072 6570   TEC: EEPROM rep
-000106a0: 6f72 7473 206e 6f20 636f 6f6c 696e 6722  orts no cooling"
-000106b0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-000106c0: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
-000106d0: 7252 6573 706f 6e73 6528 6461 7461 3d46  rResponse(data=F
-000106e0: 616c 7365 2c20 6572 726f 725f 6c76 6c3d  alse, error_lvl=
-000106f0: 4572 726f 724c 6576 656c 2e6c 6f77 2c20  ErrorLevel.low, 
-00010700: 6572 726f 725f 6d73 673d 2275 6e61 626c  error_msg="unabl
-00010710: 6520 746f 2063 6f6e 7472 6f6c 2054 4543  e to control TEC
-00010720: 3a20 4545 5052 4f4d 2072 6570 6f72 7473  : EEPROM reports
-00010730: 206e 6f20 636f 6f6c 696e 6722 290a 0a20   no cooling").. 
-00010740: 2020 2020 2020 2069 6620 6465 6743 203c         if degC <
-00010750: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-00010760: 6570 726f 6d2e 6d69 6e5f 7465 6d70 5f64  eprom.min_temp_d
-00010770: 6567 433a 0a20 2020 2020 2020 2020 2020  egC:.           
-00010780: 206c 6f67 2e63 7269 7469 6361 6c28 2273   log.critical("s
-00010790: 6574 5f64 6574 6563 746f 725f 7465 635f  et_detector_tec_
-000107a0: 7365 7470 6f69 6e74 5f64 6567 433a 2073  setpoint_degC: s
-000107b0: 6574 706f 696e 7420 2566 2062 656c 6f77  etpoint %f below
-000107c0: 206d 696e 2025 6622 2c20 6465 6743 2c20   min %f", degC, 
-000107d0: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
-000107e0: 7072 6f6d 2e6d 696e 5f74 656d 705f 6465  prom.min_temp_de
-000107f0: 6743 290a 2020 2020 2020 2020 2020 2020  gC).            
-00010800: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-00010810: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
-00010820: 3d46 616c 7365 2c20 6572 726f 725f 6c76  =False, error_lv
-00010830: 6c3d 4572 726f 724c 6576 656c 2e6c 6f77  l=ErrorLevel.low
-00010840: 2c20 6572 726f 725f 6d73 673d 2273 6574  , error_msg="set
-00010850: 706f 696e 7420 6265 6c6f 7720 6d69 6e69  point below mini
-00010860: 6d75 6d22 290a 0a20 2020 2020 2020 2069  mum")..        i
-00010870: 6620 6465 6743 203e 2073 656c 662e 7365  f degC > self.se
-00010880: 7474 696e 6773 2e65 6570 726f 6d2e 6d61  ttings.eeprom.ma
-00010890: 785f 7465 6d70 5f64 6567 433a 0a20 2020  x_temp_degC:.   
-000108a0: 2020 2020 2020 2020 206c 6f67 2e63 7269           log.cri
-000108b0: 7469 6361 6c28 2273 6574 5f64 6574 6563  tical("set_detec
-000108c0: 746f 725f 7465 635f 7365 7470 6f69 6e74  tor_tec_setpoint
-000108d0: 5f64 6567 433a 2073 6574 706f 696e 7420  _degC: setpoint 
-000108e0: 2566 2065 7863 6565 6473 206d 6178 2025  %f exceeds max %
-000108f0: 6622 2c20 6465 6743 2c20 7365 6c66 2e73  f", degC, self.s
-00010900: 6574 7469 6e67 732e 6565 7072 6f6d 2e6d  ettings.eeprom.m
-00010910: 6178 5f74 656d 705f 6465 6743 290a 2020  ax_temp_degC).  
-00010920: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00010930: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-00010940: 706f 6e73 6528 6461 7461 3d46 616c 7365  ponse(data=False
-00010950: 2c20 6572 726f 725f 6c76 6c3d 4572 726f  , error_lvl=Erro
-00010960: 724c 6576 656c 2e6c 6f77 2c20 6572 726f  rLevel.low, erro
-00010970: 725f 6d73 673d 2273 6574 706f 696e 7420  r_msg="setpoint 
-00010980: 6265 796f 6e64 206d 6178 2229 0a0a 2020  beyond max")..  
-00010990: 2020 2020 2020 7261 7720 3d20 696e 7428        raw = int(
-000109a0: 726f 756e 6428 7365 6c66 2e73 6574 7469  round(self.setti
-000109b0: 6e67 732e 6565 7072 6f6d 2e64 6567 435f  ngs.eeprom.degC_
-000109c0: 746f 5f64 6163 5f63 6f65 6666 735b 305d  to_dac_coeffs[0]
-000109d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000109e0: 2020 2020 2020 202b 2073 656c 662e 7365         + self.se
-000109f0: 7474 696e 6773 2e65 6570 726f 6d2e 6465  ttings.eeprom.de
-00010a00: 6743 5f74 6f5f 6461 635f 636f 6566 6673  gC_to_dac_coeffs
-00010a10: 5b31 5d20 2a20 6465 6743 0a20 2020 2020  [1] * degC.     
-00010a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a30: 202b 2073 656c 662e 7365 7474 696e 6773   + self.settings
-00010a40: 2e65 6570 726f 6d2e 6465 6743 5f74 6f5f  .eeprom.degC_to_
-00010a50: 6461 635f 636f 6566 6673 5b32 5d20 2a20  dac_coeffs[2] * 
-00010a60: 6465 6743 202a 2064 6567 4329 290a 0a20  degC * degC)).. 
-00010a70: 2020 2020 2020 2023 2052 4f55 4e44 2028         # ROUND (
-00010a80: 646f 6e27 7420 6d61 736b 2920 746f 2031  don't mask) to 1
-00010a90: 322d 6269 7420 4441 430a 2020 2020 2020  2-bit DAC.      
-00010aa0: 2020 7261 7720 3d20 6d61 7828 302c 206d    raw = max(0, m
-00010ab0: 696e 2872 6177 2c20 3078 6666 6629 290a  in(raw, 0xfff)).
-00010ac0: 0a20 2020 2020 2020 206c 6f67 2e64 6562  .        log.deb
-00010ad0: 7567 2822 5365 7420 4343 4420 5445 4320  ug("Set CCD TEC 
-00010ae0: 5365 7470 6f69 6e74 3a20 252e 3266 2064  Setpoint: %.2f d
-00010af0: 6567 2043 2028 7261 7720 4144 4320 3078  eg C (raw ADC 0x
-00010b00: 2530 3478 2922 2c20 6465 6743 2c20 7261  %04x)", degC, ra
-00010b10: 7729 0a20 2020 2020 2020 206f 6b20 3d20  w).        ok = 
-00010b20: 7365 6c66 2e5f 7365 6e64 5f63 6f64 6528  self._send_code(
-00010b30: 3078 6438 2c20 7261 772c 206c 6162 656c  0xd8, raw, label
-00010b40: 3d22 5345 545f 4445 5445 4354 4f52 5f54  ="SET_DETECTOR_T
-00010b50: 4543 5f53 4554 504f 494e 5422 290a 2020  EC_SETPOINT").  
-00010b60: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-00010b70: 6e67 732e 7374 6174 652e 7465 635f 7365  ngs.state.tec_se
-00010b80: 7470 6f69 6e74 5f64 6567 4320 3d20 6465  tpoint_degC = de
-00010b90: 6743 0a20 2020 2020 2020 2073 656c 662e  gC.        self.
-00010ba0: 6465 7465 6374 6f72 5f74 6563 5f73 6574  detector_tec_set
-00010bb0: 706f 696e 745f 6861 735f 6265 656e 5f73  point_has_been_s
-00010bc0: 6574 203d 2054 7275 650a 2020 2020 2020  et = True.      
-00010bd0: 2020 7265 7475 726e 206f 6b0a 0a20 2020    return ok..   
-00010be0: 2064 6566 2067 6574 5f64 6574 6563 746f   def get_detecto
-00010bf0: 725f 7465 635f 7365 7470 6f69 6e74 5f64  r_tec_setpoint_d
-00010c00: 6567 4328 7365 6c66 2920 2d3e 2053 7065  egC(self) -> Spe
-00010c10: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-00010c20: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
-00010c30: 6c66 2e64 6574 6563 746f 725f 7465 635f  lf.detector_tec_
-00010c40: 7365 7470 6f69 6e74 5f68 6173 5f62 6565  setpoint_has_bee
-00010c50: 6e5f 7365 743a 0a20 2020 2020 2020 2020  n_set:.         
-00010c60: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-00010c70: 6f6d 6574 6572 5265 7370 6f6e 7365 2873  ometerResponse(s
-00010c80: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
-00010c90: 7465 2e74 6563 5f73 6574 706f 696e 745f  te.tec_setpoint_
-00010ca0: 6465 6743 290a 2020 2020 2020 2020 6c6f  degC).        lo
-00010cb0: 672e 6572 726f 7228 2244 6574 6563 746f  g.error("Detecto
-00010cc0: 7220 5445 4320 7365 7470 6f69 6e74 2068  r TEC setpoint h
-00010cd0: 6173 206e 6f74 2079 6574 2062 6565 6e20  as not yet been 
-00010ce0: 6170 706c 6965 6422 290a 2020 2020 2020  applied").      
-00010cf0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-00010d00: 6d65 7465 7252 6573 706f 6e73 6528 302e  meterResponse(0.
-00010d10: 3029 0a0a 2020 2020 6465 6620 6765 745f  0)..    def get_
-00010d20: 6465 7465 6374 6f72 5f74 6563 5f73 6574  detector_tec_set
-00010d30: 706f 696e 745f 7261 7728 7365 6c66 2920  point_raw(self) 
-00010d40: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-00010d50: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-00010d60: 2072 6574 7572 6e20 7365 6c66 2e67 6574   return self.get
-00010d70: 5f64 6163 2830 290a 0a20 2020 2064 6566  _dac(0)..    def
-00010d80: 2067 6574 5f64 6163 2873 656c 662c 2064   get_dac(self, d
-00010d90: 6163 496e 6465 783a 2069 6e74 203d 2030  acIndex: int = 0
-00010da0: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-00010db0: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-00010dc0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-00010dd0: 6765 745f 636f 6465 2830 7864 392c 2077  get_code(0xd9, w
-00010de0: 496e 6465 783d 6461 6349 6e64 6578 2c20  Index=dacIndex, 
-00010df0: 6c61 6265 6c3d 2247 4554 5f44 4143 222c  label="GET_DAC",
-00010e00: 206c 7362 5f6c 656e 3d32 290a 0a20 2020   lsb_len=2)..   
-00010e10: 2023 2320 4074 6f64 6f20 7265 6e61 6d65   ## @todo rename
-00010e20: 2073 6574 5f64 6574 6563 746f 725f 7465   set_detector_te
-00010e30: 635f 656e 6162 6c65 0a20 2020 2064 6566  c_enable.    def
-00010e40: 2073 6574 5f74 6563 5f65 6e61 626c 6528   set_tec_enable(
-00010e50: 7365 6c66 2c20 666c 6167 3a20 626f 6f6c  self, flag: bool
-00010e60: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-00010e70: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-00010e80: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
-00010e90: 6574 7469 6e67 732e 6565 7072 6f6d 2e68  ettings.eeprom.h
-00010ea0: 6173 5f63 6f6f 6c69 6e67 3a0a 2020 2020  as_cooling:.    
-00010eb0: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-00010ec0: 6728 2275 6e61 626c 6520 746f 2063 6f6e  g("unable to con
-00010ed0: 7472 6f6c 2054 4543 3a20 4545 5052 4f4d  trol TEC: EEPROM
-00010ee0: 2072 6570 6f72 7473 206e 6f20 636f 6f6c   reports no cool
-00010ef0: 696e 6722 290a 2020 2020 2020 2020 2020  ing").          
-00010f00: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-00010f10: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-00010f20: 7461 3d46 616c 7365 2c20 6572 726f 725f  ta=False, error_
-00010f30: 6d73 673d 2275 6e61 626c 6520 746f 2063  msg="unable to c
-00010f40: 6f6e 7472 6f6c 2054 4543 3a20 4545 5052  ontrol TEC: EEPR
-00010f50: 4f4d 2072 6570 6f72 7473 206e 6f20 636f  OM reports no co
-00010f60: 6f6c 696e 6722 290a 0a20 2020 2020 2020  oling")..       
-00010f70: 2076 616c 7565 203d 2031 2069 6620 666c   value = 1 if fl
-00010f80: 6167 2065 6c73 6520 300a 0a20 2020 2020  ag else 0..     
-00010f90: 2020 2069 6620 6e6f 7420 7365 6c66 2e64     if not self.d
-00010fa0: 6574 6563 746f 725f 7465 635f 7365 7470  etector_tec_setp
-00010fb0: 6f69 6e74 5f68 6173 5f62 6565 6e5f 7365  oint_has_been_se
-00010fc0: 743a 0a0a 2020 2020 2020 2020 2020 2020  t:..            
-00010fd0: 2320 4074 6f64 6f20 7368 6f75 6c64 2074  # @todo should t
-00010fe0: 6869 7320 6e6f 7420 6265 2065 6570 726f  his not be eepro
-00010ff0: 6d2e 7374 6172 7475 705f 7465 6d70 5f64  m.startup_temp_d
-00011000: 6567 430a 2020 2020 2020 2020 2020 2020  egC.            
-00011010: 6c6f 672e 6465 6275 6728 2264 6566 6175  log.debug("defau
-00011020: 6c74 696e 6720 5445 4320 7365 7470 6f69  lting TEC setpoi
-00011030: 6e74 2074 6f20 6d69 6e20 2573 222c 2073  nt to min %s", s
-00011040: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
-00011050: 726f 6d2e 6d69 6e5f 7465 6d70 5f64 6567  rom.min_temp_deg
-00011060: 4329 0a20 2020 2020 2020 2020 2020 2073  C).            s
-00011070: 656c 662e 7365 745f 6465 7465 6374 6f72  elf.set_detector
-00011080: 5f74 6563 5f73 6574 706f 696e 745f 6465  _tec_setpoint_de
-00011090: 6743 2873 656c 662e 7365 7474 696e 6773  gC(self.settings
-000110a0: 2e65 6570 726f 6d2e 6d69 6e5f 7465 6d70  .eeprom.min_temp
-000110b0: 5f64 6567 4329 0a0a 2020 2020 2020 2020  _degC)..        
-000110c0: 6c6f 672e 6465 6275 6728 2253 656e 6420  log.debug("Send 
-000110d0: 6465 7465 6374 6f72 2054 4543 2065 6e61  detector TEC ena
-000110e0: 626c 653a 2025 7322 2c20 7661 6c75 6529  ble: %s", value)
-000110f0: 0a20 2020 2020 2020 206f 6b20 3d20 7365  .        ok = se
-00011100: 6c66 2e5f 7365 6e64 5f63 6f64 6528 3078  lf._send_code(0x
-00011110: 6436 2c20 7661 6c75 652c 206c 6162 656c  d6, value, label
-00011120: 3d22 5345 545f 4445 5445 4354 4f52 5f54  ="SET_DETECTOR_T
-00011130: 4543 5f45 4e41 424c 4522 290a 2020 2020  EC_ENABLE").    
-00011140: 2020 2020 6966 206f 6b2e 6461 7461 3a0a      if ok.data:.
-00011150: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00011160: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
-00011170: 7465 635f 656e 6162 6c65 6420 3d20 666c  tec_enabled = fl
-00011180: 6167 0a20 2020 2020 2020 2072 6574 7572  ag.        retur
-00011190: 6e20 6f6b 0a0a 2020 2020 6465 6620 7365  n ok..    def se
-000111a0: 745f 7472 6967 6765 725f 736f 7572 6365  t_trigger_source
-000111b0: 2873 656c 662c 2076 616c 7565 3a20 626f  (self, value: bo
-000111c0: 6f6c 2920 2d3e 2053 7065 6374 726f 6d65  ol) -> Spectrome
-000111d0: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-000111e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000111f0: 2053 6574 2074 6865 2073 6f75 7263 6520   Set the source 
-00011200: 666f 7220 696e 636f 6d69 6e67 2061 6371  for incoming acq
-00011210: 7569 7369 7469 6f6e 2074 7269 6767 6572  uisition trigger
-00011220: 732e 0a20 2020 2020 2020 2040 7061 7261  s..        @para
-00011230: 6d20 7661 6c75 6520 6569 7468 6572 2030  m value either 0
-00011240: 2066 6f72 2022 696e 7465 726e 616c 2220   for "internal" 
-00011250: 6f72 2031 2066 6f72 2022 6578 7465 726e  or 1 for "extern
-00011260: 616c 220a 2020 2020 2020 2020 5769 7468  al".        With
-00011270: 2069 6e74 6572 6e61 6c20 7472 6967 6765   internal trigge
-00011280: 7269 6e67 2028 7468 6520 6465 6661 756c  ring (the defaul
-00011290: 7429 2c20 7468 6520 7370 6563 7472 6f6d  t), the spectrom
-000112a0: 6574 6572 2065 7870 6563 7473 2074 6865  eter expects the
-000112b0: 0a20 2020 2020 2020 2055 5342 2068 6f73  .        USB hos
-000112c0: 7420 746f 2065 7870 6c69 6369 746c 7920  t to explicitly 
-000112d0: 7365 6e64 2061 2053 5441 5254 5f41 4351  send a START_ACQ
-000112e0: 5549 5349 5449 4f4e 2028 4143 5155 4952  UISITION (ACQUIR
-000112f0: 4529 206f 7063 6f64 6520 746f 0a20 2020  E) opcode to.   
-00011300: 2020 2020 2062 6567 696e 2065 6163 6820       begin each 
-00011310: 696e 7465 6772 6174 696f 6e2e 2020 496e  integration.  In
-00011320: 2065 7874 6572 6e61 6c20 7472 6967 6765   external trigge
-00011330: 7269 6e67 2c20 7468 6520 7370 6563 7472  ring, the spectr
-00011340: 6f6d 6574 6572 0a20 2020 2020 2020 2077  ometer.        w
-00011350: 6169 7473 2066 6f72 2074 6865 2072 6973  aits for the ris
-00011360: 696e 6720 6564 6765 206f 6e20 6120 7369  ing edge on a si
-00011370: 676e 616c 2063 6f6e 6e65 6374 6564 2074  gnal connected t
-00011380: 6f20 6120 7069 6e20 6f6e 2074 6865 204f  o a pin on the O
-00011390: 454d 0a20 2020 2020 2020 2061 6363 6573  EM.        acces
-000113a0: 736f 7279 2063 6f6e 6e65 6374 6f72 2e0a  sory connector..
-000113b0: 2020 2020 2020 2020 5465 6368 6e69 6361          Technica
-000113c0: 6c6c 7920 6f6e 2041 524d 2c20 7468 6520  lly on ARM, the 
-000113d0: 6d69 6372 6f63 6f6e 7472 6f6c 6c65 7220  microcontroller 
-000113e0: 6973 2063 6f6e 7469 6e75 6f75 736c 7920  is continuously 
-000113f0: 6d6f 6e69 746f 7269 6e67 0a20 2020 2020  monitoring.     
-00011400: 2020 2062 6f74 6820 7468 6520 6578 7465     both the exte
-00011410: 726e 616c 2070 696e 2061 6e64 206c 6973  rnal pin and lis
-00011420: 7465 6e69 6e67 2066 6f72 2069 6e74 6572  tening for inter
-00011430: 6e61 6c20 736f 6674 7761 7265 206f 7063  nal software opc
-00011440: 6f64 6573 2e0a 2020 2020 2020 2020 4f6e  odes..        On
-00011450: 2074 6865 2046 5832 2079 6f75 206e 6565   the FX2 you nee
-00011460: 6420 746f 2065 7870 6c69 6369 746c 7920  d to explicitly 
-00011470: 706c 6163 6520 7468 6520 6d69 6372 6f63  place the microc
-00011480: 6f6e 7472 6f6c 6c65 7220 696e 746f 0a20  ontroller into. 
-00011490: 2020 2020 2020 2065 7874 6572 6e61 6c20         external 
-000114a0: 7472 6967 6765 7269 6e67 206d 6f64 6520  triggering mode 
-000114b0: 746f 2061 7661 696c 2074 6865 2066 6561  to avail the fea
-000114c0: 7475 7265 2e0a 2020 2020 2020 2020 2222  ture..        ""
-000114d0: 220a 2020 2020 2020 2020 7365 6c66 2e73  ".        self.s
-000114e0: 6574 7469 6e67 732e 7374 6174 652e 7472  ettings.state.tr
-000114f0: 6967 6765 725f 736f 7572 6365 203d 2076  igger_source = v
-00011500: 616c 7565 0a20 2020 2020 2020 206c 6f67  alue.        log
-00011510: 2e64 6562 7567 2822 7472 6967 6765 725f  .debug("trigger_
-00011520: 736f 7572 6365 206e 6f77 2025 7322 2c20  source now %s", 
-00011530: 7661 6c75 6529 0a0a 2020 2020 2020 2020  value)..        
-00011540: 2320 446f 6e27 7420 7365 6e64 2074 6865  # Don't send the
-00011550: 206f 7063 6f64 6520 6f6e 2041 524d 2e20   opcode on ARM. 
-00011560: 5365 6520 6973 7375 6520 2332 206f 6e20  See issue #2 on 
-00011570: 5761 7361 7463 6855 5342 2070 726f 6a65  WasatchUSB proje
-00011580: 6374 0a20 2020 2020 2020 2069 6620 7365  ct.        if se
-00011590: 6c66 2e73 6574 7469 6e67 732e 6973 5f61  lf.settings.is_a
-000115a0: 726d 2829 3a0a 2020 2020 2020 2020 2020  rm():.          
-000115b0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-000115c0: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-000115d0: 7461 3d46 616c 7365 290a 0a20 2020 2020  ta=False)..     
-000115e0: 2020 206d 7362 203d 2030 0a20 2020 2020     msb = 0.     
-000115f0: 2020 206c 7362 203d 2076 616c 7565 0a20     lsb = value. 
-00011600: 2020 2020 2020 2062 7566 203d 205b 305d         buf = [0]
-00011610: 202a 2038 0a0a 2020 2020 2020 2020 2320   * 8..        # 
-00011620: 4d5a 3a20 7468 6973 2069 7320 7765 6972  MZ: this is weir
-00011630: 642e 2e2e 7765 2772 6520 7365 6e64 696e  d...we're sendin
-00011640: 6720 7468 6520 6275 6666 6572 206f 6e20  g the buffer on 
-00011650: 616e 2046 5832 2d6f 6e6c 7920 636f 6d6d  an FX2-only comm
-00011660: 616e 640a 2020 2020 2020 2020 7265 7475  and.        retu
-00011670: 726e 2073 656c 662e 5f73 656e 645f 636f  rn self._send_co
-00011680: 6465 2830 7864 322c 206c 7362 2c20 6d73  de(0xd2, lsb, ms
-00011690: 622c 2062 7566 2c20 6c61 6265 6c3d 2253  b, buf, label="S
-000116a0: 4554 5f54 5249 4747 4552 5f53 4f55 5243  ET_TRIGGER_SOURC
-000116b0: 4522 290a 0a20 2020 2023 230a 2020 2020  E")..    ##.    
-000116c0: 2320 4346 5f53 454c 4543 5420 6973 2063  # CF_SELECT is c
-000116d0: 6f6e 6669 6775 7265 6420 7573 696e 6720  onfigured using 
-000116e0: 6269 7420 3220 6f66 2074 6865 2046 5047  bit 2 of the FPG
-000116f0: 4120 636f 6e66 6967 7572 6174 696f 6e20  A configuration 
-00011700: 7265 6769 7374 6572 0a20 2020 2023 2030  register.    # 0
-00011710: 7831 322e 2020 5468 6973 2062 6974 2063  x12.  This bit c
-00011720: 616e 2062 6520 7365 7420 7573 696e 6720  an be set using 
-00011730: 7665 6e64 6f72 2063 6f6d 6d61 6e64 7320  vendor commands 
-00011740: 3078 6562 2074 6f20 5345 5420 616e 6420  0xeb to SET and 
-00011750: 3078 6563 0a20 2020 2023 2074 6f20 4745  0xec.    # to GE
-00011760: 542e 2020 4e6f 7465 2074 6861 7420 7468  T.  Note that th
-00011770: 6520 7365 7420 636f 6d6d 616e 6420 6973  e set command is
-00011780: 2065 7870 6563 7469 6e67 2061 2035 2d62   expecting a 5-b
-00011790: 7974 6520 756e 7369 676e 6564 0a20 2020  yte unsigned.   
-000117a0: 2023 2076 616c 7565 2c20 7468 6520 6869   # value, the hi
-000117b0: 6768 6573 7420 6279 7465 206f 6620 7768  ghest byte of wh
-000117c0: 6963 6820 7765 2070 6173 7320 6173 2070  ich we pass as p
-000117d0: 6172 7420 6f66 2061 6e20 382d 6279 7465  art of an 8-byte
-000117e0: 2062 7566 6665 722e 0a20 2020 2023 204e   buffer..    # N
-000117f0: 6f74 2073 7572 6520 7768 792e 0a20 2020  ot sure why..   
-00011800: 2064 6566 2073 6574 5f68 6967 685f 6761   def set_high_ga
-00011810: 696e 5f6d 6f64 655f 656e 6162 6c65 2873  in_mode_enable(s
-00011820: 656c 662c 2066 6c61 673a 2062 6f6f 6c29  elf, flag: bool)
-00011830: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
-00011840: 5265 7370 6f6e 7365 3a0a 2020 2020 2020  Response:.      
-00011850: 2020 6c6f 672e 6465 6275 6728 2253 6574    log.debug("Set
-00011860: 2068 6967 6820 6761 696e 206d 6f64 653a   high gain mode:
-00011870: 2025 7322 2c20 666c 6167 290a 2020 2020   %s", flag).    
-00011880: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00011890: 7365 7474 696e 6773 2e69 735f 696e 6761  settings.is_inga
-000118a0: 6173 2829 3a0a 2020 2020 2020 2020 2020  as():.          
-000118b0: 2020 6c6f 672e 6465 6275 6728 2253 4554    log.debug("SET
-000118c0: 5f48 4947 485f 4741 494e 5f4d 4f44 455f  _HIGH_GAIN_MODE_
-000118d0: 454e 4142 4c45 206f 6e6c 7920 7375 7070  ENABLE only supp
-000118e0: 6f72 7465 6420 6f6e 2049 6e47 6141 7322  orted on InGaAs"
-000118f0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00011900: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
-00011910: 7252 6573 706f 6e73 6528 6461 7461 3d46  rResponse(data=F
-00011920: 616c 7365 2c65 7272 6f72 5f6d 7367 3d22  alse,error_msg="
-00011930: 4869 6768 2047 6169 6e20 6e6f 7420 7375  High Gain not su
-00011940: 7070 6f72 7420 6f6e 2074 6869 7320 7370  pport on this sp
-00011950: 6563 7472 6f6d 6574 6572 2229 0a0a 2020  ectrometer")..  
-00011960: 2020 2020 2020 7661 6c75 6520 3d20 3120        value = 1 
-00011970: 6966 2066 6c61 6720 656c 7365 2030 0a0a  if flag else 0..
-00011980: 2020 2020 2020 2020 2320 7468 6973 2069          # this i
-00011990: 7320 646f 6e65 2061 7574 6f6d 6174 6963  s done automatic
-000119a0: 616c 6c79 206f 6e20 4152 4d2c 2062 7574  ally on ARM, but
-000119b0: 2066 6f72 2074 6869 7320 6f70 636f 6465   for this opcode
-000119c0: 2077 6520 646f 2069 7420 6f6e 2046 5832   we do it on FX2
-000119d0: 2061 7320 7765 6c6c 0a20 2020 2020 2020   as well.       
-000119e0: 2062 7566 203d 205b 305d 202a 2038 0a0a   buf = [0] * 8..
-000119f0: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-00011a00: 7469 6e67 732e 7374 6174 652e 6869 6768  tings.state.high
-00011a10: 5f67 6169 6e5f 6d6f 6465 5f65 6e61 626c  _gain_mode_enabl
-00011a20: 6564 203d 2066 6c61 670a 2020 2020 2020  ed = flag.      
-00011a30: 2020 7265 7475 726e 2073 656c 662e 5f73    return self._s
-00011a40: 656e 645f 636f 6465 2830 7865 622c 2077  end_code(0xeb, w
-00011a50: 5661 6c75 653d 7661 6c75 652c 2077 496e  Value=value, wIn
-00011a60: 6465 783d 302c 2064 6174 615f 6f72 5f77  dex=0, data_or_w
-00011a70: 4c65 6e67 7468 3d62 7566 2c20 6c61 6265  Length=buf, labe
-00011a80: 6c3d 2253 4554 5f48 4947 485f 4741 494e  l="SET_HIGH_GAIN
-00011a90: 5f4d 4f44 455f 454e 4142 4c45 2229 0a0a  _MODE_ENABLE")..
-00011aa0: 2020 2020 6465 6620 6765 745f 6869 6768      def get_high
-00011ab0: 5f67 6169 6e5f 6d6f 6465 5f65 6e61 626c  _gain_mode_enabl
-00011ac0: 6564 2873 656c 6629 202d 3e20 5370 6563  ed(self) -> Spec
-00011ad0: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-00011ae0: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00011af0: 2073 656c 662e 7365 7474 696e 6773 2e69   self.settings.i
-00011b00: 735f 696e 6761 6173 2829 3a0a 2020 2020  s_ingaas():.    
-00011b10: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-00011b20: 6728 2247 4554 5f48 4947 485f 4741 494e  g("GET_HIGH_GAIN
-00011b30: 5f4d 4f44 455f 454e 4142 4c45 206f 6e6c  _MODE_ENABLE onl
-00011b40: 7920 7375 7070 6f72 7465 6420 6f6e 2049  y supported on I
-00011b50: 6e47 6141 7322 290a 2020 2020 2020 2020  nGaAs").        
-00011b60: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-00011b70: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-00011b80: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
-00011b90: 7072 6f6d 2e68 6967 685f 6761 696e 5f6d  prom.high_gain_m
-00011ba0: 6f64 655f 656e 6162 6c65 6429 0a0a 2020  ode_enabled)..  
-00011bb0: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-00011bc0: 6e67 732e 7374 6174 652e 6869 6768 5f67  ngs.state.high_g
-00011bd0: 6169 6e5f 6d6f 6465 5f65 6e61 626c 6564  ain_mode_enabled
-00011be0: 203d 2030 2021 3d20 7365 6c66 2e5f 6765   = 0 != self._ge
-00011bf0: 745f 636f 6465 2830 7865 632c 206c 7362  t_code(0xec, lsb
-00011c00: 5f6c 656e 3d31 2c20 6c61 6265 6c3d 2247  _len=1, label="G
-00011c10: 4554 5f48 4947 485f 4741 494e 5f4d 4f44  ET_HIGH_GAIN_MOD
-00011c20: 455f 454e 4142 4c45 4422 290a 2020 2020  E_ENABLED").    
-00011c30: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-00011c40: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-00011c50: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
-00011c60: 6174 652e 6869 6768 5f67 6169 6e5f 6d6f  ate.high_gain_mo
-00011c70: 6465 5f65 6e61 626c 6564 290a 0a20 2020  de_enabled)..   
-00011c80: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00011c90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011ca0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011cb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011cc0: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-00011cd0: 2020 2320 4c61 7365 7220 636f 6d6d 616e    # Laser comman
-00011ce0: 6473 0a20 2020 2023 2323 2323 2323 2323  ds.    #########
-00011cf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011d00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011d10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011d20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011d30: 2323 230a 0a20 2020 2064 6566 2067 6574  ###..    def get
-00011d40: 5f6f 7074 5f6c 6173 6572 5f63 6f6e 7472  _opt_laser_contr
-00011d50: 6f6c 2873 656c 6629 202d 3e20 5370 6563  ol(self) -> Spec
-00011d60: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-00011d70: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00011d80: 2073 656c 662e 6765 745f 7570 7065 725f   self.get_upper_
-00011d90: 636f 6465 2830 7830 392c 206c 6162 656c  code(0x09, label
-00011da0: 3d22 4745 545f 4f50 545f 4c41 5345 525f  ="GET_OPT_LASER_
-00011db0: 434f 4e54 524f 4c22 2c20 6d73 625f 6c65  CONTROL", msb_le
-00011dc0: 6e3d 3129 0a0a 2020 2020 6465 6620 6765  n=1)..    def ge
-00011dd0: 745f 6f70 745f 6861 735f 6c61 7365 7228  t_opt_has_laser(
-00011de0: 7365 6c66 2920 2d3e 2053 7065 6374 726f  self) -> Spectro
-00011df0: 6d65 7465 7252 6573 706f 6e73 653a 0a20  meterResponse:. 
-00011e00: 2020 2020 2020 2061 7661 696c 6162 6c65         available
-00011e10: 203d 2028 3020 213d 2073 656c 662e 6765   = (0 != self.ge
-00011e20: 745f 7570 7065 725f 636f 6465 2830 7830  t_upper_code(0x0
-00011e30: 382c 206c 6162 656c 3d22 4745 545f 4f50  8, label="GET_OP
-00011e40: 545f 4841 535f 4c41 5345 5222 2c20 6d73  T_HAS_LASER", ms
-00011e50: 625f 6c65 6e3d 3129 2e64 6174 6129 0a20  b_len=1).data). 
-00011e60: 2020 2020 2020 2069 6620 6176 6169 6c61         if availa
-00011e70: 626c 6520 213d 2073 656c 662e 7365 7474  ble != self.sett
-00011e80: 696e 6773 2e65 6570 726f 6d2e 6861 735f  ings.eeprom.has_
-00011e90: 6c61 7365 723a 0a20 2020 2020 2020 2020  laser:.         
-00011ea0: 2020 206c 6f67 2e65 7272 6f72 2822 4f50     log.error("OP
-00011eb0: 545f 4841 535f 4c41 5345 5220 6f70 636f  T_HAS_LASER opco
-00011ec0: 6465 2072 6573 756c 7420 2573 2021 3d20  de result %s != 
-00011ed0: 4545 5052 4f4d 2068 6173 5f6c 6173 6572  EEPROM has_laser
-00011ee0: 2025 7320 2875 7369 6e67 206f 7063 6f64   %s (using opcod
-00011ef0: 6529 222c 0a20 2020 2020 2020 2020 2020  e)",.           
-00011f00: 2020 2020 2076 616c 7565 2c20 7365 6c66       value, self
-00011f10: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
-00011f20: 2e68 6173 5f6c 6173 6572 290a 2020 2020  .has_laser).    
-00011f30: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-00011f40: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-00011f50: 6461 7461 3d61 7661 696c 6162 6c65 290a  data=available).
-00011f60: 0a20 2020 2023 2320 406e 6f74 6520 6c69  .    ## @note li
-00011f70: 7474 6c65 2d65 6e64 6961 6e2c 2072 6576  ttle-endian, rev
-00011f80: 6572 7365 206f 6620 6765 745f 6465 7465  erse of get_dete
-00011f90: 6374 6f72 5f74 656d 7065 7261 7475 7265  ctor_temperature
-00011fa0: 5f72 6177 0a20 2020 2064 6566 2067 6574  _raw.    def get
-00011fb0: 5f6c 6173 6572 5f74 656d 7065 7261 7475  _laser_temperatu
-00011fc0: 7265 5f72 6177 2873 656c 6629 202d 3e20  re_raw(self) -> 
-00011fd0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00011fe0: 6f6e 7365 3a0a 2020 2020 2020 2020 2320  onse:.        # 
-00011ff0: 666c 6970 2074 6f20 7072 696d 6172 7920  flip to primary 
-00012000: 4144 4320 6966 206e 6565 6465 640a 2020  ADC if needed.  
-00012010: 2020 2020 2020 6966 2073 656c 662e 7365        if self.se
-00012020: 7474 696e 6773 2e73 7461 7465 2e73 656c  ttings.state.sel
-00012030: 6563 7465 645f 6164 6320 6973 204e 6f6e  ected_adc is Non
-00012040: 6520 6f72 2073 656c 662e 7365 7474 696e  e or self.settin
-00012050: 6773 2e73 7461 7465 2e73 656c 6563 7465  gs.state.selecte
-00012060: 645f 6164 6320 213d 2030 3a0a 2020 2020  d_adc != 0:.    
-00012070: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
-00012080: 6563 745f 6164 6328 3029 0a0a 2020 2020  ect_adc(0)..    
-00012090: 2020 2020 7265 7375 6c74 203d 2073 656c      result = sel
-000120a0: 662e 5f67 6574 5f63 6f64 6528 3078 6435  f._get_code(0xd5
-000120b0: 2c20 774c 656e 6774 683d 322c 206c 6162  , wLength=2, lab
-000120c0: 656c 3d22 4745 545f 4144 4322 2c20 6c73  el="GET_ADC", ls
-000120d0: 625f 6c65 6e3d 3229 0a20 2020 2020 2020  b_len=2).       
-000120e0: 2069 6620 6e6f 7420 7265 7375 6c74 2e64   if not result.d
-000120f0: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
-00012100: 206c 6f67 2e64 6562 7567 2822 556e 6162   log.debug("Unab
-00012110: 6c65 2074 6f20 7265 6164 206c 6173 6572  le to read laser
-00012120: 2074 656d 7065 7261 7475 7265 2229 0a20   temperature"). 
-00012130: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00012140: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-00012150: 7370 6f6e 7365 2830 290a 2020 2020 2020  sponse(0).      
-00012160: 2020 7265 7375 6c74 2e64 6174 6120 3d20    result.data = 
-00012170: 7265 7375 6c74 2e64 6174 6120 2620 3078  result.data & 0x
-00012180: 6666 660a 2020 2020 2020 2020 7265 7475  fff.        retu
-00012190: 726e 2072 6573 756c 740a 0a20 2020 2064  rn result..    d
-000121a0: 6566 2073 6574 5f73 656c 6563 7465 645f  ef set_selected_
-000121b0: 6c61 7365 7228 7365 6c66 2c20 7661 6c75  laser(self, valu
-000121c0: 653a 2069 6e74 2920 2d3e 2053 7065 6374  e: int) -> Spect
-000121d0: 726f 6d65 7465 7252 6573 706f 6e73 653a  rometerResponse:
-000121e0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000121f0: 2020 2020 204f 6e20 7370 6563 7472 6f6d       On spectrom
-00012200: 6574 6572 7320 7375 7070 6f72 7469 6e67  eters supporting
-00012210: 2074 776f 206c 6173 6572 732c 2073 656c   two lasers, sel
-00012220: 6563 7420 7468 6520 7072 696d 6172 7920  ect the primary 
-00012230: 2830 2920 6f72 0a20 2020 2020 2020 2073  (0) or.        s
-00012240: 6563 6f6e 6461 7279 2028 3129 2e20 204c  econdary (1).  L
-00012250: 6173 6572 2045 6e61 626c 652c 206c 6173  aser Enable, las
-00012260: 6572 2070 6f77 6572 2065 7463 2073 686f  er power etc sho
-00012270: 756c 6420 616c 6c20 7468 656e 0a20 2020  uld all then.   
-00012280: 2020 2020 2061 6666 6563 7420 7468 6520       affect the 
-00012290: 6375 7272 656e 746c 792d 7365 6c65 6374  currently-select
-000122a0: 6564 206c 6173 6572 2e0a 2020 2020 2020  ed laser..      
-000122b0: 2020 4077 6172 6e69 6e67 2063 6f6e 666c    @warning confl
-000122c0: 6963 7473 2077 6974 6820 4745 545f 5241  icts with GET_RA
-000122d0: 4d41 4e5f 4d4f 4445 5f45 4e41 424c 450a  MAN_MODE_ENABLE.
-000122e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000122f0: 2020 2020 6e20 3d20 3120 6966 2076 616c      n = 1 if val
-00012300: 7565 2065 6c73 6520 300a 0a20 2020 2020  ue else 0..     
-00012310: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
-00012320: 6574 7469 6e67 732e 6565 7072 6f6d 2e68  ettings.eeprom.h
-00012330: 6173 5f6c 6173 6572 3a0a 2020 2020 2020  as_laser:.      
-00012340: 2020 2020 2020 6c6f 672e 6572 726f 7228        log.error(
-00012350: 2275 6e61 626c 6520 746f 2063 6f6e 7472  "unable to contr
-00012360: 6f6c 206c 6173 6572 3a20 4545 5052 4f4d  ol laser: EEPROM
-00012370: 2072 6570 6f72 7473 206e 6f20 6c61 7365   reports no lase
-00012380: 7220 696e 7374 616c 6c65 6422 290a 2020  r installed").  
-00012390: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000123a0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-000123b0: 706f 6e73 6528 6461 7461 3d46 616c 7365  ponse(data=False
-000123c0: 2c65 7272 6f72 5f6d 7367 3d22 4e6f 206c  ,error_msg="No l
-000123d0: 6173 6572 2069 6e73 7461 6c6c 6572 2229  aser installer")
-000123e0: 0a0a 2020 2020 2020 2020 6c6f 672e 6465  ..        log.de
-000123f0: 6275 6728 2273 656c 6563 7469 6e67 206c  bug("selecting l
-00012400: 6173 6572 2025 6422 2c20 6e29 0a20 2020  aser %d", n).   
-00012410: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-00012420: 6773 2e73 7461 7465 2e73 656c 6563 7465  gs.state.selecte
-00012430: 645f 6c61 7365 7220 3d20 6e0a 0a20 2020  d_laser = n..   
-00012440: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00012450: 2e5f 7365 6e64 5f63 6f64 6528 6252 6571  ._send_code(bReq
-00012460: 7565 7374 2020 2020 2020 2020 3d20 3078  uest        = 0x
-00012470: 6666 2c0a 2020 2020 2020 2020 2020 2020  ff,.            
-00012480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012490: 2020 7756 616c 7565 2020 2020 2020 2020    wValue        
-000124a0: 2020 3d20 3078 3135 2c0a 2020 2020 2020    = 0x15,.      
-000124b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124c0: 2020 2020 2020 2020 7749 6e64 6578 2020          wIndex  
-000124d0: 2020 2020 2020 2020 3d20 6e2c 0a20 2020          = n,.   
-000124e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124f0: 2020 2020 2020 2020 2020 2064 6174 615f             data_
-00012500: 6f72 5f77 4c65 6e67 7468 203d 205b 305d  or_wLength = [0]
-00012510: 202a 2038 2c0a 2020 2020 2020 2020 2020   * 8,.          
-00012520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012530: 2020 2020 6c61 6265 6c20 2020 2020 2020      label       
-00012540: 2020 2020 3d20 2253 4554 5f53 454c 4543      = "SET_SELEC
-00012550: 5445 445f 4c41 5345 5222 290a 0a20 2020  TED_LASER")..   
-00012560: 2064 6566 2067 6574 5f73 656c 6563 7465   def get_selecte
-00012570: 645f 6c61 7365 7228 7365 6c66 2920 2d3e  d_laser(self) ->
-00012580: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-00012590: 706f 6e73 653a 0a20 2020 2020 2020 2072  ponse:.        r
-000125a0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-000125b0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-000125c0: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
-000125d0: 6174 652e 7365 6c65 6374 6564 5f6c 6173  ate.selected_las
-000125e0: 6572 290a 0a20 2020 2064 6566 2067 6574  er)..    def get
-000125f0: 5f6c 6173 6572 5f65 6e61 626c 6564 2873  _laser_enabled(s
-00012600: 656c 6629 202d 3e20 5370 6563 7472 6f6d  elf) -> Spectrom
-00012610: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-00012620: 2020 2020 2020 666c 6167 203d 2030 2021        flag = 0 !
-00012630: 3d20 7365 6c66 2e5f 6765 745f 636f 6465  = self._get_code
-00012640: 2830 7865 322c 206c 6162 656c 3d22 4745  (0xe2, label="GE
-00012650: 545f 4c41 5345 525f 454e 4142 4c45 4422  T_LASER_ENABLED"
-00012660: 2c20 6d73 625f 6c65 6e3d 3129 2e64 6174  , msb_len=1).dat
-00012670: 610a 2020 2020 2020 2020 6c6f 672e 6465  a.        log.de
-00012680: 6275 6728 2267 6574 5f6c 6173 6572 5f65  bug("get_laser_e
-00012690: 6e61 626c 6564 3a20 2573 222c 2066 6c61  nabled: %s", fla
-000126a0: 6729 0a20 2020 2020 2020 2073 656c 662e  g).        self.
-000126b0: 7365 7474 696e 6773 2e73 7461 7465 2e6c  settings.state.l
-000126c0: 6173 6572 5f65 6e61 626c 6564 203d 2066  aser_enabled = f
-000126d0: 6c61 670a 2020 2020 2020 2020 7265 7475  lag.        retu
-000126e0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-000126f0: 6573 706f 6e73 6528 6461 7461 3d66 6c61  esponse(data=fla
-00012700: 6729 0a0a 2020 2020 6465 6620 7365 745f  g)..    def set_
-00012710: 6c61 7365 725f 656e 6162 6c65 2873 656c  laser_enable(sel
-00012720: 662c 2066 6c61 673a 2062 6f6f 6c29 202d  f, flag: bool) -
-00012730: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
-00012740: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
-00012750: 2222 220a 2020 2020 2020 2020 5475 726e  """.        Turn
-00012760: 2074 6865 206c 6173 6572 206f 6e20 6f72   the laser on or
-00012770: 206f 6666 2e0a 2020 2020 2020 2020 4966   off..        If
-00012780: 206c 6173 6572 2070 6f77 6572 2068 6173   laser power has
-00012790: 6e27 7420 7965 7420 6265 656e 2065 7874  n't yet been ext
-000127a0: 6572 6e61 6c6c 7920 636f 6e66 6967 7572  ernally configur
-000127b0: 6564 2c20 6170 706c 6965 7320 7468 6520  ed, applies the 
-000127c0: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
-000127d0: 6f66 2066 756c 6c2d 706f 7765 722e 2020  of full-power.  
-000127e0: 5468 6520 6e65 7720 7374 6174 6520 7769  The new state wi
-000127f0: 6c6c 2062 6520 6170 706c 6965 6420 696d  ll be applied im
-00012800: 6d65 6469 6174 656c 792e 0a20 2020 2020  mediately..     
-00012810: 2020 2040 7061 7261 6d20 666c 6167 2028     @param flag (
-00012820: 496e 7075 7429 2062 6f6f 6c20 2854 7275  Input) bool (Tru
-00012830: 6520 7475 726e 7320 6c61 7365 7220 6f6e  e turns laser on
-00012840: 2c20 4661 6c73 6520 7475 726e 7320 6c61  , False turns la
-00012850: 7365 7220 6f66 6629 0a20 2020 2020 2020  ser off).       
-00012860: 2040 7265 7475 726e 7320 7768 6574 6865   @returns whethe
-00012870: 7220 7468 6520 6e65 7720 7374 6174 6520  r the new state 
-00012880: 7761 7320 6170 706c 6965 640a 2020 2020  was applied.    
-00012890: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000128a0: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
-000128b0: 696e 6773 2e65 6570 726f 6d2e 6861 735f  ings.eeprom.has_
-000128c0: 6c61 7365 723a 0a20 2020 2020 2020 2020  laser:.         
-000128d0: 2020 206c 6f67 2e65 7272 6f72 2822 756e     log.error("un
-000128e0: 6162 6c65 2074 6f20 636f 6e74 726f 6c20  able to control 
-000128f0: 6c61 7365 723a 2045 4550 524f 4d20 7265  laser: EEPROM re
-00012900: 706f 7274 7320 6e6f 206c 6173 6572 2069  ports no laser i
-00012910: 6e73 7461 6c6c 6564 2229 0a20 2020 2020  nstalled").     
-00012920: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
-00012930: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-00012940: 7365 2864 6174 613d 4661 6c73 652c 2065  se(data=False, e
-00012950: 7272 6f72 5f6d 7367 3d22 6e6f 206c 6173  rror_msg="no las
-00012960: 6572 2069 6e73 7461 6c6c 6564 2229 0a0a  er installed")..
-00012970: 2020 2020 2020 2020 2320 4152 4d20 7365          # ARM se
-00012980: 656d 7320 746f 2072 6571 7569 7265 2074  ems to require t
-00012990: 6861 7420 6c61 7365 7220 706f 7765 7220  hat laser power 
-000129a0: 6265 2073 6574 2062 6566 6f72 6520 7468  be set before th
-000129b0: 6520 6c61 7365 7220 6973 2065 6e61 626c  e laser is enabl
-000129c0: 6564 0a20 2020 2020 2020 2069 6620 7365  ed.        if se
-000129d0: 6c66 2e6e 6578 745f 6170 706c 6965 645f  lf.next_applied_
-000129e0: 6c61 7365 725f 706f 7765 7220 6973 204e  laser_power is N
-000129f0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00012a00: 2073 656c 662e 7365 745f 6c61 7365 725f   self.set_laser_
-00012a10: 706f 7765 725f 7065 7263 2831 3030 2e30  power_perc(100.0
-00012a20: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00012a30: 7365 7474 696e 6773 2e73 7461 7465 2e6c  settings.state.l
-00012a40: 6173 6572 5f65 6e61 626c 6564 203d 2066  aser_enabled = f
-00012a50: 6c61 670a 2020 2020 2020 2020 7365 6c66  lag.        self
-00012a60: 2e5f 7365 745f 6c61 7365 725f 656e 6162  ._set_laser_enab
-00012a70: 6c65 5f69 6d6d 6564 6961 7465 2866 6c61  le_immediate(fla
-00012a80: 6729 0a20 2020 2020 2020 2072 6574 7572  g).        retur
-00012a90: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-00012aa0: 7370 6f6e 7365 2864 6174 613d 5472 7565  sponse(data=True
-00012ab0: 290a 0a20 2020 2064 6566 2073 6574 5f6c  )..    def set_l
-00012ac0: 6173 6572 5f70 6f77 6572 5f72 616d 7069  aser_power_rampi
-00012ad0: 6e67 5f65 6e61 626c 6528 7365 6c66 2c20  ng_enable(self, 
-00012ae0: 666c 6167 3a20 626f 6f6c 2920 2d3e 2053  flag: bool) -> S
-00012af0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-00012b00: 6e73 653a 0a20 2020 2020 2020 206c 6f67  nse:.        log
-00012b10: 2e65 7272 6f72 2822 6c61 7365 7220 706f  .error("laser po
-00012b20: 7765 7220 7261 6d70 696e 6720 6861 7320  wer ramping has 
-00012b30: 6265 656e 2064 6570 7265 6361 7465 6422  been deprecated"
-00012b40: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00012b50: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-00012b60: 706f 6e73 6528 6461 7461 3d46 616c 7365  ponse(data=False
-00012b70: 290a 0a20 2020 2064 6566 2067 6574 5f6c  )..    def get_l
-00012b80: 6173 6572 5f70 6f77 6572 5f72 616d 7069  aser_power_rampi
-00012b90: 6e67 5f65 6e61 626c 6564 2873 656c 6629  ng_enabled(self)
-00012ba0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-00012bb0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00012bc0: 2020 2020 6465 6620 5f73 6574 5f6c 6173      def _set_las
-00012bd0: 6572 5f65 6e61 626c 655f 696d 6d65 6469  er_enable_immedi
-00012be0: 6174 6528 7365 6c66 2c20 666c 6167 3a20  ate(self, flag: 
-00012bf0: 626f 6f6c 2920 2d3e 2053 7065 6374 726f  bool) -> Spectro
-00012c00: 6d65 7465 7252 6573 706f 6e73 653a 0a20  meterResponse:. 
-00012c10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00012c20: 2020 2054 6865 2075 7365 7220 6861 7320     The user has 
-00012c30: 7265 7175 6573 7465 6420 746f 2075 7064  requested to upd
-00012c40: 6174 6520 7468 6520 6c61 7365 7220 6669  ate the laser fi
-00012c50: 7269 6e67 2073 7461 7465 2028 6f6e 206f  ring state (on o
-00012c60: 7220 6f66 6629 2c0a 2020 2020 2020 2020  r off),.        
-00012c70: 736f 2061 7070 6c79 2074 6865 206e 6577  so apply the new
-00012c80: 206c 6173 6572 2073 7461 7465 2074 6f20   laser state to 
-00012c90: 7468 6520 7370 6563 7472 6f6d 6574 6572  the spectrometer
-00012ca0: 2069 6d6d 6564 6961 7465 6c79 2e0a 2020   immediately..  
-00012cb0: 2020 2020 2020 4265 6361 7573 6520 7468        Because th
-00012cc0: 6520 6162 696c 6974 7920 746f 2069 6d6d  e ability to imm
-00012cd0: 6564 6961 7465 6c79 2064 6973 6162 6c65  ediately disable
-00012ce0: 2061 206c 6173 6572 2069 7320 6120 7361   a laser is a sa
-00012cf0: 6665 7479 2d72 656c 6174 6564 0a20 2020  fety-related.   
-00012d00: 2020 2020 2066 6561 7475 7265 2028 6e6f       feature (no
-00012d10: 7469 6e67 2074 6861 7420 7472 756c 7920  ting that truly 
-00012d20: 7361 6665 7479 2d63 7269 7469 6361 6c20  safety-critical 
-00012d30: 6361 7061 6269 6c69 7469 6573 2073 686f  capabilities sho
-00012d40: 756c 6420 6265 0a20 2020 2020 2020 2069  uld be.        i
-00012d50: 6d70 6c65 6d65 6e74 6564 2069 6e20 6861  mplemented in ha
-00012d60: 7264 7761 7265 2c20 616e 6420 6765 6e65  rdware, and gene
-00012d70: 7261 6c6c 7920 6361 6e27 7420 6265 2072  rally can't be r
-00012d80: 6f62 7573 746c 7920 6163 6869 6576 6564  obustly achieved
-00012d90: 2074 6872 6f75 6768 0a20 2020 2020 2020   through.       
-00012da0: 2050 7974 686f 6e20 7363 7269 7074 7329   Python scripts)
-00012db0: 2c20 7468 6973 2066 756e 6374 696f 6e20  , this function 
-00012dc0: 7461 6b65 7320 7468 6520 756e 7573 7561  takes the unusua
-00012dd0: 6c20 7374 6570 206f 6620 6c6f 6f70 696e  l step of loopin
-00012de0: 6720 6f76 6572 0a20 2020 2020 2020 206d  g over.        m
-00012df0: 756c 7469 706c 6520 6174 7465 6d70 7473  ultiple attempts
-00012e00: 2074 6f20 7365 7420 7468 6520 6c61 7365   to set the lase
-00012e10: 7220 7374 6174 6520 756e 7469 6c20 6569  r state until ei
-00012e20: 7468 6572 2074 6865 2063 6f6d 6d61 6e64  ther the command
-00012e30: 2073 7563 6365 6564 732c 0a20 2020 2020   succeeds,.     
-00012e40: 2020 206f 7220 3320 636f 6e73 6563 7574     or 3 consecut
-00012e50: 6976 6520 6661 696c 7572 6573 2068 6176  ive failures hav
-00012e60: 6520 6f63 6375 7265 642e 0a20 2020 2020  e occured..     
-00012e70: 2020 2054 6869 7320 6265 6861 7669 6f72     This behavior
-00012e80: 2077 6173 2061 6464 6564 2061 6674 6572   was added after
-00012e90: 2061 2064 6576 656c 6f70 6d65 6e74 616c   a developmental
-00012ea0: 2c20 756e 7265 6c65 6173 6564 2070 726f  , unreleased pro
-00012eb0: 746f 7479 7065 2077 6173 0a20 2020 2020  totype was.     
-00012ec0: 2020 2066 6f75 6e64 2074 6f20 6f63 6361     found to occa
-00012ed0: 7369 6f6e 616c 6c79 2064 726f 7020 5553  sionally drop US
-00012ee0: 4220 7061 636b 6574 732c 2061 6e64 2077  B packets, and w
-00012ef0: 6173 2074 6865 7265 666f 7265 2073 7573  as therefore sus
-00012f00: 6365 7074 6962 6c65 2074 6f0a 2020 2020  ceptible to.    
-00012f10: 2020 2020 696e 6164 7665 7274 656e 746c      inadvertentl
-00012f20: 7920 6661 696c 696e 6720 746f 2064 6973  y failing to dis
-00012f30: 6162 6c65 2074 6865 206c 6173 6572 2075  able the laser u
-00012f40: 706f 6e20 636f 6d6d 616e 642e 0a20 2020  pon command..   
-00012f50: 2020 2020 2040 7072 6976 6174 6520 2861       @private (a
-00012f60: 7320 6361 6c6c 6572 7320 6172 6520 7265  s callers are re
-00012f70: 636f 6d6d 656e 6465 6420 746f 2075 7365  commended to use
-00012f80: 2073 6574 5f6c 6173 6572 5f65 6e61 626c   set_laser_enabl
-00012f90: 6529 0a20 2020 2020 2020 2040 7061 7261  e).        @para
-00012fa0: 6d20 666c 6167 2028 496e 7075 7429 2077  m flag (Input) w
-00012fb0: 6865 7468 6572 2074 6865 206c 6173 6572  hether the laser
-00012fc0: 2073 686f 756c 6420 6265 206f 6e20 2874   should be on (t
-00012fd0: 7275 6529 206f 7220 6f66 6620 2866 616c  rue) or off (fal
-00012fe0: 7365 290a 2020 2020 2020 2020 4072 6574  se).        @ret
-00012ff0: 7572 6e73 2074 7275 6520 6966 206e 6577  urns true if new
-00013000: 2073 7461 7465 2077 6173 2073 7563 6365   state was succe
-00013010: 7373 6675 6c6c 7920 6170 706c 6965 640a  ssfully applied.
-00013020: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00013030: 2020 2020 6c6f 672e 6465 6275 6728 2253      log.debug("S
-00013040: 656e 6420 6c61 7365 7220 656e 6162 6c65  end laser enable
-00013050: 3a20 2573 222c 2066 6c61 6729 0a20 2020  : %s", flag).   
-00013060: 2020 2020 2069 6620 666c 6167 3a0a 2020       if flag:.  
-00013070: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-00013080: 6173 745f 6170 706c 6965 645f 6c61 7365  ast_applied_lase
-00013090: 725f 706f 7765 7220 3d20 302e 300a 2020  r_power = 0.0.  
-000130a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000130b0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-000130c0: 745f 6170 706c 6965 645f 6c61 7365 725f  t_applied_laser_
-000130d0: 706f 7765 7220 3d20 7365 6c66 2e6e 6578  power = self.nex
-000130e0: 745f 6170 706c 6965 645f 6c61 7365 725f  t_applied_laser_
-000130f0: 706f 7765 720a 0a20 2020 2020 2020 2074  power..        t
-00013100: 7269 6573 203d 2030 0a20 2020 2020 2020  ries = 0.       
-00013110: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
-00013120: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
-00013130: 745f 7374 726f 6265 5f65 6e61 626c 6528  t_strobe_enable(
-00013140: 666c 6167 290a 2020 2020 2020 2020 2020  flag).          
-00013150: 2020 7265 7320 3d20 7365 6c66 2e67 6574    res = self.get
-00013160: 5f6c 6173 6572 5f65 6e61 626c 6564 2829  _laser_enabled()
-00013170: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013180: 666c 6167 203d 3d20 7265 732e 6461 7461  flag == res.data
-00013190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000131a0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-000131b0: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-000131c0: 7461 3d54 7275 6529 0a20 2020 2020 2020  ta=True).       
-000131d0: 2020 2020 2074 7269 6573 202b 3d20 310a       tries += 1.
-000131e0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-000131f0: 7269 6573 203e 2033 3a0a 2020 2020 2020  ries > 3:.      
-00013200: 2020 2020 2020 2020 2020 6c6f 672e 6372            log.cr
-00013210: 6974 6963 616c 2822 6c61 7365 725f 656e  itical("laser_en
-00013220: 6162 6c65 2025 7320 636f 6d6d 616e 6420  able %s command 
-00013230: 6661 696c 6564 2c20 6769 7669 6e67 2075  failed, giving u
-00013240: 7022 2c20 666c 6167 290a 2020 2020 2020  p", flag).      
-00013250: 2020 2020 2020 2020 2020 7365 6c66 2e71            self.q
-00013260: 7565 7565 5f6d 6573 7361 6765 2822 6d61  ueue_message("ma
-00013270: 7271 7565 655f 6572 726f 7222 2c20 226c  rquee_error", "l
-00013280: 6173 6572 2073 6574 7469 6e67 2066 6169  aser setting fai
-00013290: 6c65 6422 290a 2020 2020 2020 2020 2020  led").          
-000132a0: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
-000132b0: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-000132c0: 6528 6461 7461 3d46 616c 7365 2c65 7272  e(data=False,err
-000132d0: 6f72 5f6d 7367 3d22 6c61 7365 7220 7365  or_msg="laser se
-000132e0: 7474 696e 6720 6661 696c 6564 222c 6572  tting failed",er
-000132f0: 726f 725f 6c76 6c3d 4572 726f 724c 6576  ror_lvl=ErrorLev
-00013300: 656c 2e6d 6564 6975 6d29 0a20 2020 2020  el.medium).     
-00013310: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013320: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00013330: 2e65 7272 6f72 2822 6c61 7365 725f 656e  .error("laser_en
-00013340: 6162 6c65 2025 7320 636f 6d6d 616e 6420  able %s command 
-00013350: 6661 696c 6564 2c20 7265 2d74 7279 696e  failed, re-tryin
-00013360: 6722 2c20 666c 6167 290a 0a20 2020 2064  g", flag)..    d
-00013370: 6566 2068 6173 5f6c 6173 6572 5f70 6f77  ef has_laser_pow
-00013380: 6572 5f63 616c 6962 7261 7469 6f6e 2873  er_calibration(s
-00013390: 656c 6629 202d 3e20 5370 6563 7472 6f6d  elf) -> Spectrom
-000133a0: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-000133b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000133c0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-000133d0: 6d2e 6861 735f 6c61 7365 725f 706f 7765  m.has_laser_powe
-000133e0: 725f 6361 6c69 6272 6174 696f 6e28 290a  r_calibration().
-000133f0: 0a20 2020 2064 6566 2073 6574 5f6c 6173  .    def set_las
-00013400: 6572 5f70 6f77 6572 5f6d 5728 7365 6c66  er_power_mW(self
-00013410: 2c20 6d57 5f69 6e3a 2069 6e74 2920 2d3e  , mW_in: int) ->
-00013420: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-00013430: 706f 6e73 653a 0a20 2020 2020 2020 2069  ponse:.        i
-00013440: 6620 6d57 5f69 6e20 6973 204e 6f6e 6520  f mW_in is None 
-00013450: 6f72 206e 6f74 2073 656c 662e 6861 735f  or not self.has_
-00013460: 6c61 7365 725f 706f 7765 725f 6361 6c69  laser_power_cali
-00013470: 6272 6174 696f 6e28 293a 0a20 2020 2020  bration():.     
-00013480: 2020 2020 2020 206c 6f67 2e65 7272 6f72         log.error
-00013490: 2822 4545 5052 4f4d 2064 6f65 736e 2774  ("EEPROM doesn't
-000134a0: 2068 6176 6520 6c61 7365 7220 706f 7765   have laser powe
-000134b0: 7220 6361 6c69 6272 6174 696f 6e22 290a  r calibration").
-000134c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000134d0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
-000134e0: 6c61 7365 725f 706f 7765 725f 6d57 203d  laser_power_mW =
-000134f0: 2030 0a20 2020 2020 2020 2020 2020 2073   0.            s
-00013500: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
-00013510: 7465 2e6c 6173 6572 5f70 6f77 6572 5f70  te.laser_power_p
-00013520: 6572 6320 3d20 300a 2020 2020 2020 2020  erc = 0.        
-00013530: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
-00013540: 732e 7374 6174 652e 7573 655f 6d57 203d  s.state.use_mW =
-00013550: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-00013560: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-00013570: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-00013580: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
-00013590: 6d73 673d 226e 6f20 6c61 7365 7220 706f  msg="no laser po
-000135a0: 7765 7220 6361 6c69 6272 6174 696f 6e22  wer calibration"
-000135b0: 290a 0a20 2020 2020 2020 206d 5720 3d20  )..        mW = 
-000135c0: 6d69 6e28 7365 6c66 2e73 6574 7469 6e67  min(self.setting
-000135d0: 732e 6565 7072 6f6d 2e6d 6178 5f6c 6173  s.eeprom.max_las
-000135e0: 6572 5f70 6f77 6572 5f6d 572c 206d 6178  er_power_mW, max
-000135f0: 2873 656c 662e 7365 7474 696e 6773 2e65  (self.settings.e
-00013600: 6570 726f 6d2e 6d69 6e5f 6c61 7365 725f  eprom.min_laser_
-00013610: 706f 7765 725f 6d57 2c20 6d57 5f69 6e29  power_mW, mW_in)
-00013620: 290a 0a20 2020 2020 2020 2070 6572 6320  )..        perc 
-00013630: 3d20 7365 6c66 2e73 6574 7469 6e67 732e  = self.settings.
-00013640: 6565 7072 6f6d 2e6c 6173 6572 5f70 6f77  eeprom.laser_pow
-00013650: 6572 5f6d 575f 746f 5f70 6572 6365 6e74  er_mW_to_percent
-00013660: 286d 5729 0a20 2020 2020 2020 206c 6f67  (mW).        log
-00013670: 2e64 6562 7567 2822 7365 745f 6c61 7365  .debug("set_lase
-00013680: 725f 706f 7765 725f 6d57 3a20 7261 6e67  r_power_mW: rang
-00013690: 6520 2825 2e32 662c 2025 2e32 6629 2c20  e (%.2f, %.2f), 
-000136a0: 7265 7175 6573 7465 6420 252e 3266 2c20  requested %.2f, 
-000136b0: 6170 7072 6f76 6564 2025 2e32 662c 2070  approved %.2f, p
-000136c0: 6572 6365 6e74 203d 2025 2e32 6622 2c0a  ercent = %.2f",.
-000136d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000136e0: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
-000136f0: 2e6d 696e 5f6c 6173 6572 5f70 6f77 6572  .min_laser_power
-00013700: 5f6d 572c 0a20 2020 2020 2020 2020 2020  _mW,.           
-00013710: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-00013720: 6570 726f 6d2e 6d61 785f 6c61 7365 725f  eprom.max_laser_
-00013730: 706f 7765 725f 6d57 2c0a 2020 2020 2020  power_mW,.      
-00013740: 2020 2020 2020 6d57 5f69 6e2c 0a20 2020        mW_in,.   
-00013750: 2020 2020 2020 2020 206d 572c 0a20 2020           mW,.   
-00013760: 2020 2020 2020 2020 2070 6572 6329 0a20           perc). 
-00013770: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
-00013780: 696e 6773 2e73 7461 7465 2e6c 6173 6572  ings.state.laser
-00013790: 5f70 6f77 6572 5f6d 5720 3d20 6d57 0a20  _power_mW = mW. 
-000137a0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000137b0: 6c66 2e73 6574 5f6c 6173 6572 5f70 6f77  lf.set_laser_pow
-000137c0: 6572 5f70 6572 6328 7065 7263 2c20 7365  er_perc(perc, se
-000137d0: 745f 696e 5f70 6572 633d 4661 6c73 6529  t_in_perc=False)
-000137e0: 0a0a 2020 2020 6465 6620 7365 745f 6c61  ..    def set_la
-000137f0: 7365 725f 706f 7765 725f 6869 6768 5f72  ser_power_high_r
-00013800: 6573 6f6c 7574 696f 6e28 7365 6c66 2c20  esolution(self, 
-00013810: 666c 6167 3a20 626f 6f6c 2920 2d3e 2053  flag: bool) -> S
-00013820: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-00013830: 6e73 653a 0a20 2020 2020 2020 2073 656c  nse:.        sel
-00013840: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-00013850: 2e6c 6173 6572 5f70 6f77 6572 5f68 6967  .laser_power_hig
-00013860: 685f 7265 736f 6c75 7469 6f6e 203d 2054  h_resolution = T
-00013870: 7275 6520 6966 2066 6c61 6720 656c 7365  rue if flag else
-00013880: 2046 616c 7365 0a20 2020 2020 2020 2072   False.        r
-00013890: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-000138a0: 6572 5265 7370 6f6e 7365 2829 0a0a 2020  erResponse()..  
-000138b0: 2020 6465 6620 7365 745f 6c61 7365 725f    def set_laser_
-000138c0: 706f 7765 725f 7265 7175 6972 655f 6d6f  power_require_mo
-000138d0: 6475 6c61 7469 6f6e 2873 656c 662c 2066  dulation(self, f
-000138e0: 6c61 673a 2062 6f6f 6c29 202d 3e20 5370  lag: bool) -> Sp
-000138f0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-00013900: 7365 3a0a 2020 2020 2020 2020 7365 6c66  se:.        self
-00013910: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
-00013920: 6c61 7365 725f 706f 7765 725f 7265 7175  laser_power_requ
-00013930: 6972 655f 6d6f 6475 6c61 7469 6f6e 203d  ire_modulation =
-00013940: 2054 7275 6520 6966 2066 6c61 6720 656c   True if flag el
-00013950: 7365 2046 616c 7365 0a20 2020 2020 2020  se False.       
-00013960: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-00013970: 6574 6572 5265 7370 6f6e 7365 2829 0a0a  eterResponse()..
-00013980: 2020 2020 2323 0a20 2020 2023 2040 746f      ##.    # @to
-00013990: 646f 2073 7570 706f 7274 2066 6c6f 6174  do support float
-000139a0: 696e 672d 706f 696e 7420 7661 6c75 652c  ing-point value,
-000139b0: 2061 7320 7765 2068 6176 6520 6120 3132   as we have a 12
-000139c0: 2d62 6974 2041 4443 2061 6e64 2063 616e  -bit ADC and can
-000139d0: 2070 726f 7669 6465 0a20 2020 2023 2061   provide.    # a
-000139e0: 2062 6974 206d 6f72 6520 7072 6563 6973   bit more precis
-000139f0: 696f 6e20 7468 616e 2031 3030 2064 6973  ion than 100 dis
-00013a00: 6372 6574 6520 7374 6570 7320 2867 6f61  crete steps (goa
-00013a10: 6c20 746f 2073 7570 706f 7274 2030 2e31  l to support 0.1
-00013a20: 202d 202e 3132 3525 2072 6573 6f6c 7574   - .125% resolut
-00013a30: 696f 6e29 0a20 2020 2064 6566 2073 6574  ion).    def set
-00013a40: 5f6c 6173 6572 5f70 6f77 6572 5f70 6572  _laser_power_per
-00013a50: 6328 7365 6c66 2c20 7661 6c75 655f 696e  c(self, value_in
-00013a60: 3a20 666c 6f61 742c 2073 6574 5f69 6e5f  : float, set_in_
-00013a70: 7065 7263 3a20 626f 6f6c 203d 2054 7275  perc: bool = Tru
-00013a80: 6529 202d 3e20 5370 6563 7472 6f6d 6574  e) -> Spectromet
-00013a90: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-00013aa0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00013ab0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
-00013ac0: 6861 735f 6c61 7365 723a 0a20 2020 2020  has_laser:.     
-00013ad0: 2020 2020 2020 206c 6f67 2e65 7272 6f72         log.error
-00013ae0: 2822 756e 6162 6c65 2074 6f20 636f 6e74  ("unable to cont
-00013af0: 726f 6c20 6c61 7365 723a 2045 4550 524f  rol laser: EEPRO
-00013b00: 4d20 7265 706f 7274 7320 6e6f 206c 6173  M reports no las
-00013b10: 6572 2069 6e73 7461 6c6c 6564 2229 0a20  er installed"). 
-00013b20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013b30: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-00013b40: 7370 6f6e 7365 2864 6174 613d 4661 6c73  sponse(data=Fals
-00013b50: 652c 6572 726f 725f 6d73 673d 226e 6f20  e,error_msg="no 
-00013b60: 6c61 7365 7220 696e 7374 616c 6c65 6422  laser installed"
-00013b70: 290a 0a20 2020 2020 2020 2076 616c 7565  )..        value
-00013b80: 203d 2066 6c6f 6174 286d 6178 2830 2c20   = float(max(0, 
-00013b90: 6d69 6e28 3130 302c 2076 616c 7565 5f69  min(100, value_i
-00013ba0: 6e29 2929 0a20 2020 2020 2020 2073 656c  n))).        sel
-00013bb0: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-00013bc0: 2e6c 6173 6572 5f70 6f77 6572 5f70 6572  .laser_power_per
-00013bd0: 6320 3d20 7661 6c75 650a 2020 2020 2020  c = value.      
-00013be0: 2020 6c6f 672e 6465 6275 6728 2273 6574    log.debug("set
-00013bf0: 5f6c 6173 6572 5f70 6f77 6572 5f70 6572  _laser_power_per
-00013c00: 633a 2072 616e 6765 2028 302c 2031 3030  c: range (0, 100
-00013c10: 292c 2072 6571 7565 7374 6564 2025 2e32  ), requested %.2
-00013c20: 662c 2061 7070 6c79 696e 6720 252e 3266  f, applying %.2f
-00013c30: 222c 2076 616c 7565 5f69 6e2c 2076 616c  ", value_in, val
-00013c40: 7565 290a 0a20 2020 2020 2020 2069 6620  ue)..        if 
-00013c50: 7365 745f 696e 5f70 6572 633a 0a20 2020  set_in_perc:.   
-00013c60: 2020 2020 2020 2020 2023 2061 7070 6172           # appar
-00013c70: 656e 746c 7920 7468 6520 6c61 7365 7220  ently the laser 
-00013c80: 706f 7765 7220 7761 7320 6578 706c 6963  power was explic
-00013c90: 6974 6c79 2063 6f6d 6d61 6e64 6564 2061  itly commanded a
-00013ca0: 7320 6120 7065 7263 656e 7461 6765 0a20  s a percentage. 
-00013cb0: 2020 2020 2020 2020 2020 2023 206f 6620             # of 
-00013cc0: 6675 6c6c 2c20 616e 6420 6e6f 7420 2263  full, and not "c
-00013cd0: 6f6d 7075 7465 6420 6672 6f6d 206d 5722  omputed from mW"
-00013ce0: 2075 7369 6e67 2061 2063 616c 6962 7261   using a calibra
-00013cf0: 7469 6f6e 2c20 736f 2063 6c65 6172 0a20  tion, so clear. 
-00013d00: 2020 2020 2020 2020 2020 2023 2074 6865             # the
-00013d10: 206d 5720 7365 7470 6f69 6e74 0a20 2020   mW setpoint.   
-00013d20: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
-00013d30: 7474 696e 6773 2e73 7461 7465 2e6c 6173  ttings.state.las
-00013d40: 6572 5f70 6f77 6572 5f6d 5720 3d20 300a  er_power_mW = 0.
-00013d50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00013d60: 7365 6c66 2e73 6574 5f6c 6173 6572 5f70  self.set_laser_p
-00013d70: 6f77 6572 5f70 6572 635f 696d 6d65 6469  ower_perc_immedi
-00013d80: 6174 6528 7661 6c75 6529 0a0a 2020 2020  ate(value)..    
-00013d90: 2323 0a20 2020 2023 2053 6574 7320 6c61  ##.    # Sets la
-00013da0: 7365 7220 706f 7765 7220 286d 6f64 756c  ser power (modul
-00013db0: 6174 6564 2070 756c 7365 2077 6964 7468  ated pulse width
-00013dc0: 2920 7768 6963 6820 7769 6c6c 2062 6520  ) which will be 
-00013dd0: 7573 6564 206e 6578 7420 7469 6d65 2074  used next time t
-00013de0: 6865 0a20 2020 2023 206c 6173 6572 2069  he.    # laser i
-00013df0: 7320 7475 726e 6564 206f 6e20 286f 7220  s turned on (or 
-00013e00: 6368 616e 6765 6420 696d 6d65 6469 6174  changed immediat
-00013e10: 656c 792c 2069 6620 7468 6520 6c61 7365  ely, if the lase
-00013e20: 7220 6973 2061 6c72 6561 6479 2065 6e61  r is already ena
-00013e30: 626c 6564 292e 0a20 2020 2023 204c 6173  bled)..    # Las
-00013e40: 6572 2070 6f77 6572 2069 7320 6465 7465  er power is dete
-00013e50: 726d 696e 6564 2062 7920 6120 636f 6d62  rmined by a comb
-00013e60: 696e 6174 696f 6e20 6f66 2074 6865 2070  ination of the p
-00013e70: 756c 7365 2077 6964 7468 2c0a 2020 2020  ulse width,.    
-00013e80: 2320 7065 7269 6f64 2061 6e64 206d 6f64  # period and mod
-00013e90: 756c 6174 696f 6e20 6265 696e 6720 656e  ulation being en
-00013ea0: 6162 6c65 642e 2054 6865 7265 2061 7265  abled. There are
-00013eb0: 206d 616e 7920 636f 6d62 696e 6174 696f   many combinatio
-00013ec0: 6e73 206f 660a 2020 2020 2320 7468 6573  ns of.    # thes
-00013ed0: 6520 7661 6c75 6573 2074 6861 7420 7769  e values that wi
-00013ee0: 6c6c 2070 726f 6475 6365 2061 2067 6976  ll produce a giv
-00013ef0: 656e 2070 6572 6365 6e74 6167 6520 6f66  en percentage of
-00013f00: 2074 6865 2074 6f74 616c 206c 6173 6572   the total laser
-00013f10: 0a20 2020 2023 2070 6f77 6572 2074 6872  .    # power thr
-00013f20: 6f75 6768 2070 756c 7365 2077 6964 7468  ough pulse width
-00013f30: 206d 6f64 756c 6174 696f 6e2e 2054 6865   modulation. The
-00013f40: 7265 2069 7320 6e6f 2027 6765 7420 6c61  re is no 'get la
-00013f50: 7365 7220 706f 7765 7227 0a20 2020 2023  ser power'.    #
-00013f60: 2063 6f6e 7472 6f6c 206d 6573 7361 6765   control message
-00013f70: 206f 6e20 7468 6520 6465 7669 6365 2e0a   on the device..
-00013f80: 2020 2020 230a 2020 2020 2320 536f 6d65      #.    # Some
-00013f90: 206f 6620 7468 6520 676f 616c 7320 6f66   of the goals of
-00013fa0: 2045 6e6c 6967 6874 656e 2061 7265 2066   Enlighten are f
-00013fb0: 6f72 2069 7420 746f 2062 6520 7374 6162  or it to be stab
-00013fc0: 6c65 2c20 616e 6420 6120 7265 6173 6f6e  le, and a reason
-00013fd0: 0a20 2020 2023 2077 6520 6861 7665 2073  .    # we have s
-00013fe0: 616c 6573 2e20 4475 7269 6e67 2073 7065  ales. During spe
-00013ff0: 6374 726f 6d65 7465 7220 6275 696c 6473  ctrometer builds
-00014000: 2c20 6974 2077 6173 2064 6973 636f 7665  , it was discove
-00014010: 7265 6420 7468 6174 0a20 2020 2023 2074  red that.    # t
-00014020: 6865 206c 6173 6572 2070 6f77 6572 2073  he laser power s
-00014030: 6574 7469 6e67 7320 7765 7265 206e 6f74  ettings were not
-00014040: 2069 6d70 6c65 6d65 6e74 6564 2e20 4475   implemented. Du
-00014050: 7269 6e67 2074 6865 0a20 2020 2023 2069  ring the.    # i
-00014060: 6d70 6c65 6d65 6e74 6174 696f 6e20 7072  mplementation pr
-00014070: 6f63 6573 732c 2069 7420 7761 7320 6469  ocess, it was di
-00014080: 7363 6f76 6572 6564 2074 6861 7420 7468  scovered that th
-00014090: 6520 6c61 7365 7220 6d6f 6475 6c61 7469  e laser modulati
-000140a0: 6f6e 2c0a 2020 2020 2320 7075 6c73 6520  on,.    # pulse 
-000140b0: 7065 7269 6f64 2061 6e64 2070 756c 7365  period and pulse
-000140c0: 2077 6964 7468 2063 6f6d 6d61 6e64 7320   width commands 
-000140d0: 646f 206e 6f74 2063 6f6e 666f 726d 2074  do not conform t
-000140e0: 6f0a 2020 2020 2320 7370 6563 6966 6963  o.    # specific
-000140f0: 6174 696f 6e2e 2057 6865 7265 2079 6f75  ation. Where you
-00014100: 2063 616e 2073 6574 2069 6e74 6567 7261   can set integra
-00014110: 7469 6f6e 2074 696d 6520 3130 3020 6d73  tion time 100 ms
-00014120: 2077 6974 6820 7468 650a 2020 2020 2320   with the.    # 
-00014130: 636f 6d6d 616e 643a 0a20 2020 2023 0a20  command:.    #. 
-00014140: 2020 2023 2064 6576 6963 652e 6374 726c     # device.ctrl
-00014150: 5f74 7261 6e73 6665 7228 626d 5265 7175  _transfer(bmRequ
-00014160: 6573 7454 7970 653d 6465 7669 6365 5f74  estType=device_t
-00014170: 6f5f 686f 7374 2c0a 2020 2020 2320 2020  o_host,.    #   
-00014180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014190: 2020 2062 5265 7175 6573 743d 3078 4442     bRequest=0xDB
-000141a0: 2c0a 2020 2020 2320 2020 2020 2020 2020  ,.    #         
-000141b0: 2020 2020 2020 2020 2020 2020 2077 5661               wVa
-000141c0: 6c75 653d 3130 302c 0a20 2020 2023 2020  lue=100,.    #  
-000141d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141e0: 2020 2020 7749 6e64 6578 3d30 2c0a 2020      wIndex=0,.  
-000141f0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-00014200: 2020 2020 2020 2020 2064 6174 615f 6f72           data_or
-00014210: 5f77 4c65 6e67 7468 3d30 290a 2020 2020  _wLength=0).    
-00014220: 230a 2020 2020 2320 5468 6520 6c61 7365  #.    # The lase
-00014230: 7220 7075 6c73 6520 7065 7269 6f64 206d  r pulse period m
-00014240: 7573 7420 6265 2073 6574 2077 6865 7265  ust be set where
-00014250: 2074 6865 2077 5661 6c75 6520 616e 640a   the wValue and.
-00014260: 2020 2020 2320 6461 7461 5f6f 725f 774c      # data_or_wL
-00014270: 656e 6774 6820 7061 7261 6d65 7465 7273  ength parameters
-00014280: 2061 7265 2065 7175 616c 2e20 536f 2069   are equal. So i
-00014290: 6620 796f 7520 7761 6e74 6564 2061 2070  f you wanted a p
-000142a0: 756c 7365 0a20 2020 2023 2070 6572 696f  ulse.    # perio
-000142b0: 6420 6f66 2031 3030 2c20 796f 7520 6d75  d of 100, you mu
-000142c0: 7374 2073 7065 6369 6679 2074 6865 2076  st specify the v
-000142d0: 616c 7565 2069 6e20 626f 7468 2070 6c61  alue in both pla
-000142e0: 6365 733a 0a20 2020 2023 0a20 2020 2023  ces:.    #.    #
-000142f0: 202e 2e2e 0a20 2020 2023 2020 2020 2020   ....    #      
-00014300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014310: 7756 616c 7565 3d31 3030 2c0a 2020 2020  wValue=100,.    
-00014320: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00014330: 2020 2020 2020 2064 6174 615f 6f72 5f77         data_or_w
-00014340: 4c65 6e67 7468 3d31 3030 290a 2020 2020  Length=100).    
-00014350: 2320 2e2e 2e0a 2020 2020 230a 2020 2020  # ....    #.    
-00014360: 2320 5468 6973 2069 6e20 7475 726e 2069  # This in turn i
-00014370: 6d70 6c69 6573 2074 6861 7420 7468 6520  mplies that the 
-00014380: 6c65 6761 6379 2066 6972 6d77 6172 6520  legacy firmware 
-00014390: 6861 7320 6120 6c6f 6e67 206d 6173 6b65  has a long maske
-000143a0: 640a 2020 2020 2320 6973 7375 6520 7768  d.    # issue wh
-000143b0: 656e 2072 6561 6469 6e67 2074 6865 2076  en reading the v
-000143c0: 616c 7565 2074 6f20 7570 6461 7465 2066  alue to update f
-000143d0: 726f 6d20 7468 6520 6461 7461 5f6f 725f  rom the data_or_
-000143e0: 774c 656e 6774 680a 2020 2020 2320 7061  wLength.    # pa
-000143f0: 7261 6d65 7465 7220 696e 7374 6561 6420  rameter instead 
-00014400: 6f66 2074 6865 2077 5661 6c75 6520 6669  of the wValue fi
-00014410: 656c 642e 2054 6869 7320 6973 206f 6e6c  eld. This is onl
-00014420: 7920 6163 6375 7261 7465 2066 6f72 2074  y accurate for t
-00014430: 6865 0a20 2020 2023 206c 6173 6572 206d  he.    # laser m
-00014440: 6f64 756c 6174 696f 6e20 7265 6c61 7465  odulation relate
-00014450: 6420 6675 6e63 7469 6f6e 732e 0a20 2020  d functions..   
-00014460: 2023 0a20 2020 2023 2054 6869 7320 6973   #.    # This is
-00014470: 2062 6163 6b65 6420 7570 2062 7920 7468   backed up by th
-00014480: 6520 4461 7368 2076 3320 5374 726f 6b65  e Dash v3 Stroke
-00014490: 7243 6f6e 7472 6f6c 2044 4c4c 2069 6d70  rControl DLL imp
-000144a0: 6c65 6d65 6e74 6174 696f 6e2e 0a20 2020  lementation..   
-000144b0: 2023 2049 7420 7761 7320 6469 7363 6f76   # It was discov
-000144c0: 6572 6564 2074 6861 7420 7468 6520 5374  ered that the St
-000144d0: 726f 6b65 7243 6f6e 7472 6f6c 2044 4c4c  rokerControl DLL
-000144e0: 2073 6574 7320 7468 6520 7756 616c 7565   sets the wValue
-000144f0: 2061 6e64 0a20 2020 2023 2064 6174 6120   and.    # data 
-00014500: 6f72 2077 4c65 6e67 7468 2070 6172 616d  or wLength param
-00014510: 6574 6572 7320 746f 2074 6865 2073 616d  eters to the sam
-00014520: 6520 7661 6c75 6520 6174 2065 7665 7279  e value at every
-00014530: 2063 6f6e 7472 6f6c 0a20 2020 2023 206d   control.    # m
-00014540: 6573 7361 6765 2077 7269 7465 2e0a 2020  essage write..  
-00014550: 2020 230a 2020 2020 2320 5468 6520 6578    #.    # The ex
-00014560: 6369 7469 6e67 2074 616b 6561 7761 7920  citing takeaway 
-00014570: 6865 7265 2069 7320 7468 6174 2045 6e6c  here is that Enl
-00014580: 6967 6874 656e 2069 7320 7374 6162 6c65  ighten is stable
-00014590: 2065 6e6f 7567 682e 0a20 2020 2023 2054   enough..    # T
-000145a0: 7572 6e69 6e67 2074 6865 206c 6173 6572  urning the laser
-000145b0: 206f 6e20 7769 7468 2074 6865 2064 6174   on with the dat
-000145c0: 6120 6f72 2077 4c65 6e67 7468 2070 6172  a or wLength par
-000145d0: 616d 6574 6572 206e 6f74 2073 6574 0a20  ameter not set. 
-000145e0: 2020 2023 2063 6f72 7265 6374 6c79 2077     # correctly w
-000145f0: 696c 6c20 6361 7573 6520 6120 6861 7264  ill cause a hard
-00014600: 7761 7265 2066 6169 6c75 7265 2061 6e64  ware failure and
-00014610: 2063 6f6d 706c 6574 6520 6465 7669 6365   complete device
-00014620: 206c 6f63 6b75 700a 2020 2020 2320 7265   lockup.    # re
-00014630: 7175 6972 696e 6720 6120 706f 7765 7220  quiring a power 
-00014640: 6379 636c 652e 0a20 2020 2023 0a20 2020  cycle..    #.   
-00014650: 2023 2066 6964 3a0a 2020 2020 2320 2020   # fid:.    #   
-00014660: 2020 4352 4954 4943 414c 2048 6172 6477    CRITICAL Hardw
-00014670: 6172 6520 4661 696c 7572 6520 4649 4420  are Failure FID 
-00014680: 5365 6e64 2043 6f64 6520 5072 6f62 6c65  Send Code Proble
-00014690: 6d20 7769 7468 0a20 2020 2023 2020 2020  m with.    #    
-000146a0: 2020 2020 2020 2020 2020 6374 726c 2074            ctrl t
-000146b0: 7261 6e73 6665 723a 205b 4572 726e 6f20  ransfer: [Errno 
-000146c0: 4e6f 6e65 5d20 3131 0a20 2020 2023 0a20  None] 11.    #. 
-000146d0: 2020 2023 2055 6e6c 696b 6520 4461 7368     # Unlike Dash
-000146e0: 2077 6869 6368 206d 6179 206c 6f63 6b75   which may locku
-000146f0: 7020 616e 6420 7265 7175 6972 6520 6b69  p and require ki
-00014700: 6c6c 696e 6720 7468 6520 6170 706c 6963  lling the applic
-00014710: 6174 696f 6e2c 0a20 2020 2023 2045 6e6c  ation,.    # Enl
-00014720: 6967 6874 656e 2064 6f65 7320 6e6f 7420  ighten does not 
-00014730: 6c6f 636b 2075 702e 2054 6865 2045 6e6c  lock up. The Enl
-00014740: 6967 6874 656e 2063 6f64 6520 6261 7365  ighten code base
-00014750: 2068 6173 206e 6f77 2062 6565 6e0a 2020   has now been.  
-00014760: 2020 2320 7573 6564 2074 6f20 756e 6d61    # used to unma
-00014770: 736b 2061 6e20 6973 7375 6520 7468 6174  sk an issue that
-00014780: 2068 6173 2062 6565 6e20 6c75 726b 696e   has been lurkin
-00014790: 6720 7769 7468 206f 7572 206c 6567 6163  g with our legac
-000147a0: 790a 2020 2020 2320 6669 726d 7761 7265  y.    # firmware
-000147b0: 2066 6f72 2063 6c6f 7365 2074 6f20 3620   for close to 6 
-000147c0: 7965 6172 732e 2057 6527 7665 2064 6574  years. We've det
-000147d0: 6563 7465 6420 7468 6973 206f 7574 206f  ected this out o
-000147e0: 660a 2020 2020 2320 7370 6563 6966 6963  f.    # specific
-000147f0: 6174 696f 6e20 6172 6561 206f 6620 7468  ation area of th
-00014800: 6520 636f 6465 2062 6566 6f72 6520 6974  e code before it
-00014810: 2063 616e 2061 6476 6572 7365 6c79 2069   can adversely i
-00014820: 6d70 6163 7420 610a 2020 2020 2320 6375  mpact a.    # cu
-00014830: 7374 6f6d 6572 2e20 2222 220a 2020 2020  stomer. """.    
-00014840: 230a 2020 2020 2320 4173 206c 6f6e 6720  #.    # As long 
-00014850: 6173 206c 6173 6572 2070 6f77 6572 2069  as laser power i
-00014860: 7320 6d6f 6475 6c61 7465 6420 7573 696e  s modulated usin
-00014870: 6720 6120 7065 7269 6f64 206f 6620 3130  g a period of 10
-00014880: 3075 732c 0a20 2020 2023 2077 6974 6820  0us,.    # with 
-00014890: 6120 6e65 6365 7373 6172 696c 792d 696e  a necessarily-in
-000148a0: 7465 6772 616c 2070 756c 7365 2077 6964  tegral pulse wid
-000148b0: 7468 206f 6620 312d 3939 7573 2c20 7468  th of 1-99us, th
-000148c0: 656e 2069 7427 730a 2020 2020 2320 6e6f  en it's.    # no
-000148d0: 7420 7068 7973 6963 616c 6c79 2070 6f73  t physically pos
-000148e0: 7369 626c 6520 746f 2073 7570 706f 7274  sible to support
-000148f0: 2066 7261 6374 696f 6e61 6c20 706f 7765   fractional powe
-00014900: 7220 6c65 7665 6c73 2e0a 2020 2020 230a  r levels..    #.
-00014910: 2020 2020 2320 4074 6f64 6f20 7461 6c6b      # @todo talk
-00014920: 2074 6f20 4a61 736f 6e20 6162 6f75 7420   to Jason about 
-00014930: 6368 616e 6769 6e67 206d 6f64 756c 6174  changing modulat
-00014940: 696f 6e20 5045 5249 4f44 2074 6f20 6c6f  ion PERIOD to lo
-00014950: 6e67 6572 0a20 2020 2023 2020 2020 2076  nger.    #     v
-00014960: 616c 7565 2028 3230 3075 733f 2034 3030  alue (200us? 400
-00014970: 3f20 3130 3030 3f29 2c20 4f52 2077 6865  ? 1000?), OR whe
-00014980: 7468 6572 2070 756c 7365 2057 4944 5448  ther pulse WIDTH
-00014990: 2063 616e 2062 650a 2020 2020 2320 2020   can be.    #   
-000149a0: 2020 696e 2073 6d61 6c6c 6572 2075 6e69    in smaller uni
-000149b0: 7420 2835 3030 6e73 3f20 3130 306e 733f  t (500ns? 100ns?
-000149c0: 290a 2020 2020 6465 6620 7365 745f 6c61  ).    def set_la
-000149d0: 7365 725f 706f 7765 725f 7065 7263 5f69  ser_power_perc_i
-000149e0: 6d6d 6564 6961 7465 2873 656c 662c 2076  mmediate(self, v
-000149f0: 616c 7565 3a20 666c 6f61 7429 202d 3e20  alue: float) -> 
-00014a00: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00014a10: 6f6e 7365 3a0a 0a20 2020 2020 2020 2023  onse:..        #
-00014a20: 206c 6173 6572 2063 616e 2066 6c69 636b   laser can flick
-00014a30: 6572 2069 6620 7765 2772 6520 6f6e 2074  er if we're on t
-00014a40: 6865 2077 726f 6e67 2041 4443 3f0a 0a20  he wrong ADC?.. 
-00014a50: 2020 2020 2020 2023 2064 6f6e 2774 2077         # don't w
-00014a60: 616e 7420 616e 7974 6869 6e67 2077 6569  ant anything wei
-00014a70: 7264 2077 6865 6e20 7061 7373 696e 6720  rd when passing 
-00014a80: 6f76 6572 2055 5342 0a20 2020 2020 2020  over USB.       
-00014a90: 2076 616c 7565 203d 2066 6c6f 6174 286d   value = float(m
-00014aa0: 6178 2830 2c20 6d69 6e28 3130 302c 2076  ax(0, min(100, v
-00014ab0: 616c 7565 2929 290a 0a20 2020 2020 2020  alue)))..       
-00014ac0: 2023 2049 6620 6675 6c6c 2070 6f77 6572   # If full power
-00014ad0: 2028 616e 6420 616c 6c6f 7765 6429 2c20   (and allowed), 
-00014ae0: 6469 7361 626c 6520 6d6f 6475 6c61 7469  disable modulati
-00014af0: 6f6e 2061 6e64 2065 7869 740a 2020 2020  on and exit.    
-00014b00: 2020 2020 6966 2076 616c 7565 203e 3d20      if value >= 
-00014b10: 3130 303a 0a20 2020 2020 2020 2020 2020  100:.           
-00014b20: 2069 6620 7365 6c66 2e73 6574 7469 6e67   if self.setting
-00014b30: 732e 7374 6174 652e 6c61 7365 725f 706f  s.state.laser_po
-00014b40: 7765 725f 7265 7175 6972 655f 6d6f 6475  wer_require_modu
-00014b50: 6c61 7469 6f6e 3a0a 2020 2020 2020 2020  lation:.        
-00014b60: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-00014b70: 6728 2231 3030 2520 706f 7765 7220 7265  g("100% power re
-00014b80: 7175 6573 7465 642c 2079 6574 206c 6173  quested, yet las
-00014b90: 6572 206d 6f64 756c 6174 696f 6e20 7265  er modulation re
-00014ba0: 7175 6972 6564 2c20 736f 206e 6f74 2064  quired, so not d
-00014bb0: 6973 6162 6c69 6e67 206d 6f64 756c 6174  isabling modulat
-00014bc0: 696f 6e22 290a 2020 2020 2020 2020 2020  ion").          
-00014bd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00014be0: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-00014bf0: 6728 2254 7572 6e69 6e67 206f 6666 206c  g("Turning off l
-00014c00: 6173 6572 206d 6f64 756c 6174 696f 6e20  aser modulation 
-00014c10: 2866 756c 6c20 706f 7765 7229 2229 0a20  (full power)"). 
-00014c20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014c30: 656c 662e 6e65 7874 5f61 7070 6c69 6564  elf.next_applied
-00014c40: 5f6c 6173 6572 5f70 6f77 6572 203d 2031  _laser_power = 1
-00014c50: 3030 2e30 0a20 2020 2020 2020 2020 2020  00.0.           
-00014c60: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-00014c70: 6e65 7874 5f61 7070 6c69 6564 5f6c 6173  next_applied_las
-00014c80: 6572 5f70 6f77 6572 203d 2031 3030 2e30  er_power = 100.0
-00014c90: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00014ca0: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-00014cb0: 6574 5f6d 6f64 5f65 6e61 626c 6528 4661  et_mod_enable(Fa
-00014cc0: 6c73 6529 0a0a 2020 2020 2020 2020 7065  lse)..        pe
-00014cd0: 7269 6f64 5f75 7320 3d20 3130 3030 2069  riod_us = 1000 i
-00014ce0: 6620 7365 6c66 2e73 6574 7469 6e67 732e  f self.settings.
-00014cf0: 7374 6174 652e 6c61 7365 725f 706f 7765  state.laser_powe
-00014d00: 725f 6869 6768 5f72 6573 6f6c 7574 696f  r_high_resolutio
-00014d10: 6e20 656c 7365 2031 3030 0a20 2020 2020  n else 100.     
-00014d20: 2020 2077 6964 7468 5f75 7320 3d20 696e     width_us = in
-00014d30: 7428 726f 756e 6428 312e 3020 2a20 7661  t(round(1.0 * va
-00014d40: 6c75 6520 2a20 7065 7269 6f64 5f75 7320  lue * period_us 
-00014d50: 2f20 3130 302e 302c 2030 2929 2023 206e  / 100.0, 0)) # n
-00014d60: 6f74 6520 7468 6174 2076 616c 7565 2069  ote that value i
-00014d70: 7320 696e 2072 616e 6765 2028 302c 2031  s in range (0, 1
-00014d80: 3030 2920 6e6f 7420 2830 2c20 3129 0a0a  00) not (0, 1)..
-00014d90: 2020 2020 2020 2020 2320 7075 6c73 6520          # pulse 
-00014da0: 7769 6474 6820 6361 6e27 7420 6265 206c  width can't be l
-00014db0: 6f6e 6765 7220 7468 616e 2070 6572 696f  onger than perio
-00014dc0: 642c 206f 7220 7368 6f72 7465 7220 7468  d, or shorter th
-00014dd0: 616e 2031 7573 0a20 2020 2020 2020 2077  an 1us.        w
-00014de0: 6964 7468 5f75 7320 3d20 6d61 7828 312c  idth_us = max(1,
-00014df0: 206d 696e 2877 6964 7468 5f75 732c 2070   min(width_us, p
-00014e00: 6572 696f 645f 7573 2929 0a0a 2020 2020  eriod_us))..    
-00014e10: 2020 2020 2320 4368 616e 6765 2074 6865      # Change the
-00014e20: 2070 756c 7365 2070 6572 696f 642e 2020   pulse period.  
-00014e30: 4e6f 7465 2074 6861 7420 7765 2772 6520  Note that we're 
-00014e40: 6e6f 7420 7061 7273 696e 6720 696e 746f  not parsing into
-00014e50: 2034 302d 6269 740a 2020 2020 2020 2020   40-bit.        
-00014e60: 2320 6265 6361 7573 6520 7468 6973 2069  # because this i
-00014e70: 6d70 6c65 6d65 6e74 6174 696f 6e20 6973  mplementation is
-00014e80: 2068 6172 642d 636f 6465 6420 746f 2065   hard-coded to e
-00014e90: 6974 6865 7220 3130 3020 6f72 2031 3030  ither 100 or 100
-00014ea0: 3075 730a 2020 2020 2020 2020 2320 2862  0us.        # (b
-00014eb0: 6f74 6820 6669 7474 696e 6720 7765 6c6c  oth fitting well
-00014ec0: 2077 6974 6869 6e20 7569 6e74 3136 290a   within uint16).
-00014ed0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00014ee0: 2073 656c 662e 7365 745f 6d6f 645f 7065   self.set_mod_pe
-00014ef0: 7269 6f64 5f75 7328 7065 7269 6f64 5f75  riod_us(period_u
-00014f00: 7329 0a20 2020 2020 2020 2023 2069 6620  s).        # if 
-00014f10: 7265 7375 6c74 2e64 6174 6120 6973 204e  result.data is N
-00014f20: 6f6e 653a 0a20 2020 2020 2020 2023 2020  one:.        #  
-00014f30: 2020 206c 6f67 2e63 7269 7469 6361 6c28     log.critical(
-00014f40: 2248 6172 6477 6172 6520 4661 696c 7572  "Hardware Failur
-00014f50: 6520 746f 2073 656e 6420 6c61 7365 7220  e to send laser 
-00014f60: 6d6f 642e 2070 756c 7365 2070 6572 696f  mod. pulse perio
-00014f70: 6422 290a 2020 2020 2020 2020 2320 2020  d").        #   
-00014f80: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-00014f90: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-00014fa0: 7461 3d46 616c 7365 2c65 7272 6f72 5f6d  ta=False,error_m
-00014fb0: 7367 3d22 6661 696c 6564 2074 6f20 7365  sg="failed to se
-00014fc0: 6e64 206c 6173 6572 206d 6f64 2229 0a0a  nd laser mod")..
-00014fd0: 2020 2020 2020 2020 2320 5365 7420 7468          # Set th
-00014fe0: 6520 7075 6c73 6520 7769 6474 6820 746f  e pulse width to
-00014ff0: 2074 6865 2030 2d31 3030 2070 6572 6365   the 0-100 perce
-00015000: 6e74 6167 6520 6f66 2070 6f77 6572 0a20  ntage of power. 
-00015010: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00015020: 7365 6c66 2e73 6574 5f6d 6f64 5f77 6964  self.set_mod_wid
-00015030: 7468 5f75 7328 7769 6474 685f 7573 290a  th_us(width_us).
-00015040: 2020 2020 2020 2020 2320 6966 2072 6573          # if res
-00015050: 756c 742e 6461 7461 2069 7320 4e6f 6e65  ult.data is None
-00015060: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
-00015070: 6c6f 672e 6372 6974 6963 616c 2822 4861  log.critical("Ha
-00015080: 7264 7761 7265 2046 6169 6c75 7265 2074  rdware Failure t
-00015090: 6f20 7365 6e64 2070 756c 7365 2077 6964  o send pulse wid
-000150a0: 7468 2229 0a20 2020 2020 2020 2023 2020  th").        #  
-000150b0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-000150c0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-000150d0: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
-000150e0: 6d73 673d 2266 6169 6c65 6420 746f 2073  msg="failed to s
-000150f0: 656e 6420 7075 6c73 6520 7769 6474 6822  end pulse width"
-00015100: 290a 0a20 2020 2020 2020 2023 2045 6e61  )..        # Ena
-00015110: 626c 6520 6d6f 6475 6c61 7469 6f6e 0a20  ble modulation. 
-00015120: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00015130: 7365 6c66 2e73 6574 5f6d 6f64 5f65 6e61  self.set_mod_ena
-00015140: 626c 6528 5472 7565 290a 2020 2020 2020  ble(True).      
-00015150: 2020 2320 6966 2072 6573 756c 742e 6461    # if result.da
-00015160: 7461 2069 7320 4e6f 6e65 3a0a 2020 2020  ta is None:.    
-00015170: 2020 2020 2320 2020 2020 6c6f 672e 6372      #     log.cr
-00015180: 6974 6963 616c 2822 4861 7264 7761 7265  itical("Hardware
-00015190: 2046 6169 6c75 7265 2074 6f20 7365 6e64   Failure to send
-000151a0: 206c 6173 6572 206d 6f64 756c 6174 696f   laser modulatio
-000151b0: 6e22 290a 2020 2020 2020 2020 2320 2020  n").        #   
-000151c0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-000151d0: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-000151e0: 7461 3d46 616c 7365 2c65 7272 6f72 5f6d  ta=False,error_m
-000151f0: 7367 3d22 6661 696c 6564 2074 6f20 7365  sg="failed to se
-00015200: 6e64 206c 6173 6572 206d 6f64 756c 6174  nd laser modulat
-00015210: 696f 6e22 290a 0a20 2020 2020 2020 206c  ion")..        l
-00015220: 6f67 2e64 6562 7567 2822 4c61 7365 7220  og.debug("Laser 
-00015230: 706f 7765 7220 7365 7420 746f 3a20 2564  power set to: %d
-00015240: 222c 2076 616c 7565 290a 0a20 2020 2020  ", value)..     
-00015250: 2020 2073 656c 662e 6e65 7874 5f61 7070     self.next_app
-00015260: 6c69 6564 5f6c 6173 6572 5f70 6f77 6572  lied_laser_power
-00015270: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
-00015280: 206c 6f67 2e64 6562 7567 2822 6e65 7874   log.debug("next
-00015290: 5f61 7070 6c69 6564 5f6c 6173 6572 5f70  _applied_laser_p
-000152a0: 6f77 6572 203d 2025 7322 2c20 7365 6c66  ower = %s", self
-000152b0: 2e6e 6578 745f 6170 706c 6965 645f 6c61  .next_applied_la
-000152c0: 7365 725f 706f 7765 7229 0a0a 2020 2020  ser_power)..    
-000152d0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-000152e0: 740a 0a20 2020 2023 230a 2020 2020 2320  t..    ##.    # 
-000152f0: 406e 6f74 6520 6e65 7665 7220 7573 6564  @note never used
-00015300: 2c20 7072 6f76 6964 6564 2066 6f72 204f  , provided for O
-00015310: 454d 0a20 2020 2064 6566 2067 6574 5f6c  EM.    def get_l
-00015320: 6173 6572 5f74 656d 7065 7261 7475 7265  aser_temperature
-00015330: 5f73 6574 706f 696e 745f 7261 7728 7365  _setpoint_raw(se
-00015340: 6c66 2920 2d3e 2053 7065 6374 726f 6d65  lf) -> Spectrome
-00015350: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-00015360: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00015370: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
-00015380: 2e68 6173 5f6c 6173 6572 3a0a 2020 2020  .has_laser:.    
-00015390: 2020 2020 2020 2020 6c6f 672e 6572 726f          log.erro
-000153a0: 7228 2275 6e61 626c 6520 746f 2063 6f6e  r("unable to con
-000153b0: 7472 6f6c 206c 6173 6572 3a20 4545 5052  trol laser: EEPR
-000153c0: 4f4d 2072 6570 6f72 7473 206e 6f20 6c61  OM reports no la
-000153d0: 7365 7220 696e 7374 616c 6c65 6422 290a  ser installed").
-000153e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000153f0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-00015400: 6573 706f 6e73 6528 6461 7461 3d4e 6f6e  esponse(data=Non
-00015410: 652c 6572 726f 725f 6d73 673d 226e 6f20  e,error_msg="no 
-00015420: 6c61 7365 7220 696e 7374 616c 6c65 6422  laser installed"
-00015430: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-00015440: 7420 3d20 7365 6c66 2e5f 6765 745f 636f  t = self._get_co
-00015450: 6465 2830 7865 382c 206c 6162 656c 3d22  de(0xe8, label="
-00015460: 4745 545f 4c41 5345 525f 5445 435f 5345  GET_LASER_TEC_SE
-00015470: 5450 4f49 4e54 2229 0a20 2020 2020 2020  TPOINT").       
-00015480: 2072 6573 203d 2053 7065 6374 726f 6d65   res = Spectrome
-00015490: 7465 7252 6573 706f 6e73 6528 290a 2020  terResponse().  
-000154a0: 2020 2020 2020 7265 732e 7472 616e 7366        res.transf
-000154b0: 6572 5f72 6573 706f 6e73 6528 7265 7375  er_response(resu
-000154c0: 6c74 290a 2020 2020 2020 2020 7265 732e  lt).        res.
-000154d0: 6461 7461 203d 2072 6573 756c 742e 6461  data = result.da
-000154e0: 7461 5b30 5d0a 2020 2020 2020 2020 7265  ta[0].        re
-000154f0: 7475 726e 2072 6573 0a0a 2020 2020 6465  turn res..    de
-00015500: 6620 7365 745f 6c61 7365 725f 7465 6d70  f set_laser_temp
-00015510: 6572 6174 7572 655f 7365 7470 6f69 6e74  erature_setpoint
-00015520: 5f72 6177 2873 656c 662c 2076 616c 7565  _raw(self, value
-00015530: 3a20 696e 7429 202d 3e20 5370 6563 7472  : int) -> Spectr
-00015540: 6f6d 6574 6572 5265 7370 6f6e 7365 3a0a  ometerResponse:.
-00015550: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-00015560: 6728 2253 656e 6420 6c61 7365 7220 7465  g("Send laser te
-00015570: 6d70 6572 6174 7572 6520 7365 7470 6f69  mperature setpoi
-00015580: 6e74 2072 6177 3a20 2564 222c 2076 616c  nt raw: %d", val
-00015590: 7565 290a 2020 2020 2020 2020 7265 7475  ue).        retu
-000155a0: 726e 2073 656c 662e 5f73 656e 645f 636f  rn self._send_co
-000155b0: 6465 2830 7865 372c 2076 616c 7565 2c20  de(0xe7, value, 
-000155c0: 6c61 6265 6c3d 2253 4554 5f4c 4153 4552  label="SET_LASER
-000155d0: 5f54 4543 5f53 4554 504f 494e 5422 290a  _TEC_SETPOINT").
-000155e0: 0a20 2020 2064 6566 2067 6574 5f6c 6173  .    def get_las
-000155f0: 6572 5f69 6e74 6572 6c6f 636b 2873 656c  er_interlock(sel
-00015600: 6629 202d 3e20 5370 6563 7472 6f6d 6574  f) -> Spectromet
-00015610: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-00015620: 2020 2020 2222 2220 4c65 6761 6379 2077      """ Legacy w
-00015630: 7261 7070 6572 206f 7665 7220 6361 6e5f  rapper over can_
-00015640: 6c61 7365 725f 6669 7265 2e20 2222 220a  laser_fire. """.
-00015650: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00015660: 656c 662e 6361 6e5f 6c61 7365 725f 6669  elf.can_laser_fi
-00015670: 7265 2829 0a0a 2020 2020 6465 6620 6361  re()..    def ca
-00015680: 6e5f 6c61 7365 725f 6669 7265 2873 656c  n_laser_fire(sel
-00015690: 6629 202d 3e20 5370 6563 7472 6f6d 6574  f) -> Spectromet
-000156a0: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-000156b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000156c0: 406e 6f74 6520 6f6e 6c79 2077 6f72 6b73  @note only works
-000156d0: 206f 6e20 4658 322d 6261 7365 6420 7370   on FX2-based sp
-000156e0: 6563 7472 6f6d 6574 6572 7320 7769 7468  ectrometers with
-000156f0: 2046 5720 3e3d 2031 302e 302e 302e 3131   FW >= 10.0.0.11
-00015700: 0a20 2020 2020 2020 2040 7265 7475 726e  .        @return
-00015710: 7320 5472 7565 2069 6620 7468 6572 6520  s True if there 
-00015720: 6973 2061 206c 6173 6572 2061 6e64 2065  is a laser and e
-00015730: 6974 6865 7220 7468 6520 696e 7465 726c  ither the interl
-00015740: 6f63 6b20 6973 0a20 2020 2020 2020 2020  ock is.         
-00015750: 636c 6f73 6564 2028 696e 2066 6972 696e  closed (in firin
-00015760: 6720 706f 7369 7469 6f6e 292c 206f 7220  g position), or 
-00015770: 7468 6572 6520 6973 206e 6f20 7265 6164  there is no read
-00015780: 6162 6c65 0a20 2020 2020 2020 2020 696e  able.         in
-00015790: 7465 726c 6f63 6b0a 2020 2020 2020 2020  terlock.        
-000157a0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-000157b0: 6f74 2073 656c 662e 7365 7474 696e 6773  ot self.settings
-000157c0: 2e65 6570 726f 6d2e 6861 735f 6c61 7365  .eeprom.has_lase
-000157d0: 723a 0a20 2020 2020 2020 2020 2020 206c  r:.            l
-000157e0: 6f67 2e65 7272 6f72 2822 4545 5052 4f4d  og.error("EEPROM
-000157f0: 2072 6570 6f72 7473 206e 6f20 6c61 7365   reports no lase
-00015800: 7220 696e 7374 616c 6c65 6422 290a 2020  r installed").  
-00015810: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00015820: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-00015830: 706f 6e73 6528 6461 7461 3d46 616c 7365  ponse(data=False
-00015840: 2c65 7272 6f72 5f6d 7367 3d22 6e6f 206c  ,error_msg="no l
-00015850: 6173 6572 2069 6e73 7461 6c6c 6564 2229  aser installed")
-00015860: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00015870: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
-00015880: 6570 726f 6d2e 6861 735f 696e 7465 726c  eprom.has_interl
-00015890: 6f63 6b5f 6665 6564 6261 636b 3a0a 2020  ock_feedback:.  
-000158a0: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
-000158b0: 6275 6728 2243 414e 5f4c 4153 4552 5f46  bug("CAN_LASER_F
-000158c0: 4952 4520 7265 7175 6972 6573 2068 6173  IRE requires has
-000158d0: 5f69 6e74 6572 6c6f 636b 5f66 6565 6462  _interlock_feedb
-000158e0: 6163 6b20 2864 6566 6175 6c74 696e 6720  ack (defaulting 
-000158f0: 5472 7565 2922 290a 2020 2020 2020 2020  True)").        
-00015900: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-00015910: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-00015920: 6461 7461 3d54 7275 6529 0a0a 2020 2020  data=True)..    
-00015930: 2020 2020 7265 7320 3d20 7365 6c66 2e5f      res = self._
-00015940: 6765 745f 636f 6465 2830 7865 662c 206c  get_code(0xef, l
-00015950: 6162 656c 3d22 4341 4e5f 4c41 5345 525f  abel="CAN_LASER_
-00015960: 4649 5245 222c 206d 7362 5f6c 656e 3d31  FIRE", msb_len=1
-00015970: 290a 2020 2020 2020 2020 7265 732e 6461  ).        res.da
-00015980: 7461 203d 2030 2021 3d20 7265 732e 6461  ta = 0 != res.da
-00015990: 7461 0a20 2020 2020 2020 2072 6574 7572  ta.        retur
-000159a0: 6e20 7265 730a 0a20 2020 2064 6566 2069  n res..    def i
-000159b0: 735f 6c61 7365 725f 6669 7269 6e67 2873  s_laser_firing(s
-000159c0: 656c 6629 202d 3e20 5370 6563 7472 6f6d  elf) -> Spectrom
-000159d0: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-000159e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000159f0: 2020 4368 6563 6b20 6966 2074 6865 206c    Check if the l
-00015a00: 6173 6572 2061 6374 7561 6c6c 7920 4953  aser actually IS
-00015a10: 2066 6972 696e 672c 2069 6e64 6570 656e   firing, indepen
-00015a20: 6465 6e74 206f 6620 6c61 7365 725f 656e  dent of laser_en
-00015a30: 6162 6c65 206f 7220 0a20 2020 2020 2020  able or .       
-00015a40: 2063 616e 5f6c 6173 6572 5f66 6972 652e   can_laser_fire.
-00015a50: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00015a60: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00015a70: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
-00015a80: 2e68 6173 5f69 6e74 6572 6c6f 636b 5f66  .has_interlock_f
-00015a90: 6565 6462 6163 6b3a 0a20 2020 2020 2020  eedback:.       
-00015aa0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-00015ab0: 4953 5f4c 4153 4552 5f46 4952 494e 4720  IS_LASER_FIRING 
-00015ac0: 7265 7175 6972 6573 2068 6173 5f69 6e74  requires has_int
-00015ad0: 6572 6c6f 636b 5f66 6565 6462 6163 6b20  erlock_feedback 
-00015ae0: 2864 6566 6175 6c74 696e 6720 746f 206c  (defaulting to l
-00015af0: 6173 6572 5f65 6e61 626c 6564 2922 290a  aser_enabled)").
-00015b00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00015b10: 726e 2073 656c 662e 6765 745f 6c61 7365  rn self.get_lase
-00015b20: 725f 656e 6162 6c65 6428 290a 0a20 2020  r_enabled()..   
-00015b30: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
-00015b40: 6765 745f 7570 7065 725f 636f 6465 2830  get_upper_code(0
-00015b50: 7830 642c 206c 6162 656c 3d22 4953 5f4c  x0d, label="IS_L
-00015b60: 4153 4552 5f46 4952 494e 4722 2c20 6d73  ASER_FIRING", ms
-00015b70: 625f 6c65 6e3d 3129 0a20 2020 2020 2020  b_len=1).       
-00015b80: 2072 6573 2e64 6174 6120 3d20 3020 213d   res.data = 0 !=
-00015b90: 2072 6573 2e64 6174 610a 2020 2020 2020   res.data.      
-00015ba0: 2020 7265 7475 726e 2072 6573 0a0a 2020    return res..  
-00015bb0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-00015bc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015bd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015be0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015bf0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-00015c00: 2020 2023 2028 656e 6420 6f66 206c 6173     # (end of las
-00015c10: 6572 2063 6f6d 6d61 6e64 7329 0a20 2020  er commands).   
-00015c20: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00015c30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015c40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015c50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015c60: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
-00015c70: 2020 2064 6566 2072 6573 6574 5f66 7067     def reset_fpg
-00015c80: 6128 7365 6c66 2920 2d3e 2053 7065 6374  a(self) -> Spect
-00015c90: 726f 6d65 7465 7252 6573 706f 6e73 653a  rometerResponse:
-00015ca0: 0a20 2020 2020 2020 206c 6f67 2e64 6562  .        log.deb
-00015cb0: 7567 2822 6669 643a 2072 6573 6574 7469  ug("fid: resetti
-00015cc0: 6e67 2046 5047 4122 290a 2020 2020 2020  ng FPGA").      
-00015cd0: 2020 7265 7375 6c74 203d 2073 656c 662e    result = self.
-00015ce0: 5f73 656e 645f 636f 6465 2830 7862 352c  _send_code(0xb5,
-00015cf0: 206c 6162 656c 3d22 5245 5345 545f 4650   label="RESET_FP
-00015d00: 4741 2229 0a20 2020 2020 2020 206c 6f67  GA").        log
-00015d10: 2e64 6562 7567 2822 6669 643a 2073 6c65  .debug("fid: sle
-00015d20: 6570 696e 6720 3373 6563 2229 0a20 2020  eping 3sec").   
-00015d30: 2020 2020 2073 6c65 6570 2833 290a 2020       sleep(3).  
-00015d40: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00015d50: 756c 740a 0a20 2020 2023 230a 2020 2020  ult..    ##.    
-00015d60: 2320 5265 6164 2074 6865 2074 7269 6767  # Read the trigg
-00015d70: 6572 2073 6f75 7263 6520 7365 7474 696e  er source settin
-00015d80: 6720 6672 6f6d 2074 6865 2064 6576 6963  g from the devic
-00015d90: 652e 0a20 2020 2023 0a20 2020 2023 202d  e..    #.    # -
-00015da0: 2030 203d 2069 6e74 6572 6e61 6c0a 2020   0 = internal.  
-00015db0: 2020 2320 2d20 3120 3d20 6578 7465 726e    # - 1 = extern
-00015dc0: 616c 0a20 2020 2023 0a20 2020 2023 2055  al.    #.    # U
-00015dd0: 7365 2063 6175 7469 6f6e 2077 6865 6e20  se caution when 
-00015de0: 696e 7465 7270 7265 7469 6e67 2074 6865  interpreting the
-00015df0: 206c 6172 6765 7220 6265 6861 7669 6f72   larger behavior
-00015e00: 206f 660a 2020 2020 2320 7468 6520 6465   of.    # the de
-00015e10: 7669 6365 2061 7320 4152 4d20 616e 6420  vice as ARM and 
-00015e20: 4658 3220 696d 706c 656d 656e 7461 7469  FX2 implementati
-00015e30: 6f6e 7320 6469 6666 6572 2061 7320 6f66  ons differ as of
-00015e40: 2032 3031 372d 3038 2d30 320a 2020 2020   2017-08-02.    
-00015e50: 230a 2020 2020 2320 406e 6f74 6520 6e65  #.    # @note ne
-00015e60: 7665 7220 6361 6c6c 6564 2062 7920 454e  ver called by EN
-00015e70: 4c49 4748 5445 4e20 2d20 7072 6f76 6964  LIGHTEN - provid
-00015e80: 6564 2066 6f72 204f 454d 730a 2020 2020  ed for OEMs.    
-00015e90: 6465 6620 6765 745f 7472 6967 6765 725f  def get_trigger_
-00015ea0: 736f 7572 6365 2873 656c 6629 202d 3e20  source(self) -> 
-00015eb0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-00015ec0: 6f6e 7365 3a0a 2020 2020 2020 2020 7661  onse:.        va
-00015ed0: 6c75 6520 3d20 7365 6c66 2e5f 6765 745f  lue = self._get_
-00015ee0: 636f 6465 2830 7864 332c 206c 6162 656c  code(0xd3, label
-00015ef0: 3d22 4745 545f 5452 4947 4745 525f 534f  ="GET_TRIGGER_SO
-00015f00: 5552 4345 222c 206d 7362 5f6c 656e 3d31  URCE", msb_len=1
-00015f10: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-00015f20: 6574 7469 6e67 732e 7374 6174 652e 7472  ettings.state.tr
-00015f30: 6967 6765 725f 736f 7572 6365 203d 2076  igger_source = v
-00015f40: 616c 7565 2e64 6174 610a 2020 2020 2020  alue.data.      
-00015f50: 2020 7265 7475 726e 2076 616c 7565 0a0a    return value..
-00015f60: 2020 2020 2323 0a20 2020 2023 2040 6e6f      ##.    # @no
-00015f70: 7465 206e 6f74 2063 616c 6c65 6420 6279  te not called by
-00015f80: 2045 4e4c 4947 4854 454e 0a20 2020 2023   ENLIGHTEN.    #
-00015f90: 2040 7761 726e 696e 6720 636f 6e66 6c69   @warning confli
-00015fa0: 6374 7320 7769 7468 2047 4554 5f53 454c  cts with GET_SEL
-00015fb0: 4543 5445 445f 4c41 5345 520a 2020 2020  ECTED_LASER.    
-00015fc0: 6465 6620 6765 745f 7261 6d61 6e5f 6d6f  def get_raman_mo
-00015fd0: 6465 5f65 6e61 626c 6564 5f4e 4f54 5f55  de_enabled_NOT_U
-00015fe0: 5345 4428 7365 6c66 2920 2d3e 2053 7065  SED(self) -> Spe
-00015ff0: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-00016000: 653a 0a20 2020 2020 2020 2072 6573 203d  e:.        res =
-00016010: 2073 656c 662e 6765 745f 7570 7065 725f   self.get_upper_
-00016020: 636f 6465 2830 7831 352c 206c 6162 656c  code(0x15, label
-00016030: 3d22 4745 545f 5241 4d41 4e5f 4d4f 4445  ="GET_RAMAN_MODE
-00016040: 5f45 4e41 424c 4544 222c 206d 7362 5f6c  _ENABLED", msb_l
-00016050: 656e 3d31 290a 2020 2020 2020 2020 7265  en=1).        re
-00016060: 732e 6461 7461 203d 2030 2021 3d20 7265  s.data = 0 != re
-00016070: 732e 6461 7461 0a20 2020 2020 2020 2072  s.data.        r
-00016080: 6574 7572 6e20 7265 730a 0a20 2020 2023  eturn res..    #
-00016090: 230a 2020 2020 2320 456e 6162 6c65 2022  #.    # Enable "
-000160a0: 5261 6d61 6e20 6d6f 6465 2220 2861 7574  Raman mode" (aut
-000160b0: 6f6d 6174 6963 206c 6173 6572 2920 696e  omatic laser) in
-000160c0: 2074 6865 2073 7065 6374 726f 6d65 7465   the spectromete
-000160d0: 7220 6669 726d 7761 7265 2e0a 2020 2020  r firmware..    
-000160e0: 6465 6620 7365 745f 7261 6d61 6e5f 6d6f  def set_raman_mo
-000160f0: 6465 5f65 6e61 626c 655f 4e4f 545f 5553  de_enable_NOT_US
-00016100: 4544 2873 656c 662c 2066 6c61 673a 2062  ED(self, flag: b
-00016110: 6f6f 6c29 202d 3e20 5370 6563 7472 6f6d  ool) -> Spectrom
-00016120: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-00016130: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-00016140: 662e 7365 7474 696e 6773 2e69 735f 6d69  f.settings.is_mi
-00016150: 6372 6f28 293a 0a20 2020 2020 2020 2020  cro():.         
-00016160: 2020 206c 6f67 2e64 6562 7567 2822 5261     log.debug("Ra
-00016170: 6d61 6e20 6d6f 6465 206f 6e6c 7920 7375  man mode only su
-00016180: 7070 6f72 7465 6420 6f6e 2053 6572 6965  pported on Serie
-00016190: 732d 5853 2229 0a20 2020 2020 2020 2020  s-XS").         
-000161a0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-000161b0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-000161c0: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
-000161d0: 6d73 673d 2272 616d 616e 206d 6f64 6520  msg="raman mode 
-000161e0: 6e6f 7420 7375 7070 6f72 7465 6422 290a  not supported").
-000161f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00016200: 7365 6c66 2e5f 7365 6e64 5f63 6f64 6528  self._send_code(
-00016210: 6252 6571 7565 7374 2020 2020 2020 2020  bRequest        
-00016220: 3d20 3078 6666 2c0a 2020 2020 2020 2020  = 0xff,.        
-00016230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016240: 2020 2020 2020 7756 616c 7565 2020 2020        wValue    
-00016250: 2020 2020 2020 3d20 3078 3136 2c0a 2020        = 0x16,.  
-00016260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016270: 2020 2020 2020 2020 2020 2020 7749 6e64              wInd
-00016280: 6578 2020 2020 2020 2020 2020 3d20 3120  ex          = 1 
-00016290: 6966 2066 6c61 6720 656c 7365 2030 2c0a  if flag else 0,.
-000162a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162b0: 2020 2020 2020 2020 2020 2020 2020 6461                da
-000162c0: 7461 5f6f 725f 774c 656e 6774 6820 3d20  ta_or_wLength = 
-000162d0: 5b30 5d20 2a20 382c 0a20 2020 2020 2020  [0] * 8,.       
-000162e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162f0: 2020 2020 2020 206c 6162 656c 2020 2020         label    
-00016300: 2020 2020 2020 203d 2022 5345 545f 5241         = "SET_RA
-00016310: 4d41 4e5f 4d4f 4445 5f45 4e41 424c 4522  MAN_MODE_ENABLE"
-00016320: 290a 0a20 2020 2064 6566 2067 6574 5f72  )..    def get_r
-00016330: 616d 616e 5f64 656c 6179 5f6d 7328 7365  aman_delay_ms(se
-00016340: 6c66 2920 2d3e 2053 7065 6374 726f 6d65  lf) -> Spectrome
-00016350: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-00016360: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
-00016370: 6765 745f 7570 7065 725f 636f 6465 2830  get_upper_code(0
-00016380: 7831 392c 206c 6162 656c 3d22 4745 545f  x19, label="GET_
-00016390: 5241 4d41 4e5f 4445 4c41 595f 4d53 222c  RAMAN_DELAY_MS",
-000163a0: 206d 7362 5f6c 656e 3d32 290a 2020 2020   msb_len=2).    
-000163b0: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
-000163c0: 732e 7374 6174 652e 7261 6d61 6e5f 6465  s.state.raman_de
-000163d0: 6c61 795f 6d73 203d 2072 6573 2e64 6174  lay_ms = res.dat
-000163e0: 610a 2020 2020 2020 2020 7265 7475 726e  a.        return
-000163f0: 2072 6573 0a0a 2020 2020 6465 6620 7365   res..    def se
-00016400: 745f 7261 6d61 6e5f 6465 6c61 795f 6d73  t_raman_delay_ms
-00016410: 2873 656c 662c 206d 733a 2069 6e74 2920  (self, ms: int) 
-00016420: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-00016430: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-00016440: 2069 6620 6e6f 7420 7365 6c66 2e73 6574   if not self.set
-00016450: 7469 6e67 732e 6973 5f6d 6963 726f 2829  tings.is_micro()
-00016460: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00016470: 672e 6465 6275 6728 2252 616d 616e 2064  g.debug("Raman d
-00016480: 656c 6179 206f 6e6c 7920 7375 7070 6f72  elay only suppor
-00016490: 7465 6420 6f6e 2053 6572 6965 732d 5853  ted on Series-XS
-000164a0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-000164b0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-000164c0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-000164d0: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
-000164e0: 2272 616d 616e 2064 656c 6179 206e 6f74  "raman delay not
-000164f0: 2073 7570 706f 7274 6564 2229 0a0a 2020   supported")..  
-00016500: 2020 2020 2020 2320 7365 6e64 2076 616c        # send val
-00016510: 7565 2061 7320 6269 672d 656e 6469 616e  ue as big-endian
-00016520: 0a20 2020 2020 2020 206d 7362 203d 2028  .        msb = (
-00016530: 6d73 203e 3e20 3829 2026 2030 7866 660a  ms >> 8) & 0xff.
-00016540: 2020 2020 2020 2020 6c73 6220 3d20 206d          lsb =  m
-00016550: 7320 2020 2020 2020 2620 3078 6666 0a20  s       & 0xff. 
-00016560: 2020 2020 2020 2076 616c 7565 203d 2028         value = (
-00016570: 6d73 6220 3c3c 2038 2920 7c20 6c73 620a  msb << 8) | lsb.
-00016580: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
-00016590: 7474 696e 6773 2e73 7461 7465 2e72 616d  ttings.state.ram
-000165a0: 616e 5f64 656c 6179 5f6d 7320 3d20 6d73  an_delay_ms = ms
-000165b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000165c0: 7365 6c66 2e5f 7365 6e64 5f63 6f64 6528  self._send_code(
-000165d0: 6252 6571 7565 7374 2020 2020 2020 2020  bRequest        
-000165e0: 3d20 3078 6666 2c0a 2020 2020 2020 2020  = 0xff,.        
-000165f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016600: 2020 2020 2020 7756 616c 7565 2020 2020        wValue    
-00016610: 2020 2020 2020 3d20 3078 3230 2c0a 2020        = 0x20,.  
-00016620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016630: 2020 2020 2020 2020 2020 2020 7749 6e64              wInd
-00016640: 6578 2020 2020 2020 2020 2020 3d20 7661  ex          = va
-00016650: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-00016660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016670: 2020 2064 6174 615f 6f72 5f77 4c65 6e67     data_or_wLeng
-00016680: 7468 203d 205b 305d 202a 2038 2c0a 2020  th = [0] * 8,.  
-00016690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166a0: 2020 2020 2020 2020 2020 2020 6c61 6265              labe
-000166b0: 6c20 2020 2020 2020 2020 2020 3d20 2253  l           = "S
-000166c0: 4554 5f52 414d 414e 5f44 454c 4159 5f4d  ET_RAMAN_DELAY_M
-000166d0: 5322 290a 0a20 2020 2064 6566 2067 6574  S")..    def get
-000166e0: 5f6c 6173 6572 5f77 6174 6368 646f 675f  _laser_watchdog_
-000166f0: 7365 6328 7365 6c66 2920 2d3e 2053 7065  sec(self) -> Spe
-00016700: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-00016710: 653a 0a20 2020 2020 2020 2072 6573 203d  e:.        res =
-00016720: 2073 656c 662e 6765 745f 7570 7065 725f   self.get_upper_
-00016730: 636f 6465 2830 7831 372c 206c 6162 656c  code(0x17, label
-00016740: 3d22 4745 545f 4c41 5345 525f 5741 5443  ="GET_LASER_WATC
-00016750: 4844 4f47 5f53 4543 222c 206d 7362 5f6c  HDOG_SEC", msb_l
-00016760: 656e 3d32 290a 2020 2020 2020 2020 7365  en=2).        se
-00016770: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
-00016780: 652e 6c61 7365 725f 7761 7463 6864 6f67  e.laser_watchdog
-00016790: 5f73 6563 203d 2072 6573 2e64 6174 610a  _sec = res.data.
-000167a0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-000167b0: 6573 0a0a 2020 2020 2320 406e 6f74 6520  es..    # @note 
-000167c0: 756e 7469 6c20 7468 6973 2063 6861 6e67  until this chang
-000167d0: 6520 6973 206d 696d 6963 6b27 6420 696e  e is mimick'd in
-000167e0: 2074 6865 2053 544d 3332 2028 616e 6420   the STM32 (and 
-000167f0: 6166 7465 7220 7468 6174 2c20 756e 7469  after that, unti
-00016800: 6c20 7468 6520 4650 4741 0a20 2020 2023  l the FPGA.    #
-00016810: 2020 2020 2020 206c 6f67 6963 2069 7473         logic its
-00016820: 656c 6620 6973 2066 6978 6564 292c 2061  elf is fixed), a
-00016830: 6c77 6179 7320 7365 6e64 2061 2044 4953  lways send a DIS
-00016840: 4142 4c45 5f4c 4153 4552 2062 6566 6f72  ABLE_LASER befor
-00016850: 6520 6368 616e 6769 6e67 2074 6865 200a  e changing the .
-00016860: 2020 2020 2320 2020 2020 2020 7761 7463      #       watc
-00016870: 6864 6f67 2070 6572 696f 642e 0a20 2020  hdog period..   
-00016880: 2064 6566 2073 6574 5f6c 6173 6572 5f77   def set_laser_w
-00016890: 6174 6368 646f 675f 7365 6328 7365 6c66  atchdog_sec(self
-000168a0: 2c20 7365 6329 3a0a 2020 2020 2020 2020  , sec):.        
-000168b0: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
-000168c0: 696e 6773 2e69 735f 6d69 6372 6f28 293a  ings.is_micro():
-000168d0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-000168e0: 2e65 7272 6f72 2822 4c61 7365 7220 7761  .error("Laser wa
-000168f0: 7463 6864 6f67 206f 6e6c 7920 7375 7070  tchdog only supp
-00016900: 6f72 7465 6420 6f6e 2053 6572 6965 732d  orted on Series-
-00016910: 5853 2229 0a20 2020 2020 2020 2020 2020  XS").           
-00016920: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-00016930: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-00016940: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
-00016950: 673d 226c 6173 6572 2077 6174 6368 646f  g="laser watchdo
-00016960: 6720 6e6f 7420 7375 7070 6f72 7465 6422  g not supported"
-00016970: 290a 0a20 2020 2020 2020 2023 2072 656d  )..        # rem
-00016980: 6f76 6520 7468 6973 2063 616c 6c20 6166  ove this call af
-00016990: 7465 7220 7468 6520 5365 7269 6573 2d58  ter the Series-X
-000169a0: 5320 4152 4d20 2f20 4650 4741 2077 6174  S ARM / FPGA wat
-000169b0: 6368 646f 6720 6172 6520 6669 7865 640a  chdog are fixed.
-000169c0: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-000169d0: 5f6c 6173 6572 5f65 6e61 626c 6528 4661  _laser_enable(Fa
-000169e0: 6c73 6529 0a0a 2020 2020 2020 2020 2320  lse)..        # 
-000169f0: 7365 6e64 2076 616c 7565 2061 7320 6269  send value as bi
-00016a00: 672d 656e 6469 616e 0a20 2020 2020 2020  g-endian.       
-00016a10: 206d 7362 203d 2028 7365 6320 3e3e 2038   msb = (sec >> 8
-00016a20: 2920 2620 3078 6666 0a20 2020 2020 2020  ) & 0xff.       
-00016a30: 206c 7362 203d 2020 7365 6320 2020 2020   lsb =  sec     
-00016a40: 2020 2620 3078 6666 0a20 2020 2020 2020    & 0xff.       
-00016a50: 2076 616c 7565 203d 2028 6d73 6220 3c3c   value = (msb <<
-00016a60: 2038 2920 7c20 6c73 620a 0a20 2020 2020   8) | lsb..     
-00016a70: 2020 2073 656c 662e 7365 7474 696e 6773     self.settings
-00016a80: 2e73 7461 7465 2e6c 6173 6572 5f77 6174  .state.laser_wat
-00016a90: 6368 646f 675f 7365 6320 3d20 7365 630a  chdog_sec = sec.
-00016aa0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00016ab0: 656c 662e 5f73 656e 645f 636f 6465 2862  elf._send_code(b
-00016ac0: 5265 7175 6573 7420 2020 2020 2020 203d  Request        =
-00016ad0: 2030 7866 662c 0a20 2020 2020 2020 2020   0xff,.         
-00016ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016af0: 2020 2020 2077 5661 6c75 6520 2020 2020       wValue     
-00016b00: 2020 2020 203d 2030 7831 382c 0a20 2020       = 0x18,.   
-00016b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b20: 2020 2020 2020 2020 2020 2077 496e 6465             wInde
-00016b30: 7820 2020 2020 2020 2020 203d 2076 616c  x          = val
-00016b40: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-00016b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b60: 2020 6461 7461 5f6f 725f 774c 656e 6774    data_or_wLengt
-00016b70: 6820 3d20 5b30 5d20 2a20 382c 0a20 2020  h = [0] * 8,.   
-00016b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b90: 2020 2020 2020 2020 2020 206c 6162 656c             label
-00016ba0: 2020 2020 2020 2020 2020 203d 2022 5345             = "SE
-00016bb0: 545f 4c41 5345 525f 5741 5443 4844 4f47  T_LASER_WATCHDOG
-00016bc0: 5f53 4543 2229 0a0a 2020 2020 6465 6620  _SEC")..    def 
-00016bd0: 7570 6461 7465 5f6c 6173 6572 5f77 6174  update_laser_wat
-00016be0: 6368 646f 6728 7365 6c66 2920 2d3e 2053  chdog(self) -> S
-00016bf0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-00016c00: 6e73 653a 0a20 2020 2020 2020 2022 2222  nse:.        """
-00016c10: 0a20 2020 2020 2020 2041 7574 6f6d 6174  .        Automat
-00016c20: 6963 616c 6c79 2073 6574 2074 6865 206c  ically set the l
-00016c30: 6173 6572 2077 6174 6368 646f 6720 6c6f  aser watchdog lo
-00016c40: 6e67 2065 6e6f 7567 6820 746f 2068 616e  ng enough to han
-00016c50: 646c 6520 7468 6520 6375 7272 656e 740a  dle the current.
-00016c60: 2020 2020 2020 2020 696e 7465 6772 6174          integrat
-00016c70: 696f 6e20 7469 6d65 2c20 6173 7375 6d69  ion time, assumi
-00016c80: 6e67 2077 6520 6861 7665 2074 6f20 7065  ng we have to pe
-00016c90: 7266 6f72 6d20 3620 7468 726f 7761 7761  rform 6 throwawa
-00016ca0: 7973 206f 6e20 7468 6520 7365 6e73 6f72  ys on the sensor
-00016cb0: 0a20 2020 2020 2020 2069 6e20 6361 7365  .        in case
-00016cc0: 2069 7420 7765 6e74 2074 6f20 736c 6565   it went to slee
-00016cd0: 702e 0a0a 2020 2020 2020 2020 406e 6f74  p...        @not
-00016ce0: 6520 7765 2061 7265 206e 6f74 2063 7572  e we are not cur
-00016cf0: 7265 6e74 6c79 2075 7369 6e67 2074 6869  rently using thi
-00016d00: 7320 6675 6e63 7469 6f6e 0a20 2020 2020  s function.     
-00016d10: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00016d20: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
-00016d30: 6e67 732e 6973 5f6d 6963 726f 2829 206f  ngs.is_micro() o
-00016d40: 7220 6e6f 7420 7365 6c66 2e73 6574 7469  r not self.setti
-00016d50: 6e67 732e 6565 7072 6f6d 2e68 6173 5f6c  ngs.eeprom.has_l
-00016d60: 6173 6572 3a0a 2020 2020 2020 2020 2020  aser:.          
-00016d70: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
-00016d80: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
-00016d90: 7461 3d46 616c 7365 2c65 7272 6f72 5f6d  ta=False,error_m
-00016da0: 7367 3d22 7570 6461 7465 206c 6173 6572  sg="update laser
-00016db0: 2077 6174 6368 646f 6720 6e6f 7420 7375   watchdog not su
-00016dc0: 7070 6f72 7465 6422 290a 0a20 2020 2020  pported")..     
-00016dd0: 2020 2069 6e74 5f6d 7320 3d20 7365 6c66     int_ms = self
-00016de0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
-00016df0: 696e 7465 6772 6174 696f 6e5f 7469 6d65  integration_time
-00016e00: 5f6d 730a 2020 2020 2020 2020 7363 616e  _ms.        scan
-00016e10: 7320 203d 2073 656c 662e 7365 7474 696e  s  = self.settin
-00016e20: 6773 2e73 7461 7465 2e73 6361 6e73 5f74  gs.state.scans_t
-00016e30: 6f5f 6176 6572 6167 650a 2020 2020 2020  o_average.      
-00016e40: 2020 0a20 2020 2020 2020 2074 6872 6f77    .        throw
-00016e50: 6177 6179 735f 7365 6320 3d20 696e 745f  aways_sec = int_
-00016e60: 6d73 202a 2028 3820 2b20 7363 616e 7329  ms * (8 + scans)
-00016e70: 202f 2031 3030 302e 300a 2020 2020 2020   / 1000.0.      
-00016e80: 2020 7761 7463 6864 6f67 5f73 6563 203d    watchdog_sec =
-00016e90: 2069 6e74 286d 6178 2831 302c 2074 6872   int(max(10, thr
-00016ea0: 6f77 6177 6179 735f 7365 6329 2920 2a20  owaways_sec)) * 
-00016eb0: 320a 2020 2020 2020 2020 6c6f 672e 6465  2.        log.de
-00016ec0: 6275 6728 6622 7570 6461 7469 6e67 206c  bug(f"updating l
-00016ed0: 6173 6572 2077 6174 6368 646f 6720 746f  aser watchdog to
-00016ee0: 207b 7761 7463 6864 6f67 5f73 6563 7d20   {watchdog_sec} 
-00016ef0: 6261 7365 6420 6f6e 2069 6e74 6567 7261  based on integra
-00016f00: 7469 6f6e 2074 696d 6520 7b69 6e74 5f6d  tion time {int_m
-00016f10: 737d 6d73 2061 6e64 207b 7363 616e 737d  s}ms and {scans}
-00016f20: 2061 7665 7261 6769 6e67 2229 0a0a 2020   averaging")..  
-00016f30: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00016f40: 662e 7365 745f 6c61 7365 725f 7761 7463  f.set_laser_watc
-00016f50: 6864 6f67 5f73 6563 2877 6174 6368 646f  hdog_sec(watchdo
-00016f60: 675f 7365 6329 0a0a 2020 2020 6465 6620  g_sec)..    def 
-00016f70: 7365 745f 7665 7274 6963 616c 5f62 696e  set_vertical_bin
-00016f80: 6e69 6e67 2873 656c 662c 206c 696e 6573  ning(self, lines
-00016f90: 3a20 7475 706c 655b 696e 742c 2069 6e74  : tuple[int, int
-00016fa0: 5d29 202d 3e20 5370 6563 7472 6f6d 6574  ]) -> Spectromet
-00016fb0: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-00016fc0: 2020 2020 2320 6368 6563 6b20 666f 7220      # check for 
-00016fd0: 6c65 6761 6379 2076 6973 2073 696e 6365  legacy vis since
-00016fe0: 2074 6865 7920 646f 6e27 7420 6c69 6b65   they don't like
-00016ff0: 2076 6572 7469 6361 6c20 6269 6e6e 696e   vertical binnin
-00017000: 670a 2020 2020 2020 2020 6966 2073 656c  g.        if sel
-00017010: 662e 7365 7474 696e 6773 2e66 7067 615f  f.settings.fpga_
-00017020: 6669 726d 7761 7265 5f76 6572 7369 6f6e  firmware_version
-00017030: 203d 3d20 2230 3030 2d30 3038 2220 616e   == "000-008" an
-00017040: 6420 7365 6c66 2e73 6574 7469 6e67 732e  d self.settings.
-00017050: 6d69 6372 6f63 6f6e 7472 6f6c 6c65 725f  microcontroller_
-00017060: 6669 726d 7761 7265 5f76 6572 7369 6f6e  firmware_version
-00017070: 203d 3d20 2230 2e31 2e30 2e37 223a 0a20   == "0.1.0.7":. 
-00017080: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00017090: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
-000170a0: 7370 6f6e 7365 2864 6174 613d 4661 6c73  sponse(data=Fals
-000170b0: 6529 0a20 2020 2020 2020 2069 6620 6e6f  e).        if no
-000170c0: 7420 7365 6c66 2e73 6574 7469 6e67 732e  t self.settings.
-000170d0: 6973 5f6d 6963 726f 2829 3a0a 2020 2020  is_micro():.    
-000170e0: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-000170f0: 6728 2256 6572 7469 6361 6c20 4269 6e6e  g("Vertical Binn
-00017100: 696e 6720 6f6e 6c79 2063 6f6e 6669 6775  ing only configu
-00017110: 7261 626c 6520 6f6e 2053 6572 6965 732d  rable on Series-
-00017120: 5853 2229 0a20 2020 2020 2020 2020 2020  XS").           
-00017130: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-00017140: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-00017150: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
-00017160: 673d 2276 6572 7469 6361 6c20 6269 6e6e  g="vertical binn
-00017170: 696e 6720 6e6f 7420 7375 7070 6f72 7465  ing not supporte
-00017180: 6422 290a 0a20 2020 2020 2020 2074 7279  d")..        try
-00017190: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-000171a0: 6172 7420 3d20 6c69 6e65 735b 305d 0a20  art = lines[0]. 
-000171b0: 2020 2020 2020 2020 2020 2065 6e64 2020             end  
-000171c0: 203d 206c 696e 6573 5b31 5d0a 2020 2020   = lines[1].    
-000171d0: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
-000171e0: 2020 2020 2020 2020 6c6f 672e 6572 726f          log.erro
-000171f0: 7228 2273 6574 5f76 6572 7469 6361 6c5f  r("set_vertical_
-00017200: 6269 6e6e 696e 6720 7265 7175 6972 6573  binning requires
-00017210: 2061 2074 7570 6c65 206f 6620 2873 7461   a tuple of (sta
-00017220: 7274 2c20 7374 6f70 2920 6c69 6e65 7322  rt, stop) lines"
-00017230: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00017240: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
-00017250: 7252 6573 706f 6e73 6528 6461 7461 3d46  rResponse(data=F
-00017260: 616c 7365 2c65 7272 6f72 5f6d 7367 3d22  alse,error_msg="
-00017270: 696e 7661 6c69 6420 7374 6172 7420 616e  invalid start an
-00017280: 6420 7374 6f70 206c 696e 6573 2229 0a0a  d stop lines")..
-00017290: 2020 2020 2020 2020 6966 2073 7461 7274          if start
-000172a0: 203c 2030 206f 7220 656e 6420 3c20 303a   < 0 or end < 0:
-000172b0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-000172c0: 2e65 7272 6f72 2822 7365 745f 7665 7274  .error("set_vert
-000172d0: 6963 616c 5f62 696e 6e69 6e67 2072 6571  ical_binning req
-000172e0: 7569 7265 7320 6120 7475 706c 6520 6f66  uires a tuple of
-000172f0: 2050 4f53 4954 4956 4520 2873 7461 7274   POSITIVE (start
-00017300: 2c20 7374 6f70 2920 6c69 6e65 7322 290a  , stop) lines").
-00017310: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017320: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-00017330: 6573 706f 6e73 6528 6461 7461 3d46 616c  esponse(data=Fal
-00017340: 7365 2c65 7272 6f72 5f6d 7367 3d22 696e  se,error_msg="in
-00017350: 7661 6c69 6420 7374 6172 7420 616e 6420  valid start and 
-00017360: 7374 6f70 206c 696e 6573 2229 0a0a 2020  stop lines")..  
-00017370: 2020 2020 2020 2320 656e 666f 7263 6520        # enforce 
-00017380: 6173 6365 6e64 696e 6720 6f72 6465 7220  ascending order 
-00017390: 2861 6c73 6f2c 206e 6f74 6520 7468 6174  (also, note that
-000173a0: 2073 746f 7020 6c69 6e65 2069 7320 226c   stop line is "l
-000173b0: 6173 7420 6c69 6e65 2062 696e 6e65 6420  ast line binned 
-000173c0: 2b20 3122 2c20 736f 2073 746f 7020 6d75  + 1", so stop mu
-000173d0: 7374 2062 6520 3e20 7374 6172 7429 0a20  st be > start). 
-000173e0: 2020 2020 2020 2069 6620 7374 6172 7420         if start 
-000173f0: 3e3d 2065 6e64 3a0a 2020 2020 2020 2020  >= end:.        
-00017400: 2020 2020 2320 2873 7461 7274 2c20 656e      # (start, en
-00017410: 6429 203d 2028 656e 642c 2073 7461 7274  d) = (end, start
-00017420: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-00017430: 672e 6572 726f 7228 2273 6574 5f76 6572  g.error("set_ver
-00017440: 7469 6361 6c5f 6269 6e6e 696e 6720 7265  tical_binning re
-00017450: 7175 6972 6573 2061 7363 656e 6469 6e67  quires ascending
-00017460: 206f 7264 6572 2028 6967 6e6f 7269 6e67   order (ignoring
-00017470: 2025 642c 2025 6429 222c 2073 7461 7274   %d, %d)", start
-00017480: 2c20 656e 6429 0a20 2020 2020 2020 2020  , end).         
-00017490: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
-000174a0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
-000174b0: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
-000174c0: 6d73 673d 2269 6e76 616c 6964 2073 7461  msg="invalid sta
-000174d0: 7274 2061 6e64 2073 746f 7020 6c69 6e65  rt and stop line
-000174e0: 7322 290a 0a20 2020 2020 2020 206f 6b31  s")..        ok1
-000174f0: 203d 2073 656c 662e 5f73 656e 645f 636f   = self._send_co
-00017500: 6465 2862 5265 7175 6573 7420 2020 2020  de(bRequest     
-00017510: 2020 203d 2030 7866 662c 0a20 2020 2020     = 0xff,.     
-00017520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017530: 2020 2020 2020 2020 7756 616c 7565 2020          wValue  
-00017540: 2020 2020 2020 2020 3d20 3078 3231 2c0a          = 0x21,.
-00017550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017560: 2020 2020 2020 2020 2020 2020 2077 496e               wIn
-00017570: 6465 7820 2020 2020 2020 2020 203d 2073  dex          = s
-00017580: 7461 7274 2c0a 2020 2020 2020 2020 2020  tart,.          
-00017590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175a0: 2020 2064 6174 615f 6f72 5f77 4c65 6e67     data_or_wLeng
-000175b0: 7468 203d 205b 305d 202a 2038 2c0a 2020  th = [0] * 8,.  
-000175c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175d0: 2020 2020 2020 2020 2020 206c 6162 656c             label
-000175e0: 2020 2020 2020 2020 2020 203d 2022 5345             = "SE
-000175f0: 545f 4343 445f 5354 4152 545f 4c49 4e45  T_CCD_START_LINE
-00017600: 2229 0a20 2020 2020 2020 2069 6620 6f6b  ").        if ok
-00017610: 312e 6572 726f 725f 6d73 6720 213d 2027  1.error_msg != '
-00017620: 273a 0a20 2020 2020 2020 2020 2020 2072  ':.            r
-00017630: 6574 7572 6e20 6f6b 310a 0a20 2020 2020  eturn ok1..     
-00017640: 2020 206f 6b32 203d 2073 656c 662e 5f73     ok2 = self._s
-00017650: 656e 645f 636f 6465 2862 5265 7175 6573  end_code(bReques
-00017660: 7420 2020 2020 2020 203d 2030 7866 662c  t        = 0xff,
-00017670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017680: 2020 2020 2020 2020 2020 2020 2020 7756                wV
-00017690: 616c 7565 2020 2020 2020 2020 2020 3d20  alue          = 
-000176a0: 3078 3233 2c0a 2020 2020 2020 2020 2020  0x23,.          
-000176b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176c0: 2020 2077 496e 6465 7820 2020 2020 2020     wIndex       
-000176d0: 2020 203d 2065 6e64 2c0a 2020 2020 2020     = end,.      
-000176e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176f0: 2020 2020 2020 2064 6174 615f 6f72 5f77         data_or_w
-00017700: 4c65 6e67 7468 203d 205b 305d 202a 2038  Length = [0] * 8
-00017710: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017720: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00017730: 6162 656c 2020 2020 2020 2020 2020 203d  abel           =
-00017740: 2022 5345 545f 4343 445f 5354 4f50 5f4c   "SET_CCD_STOP_L
-00017750: 494e 4522 290a 2020 2020 2020 2020 6966  INE").        if
-00017760: 206f 6b32 2e65 7272 6f72 5f6d 7367 2021   ok2.error_msg !
-00017770: 3d20 2727 3a0a 2020 2020 2020 2020 2020  = '':.          
-00017780: 2020 7265 7475 726e 206f 6b32 0a20 2020    return ok2.   
-00017790: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
-000177a0: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-000177b0: 2864 6174 613d 6f6b 312e 6461 7461 2061  (data=ok1.data a
-000177c0: 6e64 206f 6b32 2e64 6174 6129 0a0a 2020  nd ok2.data)..  
-000177d0: 2020 2323 200a 2020 2020 2320 4070 6172    ## .    # @par
-000177e0: 616d 7320 6d6f 6465 3a20 696e 7465 6772  ams mode: integr
-000177f0: 616c 2076 616c 7565 2030 2d33 0a20 2020  al value 0-3.   
-00017800: 2023 0a20 2020 2023 205c 7665 7262 6f73   #.    # \verbos
-00017810: 650a 2020 2020 2320 6d6f 6465 2020 4144  e.    # mode  AD
-00017820: 4320 2841 4429 2020 2050 6978 656c 2057  C (AD)   Pixel W
-00017830: 6964 7468 2028 4f44 290a 2020 2020 2320  idth (OD).    # 
-00017840: 6230 3020 2020 3130 2d62 6974 2020 2020  b00   10-bit    
-00017850: 2031 302d 6269 740a 2020 2020 2320 6230   10-bit.    # b0
-00017860: 3120 2020 3130 2d62 6974 2020 2020 2031  1   10-bit     1
-00017870: 322d 6269 740a 2020 2020 2320 6231 3020  2-bit.    # b10 
-00017880: 2020 3132 2d62 6974 2020 2020 2031 302d    12-bit     10-
-00017890: 6269 740a 2020 2020 2320 6231 3120 2020  bit.    # b11   
-000178a0: 3132 2d62 6974 2020 2020 2031 322d 6269  12-bit     12-bi
-000178b0: 740a 2020 2020 2320 5c65 6e64 7665 7262  t.    # \endverb
-000178c0: 6f73 650a 2020 2020 6465 6620 7365 745f  ose.    def set_
-000178d0: 7069 7865 6c5f 6d6f 6465 2873 656c 662c  pixel_mode(self,
-000178e0: 206d 6f64 653a 2066 6c6f 6174 2920 2d3e   mode: float) ->
-000178f0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-00017900: 706f 6e73 653a 0a20 2020 2020 2020 2069  ponse:.        i
-00017910: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
-00017920: 6e67 732e 6973 5f6d 6963 726f 2829 3a0a  ngs.is_micro():.
-00017930: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
-00017940: 6465 6275 6728 2250 6978 656c 204d 6f64  debug("Pixel Mod
-00017950: 6520 6f6e 6c79 2063 6f6e 6669 6775 7261  e only configura
-00017960: 626c 6520 6f6e 2053 6572 6965 732d 5853  ble on Series-XS
-00017970: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00017980: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-00017990: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-000179a0: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
-000179b0: 2270 6978 656c 206d 6f64 6520 6e6f 7420  "pixel mode not 
-000179c0: 7375 7070 6f72 7465 6422 290a 0a20 2020  supported")..   
-000179d0: 2020 2020 2023 2077 6520 6f6e 6c79 2063       # we only c
-000179e0: 6172 6520 6162 6f75 7420 7468 6520 7477  are about the tw
-000179f0: 6f20 6c65 6173 742d 7369 676e 6966 6963  o least-signific
-00017a00: 616e 7420 6269 7473 0a20 2020 2020 2020  ant bits.       
-00017a10: 206d 6f64 6520 3d20 696e 7428 726f 756e   mode = int(roun
-00017a20: 6428 6d6f 6465 2929 2026 2030 7833 200a  d(mode)) & 0x3 .
-00017a30: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-00017a40: 3d20 7365 6c66 2e5f 7365 6e64 5f63 6f64  = self._send_cod
-00017a50: 6528 6252 6571 7565 7374 203d 2030 7866  e(bRequest = 0xf
-00017a60: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-00017a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a80: 2020 2077 5661 6c75 6520 2020 3d20 6d6f     wValue   = mo
-00017a90: 6465 2c0a 2020 2020 2020 2020 2020 2020  de,.            
-00017aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ab0: 2020 2020 6c61 6265 6c20 2020 203d 2022      label    = "
-00017ac0: 5345 545f 5049 5845 4c5f 4d4f 4445 2229  SET_PIXEL_MODE")
-00017ad0: 0a0a 2020 2020 2020 2020 6c6f 672e 6465  ..        log.de
-00017ae0: 6275 6728 2277 6169 7469 6e67 2031 7365  bug("waiting 1se
-00017af0: 632e 2e2e 2229 0a20 2020 2020 2020 2073  c...").        s
-00017b00: 6c65 6570 2831 290a 0a20 2020 2020 2020  leep(1)..       
-00017b10: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
-00017b20: 2020 2020 6465 6620 636c 6561 725f 7265      def clear_re
-00017b30: 6769 6f6e 7328 7365 6c66 2920 2d3e 2053  gions(self) -> S
-00017b40: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-00017b50: 6e73 653a 0a20 2020 2020 2020 2078 3120  nse:.        x1 
-00017b60: 3d20 7365 6c66 2e73 6574 7469 6e67 732e  = self.settings.
-00017b70: 6565 7072 6f6d 2e61 6374 6976 655f 7069  eeprom.active_pi
-00017b80: 7865 6c73 5f68 6f72 697a 6f6e 7461 6c0a  xels_horizontal.
-00017b90: 2020 2020 2020 2020 7931 203d 2073 656c          y1 = sel
-00017ba0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
-00017bb0: 6d2e 6163 7469 7665 5f70 6978 656c 735f  m.active_pixels_
-00017bc0: 7665 7274 6963 616c 0a20 2020 2020 2020  vertical.       
-00017bd0: 206c 6f67 2e64 6562 7567 2866 2272 6573   log.debug(f"res
-00017be0: 6574 7469 6e67 7320 6465 7465 6374 6f72  ettings detector
-00017bf0: 2074 6f20 6675 6c6c 2028 7b78 317d 2c20   to full ({x1}, 
-00017c00: 7b79 317d 2920 6578 7465 6e74 2229 0a0a  {y1}) extent")..
-00017c10: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-00017c20: 7469 6e67 732e 7374 6174 652e 7265 6769  tings.state.regi
-00017c30: 6f6e 203d 204e 6f6e 650a 2020 2020 2020  on = None.      
-00017c40: 2020 7365 6c66 2e73 6574 7469 6e67 732e    self.settings.
-00017c50: 7570 6461 7465 5f77 6176 6563 616c 2829  update_wavecal()
-00017c60: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00017c70: 2073 656c 662e 7365 745f 6465 7465 6374   self.set_detect
-00017c80: 6f72 5f72 6f69 285b 302c 2030 2c20 7931  or_roi([0, 0, y1
-00017c90: 2c20 302c 2078 315d 2c20 7374 6f72 653d  , 0, x1], store=
-00017ca0: 4661 6c73 6529 0a0a 2020 2020 6465 6620  False)..    def 
-00017cb0: 7365 745f 7369 6e67 6c65 5f72 6567 696f  set_single_regio
-00017cc0: 6e28 7365 6c66 2c20 6e3a 2069 6e74 2920  n(self, n: int) 
-00017cd0: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-00017ce0: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-00017cf0: 2022 2222 0a20 2020 2020 2020 2054 6869   """.        Thi
-00017d00: 7320 6675 6e63 7469 6f6e 2075 7365 7320  s function uses 
-00017d10: 7468 6520 7468 6520 6d75 6c74 692d 7265  the the multi-re
-00017d20: 6769 6f6e 2066 6561 7475 7265 2074 6f20  gion feature to 
-00017d30: 7365 6c65 6374 206a 7573 7420 6120 7369  select just a si
-00017d40: 6e67 6c65 200a 2020 2020 2020 2020 7072  ngle .        pr
-00017d50: 652d 636f 6e66 6967 7572 6564 2072 6567  e-configured reg
-00017d60: 696f 6e20 6174 2061 2074 696d 652e 2020  ion at a time.  
-00017d70: 5768 6963 6865 7665 7220 7265 6769 6f6e  Whichever region
-00017d80: 2069 7320 7365 6c65 6374 6564 2c20 7468   is selected, th
-00017d90: 6174 200a 2020 2020 2020 2020 7265 6769  at .        regi
-00017da0: 6f6e 2773 2070 6172 616d 6574 6572 7320  on's parameters 
-00017db0: 6172 6520 7772 6974 7465 6e20 746f 2022  are written to "
-00017dc0: 7265 6769 6f6e 2030 2220 6f66 2074 6865  region 0" of the
-00017dd0: 2073 7065 6374 726f 6d65 7465 722c 2061   spectrometer, a
-00017de0: 6e64 0a20 2020 2020 2020 2074 6865 2067  nd.        the g
-00017df0: 6c6f 6261 6c20 7761 7665 6361 6c20 6973  lobal wavecal is
-00017e00: 2075 7064 6174 6564 2074 6f20 7573 6520   updated to use 
-00017e10: 7468 6174 2072 6567 696f 6e27 7320 6361  that region's ca
-00017e20: 6c69 6272 6174 696f 6e2e 0a20 2020 2020  libration..     
-00017e30: 2020 0a20 2020 2020 2020 2040 746f 646f    .        @todo
-00017e40: 2063 6f6e 7369 6465 7220 636c 6561 725f   consider clear_
-00017e50: 7265 6769 6f6e 2829 2066 756e 6374 696f  region() functio
-00017e60: 6e20 746f 2072 6573 746f 7265 2070 6879  n to restore phy
-00017e70: 7369 6361 6c20 524f 4920 746f 200a 2020  sical ROI to .  
-00017e80: 2020 2020 2020 2020 2020 2830 2c20 6163            (0, ac
-00017e90: 7469 7665 5f76 6572 7469 6361 6c5f 7069  tive_vertical_pi
-00017ea0: 7865 6c73 2c20 302c 2061 6374 6976 655f  xels, 0, active_
-00017eb0: 686f 7269 7a6f 6e74 616c 5f70 6978 656c  horizontal_pixel
-00017ec0: 7329 0a20 2020 2020 2020 2020 2020 2028  s).            (
-00017ed0: 6c65 6176 6520 7761 7665 6361 6c20 616c  leave wavecal al
-00017ee0: 6f6e 653f 290a 2020 2020 2020 2020 2222  one?).        ""
-00017ef0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00017f00: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-00017f10: 2e64 6574 6563 746f 725f 7265 6769 6f6e  .detector_region
-00017f20: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00017f30: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
-00017f40: 2866 226e 6f20 6465 7465 6374 6f72 2072  (f"no detector r
-00017f50: 6567 696f 6e73 2063 6f6e 6669 6775 7265  egions configure
-00017f60: 6422 290a 2020 2020 2020 2020 2020 2020  d").            
-00017f70: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-00017f80: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
-00017f90: 3d46 616c 7365 2c65 7272 6f72 5f6d 7367  =False,error_msg
-00017fa0: 3d22 6e6f 2072 6567 696f 6e73 2063 6f6e  ="no regions con
-00017fb0: 6669 6775 7265 6422 290a 0a20 2020 2020  figured")..     
-00017fc0: 2020 2072 6f69 203d 2073 656c 662e 7365     roi = self.se
-00017fd0: 7474 696e 6773 2e73 7461 7465 2e64 6574  ttings.state.det
-00017fe0: 6563 746f 725f 7265 6769 6f6e 732e 6765  ector_regions.ge
-00017ff0: 745f 726f 6928 6e29 0a20 2020 2020 2020  t_roi(n).       
-00018000: 2069 6620 726f 6920 6973 204e 6f6e 653a   if roi is None:
-00018010: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00018020: 2e64 6562 7567 2866 2275 6e63 6f6e 6669  .debug(f"unconfi
-00018030: 6775 7265 6420 7265 6769 6f6e 207b 6e7d  gured region {n}
-00018040: 2028 6d61 7820 7b73 656c 662e 7365 7474   (max {self.sett
-00018050: 696e 6773 2e65 6570 726f 6d2e 7265 6769  ings.eeprom.regi
-00018060: 6f6e 5f63 6f75 6e74 7d22 290a 2020 2020  on_count}").    
-00018070: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-00018080: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-00018090: 6e73 6528 6461 7461 3d46 616c 7365 2c65  nse(data=False,e
-000180a0: 7272 6f72 5f6d 7367 3d22 756e 636f 6e66  rror_msg="unconf
-000180b0: 6967 7572 6564 2072 6567 696f 6e22 290a  igured region").
-000180c0: 0a20 2020 2020 2020 206c 6f67 2e64 6562  .        log.deb
-000180d0: 7567 2866 2273 6574 5f73 696e 676c 655f  ug(f"set_single_
-000180e0: 7265 6769 6f6e 3a20 6170 706c 7969 6e67  region: applying
-000180f0: 2072 6567 696f 6e20 7b6e 7d3a 207b 726f   region {n}: {ro
-00018100: 697d 2229 0a20 2020 2020 2020 2073 656c  i}").        sel
-00018110: 662e 7365 7474 696e 6773 2e73 6574 5f73  f.settings.set_s
-00018120: 696e 676c 655f 7265 6769 6f6e 286e 290a  ingle_region(n).
-00018130: 0a20 2020 2020 2020 2023 2073 656e 6420  .        # send 
-00018140: 6120 2266 616b 6522 2052 4f49 2064 6f77  a "fake" ROI dow
-00018150: 6e73 7472 6561 6d2c 206f 7665 7272 6964  nstream, overrid
-00018160: 696e 6720 746f 2070 6f73 6974 696f 6e20  ing to position 
-00018170: 300a 2020 2020 2020 2020 7365 6c66 2e73  0.        self.s
-00018180: 6574 5f64 6574 6563 746f 725f 726f 6928  et_detector_roi(
-00018190: 5b30 2c20 726f 692e 7930 2c20 726f 692e  [0, roi.y0, roi.
-000181a0: 7931 2c20 726f 692e 7830 2c20 726f 692e  y1, roi.x0, roi.
-000181b0: 7831 5d2c 2073 746f 7265 3d46 616c 7365  x1], store=False
-000181c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000181d0: 2053 7053 7065 6374 726f 6d65 7465 7252   SpSpectrometerR
-000181e0: 6573 706f 6e73 6528 290a 0a20 2020 2064  esponse()..    d
-000181f0: 6566 2073 6574 5f64 6574 6563 746f 725f  ef set_detector_
-00018200: 726f 6928 7365 6c66 2c20 6172 6773 3a20  roi(self, args: 
-00018210: 6c69 7374 5b66 6c6f 6174 5d2c 2073 746f  list[float], sto
-00018220: 7265 3a20 626f 6f6c 203d 2054 7275 6529  re: bool = True)
-00018230: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
-00018240: 5265 7370 6f6e 7365 3a0a 2020 2020 2020  Response:.      
-00018250: 2020 2222 220a 2020 2020 2020 2020 4e6f    """.        No
-00018260: 7465 2074 6869 7320 6f6e 6c79 2073 656e  te this only sen
-00018270: 6473 2074 6865 2052 4f49 2064 6f77 6e73  ds the ROI downs
-00018280: 7472 6561 6d20 746f 2074 6865 2073 7065  tream to the spe
-00018290: 6374 726f 6d65 7465 7220 2861 6e64 2073  ctrometer (and s
-000182a0: 746f 7265 730a 2020 2020 2020 2020 6974  tores.        it
-000182b0: 2069 6e20 4465 7465 6374 6f72 5265 6769   in DetectorRegi
-000182c0: 6f6e 7329 2e20 2049 6620 796f 7520 7761  ons).  If you wa
-000182d0: 6e74 2074 6f20 7570 6461 7465 2074 6865  nt to update the
-000182e0: 2077 6176 6563 616c 2061 6e64 2073 746f   wavecal and sto
-000182f0: 7265 0a20 2020 2020 2020 2074 6865 2022  re.        the "
-00018300: 7365 6c65 6374 6564 2220 7265 6769 6f6e  selected" region
-00018310: 2069 6e64 6578 2c20 7573 6520 7365 745f   index, use set_
-00018320: 7265 6769 6f6e 2829 2069 6e73 7465 6164  region() instead
-00018330: 2028 7768 6963 6820 6361 6c6c 7320 7468   (which calls th
-00018340: 6973 292e 0a20 2020 2020 2020 200a 2020  is)..        .  
-00018350: 2020 2020 2020 596f 7520 7368 6f75 6c64        You should
-00018360: 2075 7365 2073 6574 5f72 6567 696f 6e28   use set_region(
-00018370: 2920 6966 2079 6f75 2061 7265 2073 656c  ) if you are sel
-00018380: 6563 7469 6e67 206f 6e65 206f 6620 7468  ecting one of th
-00018390: 6520 7374 616e 6461 7264 0a20 2020 2020  e standard.     
-000183a0: 2020 2072 6567 696f 6e73 2061 6c72 6561     regions alrea
-000183b0: 6479 2063 6f6e 6669 6775 7265 6420 6f6e  dy configured on
-000183c0: 2074 6865 2045 4550 524f 4d2e 2020 596f   the EEPROM.  Yo
-000183d0: 7520 7368 6f75 6c64 2075 7365 2073 6574  u should use set
-000183e0: 5f64 6574 6563 746f 725f 726f 6928 290a  _detector_roi().
-000183f0: 2020 2020 2020 2020 6966 2079 6f75 2772          if you'r
-00018400: 6520 6d61 6b69 6e67 2061 642d 686f 6320  e making ad-hoc 
-00018410: 524f 4973 2077 6869 6368 2061 7265 6e27  ROIs which aren'
-00018420: 7420 636f 6e66 6967 7572 6564 206f 6e20  t configured on 
-00018430: 7468 6520 4545 5052 4f4d 2e0a 2020 2020  the EEPROM..    
-00018440: 2020 2020 0a20 2020 2020 2020 2040 7061      .        @pa
-00018450: 7261 6d20 6172 6773 3a20 6569 7468 6572  ram args: either
-00018460: 2061 2044 6574 6563 746f 7252 4f49 206f   a DetectorROI o
-00018470: 7220 6120 7475 706c 6520 6f66 2028 7265  r a tuple of (re
-00018480: 6769 6f6e 2c20 7930 2c20 7931 2c20 7830  gion, y0, y1, x0
-00018490: 2c20 7831 290a 2020 2020 2020 2020 2222  , x1).        ""
-000184a0: 220a 2020 2020 2020 2020 6966 206e 6f74  ".        if not
-000184b0: 2073 656c 662e 7365 7474 696e 6773 2e69   self.settings.i
-000184c0: 735f 6d69 6372 6f28 293a 0a20 2020 2020  s_micro():.     
-000184d0: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
-000184e0: 2822 4465 7465 6374 6f72 2052 4f49 206f  ("Detector ROI o
-000184f0: 6e6c 7920 636f 6e66 6967 7572 6162 6c65  nly configurable
-00018500: 206f 6e20 5365 7269 6573 2d58 5322 290a   on Series-XS").
-00018510: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00018520: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-00018530: 6573 706f 6e73 6528 6461 7461 3d46 616c  esponse(data=Fal
-00018540: 7365 2c65 7272 6f72 5f6d 7367 3d22 4465  se,error_msg="De
-00018550: 7465 6374 6f72 2052 4f49 206e 6f74 2063  tector ROI not c
-00018560: 6f6e 6669 6775 7261 626c 6522 290a 0a20  onfigurable").. 
-00018570: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00018580: 616e 6365 2861 7267 732c 2044 6574 6563  ance(args, Detec
-00018590: 746f 7252 4f49 293a 0a20 2020 2020 2020  torROI):.       
-000185a0: 2020 2020 2072 6f69 203d 2061 7267 730a       roi = args.
-000185b0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
-000185c0: 6465 6275 6728 6622 7061 7373 6564 2044  debug(f"passed D
-000185d0: 6574 6563 746f 7252 4f49 3a20 7b72 6f69  etectorROI: {roi
-000185e0: 7d22 290a 2020 2020 2020 2020 656c 7365  }").        else
-000185f0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00018600: 636f 6e76 6572 7420 6172 6773 2074 6f20  convert args to 
-00018610: 524f 490a 2020 2020 2020 2020 2020 2020  ROI.            
-00018620: 6c6f 672e 6465 6275 6728 6622 6372 6561  log.debug(f"crea
-00018630: 7469 6e67 2044 6574 6563 746f 7252 4f49  ting DetectorROI
-00018640: 2066 726f 6d20 6172 6773 3a20 7b61 7267   from args: {arg
-00018650: 737d 2229 0a0a 2020 2020 2020 2020 2020  s}")..          
-00018660: 2020 6966 206c 656e 2861 7267 7329 2021    if len(args) !
-00018670: 3d20 353a 0a20 2020 2020 2020 2020 2020  = 5:.           
-00018680: 2020 2020 206c 6f67 2e65 7272 6f72 2866       log.error(f
-00018690: 2269 6e76 616c 6964 2064 6574 6563 746f  "invalid detecto
-000186a0: 7220 726f 6920 6172 6773 3a20 7b61 7267  r roi args: {arg
-000186b0: 737d 2229 0a20 2020 2020 2020 2020 2020  s}").           
-000186c0: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
-000186d0: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-000186e0: 2864 6174 613d 4661 6c73 652c 6572 726f  (data=False,erro
-000186f0: 725f 6d73 673d 2269 6e76 616c 6964 2072  r_msg="invalid r
-00018700: 6f69 2061 7267 7322 290a 0a20 2020 2020  oi args")..     
-00018710: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
-00018720: 696e 7428 726f 756e 6428 6172 6773 5b30  int(round(args[0
-00018730: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-00018740: 7930 2020 2020 203d 2069 6e74 2872 6f75  y0     = int(rou
-00018750: 6e64 2861 7267 735b 315d 2929 0a20 2020  nd(args[1])).   
-00018760: 2020 2020 2020 2020 2079 3120 2020 2020           y1     
-00018770: 3d20 696e 7428 726f 756e 6428 6172 6773  = int(round(args
-00018780: 5b32 5d29 290a 2020 2020 2020 2020 2020  [2])).          
-00018790: 2020 7830 2020 2020 203d 2069 6e74 2872    x0     = int(r
-000187a0: 6f75 6e64 2861 7267 735b 335d 2929 0a20  ound(args[3])). 
-000187b0: 2020 2020 2020 2020 2020 2078 3120 2020             x1   
-000187c0: 2020 3d20 696e 7428 726f 756e 6428 6172    = int(round(ar
-000187d0: 6773 5b34 5d29 290a 0a20 2020 2020 2020  gs[4]))..       
-000187e0: 2020 2020 2069 6620 6e6f 7420 2830 203c       if not (0 <
-000187f0: 3d20 7265 6769 6f6e 203c 3d20 3320 616e  = region <= 3 an
-00018800: 6420 5c0a 2020 2020 2020 2020 2020 2020  d \.            
-00018810: 2020 2020 2020 2020 7930 203c 2079 3120          y0 < y1 
-00018820: 616e 6420 5c0a 2020 2020 2020 2020 2020  and \.          
-00018830: 2020 2020 2020 2020 2020 7830 203c 2078            x0 < x
-00018840: 3120 616e 6420 5c0a 2020 2020 2020 2020  1 and \.        
-00018850: 2020 2020 2020 2020 2020 2020 7930 203e              y0 >
-00018860: 3d20 3020 616e 6420 5c0a 2020 2020 2020  = 0 and \.      
-00018870: 2020 2020 2020 2020 2020 2020 2020 7830                x0
-00018880: 203e 3d20 3020 616e 6420 5c0a 2020 2020   >= 0 and \.    
-00018890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188a0: 7931 203c 3d20 7365 6c66 2e73 6574 7469  y1 <= self.setti
-000188b0: 6e67 732e 6565 7072 6f6d 2e61 6374 6976  ngs.eeprom.activ
-000188c0: 655f 7069 7865 6c73 5f68 6f72 697a 6f6e  e_pixels_horizon
-000188d0: 7461 6c20 616e 6420 5c0a 2020 2020 2020  tal and \.      
-000188e0: 2020 2020 2020 2020 2020 2020 2020 7831                x1
-000188f0: 203c 3d20 7365 6c66 2e73 6574 7469 6e67   <= self.setting
-00018900: 732e 6565 7072 6f6d 2e61 6374 6976 655f  s.eeprom.active_
-00018910: 7069 7865 6c73 5f68 6f72 697a 6f6e 7461  pixels_horizonta
-00018920: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
-00018930: 2020 2020 6c6f 672e 6572 726f 7228 6622      log.error(f"
-00018940: 696e 7661 6c69 6420 6465 7465 6374 6f72  invalid detector
-00018950: 2072 6f69 3a20 7b61 7267 737d 2229 0a20   roi: {args}"). 
-00018960: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00018970: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-00018980: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-00018990: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
-000189a0: 2269 6e76 616c 6964 2072 6f69 2061 7267  "invalid roi arg
-000189b0: 7322 290a 2020 2020 2020 2020 2020 2020  s").            
-000189c0: 726f 6920 3d20 4465 7465 6374 6f72 524f  roi = DetectorRO
-000189d0: 4928 7265 6769 6f6e 2c20 7930 2c20 7931  I(region, y0, y1
-000189e0: 2c20 7830 2c20 7831 290a 2020 2020 2020  , x0, x1).      
-000189f0: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-00018a00: 6622 6372 6561 7465 6420 4465 7465 6374  f"created Detect
-00018a10: 6f72 524f 493a 207b 726f 697d 2229 0a0a  orROI: {roi}")..
-00018a20: 2020 2020 2020 2020 2320 6465 7465 726d          # determ
-00018a30: 696e 6520 7072 6576 696f 7573 2074 6f74  ine previous tot
-00018a40: 616c 2070 6978 656c 730a 2020 2020 2020  al pixels.      
-00018a50: 2020 7365 6c66 2e70 7265 765f 7069 7865    self.prev_pixe
-00018a60: 6c73 203d 2073 656c 662e 7365 7474 696e  ls = self.settin
-00018a70: 6773 2e70 6978 656c 7328 290a 2020 2020  gs.pixels().    
-00018a80: 2020 2020 6c6f 672e 6465 6275 6728 6622      log.debug(f"
-00018a90: 7072 6576 5f70 6978 656c 7320 3d20 7b73  prev_pixels = {s
-00018aa0: 656c 662e 7072 6576 5f70 6978 656c 737d  elf.prev_pixels}
-00018ab0: 2229 0a0a 2020 2020 2020 2020 6966 2073  ")..        if s
-00018ac0: 746f 7265 3a0a 2020 2020 2020 2020 2020  tore:.          
-00018ad0: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
-00018ae0: 6773 2e73 7461 7465 2e64 6574 6563 746f  gs.state.detecto
-00018af0: 725f 7265 6769 6f6e 7320 6973 204e 6f6e  r_regions is Non
-00018b00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00018b10: 2020 206c 6f67 2e64 6562 7567 2822 6372     log.debug("cr
-00018b20: 6561 7469 6e67 2044 6574 6563 746f 7252  eating DetectorR
-00018b30: 6567 696f 6e73 2229 0a20 2020 2020 2020  egions").       
-00018b40: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
-00018b50: 7474 696e 6773 2e73 7461 7465 2e64 6574  ttings.state.det
-00018b60: 6563 746f 725f 7265 6769 6f6e 7320 3d20  ector_regions = 
-00018b70: 4465 7465 6374 6f72 5265 6769 6f6e 7328  DetectorRegions(
-00018b80: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00018b90: 2074 6869 7320 6973 2061 206e 6f2d 6f70   this is a no-op
-00018ba0: 2069 6620 6974 2773 2061 6c72 6561 6479   if it's already
-00018bb0: 2070 7265 7365 6e74 2061 6e64 2075 6e63   present and unc
-00018bc0: 6861 6e67 6564 0a20 2020 2020 2020 2020  hanged.         
-00018bd0: 2020 206c 6f67 2e64 6562 7567 2822 7361     log.debug("sa
-00018be0: 7669 6e67 2044 6574 6563 746f 7252 4f49  ving DetectorROI
-00018bf0: 2069 6e20 4465 7465 6374 6f72 5265 6769   in DetectorRegi
-00018c00: 6f6e 7322 290a 2020 2020 2020 2020 2020  ons").          
-00018c10: 2020 7365 6c66 2e73 6574 7469 6e67 732e    self.settings.
-00018c20: 7374 6174 652e 6465 7465 6374 6f72 5f72  state.detector_r
-00018c30: 6567 696f 6e73 2e61 6464 2872 6f69 290a  egions.add(roi).
-00018c40: 0a20 2020 2020 2020 206c 6f67 2e64 6562  .        log.deb
-00018c50: 7567 2866 2274 6f74 616c 5f70 6978 656c  ug(f"total_pixel
-00018c60: 7320 6e6f 7720 7b73 656c 662e 7365 7474  s now {self.sett
-00018c70: 696e 6773 2e70 6978 656c 7328 297d 2229  ings.pixels()}")
-00018c80: 0a0a 2020 2020 2020 2020 6275 6620 3d20  ..        buf = 
-00018c90: 7574 696c 732e 7569 6e74 3136 5f74 6f5f  utils.uint16_to_
-00018ca0: 6c69 7474 6c65 5f65 6e64 6961 6e28 5b20  little_endian([ 
-00018cb0: 726f 692e 7930 2c20 726f 692e 7931 2c20  roi.y0, roi.y1, 
-00018cc0: 726f 692e 7830 2c20 726f 692e 7831 205d  roi.x0, roi.x1 ]
-00018cd0: 290a 2020 2020 2020 2020 6c6f 672e 6465  ).        log.de
-00018ce0: 6275 6728 2277 6f75 6c64 2073 656e 6420  bug("would send 
-00018cf0: 6275 663a 2025 7322 2c20 6275 6629 0a0a  buf: %s", buf)..
-00018d00: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00018d10: 2073 656c 662e 5f73 656e 645f 636f 6465   self._send_code
-00018d20: 2862 5265 7175 6573 7420 2020 2020 2020  (bRequest       
-00018d30: 203d 2030 7866 662c 0a20 2020 2020 2020   = 0xff,.       
-00018d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d50: 2020 2020 2020 2020 2077 5661 6c75 6520           wValue 
-00018d60: 2020 2020 2020 2020 203d 2030 7832 352c           = 0x25,
-00018d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d90: 2077 496e 6465 7820 2020 2020 2020 2020   wIndex         
-00018da0: 203d 2072 6f69 2e72 6567 696f 6e2c 0a20   = roi.region,. 
-00018db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018dc0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00018dd0: 6174 615f 6f72 5f77 4c65 6e67 7468 203d  ata_or_wLength =
-00018de0: 2062 7566 2c0a 2020 2020 2020 2020 2020   buf,.          
-00018df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e00: 2020 2020 2020 6c61 6265 6c20 2020 2020        label     
-00018e10: 2020 2020 2020 3d20 2253 4554 5f44 4554        = "SET_DET
-00018e20: 4543 544f 525f 524f 4922 290a 0a20 2020  ECTOR_ROI")..   
-00018e30: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-00018e40: 7761 6974 696e 6720 3173 6563 2e2e 2e22  waiting 1sec..."
-00018e50: 290a 2020 2020 2020 2020 736c 6565 7028  ).        sleep(
-00018e60: 3129 0a0a 2020 2020 2020 2020 2320 4a75  1)..        # Ju
-00018e70: 7374 2069 6e20 6361 7365 2c20 666c 6f77  st in case, flow
-00018e80: 7320 7468 6520 7570 6461 7465 6420 4465  s the updated De
-00018e90: 7465 6374 6f72 5265 6769 6f6e 7320 6f62  tectorRegions ob
-00018ea0: 6a65 6374 2075 7073 7472 6561 6d0a 2020  ject upstream.  
-00018eb0: 2020 2020 2020 2320 736f 2063 616c 6c65        # so calle
-00018ec0: 7220 6861 7320 6163 6365 7373 2074 6f20  r has access to 
-00018ed0: 6974 2e0a 2020 2020 2020 2020 6966 2073  it..        if s
-00018ee0: 746f 7265 3a0a 2020 2020 2020 2020 2020  tore:.          
-00018ef0: 2020 7365 6c66 2e71 7565 7565 5f6d 6573    self.queue_mes
-00018f00: 7361 6765 2822 6465 7465 6374 6f72 5f72  sage("detector_r
-00018f10: 6567 696f 6e73 222c 2073 656c 662e 7365  egions", self.se
-00018f20: 7474 696e 6773 2e73 7461 7465 2e64 6574  ttings.state.det
-00018f30: 6563 746f 725f 7265 6769 6f6e 7329 0a0a  ector_regions)..
-00018f40: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00018f50: 6573 756c 740a 0a20 2020 2064 6566 2067  esult..    def g
-00018f60: 6574 5f66 7067 615f 636f 6e66 6967 7572  et_fpga_configur
-00018f70: 6174 696f 6e5f 7265 6769 7374 6572 2873  ation_register(s
-00018f80: 656c 662c 206c 6162 656c 3a20 7374 7220  elf, label: str 
-00018f90: 3d20 2222 2920 2d3e 2053 7065 6374 726f  = "") -> Spectro
-00018fa0: 6d65 7465 7252 6573 706f 6e73 653a 0a20  meterResponse:. 
-00018fb0: 2020 2020 2020 2072 6177 203d 2073 656c         raw = sel
-00018fc0: 662e 5f67 6574 5f63 6f64 6528 3078 6233  f._get_code(0xb3
-00018fd0: 2c20 6c73 625f 6c65 6e3d 322c 206c 6162  , lsb_len=2, lab
-00018fe0: 656c 3d22 4745 545f 4650 4741 5f43 4f4e  el="GET_FPGA_CON
-00018ff0: 4649 4755 5241 5449 4f4e 5f52 4547 4953  FIGURATION_REGIS
-00019000: 5445 5222 290a 2020 2020 2020 2020 6c6f  TER").        lo
-00019010: 672e 6465 6275 6728 6622 4650 4741 2043  g.debug(f"FPGA C
-00019020: 6f6e 6669 6775 7261 7469 6f6e 2052 6567  onfiguration Reg
-00019030: 6973 7465 723a 2030 787b 7261 773a 3034  ister: 0x{raw:04
-00019040: 787d 2028 7b6c 6162 656c 7d29 2229 0a20  x} ({label})"). 
-00019050: 2020 2020 2020 2072 6574 7572 6e20 7261         return ra
-00019060: 770a 0a20 2020 2023 2023 2323 2323 2323  w..    # #######
-00019070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019090: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000190a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000190b0: 2323 230a 2020 2020 230a 2020 2020 2320  ###.    #.    # 
-000190c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000190d0: 2020 2020 2020 2020 2020 4163 6365 7373            Access
-000190e0: 6f72 7920 436f 6e6e 6563 746f 720a 2020  ory Connector.  
-000190f0: 2020 230a 2020 2020 2320 2323 2323 2323    #.    # ######
-00019100: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019120: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019130: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019140: 2323 2323 0a0a 2020 2020 2320 2323 2323  ####..    # ####
-00019150: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019160: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019170: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019180: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019190: 2323 2323 2323 0a20 2020 2023 2041 6363  ######.    # Acc
-000191a0: 6573 736f 7279 2045 6e61 626c 650a 2020  essory Enable.  
-000191b0: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
-000191c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000191d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000191e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000191f0: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-00019200: 2020 2020 2323 2040 746f 646f 2063 6861      ## @todo cha
-00019210: 6e67 6520 6f70 636f 6465 2028 636f 6e66  nge opcode (conf
-00019220: 6c69 6374 7320 7769 7468 2047 4554 5f44  licts with GET_D
-00019230: 4554 4543 544f 525f 5354 4152 545f 4c49  ETECTOR_START_LI
-00019240: 4e45 290a 2020 2020 6465 6620 7365 745f  NE).    def set_
-00019250: 6163 6365 7373 6f72 795f 656e 6162 6c65  accessory_enable
-00019260: 2873 656c 662c 2066 6c61 673a 2062 6f6f  (self, flag: boo
-00019270: 6c29 202d 3e20 5370 6563 7472 6f6d 6574  l) -> Spectromet
-00019280: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-00019290: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-000192a0: 7365 7474 696e 6773 2e69 735f 6765 6e31  settings.is_gen1
-000192b0: 3528 293a 0a20 2020 2020 2020 2020 2020  5():.           
-000192c0: 206c 6f67 2e64 6562 7567 2822 6163 6365   log.debug("acce
-000192d0: 7373 6f72 7920 7265 7175 6972 6573 2047  ssory requires G
-000192e0: 656e 2031 2e35 2229 0a20 2020 2020 2020  en 1.5").       
-000192f0: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
-00019300: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-00019310: 2864 6174 613d 4661 6c73 652c 6572 726f  (data=False,erro
-00019320: 725f 6d73 673d 2272 6571 7569 7265 7320  r_msg="requires 
-00019330: 6765 6e31 2e35 2229 0a20 2020 2020 2020  gen1.5").       
-00019340: 2076 616c 7565 203d 2031 2069 6620 666c   value = 1 if fl
-00019350: 6167 2065 6c73 6520 300a 2020 2020 2020  ag else 0.      
-00019360: 2020 7265 7475 726e 2073 656c 662e 5f73    return self._s
-00019370: 656e 645f 636f 6465 2862 5265 7175 6573  end_code(bReques
-00019380: 7420 2020 2020 2020 203d 2030 7832 322c  t        = 0x22,
-00019390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000193a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000193b0: 5661 6c75 6520 2020 2020 2020 2020 203d  Value          =
-000193c0: 2076 616c 7565 2c0a 2020 2020 2020 2020   value,.        
-000193d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193e0: 2020 2020 2020 7749 6e64 6578 2020 2020        wIndex    
-000193f0: 2020 2020 2020 3d20 302c 0a20 2020 2020        = 0,.     
-00019400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019410: 2020 2020 2020 2020 2064 6174 615f 6f72           data_or
-00019420: 5f77 4c65 6e67 7468 203d 205b 305d 202a  _wLength = [0] *
-00019430: 2038 2c0a 2020 2020 2020 2020 2020 2020   8,.            
-00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019450: 2020 6c61 6265 6c20 2020 2020 2020 2020    label         
-00019460: 2020 3d20 2253 4554 5f41 4343 4553 534f    = "SET_ACCESSO
-00019470: 5259 5f45 4e41 424c 4522 290a 0a20 2020  RY_ENABLE")..   
-00019480: 2023 2320 4074 6f64 6f20 6669 6e64 206f   ## @todo find o
-00019490: 7574 206f 7063 6f64 650a 2020 2020 6465  ut opcode.    de
-000194a0: 6620 6765 745f 6469 7363 7265 7465 735f  f get_discretes_
-000194b0: 656e 6162 6c65 6428 7365 6c66 2920 2d3e  enabled(self) ->
-000194c0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-000194d0: 706f 6e73 653a 0a20 2020 2020 2020 2069  ponse:.        i
-000194e0: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
-000194f0: 6e67 732e 6973 5f67 656e 3135 2829 3a0a  ngs.is_gen15():.
-00019500: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
-00019510: 6572 726f 7228 2261 6363 6573 736f 7279  error("accessory
-00019520: 2072 6571 7569 7265 7320 4765 6e20 312e   requires Gen 1.
-00019530: 3522 290a 2020 2020 2020 2020 2020 2020  5").            
-00019540: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-00019550: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
-00019560: 3d46 616c 7365 2c65 7272 6f72 5f6d 7367  =False,error_msg
-00019570: 3d22 7265 7175 6972 6573 2067 656e 312e  ="requires gen1.
-00019580: 3522 290a 2020 2020 2020 2020 2320 7265  5").        # re
-00019590: 7475 726e 2073 656c 662e 5f67 6574 5f63  turn self._get_c
-000195a0: 6f64 6528 3078 3337 2c20 6c61 6265 6c3d  ode(0x37, label=
-000195b0: 2247 4554 5f41 4343 4553 534f 5259 5f45  "GET_ACCESSORY_E
-000195c0: 4e41 424c 4544 222c 206d 7362 5f6c 656e  NABLED", msb_len
-000195d0: 3d31 290a 0a20 2020 2023 2023 2323 2323  =1)..    # #####
-000195e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000195f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019610: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019620: 2323 2323 230a 2020 2020 2320 4661 6e0a  #####.    # Fan.
-00019630: 2020 2020 2320 2323 2323 2323 2323 2323      # ##########
-00019640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019680: 0a0a 2020 2020 6465 6620 7365 745f 6661  ..    def set_fa
-00019690: 6e5f 656e 6162 6c65 2873 656c 662c 2066  n_enable(self, f
-000196a0: 6c61 673a 2062 6f6f 6c29 202d 3e20 5370  lag: bool) -> Sp
-000196b0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-000196c0: 7365 3a0a 2020 2020 2020 2020 6966 206e  se:.        if n
-000196d0: 6f74 2073 656c 662e 7365 7474 696e 6773  ot self.settings
-000196e0: 2e69 735f 6765 6e31 3528 293a 0a20 2020  .is_gen15():.   
-000196f0: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
-00019700: 7567 2822 6661 6e20 7265 7175 6972 6573  ug("fan requires
-00019710: 2047 656e 2031 2e35 2229 0a20 2020 2020   Gen 1.5").     
-00019720: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
-00019730: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-00019740: 7365 2864 6174 613d 4661 6c73 652c 6572  se(data=False,er
-00019750: 726f 725f 6d73 673d 2266 616e 2072 6571  ror_msg="fan req
-00019760: 7569 7265 7320 6765 6e31 352e 2229 0a20  uires gen15."). 
-00019770: 2020 2020 2020 2076 616c 7565 203d 2031         value = 1
-00019780: 2069 6620 666c 6167 2065 6c73 6520 300a   if flag else 0.
-00019790: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000197a0: 656c 662e 5f73 656e 645f 636f 6465 2862  elf._send_code(b
-000197b0: 5265 7175 6573 7420 2020 2020 2020 203d  Request        =
-000197c0: 2030 7833 362c 0a20 2020 2020 2020 2020   0x36,.         
-000197d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197e0: 2020 2020 2077 5661 6c75 6520 2020 2020       wValue     
-000197f0: 2020 2020 203d 2076 616c 7565 2c0a 2020       = value,.  
-00019800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019810: 2020 2020 2020 2020 2020 2020 7749 6e64              wInd
-00019820: 6578 2020 2020 2020 2020 2020 3d20 302c  ex          = 0,
-00019830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019840: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00019850: 6174 615f 6f72 5f77 4c65 6e67 7468 203d  ata_or_wLength =
-00019860: 205b 305d 202a 2038 2c0a 2020 2020 2020   [0] * 8,.      
-00019870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019880: 2020 2020 2020 2020 6c61 6265 6c20 2020          label   
-00019890: 2020 2020 2020 2020 3d20 2253 4554 5f46          = "SET_F
-000198a0: 414e 5f45 4e41 424c 4522 290a 0a20 2020  AN_ENABLE")..   
-000198b0: 2064 6566 2067 6574 5f66 616e 5f65 6e61   def get_fan_ena
-000198c0: 626c 6564 2873 656c 6629 202d 3e20 5370  bled(self) -> Sp
-000198d0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-000198e0: 7365 3a0a 2020 2020 2020 2020 6966 206e  se:.        if n
-000198f0: 6f74 2073 656c 662e 7365 7474 696e 6773  ot self.settings
-00019900: 2e69 735f 6765 6e31 3528 293a 0a20 2020  .is_gen15():.   
-00019910: 2020 2020 2020 2020 206c 6f67 2e65 7272           log.err
-00019920: 6f72 2822 6661 6e20 7265 7175 6972 6573  or("fan requires
-00019930: 2047 656e 2031 2e35 2229 0a20 2020 2020   Gen 1.5").     
-00019940: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
-00019950: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-00019960: 7365 2864 6174 613d 4661 6c73 652c 6572  se(data=False,er
-00019970: 726f 725f 6d73 673d 2266 616e 2072 6571  ror_msg="fan req
-00019980: 7569 7265 7320 6765 6e31 2e35 2229 0a20  uires gen1.5"). 
-00019990: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
-000199a0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-000199b0: 7365 2864 6174 613d 3020 213d 2073 656c  se(data=0 != sel
-000199c0: 662e 5f67 6574 5f63 6f64 6528 3078 3337  f._get_code(0x37
-000199d0: 2c20 6c61 6265 6c3d 2247 4554 5f46 414e  , label="GET_FAN
-000199e0: 5f45 4e41 424c 4544 222c 206d 7362 5f6c  _ENABLED", msb_l
-000199f0: 656e 3d31 2929 0a0a 2020 2020 2320 2323  en=1))..    # ##
-00019a00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a40: 2323 2323 2323 2323 0a20 2020 2023 204c  ########.    # L
-00019a50: 616d 700a 2020 2020 2320 2323 2323 2323  amp.    # ######
-00019a60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019aa0: 2323 2323 0a0a 2020 2020 6465 6620 7365  ####..    def se
-00019ab0: 745f 6c61 6d70 5f65 6e61 626c 6528 7365  t_lamp_enable(se
-00019ac0: 6c66 2c20 666c 6167 3a20 626f 6f6c 2920  lf, flag: bool) 
-00019ad0: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-00019ae0: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-00019af0: 2069 6620 6e6f 7420 7365 6c66 2e73 6574   if not self.set
-00019b00: 7469 6e67 732e 6973 5f67 656e 3135 2829  tings.is_gen15()
-00019b10: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00019b20: 672e 6465 6275 6728 226c 616d 7020 7265  g.debug("lamp re
-00019b30: 7175 6972 6573 2047 656e 2031 2e35 2229  quires Gen 1.5")
-00019b40: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00019b50: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
-00019b60: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
-00019b70: 6c73 652c 6572 726f 725f 6d73 673d 226c  lse,error_msg="l
-00019b80: 616d 7020 7265 7175 6972 6573 2067 656e  amp requires gen
-00019b90: 312e 3522 290a 2020 2020 2020 2020 7661  1.5").        va
-00019ba0: 6c75 6520 3d20 3120 6966 2066 6c61 6720  lue = 1 if flag 
-00019bb0: 656c 7365 2030 0a20 2020 2020 2020 2072  else 0.        r
-00019bc0: 6574 7572 6e20 7365 6c66 2e5f 7365 6e64  eturn self._send
-00019bd0: 5f63 6f64 6528 6252 6571 7565 7374 2020  _code(bRequest  
-00019be0: 2020 2020 2020 3d20 3078 3332 2c0a 2020        = 0x32,.  
-00019bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c00: 2020 2020 2020 2020 2020 2020 7756 616c              wVal
-00019c10: 7565 2020 2020 2020 2020 2020 3d20 7661  ue          = va
-00019c20: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
-00019c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c40: 2020 2077 496e 6465 7820 2020 2020 2020     wIndex       
-00019c50: 2020 203d 2030 2c0a 2020 2020 2020 2020     = 0,.        
-00019c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c70: 2020 2020 2020 6461 7461 5f6f 725f 774c        data_or_wL
-00019c80: 656e 6774 6820 3d20 5b30 5d20 2a20 382c  ength = [0] * 8,
-00019c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ca0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00019cb0: 6162 656c 2020 2020 2020 2020 2020 203d  abel           =
-00019cc0: 2022 5345 545f 4c41 4d50 5f45 4e41 424c   "SET_LAMP_ENABL
-00019cd0: 4522 290a 0a20 2020 2064 6566 2067 6574  E")..    def get
-00019ce0: 5f6c 616d 705f 656e 6162 6c65 6428 7365  _lamp_enabled(se
-00019cf0: 6c66 2920 2d3e 2053 7065 6374 726f 6d65  lf) -> Spectrome
-00019d00: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-00019d10: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00019d20: 2e73 6574 7469 6e67 732e 6973 5f67 656e  .settings.is_gen
-00019d30: 3135 2829 3a0a 2020 2020 2020 2020 2020  15():.          
-00019d40: 2020 6c6f 672e 6572 726f 7228 226c 616d    log.error("lam
-00019d50: 7020 7265 7175 6972 6573 2047 656e 2031  p requires Gen 1
-00019d60: 2e35 2229 0a20 2020 2020 2020 2020 2020  .5").           
-00019d70: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-00019d80: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-00019d90: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
-00019da0: 673d 226c 616d 7020 7265 7175 6972 6573  g="lamp requires
-00019db0: 2067 656e 312e 3522 290a 2020 2020 2020   gen1.5").      
-00019dc0: 2020 7265 7320 3d20 7365 6c66 2e5f 6765    res = self._ge
-00019dd0: 745f 636f 6465 2830 7833 332c 206c 6162  t_code(0x33, lab
-00019de0: 656c 3d22 4745 545f 4c41 4d50 5f45 4e41  el="GET_LAMP_ENA
-00019df0: 424c 4544 222c 206d 7362 5f6c 656e 3d31  BLED", msb_len=1
-00019e00: 290a 2020 2020 2020 2020 7265 732e 6461  ).        res.da
-00019e10: 7461 203d 2030 2021 3d20 7265 732e 6461  ta = 0 != res.da
-00019e20: 7461 0a20 2020 2020 2020 2072 6574 7572  ta.        retur
-00019e30: 6e20 7265 730a 0a20 2020 2023 2023 2323  n res..    # ###
-00019e40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019e50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019e60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019e70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019e80: 2323 2323 2323 230a 2020 2020 2320 5368  #######.    # Sh
-00019e90: 7574 7465 720a 2020 2020 2320 2323 2323  utter.    # ####
-00019ea0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019eb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019ec0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019ed0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019ee0: 2323 2323 2323 0a0a 2020 2020 6465 6620  ######..    def 
-00019ef0: 7365 745f 7368 7574 7465 725f 656e 6162  set_shutter_enab
-00019f00: 6c65 2873 656c 662c 2066 6c61 673a 2062  le(self, flag: b
-00019f10: 6f6f 6c29 202d 3e20 5370 6563 7472 6f6d  ool) -> Spectrom
-00019f20: 6574 6572 5265 7370 6f6e 7365 3a0a 2020  eterResponse:.  
-00019f30: 2020 2020 2020 6966 206e 6f74 2028 7365        if not (se
-00019f40: 6c66 2e73 6574 7469 6e67 732e 6973 5f67  lf.settings.is_g
-00019f50: 656e 3135 2829 2061 6e64 2073 656c 662e  en15() and self.
-00019f60: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
-00019f70: 6861 735f 7368 7574 7465 7229 3a0a 2020  has_shutter):.  
-00019f80: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
-00019f90: 6275 6728 2273 6875 7474 6572 2072 6571  bug("shutter req
-00019fa0: 7569 7265 7320 4765 6e20 312e 3520 616e  uires Gen 1.5 an
-00019fb0: 6420 6861 735f 7368 7574 7465 7220 666c  d has_shutter fl
-00019fc0: 6167 2229 0a20 2020 2020 2020 2020 2020  ag").           
-00019fd0: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-00019fe0: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-00019ff0: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
-0001a000: 673d 2273 6875 7474 6572 2072 6571 7569  g="shutter requi
-0001a010: 7265 7320 6765 6e31 2e35 2229 0a20 2020  res gen1.5").   
-0001a020: 2020 2020 2076 616c 7565 203d 2031 2069       value = 1 i
-0001a030: 6620 666c 6167 2065 6c73 6520 300a 2020  f flag else 0.  
-0001a040: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001a050: 662e 5f73 656e 645f 636f 6465 2862 5265  f._send_code(bRe
-0001a060: 7175 6573 7420 2020 2020 2020 203d 2030  quest        = 0
-0001a070: 7833 302c 0a20 2020 2020 2020 2020 2020  x30,.           
-0001a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a090: 2020 2077 5661 6c75 6520 2020 2020 2020     wValue       
-0001a0a0: 2020 203d 2076 616c 7565 2c0a 2020 2020     = value,.    
-0001a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a0c0: 2020 2020 2020 2020 2020 7749 6e64 6578            wIndex
-0001a0d0: 2020 2020 2020 2020 2020 3d20 302c 0a20            = 0,. 
-0001a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a0f0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-0001a100: 615f 6f72 5f77 4c65 6e67 7468 203d 205b  a_or_wLength = [
-0001a110: 305d 202a 2038 2c0a 2020 2020 2020 2020  0] * 8,.        
-0001a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a130: 2020 2020 2020 6c61 6265 6c20 2020 2020        label     
-0001a140: 2020 2020 2020 3d20 2253 4554 5f53 4855        = "SET_SHU
-0001a150: 5454 4552 5f45 4e41 424c 4522 290a 0a20  TTER_ENABLE").. 
-0001a160: 2020 2064 6566 2067 6574 5f73 6875 7474     def get_shutt
-0001a170: 6572 5f65 6e61 626c 6564 2873 656c 6629  er_enabled(self)
-0001a180: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
-0001a190: 5265 7370 6f6e 7365 3a0a 2020 2020 2020  Response:.      
-0001a1a0: 2020 6966 206e 6f74 2028 7365 6c66 2e73    if not (self.s
-0001a1b0: 6574 7469 6e67 732e 6973 5f67 656e 3135  ettings.is_gen15
-0001a1c0: 2829 2061 6e64 2073 656c 662e 7365 7474  () and self.sett
-0001a1d0: 696e 6773 2e65 6570 726f 6d2e 6861 735f  ings.eeprom.has_
-0001a1e0: 7368 7574 7465 7229 3a0a 2020 2020 2020  shutter):.      
-0001a1f0: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
-0001a200: 2273 6875 7474 6572 2072 6571 7569 7265  "shutter require
-0001a210: 7320 4765 6e20 312e 3520 616e 6420 6861  s Gen 1.5 and ha
-0001a220: 735f 7368 7574 7465 7220 666c 6167 2229  s_shutter flag")
-0001a230: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001a240: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
-0001a250: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
-0001a260: 6c73 652c 6572 726f 725f 6d73 673d 2273  lse,error_msg="s
-0001a270: 6875 7474 6572 2072 6571 7569 7265 7320  hutter requires 
-0001a280: 6765 6e31 2e35 2229 0a20 2020 2020 2020  gen1.5").       
-0001a290: 2072 6573 203d 2053 7065 6374 726f 6d65   res = Spectrome
-0001a2a0: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
-0001a2b0: 3d30 2021 3d20 7365 6c66 2e5f 6765 745f  =0 != self._get_
-0001a2c0: 636f 6465 2830 7833 312c 206c 6162 656c  code(0x31, label
-0001a2d0: 3d22 4745 545f 5348 5554 5445 525f 454e  ="GET_SHUTTER_EN
-0001a2e0: 4142 4c45 4422 2c20 6d73 625f 6c65 6e3d  ABLED", msb_len=
-0001a2f0: 3129 290a 2020 2020 2020 2020 7265 732e  1)).        res.
-0001a300: 6461 7461 203d 2030 2021 3d20 7265 732e  data = 0 != res.
-0001a310: 6461 7461 0a20 2020 2020 2020 2072 6574  data.        ret
-0001a320: 7572 6e20 7265 7320 0a20 2020 2023 2023  urn res .    # #
-0001a330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a370: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
-0001a380: 4c61 7365 7220 4d6f 6475 6c61 7469 6f6e  Laser Modulation
-0001a390: 2061 6e64 2043 6f6e 7469 6e75 6f75 7320   and Continuous 
-0001a3a0: 5374 726f 6265 0a20 2020 2023 2023 2323  Strobe.    # ###
-0001a3b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a3c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a3d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a3e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001a3f0: 2323 2323 2323 230a 0a20 2020 2064 6566  #######..    def
-0001a400: 2073 6574 5f6d 6f64 5f65 6e61 626c 6528   set_mod_enable(
-0001a410: 7365 6c66 2c20 666c 6167 3a20 626f 6f6c  self, flag: bool
-0001a420: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-0001a430: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-0001a440: 2020 2073 656c 662e 7365 7474 696e 6773     self.settings
-0001a450: 2e73 7461 7465 2e6d 6f64 5f65 6e61 626c  .state.mod_enabl
-0001a460: 6564 203d 2066 6c61 670a 2020 2020 2020  ed = flag.      
-0001a470: 2020 7661 6c75 6520 3d20 3120 6966 2066    value = 1 if f
-0001a480: 6c61 6720 656c 7365 2030 0a20 2020 2020  lag else 0.     
-0001a490: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0001a4a0: 7365 6e64 5f63 6f64 6528 3078 6264 2c20  send_code(0xbd, 
-0001a4b0: 7661 6c75 652c 206c 6162 656c 3d22 5345  value, label="SE
-0001a4c0: 545f 4d4f 445f 454e 4142 4c45 2229 0a0a  T_MOD_ENABLE")..
-0001a4d0: 2020 2020 6465 6620 6765 745f 6d6f 645f      def get_mod_
-0001a4e0: 656e 6162 6c65 6428 7365 6c66 2920 2d3e  enabled(self) ->
-0001a4f0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0001a500: 706f 6e73 653a 0a20 2020 2020 2020 2072  ponse:.        r
-0001a510: 6573 203d 2073 656c 662e 5f67 6574 5f63  es = self._get_c
-0001a520: 6f64 6528 3078 6533 2c20 6c61 6265 6c3d  ode(0xe3, label=
-0001a530: 2247 4554 5f4d 4f44 5f45 4e41 424c 4544  "GET_MOD_ENABLED
-0001a540: 222c 206d 7362 5f6c 656e 3d31 290a 2020  ", msb_len=1).  
-0001a550: 2020 2020 2020 6966 2072 6573 2e65 7272        if res.err
-0001a560: 6f72 5f6d 7367 2021 3d20 2727 3a0a 2020  or_msg != '':.  
-0001a570: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001a580: 2072 6573 0a20 2020 2020 2020 2066 6c61   res.        fla
-0001a590: 6720 3d20 3020 213d 2072 6573 2e64 6174  g = 0 != res.dat
-0001a5a0: 610a 2020 2020 2020 2020 7365 6c66 2e73  a.        self.s
-0001a5b0: 6574 7469 6e67 732e 7374 6174 652e 6d6f  ettings.state.mo
-0001a5c0: 645f 656e 6162 6c65 6420 3d20 666c 6167  d_enabled = flag
-0001a5d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001a5e0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001a5f0: 6f6e 7365 2864 6174 613d 666c 6167 290a  onse(data=flag).
-0001a600: 0a20 2020 2064 6566 2073 6574 5f6d 6f64  .    def set_mod
-0001a610: 5f70 6572 696f 645f 7573 2873 656c 662c  _period_us(self,
-0001a620: 2075 733a 2066 6c6f 6174 2920 2d3e 2053   us: float) -> S
-0001a630: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0001a640: 6e73 653a 0a20 2020 2020 2020 2073 656c  nse:.        sel
-0001a650: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
-0001a660: 2e6d 6f64 5f70 6572 696f 645f 7573 203d  .mod_period_us =
-0001a670: 2075 730a 2020 2020 2020 2020 286c 7377   us.        (lsw
-0001a680: 2c20 6d73 772c 2062 7566 2920 3d20 7365  , msw, buf) = se
-0001a690: 6c66 2e5f 746f 3430 6269 7428 7573 290a  lf._to40bit(us).
-0001a6a0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001a6b0: 656c 662e 5f73 656e 645f 636f 6465 2830  elf._send_code(0
-0001a6c0: 7863 372c 206c 7377 2c20 6d73 772c 2062  xc7, lsw, msw, b
-0001a6d0: 7566 2c20 6c61 6265 6c3d 2253 4554 5f4d  uf, label="SET_M
-0001a6e0: 4f44 5f50 4552 494f 4422 290a 0a20 2020  OD_PERIOD")..   
-0001a6f0: 2064 6566 2067 6574 5f6d 6f64 5f70 6572   def get_mod_per
-0001a700: 696f 645f 7573 2873 656c 6629 202d 3e20  iod_us(self) -> 
-0001a710: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001a720: 6f6e 7365 3a0a 2020 2020 2020 2020 7661  onse:.        va
-0001a730: 6c75 6520 3d20 7365 6c66 2e5f 6765 745f  lue = self._get_
-0001a740: 636f 6465 2830 7863 622c 206c 6162 656c  code(0xcb, label
-0001a750: 3d22 4745 545f 4d4f 445f 5045 5249 4f44  ="GET_MOD_PERIOD
-0001a760: 222c 206c 7362 5f6c 656e 3d35 290a 2020  ", lsb_len=5).  
-0001a770: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-0001a780: 6e67 732e 7374 6174 652e 6d6f 645f 7065  ngs.state.mod_pe
-0001a790: 7269 6f64 5f75 7320 3d20 7661 6c75 650a  riod_us = value.
-0001a7a0: 2020 2020 2020 2020 7265 7475 726e 2076          return v
-0001a7b0: 616c 7565 0a0a 2020 2020 6465 6620 7365  alue..    def se
-0001a7c0: 745f 6d6f 645f 7769 6474 685f 7573 2873  t_mod_width_us(s
-0001a7d0: 656c 662c 2075 733a 2066 6c6f 6174 2920  elf, us: float) 
-0001a7e0: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-0001a7f0: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-0001a800: 2073 656c 662e 7365 7474 696e 6773 2e73   self.settings.s
-0001a810: 7461 7465 2e6d 6f64 5f77 6964 7468 5f75  tate.mod_width_u
-0001a820: 7320 3d20 7573 0a20 2020 2020 2020 2028  s = us.        (
-0001a830: 6c73 772c 206d 7377 2c20 6275 6629 203d  lsw, msw, buf) =
-0001a840: 2073 656c 662e 5f74 6f34 3062 6974 2875   self._to40bit(u
-0001a850: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-0001a860: 6e20 7365 6c66 2e5f 7365 6e64 5f63 6f64  n self._send_cod
-0001a870: 6528 3078 6462 2c20 6c73 772c 206d 7377  e(0xdb, lsw, msw
-0001a880: 2c20 6275 662c 206c 6162 656c 3d22 5345  , buf, label="SE
-0001a890: 545f 4d4f 445f 5749 4454 4822 290a 0a20  T_MOD_WIDTH").. 
-0001a8a0: 2020 2064 6566 2067 6574 5f6d 6f64 5f77     def get_mod_w
-0001a8b0: 6964 7468 5f75 7328 7365 6c66 2920 2d3e  idth_us(self) ->
-0001a8c0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0001a8d0: 706f 6e73 653a 0a20 2020 2020 2020 2076  ponse:.        v
-0001a8e0: 616c 7565 203d 2073 656c 662e 5f67 6574  alue = self._get
-0001a8f0: 5f63 6f64 6528 3078 6463 2c20 6c61 6265  _code(0xdc, labe
-0001a900: 6c3d 2247 4554 5f4d 4f44 5f57 4944 5448  l="GET_MOD_WIDTH
-0001a910: 222c 206c 7362 5f6c 656e 3d35 290a 2020  ", lsb_len=5).  
-0001a920: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-0001a930: 6e67 732e 7374 6174 652e 6d6f 645f 7769  ngs.state.mod_wi
-0001a940: 6474 685f 7573 203d 2076 616c 7565 2e64  dth_us = value.d
-0001a950: 6174 610a 2020 2020 2020 2020 7265 7475  ata.        retu
-0001a960: 726e 2076 616c 7565 0a0a 2020 2020 6465  rn value..    de
-0001a970: 6620 7365 745f 6d6f 645f 6465 6c61 795f  f set_mod_delay_
-0001a980: 7573 2873 656c 662c 2075 733a 2066 6c6f  us(self, us: flo
-0001a990: 6174 2920 2d3e 2053 7065 6374 726f 6d65  at) -> Spectrome
-0001a9a0: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-0001a9b0: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-0001a9c0: 6773 2e73 7461 7465 2e6d 6f64 5f64 656c  gs.state.mod_del
-0001a9d0: 6179 5f75 7320 3d20 7573 0a20 2020 2020  ay_us = us.     
-0001a9e0: 2020 2028 6c73 772c 206d 7377 2c20 6275     (lsw, msw, bu
-0001a9f0: 6629 203d 2073 656c 662e 5f74 6f34 3062  f) = self._to40b
-0001aa00: 6974 2875 7329 0a20 2020 2020 2020 2072  it(us).        r
-0001aa10: 6574 7572 6e20 7365 6c66 2e5f 7365 6e64  eturn self._send
-0001aa20: 5f63 6f64 6528 3078 6336 2c20 6c73 772c  _code(0xc6, lsw,
-0001aa30: 206d 7377 2c20 6275 662c 206c 6162 656c   msw, buf, label
-0001aa40: 3d22 5345 545f 4d4f 445f 4445 4c41 5922  ="SET_MOD_DELAY"
-0001aa50: 290a 0a20 2020 2064 6566 2067 6574 5f6d  )..    def get_m
-0001aa60: 6f64 5f64 656c 6179 5f75 7328 7365 6c66  od_delay_us(self
-0001aa70: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-0001aa80: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-0001aa90: 2020 2076 616c 7565 203d 2073 656c 662e     value = self.
-0001aaa0: 5f67 6574 5f63 6f64 6528 3078 6361 2c20  _get_code(0xca, 
-0001aab0: 6c61 6265 6c3d 2247 4554 5f4d 4f44 5f44  label="GET_MOD_D
-0001aac0: 454c 4159 222c 206c 7362 5f6c 656e 3d35  ELAY", lsb_len=5
-0001aad0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0001aae0: 6574 7469 6e67 732e 7374 6174 652e 6d6f  ettings.state.mo
-0001aaf0: 645f 6465 6c61 795f 7573 203d 2076 616c  d_delay_us = val
-0001ab00: 7565 2e64 6174 610a 2020 2020 2020 2020  ue.data.        
-0001ab10: 7265 7475 726e 2076 616c 7565 0a0a 2020  return value..  
-0001ab20: 2020 6465 6620 7365 745f 6d6f 645f 6475    def set_mod_du
-0001ab30: 7261 7469 6f6e 5f75 735f 4e4f 545f 5553  ration_us_NOT_US
-0001ab40: 4544 2873 656c 662c 2075 733a 2066 6c6f  ED(self, us: flo
-0001ab50: 6174 2920 2d3e 2053 7065 6374 726f 6d65  at) -> Spectrome
-0001ab60: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-0001ab70: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-0001ab80: 6773 2e73 7461 7465 2e6d 6f64 5f64 7572  gs.state.mod_dur
-0001ab90: 6174 696f 6e5f 7573 203d 2075 730a 2020  ation_us = us.  
-0001aba0: 2020 2020 2020 286c 7377 2c20 6d73 772c        (lsw, msw,
-0001abb0: 2062 7566 2920 3d20 7365 6c66 2e5f 746f   buf) = self._to
-0001abc0: 3430 6269 7428 7573 290a 2020 2020 2020  40bit(us).      
-0001abd0: 2020 7265 7475 726e 2073 656c 662e 5f73    return self._s
-0001abe0: 656e 645f 636f 6465 2830 7862 392c 206c  end_code(0xb9, l
-0001abf0: 7377 2c20 6d73 772c 2062 7566 2c20 6c61  sw, msw, buf, la
-0001ac00: 6265 6c3d 2253 4554 5f4d 4f44 5f44 5552  bel="SET_MOD_DUR
-0001ac10: 4154 494f 4e22 290a 0a20 2020 2064 6566  ATION")..    def
-0001ac20: 2067 6574 5f6d 6f64 5f64 7572 6174 696f   get_mod_duratio
-0001ac30: 6e5f 7573 2873 656c 6629 202d 3e20 5370  n_us(self) -> Sp
-0001ac40: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0001ac50: 7365 3a0a 2020 2020 2020 2020 7661 6c75  se:.        valu
-0001ac60: 6520 3d20 7365 6c66 2e5f 6765 745f 636f  e = self._get_co
-0001ac70: 6465 2830 7863 332c 206c 6162 656c 3d22  de(0xc3, label="
-0001ac80: 4745 545f 4d4f 445f 4455 5241 5449 4f4e  GET_MOD_DURATION
-0001ac90: 222c 206c 7362 5f6c 656e 3d35 290a 2020  ", lsb_len=5).  
-0001aca0: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-0001acb0: 6e67 732e 7374 6174 652e 6d6f 645f 6475  ngs.state.mod_du
-0001acc0: 7261 7469 6f6e 5f75 7320 3d20 7661 6c75  ration_us = valu
-0001acd0: 652e 6461 7461 0a20 2020 2020 2020 2072  e.data.        r
-0001ace0: 6574 7572 6e20 7661 6c75 650a 0a20 2020  eturn value..   
-0001acf0: 2023 2320 7468 6973 2069 7320 6120 7379   ## this is a sy
-0001ad00: 6e6f 6e79 6d20 666f 7220 5f73 6574 5f6c  nonym for _set_l
-0001ad10: 6173 6572 5f65 6e61 626c 655f 696d 6d65  aser_enable_imme
-0001ad20: 6469 6174 6528 292c 2062 7574 2077 6974  diate(), but wit
-0001ad30: 686f 7574 2073 6964 652d 6566 6665 6374  hout side-effect
-0001ad40: 730a 2020 2020 6465 6620 7365 745f 7374  s.    def set_st
-0001ad50: 726f 6265 5f65 6e61 626c 6528 7365 6c66  robe_enable(self
-0001ad60: 2c20 666c 6167 3a20 626f 6f6c 2920 2d3e  , flag: bool) ->
-0001ad70: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0001ad80: 706f 6e73 653a 0a20 2020 2020 2020 2076  ponse:.        v
-0001ad90: 616c 7565 203d 2031 2069 6620 666c 6167  alue = 1 if flag
-0001ada0: 2065 6c73 6520 300a 2020 2020 2020 2020   else 0.        
-0001adb0: 7265 7475 726e 2073 656c 662e 5f73 656e  return self._sen
-0001adc0: 645f 636f 6465 2830 7862 652c 2076 616c  d_code(0xbe, val
-0001add0: 7565 2c20 6c61 6265 6c3d 2253 4554 5f53  ue, label="SET_S
-0001ade0: 5452 4f42 455f 454e 4142 4c45 2229 0a0a  TROBE_ENABLE")..
-0001adf0: 2020 2020 2323 2061 206c 6974 6572 616c      ## a literal
-0001ae00: 2070 6173 732d 7468 726f 7567 6820 746f   pass-through to
-0001ae10: 2067 6574 5f6c 6173 6572 5f65 6e61 626c   get_laser_enabl
-0001ae20: 6564 2829 0a20 2020 2064 6566 2067 6574  ed().    def get
-0001ae30: 5f73 7472 6f62 655f 656e 6162 6c65 6428  _strobe_enabled(
-0001ae40: 7365 6c66 2920 2d3e 2053 7065 6374 726f  self) -> Spectro
-0001ae50: 6d65 7465 7252 6573 706f 6e73 653a 0a20  meterResponse:. 
-0001ae60: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0001ae70: 6c66 2e67 6574 5f6c 6173 6572 5f65 6e61  lf.get_laser_ena
-0001ae80: 626c 6564 2829 0a0a 2020 2020 2320 2323  bled()..    # ##
-0001ae90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001aea0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001aeb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001aec0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001aed0: 2323 2323 2323 2323 0a20 2020 2023 2041  ########.    # A
-0001aee0: 6d62 6965 6e74 2054 656d 7065 7261 7475  mbient Temperatu
-0001aef0: 7265 0a20 2020 2023 2023 2323 2323 2323  re.    # #######
-0001af00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001af10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001af20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001af30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001af40: 2323 230a 0a20 2020 2023 2320 4073 6565  ###..    ## @see
-0001af50: 2068 7474 7073 3a2f 2f77 7777 2e6e 7870   https://www.nxp
-0001af60: 2e63 6f6d 2f64 6f63 732f 656e 2f64 6174  .com/docs/en/dat
-0001af70: 612d 7368 6565 742f 4c4d 3735 422e 7064  a-sheet/LM75B.pd
-0001af80: 660a 2020 2020 6465 6620 6765 745f 616d  f.    def get_am
-0001af90: 6269 656e 745f 7465 6d70 6572 6174 7572  bient_temperatur
-0001afa0: 655f 6465 6743 2873 656c 6629 202d 3e20  e_degC(self) -> 
-0001afb0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001afc0: 6f6e 7365 3a0a 2020 2020 2020 2020 6966  onse:.        if
-0001afd0: 206e 6f74 2073 656c 662e 7365 7474 696e   not self.settin
-0001afe0: 6773 2e69 735f 6765 6e31 3528 293a 0a20  gs.is_gen15():. 
-0001aff0: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
-0001b000: 7272 6f72 2822 616d 6269 656e 7420 7465  rror("ambient te
-0001b010: 6d70 6572 6174 7572 6520 7265 7175 6972  mperature requir
-0001b020: 6573 2047 656e 2031 2e35 2229 0a20 2020  es Gen 1.5").   
-0001b030: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001b040: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001b050: 6f6e 7365 2864 6174 613d 4661 6c73 652c  onse(data=False,
-0001b060: 6572 726f 725f 6d73 673d 2261 6d62 6965  error_msg="ambie
-0001b070: 6e74 2074 656d 7020 7265 7175 6972 6573  nt temp requires
-0001b080: 2067 656e 312e 3522 290a 0a20 2020 2020   gen1.5")..     
-0001b090: 2020 206c 6f67 2e64 6562 7567 2822 6174     log.debug("at
-0001b0a0: 7465 6d70 7469 6e67 2074 6f20 7265 6164  tempting to read
-0001b0b0: 2061 6d62 6965 6e74 2074 656d 7065 7261   ambient tempera
-0001b0c0: 7475 7265 2229 0a20 2020 2020 2020 2072  ture").        r
-0001b0d0: 6573 756c 7420 3d20 7365 6c66 2e5f 6765  esult = self._ge
-0001b0e0: 745f 636f 6465 2830 7833 342c 206c 6162  t_code(0x34, lab
-0001b0f0: 656c 3d22 4745 545f 414d 4249 454e 545f  el="GET_AMBIENT_
-0001b100: 5445 4d50 4552 4154 5552 4522 2c20 6d73  TEMPERATURE", ms
-0001b110: 625f 6c65 6e3d 3229 0a20 2020 2020 2020  b_len=2).       
-0001b120: 2069 6620 7265 7375 6c74 2069 7320 4e6f   if result is No
-0001b130: 6e65 206f 7220 6c65 6e28 7265 7375 6c74  ne or len(result
-0001b140: 2920 213d 2032 3a0a 2020 2020 2020 2020  ) != 2:.        
-0001b150: 2020 2020 6c6f 672e 6572 726f 7228 2266      log.error("f
-0001b160: 6169 6c65 6420 746f 2072 6561 6420 616d  ailed to read am
-0001b170: 6269 656e 7420 7465 6d70 6572 6174 7572  bient temperatur
-0001b180: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
-0001b190: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
-0001b1a0: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
-0001b1b0: 3d46 616c 7365 2c65 7272 6f72 5f6d 7367  =False,error_msg
-0001b1c0: 3d22 616d 6269 656e 7420 7465 6d70 2072  ="ambient temp r
-0001b1d0: 6561 6420 6661 696c 6564 2229 0a20 2020  ead failed").   
-0001b1e0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
-0001b1f0: 616d 6269 656e 7420 7465 6d70 6572 6174  ambient temperat
-0001b200: 7572 6520 7261 773a 2025 7322 2c20 7265  ure raw: %s", re
-0001b210: 7375 6c74 290a 0a20 2020 2020 2020 2072  sult)..        r
-0001b220: 6177 203d 2072 6573 756c 742e 6461 7461  aw = result.data
-0001b230: 0a20 2020 2020 2020 2072 6177 203d 2072  .        raw = r
-0001b240: 6177 203e 3e20 350a 2020 2020 2020 2020  aw >> 5.        
-0001b250: 6465 6743 203d 2030 2e31 3235 202a 2075  degC = 0.125 * u
-0001b260: 7469 6c73 2e74 776f 735f 636f 6d70 2872  tils.twos_comp(r
-0001b270: 6177 2c20 3131 290a 0a20 2020 2020 2020  aw, 11)..       
-0001b280: 206c 6f67 2e64 6562 7567 2822 7061 7273   log.debug("pars
-0001b290: 6564 2061 6d62 6965 6e74 2074 656d 7065  ed ambient tempe
-0001b2a0: 7261 7475 7265 2066 726f 6d20 7261 7720  rature from raw 
-0001b2b0: 2573 2074 6f20 252e 3366 2064 6567 4322  %s to %.3f degC"
-0001b2c0: 2c20 7265 7375 6c74 2c20 6465 6743 290a  , result, degC).
-0001b2d0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-0001b2e0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0001b2f0: 6e73 6528 6461 7461 3d64 6567 4329 0a0a  nse(data=degC)..
-0001b300: 2020 2020 2320 2323 2323 2323 2323 2323      # ##########
-0001b310: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b350: 0a20 2020 2023 2061 6464 6564 2066 6f72  .    # added for
-0001b360: 2077 6173 6174 6368 2d73 6865 6c6c 0a20   wasatch-shell. 
-0001b370: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
-0001b380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b390: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b3a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b3b0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0001b3c0: 0a20 2020 2064 6566 2067 6574 5f74 6563  .    def get_tec
-0001b3d0: 5f65 6e61 626c 6564 2873 656c 6629 202d  _enabled(self) -
-0001b3e0: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
-0001b3f0: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
-0001b400: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
-0001b410: 696e 6773 2e65 6570 726f 6d2e 6861 735f  ings.eeprom.has_
-0001b420: 636f 6f6c 696e 673a 0a20 2020 2020 2020  cooling:.       
-0001b430: 2020 2020 206c 6f67 2e65 7272 6f72 2822       log.error("
-0001b440: 756e 6162 6c65 2074 6f20 636f 6e74 726f  unable to contro
-0001b450: 6c20 5445 433a 2045 4550 524f 4d20 7265  l TEC: EEPROM re
-0001b460: 706f 7274 7320 6e6f 2063 6f6f 6c69 6e67  ports no cooling
-0001b470: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-0001b480: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-0001b490: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-0001b4a0: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
-0001b4b0: 226e 6f20 636f 6f6c 696e 6720 7265 706f  "no cooling repo
-0001b4c0: 7274 6564 2229 0a20 2020 2020 2020 2072  rted").        r
-0001b4d0: 6573 203d 2073 656c 662e 5f67 6574 5f63  es = self._get_c
-0001b4e0: 6f64 6528 3078 6461 2c20 6c61 6265 6c3d  ode(0xda, label=
-0001b4f0: 2247 4554 5f43 4344 5f54 4543 5f45 4e41  "GET_CCD_TEC_ENA
-0001b500: 424c 4544 222c 206d 7362 5f6c 656e 3d31  BLED", msb_len=1
-0001b510: 290a 2020 2020 2020 2020 7265 732e 6461  ).        res.da
-0001b520: 7461 203d 2030 2021 3d20 7265 732e 6461  ta = 0 != res.da
-0001b530: 7461 0a20 2020 2020 2020 2069 6620 7265  ta.        if re
-0001b540: 732e 6572 726f 725f 6d73 6720 213d 2027  s.error_msg != '
-0001b550: 273a 0a20 2020 2020 2020 2020 2020 2072  ':.            r
-0001b560: 6574 7572 6e20 7265 730a 2020 2020 2020  eturn res.      
-0001b570: 2020 7265 7475 726e 2072 6573 0a0a 2020    return res..  
-0001b580: 2020 6465 6620 6765 745f 6163 7475 616c    def get_actual
-0001b590: 5f66 7261 6d65 7328 7365 6c66 2920 2d3e  _frames(self) ->
-0001b5a0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0001b5b0: 706f 6e73 653a 0a20 2020 2020 2020 2072  ponse:.        r
-0001b5c0: 6574 7572 6e20 7365 6c66 2e5f 6765 745f  eturn self._get_
-0001b5d0: 636f 6465 2830 7865 342c 206c 6162 656c  code(0xe4, label
-0001b5e0: 3d22 4745 545f 4143 5455 414c 5f46 5241  ="GET_ACTUAL_FRA
-0001b5f0: 4d45 5322 2c20 6c73 625f 6c65 6e3d 3229  MES", lsb_len=2)
-0001b600: 0a0a 2020 2020 6465 6620 6765 745f 6163  ..    def get_ac
-0001b610: 7475 616c 5f69 6e74 6567 7261 7469 6f6e  tual_integration
-0001b620: 5f74 696d 655f 7573 2873 656c 6629 202d  _time_us(self) -
-0001b630: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
-0001b640: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
-0001b650: 7265 7475 726e 2073 656c 662e 5f67 6574  return self._get
-0001b660: 5f63 6f64 6528 3078 6466 2c20 6c61 6265  _code(0xdf, labe
-0001b670: 6c3d 2247 4554 5f41 4354 5541 4c5f 494e  l="GET_ACTUAL_IN
-0001b680: 5445 4752 4154 494f 4e5f 5449 4d45 5f55  TEGRATION_TIME_U
-0001b690: 5322 2c20 6c73 625f 6c65 6e3d 3329 0a0a  S", lsb_len=3)..
-0001b6a0: 2020 2020 6465 6620 6765 745f 6465 7465      def get_dete
-0001b6b0: 6374 6f72 5f6f 6666 7365 7428 7365 6c66  ctor_offset(self
-0001b6c0: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-0001b6d0: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-0001b6e0: 2020 2076 616c 7565 203d 2073 656c 662e     value = self.
-0001b6f0: 5f67 6574 5f63 6f64 6528 3078 6334 2c20  _get_code(0xc4, 
-0001b700: 6c61 6265 6c3d 2247 4554 5f44 4554 4543  label="GET_DETEC
-0001b710: 544f 525f 4f46 4653 4554 222c 206c 7362  TOR_OFFSET", lsb
-0001b720: 5f6c 656e 3d32 290a 2020 2020 2020 2020  _len=2).        
-0001b730: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
-0001b740: 7072 6f6d 2e64 6574 6563 746f 725f 6f66  prom.detector_of
-0001b750: 6673 6574 203d 2076 616c 7565 2e64 6174  fset = value.dat
-0001b760: 610a 2020 2020 2020 2020 7265 7475 726e  a.        return
-0001b770: 2076 616c 7565 0a0a 2020 2020 6465 6620   value..    def 
-0001b780: 6765 745f 6465 7465 6374 6f72 5f6f 6666  get_detector_off
-0001b790: 7365 745f 6f64 6428 7365 6c66 2920 2d3e  set_odd(self) ->
-0001b7a0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0001b7b0: 706f 6e73 653a 0a20 2020 2020 2020 2069  ponse:.        i
-0001b7c0: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
-0001b7d0: 6e67 732e 6973 5f69 6e67 6161 7328 293a  ngs.is_ingaas():
-0001b7e0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0001b7f0: 2e64 6562 7567 2822 4745 545f 4445 5445  .debug("GET_DETE
-0001b800: 4354 4f52 5f4f 4646 5345 545f 4f44 4420  CTOR_OFFSET_ODD 
-0001b810: 6f6e 6c79 2073 7570 706f 7274 6564 206f  only supported o
-0001b820: 6e20 496e 4761 4173 2229 0a20 2020 2020  n InGaAs").     
-0001b830: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
-0001b840: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0001b850: 7365 2864 6174 613d 7365 6c66 2e73 6574  se(data=self.set
-0001b860: 7469 6e67 732e 6565 7072 6f6d 2e64 6574  tings.eeprom.det
-0001b870: 6563 746f 725f 6f66 6673 6574 5f6f 6464  ector_offset_odd
-0001b880: 290a 0a20 2020 2020 2020 2076 616c 7565  )..        value
-0001b890: 203d 2073 656c 662e 5f67 6574 5f63 6f64   = self._get_cod
-0001b8a0: 6528 3078 3965 2c20 6c61 6265 6c3d 2247  e(0x9e, label="G
-0001b8b0: 4554 5f44 4554 4543 544f 525f 4f46 4653  ET_DETECTOR_OFFS
-0001b8c0: 4554 5f4f 4444 222c 206c 7362 5f6c 656e  ET_ODD", lsb_len
-0001b8d0: 3d32 290a 2020 2020 2020 2020 6966 2076  =2).        if v
-0001b8e0: 616c 7565 2e65 7272 6f72 5f6d 7367 2021  alue.error_msg !
-0001b8f0: 3d20 2727 3a0a 2020 2020 2020 2020 2020  = '':.          
-0001b900: 2020 7265 7475 726e 2076 616c 7565 0a20    return value. 
-0001b910: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
-0001b920: 696e 6773 2e65 6570 726f 6d2e 6465 7465  ings.eeprom.dete
-0001b930: 6374 6f72 5f6f 6666 7365 745f 6f64 6420  ctor_offset_odd 
-0001b940: 3d20 7661 6c75 652e 6461 7461 0a20 2020  = value.data.   
-0001b950: 2020 2020 2072 6574 7572 6e20 7661 6c75       return valu
-0001b960: 650a 0a20 2020 2064 6566 2067 6574 5f63  e..    def get_c
-0001b970: 6364 5f73 656e 7369 6e67 5f74 6872 6573  cd_sensing_thres
-0001b980: 686f 6c64 2873 656c 6629 202d 3e20 5370  hold(self) -> Sp
-0001b990: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0001b9a0: 7365 3a0a 2020 2020 2020 2020 7265 7475  se:.        retu
-0001b9b0: 726e 2073 656c 662e 5f67 6574 5f63 6f64  rn self._get_cod
-0001b9c0: 6528 3078 6431 2c20 6c61 6265 6c3d 2247  e(0xd1, label="G
-0001b9d0: 4554 5f43 4344 5f53 454e 5349 4e47 5f54  ET_CCD_SENSING_T
-0001b9e0: 4852 4553 484f 4c44 222c 206c 7362 5f6c  HRESHOLD", lsb_l
-0001b9f0: 656e 3d32 290a 0a20 2020 2064 6566 2067  en=2)..    def g
-0001ba00: 6574 5f63 6364 5f74 6872 6573 686f 6c64  et_ccd_threshold
-0001ba10: 5f73 656e 7369 6e67 5f6d 6f64 6528 7365  _sensing_mode(se
-0001ba20: 6c66 2920 2d3e 2053 7065 6374 726f 6d65  lf) -> Spectrome
-0001ba30: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-0001ba40: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001ba50: 2e5f 6765 745f 636f 6465 2830 7863 662c  ._get_code(0xcf,
-0001ba60: 206c 6162 656c 3d22 4745 545f 4343 445f   label="GET_CCD_
-0001ba70: 5448 5245 5348 4f4c 445f 5345 4e53 494e  THRESHOLD_SENSIN
-0001ba80: 475f 4d4f 4445 222c 206d 7362 5f6c 656e  G_MODE", msb_len
-0001ba90: 3d31 290a 0a20 2020 2064 6566 2067 6574  =1)..    def get
-0001baa0: 5f65 7874 6572 6e61 6c5f 7472 6967 6765  _external_trigge
-0001bab0: 725f 6f75 7470 7574 2873 656c 6629 202d  r_output(self) -
-0001bac0: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
-0001bad0: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
-0001bae0: 7265 7475 726e 2073 656c 662e 5f67 6574  return self._get
-0001baf0: 5f63 6f64 6528 3078 6531 2c20 6c61 6265  _code(0xe1, labe
-0001bb00: 6c3d 2247 4554 5f45 5854 4552 4e41 4c5f  l="GET_EXTERNAL_
-0001bb10: 5452 4947 4745 525f 4f55 5450 5554 222c  TRIGGER_OUTPUT",
-0001bb20: 206d 7362 5f6c 656e 3d31 290a 0a20 2020   msb_len=1)..   
-0001bb30: 2064 6566 2067 6574 5f6c 6173 6572 5f69   def get_laser_i
-0001bb40: 6e74 6572 6c6f 636b 2873 656c 6629 202d  nterlock(self) -
-0001bb50: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
-0001bb60: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
-0001bb70: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
-0001bb80: 2e69 735f 6172 6d28 293a 0a20 2020 2020  .is_arm():.     
-0001bb90: 2020 2020 2020 206c 6f67 2e65 7272 6f72         log.error
-0001bba0: 2822 4745 545f 4c41 5345 525f 494e 5445  ("GET_LASER_INTE
-0001bbb0: 524c 4f43 4b20 6e6f 7420 7375 7070 6f72  RLOCK not suppor
-0001bbc0: 7465 6420 6f6e 2041 524d 2229 0a20 2020  ted on ARM").   
-0001bbd0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001bbe0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001bbf0: 6f6e 7365 2864 6174 613d 4661 6c73 652c  onse(data=False,
-0001bc00: 6572 726f 725f 6d73 673d 226c 6173 6572  error_msg="laser
-0001bc10: 2069 6e74 6572 6c6f 636b 206e 6f74 2073   interlock not s
-0001bc20: 7570 706f 7274 6564 2229 0a20 2020 2020  upported").     
-0001bc30: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0001bc40: 6765 745f 636f 6465 2830 7865 662c 206c  get_code(0xef, l
-0001bc50: 6162 656c 3d22 4745 545f 4c41 5345 525f  abel="GET_LASER_
-0001bc60: 494e 5445 524c 4f43 4b22 2c20 6d73 625f  INTERLOCK", msb_
-0001bc70: 6c65 6e3d 3129 0a0a 2020 2020 6465 6620  len=1)..    def 
-0001bc80: 6765 745f 6c61 7365 725f 656e 6162 6c65  get_laser_enable
-0001bc90: 6428 7365 6c66 2920 2d3e 2053 7065 6374  d(self) -> Spect
-0001bca0: 726f 6d65 7465 7252 6573 706f 6e73 653a  rometerResponse:
-0001bcb0: 0a20 2020 2020 2020 2072 6573 203d 2073  .        res = s
-0001bcc0: 656c 662e 5f67 6574 5f63 6f64 6528 3078  elf._get_code(0x
-0001bcd0: 6532 2c20 6c61 6265 6c3d 2247 4554 5f4c  e2, label="GET_L
-0001bce0: 4153 4552 5f45 4e41 424c 4544 222c 206d  ASER_ENABLED", m
-0001bcf0: 7362 5f6c 656e 3d31 290a 2020 2020 2020  sb_len=1).      
-0001bd00: 2020 666c 6167 203d 2030 2021 3d20 7265    flag = 0 != re
-0001bd10: 732e 6461 7461 0a20 2020 2020 2020 206c  s.data.        l
-0001bd20: 6f67 2e64 6562 7567 2822 6765 745f 6c61  og.debug("get_la
-0001bd30: 7365 725f 656e 6162 6c65 643a 2025 7322  ser_enabled: %s"
-0001bd40: 2c20 666c 6167 290a 2020 2020 2020 2020  , flag).        
+0000e630: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+0000e640: 0a0d 0a20 2020 2020 2020 2069 6620 7365  ...        if se
+0000e650: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
+0000e660: 652e 6261 645f 7069 7865 6c5f 6d6f 6465  e.bad_pixel_mode
+0000e670: 203d 3d20 5370 6563 7472 6f6d 6574 6572   == Spectrometer
+0000e680: 5374 6174 652e 4241 445f 5049 5845 4c5f  State.BAD_PIXEL_
+0000e690: 4d4f 4445 5f41 5645 5241 4745 3a0d 0a20  MODE_AVERAGE:.. 
+0000e6a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000e6b0: 5f63 6f72 7265 6374 5f62 6164 5f70 6978  _correct_bad_pix
+0000e6c0: 656c 7328 7370 6563 7472 756d 290d 0a0d  els(spectrum)...
+0000e6d0: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+0000e6e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e6f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e700: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e710: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e720: 230d 0a20 2020 2020 2020 2023 2053 7761  #..        # Swa
+0000e730: 7020 416c 7465 726e 6174 696e 6720 5069  p Alternating Pi
+0000e740: 7865 6c73 2028 7665 7279 2072 6172 6529  xels (very rare)
+0000e750: 0d0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
+0000e760: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e770: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e780: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e790: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e7a0: 2323 0d0a 0d0a 2020 2020 2020 2020 2320  ##....        # 
+0000e7b0: 6120 7072 6f74 6f74 7970 6520 6d6f 6465  a prototype mode
+0000e7c0: 6c20 6f75 7470 7574 2073 7065 6374 7261  l output spectra
+0000e7d0: 2077 6974 6820 616c 7465 726e 6174 696e   with alternatin
+0000e7e0: 6720 7069 7865 6c73 2073 7761 7070 6564  g pixels swapped
+0000e7f0: 2c20 616e 640d 0a20 2020 2020 2020 2023  , and..        #
+0000e800: 2074 6869 7320 7761 7320 7175 6963 6b65   this was quicke
+0000e810: 7220 7468 616e 2063 6861 6e67 696e 6720  r than changing 
+0000e820: 696e 2066 6972 6d77 6172 650d 0a0d 0a20  in firmware.... 
+0000e830: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+0000e840: 6574 7469 6e67 732e 7374 6174 652e 7377  ettings.state.sw
+0000e850: 6170 5f61 6c74 6572 6e61 7469 6e67 5f70  ap_alternating_p
+0000e860: 6978 656c 7320 616e 6420 7365 6c66 2e73  ixels and self.s
+0000e870: 6574 7469 6e67 732e 7374 6174 652e 6465  ettings.state.de
+0000e880: 7465 6374 6f72 5f72 6567 696f 6e73 2069  tector_regions i
+0000e890: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
+0000e8a0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
+0000e8b0: 7377 6170 7069 6e67 2061 6c74 6572 6e61  swapping alterna
+0000e8c0: 7469 6e67 2070 6978 656c 733a 2073 7065  ting pixels: spe
+0000e8d0: 6374 7275 6d20 3d20 2573 222c 2073 7065  ctrum = %s", spe
+0000e8e0: 6374 7275 6d5b 3a31 305d 290d 0a20 2020  ctrum[:10])..   
+0000e8f0: 2020 2020 2020 2020 2063 6f72 7265 6374           correct
+0000e900: 6564 203d 205b 5d0d 0a20 2020 2020 2020  ed = []..       
+0000e910: 2020 2020 2066 6f72 2061 2c20 6220 696e       for a, b in
+0000e920: 207a 6970 2873 7065 6374 7275 6d5b 303a   zip(spectrum[0:
+0000e930: 3a32 5d2c 2073 7065 6374 7275 6d5b 313a  :2], spectrum[1:
+0000e940: 3a32 5d29 3a0d 0a20 2020 2020 2020 2020  :2]):..         
+0000e950: 2020 2020 2020 2063 6f72 7265 6374 6564         corrected
+0000e960: 2e65 7874 656e 6428 5b62 2c20 615d 290d  .extend([b, a]).
+0000e970: 0a20 2020 2020 2020 2020 2020 2073 7065  .            spe
+0000e980: 6374 7275 6d20 3d20 636f 7272 6563 7465  ctrum = correcte
+0000e990: 640d 0a20 2020 2020 2020 2020 2020 206c  d..            l
+0000e9a0: 6f67 2e64 6562 7567 2822 7377 6170 7065  og.debug("swappe
+0000e9b0: 6420 616c 7465 726e 6174 696e 6720 7069  d alternating pi
+0000e9c0: 7865 6c73 3a20 7370 6563 7472 756d 203d  xels: spectrum =
+0000e9d0: 2025 7322 2c20 7370 6563 7472 756d 5b3a   %s", spectrum[:
+0000e9e0: 3130 5d29 0d0a 0d0a 2020 2020 2020 2020  10])....        
+0000e9f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ea00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ea10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ea20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ea30: 2323 2323 2323 2323 0d0a 2020 2020 2020  ########..      
+0000ea40: 2020 2320 3278 3220 6269 6e6e 696e 670d    # 2x2 binning.
+0000ea50: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+0000ea60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ea70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ea80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ea90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000eaa0: 230d 0a0d 0a20 2020 2020 2020 2023 2061  #....        # a
+0000eab0: 7070 6c79 2073 6f2d 6361 6c6c 6564 2022  pply so-called "
+0000eac0: 3278 3220 7069 7865 6c20 6269 6e6e 696e  2x2 pixel binnin
+0000ead0: 6722 200d 0a20 2020 2020 2020 2073 7065  g" ..        spe
+0000eae0: 6374 7275 6d20 3d20 7365 6c66 2e5f 6170  ctrum = self._ap
+0000eaf0: 706c 795f 3278 325f 6269 6e6e 696e 6728  ply_2x2_binning(
+0000eb00: 7370 6563 7472 756d 290d 0a0d 0a20 2020  spectrum)....   
+0000eb10: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+0000eb20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000eb30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000eb40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000eb50: 2323 2323 2323 2323 2323 2323 230d 0a20  #############.. 
+0000eb60: 2020 2020 2020 2023 2047 7261 7068 2041         # Graph A
+0000eb70: 6c74 6572 6e61 7469 6e67 2050 6978 656c  lternating Pixel
+0000eb80: 730d 0a20 2020 2020 2020 2023 2323 2323  s..        #####
+0000eb90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000eba0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ebb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ebc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ebd0: 2323 230d 0a0d 0a20 2020 2020 2020 2023  ###....        #
+0000ebe0: 2057 6865 6e20 696e 7465 6772 6174 696e   When integratin
+0000ebf0: 6720 6e65 7720 7365 6e73 6f72 732c 206f  g new sensors, o
+0000ec00: 7220 7465 7374 696e 6720 2269 6e74 6572  r testing "inter
+0000ec10: 6c65 6176 6564 2220 6465 7465 6374 6f72  leaved" detector
+0000ec20: 7320 6c69 6b65 0d0a 2020 2020 2020 2020  s like..        
+0000ec30: 2320 7468 6520 496e 4761 4173 2c20 736f  # the InGaAs, so
+0000ec40: 6d65 7469 6d65 7320 7765 2077 616e 7420  metimes we want 
+0000ec50: 746f 206f 6e6c 7920 6c6f 6f6b 2061 7420  to only look at 
+0000ec60: 2265 7665 7279 206f 7468 6572 2220 7069  "every other" pi
+0000ec70: 7865 6c20 746f 0d0a 2020 2020 2020 2020  xel to..        
+0000ec80: 2320 666c 6174 7465 6e2d 6f75 7420 6972  # flatten-out ir
+0000ec90: 7265 6775 6c61 7269 7469 6573 2069 6e20  regularities in 
+0000eca0: 4261 7965 7220 6669 6c74 6572 7320 6f72  Bayer filters or
+0000ecb0: 2070 686f 746f 6469 6f64 6520 6172 7261   photodiode arra
+0000ecc0: 7973 2e0d 0a20 2020 2020 2020 2023 2048  ys...        # H
+0000ecd0: 6f77 6576 6572 2c20 7765 2064 6f6e 2774  owever, we don't
+0000ece0: 2077 616e 7420 746f 2064 6973 7275 7074   want to disrupt
+0000ecf0: 2074 6865 2065 7870 6563 7465 6420 7069   the expected pi
+0000ed00: 7865 6c2d 636f 756e 742c 2073 6f20 6a75  xel-count, so ju
+0000ed10: 7374 0d0a 2020 2020 2020 2020 2320 6176  st..        # av
+0000ed20: 6572 6167 652d 6f76 6572 2074 6865 2073  erage-over the s
+0000ed30: 6b69 7070 6564 2070 6978 656c 732e 0d0a  kipped pixels...
+0000ed40: 2020 2020 2020 2020 230d 0a20 2020 2020          #..     
+0000ed50: 2020 2023 204e 6f74 2069 6d70 6f72 7461     # Not importa
+0000ed60: 6e74 2065 6e6f 7567 6820 746f 2075 7064  nt enough to upd
+0000ed70: 6174 6520 666f 7220 4465 7465 6374 6f72  ate for Detector
+0000ed80: 5265 6769 6f6e 730d 0a20 2020 2020 2020  Regions..       
+0000ed90: 2069 6620 7365 6c66 2e73 6574 7469 6e67   if self.setting
+0000eda0: 732e 7374 6174 652e 6772 6170 685f 616c  s.state.graph_al
+0000edb0: 7465 726e 6174 696e 675f 7069 7865 6c73  ternating_pixels
+0000edc0: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
+0000edd0: 6f67 2e64 6562 7567 2822 6170 706c 7969  og.debug("applyi
+0000ede0: 6e67 2067 7261 7068 5f61 6c74 6572 6e61  ng graph_alterna
+0000edf0: 7469 6e67 5f70 6978 656c 7322 290d 0a20  ting_pixels").. 
+0000ee00: 2020 2020 2020 2020 2020 2073 6d6f 6f74             smoot
+0000ee10: 6865 6420 3d20 5b5d 0d0a 2020 2020 2020  hed = []..      
+0000ee20: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
+0000ee30: 616e 6765 286c 656e 2873 7065 6374 7275  ange(len(spectru
+0000ee40: 6d29 293a 0d0a 2020 2020 2020 2020 2020  m)):..          
+0000ee50: 2020 2020 2020 6966 2069 2025 2032 203d        if i % 2 =
+0000ee60: 3d20 303a 0d0a 2020 2020 2020 2020 2020  = 0:..          
+0000ee70: 2020 2020 2020 2020 2020 736d 6f6f 7468            smooth
+0000ee80: 6564 2e61 7070 656e 6428 7370 6563 7472  ed.append(spectr
+0000ee90: 756d 5b69 5d29 0d0a 2020 2020 2020 2020  um[i])..        
+0000eea0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+0000eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eec0: 2020 2069 6620 6920 2b20 3120 3c20 6c65     if i + 1 < le
+0000eed0: 6e28 7370 6563 7472 756d 293a 0d0a 2020  n(spectrum):..  
+0000eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eef0: 2020 2020 2020 6176 6572 6167 6564 203d        averaged =
+0000ef00: 2028 7370 6563 7472 756d 5b69 2d31 5d20   (spectrum[i-1] 
+0000ef10: 2b20 7370 6563 7472 756d 5b69 2b31 5d29  + spectrum[i+1])
+0000ef20: 202f 2032 2e30 0d0a 2020 2020 2020 2020   / 2.0..        
+0000ef30: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000ef40: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+0000ef50: 2020 2020 2020 2020 2020 2061 7665 7261             avera
+0000ef60: 6765 6420 3d20 7370 6563 7472 756d 5b69  ged = spectrum[i
+0000ef70: 202d 2031 5d0d 0a20 2020 2020 2020 2020   - 1]..         
+0000ef80: 2020 2020 2020 2020 2020 2073 6d6f 6f74             smoot
+0000ef90: 6865 642e 6170 7065 6e64 2861 7665 7261  hed.append(avera
+0000efa0: 6765 6429 0d0a 2020 2020 2020 2020 2020  ged)..          
+0000efb0: 2020 7370 6563 7472 756d 203d 2073 6d6f    spectrum = smo
+0000efc0: 6f74 6865 640d 0a0d 0a20 2020 2020 2020  othed....       
+0000efd0: 2023 2053 6f6d 6577 6861 7420 6f64 646c   # Somewhat oddl
+0000efe0: 792c 2077 6527 7265 2063 7572 7265 6e74  y, we're current
+0000eff0: 6c79 2072 6574 7572 6e69 6e67 2061 2054  ly returning a T
+0000f000: 5550 4c45 206f 6620 7468 6520 7370 6563  UPLE of the spec
+0000f010: 7472 756d 2061 6e64 0d0a 2020 2020 2020  trum and..      
+0000f020: 2020 2320 7468 6520 6172 6561 2073 6361    # the area sca
+0000f030: 6e20 726f 7720 636f 756e 742e 2020 5768  n row count.  Wh
+0000f040: 656e 2022 4661 7374 2220 4172 6561 2053  en "Fast" Area S
+0000f050: 6361 6e20 6973 206d 6f72 6520 636f 6d6d  can is more comm
+0000f060: 6f6e 706c 6163 6520 0d0a 2020 2020 2020  onplace ..      
+0000f070: 2020 2320 7765 276c 6c20 6368 616e 6765    # we'll change
+0000f080: 2074 6869 7320 6261 636b 2074 6f20 6a75   this back to ju
+0000f090: 7374 2072 6574 7572 6e69 6e67 2074 6865  st returning the
+0000f0a0: 2073 7065 6374 7275 6d20 6172 7261 7920   spectrum array 
+0000f0b0: 6469 7265 6374 6c79 2e0d 0a20 2020 2020  directly...     
+0000f0c0: 2020 2072 6573 706f 6e73 652e 6461 7461     response.data
+0000f0d0: 203d 2053 7065 6374 7275 6d41 6e64 526f   = SpectrumAndRo
+0000f0e0: 7728 7370 6563 7472 756d 2c20 6172 6561  w(spectrum, area
+0000f0f0: 5f73 6361 6e5f 726f 775f 636f 756e 7429  _scan_row_count)
+0000f100: 200d 0a20 2020 2020 2020 2072 6574 7572   ..        retur
+0000f110: 6e20 7265 7370 6f6e 7365 0d0a 0d0a 2020  n response....  
+0000f120: 2020 6465 6620 7365 745f 696e 7465 6772    def set_integr
+0000f130: 6174 696f 6e5f 7469 6d65 5f6d 7328 7365  ation_time_ms(se
+0000f140: 6c66 2c20 6d73 3a20 666c 6f61 7429 3a20  lf, ms: float): 
+0000f150: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+0000f160: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+0000f170: 2020 2020 2222 220d 0a20 2020 2020 2020      """..       
+0000f180: 2053 656e 6420 7468 6520 7570 6461 7465   Send the update
+0000f190: 6420 696e 7465 6772 6174 696f 6e20 7469  d integration ti
+0000f1a0: 6d65 2069 6e20 6120 636f 6e74 726f 6c20  me in a control 
+0000f1b0: 6d65 7373 6167 6520 746f 2074 6865 2064  message to the d
+0000f1c0: 6576 6963 650d 0a20 2020 2020 2020 2040  evice..        @
+0000f1d0: 7761 726e 696e 6720 6469 7361 626c 6564  warning disabled
+0000f1e0: 2045 4550 524f 4d20 7261 6e67 652d 6368   EEPROM range-ch
+0000f1f0: 6563 6b69 6e67 2062 7920 6375 7374 6f6d  ecking by custom
+0000f200: 6572 0d0a 2020 2020 2020 2020 2020 2020  er..            
+0000f210: 2072 6571 7565 7374 3b20 7261 6e67 6520   request; range 
+0000f220: 6c69 6d69 7473 2069 6e20 4545 5052 4f4d  limits in EEPROM
+0000f230: 2061 7265 2064 6566 696e 6564 2061 7320   are defined as 
+0000f240: 3136 2d62 6974 0d0a 2020 2020 2020 2020  16-bit..        
+0000f250: 2020 2020 2076 616c 7565 732c 2077 6869       values, whi
+0000f260: 6c65 2069 6e74 6567 7261 7469 6f6e 2074  le integration t
+0000f270: 696d 6520 6973 2061 6374 7561 6c6c 7920  ime is actually 
+0000f280: 6120 3234 2d62 6974 2076 616c 7565 2c0d  a 24-bit value,.
+0000f290: 0a20 2020 2020 2020 2020 2020 2020 7375  .             su
+0000f2a0: 6368 2074 6861 7420 7468 6520 4545 5052  ch that the EEPR
+0000f2b0: 4f4d 2069 7320 6172 7469 6669 6369 616c  OM is artificial
+0000f2c0: 6c79 206c 696d 6974 696e 6720 6f75 7220  ly limiting our 
+0000f2d0: 7261 6e67 652e 0d0a 2020 2020 2020 2020  range...        
+0000f2e0: 2222 220d 0a20 2020 2020 2020 206d 7320  """..        ms 
+0000f2f0: 3d20 6d61 7828 312c 2069 6e74 2872 6f75  = max(1, int(rou
+0000f300: 6e64 286d 7329 2929 0d0a 0d0a 2020 2020  nd(ms)))....    
+0000f310: 2020 2020 6c73 7720 3d20 206d 7320 2020      lsw =  ms   
+0000f320: 2020 2020 2026 2030 7866 6666 660d 0a20       & 0xffff.. 
+0000f330: 2020 2020 2020 206d 7377 203d 2028 6d73         msw = (ms
+0000f340: 203e 3e20 3136 2920 2620 3078 3030 6666   >> 16) & 0x00ff
+0000f350: 0d0a 0d0a 2020 2020 2020 2020 7265 7375  ....        resu
+0000f360: 6c74 203d 2073 656c 662e 5f73 656e 645f  lt = self._send_
+0000f370: 636f 6465 2830 7842 322c 206c 7377 2c20  code(0xB2, lsw, 
+0000f380: 6d73 772c 206c 6162 656c 3d22 5345 545f  msw, label="SET_
+0000f390: 494e 5445 4752 4154 494f 4e5f 5449 4d45  INTEGRATION_TIME
+0000f3a0: 5f4d 5322 290d 0a20 2020 2020 2020 206c  _MS")..        l
+0000f3b0: 6f67 2e64 6562 7567 2822 5345 545f 494e  og.debug("SET_IN
+0000f3c0: 5445 4752 4154 494f 4e5f 5449 4d45 5f4d  TEGRATION_TIME_M
+0000f3d0: 533a 206e 6f77 2025 6422 2c20 6d73 290d  S: now %d", ms).
+0000f3e0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0000f3f0: 7474 696e 6773 2e73 7461 7465 2e69 6e74  ttings.state.int
+0000f400: 6567 7261 7469 6f6e 5f74 696d 655f 6d73  egration_time_ms
+0000f410: 203d 206d 730d 0a0d 0a20 2020 2020 2020   = ms....       
+0000f420: 2023 2063 6f6e 7363 696f 7573 6c79 2062   # consciously b
+0000f430: 7574 2063 6175 7469 6f75 736c 7920 6469  ut cautiously di
+0000f440: 7361 626c 696e 6720 7468 6973 2066 756e  sabling this fun
+0000f450: 6374 696f 6e61 6c69 7479 0d0a 2020 2020  ctionality..    
+0000f460: 2020 2020 2320 6966 2073 656c 662e 7365      # if self.se
+0000f470: 7474 696e 6773 2e69 735f 6d69 6372 6f28  ttings.is_micro(
+0000f480: 293a 0d0a 2020 2020 2020 2020 2320 2020  ):..        #   
+0000f490: 2020 7365 6c66 2e75 7064 6174 655f 6c61    self.update_la
+0000f4a0: 7365 725f 7761 7463 6864 6f67 2829 3b0d  ser_watchdog();.
+0000f4b0: 0a0d 0a20 2020 2020 2020 2072 6574 7572  ...        retur
+0000f4c0: 6e20 7265 7375 6c74 0d0a 0d0a 2020 2020  n result....    
+0000f4d0: 2320 2323 2323 2323 2323 2323 2323 2323  # ##############
+0000f4e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f4f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f510: 2323 2323 2323 2323 2323 2323 0d0a 2020  ############..  
+0000f520: 2020 2320 5465 6d70 6572 6174 7572 650d    # Temperature.
+0000f530: 0a20 2020 2023 2023 2323 2323 2323 2323  .    # #########
+0000f540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f560: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000f580: 230d 0a0d 0a20 2020 2064 6566 2073 656c  #....    def sel
+0000f590: 6563 745f 6164 6328 7365 6c66 2c20 6e3a  ect_adc(self, n:
+0000f5a0: 2069 6e74 293a 2023 202d 3e20 5370 6563   int): # -> Spec
+0000f5b0: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+0000f5c0: 200d 0a20 2020 2020 2020 206c 6f67 2e64   ..        log.d
+0000f5d0: 6562 7567 2822 7365 6c65 6374 5f61 6463  ebug("select_adc
+0000f5e0: 202d 3e20 2564 222c 206e 290d 0a20 2020   -> %d", n)..   
+0000f5f0: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
+0000f600: 6773 2e73 7461 7465 2e73 656c 6563 7465  gs.state.selecte
+0000f610: 645f 6164 6320 3d20 6e0d 0a20 2020 2020  d_adc = n..     
+0000f620: 2020 2072 6573 756c 7420 3d20 7365 6c66     result = self
+0000f630: 2e5f 7365 6e64 5f63 6f64 6528 3078 6564  ._send_code(0xed
+0000f640: 2c20 6e2c 206c 6162 656c 3d22 5345 4c45  , n, label="SELE
+0000f650: 4354 5f41 4443 2229 0d0a 2020 2020 2020  CT_ADC")..      
+0000f660: 2020 7365 6c66 2e5f 6765 745f 636f 6465    self._get_code
+0000f670: 2830 7864 352c 2077 4c65 6e67 7468 3d32  (0xd5, wLength=2
+0000f680: 2c20 6c61 6265 6c3d 2247 4554 5f41 4443  , label="GET_ADC
+0000f690: 2028 7468 726f 7761 7761 7929 2229 2023   (throwaway)") #
+0000f6a0: 2073 7461 6269 6c69 7a61 7469 6f6e 2072   stabilization r
+0000f6b0: 6561 640d 0a20 2020 2020 2020 2072 6574  ead..        ret
+0000f6c0: 7572 6e20 7265 7375 6c74 0d0a 0d0a 2020  urn result....  
+0000f6d0: 2020 6465 6620 6765 745f 7365 636f 6e64    def get_second
+0000f6e0: 6172 795f 6164 635f 6361 6c69 6272 6174  ary_adc_calibrat
+0000f6f0: 6564 2873 656c 662c 2072 6177 3a20 666c  ed(self, raw: fl
+0000f700: 6f61 7420 3d20 4e6f 6e65 293a 2023 202d  oat = None): # -
+0000f710: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+0000f720: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+0000f730: 2072 6573 706f 6e73 6520 3d20 5370 6563   response = Spec
+0000f740: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+0000f750: 2829 0d0a 2020 2020 2020 2020 6966 206e  ()..        if n
+0000f760: 6f74 2073 656c 662e 6861 735f 6c69 6e65  ot self.has_line
+0000f770: 6172 6974 795f 636f 6566 6673 2829 3a0d  arity_coeffs():.
+0000f780: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0000f790: 2e64 6562 7567 2822 7365 636f 6e64 6172  .debug("secondar
+0000f7a0: 795f 6164 635f 6361 6c69 6272 6174 6564  y_adc_calibrated
+0000f7b0: 3a20 6e6f 2063 616c 6962 7261 7469 6f6e  : no calibration
+0000f7c0: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+0000f7d0: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+0000f7e0: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
+0000f7f0: 3d4e 6f6e 652c 2065 7272 6f72 5f6c 766c  =None, error_lvl
+0000f800: 3d45 7272 6f72 4c65 7665 6c2e 6c6f 772c  =ErrorLevel.low,
+0000f810: 2065 7272 6f72 5f6d 7367 3d22 7365 636f   error_msg="seco
+0000f820: 6e64 6172 795f 6164 635f 6361 6c69 6272  ndary_adc_calibr
+0000f830: 6174 6564 3a20 6e6f 2063 616c 6962 7261  ated: no calibra
+0000f840: 7469 6f6e 2229 0d0a 0d0a 2020 2020 2020  tion")....      
+0000f850: 2020 6966 2072 6177 2069 7320 4e6f 6e65    if raw is None
+0000f860: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+0000f870: 6177 5f72 6573 203d 2073 656c 662e 6765  aw_res = self.ge
+0000f880: 745f 7365 636f 6e64 6172 795f 6164 635f  t_secondary_adc_
+0000f890: 7261 7728 290d 0a20 2020 2020 2020 2069  raw()..        i
+0000f8a0: 6620 7261 775f 7265 732e 6461 7461 2069  f raw_res.data i
+0000f8b0: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
+0000f8c0: 2020 2020 2072 6574 7572 6e20 7261 775f       return raw_
+0000f8d0: 7265 730d 0a0d 0a20 2020 2020 2020 2072  res....        r
+0000f8e0: 6177 203d 2066 6c6f 6174 2872 6177 5f72  aw = float(raw_r
+0000f8f0: 6573 2e64 6174 6129 0d0a 0d0a 2020 2020  es.data)....    
+0000f900: 2020 2020 2320 7573 6520 7468 6520 6669      # use the fi
+0000f910: 7273 7420 3420 6c69 6e65 6172 6974 7920  rst 4 linearity 
+0000f920: 636f 6566 6669 6369 656e 7473 2061 7320  coefficients as 
+0000f930: 6120 3372 642d 6f72 6465 7220 706f 6c79  a 3rd-order poly
+0000f940: 6e6f 6d69 616c 0d0a 2020 2020 2020 2020  nomial..        
+0000f950: 6361 6c69 6272 6174 6564 203d 2066 6c6f  calibrated = flo
+0000f960: 6174 2873 656c 662e 7365 7474 696e 6773  at(self.settings
+0000f970: 2e65 6570 726f 6d2e 6c69 6e65 6172 6974  .eeprom.linearit
+0000f980: 795f 636f 6566 6673 5b30 5d29 205c 0d0a  y_coeffs[0]) \..
+0000f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9a0: 2020 202b 2066 6c6f 6174 2873 656c 662e     + float(self.
+0000f9b0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+0000f9c0: 6c69 6e65 6172 6974 795f 636f 6566 6673  linearity_coeffs
+0000f9d0: 5b31 5d29 202a 2072 6177 205c 0d0a 2020  [1]) * raw \..  
+0000f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f9f0: 202b 2066 6c6f 6174 2873 656c 662e 7365   + float(self.se
+0000fa00: 7474 696e 6773 2e65 6570 726f 6d2e 6c69  ttings.eeprom.li
+0000fa10: 6e65 6172 6974 795f 636f 6566 6673 5b32  nearity_coeffs[2
+0000fa20: 5d29 202a 2072 6177 202a 2072 6177 205c  ]) * raw * raw \
+0000fa30: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000fa40: 2020 2020 202b 2066 6c6f 6174 2873 656c       + float(sel
+0000fa50: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+0000fa60: 6d2e 6c69 6e65 6172 6974 795f 636f 6566  m.linearity_coef
+0000fa70: 6673 5b33 5d29 202a 2072 6177 202a 2072  fs[3]) * raw * r
+0000fa80: 6177 202a 2072 6177 0d0a 2020 2020 2020  aw * raw..      
+0000fa90: 2020 6c6f 672e 6465 6275 6728 2273 6563    log.debug("sec
+0000faa0: 6f6e 6461 7279 5f61 6463 5f63 616c 6962  ondary_adc_calib
+0000fab0: 7261 7465 643a 2025 6622 2c20 6361 6c69  rated: %f", cali
+0000fac0: 6272 6174 6564 290d 0a20 2020 2020 2020  brated)..       
+0000fad0: 2072 6573 706f 6e73 652e 7472 616e 7366   response.transf
+0000fae0: 6572 5f72 6573 706f 6e73 6528 7261 775f  er_response(raw_
+0000faf0: 7265 7329 0d0a 2020 2020 2020 2020 7265  res)..        re
+0000fb00: 7370 6f6e 7365 2e64 6174 6120 3d20 6361  sponse.data = ca
+0000fb10: 6c69 6272 6174 6564 0d0a 2020 2020 2020  librated..      
+0000fb20: 2020 7265 7475 726e 2072 6573 706f 6e73    return respons
+0000fb30: 650d 0a0d 0a20 2020 2064 6566 2067 6574  e....    def get
+0000fb40: 5f73 6563 6f6e 6461 7279 5f61 6463 5f72  _secondary_adc_r
+0000fb50: 6177 2873 656c 6629 3a20 2320 2d3e 2053  aw(self): # -> S
+0000fb60: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0000fb70: 6e73 6520 0d0a 2020 2020 2020 2020 2320  nse ..        # 
+0000fb80: 666c 6970 2074 6f20 7365 636f 6e64 6172  flip to secondar
+0000fb90: 7920 4144 4320 6966 206e 6565 6465 640d  y ADC if needed.
+0000fba0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000fbb0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
+0000fbc0: 7365 6c65 6374 6564 5f61 6463 2069 7320  selected_adc is 
+0000fbd0: 4e6f 6e65 206f 7220 7365 6c66 2e73 6574  None or self.set
+0000fbe0: 7469 6e67 732e 7374 6174 652e 7365 6c65  tings.state.sele
+0000fbf0: 6374 6564 5f61 6463 2021 3d20 313a 0d0a  cted_adc != 1:..
+0000fc00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000fc10: 2e73 656c 6563 745f 6164 6328 3129 0d0a  .select_adc(1)..
+0000fc20: 0d0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+0000fc30: 203d 2073 656c 662e 5f67 6574 5f63 6f64   = self._get_cod
+0000fc40: 6528 3078 6435 2c20 774c 656e 6774 683d  e(0xd5, wLength=
+0000fc50: 322c 206c 6162 656c 3d22 4745 545f 4144  2, label="GET_AD
+0000fc60: 4322 2c20 6c73 625f 6c65 6e3d 3229 2026  C", lsb_len=2) &
+0000fc70: 2030 7866 6666 0d0a 2020 2020 2020 2020   0xfff..        
+0000fc80: 6c6f 672e 6465 6275 6728 2273 6563 6f6e  log.debug("secon
+0000fc90: 6461 7279 5f61 6463 5f72 6177 3a20 3078  dary_adc_raw: 0x
+0000fca0: 2530 3478 222c 2072 6573 756c 7429 0d0a  %04x", result)..
+0000fcb0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0000fcc0: 6573 756c 740d 0a0d 0a20 2020 2023 230d  esult....    ##.
+0000fcd0: 0a20 2020 2023 204c 6173 6572 2074 656d  .    # Laser tem
+0000fce0: 7065 7261 7475 7265 2063 6f6e 7665 7273  perature convers
+0000fcf0: 696f 6e20 646f 6573 6e27 7420 7573 6520  ion doesn't use 
+0000fd00: 4545 5052 4f4d 2063 6f65 6666 7320 6174  EEPROM coeffs at
+0000fd10: 2061 6c6c 2e0d 0a20 2020 2023 204d 6f73   all...    # Mos
+0000fd20: 7420 5761 7361 7463 6820 5261 6d61 6e20  t Wasatch Raman 
+0000fd30: 7379 7374 656d 7320 7573 6520 616e 2049  systems use an I
+0000fd40: 5053 2057 6176 656c 656e 6774 682d 5374  PS Wavelength-St
+0000fd50: 6162 696c 697a 6564 2054 4f2d 3536 0d0a  abilized TO-56..
+0000fd60: 2020 2020 2320 6c61 7365 722c 2077 6869      # laser, whi
+0000fd70: 6368 2069 6e74 6572 6e61 6c6c 7920 7573  ch internally us
+0000fd80: 6573 2061 2042 6574 6174 6865 726d 2031  es a Betatherm 1
+0000fd90: 304b 3343 4733 2074 6865 726d 6973 746f  0K3CG3 thermisto
+0000fda0: 722e 0d0a 2020 2020 230d 0a20 2020 2023  r...    #..    #
+0000fdb0: 2040 7365 6520 6874 7470 733a 2f2f 7777   @see https://ww
+0000fdc0: 772e 6970 736c 6173 6572 732e 636f 6d2f  w.ipslasers.com/
+0000fdd0: 6461 7461 2d73 6865 6574 732f 534d 2d54  data-sheets/SM-T
+0000fde0: 4f2d 3536 2d44 6174 612d 5368 6565 742d  O-56-Data-Sheet-
+0000fdf0: 4950 532e 7064 660d 0a20 2020 2023 0d0a  IPS.pdf..    #..
+0000fe00: 2020 2020 2320 5468 6520 6f66 6669 6369      # The offici
+0000fe10: 616c 2063 6f6e 7665 7273 696f 6e20 6672  al conversion fr
+0000fe20: 6f6d 2074 6865 726d 6973 746f 7220 7265  om thermistor re
+0000fe30: 7369 7374 616e 6365 2028 696e 206f 686d  sistance (in ohm
+0000fe40: 7329 2074 6f20 6465 6743 2069 733a 0d0a  s) to degC is:..
+0000fe50: 2020 2020 230d 0a20 2020 2023 205c 7665      #..    # \ve
+0000fe60: 7262 6174 696d 0d0a 2020 2020 2320 3120  rbatim..    # 1 
+0000fe70: 2f20 2820 2020 4331 0d0a 2020 2020 2320  / (   C1..    # 
+0000fe80: 2020 2020 2020 2b20 4332 202a 206c 6e28        + C2 * ln(
+0000fe90: 6f68 6d73 290d 0a20 2020 2023 2020 2020  ohms)..    #    
+0000fea0: 2020 202b 2043 3320 2a20 706f 7728 6c6e     + C3 * pow(ln
+0000feb0: 286f 686d 7329 2c20 3329 0d0a 2020 2020  (ohms), 3)..    
+0000fec0: 2320 2020 2020 290d 0a20 2020 2023 202d  #     )..    # -
+0000fed0: 2032 3733 2e31 350d 0a20 2020 2023 0d0a   273.15..    #..
+0000fee0: 2020 2020 2320 5768 6572 653a 2043 3120      # Where: C1 
+0000fef0: 3d20 302e 3030 3131 330d 0a20 2020 2023  = 0.00113..    #
+0000ff00: 2020 2020 2020 2020 4332 203d 2030 2e30          C2 = 0.0
+0000ff10: 3030 3233 340d 0a20 2020 2023 2020 2020  00234..    #    
+0000ff20: 2020 2020 4333 203d 2038 2e37 3865 2d38      C3 = 8.78e-8
+0000ff30: 0d0a 2020 2020 2320 5c65 6e64 7665 7262  ..    # \endverb
+0000ff40: 6174 696d 0d0a 2020 2020 230d 0a20 2020  atim..    #..   
+0000ff50: 2023 2040 7061 7261 6d20 7261 7720 2020   # @param raw   
+0000ff60: 2074 6865 2076 616c 7565 2072 6561 6420   the value read 
+0000ff70: 6672 6f6d 2074 6865 2074 6865 726d 6973  from the thermis
+0000ff80: 746f 7227 7320 3132 2d62 6974 2041 4443  tor's 12-bit ADC
+0000ff90: 2028 7368 6f75 6c64 2062 6520 0d0a 2020   (should be ..  
+0000ffa0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+0000ffb0: 2020 7569 6e74 3132 2c20 6275 7420 6170    uint12, but ap
+0000ffc0: 7061 7265 6e74 6c79 2063 616e 2062 6520  parently can be 
+0000ffd0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+0000ffe0: 6f6e 7365 3f29 0d0a 2020 2020 6465 6620  onse?)..    def 
+0000fff0: 6765 745f 6c61 7365 725f 7465 6d70 6572  get_laser_temper
+00010000: 6174 7572 655f 6465 6743 2873 656c 662c  ature_degC(self,
+00010010: 2072 6177 3a20 696e 7420 3d20 4e6f 6e65   raw: int = None
+00010020: 293a 2023 202d 3e20 5370 6563 7472 6f6d  ): # -> Spectrom
+00010030: 6574 6572 5265 7370 6f6e 7365 200d 0a20  eterResponse .. 
+00010040: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+00010050: 696e 7374 616e 6365 2872 6177 2c20 5370  instance(raw, Sp
+00010060: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00010070: 7365 293a 0d0a 2020 2020 2020 2020 2020  se):..          
+00010080: 2020 7261 7720 3d20 5370 6563 7472 6f6d    raw = Spectrom
+00010090: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+000100a0: 613d 7261 7729 0d0a 2020 2020 2020 2020  a=raw)..        
+000100b0: 6966 2072 6177 2069 7320 4e6f 6e65 3a0d  if raw is None:.
+000100c0: 0a20 2020 2020 2020 2020 2020 2072 6177  .            raw
+000100d0: 203d 2073 656c 662e 6765 745f 6c61 7365   = self.get_lase
+000100e0: 725f 7465 6d70 6572 6174 7572 655f 7261  r_temperature_ra
+000100f0: 7728 290d 0a0d 0a20 2020 2020 2020 2069  w()....        i
+00010100: 6620 7261 772e 6461 7461 2069 7320 4e6f  f raw.data is No
+00010110: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+00010120: 206d 7367 3d22 6765 745f 6c61 7365 725f   msg="get_laser_
+00010130: 7465 6d70 6572 6174 7572 655f 6465 6743  temperature_degC
+00010140: 3a20 6572 726f 7220 7265 6164 696e 6720  : error reading 
+00010150: 7261 7720 6c61 7365 7220 7465 6d70 6572  raw laser temper
+00010160: 6174 7572 6522 0d0a 2020 2020 2020 2020  ature"..        
+00010170: 2020 2020 6c6f 672e 6572 726f 7228 6d73      log.error(ms
+00010180: 6729 0d0a 2020 2020 2020 2020 2020 2020  g)..            
+00010190: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+000101a0: 7465 7252 6573 706f 6e73 6528 6572 726f  terResponse(erro
+000101b0: 725f 6c76 6c3d 4572 726f 724c 6576 656c  r_lvl=ErrorLevel
+000101c0: 2e6c 6f77 2c20 6572 726f 725f 6d73 673d  .low, error_msg=
+000101d0: 6d73 6729 0d0a 0d0a 2020 2020 2020 2020  msg)....        
+000101e0: 6966 2072 6177 2e64 6174 6120 3e20 3078  if raw.data > 0x
+000101f0: 6666 663a 0d0a 2020 2020 2020 2020 2020  fff:..          
+00010200: 2020 6d73 6720 3d20 2267 6574 5f6c 6173    msg = "get_las
+00010210: 6572 5f74 656d 7065 7261 7475 7265 5f64  er_temperature_d
+00010220: 6567 433a 2072 6177 2076 616c 7565 2030  egC: raw value 0
+00010230: 7825 3034 7820 6578 6365 6564 7320 3132  x%04x exceeds 12
+00010240: 2062 6974 7322 2025 2072 6177 2e64 6174   bits" % raw.dat
+00010250: 610d 0a20 2020 2020 2020 2020 2020 206c  a..            l
+00010260: 6f67 2e65 7272 6f72 286d 7367 290d 0a20  og.error(msg).. 
+00010270: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00010280: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
+00010290: 7370 6f6e 7365 2864 6174 613d 4e6f 6e65  sponse(data=None
+000102a0: 2c20 6572 726f 725f 6c76 6c3d 4572 726f  , error_lvl=Erro
+000102b0: 724c 6576 656c 2e6c 6f77 2c20 6572 726f  rLevel.low, erro
+000102c0: 725f 6d73 673d 6d73 6729 0d0a 0d0a 2020  r_msg=msg)....  
+000102d0: 2020 2020 2020 6966 2072 6177 2e64 6174        if raw.dat
+000102e0: 6120 3d3d 2030 3a0d 0a20 2020 2020 2020  a == 0:..       
+000102f0: 2020 2020 206d 7367 203d 2022 6765 745f       msg = "get_
+00010300: 6c61 7365 725f 7465 6d70 6572 6174 7572  laser_temperatur
+00010310: 655f 6465 6743 3a20 6361 6e27 7420 7461  e_degC: can't ta
+00010320: 6b65 206c 6f67 206f 6620 7261 7720 4144  ke log of raw AD
+00010330: 4320 7661 6c75 6520 3022 0d0a 2020 2020  C value 0"..    
+00010340: 2020 2020 2020 2020 6c6f 672e 6572 726f          log.erro
+00010350: 7228 6d73 6729 0d0a 2020 2020 2020 2020  r(msg)..        
+00010360: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
+00010370: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
+00010380: 6461 7461 3d4e 6f6e 6529 2023 206e 6f74  data=None) # not
+00010390: 2070 726f 706f 6761 7469 6e67 2065 7272   propogating err
+000103a0: 6f72 5f6d 7367 2066 6f72 206e 6f77 0d0a  or_msg for now..
+000103b0: 0d0a 2020 2020 2020 2020 6465 6743 203d  ..        degC =
+000103c0: 2030 0d0a 2020 2020 2020 2020 7472 793a   0..        try:
+000103d0: 0d0a 2020 2020 2020 2020 2020 2020 766f  ..            vo
+000103e0: 6c74 6167 6520 2020 203d 2032 2e35 202a  ltage    = 2.5 *
+000103f0: 2072 6177 2e64 6174 6120 2f20 3430 3936   raw.data / 4096
+00010400: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00010410: 7369 7374 616e 6365 203d 2032 3134 3530  sistance = 21450
+00010420: 2e30 202a 2076 6f6c 7461 6765 202f 2028  .0 * voltage / (
+00010430: 322e 3520 2d20 766f 6c74 6167 6529 2023  2.5 - voltage) #
+00010440: 204c 4220 636f 6e66 6972 6d65 640d 0a0d   LB confirmed...
+00010450: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010460: 7265 7369 7374 616e 6365 203c 2030 3a0d  resistance < 0:.
+00010470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010480: 206d 7367 3d22 6765 745f 6c61 7365 725f   msg="get_laser_
+00010490: 7465 6d70 6572 6174 7572 655f 6465 6743  temperature_degC
+000104a0: 3a20 6361 6e27 7420 636f 6d70 7574 6520  : can't compute 
+000104b0: 6465 6743 3a20 7261 7720 3d20 3078 2530  degC: raw = 0x%0
+000104c0: 3478 2c20 766f 6c74 6167 6520 3d20 2566  4x, voltage = %f
+000104d0: 2c20 7265 7369 7374 616e 6365 203d 2025  , resistance = %
+000104e0: 6622 2025 2028 0d0a 2020 2020 2020 2020  f" % (..        
+000104f0: 2020 2020 2020 2020 2020 2020 7261 772e              raw.
+00010500: 6461 7461 2c20 766f 6c74 6167 652c 2072  data, voltage, r
+00010510: 6573 6973 7461 6e63 6529 0d0a 2020 2020  esistance)..    
+00010520: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+00010530: 6572 726f 7228 6d73 6729 0d0a 2020 2020  error(msg)..    
+00010540: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00010550: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+00010560: 6573 706f 6e73 6528 6461 7461 3d4e 6f6e  esponse(data=Non
+00010570: 652c 2065 7272 6f72 5f6c 6576 656c 3d45  e, error_level=E
+00010580: 7272 6f72 4c65 7665 6c2e 6c6f 772c 2065  rrorLevel.low, e
+00010590: 7272 6f72 5f6d 7367 3d6d 7367 290d 0a0d  rror_msg=msg)...
+000105a0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000105b0: 5661 6c20 2020 2020 3d20 6d61 7468 2e6c  Val     = math.l
+000105c0: 6f67 2872 6573 6973 7461 6e63 6520 2f20  og(resistance / 
+000105d0: 3130 3030 302e 3029 0d0a 2020 2020 2020  10000.0)..      
+000105e0: 2020 2020 2020 696e 7369 6465 4d61 696e        insideMain
+000105f0: 203d 206c 6f67 5661 6c20 2b20 3339 3737   = logVal + 3977
+00010600: 2e30 202f 2028 3235 202b 2032 3733 2e30  .0 / (25 + 273.0
+00010610: 290d 0a20 2020 2020 2020 2020 2020 2064  )..            d
+00010620: 6567 4320 2020 2020 2020 3d20 3339 3737  egC       = 3977
+00010630: 2e30 202f 2069 6e73 6964 654d 6169 6e20  .0 / insideMain 
+00010640: 2d20 3237 332e 300d 0a0d 0a20 2020 2020  - 273.0....     
+00010650: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
+00010660: 2822 4c61 7365 7220 7465 6d70 6572 6174  ("Laser temperat
+00010670: 7572 653a 2025 2e32 6620 6465 6720 4320  ure: %.2f deg C 
+00010680: 2830 7825 3034 7820 7261 7729 2220 2520  (0x%04x raw)" % 
+00010690: 2864 6567 432c 2072 6177 2e64 6174 6129  (degC, raw.data)
+000106a0: 290d 0a20 2020 2020 2020 2065 7863 6570  )..        excep
+000106b0: 743a 0d0a 2020 2020 2020 2020 2020 2020  t:..            
+000106c0: 6d73 6720 3d20 2265 7863 6570 7469 6f6e  msg = "exception
+000106d0: 2063 6f6d 7075 7469 6e67 206c 6173 6572   computing laser
+000106e0: 2074 656d 7065 7261 7475 7265 220d 0a20   temperature".. 
+000106f0: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
+00010700: 7272 6f72 286d 7367 2c20 6578 635f 696e  rror(msg, exc_in
+00010710: 666f 3d31 290d 0a20 2020 2020 2020 2020  fo=1)..         
+00010720: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+00010730: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+00010740: 6174 613d 4e6f 6e65 2c20 6572 726f 725f  ata=None, error_
+00010750: 6c65 7665 6c3d 4572 726f 724c 6576 656c  level=ErrorLevel
+00010760: 2e6c 6f77 2c20 6572 726f 725f 6d73 673d  .low, error_msg=
+00010770: 6d73 6729 0d0a 0d0a 2020 2020 2020 2020  msg)....        
+00010780: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+00010790: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
+000107a0: 3d64 6567 4329 0d0a 0d0a 2020 2020 2323  =degC)....    ##
+000107b0: 2040 6e6f 7465 2062 6967 2d65 6e64 6961   @note big-endia
+000107c0: 6e2c 2072 6576 6572 7365 206f 6620 6765  n, reverse of ge
+000107d0: 745f 6c61 7365 725f 7465 6d70 6572 6174  t_laser_temperat
+000107e0: 7572 655f 7261 770d 0a20 2020 2064 6566  ure_raw..    def
+000107f0: 2067 6574 5f64 6574 6563 746f 725f 7465   get_detector_te
+00010800: 6d70 6572 6174 7572 655f 7261 7728 7365  mperature_raw(se
+00010810: 6c66 293a 2023 202d 3e20 5370 6563 7472  lf): # -> Spectr
+00010820: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+00010830: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010840: 7365 6c66 2e5f 6765 745f 636f 6465 2830  self._get_code(0
+00010850: 7864 372c 206c 6162 656c 3d22 4745 545f  xd7, label="GET_
+00010860: 4343 445f 5445 4d50 222c 206d 7362 5f6c  CCD_TEMP", msb_l
+00010870: 656e 3d32 290d 0a0d 0a20 2020 2064 6566  en=2)....    def
+00010880: 2067 6574 5f64 6574 6563 746f 725f 7465   get_detector_te
+00010890: 6d70 6572 6174 7572 655f 6465 6743 2873  mperature_degC(s
+000108a0: 656c 662c 2072 6177 3a20 666c 6f61 7420  elf, raw: float 
+000108b0: 3d20 4e6f 6e65 293a 2023 202d 3e20 5370  = None): # -> Sp
+000108c0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+000108d0: 7365 200d 0a20 2020 2020 2020 2069 6620  se ..        if 
+000108e0: 7261 7720 6973 204e 6f6e 653a 0d0a 2020  raw is None:..  
+000108f0: 2020 2020 2020 2020 2020 7261 7720 3d20            raw = 
+00010900: 7365 6c66 2e67 6574 5f64 6574 6563 746f  self.get_detecto
+00010910: 725f 7465 6d70 6572 6174 7572 655f 7261  r_temperature_ra
+00010920: 7728 292e 6461 7461 0d0a 0d0a 2020 2020  w().data....    
+00010930: 2020 2020 6966 2072 6177 2069 7320 4e6f      if raw is No
+00010940: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+00010950: 2072 6574 7572 6e20 7261 770d 0a0d 0a20   return raw.... 
+00010960: 2020 2020 2020 2064 6567 4320 3d20 7365         degC = se
+00010970: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+00010980: 6f6d 2e61 6463 5f74 6f5f 6465 6743 5f63  om.adc_to_degC_c
+00010990: 6f65 6666 735b 305d 2020 2020 2020 2020  oeffs[0]        
+000109a0: 2020 2020 205c 0d0a 2020 2020 2020 2020       \..        
+000109b0: 2020 2020 202b 2073 656c 662e 7365 7474       + self.sett
+000109c0: 696e 6773 2e65 6570 726f 6d2e 6164 635f  ings.eeprom.adc_
+000109d0: 746f 5f64 6567 435f 636f 6566 6673 5b31  to_degC_coeffs[1
+000109e0: 5d20 2a20 7261 7720 2020 2020 2020 5c0d  ] * raw       \.
+000109f0: 0a20 2020 2020 2020 2020 2020 2020 2b20  .             + 
+00010a00: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00010a10: 7072 6f6d 2e61 6463 5f74 6f5f 6465 6743  prom.adc_to_degC
+00010a20: 5f63 6f65 6666 735b 325d 202a 2072 6177  _coeffs[2] * raw
+00010a30: 202a 2072 6177 0d0a 2020 2020 2020 2020   * raw..        
+00010a40: 6c6f 672e 6465 6275 6728 2244 6574 6563  log.debug("Detec
+00010a50: 746f 7220 7465 6d70 6572 6174 7572 653a  tor temperature:
+00010a60: 2025 2e32 6620 6465 6720 4320 2830 7825   %.2f deg C (0x%
+00010a70: 3034 7820 7261 7729 2220 2520 2864 6567  04x raw)" % (deg
+00010a80: 432c 2072 6177 2929 0d0a 2020 2020 2020  C, raw))..      
+00010a90: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+00010aa0: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+00010ab0: 7461 3d64 6567 4329 0d0a 0d0a 2020 2020  ta=degC)....    
+00010ac0: 6465 6620 7365 745f 6465 7465 6374 6f72  def set_detector
+00010ad0: 5f74 6563 5f73 6574 706f 696e 745f 6465  _tec_setpoint_de
+00010ae0: 6743 2873 656c 662c 2064 6567 433a 2066  gC(self, degC: f
+00010af0: 6c6f 6174 293a 2023 202d 3e20 5370 6563  loat): # -> Spec
+00010b00: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00010b10: 200d 0a20 2020 2020 2020 2022 2222 0d0a   ..        """..
+00010b20: 2020 2020 2020 2020 4174 7465 6d70 7420          Attempt 
+00010b30: 746f 2073 6574 2074 6865 2043 4344 2063  to set the CCD c
+00010b40: 6f6f 6c65 7220 7365 7470 6f69 6e74 2e20  ooler setpoint. 
+00010b50: 5665 7269 6679 2074 6861 7420 6974 2069  Verify that it i
+00010b60: 7320 7769 7468 696e 2061 6e0d 0a20 2020  s within an..   
+00010b70: 2020 2020 2061 6363 6570 7461 626c 6520       acceptable 
+00010b80: 7261 6e67 652e 2049 6465 616c 6c79 2074  range. Ideally t
+00010b90: 6869 7320 6973 2074 6f20 7072 6576 656e  his is to preven
+00010ba0: 7420 636f 6e64 656e 7361 7469 6f6e 2061  t condensation a
+00010bb0: 6e64 206f 7468 6572 0d0a 2020 2020 2020  nd other..      
+00010bc0: 2020 6973 7375 6573 2e20 5468 6973 2076    issues. This v
+00010bd0: 616c 7565 2069 7320 6120 6465 6661 756c  alue is a defaul
+00010be0: 7420 616e 6420 6973 2068 7567 656c 7920  t and is hugely 
+00010bf0: 6465 7065 6e64 656e 7420 6f6e 2074 6865  dependent on the
+00010c00: 0d0a 2020 2020 2020 2020 656e 7669 726f  ..        enviro
+00010c10: 6e6d 656e 7461 6c20 636f 6e64 6974 696f  nmental conditio
+00010c20: 6e73 2e0d 0a20 2020 2020 2020 2022 2222  ns...        """
+00010c30: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00010c40: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
+00010c50: 6570 726f 6d2e 6861 735f 636f 6f6c 696e  eprom.has_coolin
+00010c60: 673a 0d0a 2020 2020 2020 2020 2020 2020  g:..            
+00010c70: 6c6f 672e 6572 726f 7228 2275 6e61 626c  log.error("unabl
+00010c80: 6520 746f 2063 6f6e 7472 6f6c 2054 4543  e to control TEC
+00010c90: 3a20 4545 5052 4f4d 2072 6570 6f72 7473  : EEPROM reports
+00010ca0: 206e 6f20 636f 6f6c 696e 6722 290d 0a20   no cooling").. 
+00010cb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00010cc0: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
+00010cd0: 7370 6f6e 7365 2864 6174 613d 4661 6c73  sponse(data=Fals
+00010ce0: 652c 2065 7272 6f72 5f6c 766c 3d45 7272  e, error_lvl=Err
+00010cf0: 6f72 4c65 7665 6c2e 6c6f 772c 2065 7272  orLevel.low, err
+00010d00: 6f72 5f6d 7367 3d22 756e 6162 6c65 2074  or_msg="unable t
+00010d10: 6f20 636f 6e74 726f 6c20 5445 433a 2045  o control TEC: E
+00010d20: 4550 524f 4d20 7265 706f 7274 7320 6e6f  EPROM reports no
+00010d30: 2063 6f6f 6c69 6e67 2229 0d0a 0d0a 2020   cooling")....  
+00010d40: 2020 2020 2020 6966 2064 6567 4320 3c20        if degC < 
+00010d50: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00010d60: 7072 6f6d 2e6d 696e 5f74 656d 705f 6465  prom.min_temp_de
+00010d70: 6743 3a0d 0a20 2020 2020 2020 2020 2020  gC:..           
+00010d80: 206c 6f67 2e63 7269 7469 6361 6c28 2273   log.critical("s
+00010d90: 6574 5f64 6574 6563 746f 725f 7465 635f  et_detector_tec_
+00010da0: 7365 7470 6f69 6e74 5f64 6567 433a 2073  setpoint_degC: s
+00010db0: 6574 706f 696e 7420 2566 2062 656c 6f77  etpoint %f below
+00010dc0: 206d 696e 2025 6622 2c20 6465 6743 2c20   min %f", degC, 
+00010dd0: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00010de0: 7072 6f6d 2e6d 696e 5f74 656d 705f 6465  prom.min_temp_de
+00010df0: 6743 290d 0a20 2020 2020 2020 2020 2020  gC)..           
+00010e00: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+00010e10: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+00010e20: 613d 4661 6c73 652c 2065 7272 6f72 5f6c  a=False, error_l
+00010e30: 766c 3d45 7272 6f72 4c65 7665 6c2e 6c6f  vl=ErrorLevel.lo
+00010e40: 772c 2065 7272 6f72 5f6d 7367 3d22 7365  w, error_msg="se
+00010e50: 7470 6f69 6e74 2062 656c 6f77 206d 696e  tpoint below min
+00010e60: 696d 756d 2229 0d0a 0d0a 2020 2020 2020  imum")....      
+00010e70: 2020 6966 2064 6567 4320 3e20 7365 6c66    if degC > self
+00010e80: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00010e90: 2e6d 6178 5f74 656d 705f 6465 6743 3a0d  .max_temp_degC:.
+00010ea0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00010eb0: 2e63 7269 7469 6361 6c28 2273 6574 5f64  .critical("set_d
+00010ec0: 6574 6563 746f 725f 7465 635f 7365 7470  etector_tec_setp
+00010ed0: 6f69 6e74 5f64 6567 433a 2073 6574 706f  oint_degC: setpo
+00010ee0: 696e 7420 2566 2065 7863 6565 6473 206d  int %f exceeds m
+00010ef0: 6178 2025 6622 2c20 6465 6743 2c20 7365  ax %f", degC, se
+00010f00: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+00010f10: 6f6d 2e6d 6178 5f74 656d 705f 6465 6743  om.max_temp_degC
+00010f20: 290d 0a20 2020 2020 2020 2020 2020 2072  )..            r
+00010f30: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+00010f40: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+00010f50: 4661 6c73 652c 2065 7272 6f72 5f6c 766c  False, error_lvl
+00010f60: 3d45 7272 6f72 4c65 7665 6c2e 6c6f 772c  =ErrorLevel.low,
+00010f70: 2065 7272 6f72 5f6d 7367 3d22 7365 7470   error_msg="setp
+00010f80: 6f69 6e74 2062 6579 6f6e 6420 6d61 7822  oint beyond max"
+00010f90: 290d 0a0d 0a20 2020 2020 2020 2072 6177  )....        raw
+00010fa0: 203d 2069 6e74 2872 6f75 6e64 2873 656c   = int(round(sel
+00010fb0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+00010fc0: 6d2e 6465 6743 5f74 6f5f 6461 635f 636f  m.degC_to_dac_co
+00010fd0: 6566 6673 5b30 5d0d 0a20 2020 2020 2020  effs[0]..       
+00010fe0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00010ff0: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
+00011000: 6570 726f 6d2e 6465 6743 5f74 6f5f 6461  eprom.degC_to_da
+00011010: 635f 636f 6566 6673 5b31 5d20 2a20 6465  c_coeffs[1] * de
+00011020: 6743 0d0a 2020 2020 2020 2020 2020 2020  gC..            
+00011030: 2020 2020 2020 2020 2020 2b20 7365 6c66            + self
+00011040: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00011050: 2e64 6567 435f 746f 5f64 6163 5f63 6f65  .degC_to_dac_coe
+00011060: 6666 735b 325d 202a 2064 6567 4320 2a20  ffs[2] * degC * 
+00011070: 6465 6743 2929 0d0a 0d0a 2020 2020 2020  degC))....      
+00011080: 2020 2320 524f 554e 4420 2864 6f6e 2774    # ROUND (don't
+00011090: 206d 6173 6b29 2074 6f20 3132 2d62 6974   mask) to 12-bit
+000110a0: 2044 4143 0d0a 2020 2020 2020 2020 7261   DAC..        ra
+000110b0: 7720 3d20 6d61 7828 302c 206d 696e 2872  w = max(0, min(r
+000110c0: 6177 2c20 3078 6666 6629 290d 0a0d 0a20  aw, 0xfff)).... 
+000110d0: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
+000110e0: 2822 5365 7420 4343 4420 5445 4320 5365  ("Set CCD TEC Se
+000110f0: 7470 6f69 6e74 3a20 252e 3266 2064 6567  tpoint: %.2f deg
+00011100: 2043 2028 7261 7720 4144 4320 3078 2530   C (raw ADC 0x%0
+00011110: 3478 2922 2c20 6465 6743 2c20 7261 7729  4x)", degC, raw)
+00011120: 0d0a 2020 2020 2020 2020 6f6b 203d 2073  ..        ok = s
+00011130: 656c 662e 5f73 656e 645f 636f 6465 2830  elf._send_code(0
+00011140: 7864 382c 2072 6177 2c20 6c61 6265 6c3d  xd8, raw, label=
+00011150: 2253 4554 5f44 4554 4543 544f 525f 5445  "SET_DETECTOR_TE
+00011160: 435f 5345 5450 4f49 4e54 2229 0d0a 2020  C_SETPOINT")..  
+00011170: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
+00011180: 6e67 732e 7374 6174 652e 7465 635f 7365  ngs.state.tec_se
+00011190: 7470 6f69 6e74 5f64 6567 4320 3d20 6465  tpoint_degC = de
+000111a0: 6743 0d0a 2020 2020 2020 2020 7365 6c66  gC..        self
+000111b0: 2e64 6574 6563 746f 725f 7465 635f 7365  .detector_tec_se
+000111c0: 7470 6f69 6e74 5f68 6173 5f62 6565 6e5f  tpoint_has_been_
+000111d0: 7365 7420 3d20 5472 7565 0d0a 2020 2020  set = True..    
+000111e0: 2020 2020 7265 7475 726e 206f 6b0d 0a0d      return ok...
+000111f0: 0a20 2020 2064 6566 2067 6574 5f64 6574  .    def get_det
+00011200: 6563 746f 725f 7465 635f 7365 7470 6f69  ector_tec_setpoi
+00011210: 6e74 5f64 6567 4328 7365 6c66 293a 2023  nt_degC(self): #
+00011220: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
+00011230: 5265 7370 6f6e 7365 200d 0a20 2020 2020  Response ..     
+00011240: 2020 2069 6620 7365 6c66 2e64 6574 6563     if self.detec
+00011250: 746f 725f 7465 635f 7365 7470 6f69 6e74  tor_tec_setpoint
+00011260: 5f68 6173 5f62 6565 6e5f 7365 743a 0d0a  _has_been_set:..
+00011270: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00011280: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+00011290: 6573 706f 6e73 6528 7365 6c66 2e73 6574  esponse(self.set
+000112a0: 7469 6e67 732e 7374 6174 652e 7465 635f  tings.state.tec_
+000112b0: 7365 7470 6f69 6e74 5f64 6567 4329 0d0a  setpoint_degC)..
+000112c0: 2020 2020 2020 2020 6c6f 672e 6572 726f          log.erro
+000112d0: 7228 2244 6574 6563 746f 7220 5445 4320  r("Detector TEC 
+000112e0: 7365 7470 6f69 6e74 2068 6173 206e 6f74  setpoint has not
+000112f0: 2079 6574 2062 6565 6e20 6170 706c 6965   yet been applie
+00011300: 6422 290d 0a20 2020 2020 2020 2072 6574  d")..        ret
+00011310: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00011320: 5265 7370 6f6e 7365 2864 6174 613d 302e  Response(data=0.
+00011330: 3029 0d0a 0d0a 2020 2020 6465 6620 6765  0)....    def ge
+00011340: 745f 6465 7465 6374 6f72 5f74 6563 5f73  t_detector_tec_s
+00011350: 6574 706f 696e 745f 7261 7728 7365 6c66  etpoint_raw(self
+00011360: 293a 2023 202d 3e20 5370 6563 7472 6f6d  ): # -> Spectrom
+00011370: 6574 6572 5265 7370 6f6e 7365 200d 0a20  eterResponse .. 
+00011380: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00011390: 6c66 2e67 6574 5f64 6163 2830 290d 0a0d  lf.get_dac(0)...
+000113a0: 0a20 2020 2064 6566 2067 6574 5f64 6163  .    def get_dac
+000113b0: 2873 656c 662c 2064 6163 496e 6465 783a  (self, dacIndex:
+000113c0: 2069 6e74 203d 2030 293a 2023 202d 3e20   int = 0): # -> 
+000113d0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+000113e0: 6f6e 7365 200d 0a20 2020 2020 2020 2072  onse ..        r
+000113f0: 6574 7572 6e20 7365 6c66 2e5f 6765 745f  eturn self._get_
+00011400: 636f 6465 2830 7864 392c 2077 496e 6465  code(0xd9, wInde
+00011410: 783d 6461 6349 6e64 6578 2c20 6c61 6265  x=dacIndex, labe
+00011420: 6c3d 2247 4554 5f44 4143 222c 206c 7362  l="GET_DAC", lsb
+00011430: 5f6c 656e 3d32 290d 0a0d 0a20 2020 2023  _len=2)....    #
+00011440: 2320 4074 6f64 6f20 7265 6e61 6d65 2073  # @todo rename s
+00011450: 6574 5f64 6574 6563 746f 725f 7465 635f  et_detector_tec_
+00011460: 656e 6162 6c65 0d0a 2020 2020 6465 6620  enable..    def 
+00011470: 7365 745f 7465 635f 656e 6162 6c65 2873  set_tec_enable(s
+00011480: 656c 662c 2066 6c61 673a 2062 6f6f 6c29  elf, flag: bool)
+00011490: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+000114a0: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+000114b0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+000114c0: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+000114d0: 6d2e 6861 735f 636f 6f6c 696e 673a 0d0a  m.has_cooling:..
+000114e0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+000114f0: 6465 6275 6728 2275 6e61 626c 6520 746f  debug("unable to
+00011500: 2063 6f6e 7472 6f6c 2054 4543 3a20 4545   control TEC: EE
+00011510: 5052 4f4d 2072 6570 6f72 7473 206e 6f20  PROM reports no 
+00011520: 636f 6f6c 696e 6722 290d 0a20 2020 2020  cooling")..     
+00011530: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
+00011540: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00011550: 7365 2864 6174 613d 4661 6c73 652c 2065  se(data=False, e
+00011560: 7272 6f72 5f6d 7367 3d22 756e 6162 6c65  rror_msg="unable
+00011570: 2074 6f20 636f 6e74 726f 6c20 5445 433a   to control TEC:
+00011580: 2045 4550 524f 4d20 7265 706f 7274 7320   EEPROM reports 
+00011590: 6e6f 2063 6f6f 6c69 6e67 2229 0d0a 0d0a  no cooling")....
+000115a0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+000115b0: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
+000115c0: 726f 6d2e 6861 735f 6465 7465 6374 6f72  rom.has_detector
+000115d0: 5f74 6563 5f63 616c 6962 7261 7469 6f6e  _tec_calibration
+000115e0: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
+000115f0: 206c 6f67 2e64 6562 7567 2822 756e 6162   log.debug("unab
+00011600: 6c65 2074 6f20 636f 6e74 726f 6c20 5445  le to control TE
+00011610: 433a 2045 4550 524f 4d20 6d69 7373 696e  C: EEPROM missin
+00011620: 6720 7661 6c69 6420 5445 4320 6361 6c69  g valid TEC cali
+00011630: 6272 6174 696f 6e22 290d 0a20 2020 2020  bration")..     
+00011640: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
+00011650: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00011660: 7365 2864 6174 613d 4661 6c73 652c 2065  se(data=False, e
+00011670: 7272 6f72 5f6d 7367 3d22 756e 6162 6c65  rror_msg="unable
+00011680: 2074 6f20 636f 6e74 726f 6c20 5445 433a   to control TEC:
+00011690: 2045 4550 524f 4d20 6d69 7373 696e 6720   EEPROM missing 
+000116a0: 7661 6c69 6420 5445 4320 6361 6c69 6272  valid TEC calibr
+000116b0: 6174 696f 6e22 290d 0a0d 0a20 2020 2020  ation")....     
+000116c0: 2020 2076 616c 7565 203d 2031 2069 6620     value = 1 if 
+000116d0: 666c 6167 2065 6c73 6520 300d 0a0d 0a20  flag else 0.... 
+000116e0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+000116f0: 6c66 2e64 6574 6563 746f 725f 7465 635f  lf.detector_tec_
+00011700: 7365 7470 6f69 6e74 5f68 6173 5f62 6565  setpoint_has_bee
+00011710: 6e5f 7365 743a 0d0a 0d0a 2020 2020 2020  n_set:....      
+00011720: 2020 2020 2020 2320 4074 6f64 6f20 7368        # @todo sh
+00011730: 6f75 6c64 2074 6869 7320 6e6f 7420 6265  ould this not be
+00011740: 2065 6570 726f 6d2e 7374 6172 7475 705f   eeprom.startup_
+00011750: 7465 6d70 5f64 6567 430d 0a20 2020 2020  temp_degC..     
+00011760: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
+00011770: 2822 6465 6661 756c 7469 6e67 2054 4543  ("defaulting TEC
+00011780: 2073 6574 706f 696e 7420 746f 206d 696e   setpoint to min
+00011790: 2025 7322 2c20 7365 6c66 2e73 6574 7469   %s", self.setti
+000117a0: 6e67 732e 6565 7072 6f6d 2e6d 696e 5f74  ngs.eeprom.min_t
+000117b0: 656d 705f 6465 6743 290d 0a20 2020 2020  emp_degC)..     
+000117c0: 2020 2020 2020 2073 656c 662e 7365 745f         self.set_
+000117d0: 6465 7465 6374 6f72 5f74 6563 5f73 6574  detector_tec_set
+000117e0: 706f 696e 745f 6465 6743 2873 656c 662e  point_degC(self.
+000117f0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+00011800: 6d69 6e5f 7465 6d70 5f64 6567 4329 0d0a  min_temp_degC)..
+00011810: 0d0a 2020 2020 2020 2020 6c6f 672e 6465  ..        log.de
+00011820: 6275 6728 2253 656e 6420 6465 7465 6374  bug("Send detect
+00011830: 6f72 2054 4543 2065 6e61 626c 653a 2025  or TEC enable: %
+00011840: 7322 2c20 7661 6c75 6529 0d0a 2020 2020  s", value)..    
+00011850: 2020 2020 6f6b 203d 2073 656c 662e 5f73      ok = self._s
+00011860: 656e 645f 636f 6465 2830 7864 362c 2076  end_code(0xd6, v
+00011870: 616c 7565 2c20 6c61 6265 6c3d 2253 4554  alue, label="SET
+00011880: 5f44 4554 4543 544f 525f 5445 435f 454e  _DETECTOR_TEC_EN
+00011890: 4142 4c45 2229 0d0a 2020 2020 2020 2020  ABLE")..        
+000118a0: 6966 206f 6b2e 6461 7461 3a0d 0a20 2020  if ok.data:..   
+000118b0: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
+000118c0: 7474 696e 6773 2e73 7461 7465 2e74 6563  ttings.state.tec
+000118d0: 5f65 6e61 626c 6564 203d 2066 6c61 670d  _enabled = flag.
+000118e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000118f0: 6f6b 0d0a 0d0a 2020 2020 6465 6620 7365  ok....    def se
+00011900: 745f 7472 6967 6765 725f 736f 7572 6365  t_trigger_source
+00011910: 2873 656c 662c 2076 616c 7565 3a20 626f  (self, value: bo
+00011920: 6f6c 293a 2023 202d 3e20 5370 6563 7472  ol): # -> Spectr
+00011930: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+00011940: 0a20 2020 2020 2020 2022 2222 0d0a 2020  .        """..  
+00011950: 2020 2020 2020 5365 7420 7468 6520 736f        Set the so
+00011960: 7572 6365 2066 6f72 2069 6e63 6f6d 696e  urce for incomin
+00011970: 6720 6163 7175 6973 6974 696f 6e20 7472  g acquisition tr
+00011980: 6967 6765 7273 2e0d 0a20 2020 2020 2020  iggers...       
+00011990: 2040 7061 7261 6d20 7661 6c75 6520 6569   @param value ei
+000119a0: 7468 6572 2030 2066 6f72 2022 696e 7465  ther 0 for "inte
+000119b0: 726e 616c 2220 6f72 2031 2066 6f72 2022  rnal" or 1 for "
+000119c0: 6578 7465 726e 616c 220d 0a20 2020 2020  external"..     
+000119d0: 2020 2057 6974 6820 696e 7465 726e 616c     With internal
+000119e0: 2074 7269 6767 6572 696e 6720 2874 6865   triggering (the
+000119f0: 2064 6566 6175 6c74 292c 2074 6865 2073   default), the s
+00011a00: 7065 6374 726f 6d65 7465 7220 6578 7065  pectrometer expe
+00011a10: 6374 7320 7468 650d 0a20 2020 2020 2020  cts the..       
+00011a20: 2055 5342 2068 6f73 7420 746f 2065 7870   USB host to exp
+00011a30: 6c69 6369 746c 7920 7365 6e64 2061 2053  licitly send a S
+00011a40: 5441 5254 5f41 4351 5549 5349 5449 4f4e  TART_ACQUISITION
+00011a50: 2028 4143 5155 4952 4529 206f 7063 6f64   (ACQUIRE) opcod
+00011a60: 6520 746f 0d0a 2020 2020 2020 2020 6265  e to..        be
+00011a70: 6769 6e20 6561 6368 2069 6e74 6567 7261  gin each integra
+00011a80: 7469 6f6e 2e20 2049 6e20 6578 7465 726e  tion.  In extern
+00011a90: 616c 2074 7269 6767 6572 696e 672c 2074  al triggering, t
+00011aa0: 6865 2073 7065 6374 726f 6d65 7465 720d  he spectrometer.
+00011ab0: 0a20 2020 2020 2020 2077 6169 7473 2066  .        waits f
+00011ac0: 6f72 2074 6865 2072 6973 696e 6720 6564  or the rising ed
+00011ad0: 6765 206f 6e20 6120 7369 676e 616c 2063  ge on a signal c
+00011ae0: 6f6e 6e65 6374 6564 2074 6f20 6120 7069  onnected to a pi
+00011af0: 6e20 6f6e 2074 6865 204f 454d 0d0a 2020  n on the OEM..  
+00011b00: 2020 2020 2020 6163 6365 7373 6f72 7920        accessory 
+00011b10: 636f 6e6e 6563 746f 722e 0d0a 2020 2020  connector...    
+00011b20: 2020 2020 5465 6368 6e69 6361 6c6c 7920      Technically 
+00011b30: 6f6e 2041 524d 2c20 7468 6520 6d69 6372  on ARM, the micr
+00011b40: 6f63 6f6e 7472 6f6c 6c65 7220 6973 2063  ocontroller is c
+00011b50: 6f6e 7469 6e75 6f75 736c 7920 6d6f 6e69  ontinuously moni
+00011b60: 746f 7269 6e67 0d0a 2020 2020 2020 2020  toring..        
+00011b70: 626f 7468 2074 6865 2065 7874 6572 6e61  both the externa
+00011b80: 6c20 7069 6e20 616e 6420 6c69 7374 656e  l pin and listen
+00011b90: 696e 6720 666f 7220 696e 7465 726e 616c  ing for internal
+00011ba0: 2073 6f66 7477 6172 6520 6f70 636f 6465   software opcode
+00011bb0: 732e 0d0a 2020 2020 2020 2020 4f6e 2074  s...        On t
+00011bc0: 6865 2046 5832 2079 6f75 206e 6565 6420  he FX2 you need 
+00011bd0: 746f 2065 7870 6c69 6369 746c 7920 706c  to explicitly pl
+00011be0: 6163 6520 7468 6520 6d69 6372 6f63 6f6e  ace the microcon
+00011bf0: 7472 6f6c 6c65 7220 696e 746f 0d0a 2020  troller into..  
+00011c00: 2020 2020 2020 6578 7465 726e 616c 2074        external t
+00011c10: 7269 6767 6572 696e 6720 6d6f 6465 2074  riggering mode t
+00011c20: 6f20 6176 6169 6c20 7468 6520 6665 6174  o avail the feat
+00011c30: 7572 652e 0d0a 2020 2020 2020 2020 2222  ure...        ""
+00011c40: 220d 0a20 2020 2020 2020 2073 656c 662e  "..        self.
+00011c50: 7365 7474 696e 6773 2e73 7461 7465 2e74  settings.state.t
+00011c60: 7269 6767 6572 5f73 6f75 7263 6520 3d20  rigger_source = 
+00011c70: 7661 6c75 650d 0a20 2020 2020 2020 206c  value..        l
+00011c80: 6f67 2e64 6562 7567 2822 7472 6967 6765  og.debug("trigge
+00011c90: 725f 736f 7572 6365 206e 6f77 2025 7322  r_source now %s"
+00011ca0: 2c20 7661 6c75 6529 0d0a 0d0a 2020 2020  , value)....    
+00011cb0: 2020 2020 2320 446f 6e27 7420 7365 6e64      # Don't send
+00011cc0: 2074 6865 206f 7063 6f64 6520 6f6e 2041   the opcode on A
+00011cd0: 524d 2e20 5365 6520 6973 7375 6520 2332  RM. See issue #2
+00011ce0: 206f 6e20 5761 7361 7463 6855 5342 2070   on WasatchUSB p
+00011cf0: 726f 6a65 6374 0d0a 2020 2020 2020 2020  roject..        
+00011d00: 6966 2073 656c 662e 7365 7474 696e 6773  if self.settings
+00011d10: 2e69 735f 6172 6d28 293a 0d0a 2020 2020  .is_arm():..    
+00011d20: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00011d30: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00011d40: 6e73 6528 6461 7461 3d46 616c 7365 290d  nse(data=False).
+00011d50: 0a0d 0a20 2020 2020 2020 206d 7362 203d  ...        msb =
+00011d60: 2030 0d0a 2020 2020 2020 2020 6c73 6220   0..        lsb 
+00011d70: 3d20 7661 6c75 650d 0a20 2020 2020 2020  = value..       
+00011d80: 2062 7566 203d 205b 305d 202a 2038 0d0a   buf = [0] * 8..
+00011d90: 0d0a 2020 2020 2020 2020 2320 4d5a 3a20  ..        # MZ: 
+00011da0: 7468 6973 2069 7320 7765 6972 642e 2e2e  this is weird...
+00011db0: 7765 2772 6520 7365 6e64 696e 6720 7468  we're sending th
+00011dc0: 6520 6275 6666 6572 206f 6e20 616e 2046  e buffer on an F
+00011dd0: 5832 2d6f 6e6c 7920 636f 6d6d 616e 640d  X2-only command.
+00011de0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00011df0: 7365 6c66 2e5f 7365 6e64 5f63 6f64 6528  self._send_code(
+00011e00: 3078 6432 2c20 6c73 622c 206d 7362 2c20  0xd2, lsb, msb, 
+00011e10: 6275 662c 206c 6162 656c 3d22 5345 545f  buf, label="SET_
+00011e20: 5452 4947 4745 525f 534f 5552 4345 2229  TRIGGER_SOURCE")
+00011e30: 0d0a 0d0a 2020 2020 2323 0d0a 2020 2020  ....    ##..    
+00011e40: 2320 4346 5f53 454c 4543 5420 6973 2063  # CF_SELECT is c
+00011e50: 6f6e 6669 6775 7265 6420 7573 696e 6720  onfigured using 
+00011e60: 6269 7420 3220 6f66 2074 6865 2046 5047  bit 2 of the FPG
+00011e70: 4120 636f 6e66 6967 7572 6174 696f 6e20  A configuration 
+00011e80: 7265 6769 7374 6572 0d0a 2020 2020 2320  register..    # 
+00011e90: 3078 3132 2e20 2054 6869 7320 6269 7420  0x12.  This bit 
+00011ea0: 6361 6e20 6265 2073 6574 2075 7369 6e67  can be set using
+00011eb0: 2076 656e 646f 7220 636f 6d6d 616e 6473   vendor commands
+00011ec0: 2030 7865 6220 746f 2053 4554 2061 6e64   0xeb to SET and
+00011ed0: 2030 7865 630d 0a20 2020 2023 2074 6f20   0xec..    # to 
+00011ee0: 4745 542e 2020 4e6f 7465 2074 6861 7420  GET.  Note that 
+00011ef0: 7468 6520 7365 7420 636f 6d6d 616e 6420  the set command 
+00011f00: 6973 2065 7870 6563 7469 6e67 2061 2035  is expecting a 5
+00011f10: 2d62 7974 6520 756e 7369 676e 6564 0d0a  -byte unsigned..
+00011f20: 2020 2020 2320 7661 6c75 652c 2074 6865      # value, the
+00011f30: 2068 6967 6865 7374 2062 7974 6520 6f66   highest byte of
+00011f40: 2077 6869 6368 2077 6520 7061 7373 2061   which we pass a
+00011f50: 7320 7061 7274 206f 6620 616e 2038 2d62  s part of an 8-b
+00011f60: 7974 6520 6275 6666 6572 2e0d 0a20 2020  yte buffer...   
+00011f70: 2023 204e 6f74 2073 7572 6520 7768 792e   # Not sure why.
+00011f80: 0d0a 2020 2020 6465 6620 7365 745f 6869  ..    def set_hi
+00011f90: 6768 5f67 6169 6e5f 6d6f 6465 5f65 6e61  gh_gain_mode_ena
+00011fa0: 626c 6528 7365 6c66 2c20 666c 6167 3a20  ble(self, flag: 
+00011fb0: 626f 6f6c 293a 2023 202d 3e20 5370 6563  bool): # -> Spec
+00011fc0: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00011fd0: 200d 0a20 2020 2020 2020 206c 6f67 2e64   ..        log.d
+00011fe0: 6562 7567 2822 5365 7420 6869 6768 2067  ebug("Set high g
+00011ff0: 6169 6e20 6d6f 6465 3a20 2573 222c 2066  ain mode: %s", f
+00012000: 6c61 6729 0d0a 2020 2020 2020 2020 6966  lag)..        if
+00012010: 206e 6f74 2073 656c 662e 7365 7474 696e   not self.settin
+00012020: 6773 2e69 735f 696e 6761 6173 2829 3a0d  gs.is_ingaas():.
+00012030: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00012040: 2e64 6562 7567 2822 5345 545f 4849 4748  .debug("SET_HIGH
+00012050: 5f47 4149 4e5f 4d4f 4445 5f45 4e41 424c  _GAIN_MODE_ENABL
+00012060: 4520 6f6e 6c79 2073 7570 706f 7274 6564  E only supported
+00012070: 206f 6e20 496e 4761 4173 2229 0d0a 2020   on InGaAs")..  
+00012080: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00012090: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+000120a0: 706f 6e73 6528 6461 7461 3d46 616c 7365  ponse(data=False
+000120b0: 2c65 7272 6f72 5f6d 7367 3d22 4869 6768  ,error_msg="High
+000120c0: 2047 6169 6e20 6e6f 7420 7375 7070 6f72   Gain not suppor
+000120d0: 7420 6f6e 2074 6869 7320 7370 6563 7472  t on this spectr
+000120e0: 6f6d 6574 6572 2229 0d0a 0d0a 2020 2020  ometer")....    
+000120f0: 2020 2020 7661 6c75 6520 3d20 3120 6966      value = 1 if
+00012100: 2066 6c61 6720 656c 7365 2030 0d0a 0d0a   flag else 0....
+00012110: 2020 2020 2020 2020 2320 7468 6973 2069          # this i
+00012120: 7320 646f 6e65 2061 7574 6f6d 6174 6963  s done automatic
+00012130: 616c 6c79 206f 6e20 4152 4d2c 2062 7574  ally on ARM, but
+00012140: 2066 6f72 2074 6869 7320 6f70 636f 6465   for this opcode
+00012150: 2077 6520 646f 2069 7420 6f6e 2046 5832   we do it on FX2
+00012160: 2061 7320 7765 6c6c 0d0a 2020 2020 2020   as well..      
+00012170: 2020 6275 6620 3d20 5b30 5d20 2a20 380d    buf = [0] * 8.
+00012180: 0a0d 0a20 2020 2020 2020 2073 656c 662e  ...        self.
+00012190: 7365 7474 696e 6773 2e73 7461 7465 2e68  settings.state.h
+000121a0: 6967 685f 6761 696e 5f6d 6f64 655f 656e  igh_gain_mode_en
+000121b0: 6162 6c65 6420 3d20 666c 6167 0d0a 2020  abled = flag..  
+000121c0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000121d0: 662e 5f73 656e 645f 636f 6465 2830 7865  f._send_code(0xe
+000121e0: 622c 2077 5661 6c75 653d 7661 6c75 652c  b, wValue=value,
+000121f0: 2077 496e 6465 783d 302c 2064 6174 615f   wIndex=0, data_
+00012200: 6f72 5f77 4c65 6e67 7468 3d62 7566 2c20  or_wLength=buf, 
+00012210: 6c61 6265 6c3d 2253 4554 5f48 4947 485f  label="SET_HIGH_
+00012220: 4741 494e 5f4d 4f44 455f 454e 4142 4c45  GAIN_MODE_ENABLE
+00012230: 2229 0d0a 0d0a 2020 2020 6465 6620 6765  ")....    def ge
+00012240: 745f 6869 6768 5f67 6169 6e5f 6d6f 6465  t_high_gain_mode
+00012250: 5f65 6e61 626c 6564 2873 656c 6629 3a20  _enabled(self): 
+00012260: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+00012270: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+00012280: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00012290: 7365 7474 696e 6773 2e69 735f 696e 6761  settings.is_inga
+000122a0: 6173 2829 3a0d 0a20 2020 2020 2020 2020  as():..         
+000122b0: 2020 206c 6f67 2e64 6562 7567 2822 4745     log.debug("GE
+000122c0: 545f 4849 4748 5f47 4149 4e5f 4d4f 4445  T_HIGH_GAIN_MODE
+000122d0: 5f45 4e41 424c 4520 6f6e 6c79 2073 7570  _ENABLE only sup
+000122e0: 706f 7274 6564 206f 6e20 496e 4761 4173  ported on InGaAs
+000122f0: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+00012300: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+00012310: 7465 7252 6573 706f 6e73 6528 7365 6c66  terResponse(self
+00012320: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00012330: 2e68 6967 685f 6761 696e 5f6d 6f64 655f  .high_gain_mode_
+00012340: 656e 6162 6c65 6429 0d0a 0d0a 2020 2020  enabled)....    
+00012350: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
+00012360: 732e 7374 6174 652e 6869 6768 5f67 6169  s.state.high_gai
+00012370: 6e5f 6d6f 6465 5f65 6e61 626c 6564 203d  n_mode_enabled =
+00012380: 2030 2021 3d20 7365 6c66 2e5f 6765 745f   0 != self._get_
+00012390: 636f 6465 2830 7865 632c 206c 7362 5f6c  code(0xec, lsb_l
+000123a0: 656e 3d31 2c20 6c61 6265 6c3d 2247 4554  en=1, label="GET
+000123b0: 5f48 4947 485f 4741 494e 5f4d 4f44 455f  _HIGH_GAIN_MODE_
+000123c0: 454e 4142 4c45 4422 290d 0a20 2020 2020  ENABLED")..     
+000123d0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+000123e0: 6f6d 6574 6572 5265 7370 6f6e 7365 2873  ometerResponse(s
+000123f0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+00012400: 7465 2e68 6967 685f 6761 696e 5f6d 6f64  te.high_gain_mod
+00012410: 655f 656e 6162 6c65 6429 0d0a 0d0a 2020  e_enabled)....  
+00012420: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+00012430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00012440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00012450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00012460: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+00012470: 2020 2020 2320 4c61 7365 7220 636f 6d6d      # Laser comm
+00012480: 616e 6473 0d0a 2020 2020 2323 2323 2323  ands..    ######
+00012490: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000124a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000124b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000124c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000124d0: 2323 2323 2323 0d0a 0d0a 2020 2020 6465  ######....    de
+000124e0: 6620 6765 745f 6f70 745f 6c61 7365 725f  f get_opt_laser_
+000124f0: 636f 6e74 726f 6c28 7365 6c66 293a 2023  control(self): #
+00012500: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
+00012510: 5265 7370 6f6e 7365 200d 0a20 2020 2020  Response ..     
+00012520: 2020 2072 6574 7572 6e20 7365 6c66 2e67     return self.g
+00012530: 6574 5f75 7070 6572 5f63 6f64 6528 3078  et_upper_code(0x
+00012540: 3039 2c20 6c61 6265 6c3d 2247 4554 5f4f  09, label="GET_O
+00012550: 5054 5f4c 4153 4552 5f43 4f4e 5452 4f4c  PT_LASER_CONTROL
+00012560: 222c 206d 7362 5f6c 656e 3d31 290d 0a0d  ", msb_len=1)...
+00012570: 0a20 2020 2064 6566 2067 6574 5f6f 7074  .    def get_opt
+00012580: 5f68 6173 5f6c 6173 6572 2873 656c 6629  _has_laser(self)
+00012590: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+000125a0: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+000125b0: 2020 2020 2020 6176 6169 6c61 626c 6520        available 
+000125c0: 3d20 2830 2021 3d20 7365 6c66 2e67 6574  = (0 != self.get
+000125d0: 5f75 7070 6572 5f63 6f64 6528 3078 3038  _upper_code(0x08
+000125e0: 2c20 6c61 6265 6c3d 2247 4554 5f4f 5054  , label="GET_OPT
+000125f0: 5f48 4153 5f4c 4153 4552 222c 206d 7362  _HAS_LASER", msb
+00012600: 5f6c 656e 3d31 292e 6461 7461 290d 0a20  _len=1).data).. 
+00012610: 2020 2020 2020 2069 6620 6176 6169 6c61         if availa
+00012620: 626c 6520 213d 2073 656c 662e 7365 7474  ble != self.sett
+00012630: 696e 6773 2e65 6570 726f 6d2e 6861 735f  ings.eeprom.has_
+00012640: 6c61 7365 723a 0d0a 2020 2020 2020 2020  laser:..        
+00012650: 2020 2020 6c6f 672e 6572 726f 7228 224f      log.error("O
+00012660: 5054 5f48 4153 5f4c 4153 4552 206f 7063  PT_HAS_LASER opc
+00012670: 6f64 6520 7265 7375 6c74 2025 7320 213d  ode result %s !=
+00012680: 2045 4550 524f 4d20 6861 735f 6c61 7365   EEPROM has_lase
+00012690: 7220 2573 2028 7573 696e 6720 6f70 636f  r %s (using opco
+000126a0: 6465 2922 2c0d 0a20 2020 2020 2020 2020  de)",..         
+000126b0: 2020 2020 2020 2076 616c 7565 2c20 7365         value, se
+000126c0: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+000126d0: 6f6d 2e68 6173 5f6c 6173 6572 290d 0a20  om.has_laser).. 
+000126e0: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
+000126f0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00012700: 7365 2864 6174 613d 6176 6169 6c61 626c  se(data=availabl
+00012710: 6529 0d0a 0d0a 2020 2020 2323 2040 6e6f  e)....    ## @no
+00012720: 7465 206c 6974 746c 652d 656e 6469 616e  te little-endian
+00012730: 2c20 7265 7665 7273 6520 6f66 2067 6574  , reverse of get
+00012740: 5f64 6574 6563 746f 725f 7465 6d70 6572  _detector_temper
+00012750: 6174 7572 655f 7261 770d 0a20 2020 2064  ature_raw..    d
+00012760: 6566 2067 6574 5f6c 6173 6572 5f74 656d  ef get_laser_tem
+00012770: 7065 7261 7475 7265 5f72 6177 2873 656c  perature_raw(sel
+00012780: 6629 3a20 2320 2d3e 2053 7065 6374 726f  f): # -> Spectro
+00012790: 6d65 7465 7252 6573 706f 6e73 6520 0d0a  meterResponse ..
+000127a0: 2020 2020 2020 2020 2320 666c 6970 2074          # flip t
+000127b0: 6f20 7072 696d 6172 7920 4144 4320 6966  o primary ADC if
+000127c0: 206e 6565 6465 640d 0a20 2020 2020 2020   needed..       
+000127d0: 2069 6620 7365 6c66 2e73 6574 7469 6e67   if self.setting
+000127e0: 732e 7374 6174 652e 7365 6c65 6374 6564  s.state.selected
+000127f0: 5f61 6463 2069 7320 4e6f 6e65 206f 7220  _adc is None or 
+00012800: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
+00012810: 6174 652e 7365 6c65 6374 6564 5f61 6463  ate.selected_adc
+00012820: 2021 3d20 303a 0d0a 2020 2020 2020 2020   != 0:..        
+00012830: 2020 2020 7365 6c66 2e73 656c 6563 745f      self.select_
+00012840: 6164 6328 3029 0d0a 0d0a 2020 2020 2020  adc(0)....      
+00012850: 2020 7265 7375 6c74 203d 2073 656c 662e    result = self.
+00012860: 5f67 6574 5f63 6f64 6528 3078 6435 2c20  _get_code(0xd5, 
+00012870: 774c 656e 6774 683d 322c 206c 6162 656c  wLength=2, label
+00012880: 3d22 4745 545f 4144 4322 2c20 6c73 625f  ="GET_ADC", lsb_
+00012890: 6c65 6e3d 3229 0d0a 2020 2020 2020 2020  len=2)..        
+000128a0: 6966 206e 6f74 2072 6573 756c 742e 6461  if not result.da
+000128b0: 7461 3a0d 0a20 2020 2020 2020 2020 2020  ta:..           
+000128c0: 206c 6f67 2e64 6562 7567 2822 556e 6162   log.debug("Unab
+000128d0: 6c65 2074 6f20 7265 6164 206c 6173 6572  le to read laser
+000128e0: 2074 656d 7065 7261 7475 7265 2229 0d0a   temperature")..
+000128f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012900: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+00012910: 6573 706f 6e73 6528 3029 0d0a 2020 2020  esponse(0)..    
+00012920: 2020 2020 7265 7375 6c74 2e64 6174 6120      result.data 
+00012930: 3d20 7265 7375 6c74 2e64 6174 6120 2620  = result.data & 
+00012940: 3078 6666 660d 0a20 2020 2020 2020 2072  0xfff..        r
+00012950: 6574 7572 6e20 7265 7375 6c74 0d0a 0d0a  eturn result....
+00012960: 2020 2020 6465 6620 7365 745f 7365 6c65      def set_sele
+00012970: 6374 6564 5f6c 6173 6572 2873 656c 662c  cted_laser(self,
+00012980: 2076 616c 7565 3a20 696e 7429 3a20 2320   value: int): # 
+00012990: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+000129a0: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+000129b0: 2020 2222 220d 0a20 2020 2020 2020 204f    """..        O
+000129c0: 6e20 7370 6563 7472 6f6d 6574 6572 7320  n spectrometers 
+000129d0: 7375 7070 6f72 7469 6e67 2074 776f 206c  supporting two l
+000129e0: 6173 6572 732c 2073 656c 6563 7420 7468  asers, select th
+000129f0: 6520 7072 696d 6172 7920 2830 2920 6f72  e primary (0) or
+00012a00: 0d0a 2020 2020 2020 2020 7365 636f 6e64  ..        second
+00012a10: 6172 7920 2831 292e 2020 4c61 7365 7220  ary (1).  Laser 
+00012a20: 456e 6162 6c65 2c20 6c61 7365 7220 706f  Enable, laser po
+00012a30: 7765 7220 6574 6320 7368 6f75 6c64 2061  wer etc should a
+00012a40: 6c6c 2074 6865 6e0d 0a20 2020 2020 2020  ll then..       
+00012a50: 2061 6666 6563 7420 7468 6520 6375 7272   affect the curr
+00012a60: 656e 746c 792d 7365 6c65 6374 6564 206c  ently-selected l
+00012a70: 6173 6572 2e0d 0a20 2020 2020 2020 2040  aser...        @
+00012a80: 7761 726e 696e 6720 636f 6e66 6c69 6374  warning conflict
+00012a90: 7320 7769 7468 2047 4554 5f52 414d 414e  s with GET_RAMAN
+00012aa0: 5f4d 4f44 455f 454e 4142 4c45 0d0a 2020  _MODE_ENABLE..  
+00012ab0: 2020 2020 2020 2222 220d 0a20 2020 2020        """..     
+00012ac0: 2020 206e 203d 2031 2069 6620 7661 6c75     n = 1 if valu
+00012ad0: 6520 656c 7365 2030 0d0a 0d0a 2020 2020  e else 0....    
+00012ae0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00012af0: 7365 7474 696e 6773 2e65 6570 726f 6d2e  settings.eeprom.
+00012b00: 6861 735f 6c61 7365 723a 0d0a 2020 2020  has_laser:..    
+00012b10: 2020 2020 2020 2020 6c6f 672e 6572 726f          log.erro
+00012b20: 7228 2275 6e61 626c 6520 746f 2063 6f6e  r("unable to con
+00012b30: 7472 6f6c 206c 6173 6572 3a20 4545 5052  trol laser: EEPR
+00012b40: 4f4d 2072 6570 6f72 7473 206e 6f20 6c61  OM reports no la
+00012b50: 7365 7220 696e 7374 616c 6c65 6422 290d  ser installed").
+00012b60: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00012b70: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00012b80: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
+00012b90: 6c73 652c 6572 726f 725f 6d73 673d 224e  lse,error_msg="N
+00012ba0: 6f20 6c61 7365 7220 696e 7374 616c 6c65  o laser installe
+00012bb0: 7222 290d 0a0d 0a20 2020 2020 2020 206c  r")....        l
+00012bc0: 6f67 2e64 6562 7567 2822 7365 6c65 6374  og.debug("select
+00012bd0: 696e 6720 6c61 7365 7220 2564 222c 206e  ing laser %d", n
+00012be0: 290d 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00012bf0: 7365 7474 696e 6773 2e73 7461 7465 2e73  settings.state.s
+00012c00: 656c 6563 7465 645f 6c61 7365 7220 3d20  elected_laser = 
+00012c10: 6e0d 0a0d 0a20 2020 2020 2020 2072 6574  n....        ret
+00012c20: 7572 6e20 7365 6c66 2e5f 7365 6e64 5f63  urn self._send_c
+00012c30: 6f64 6528 6252 6571 7565 7374 2020 2020  ode(bRequest    
+00012c40: 2020 2020 3d20 3078 6666 2c0d 0a20 2020      = 0xff,..   
+00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c60: 2020 2020 2020 2020 2020 2077 5661 6c75             wValu
+00012c70: 6520 2020 2020 2020 2020 203d 2030 7831  e          = 0x1
+00012c80: 352c 0d0a 2020 2020 2020 2020 2020 2020  5,..            
+00012c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ca0: 2020 7749 6e64 6578 2020 2020 2020 2020    wIndex        
+00012cb0: 2020 3d20 6e2c 0d0a 2020 2020 2020 2020    = n,..        
+00012cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cd0: 2020 2020 2020 6461 7461 5f6f 725f 774c        data_or_wL
+00012ce0: 656e 6774 6820 3d20 5b30 5d20 2a20 382c  ength = [0] * 8,
+00012cf0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d10: 6c61 6265 6c20 2020 2020 2020 2020 2020  label           
+00012d20: 3d20 2253 4554 5f53 454c 4543 5445 445f  = "SET_SELECTED_
+00012d30: 4c41 5345 5222 290d 0a0d 0a20 2020 2064  LASER")....    d
+00012d40: 6566 2067 6574 5f73 656c 6563 7465 645f  ef get_selected_
+00012d50: 6c61 7365 7228 7365 6c66 293a 2023 202d  laser(self): # -
+00012d60: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+00012d70: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+00012d80: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+00012d90: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+00012da0: 613d 7365 6c66 2e73 6574 7469 6e67 732e  a=self.settings.
+00012db0: 7374 6174 652e 7365 6c65 6374 6564 5f6c  state.selected_l
+00012dc0: 6173 6572 290d 0a0d 0a20 2020 2064 6566  aser)....    def
+00012dd0: 2067 6574 5f6c 6173 6572 5f65 6e61 626c   get_laser_enabl
+00012de0: 6564 2873 656c 6629 3a20 2320 2d3e 2053  ed(self): # -> S
+00012df0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00012e00: 6e73 6520 0d0a 2020 2020 2020 2020 666c  nse ..        fl
+00012e10: 6167 203d 2030 2021 3d20 7365 6c66 2e5f  ag = 0 != self._
+00012e20: 6765 745f 636f 6465 2830 7865 322c 206c  get_code(0xe2, l
+00012e30: 6162 656c 3d22 4745 545f 4c41 5345 525f  abel="GET_LASER_
+00012e40: 454e 4142 4c45 4422 2c20 6d73 625f 6c65  ENABLED", msb_le
+00012e50: 6e3d 3129 2e64 6174 610d 0a20 2020 2020  n=1).data..     
+00012e60: 2020 206c 6f67 2e64 6562 7567 2822 6765     log.debug("ge
+00012e70: 745f 6c61 7365 725f 656e 6162 6c65 643a  t_laser_enabled:
+00012e80: 2025 7322 2c20 666c 6167 290d 0a20 2020   %s", flag)..   
+00012e90: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
+00012ea0: 6773 2e73 7461 7465 2e6c 6173 6572 5f65  gs.state.laser_e
+00012eb0: 6e61 626c 6564 203d 2066 6c61 670d 0a20  nabled = flag.. 
+00012ec0: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
+00012ed0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00012ee0: 7365 2864 6174 613d 666c 6167 290d 0a0d  se(data=flag)...
+00012ef0: 0a20 2020 2064 6566 2073 6574 5f6c 6173  .    def set_las
+00012f00: 6572 5f65 6e61 626c 6528 7365 6c66 2c20  er_enable(self, 
+00012f10: 666c 6167 3a20 626f 6f6c 293a 2023 202d  flag: bool): # -
+00012f20: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+00012f30: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+00012f40: 2022 2222 0d0a 2020 2020 2020 2020 5475   """..        Tu
+00012f50: 726e 2074 6865 206c 6173 6572 206f 6e20  rn the laser on 
+00012f60: 6f72 206f 6666 2e0d 0a20 2020 2020 2020  or off...       
+00012f70: 2049 6620 6c61 7365 7220 706f 7765 7220   If laser power 
+00012f80: 6861 736e 2774 2079 6574 2062 6565 6e20  hasn't yet been 
+00012f90: 6578 7465 726e 616c 6c79 2063 6f6e 6669  externally confi
+00012fa0: 6775 7265 642c 2061 7070 6c69 6573 2074  gured, applies t
+00012fb0: 6865 2064 6566 6175 6c74 0d0a 2020 2020  he default..    
+00012fc0: 2020 2020 6f66 2066 756c 6c2d 706f 7765      of full-powe
+00012fd0: 722e 2020 5468 6520 6e65 7720 7374 6174  r.  The new stat
+00012fe0: 6520 7769 6c6c 2062 6520 6170 706c 6965  e will be applie
+00012ff0: 6420 696d 6d65 6469 6174 656c 792e 0d0a  d immediately...
+00013000: 2020 2020 2020 2020 4070 6172 616d 2066          @param f
+00013010: 6c61 6720 2849 6e70 7574 2920 626f 6f6c  lag (Input) bool
+00013020: 2028 5472 7565 2074 7572 6e73 206c 6173   (True turns las
+00013030: 6572 206f 6e2c 2046 616c 7365 2074 7572  er on, False tur
+00013040: 6e73 206c 6173 6572 206f 6666 290d 0a20  ns laser off).. 
+00013050: 2020 2020 2020 2040 7265 7475 726e 7320         @returns 
+00013060: 7768 6574 6865 7220 7468 6520 6e65 7720  whether the new 
+00013070: 7374 6174 6520 7761 7320 6170 706c 6965  state was applie
+00013080: 640d 0a20 2020 2020 2020 2022 2222 0d0a  d..        """..
+00013090: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+000130a0: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
+000130b0: 726f 6d2e 6861 735f 6c61 7365 723a 0d0a  rom.has_laser:..
+000130c0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+000130d0: 6572 726f 7228 2275 6e61 626c 6520 746f  error("unable to
+000130e0: 2063 6f6e 7472 6f6c 206c 6173 6572 3a20   control laser: 
+000130f0: 4545 5052 4f4d 2072 6570 6f72 7473 206e  EEPROM reports n
+00013100: 6f20 6c61 7365 7220 696e 7374 616c 6c65  o laser installe
+00013110: 6422 290d 0a20 2020 2020 2020 2020 2020  d")..           
+00013120: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+00013130: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+00013140: 613d 4661 6c73 652c 2065 7272 6f72 5f6d  a=False, error_m
+00013150: 7367 3d22 6e6f 206c 6173 6572 2069 6e73  sg="no laser ins
+00013160: 7461 6c6c 6564 2229 0d0a 0d0a 2020 2020  talled")....    
+00013170: 2020 2020 2320 4152 4d20 7365 656d 7320      # ARM seems 
+00013180: 746f 2072 6571 7569 7265 2074 6861 7420  to require that 
+00013190: 6c61 7365 7220 706f 7765 7220 6265 2073  laser power be s
+000131a0: 6574 2062 6566 6f72 6520 7468 6520 6c61  et before the la
+000131b0: 7365 7220 6973 2065 6e61 626c 6564 0d0a  ser is enabled..
+000131c0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000131d0: 6e65 7874 5f61 7070 6c69 6564 5f6c 6173  next_applied_las
+000131e0: 6572 5f70 6f77 6572 2069 7320 4e6f 6e65  er_power is None
+000131f0: 3a0d 0a20 2020 2020 2020 2020 2020 2073  :..            s
+00013200: 656c 662e 7365 745f 6c61 7365 725f 706f  elf.set_laser_po
+00013210: 7765 725f 7065 7263 2831 3030 2e30 290d  wer_perc(100.0).
+00013220: 0a0d 0a20 2020 2020 2020 2073 656c 662e  ...        self.
+00013230: 7365 7474 696e 6773 2e73 7461 7465 2e6c  settings.state.l
+00013240: 6173 6572 5f65 6e61 626c 6564 203d 2066  aser_enabled = f
+00013250: 6c61 670d 0a20 2020 2020 2020 2073 656c  lag..        sel
+00013260: 662e 5f73 6574 5f6c 6173 6572 5f65 6e61  f._set_laser_ena
+00013270: 626c 655f 696d 6d65 6469 6174 6528 666c  ble_immediate(fl
+00013280: 6167 290d 0a20 2020 2020 2020 2072 6574  ag)..        ret
+00013290: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+000132a0: 5265 7370 6f6e 7365 2864 6174 613d 5472  Response(data=Tr
+000132b0: 7565 290d 0a0d 0a20 2020 2064 6566 2073  ue)....    def s
+000132c0: 6574 5f6c 6173 6572 5f70 6f77 6572 5f72  et_laser_power_r
+000132d0: 616d 7069 6e67 5f65 6e61 626c 6528 7365  amping_enable(se
+000132e0: 6c66 2c20 666c 6167 3a20 626f 6f6c 293a  lf, flag: bool):
+000132f0: 2023 202d 3e20 5370 6563 7472 6f6d 6574   # -> Spectromet
+00013300: 6572 5265 7370 6f6e 7365 200d 0a20 2020  erResponse ..   
+00013310: 2020 2020 206c 6f67 2e65 7272 6f72 2822       log.error("
+00013320: 6c61 7365 7220 706f 7765 7220 7261 6d70  laser power ramp
+00013330: 696e 6720 6861 7320 6265 656e 2064 6570  ing has been dep
+00013340: 7265 6361 7465 6422 290d 0a20 2020 2020  recated")..     
+00013350: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+00013360: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+00013370: 6174 613d 4661 6c73 6529 0d0a 0d0a 2020  ata=False)....  
+00013380: 2020 6465 6620 6765 745f 6c61 7365 725f    def get_laser_
+00013390: 706f 7765 725f 7261 6d70 696e 675f 656e  power_ramping_en
+000133a0: 6162 6c65 6428 7365 6c66 293a 2023 202d  abled(self): # -
+000133b0: 3e20 626f 6f6c 200d 0a20 2020 2020 2020  > bool ..       
+000133c0: 2072 6574 7572 6e20 4661 6c73 650d 0a0d   return False...
+000133d0: 0a20 2020 2064 6566 205f 7365 745f 6c61  .    def _set_la
+000133e0: 7365 725f 656e 6162 6c65 5f69 6d6d 6564  ser_enable_immed
+000133f0: 6961 7465 2873 656c 662c 2066 6c61 673a  iate(self, flag:
+00013400: 2062 6f6f 6c29 3a20 2320 2d3e 2053 7065   bool): # -> Spe
+00013410: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+00013420: 6520 0d0a 2020 2020 2020 2020 2222 220d  e ..        """.
+00013430: 0a20 2020 2020 2020 2054 6865 2075 7365  .        The use
+00013440: 7220 6861 7320 7265 7175 6573 7465 6420  r has requested 
+00013450: 746f 2075 7064 6174 6520 7468 6520 6c61  to update the la
+00013460: 7365 7220 6669 7269 6e67 2073 7461 7465  ser firing state
+00013470: 2028 6f6e 206f 7220 6f66 6629 2c0d 0a20   (on or off),.. 
+00013480: 2020 2020 2020 2073 6f20 6170 706c 7920         so apply 
+00013490: 7468 6520 6e65 7720 6c61 7365 7220 7374  the new laser st
+000134a0: 6174 6520 746f 2074 6865 2073 7065 6374  ate to the spect
+000134b0: 726f 6d65 7465 7220 696d 6d65 6469 6174  rometer immediat
+000134c0: 656c 792e 0d0a 0d0a 2020 2020 2020 2020  ely.....        
+000134d0: 4265 6361 7573 6520 7468 6520 6162 696c  Because the abil
+000134e0: 6974 7920 746f 2069 6d6d 6564 6961 7465  ity to immediate
+000134f0: 6c79 2064 6973 6162 6c65 2061 206c 6173  ly disable a las
+00013500: 6572 2069 7320 6120 7361 6665 7479 2d72  er is a safety-r
+00013510: 656c 6174 6564 0d0a 2020 2020 2020 2020  elated..        
+00013520: 6665 6174 7572 6520 286e 6f74 696e 6720  feature (noting 
+00013530: 7468 6174 2074 7275 6c79 2073 6166 6574  that truly safet
+00013540: 792d 6372 6974 6963 616c 2063 6170 6162  y-critical capab
+00013550: 696c 6974 6965 7320 7368 6f75 6c64 2062  ilities should b
+00013560: 650d 0a20 2020 2020 2020 2069 6d70 6c65  e..        imple
+00013570: 6d65 6e74 6564 2069 6e20 6861 7264 7761  mented in hardwa
+00013580: 7265 2c20 616e 6420 6765 6e65 7261 6c6c  re, and generall
+00013590: 7920 6361 6e27 7420 6265 2072 6f62 7573  y can't be robus
+000135a0: 746c 7920 6163 6869 6576 6564 2074 6872  tly achieved thr
+000135b0: 6f75 6768 0d0a 2020 2020 2020 2020 5079  ough..        Py
+000135c0: 7468 6f6e 2073 6372 6970 7473 292c 2074  thon scripts), t
+000135d0: 6869 7320 6675 6e63 7469 6f6e 2074 616b  his function tak
+000135e0: 6573 2074 6865 2075 6e75 7375 616c 2073  es the unusual s
+000135f0: 7465 7020 6f66 206c 6f6f 7069 6e67 206f  tep of looping o
+00013600: 7665 720d 0a20 2020 2020 2020 206d 756c  ver..        mul
+00013610: 7469 706c 6520 6174 7465 6d70 7473 2074  tiple attempts t
+00013620: 6f20 7365 7420 7468 6520 6c61 7365 7220  o set the laser 
+00013630: 7374 6174 6520 756e 7469 6c20 6569 7468  state until eith
+00013640: 6572 2074 6865 2063 6f6d 6d61 6e64 2073  er the command s
+00013650: 7563 6365 6564 732c 0d0a 2020 2020 2020  ucceeds,..      
+00013660: 2020 6f72 2033 2063 6f6e 7365 6375 7469    or 3 consecuti
+00013670: 7665 2066 6169 6c75 7265 7320 6861 7665  ve failures have
+00013680: 206f 6363 7572 6564 2e0d 0a0d 0a20 2020   occured.....   
+00013690: 2020 2020 2054 6869 7320 6265 6861 7669       This behavi
+000136a0: 6f72 2077 6173 2061 6464 6564 2061 6674  or was added aft
+000136b0: 6572 2061 2064 6576 656c 6f70 6d65 6e74  er a development
+000136c0: 616c 2c20 756e 7265 6c65 6173 6564 2070  al, unreleased p
+000136d0: 726f 746f 7479 7065 2077 6173 0d0a 2020  rototype was..  
+000136e0: 2020 2020 2020 666f 756e 6420 746f 206f        found to o
+000136f0: 6363 6173 696f 6e61 6c6c 7920 6472 6f70  ccasionally drop
+00013700: 2055 5342 2070 6163 6b65 7473 2c20 616e   USB packets, an
+00013710: 6420 7761 7320 7468 6572 6566 6f72 6520  d was therefore 
+00013720: 7375 7363 6570 7469 626c 6520 746f 0d0a  susceptible to..
+00013730: 2020 2020 2020 2020 696e 6164 7665 7274          inadvert
+00013740: 656e 746c 7920 6661 696c 696e 6720 746f  ently failing to
+00013750: 2064 6973 6162 6c65 2074 6865 206c 6173   disable the las
+00013760: 6572 2075 706f 6e20 636f 6d6d 616e 642e  er upon command.
+00013770: 0d0a 0d0a 2020 2020 2020 2020 4070 7269  ....        @pri
+00013780: 7661 7465 2028 6173 2063 616c 6c65 7273  vate (as callers
+00013790: 2061 7265 2072 6563 6f6d 6d65 6e64 6564   are recommended
+000137a0: 2074 6f20 7573 6520 7365 745f 6c61 7365   to use set_lase
+000137b0: 725f 656e 6162 6c65 290d 0a20 2020 2020  r_enable)..     
+000137c0: 2020 2040 7061 7261 6d20 666c 6167 2028     @param flag (
+000137d0: 496e 7075 7429 2077 6865 7468 6572 2074  Input) whether t
+000137e0: 6865 206c 6173 6572 2073 686f 756c 6420  he laser should 
+000137f0: 6265 206f 6e20 2874 7275 6529 206f 7220  be on (true) or 
+00013800: 6f66 6620 2866 616c 7365 290d 0a20 2020  off (false)..   
+00013810: 2020 2020 2040 7265 7475 726e 7320 7472       @returns tr
+00013820: 7565 2069 6620 6e65 7720 7374 6174 6520  ue if new state 
+00013830: 7761 7320 7375 6363 6573 7366 756c 6c79  was successfully
+00013840: 2061 7070 6c69 6564 0d0a 2020 2020 2020   applied..      
+00013850: 2020 2222 220d 0a20 2020 2020 2020 206c    """..        l
+00013860: 6f67 2e64 6562 7567 2822 5365 6e64 206c  og.debug("Send l
+00013870: 6173 6572 2065 6e61 626c 653a 2025 7322  aser enable: %s"
+00013880: 2c20 666c 6167 290d 0a20 2020 2020 2020  , flag)..       
+00013890: 2069 6620 666c 6167 3a0d 0a20 2020 2020   if flag:..     
+000138a0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+000138b0: 5f61 7070 6c69 6564 5f6c 6173 6572 5f70  _applied_laser_p
+000138c0: 6f77 6572 203d 2030 2e30 0d0a 2020 2020  ower = 0.0..    
+000138d0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+000138e0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+000138f0: 5f61 7070 6c69 6564 5f6c 6173 6572 5f70  _applied_laser_p
+00013900: 6f77 6572 203d 2073 656c 662e 6e65 7874  ower = self.next
+00013910: 5f61 7070 6c69 6564 5f6c 6173 6572 5f70  _applied_laser_p
+00013920: 6f77 6572 0d0a 0d0a 2020 2020 2020 2020  ower....        
+00013930: 7365 6c66 2e73 6574 5f73 7472 6f62 655f  self.set_strobe_
+00013940: 656e 6162 6c65 2866 6c61 6729 0d0a 0d0a  enable(flag)....
+00013950: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00013960: 7365 7474 696e 6773 2e69 735f 7873 2829  settings.is_xs()
+00013970: 3a0d 0a20 2020 2020 2020 2020 2020 2023  :..            #
+00013980: 2053 6572 6965 732d 5853 2067 6574 4c61   Series-XS getLa
+00013990: 7365 7245 6e61 626c 6520 646f 6573 6e27  serEnable doesn'
+000139a0: 7420 7072 6f76 6964 6520 696d 6d65 6469  t provide immedi
+000139b0: 6174 6520 636f 6e66 6972 6d61 7469 6f6e  ate confirmation
+000139c0: 200d 0a20 2020 2020 2020 2020 2020 2023   ..            #
+000139d0: 2062 6563 6175 7365 2069 7427 7320 636f   because it's co
+000139e0: 6d69 6e67 6c65 6420 7769 7468 206c 6173  mingled with las
+000139f0: 6572 5761 7463 6864 6f67 5365 6320 616e  erWatchdogSec an
+00013a00: 6420 7072 6f62 6162 6c79 200d 0a20 2020  d probably ..   
+00013a10: 2020 2020 2020 2020 2023 206c 6173 6572           # laser
+00013a20: 4465 6c61 7953 6563 0d0a 2020 2020 2020  DelaySec..      
+00013a30: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
+00013a40: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+00013a50: 6528 6461 7461 3d54 7275 6529 0d0a 0d0a  e(data=True)....
+00013a60: 2020 2020 2020 2020 2320 7472 7920 746f          # try to
+00013a70: 2076 6572 6966 7920 6c61 7365 7245 6e61   verify laserEna
+00013a80: 626c 6520 776f 726b 6564 0d0a 2020 2020  ble worked..    
+00013a90: 2020 2020 7472 6965 7320 3d20 300d 0a20      tries = 0.. 
+00013aa0: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
+00013ab0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00013ac0: 7265 7320 3d20 7365 6c66 2e67 6574 5f6c  res = self.get_l
+00013ad0: 6173 6572 5f65 6e61 626c 6564 2829 0d0a  aser_enabled()..
+00013ae0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00013af0: 6c61 6720 3d3d 2072 6573 2e64 6174 613a  lag == res.data:
+00013b00: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00013b10: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+00013b20: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+00013b30: 7461 3d54 7275 6529 0d0a 2020 2020 2020  ta=True)..      
+00013b40: 2020 2020 2020 7472 6965 7320 2b3d 2031        tries += 1
+00013b50: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00013b60: 2074 7269 6573 203e 2033 3a0d 0a20 2020   tries > 3:..   
+00013b70: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00013b80: 2e63 7269 7469 6361 6c28 226c 6173 6572  .critical("laser
+00013b90: 5f65 6e61 626c 6520 2573 2063 6f6d 6d61  _enable %s comma
+00013ba0: 6e64 2066 6169 6c65 642c 2067 6976 696e  nd failed, givin
+00013bb0: 6720 7570 222c 2066 6c61 6729 0d0a 2020  g up", flag)..  
+00013bc0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00013bd0: 6c66 2e71 7565 7565 5f6d 6573 7361 6765  lf.queue_message
+00013be0: 2822 6d61 7271 7565 655f 6572 726f 7222  ("marquee_error"
+00013bf0: 2c20 226c 6173 6572 2073 6574 7469 6e67  , "laser setting
+00013c00: 2066 6169 6c65 6422 290d 0a20 2020 2020   failed")..     
+00013c10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013c20: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
+00013c30: 7370 6f6e 7365 2864 6174 613d 4661 6c73  sponse(data=Fals
+00013c40: 652c 6572 726f 725f 6d73 673d 226c 6173  e,error_msg="las
+00013c50: 6572 2073 6574 7469 6e67 2066 6169 6c65  er setting faile
+00013c60: 6422 2c65 7272 6f72 5f6c 766c 3d45 7272  d",error_lvl=Err
+00013c70: 6f72 4c65 7665 6c2e 6d65 6469 756d 290d  orLevel.medium).
+00013c80: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00013c90: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00013ca0: 2020 2020 6c6f 672e 6572 726f 7228 226c      log.error("l
+00013cb0: 6173 6572 5f65 6e61 626c 6520 2573 2063  aser_enable %s c
+00013cc0: 6f6d 6d61 6e64 2066 6169 6c65 642c 2072  ommand failed, r
+00013cd0: 652d 7472 7969 6e67 222c 2066 6c61 6729  e-trying", flag)
+00013ce0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00013cf0: 2020 7365 6c66 2e73 6574 5f73 7472 6f62    self.set_strob
+00013d00: 655f 656e 6162 6c65 2866 6c61 6729 0d0a  e_enable(flag)..
+00013d10: 0d0a 2020 2020 6465 6620 7365 745f 6c61  ..    def set_la
+00013d20: 7365 725f 706f 7765 725f 6d57 2873 656c  ser_power_mW(sel
+00013d30: 662c 206d 575f 696e 3a20 696e 7429 3a20  f, mW_in: int): 
+00013d40: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+00013d50: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+00013d60: 2020 2020 6966 206d 575f 696e 2069 7320      if mW_in is 
+00013d70: 4e6f 6e65 206f 7220 6e6f 7420 7365 6c66  None or not self
+00013d80: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00013d90: 2e68 6173 5f6c 6173 6572 5f70 6f77 6572  .has_laser_power
+00013da0: 5f63 616c 6962 7261 7469 6f6e 2829 3a0d  _calibration():.
+00013db0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00013dc0: 2e65 7272 6f72 2822 4545 5052 4f4d 2064  .error("EEPROM d
+00013dd0: 6f65 736e 2774 2068 6176 6520 6c61 7365  oesn't have lase
+00013de0: 7220 706f 7765 7220 6361 6c69 6272 6174  r power calibrat
+00013df0: 696f 6e22 290d 0a20 2020 2020 2020 2020  ion")..         
+00013e00: 2020 2073 656c 662e 7365 7474 696e 6773     self.settings
+00013e10: 2e73 7461 7465 2e6c 6173 6572 5f70 6f77  .state.laser_pow
+00013e20: 6572 5f6d 5720 3d20 300d 0a20 2020 2020  er_mW = 0..     
+00013e30: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
+00013e40: 696e 6773 2e73 7461 7465 2e6c 6173 6572  ings.state.laser
+00013e50: 5f70 6f77 6572 5f70 6572 6320 3d20 300d  _power_perc = 0.
+00013e60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00013e70: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
+00013e80: 2e75 7365 5f6d 5720 3d20 4661 6c73 650d  .use_mW = False.
+00013e90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00013ea0: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00013eb0: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
+00013ec0: 6c73 652c 6572 726f 725f 6d73 673d 226e  lse,error_msg="n
+00013ed0: 6f20 6c61 7365 7220 706f 7765 7220 6361  o laser power ca
+00013ee0: 6c69 6272 6174 696f 6e22 290d 0a0d 0a20  libration").... 
+00013ef0: 2020 2020 2020 206d 5720 3d20 6d69 6e28         mW = min(
+00013f00: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00013f10: 7072 6f6d 2e6d 6178 5f6c 6173 6572 5f70  prom.max_laser_p
+00013f20: 6f77 6572 5f6d 572c 206d 6178 2873 656c  ower_mW, max(sel
+00013f30: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+00013f40: 6d2e 6d69 6e5f 6c61 7365 725f 706f 7765  m.min_laser_powe
+00013f50: 725f 6d57 2c20 6d57 5f69 6e29 290d 0a0d  r_mW, mW_in))...
+00013f60: 0a20 2020 2020 2020 2070 6572 6320 3d20  .        perc = 
+00013f70: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00013f80: 7072 6f6d 2e6c 6173 6572 5f70 6f77 6572  prom.laser_power
+00013f90: 5f6d 575f 746f 5f70 6572 6365 6e74 286d  _mW_to_percent(m
+00013fa0: 5729 0d0a 2020 2020 2020 2020 6c6f 672e  W)..        log.
+00013fb0: 6465 6275 6728 2273 6574 5f6c 6173 6572  debug("set_laser
+00013fc0: 5f70 6f77 6572 5f6d 573a 2072 616e 6765  _power_mW: range
+00013fd0: 2028 252e 3266 2c20 252e 3266 292c 2072   (%.2f, %.2f), r
+00013fe0: 6571 7565 7374 6564 2025 2e32 662c 2061  equested %.2f, a
+00013ff0: 7070 726f 7665 6420 252e 3266 2c20 7065  pproved %.2f, pe
+00014000: 7263 656e 7420 3d20 252e 3266 222c 0d0a  rcent = %.2f",..
+00014010: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00014020: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00014030: 2e6d 696e 5f6c 6173 6572 5f70 6f77 6572  .min_laser_power
+00014040: 5f6d 572c 0d0a 2020 2020 2020 2020 2020  _mW,..          
+00014050: 2020 7365 6c66 2e73 6574 7469 6e67 732e    self.settings.
+00014060: 6565 7072 6f6d 2e6d 6178 5f6c 6173 6572  eeprom.max_laser
+00014070: 5f70 6f77 6572 5f6d 572c 0d0a 2020 2020  _power_mW,..    
+00014080: 2020 2020 2020 2020 6d57 5f69 6e2c 0d0a          mW_in,..
+00014090: 2020 2020 2020 2020 2020 2020 6d57 2c0d              mW,.
+000140a0: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
+000140b0: 6329 0d0a 2020 2020 2020 2020 7365 6c66  c)..        self
+000140c0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
+000140d0: 6c61 7365 725f 706f 7765 725f 6d57 203d  laser_power_mW =
+000140e0: 206d 570d 0a20 2020 2020 2020 2072 6574   mW..        ret
+000140f0: 7572 6e20 7365 6c66 2e73 6574 5f6c 6173  urn self.set_las
+00014100: 6572 5f70 6f77 6572 5f70 6572 6328 7065  er_power_perc(pe
+00014110: 7263 2c20 7365 745f 696e 5f70 6572 633d  rc, set_in_perc=
+00014120: 4661 6c73 6529 0d0a 0d0a 2020 2020 2323  False)....    ##
+00014130: 0d0a 2020 2020 2320 4062 7269 6566 2053  ..    # @brief S
+00014140: 6574 7320 7768 6574 6865 7220 7468 6520  ets whether the 
+00014150: 5057 4d20 7075 6c73 6520 7065 7269 6f64  PWM pulse period
+00014160: 2069 7320 3130 3030 c2b5 7320 2868 6967   is 1000..s (hig
+00014170: 682d 7265 736f 6c75 7469 6f6e 2c20 6465  h-resolution, de
+00014180: 6661 756c 7429 0d0a 2020 2020 2320 6f72  fault)..    # or
+00014190: 2031 3030 c2b5 7320 286c 6f77 2d72 6573   100..s (low-res
+000141a0: 6f6c 7574 696f 6e2c 206c 6567 6163 7929  olution, legacy)
+000141b0: 2e0d 0a20 2020 2023 0d0a 2020 2020 2320  ...    #..    # 
+000141c0: 4070 6172 616d 2066 6c61 6720 2849 6e70  @param flag (Inp
+000141d0: 7574 2920 5472 7565 2066 6f72 2031 3030  ut) True for 100
+000141e0: 30c2 b573 2050 574d 2070 6572 696f 6420  0..s PWM period 
+000141f0: 2868 6967 682d 7265 736f 6c75 7469 6f6e  (high-resolution
+00014200: 2c20 6465 6661 756c 7429 2c20 0d0a 2020  , default), ..  
+00014210: 2020 2320 2020 2020 2020 2046 616c 7365    #        False
+00014220: 2066 6f72 2031 3030 c2b5 7320 286c 6f77   for 100..s (low
+00014230: 2d72 6573 6f6c 7574 696f 6e29 0d0a 2020  -resolution)..  
+00014240: 2020 2320 0d0a 2020 2020 2320 4c61 7365    # ..    # Lase
+00014250: 7220 706f 7765 7220 6973 2063 6f6e 7472  r power is contr
+00014260: 6f6c 6c65 6420 7669 6120 5057 4d20 2850  olled via PWM (P
+00014270: 756c 7365 2057 6964 7468 204d 6f64 756c  ulse Width Modul
+00014280: 6174 696f 6e29 2c20 6573 7365 6e74 6961  ation), essentia
+00014290: 6c6c 7920 0d0a 2020 2020 2320 6120 7371  lly ..    # a sq
+000142a0: 7561 7265 2077 6176 6520 7768 6f73 6520  uare wave whose 
+000142b0: 2264 7574 7920 6379 636c 6522 2028 6869  "duty cycle" (hi
+000142c0: 6768 2076 7320 6c6f 7729 2c20 6578 7072  gh vs low), expr
+000142d0: 6573 7365 6420 6173 2061 2070 6572 6365  essed as a perce
+000142e0: 6e74 6167 652c 0d0a 2020 2020 2320 7265  ntage,..    # re
+000142f0: 7072 6573 656e 7473 2074 6865 2061 6d6f  presents the amo
+00014300: 756e 7420 6f66 2074 696d 6520 7468 6520  unt of time the 
+00014310: 6c61 7365 7220 6973 2061 6374 7561 6c6c  laser is actuall
+00014320: 7920 6669 7269 6e67 2e20 4966 2074 6865  y firing. If the
+00014330: 2064 7574 790d 0a20 2020 2023 2063 7963   duty..    # cyc
+00014340: 6c65 2069 7320 3333 252c 2074 6865 206c  le is 33%, the l
+00014350: 6173 6572 2077 696c 6c20 6265 2066 6972  aser will be fir
+00014360: 696e 6720 312f 3320 6f66 2074 6865 2074  ing 1/3 of the t
+00014370: 696d 652c 2072 6570 7265 7365 6e74 696e  ime, representin
+00014380: 670d 0a20 2020 2023 2061 7070 726f 7869  g..    # approxi
+00014390: 6d61 7465 6c79 206f 6e65 2d74 6869 7264  mately one-third
+000143a0: 206f 6620 2266 756c 6c20 706f 7765 7222   of "full power"
+000143b0: 2e20 200d 0a20 2020 2023 200d 0a20 2020  .  ..    # ..   
+000143c0: 2023 2028 4974 2773 206e 6f74 2022 6578   # (It's not "ex
+000143d0: 6163 746c 7922 206f 6e65 2d74 6869 7264  actly" one-third
+000143e0: 2062 6563 6175 7365 2074 6865 206c 6173   because the las
+000143f0: 6572 206e 6565 6473 2061 206d 6f6d 656e  er needs a momen
+00014400: 7420 746f 200d 0a20 2020 2023 2073 7461  t to ..    # sta
+00014410: 626c 697a 6520 7768 656e 2065 6e65 7267  blize when energ
+00014420: 697a 6564 2c20 616e 6420 7468 6174 2022  ized, and that "
+00014430: 7374 6172 742d 7570 2220 696e 7374 6162  start-up" instab
+00014440: 696c 6974 7920 6973 2069 6e63 7265 6173  ility is increas
+00014450: 6564 200d 0a20 2020 2023 2077 6865 6e20  ed ..    # when 
+00014460: 796f 7527 7265 2063 6f6e 7374 616e 746c  you're constantl
+00014470: 7920 7075 6c73 696e 6720 7468 6520 6c61  y pulsing the la
+00014480: 7365 7220 6f6e 2d61 6e64 2d6f 6666 2e29  ser on-and-off.)
+00014490: 0d0a 2020 2020 2320 0d0a 2020 2020 2320  ..    # ..    # 
+000144a0: 5468 6973 2066 756e 6374 696f 6e20 6973  This function is
+000144b0: 2075 7365 6420 746f 2064 6574 6572 6d69   used to determi
+000144c0: 6e65 2074 6865 204c 454e 4754 4820 2870  ne the LENGTH (p
+000144d0: 6572 696f 6429 206f 6620 7468 6174 2050  eriod) of that P
+000144e0: 574d 0d0a 2020 2020 2320 7371 7561 7265  WM..    # square
+000144f0: 2077 6176 652e 2020 4265 6361 7573 6520   wave.  Because 
+00014500: 7468 6520 6c61 7365 7227 7320 5057 4d20  the laser's PWM 
+00014510: 7061 7261 6d65 7465 7273 2061 7265 2061  parameters are a
+00014520: 6c6c 2073 7065 6369 6669 6564 2069 6e0d  ll specified in.
+00014530: 0a20 2020 2023 206d 6963 726f 7365 636f  .    # microseco
+00014540: 6e64 7320 28c2 b573 292c 2061 206c 6f6e  nds (..s), a lon
+00014550: 6765 7220 7065 7269 6f64 2061 6c6c 6f77  ger period allow
+00014560: 7320 6772 6561 7465 7220 7072 6563 6973  s greater precis
+00014570: 696f 6e20 2872 6573 6f6c 7574 696f 6e29  ion (resolution)
+00014580: 0d0a 2020 2020 2320 696e 2073 7065 6369  ..    # in speci
+00014590: 6679 696e 6720 7468 6520 6475 7479 2063  fying the duty c
+000145a0: 7963 6c65 2e0d 0a20 2020 2023 200d 0a20  ycle...    # .. 
+000145b0: 2020 2023 2048 6973 746f 7269 6361 6c6c     # Historicall
+000145c0: 792c 2057 6173 6174 6368 2073 7065 6374  y, Wasatch spect
+000145d0: 726f 6d65 7465 7273 2075 7365 6420 6120  rometers used a 
+000145e0: 5057 4d20 7065 7269 6f64 206f 6620 3130  PWM period of 10
+000145f0: 30c2 b573 2c20 6d65 616e 696e 670d 0a20  0..s, meaning.. 
+00014600: 2020 2023 2074 6865 2070 756c 7365 2077     # the pulse w
+00014610: 6964 7468 2028 7469 6d65 2065 6163 6820  idth (time each 
+00014620: 7761 7665 2077 6173 2068 6967 6829 2063  wave was high) c
+00014630: 6f75 6c64 206f 6e6c 7920 6265 2073 6574  ould only be set
+00014640: 2066 726f 6d20 312d 3939 c2b5 732c 0d0a   from 1-99..s,..
+00014650: 2020 2020 2320 6769 7669 6e67 2061 6e20      # giving an 
+00014660: 6573 7365 6e74 6961 6c20 6c61 7365 7220  essential laser 
+00014670: 706f 7765 7220 7265 736f 6c75 7469 6f6e  power resolution
+00014680: 206f 6620 3125 2e20 2054 6861 7420 6265   of 1%.  That be
+00014690: 6861 7669 6f72 2063 616e 0d0a 2020 2020  havior can..    
+000146a0: 2320 6265 2072 6573 746f 7265 6420 6279  # be restored by
+000146b0: 2073 6574 7469 6e67 2074 6869 7320 7661   setting this va
+000146c0: 6c75 6520 4661 6c73 652e 0d0a 2020 2020  lue False...    
+000146d0: 2320 0d0a 2020 2020 2320 4d6f 7265 2072  # ..    # More r
+000146e0: 6563 656e 746c 792c 2077 6527 7665 2069  ecently, we've i
+000146f0: 6e63 7265 6173 6564 2074 6865 2064 6566  ncreased the def
+00014700: 6175 6c74 2050 574d 2070 756c 7365 2070  ault PWM pulse p
+00014710: 6572 696f 6420 746f 2031 3030 30c2 b573  eriod to 1000..s
+00014720: 200d 0a20 2020 2023 2028 316d 7329 2e20   ..    # (1ms). 
+00014730: 5369 6e63 6520 7468 6520 7075 6c73 6520  Since the pulse 
+00014740: 7769 6474 6820 6973 2073 7469 6c6c 2073  width is still s
+00014750: 6574 2069 6e20 c2b5 732c 2074 6861 7420  et in ..s, that 
+00014760: 616c 6c6f 7773 2061 6e0d 0a20 2020 2023  allows an..    #
+00014770: 2065 6666 6563 7469 7665 206c 6173 6572   effective laser
+00014780: 2070 6f77 6572 2072 6573 6f6c 7574 696f   power resolutio
+00014790: 6e20 6f66 2030 2e31 252e 2020 5468 6973  n of 0.1%.  This
+000147a0: 2069 7320 7468 6520 6e65 7720 6465 6661   is the new defa
+000147b0: 756c 742c 0d0a 2020 2020 2320 616e 6420  ult,..    # and 
+000147c0: 6361 6e20 6265 2065 7870 6c69 6369 746c  can be explicitl
+000147d0: 7920 7265 7175 6573 7465 6420 6279 2073  y requested by s
+000147e0: 6574 7469 6e67 2074 6869 7320 7661 6c75  etting this valu
+000147f0: 6520 746f 2054 7275 652e 0d0a 2020 2020  e to True...    
+00014800: 230d 0a20 2020 2023 2040 7761 726e 696e  #..    # @warnin
+00014810: 6720 4e6f 7465 2074 6861 7420 7468 6973  g Note that this
+00014820: 2066 756e 6374 696f 6e20 6973 2070 726f   function is pro
+00014830: 7669 6465 6420 666f 7220 6361 7365 7320  vided for cases 
+00014840: 7768 6572 6520 7468 6520 6c61 7365 7220  where the laser 
+00014850: 706f 7765 7220 0d0a 2020 2020 2320 6973  power ..    # is
+00014860: 2073 6574 2061 7320 6120 7065 7263 656e   set as a percen
+00014870: 7461 6765 2e20 2057 6865 6e20 7365 7474  tage.  When sett
+00014880: 696e 6720 6c61 7365 7220 706f 7765 7220  ing laser power 
+00014890: 7468 726f 7567 6820 6d69 6c6c 6957 6174  through milliWat
+000148a0: 7473 2c20 7573 696e 670d 0a20 2020 2023  ts, using..    #
+000148b0: 2074 6865 206f 6e62 6f61 7264 206c 6173   the onboard las
+000148c0: 6572 2070 6f77 6572 2063 616c 6962 7261  er power calibra
+000148d0: 7469 6f6e 2c20 6974 2069 7320 696d 706f  tion, it is impo
+000148e0: 7274 616e 7420 746f 2075 7365 2074 6865  rtant to use the
+000148f0: 2073 616d 650d 0a20 2020 2023 2072 6573   same..    # res
+00014900: 6f6c 7574 696f 6e20 6173 2077 6173 2069  olution as was i
+00014910: 6e20 6566 6665 6374 2077 6865 6e20 7468  n effect when th
+00014920: 6520 6361 6c69 6272 6174 696f 6e20 7761  e calibration wa
+00014930: 7320 6765 6e65 7261 7465 642e 2020 416c  s generated.  Al
+00014940: 6c20 5761 7361 7463 680d 0a20 2020 2023  l Wasatch..    #
+00014950: 206c 6173 6572 2070 6f77 6572 2063 616c   laser power cal
+00014960: 6962 7261 7469 6f6e 7320 6172 6520 6765  ibrations are ge
+00014970: 6e65 7261 7465 6420 696e 2022 6869 6768  nerated in "high
+00014980: 2d72 6573 6f6c 7574 696f 6e2c 2220 736f  -resolution," so
+00014990: 2074 6869 7320 0d0a 2020 2020 2320 6675   this ..    # fu
+000149a0: 6e63 7469 6f6e 2053 484f 554c 4420 4e4f  nction SHOULD NO
+000149b0: 5420 6265 2073 6574 2022 4661 6c73 6522  T be set "False"
+000149c0: 2028 6c6f 772d 7265 7329 2069 6620 7365   (low-res) if se
+000149d0: 7474 696e 6720 6c61 7365 7220 706f 7765  tting laser powe
+000149e0: 7220 696e 206d 572e 0d0a 2020 2020 6465  r in mW...    de
+000149f0: 6620 7365 745f 6c61 7365 725f 706f 7765  f set_laser_powe
+00014a00: 725f 6869 6768 5f72 6573 6f6c 7574 696f  r_high_resolutio
+00014a10: 6e28 7365 6c66 2c20 666c 6167 3a20 626f  n(self, flag: bo
+00014a20: 6f6c 293a 2023 202d 3e20 5370 6563 7472  ol): # -> Spectr
+00014a30: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+00014a40: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00014a50: 7474 696e 6773 2e73 7461 7465 2e6c 6173  ttings.state.las
+00014a60: 6572 5f70 6f77 6572 5f68 6967 685f 7265  er_power_high_re
+00014a70: 736f 6c75 7469 6f6e 203d 2054 7275 6520  solution = True 
+00014a80: 6966 2066 6c61 6720 656c 7365 2046 616c  if flag else Fal
+00014a90: 7365 0d0a 2020 2020 2020 2020 7265 7475  se..        retu
+00014aa0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+00014ab0: 6573 706f 6e73 6528 290d 0a0d 0a20 2020  esponse()....   
+00014ac0: 2064 6566 2073 6574 5f6c 6173 6572 5f70   def set_laser_p
+00014ad0: 6f77 6572 5f72 6571 7569 7265 5f6d 6f64  ower_require_mod
+00014ae0: 756c 6174 696f 6e28 7365 6c66 2c20 666c  ulation(self, fl
+00014af0: 6167 3a20 626f 6f6c 293a 2023 202d 3e20  ag: bool): # -> 
+00014b00: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+00014b10: 6f6e 7365 200d 0a20 2020 2020 2020 2073  onse ..        s
+00014b20: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+00014b30: 7465 2e6c 6173 6572 5f70 6f77 6572 5f72  te.laser_power_r
+00014b40: 6571 7569 7265 5f6d 6f64 756c 6174 696f  equire_modulatio
+00014b50: 6e20 3d20 5472 7565 2069 6620 666c 6167  n = True if flag
+00014b60: 2065 6c73 6520 4661 6c73 650d 0a20 2020   else False..   
+00014b70: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
+00014b80: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00014b90: 2829 0d0a 0d0a 2020 2020 2323 0d0a 2020  ()....    ##..  
+00014ba0: 2020 2320 4074 6f64 6f20 7375 7070 6f72    # @todo suppor
+00014bb0: 7420 666c 6f61 7469 6e67 2d70 6f69 6e74  t floating-point
+00014bc0: 2076 616c 7565 2c20 6173 2077 6520 6861   value, as we ha
+00014bd0: 7665 2061 2031 322d 6269 7420 4144 4320  ve a 12-bit ADC 
+00014be0: 616e 6420 6361 6e20 7072 6f76 6964 650d  and can provide.
+00014bf0: 0a20 2020 2023 2061 2062 6974 206d 6f72  .    # a bit mor
+00014c00: 6520 7072 6563 6973 696f 6e20 7468 616e  e precision than
+00014c10: 2031 3030 2064 6973 6372 6574 6520 7374   100 discrete st
+00014c20: 6570 7320 2867 6f61 6c20 746f 2073 7570  eps (goal to sup
+00014c30: 706f 7274 2030 2e31 202d 202e 3132 3525  port 0.1 - .125%
+00014c40: 2072 6573 6f6c 7574 696f 6e29 0d0a 2020   resolution)..  
+00014c50: 2020 6465 6620 7365 745f 6c61 7365 725f    def set_laser_
+00014c60: 706f 7765 725f 7065 7263 2873 656c 662c  power_perc(self,
+00014c70: 2076 616c 7565 5f69 6e3a 2066 6c6f 6174   value_in: float
+00014c80: 2c20 7365 745f 696e 5f70 6572 633a 2062  , set_in_perc: b
+00014c90: 6f6f 6c20 3d20 5472 7565 293a 2023 202d  ool = True): # -
+00014ca0: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+00014cb0: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+00014cc0: 2069 6620 6e6f 7420 7365 6c66 2e73 6574   if not self.set
+00014cd0: 7469 6e67 732e 6565 7072 6f6d 2e68 6173  tings.eeprom.has
+00014ce0: 5f6c 6173 6572 3a0d 0a20 2020 2020 2020  _laser:..       
+00014cf0: 2020 2020 206c 6f67 2e65 7272 6f72 2822       log.error("
+00014d00: 756e 6162 6c65 2074 6f20 636f 6e74 726f  unable to contro
+00014d10: 6c20 6c61 7365 723a 2045 4550 524f 4d20  l laser: EEPROM 
+00014d20: 7265 706f 7274 7320 6e6f 206c 6173 6572  reports no laser
+00014d30: 2069 6e73 7461 6c6c 6564 2229 0d0a 2020   installed")..  
+00014d40: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00014d50: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+00014d60: 706f 6e73 6528 6461 7461 3d46 616c 7365  ponse(data=False
+00014d70: 2c65 7272 6f72 5f6d 7367 3d22 6e6f 206c  ,error_msg="no l
+00014d80: 6173 6572 2069 6e73 7461 6c6c 6564 2229  aser installed")
+00014d90: 0d0a 0d0a 2020 2020 2020 2020 7661 6c75  ....        valu
+00014da0: 6520 3d20 666c 6f61 7428 6d61 7828 302c  e = float(max(0,
+00014db0: 206d 696e 2831 3030 2c20 7661 6c75 655f   min(100, value_
+00014dc0: 696e 2929 290d 0a20 2020 2020 2020 2073  in)))..        s
+00014dd0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+00014de0: 7465 2e6c 6173 6572 5f70 6f77 6572 5f70  te.laser_power_p
+00014df0: 6572 6320 3d20 7661 6c75 650d 0a20 2020  erc = value..   
+00014e00: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
+00014e10: 7365 745f 6c61 7365 725f 706f 7765 725f  set_laser_power_
+00014e20: 7065 7263 3a20 7261 6e67 6520 2830 2c20  perc: range (0, 
+00014e30: 3130 3029 2c20 7265 7175 6573 7465 6420  100), requested 
+00014e40: 252e 3266 2c20 6170 706c 7969 6e67 2025  %.2f, applying %
+00014e50: 2e32 6622 2c20 7661 6c75 655f 696e 2c20  .2f", value_in, 
+00014e60: 7661 6c75 6529 0d0a 0d0a 2020 2020 2020  value)....      
+00014e70: 2020 6966 2073 6574 5f69 6e5f 7065 7263    if set_in_perc
+00014e80: 3a0d 0a20 2020 2020 2020 2020 2020 2023  :..            #
+00014e90: 2061 7070 6172 656e 746c 7920 7468 6520   apparently the 
+00014ea0: 6c61 7365 7220 706f 7765 7220 7761 7320  laser power was 
+00014eb0: 6578 706c 6963 6974 6c79 2063 6f6d 6d61  explicitly comma
+00014ec0: 6e64 6564 2061 7320 6120 7065 7263 656e  nded as a percen
+00014ed0: 7461 6765 0d0a 2020 2020 2020 2020 2020  tage..          
+00014ee0: 2020 2320 6f66 2066 756c 6c2c 2061 6e64    # of full, and
+00014ef0: 206e 6f74 2022 636f 6d70 7574 6564 2066   not "computed f
+00014f00: 726f 6d20 6d57 2220 7573 696e 6720 6120  rom mW" using a 
+00014f10: 6361 6c69 6272 6174 696f 6e2c 2073 6f20  calibration, so 
+00014f20: 636c 6561 720d 0a20 2020 2020 2020 2020  clear..         
+00014f30: 2020 2023 2074 6865 206d 5720 7365 7470     # the mW setp
+00014f40: 6f69 6e74 0d0a 2020 2020 2020 2020 2020  oint..          
+00014f50: 2020 7365 6c66 2e73 6574 7469 6e67 732e    self.settings.
+00014f60: 7374 6174 652e 6c61 7365 725f 706f 7765  state.laser_powe
+00014f70: 725f 6d57 203d 2030 0d0a 0d0a 2020 2020  r_mW = 0....    
+00014f80: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00014f90: 7365 745f 6c61 7365 725f 706f 7765 725f  set_laser_power_
+00014fa0: 7065 7263 5f69 6d6d 6564 6961 7465 2876  perc_immediate(v
+00014fb0: 616c 7565 290d 0a0d 0a20 2020 2023 230d  alue)....    ##.
+00014fc0: 0a20 2020 2023 2053 6574 7320 6c61 7365  .    # Sets lase
+00014fd0: 7220 706f 7765 7220 286d 6f64 756c 6174  r power (modulat
+00014fe0: 6564 2070 756c 7365 2077 6964 7468 2920  ed pulse width) 
+00014ff0: 7768 6963 6820 7769 6c6c 2062 6520 7573  which will be us
+00015000: 6564 206e 6578 7420 7469 6d65 2074 6865  ed next time the
+00015010: 0d0a 2020 2020 2320 6c61 7365 7220 6973  ..    # laser is
+00015020: 2074 7572 6e65 6420 6f6e 2028 6f72 2063   turned on (or c
+00015030: 6861 6e67 6564 2069 6d6d 6564 6961 7465  hanged immediate
+00015040: 6c79 2c20 6966 2074 6865 206c 6173 6572  ly, if the laser
+00015050: 2069 7320 616c 7265 6164 7920 656e 6162   is already enab
+00015060: 6c65 6429 2e0d 0a20 2020 2023 204c 6173  led)...    # Las
+00015070: 6572 2070 6f77 6572 2069 7320 6465 7465  er power is dete
+00015080: 726d 696e 6564 2062 7920 6120 636f 6d62  rmined by a comb
+00015090: 696e 6174 696f 6e20 6f66 2074 6865 2070  ination of the p
+000150a0: 756c 7365 2077 6964 7468 2c0d 0a20 2020  ulse width,..   
+000150b0: 2023 2070 6572 696f 6420 616e 6420 6d6f   # period and mo
+000150c0: 6475 6c61 7469 6f6e 2062 6569 6e67 2065  dulation being e
+000150d0: 6e61 626c 6564 2e20 5468 6572 6520 6172  nabled. There ar
+000150e0: 6520 6d61 6e79 2063 6f6d 6269 6e61 7469  e many combinati
+000150f0: 6f6e 7320 6f66 0d0a 2020 2020 2320 7468  ons of..    # th
+00015100: 6573 6520 7661 6c75 6573 2074 6861 7420  ese values that 
+00015110: 7769 6c6c 2070 726f 6475 6365 2061 2067  will produce a g
+00015120: 6976 656e 2070 6572 6365 6e74 6167 6520  iven percentage 
+00015130: 6f66 2074 6865 2074 6f74 616c 206c 6173  of the total las
+00015140: 6572 0d0a 2020 2020 2320 706f 7765 7220  er..    # power 
+00015150: 7468 726f 7567 6820 7075 6c73 6520 7769  through pulse wi
+00015160: 6474 6820 6d6f 6475 6c61 7469 6f6e 2e20  dth modulation. 
+00015170: 5468 6572 6520 6973 206e 6f20 2767 6574  There is no 'get
+00015180: 206c 6173 6572 2070 6f77 6572 270d 0a20   laser power'.. 
+00015190: 2020 2023 2063 6f6e 7472 6f6c 206d 6573     # control mes
+000151a0: 7361 6765 206f 6e20 7468 6520 6465 7669  sage on the devi
+000151b0: 6365 2e0d 0a20 2020 2023 0d0a 2020 2020  ce...    #..    
+000151c0: 2320 536f 6d65 206f 6620 7468 6520 676f  # Some of the go
+000151d0: 616c 7320 6f66 2045 6e6c 6967 6874 656e  als of Enlighten
+000151e0: 2061 7265 2066 6f72 2069 7420 746f 2062   are for it to b
+000151f0: 6520 7374 6162 6c65 2c20 616e 6420 6120  e stable, and a 
+00015200: 7265 6173 6f6e 0d0a 2020 2020 2320 7765  reason..    # we
+00015210: 2068 6176 6520 7361 6c65 732e 2044 7572   have sales. Dur
+00015220: 696e 6720 7370 6563 7472 6f6d 6574 6572  ing spectrometer
+00015230: 2062 7569 6c64 732c 2069 7420 7761 7320   builds, it was 
+00015240: 6469 7363 6f76 6572 6564 2074 6861 740d  discovered that.
+00015250: 0a20 2020 2023 2074 6865 206c 6173 6572  .    # the laser
+00015260: 2070 6f77 6572 2073 6574 7469 6e67 7320   power settings 
+00015270: 7765 7265 206e 6f74 2069 6d70 6c65 6d65  were not impleme
+00015280: 6e74 6564 2e20 4475 7269 6e67 2074 6865  nted. During the
+00015290: 0d0a 2020 2020 2320 696d 706c 656d 656e  ..    # implemen
+000152a0: 7461 7469 6f6e 2070 726f 6365 7373 2c20  tation process, 
+000152b0: 6974 2077 6173 2064 6973 636f 7665 7265  it was discovere
+000152c0: 6420 7468 6174 2074 6865 206c 6173 6572  d that the laser
+000152d0: 206d 6f64 756c 6174 696f 6e2c 0d0a 2020   modulation,..  
+000152e0: 2020 2320 7075 6c73 6520 7065 7269 6f64    # pulse period
+000152f0: 2061 6e64 2070 756c 7365 2077 6964 7468   and pulse width
+00015300: 2063 6f6d 6d61 6e64 7320 646f 206e 6f74   commands do not
+00015310: 2063 6f6e 666f 726d 2074 6f0d 0a20 2020   conform to..   
+00015320: 2023 2073 7065 6369 6669 6361 7469 6f6e   # specification
+00015330: 2e20 5768 6572 6520 796f 7520 6361 6e20  . Where you can 
+00015340: 7365 7420 696e 7465 6772 6174 696f 6e20  set integration 
+00015350: 7469 6d65 2031 3030 206d 7320 7769 7468  time 100 ms with
+00015360: 2074 6865 0d0a 2020 2020 2320 636f 6d6d   the..    # comm
+00015370: 616e 643a 0d0a 2020 2020 230d 0a20 2020  and:..    #..   
+00015380: 2023 2064 6576 6963 652e 6374 726c 5f74   # device.ctrl_t
+00015390: 7261 6e73 6665 7228 626d 5265 7175 6573  ransfer(bmReques
+000153a0: 7454 7970 653d 6465 7669 6365 5f74 6f5f  tType=device_to_
+000153b0: 686f 7374 2c0d 0a20 2020 2023 2020 2020  host,..    #    
+000153c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000153d0: 2020 6252 6571 7565 7374 3d30 7844 422c    bRequest=0xDB,
+000153e0: 0d0a 2020 2020 2320 2020 2020 2020 2020  ..    #         
+000153f0: 2020 2020 2020 2020 2020 2020 2077 5661               wVa
+00015400: 6c75 653d 3130 302c 0d0a 2020 2020 2320  lue=100,..    # 
+00015410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015420: 2020 2020 2077 496e 6465 783d 302c 0d0a       wIndex=0,..
+00015430: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+00015440: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00015450: 6f72 5f77 4c65 6e67 7468 3d30 290d 0a20  or_wLength=0).. 
+00015460: 2020 2023 0d0a 2020 2020 2320 5468 6520     #..    # The 
+00015470: 6c61 7365 7220 7075 6c73 6520 7065 7269  laser pulse peri
+00015480: 6f64 206d 7573 7420 6265 2073 6574 2077  od must be set w
+00015490: 6865 7265 2074 6865 2077 5661 6c75 6520  here the wValue 
+000154a0: 616e 640d 0a20 2020 2023 2064 6174 615f  and..    # data_
+000154b0: 6f72 5f77 4c65 6e67 7468 2070 6172 616d  or_wLength param
+000154c0: 6574 6572 7320 6172 6520 6571 7561 6c2e  eters are equal.
+000154d0: 2053 6f20 6966 2079 6f75 2077 616e 7465   So if you wante
+000154e0: 6420 6120 7075 6c73 650d 0a20 2020 2023  d a pulse..    #
+000154f0: 2070 6572 696f 6420 6f66 2031 3030 2c20   period of 100, 
+00015500: 796f 7520 6d75 7374 2073 7065 6369 6679  you must specify
+00015510: 2074 6865 2076 616c 7565 2069 6e20 626f   the value in bo
+00015520: 7468 2070 6c61 6365 733a 0d0a 2020 2020  th places:..    
+00015530: 230d 0a20 2020 2023 202e 2e2e 0d0a 2020  #..    # .....  
+00015540: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00015550: 2020 2020 2020 2020 2077 5661 6c75 653d           wValue=
+00015560: 3130 302c 0d0a 2020 2020 2320 2020 2020  100,..    #     
+00015570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015580: 2064 6174 615f 6f72 5f77 4c65 6e67 7468   data_or_wLength
+00015590: 3d31 3030 290d 0a20 2020 2023 202e 2e2e  =100)..    # ...
+000155a0: 0d0a 2020 2020 230d 0a20 2020 2023 2054  ..    #..    # T
+000155b0: 6869 7320 696e 2074 7572 6e20 696d 706c  his in turn impl
+000155c0: 6965 7320 7468 6174 2074 6865 206c 6567  ies that the leg
+000155d0: 6163 7920 6669 726d 7761 7265 2068 6173  acy firmware has
+000155e0: 2061 206c 6f6e 6720 6d61 736b 6564 0d0a   a long masked..
+000155f0: 2020 2020 2320 6973 7375 6520 7768 656e      # issue when
+00015600: 2072 6561 6469 6e67 2074 6865 2076 616c   reading the val
+00015610: 7565 2074 6f20 7570 6461 7465 2066 726f  ue to update fro
+00015620: 6d20 7468 6520 6461 7461 5f6f 725f 774c  m the data_or_wL
+00015630: 656e 6774 680d 0a20 2020 2023 2070 6172  ength..    # par
+00015640: 616d 6574 6572 2069 6e73 7465 6164 206f  ameter instead o
+00015650: 6620 7468 6520 7756 616c 7565 2066 6965  f the wValue fie
+00015660: 6c64 2e20 5468 6973 2069 7320 6f6e 6c79  ld. This is only
+00015670: 2061 6363 7572 6174 6520 666f 7220 7468   accurate for th
+00015680: 650d 0a20 2020 2023 206c 6173 6572 206d  e..    # laser m
+00015690: 6f64 756c 6174 696f 6e20 7265 6c61 7465  odulation relate
+000156a0: 6420 6675 6e63 7469 6f6e 732e 0d0a 2020  d functions...  
+000156b0: 2020 230d 0a20 2020 2023 2054 6869 7320    #..    # This 
+000156c0: 6973 2062 6163 6b65 6420 7570 2062 7920  is backed up by 
+000156d0: 7468 6520 4461 7368 2076 3320 5374 726f  the Dash v3 Stro
+000156e0: 6b65 7243 6f6e 7472 6f6c 2044 4c4c 2069  kerControl DLL i
+000156f0: 6d70 6c65 6d65 6e74 6174 696f 6e2e 0d0a  mplementation...
+00015700: 2020 2020 2320 4974 2077 6173 2064 6973      # It was dis
+00015710: 636f 7665 7265 6420 7468 6174 2074 6865  covered that the
+00015720: 2053 7472 6f6b 6572 436f 6e74 726f 6c20   StrokerControl 
+00015730: 444c 4c20 7365 7473 2074 6865 2077 5661  DLL sets the wVa
+00015740: 6c75 6520 616e 640d 0a20 2020 2023 2064  lue and..    # d
+00015750: 6174 6120 6f72 2077 4c65 6e67 7468 2070  ata or wLength p
+00015760: 6172 616d 6574 6572 7320 746f 2074 6865  arameters to the
+00015770: 2073 616d 6520 7661 6c75 6520 6174 2065   same value at e
+00015780: 7665 7279 2063 6f6e 7472 6f6c 0d0a 2020  very control..  
+00015790: 2020 2320 6d65 7373 6167 6520 7772 6974    # message writ
+000157a0: 652e 0d0a 2020 2020 230d 0a20 2020 2023  e...    #..    #
+000157b0: 2054 6865 2065 7863 6974 696e 6720 7461   The exciting ta
+000157c0: 6b65 6177 6179 2068 6572 6520 6973 2074  keaway here is t
+000157d0: 6861 7420 456e 6c69 6768 7465 6e20 6973  hat Enlighten is
+000157e0: 2073 7461 626c 6520 656e 6f75 6768 2e0d   stable enough..
+000157f0: 0a20 2020 2023 2054 7572 6e69 6e67 2074  .    # Turning t
+00015800: 6865 206c 6173 6572 206f 6e20 7769 7468  he laser on with
+00015810: 2074 6865 2064 6174 6120 6f72 2077 4c65   the data or wLe
+00015820: 6e67 7468 2070 6172 616d 6574 6572 206e  ngth parameter n
+00015830: 6f74 2073 6574 0d0a 2020 2020 2320 636f  ot set..    # co
+00015840: 7272 6563 746c 7920 7769 6c6c 2063 6175  rrectly will cau
+00015850: 7365 2061 2068 6172 6477 6172 6520 6661  se a hardware fa
+00015860: 696c 7572 6520 616e 6420 636f 6d70 6c65  ilure and comple
+00015870: 7465 2064 6576 6963 6520 6c6f 636b 7570  te device lockup
+00015880: 0d0a 2020 2020 2320 7265 7175 6972 696e  ..    # requirin
+00015890: 6720 6120 706f 7765 7220 6379 636c 652e  g a power cycle.
+000158a0: 0d0a 2020 2020 230d 0a20 2020 2023 2066  ..    #..    # f
+000158b0: 6964 3a0d 0a20 2020 2023 2020 2020 2043  id:..    #     C
+000158c0: 5249 5449 4341 4c20 4861 7264 7761 7265  RITICAL Hardware
+000158d0: 2046 6169 6c75 7265 2046 4944 2053 656e   Failure FID Sen
+000158e0: 6420 436f 6465 2050 726f 626c 656d 2077  d Code Problem w
+000158f0: 6974 680d 0a20 2020 2023 2020 2020 2020  ith..    #      
+00015900: 2020 2020 2020 2020 6374 726c 2074 7261          ctrl tra
+00015910: 6e73 6665 723a 205b 4572 726e 6f20 4e6f  nsfer: [Errno No
+00015920: 6e65 5d20 3131 0d0a 2020 2020 230d 0a20  ne] 11..    #.. 
+00015930: 2020 2023 2055 6e6c 696b 6520 4461 7368     # Unlike Dash
+00015940: 2077 6869 6368 206d 6179 206c 6f63 6b75   which may locku
+00015950: 7020 616e 6420 7265 7175 6972 6520 6b69  p and require ki
+00015960: 6c6c 696e 6720 7468 6520 6170 706c 6963  lling the applic
+00015970: 6174 696f 6e2c 0d0a 2020 2020 2320 456e  ation,..    # En
+00015980: 6c69 6768 7465 6e20 646f 6573 206e 6f74  lighten does not
+00015990: 206c 6f63 6b20 7570 2e20 5468 6520 456e   lock up. The En
+000159a0: 6c69 6768 7465 6e20 636f 6465 2062 6173  lighten code bas
+000159b0: 6520 6861 7320 6e6f 7720 6265 656e 0d0a  e has now been..
+000159c0: 2020 2020 2320 7573 6564 2074 6f20 756e      # used to un
+000159d0: 6d61 736b 2061 6e20 6973 7375 6520 7468  mask an issue th
+000159e0: 6174 2068 6173 2062 6565 6e20 6c75 726b  at has been lurk
+000159f0: 696e 6720 7769 7468 206f 7572 206c 6567  ing with our leg
+00015a00: 6163 790d 0a20 2020 2023 2066 6972 6d77  acy..    # firmw
+00015a10: 6172 6520 666f 7220 636c 6f73 6520 746f  are for close to
+00015a20: 2036 2079 6561 7273 2e20 5765 2776 6520   6 years. We've 
+00015a30: 6465 7465 6374 6564 2074 6869 7320 6f75  detected this ou
+00015a40: 7420 6f66 0d0a 2020 2020 2320 7370 6563  t of..    # spec
+00015a50: 6966 6963 6174 696f 6e20 6172 6561 206f  ification area o
+00015a60: 6620 7468 6520 636f 6465 2062 6566 6f72  f the code befor
+00015a70: 6520 6974 2063 616e 2061 6476 6572 7365  e it can adverse
+00015a80: 6c79 2069 6d70 6163 7420 610d 0a20 2020  ly impact a..   
+00015a90: 2023 2063 7573 746f 6d65 722e 2022 2222   # customer. """
+00015aa0: 0d0a 2020 2020 230d 0a20 2020 2023 2041  ..    #..    # A
+00015ab0: 7320 6c6f 6e67 2061 7320 6c61 7365 7220  s long as laser 
+00015ac0: 706f 7765 7220 6973 206d 6f64 756c 6174  power is modulat
+00015ad0: 6564 2075 7369 6e67 2061 2070 6572 696f  ed using a perio
+00015ae0: 6420 6f66 2031 3030 7573 2c0d 0a20 2020  d of 100us,..   
+00015af0: 2023 2077 6974 6820 6120 6e65 6365 7373   # with a necess
+00015b00: 6172 696c 792d 696e 7465 6772 616c 2070  arily-integral p
+00015b10: 756c 7365 2077 6964 7468 206f 6620 312d  ulse width of 1-
+00015b20: 3939 7573 2c20 7468 656e 2069 7427 730d  99us, then it's.
+00015b30: 0a20 2020 2023 206e 6f74 2070 6879 7369  .    # not physi
+00015b40: 6361 6c6c 7920 706f 7373 6962 6c65 2074  cally possible t
+00015b50: 6f20 7375 7070 6f72 7420 6672 6163 7469  o support fracti
+00015b60: 6f6e 616c 2070 6f77 6572 206c 6576 656c  onal power level
+00015b70: 732e 0d0a 2020 2020 230d 0a20 2020 2023  s...    #..    #
+00015b80: 2040 746f 646f 2074 616c 6b20 746f 204a   @todo talk to J
+00015b90: 6173 6f6e 2061 626f 7574 2063 6861 6e67  ason about chang
+00015ba0: 696e 6720 6d6f 6475 6c61 7469 6f6e 2050  ing modulation P
+00015bb0: 4552 494f 4420 746f 206c 6f6e 6765 720d  ERIOD to longer.
+00015bc0: 0a20 2020 2023 2020 2020 2076 616c 7565  .    #     value
+00015bd0: 2028 3230 3075 733f 2034 3030 3f20 3130   (200us? 400? 10
+00015be0: 3030 3f29 2c20 4f52 2077 6865 7468 6572  00?), OR whether
+00015bf0: 2070 756c 7365 2057 4944 5448 2063 616e   pulse WIDTH can
+00015c00: 2062 650d 0a20 2020 2023 2020 2020 2069   be..    #     i
+00015c10: 6e20 736d 616c 6c65 7220 756e 6974 2028  n smaller unit (
+00015c20: 3530 306e 733f 2031 3030 6e73 3f29 0d0a  500ns? 100ns?)..
+00015c30: 2020 2020 6465 6620 7365 745f 6c61 7365      def set_lase
+00015c40: 725f 706f 7765 725f 7065 7263 5f69 6d6d  r_power_perc_imm
+00015c50: 6564 6961 7465 2873 656c 662c 2076 616c  ediate(self, val
+00015c60: 7565 3a20 666c 6f61 7429 3a20 2320 2d3e  ue: float): # ->
+00015c70: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+00015c80: 706f 6e73 6520 0d0a 0d0a 2020 2020 2020  ponse ....      
+00015c90: 2020 2320 6c61 7365 7220 6361 6e20 666c    # laser can fl
+00015ca0: 6963 6b65 7220 6966 2077 6527 7265 206f  icker if we're o
+00015cb0: 6e20 7468 6520 7772 6f6e 6720 4144 433f  n the wrong ADC?
+00015cc0: 0d0a 0d0a 2020 2020 2020 2020 2320 646f  ....        # do
+00015cd0: 6e27 7420 7761 6e74 2061 6e79 7468 696e  n't want anythin
+00015ce0: 6720 7765 6972 6420 7768 656e 2070 6173  g weird when pas
+00015cf0: 7369 6e67 206f 7665 7220 5553 420d 0a20  sing over USB.. 
+00015d00: 2020 2020 2020 2076 616c 7565 203d 2066         value = f
+00015d10: 6c6f 6174 286d 6178 2830 2c20 6d69 6e28  loat(max(0, min(
+00015d20: 3130 302c 2076 616c 7565 2929 290d 0a0d  100, value)))...
+00015d30: 0a20 2020 2020 2020 2023 2049 6620 6675  .        # If fu
+00015d40: 6c6c 2070 6f77 6572 2028 616e 6420 616c  ll power (and al
+00015d50: 6c6f 7765 6429 2c20 6469 7361 626c 6520  lowed), disable 
+00015d60: 6d6f 6475 6c61 7469 6f6e 2061 6e64 2065  modulation and e
+00015d70: 7869 740d 0a20 2020 2020 2020 2069 6620  xit..        if 
+00015d80: 7661 6c75 6520 3e3d 2031 3030 3a0d 0a20  value >= 100:.. 
+00015d90: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00015da0: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
+00015db0: 652e 6c61 7365 725f 706f 7765 725f 7265  e.laser_power_re
+00015dc0: 7175 6972 655f 6d6f 6475 6c61 7469 6f6e  quire_modulation
+00015dd0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
+00015de0: 2020 206c 6f67 2e64 6562 7567 2822 3130     log.debug("10
+00015df0: 3025 2070 6f77 6572 2072 6571 7565 7374  0% power request
+00015e00: 6564 2c20 7965 7420 6c61 7365 7220 6d6f  ed, yet laser mo
+00015e10: 6475 6c61 7469 6f6e 2072 6571 7569 7265  dulation require
+00015e20: 642c 2073 6f20 6e6f 7420 6469 7361 626c  d, so not disabl
+00015e30: 696e 6720 6d6f 6475 6c61 7469 6f6e 2229  ing modulation")
+00015e40: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00015e50: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00015e60: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
+00015e70: 5475 726e 696e 6720 6f66 6620 6c61 7365  Turning off lase
+00015e80: 7220 6d6f 6475 6c61 7469 6f6e 2028 6675  r modulation (fu
+00015e90: 6c6c 2070 6f77 6572 2922 290d 0a20 2020  ll power)")..   
+00015ea0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00015eb0: 662e 6e65 7874 5f61 7070 6c69 6564 5f6c  f.next_applied_l
+00015ec0: 6173 6572 5f70 6f77 6572 203d 2031 3030  aser_power = 100
+00015ed0: 2e30 0d0a 2020 2020 2020 2020 2020 2020  .0..            
+00015ee0: 2020 2020 6c6f 672e 6465 6275 6728 226e      log.debug("n
+00015ef0: 6578 745f 6170 706c 6965 645f 6c61 7365  ext_applied_lase
+00015f00: 725f 706f 7765 7220 3d20 3130 302e 3022  r_power = 100.0"
+00015f10: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00015f20: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+00015f30: 6574 5f6d 6f64 5f65 6e61 626c 6528 4661  et_mod_enable(Fa
+00015f40: 6c73 6529 0d0a 0d0a 2020 2020 2020 2020  lse)....        
+00015f50: 7065 7269 6f64 5f75 7320 3d20 3130 3030  period_us = 1000
+00015f60: 2069 6620 7365 6c66 2e73 6574 7469 6e67   if self.setting
+00015f70: 732e 7374 6174 652e 6c61 7365 725f 706f  s.state.laser_po
+00015f80: 7765 725f 6869 6768 5f72 6573 6f6c 7574  wer_high_resolut
+00015f90: 696f 6e20 656c 7365 2031 3030 0d0a 2020  ion else 100..  
+00015fa0: 2020 2020 2020 7769 6474 685f 7573 203d        width_us =
+00015fb0: 2069 6e74 2872 6f75 6e64 2831 2e30 202a   int(round(1.0 *
+00015fc0: 2076 616c 7565 202a 2070 6572 696f 645f   value * period_
+00015fd0: 7573 202f 2031 3030 2e30 2c20 3029 2920  us / 100.0, 0)) 
+00015fe0: 2320 6e6f 7465 2074 6861 7420 7661 6c75  # note that valu
+00015ff0: 6520 6973 2069 6e20 7261 6e67 6520 2830  e is in range (0
+00016000: 2c20 3130 3029 206e 6f74 2028 302c 2031  , 100) not (0, 1
+00016010: 290d 0a0d 0a20 2020 2020 2020 2023 2070  )....        # p
+00016020: 756c 7365 2077 6964 7468 2063 616e 2774  ulse width can't
+00016030: 2062 6520 6c6f 6e67 6572 2074 6861 6e20   be longer than 
+00016040: 7065 7269 6f64 2c20 6f72 2073 686f 7274  period, or short
+00016050: 6572 2074 6861 6e20 3175 730d 0a20 2020  er than 1us..   
+00016060: 2020 2020 2077 6964 7468 5f75 7320 3d20       width_us = 
+00016070: 6d61 7828 312c 206d 696e 2877 6964 7468  max(1, min(width
+00016080: 5f75 732c 2070 6572 696f 645f 7573 2929  _us, period_us))
+00016090: 0d0a 0d0a 2020 2020 2020 2020 2320 4368  ....        # Ch
+000160a0: 616e 6765 2074 6865 2070 756c 7365 2070  ange the pulse p
+000160b0: 6572 696f 642e 2020 4e6f 7465 2074 6861  eriod.  Note tha
+000160c0: 7420 7765 2772 6520 6e6f 7420 7061 7273  t we're not pars
+000160d0: 696e 6720 696e 746f 2034 302d 6269 740d  ing into 40-bit.
+000160e0: 0a20 2020 2020 2020 2023 2062 6563 6175  .        # becau
+000160f0: 7365 2074 6869 7320 696d 706c 656d 656e  se this implemen
+00016100: 7461 7469 6f6e 2069 7320 6861 7264 2d63  tation is hard-c
+00016110: 6f64 6564 2074 6f20 6569 7468 6572 2031  oded to either 1
+00016120: 3030 206f 7220 3130 3030 7573 0d0a 2020  00 or 1000us..  
+00016130: 2020 2020 2020 2320 2862 6f74 6820 6669        # (both fi
+00016140: 7474 696e 6720 7765 6c6c 2077 6974 6869  tting well withi
+00016150: 6e20 7569 6e74 3136 290d 0a20 2020 2020  n uint16)..     
+00016160: 2020 2072 6573 756c 7420 3d20 7365 6c66     result = self
+00016170: 2e73 6574 5f6d 6f64 5f70 6572 696f 645f  .set_mod_period_
+00016180: 7573 2870 6572 696f 645f 7573 290d 0a20  us(period_us).. 
+00016190: 2020 2020 2020 2023 2069 6620 7265 7375         # if resu
+000161a0: 6c74 2e64 6174 6120 6973 204e 6f6e 653a  lt.data is None:
+000161b0: 0d0a 2020 2020 2020 2020 2320 2020 2020  ..        #     
+000161c0: 6c6f 672e 6372 6974 6963 616c 2822 4861  log.critical("Ha
+000161d0: 7264 7761 7265 2046 6169 6c75 7265 2074  rdware Failure t
+000161e0: 6f20 7365 6e64 206c 6173 6572 206d 6f64  o send laser mod
+000161f0: 2e20 7075 6c73 6520 7065 7269 6f64 2229  . pulse period")
+00016200: 0d0a 2020 2020 2020 2020 2320 2020 2020  ..        #     
+00016210: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+00016220: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
+00016230: 3d46 616c 7365 2c65 7272 6f72 5f6d 7367  =False,error_msg
+00016240: 3d22 6661 696c 6564 2074 6f20 7365 6e64  ="failed to send
+00016250: 206c 6173 6572 206d 6f64 2229 0d0a 0d0a   laser mod")....
+00016260: 2020 2020 2020 2020 2320 5365 7420 7468          # Set th
+00016270: 6520 7075 6c73 6520 7769 6474 6820 746f  e pulse width to
+00016280: 2074 6865 2030 2d31 3030 2070 6572 6365   the 0-100 perce
+00016290: 6e74 6167 6520 6f66 2070 6f77 6572 0d0a  ntage of power..
+000162a0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+000162b0: 2073 656c 662e 7365 745f 6d6f 645f 7769   self.set_mod_wi
+000162c0: 6474 685f 7573 2877 6964 7468 5f75 7329  dth_us(width_us)
+000162d0: 0d0a 2020 2020 2020 2020 2320 6966 2072  ..        # if r
+000162e0: 6573 756c 742e 6461 7461 2069 7320 4e6f  esult.data is No
+000162f0: 6e65 3a0d 0a20 2020 2020 2020 2023 2020  ne:..        #  
+00016300: 2020 206c 6f67 2e63 7269 7469 6361 6c28     log.critical(
+00016310: 2248 6172 6477 6172 6520 4661 696c 7572  "Hardware Failur
+00016320: 6520 746f 2073 656e 6420 7075 6c73 6520  e to send pulse 
+00016330: 7769 6474 6822 290d 0a20 2020 2020 2020  width")..       
+00016340: 2023 2020 2020 2072 6574 7572 6e20 5370   #     return Sp
+00016350: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00016360: 7365 2864 6174 613d 4661 6c73 652c 6572  se(data=False,er
+00016370: 726f 725f 6d73 673d 2266 6169 6c65 6420  ror_msg="failed 
+00016380: 746f 2073 656e 6420 7075 6c73 6520 7769  to send pulse wi
+00016390: 6474 6822 290d 0a0d 0a20 2020 2020 2020  dth")....       
+000163a0: 2023 2045 6e61 626c 6520 6d6f 6475 6c61   # Enable modula
+000163b0: 7469 6f6e 0d0a 2020 2020 2020 2020 7265  tion..        re
+000163c0: 7375 6c74 203d 2073 656c 662e 7365 745f  sult = self.set_
+000163d0: 6d6f 645f 656e 6162 6c65 2854 7275 6529  mod_enable(True)
+000163e0: 0d0a 2020 2020 2020 2020 2320 6966 2072  ..        # if r
+000163f0: 6573 756c 742e 6461 7461 2069 7320 4e6f  esult.data is No
+00016400: 6e65 3a0d 0a20 2020 2020 2020 2023 2020  ne:..        #  
+00016410: 2020 206c 6f67 2e63 7269 7469 6361 6c28     log.critical(
+00016420: 2248 6172 6477 6172 6520 4661 696c 7572  "Hardware Failur
+00016430: 6520 746f 2073 656e 6420 6c61 7365 7220  e to send laser 
+00016440: 6d6f 6475 6c61 7469 6f6e 2229 0d0a 2020  modulation")..  
+00016450: 2020 2020 2020 2320 2020 2020 7265 7475        #     retu
+00016460: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+00016470: 6573 706f 6e73 6528 6461 7461 3d46 616c  esponse(data=Fal
+00016480: 7365 2c65 7272 6f72 5f6d 7367 3d22 6661  se,error_msg="fa
+00016490: 696c 6564 2074 6f20 7365 6e64 206c 6173  iled to send las
+000164a0: 6572 206d 6f64 756c 6174 696f 6e22 290d  er modulation").
+000164b0: 0a0d 0a20 2020 2020 2020 206c 6f67 2e64  ...        log.d
+000164c0: 6562 7567 2822 4c61 7365 7220 706f 7765  ebug("Laser powe
+000164d0: 7220 7365 7420 746f 3a20 2564 222c 2076  r set to: %d", v
+000164e0: 616c 7565 290d 0a0d 0a20 2020 2020 2020  alue)....       
+000164f0: 2073 656c 662e 6e65 7874 5f61 7070 6c69   self.next_appli
+00016500: 6564 5f6c 6173 6572 5f70 6f77 6572 203d  ed_laser_power =
+00016510: 2076 616c 7565 0d0a 2020 2020 2020 2020   value..        
+00016520: 6c6f 672e 6465 6275 6728 226e 6578 745f  log.debug("next_
+00016530: 6170 706c 6965 645f 6c61 7365 725f 706f  applied_laser_po
+00016540: 7765 7220 3d20 2573 222c 2073 656c 662e  wer = %s", self.
+00016550: 6e65 7874 5f61 7070 6c69 6564 5f6c 6173  next_applied_las
+00016560: 6572 5f70 6f77 6572 290d 0a0d 0a20 2020  er_power)....   
+00016570: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+00016580: 6c74 0d0a 0d0a 2020 2020 2323 0d0a 2020  lt....    ##..  
+00016590: 2020 2320 406e 6f74 6520 6e65 7665 7220    # @note never 
+000165a0: 7573 6564 2c20 7072 6f76 6964 6564 2066  used, provided f
+000165b0: 6f72 204f 454d 0d0a 2020 2020 6465 6620  or OEM..    def 
+000165c0: 6765 745f 6c61 7365 725f 7465 6d70 6572  get_laser_temper
+000165d0: 6174 7572 655f 7365 7470 6f69 6e74 5f72  ature_setpoint_r
+000165e0: 6177 2873 656c 6629 3a20 2320 2d3e 2053  aw(self): # -> S
+000165f0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00016600: 6e73 6520 0d0a 2020 2020 2020 2020 6966  nse ..        if
+00016610: 206e 6f74 2073 656c 662e 7365 7474 696e   not self.settin
+00016620: 6773 2e65 6570 726f 6d2e 6861 735f 6c61  gs.eeprom.has_la
+00016630: 7365 723a 0d0a 2020 2020 2020 2020 2020  ser:..          
+00016640: 2020 6c6f 672e 6572 726f 7228 2275 6e61    log.error("una
+00016650: 626c 6520 746f 2063 6f6e 7472 6f6c 206c  ble to control l
+00016660: 6173 6572 3a20 4545 5052 4f4d 2072 6570  aser: EEPROM rep
+00016670: 6f72 7473 206e 6f20 6c61 7365 7220 696e  orts no laser in
+00016680: 7374 616c 6c65 6422 290d 0a20 2020 2020  stalled")..     
+00016690: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
+000166a0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+000166b0: 7365 2864 6174 613d 4e6f 6e65 2c65 7272  se(data=None,err
+000166c0: 6f72 5f6d 7367 3d22 6e6f 206c 6173 6572  or_msg="no laser
+000166d0: 2069 6e73 7461 6c6c 6564 2229 0d0a 0d0a   installed")....
+000166e0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+000166f0: 2073 656c 662e 5f67 6574 5f63 6f64 6528   self._get_code(
+00016700: 3078 6538 2c20 6c61 6265 6c3d 2247 4554  0xe8, label="GET
+00016710: 5f4c 4153 4552 5f54 4543 5f53 4554 504f  _LASER_TEC_SETPO
+00016720: 494e 5422 290d 0a20 2020 2020 2020 2072  INT")..        r
+00016730: 6573 203d 2053 7065 6374 726f 6d65 7465  es = Spectromete
+00016740: 7252 6573 706f 6e73 6528 290d 0a20 2020  rResponse()..   
+00016750: 2020 2020 2072 6573 2e74 7261 6e73 6665       res.transfe
+00016760: 725f 7265 7370 6f6e 7365 2872 6573 756c  r_response(resul
+00016770: 7429 0d0a 2020 2020 2020 2020 7265 732e  t)..        res.
+00016780: 6461 7461 203d 2072 6573 756c 742e 6461  data = result.da
+00016790: 7461 5b30 5d0d 0a20 2020 2020 2020 2072  ta[0]..        r
+000167a0: 6574 7572 6e20 7265 730d 0a0d 0a20 2020  eturn res....   
+000167b0: 2064 6566 2073 6574 5f6c 6173 6572 5f74   def set_laser_t
+000167c0: 656d 7065 7261 7475 7265 5f73 6574 706f  emperature_setpo
+000167d0: 696e 745f 7261 7728 7365 6c66 2c20 7661  int_raw(self, va
+000167e0: 6c75 653a 2069 6e74 293a 2023 202d 3e20  lue: int): # -> 
+000167f0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+00016800: 6f6e 7365 200d 0a20 2020 2020 2020 206c  onse ..        l
+00016810: 6f67 2e64 6562 7567 2822 5365 6e64 206c  og.debug("Send l
+00016820: 6173 6572 2074 656d 7065 7261 7475 7265  aser temperature
+00016830: 2073 6574 706f 696e 7420 7261 773a 2025   setpoint raw: %
+00016840: 6422 2c20 7661 6c75 6529 0d0a 2020 2020  d", value)..    
+00016850: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00016860: 5f73 656e 645f 636f 6465 2830 7865 372c  _send_code(0xe7,
+00016870: 2076 616c 7565 2c20 6c61 6265 6c3d 2253   value, label="S
+00016880: 4554 5f4c 4153 4552 5f54 4543 5f53 4554  ET_LASER_TEC_SET
+00016890: 504f 494e 5422 290d 0a0d 0a20 2020 2064  POINT")....    d
+000168a0: 6566 2067 6574 5f6c 6173 6572 5f69 6e74  ef get_laser_int
+000168b0: 6572 6c6f 636b 2873 656c 6629 3a20 2320  erlock(self): # 
+000168c0: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+000168d0: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+000168e0: 2020 2222 2220 4c65 6761 6379 2077 7261    """ Legacy wra
+000168f0: 7070 6572 206f 7665 7220 6361 6e5f 6c61  pper over can_la
+00016900: 7365 725f 6669 7265 2e20 2222 220d 0a20  ser_fire. """.. 
+00016910: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00016920: 6c66 2e63 616e 5f6c 6173 6572 5f66 6972  lf.can_laser_fir
+00016930: 6528 290d 0a0d 0a20 2020 2064 6566 2063  e()....    def c
+00016940: 616e 5f6c 6173 6572 5f66 6972 6528 7365  an_laser_fire(se
+00016950: 6c66 293a 2023 202d 3e20 5370 6563 7472  lf): # -> Spectr
+00016960: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+00016970: 0a20 2020 2020 2020 2022 2222 0d0a 2020  .        """..  
+00016980: 2020 2020 2020 406e 6f74 6520 6f6e 6c79        @note only
+00016990: 2077 6f72 6b73 206f 6e20 4658 322d 6261   works on FX2-ba
+000169a0: 7365 6420 7370 6563 7472 6f6d 6574 6572  sed spectrometer
+000169b0: 7320 7769 7468 2046 5720 3e3d 2031 302e  s with FW >= 10.
+000169c0: 302e 302e 3131 0d0a 2020 2020 2020 2020  0.0.11..        
+000169d0: 4072 6574 7572 6e73 2054 7275 6520 6966  @returns True if
+000169e0: 2074 6865 7265 2069 7320 6120 6c61 7365   there is a lase
+000169f0: 7220 616e 6420 6569 7468 6572 2074 6865  r and either the
+00016a00: 2069 6e74 6572 6c6f 636b 2069 730d 0a20   interlock is.. 
+00016a10: 2020 2020 2020 2020 636c 6f73 6564 2028          closed (
+00016a20: 696e 2066 6972 696e 6720 706f 7369 7469  in firing positi
+00016a30: 6f6e 292c 206f 7220 7468 6572 6520 6973  on), or there is
+00016a40: 206e 6f20 7265 6164 6162 6c65 0d0a 2020   no readable..  
+00016a50: 2020 2020 2020 2069 6e74 6572 6c6f 636b         interlock
+00016a60: 0d0a 2020 2020 2020 2020 2222 220d 0a20  ..        """.. 
+00016a70: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00016a80: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+00016a90: 6f6d 2e68 6173 5f6c 6173 6572 3a0d 0a20  om.has_laser:.. 
+00016aa0: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
+00016ab0: 7272 6f72 2822 4545 5052 4f4d 2072 6570  rror("EEPROM rep
+00016ac0: 6f72 7473 206e 6f20 6c61 7365 7220 696e  orts no laser in
+00016ad0: 7374 616c 6c65 6422 290d 0a20 2020 2020  stalled")..     
+00016ae0: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
+00016af0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+00016b00: 7365 2864 6174 613d 4661 6c73 652c 6572  se(data=False,er
+00016b10: 726f 725f 6d73 673d 226e 6f20 6c61 7365  ror_msg="no lase
+00016b20: 7220 696e 7374 616c 6c65 6422 290d 0a0d  r installed")...
+00016b30: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00016b40: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00016b50: 7072 6f6d 2e68 6173 5f69 6e74 6572 6c6f  prom.has_interlo
+00016b60: 636b 5f66 6565 6462 6163 6b3a 0d0a 2020  ck_feedback:..  
+00016b70: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+00016b80: 6275 6728 2243 414e 5f4c 4153 4552 5f46  bug("CAN_LASER_F
+00016b90: 4952 4520 7265 7175 6972 6573 2068 6173  IRE requires has
+00016ba0: 5f69 6e74 6572 6c6f 636b 5f66 6565 6462  _interlock_feedb
+00016bb0: 6163 6b20 2864 6566 6175 6c74 696e 6720  ack (defaulting 
+00016bc0: 5472 7565 2922 290d 0a20 2020 2020 2020  True)")..       
+00016bd0: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
+00016be0: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00016bf0: 2864 6174 613d 5472 7565 290d 0a0d 0a20  (data=True).... 
+00016c00: 2020 2020 2020 2072 6573 203d 2073 656c         res = sel
+00016c10: 662e 5f67 6574 5f63 6f64 6528 3078 6566  f._get_code(0xef
+00016c20: 2c20 6c61 6265 6c3d 2243 414e 5f4c 4153  , label="CAN_LAS
+00016c30: 4552 5f46 4952 4522 2c20 6d73 625f 6c65  ER_FIRE", msb_le
+00016c40: 6e3d 3129 0d0a 2020 2020 2020 2020 7265  n=1)..        re
+00016c50: 732e 6461 7461 203d 2030 2021 3d20 7265  s.data = 0 != re
+00016c60: 732e 6461 7461 0d0a 2020 2020 2020 2020  s.data..        
+00016c70: 7265 7475 726e 2072 6573 0d0a 0d0a 2020  return res....  
+00016c80: 2020 6465 6620 6973 5f6c 6173 6572 5f66    def is_laser_f
+00016c90: 6972 696e 6728 7365 6c66 293a 2023 202d  iring(self): # -
+00016ca0: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+00016cb0: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+00016cc0: 2022 2222 0d0a 2020 2020 2020 2020 4368   """..        Ch
+00016cd0: 6563 6b20 6966 2074 6865 206c 6173 6572  eck if the laser
+00016ce0: 2061 6374 7561 6c6c 7920 4953 2066 6972   actually IS fir
+00016cf0: 696e 672c 2069 6e64 6570 656e 6465 6e74  ing, independent
+00016d00: 206f 6620 6c61 7365 725f 656e 6162 6c65   of laser_enable
+00016d10: 206f 7220 0d0a 2020 2020 2020 2020 6361   or ..        ca
+00016d20: 6e5f 6c61 7365 725f 6669 7265 2e0d 0a0d  n_laser_fire....
+00016d30: 0a20 2020 2020 2020 2040 7265 7475 726e  .        @return
+00016d40: 7320 5370 6563 7472 6f6d 6574 6572 5265  s SpectrometerRe
+00016d50: 7370 6f6e 7365 0d0a 2020 2020 2020 2020  sponse..        
+00016d60: 2222 220d 0a20 2020 2020 2020 2069 6620  """..        if 
+00016d70: 6e6f 7420 7365 6c66 2e73 6574 7469 6e67  not self.setting
+00016d80: 732e 6565 7072 6f6d 2e68 6173 5f69 6e74  s.eeprom.has_int
+00016d90: 6572 6c6f 636b 5f66 6565 6462 6163 6b3a  erlock_feedback:
+00016da0: 0d0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
+00016db0: 672e 6465 6275 6728 2249 535f 4c41 5345  g.debug("IS_LASE
+00016dc0: 525f 4649 5249 4e47 2072 6571 7569 7265  R_FIRING require
+00016dd0: 7320 6861 735f 696e 7465 726c 6f63 6b5f  s has_interlock_
+00016de0: 6665 6564 6261 636b 2028 6465 6661 756c  feedback (defaul
+00016df0: 7469 6e67 2074 6f20 6c61 7365 725f 656e  ting to laser_en
+00016e00: 6162 6c65 6429 2229 0d0a 2020 2020 2020  abled)")..      
+00016e10: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00016e20: 662e 6765 745f 6c61 7365 725f 656e 6162  f.get_laser_enab
+00016e30: 6c65 6428 290d 0a0d 0a20 2020 2020 2020  led()....       
+00016e40: 2072 6573 203d 2073 656c 662e 6765 745f   res = self.get_
+00016e50: 7570 7065 725f 636f 6465 2830 7830 642c  upper_code(0x0d,
+00016e60: 206c 6162 656c 3d22 4953 5f4c 4153 4552   label="IS_LASER
+00016e70: 5f46 4952 494e 4722 2c20 6d73 625f 6c65  _FIRING", msb_le
+00016e80: 6e3d 3129 0d0a 2020 2020 2020 2020 7265  n=1)..        re
+00016e90: 732e 6461 7461 203d 2030 2021 3d20 7265  s.data = 0 != re
+00016ea0: 732e 6461 7461 0d0a 2020 2020 2020 2020  s.data..        
+00016eb0: 7265 7475 726e 2072 6573 0d0a 0d0a 2020  return res....  
+00016ec0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+00016ed0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016ee0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016ef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016f00: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+00016f10: 2020 2020 2320 2865 6e64 206f 6620 6c61      # (end of la
+00016f20: 7365 7220 636f 6d6d 616e 6473 290d 0a20  ser commands).. 
+00016f30: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+00016f40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016f50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016f60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016f70: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+00016f80: 0a0d 0a20 2020 2064 6566 2072 6573 6574  ...    def reset
+00016f90: 5f66 7067 6128 7365 6c66 293a 2023 202d  _fpga(self): # -
+00016fa0: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+00016fb0: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+00016fc0: 206c 6f67 2e64 6562 7567 2822 6669 643a   log.debug("fid:
+00016fd0: 2072 6573 6574 7469 6e67 2046 5047 4122   resetting FPGA"
+00016fe0: 290d 0a20 2020 2020 2020 2072 6573 756c  )..        resul
+00016ff0: 7420 3d20 7365 6c66 2e5f 7365 6e64 5f63  t = self._send_c
+00017000: 6f64 6528 3078 6235 2c20 6c61 6265 6c3d  ode(0xb5, label=
+00017010: 2252 4553 4554 5f46 5047 4122 290d 0a20  "RESET_FPGA").. 
+00017020: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
+00017030: 2822 6669 643a 2073 6c65 6570 696e 6720  ("fid: sleeping 
+00017040: 3373 6563 2229 0d0a 2020 2020 2020 2020  3sec")..        
+00017050: 736c 6565 7028 3329 0d0a 2020 2020 2020  sleep(3)..      
+00017060: 2020 7265 7475 726e 2072 6573 756c 740d    return result.
+00017070: 0a0d 0a20 2020 2023 230d 0a20 2020 2023  ...    ##..    #
+00017080: 2052 6561 6420 7468 6520 7472 6967 6765   Read the trigge
+00017090: 7220 736f 7572 6365 2073 6574 7469 6e67  r source setting
+000170a0: 2066 726f 6d20 7468 6520 6465 7669 6365   from the device
+000170b0: 2e0d 0a20 2020 2023 0d0a 2020 2020 2320  ...    #..    # 
+000170c0: 2d20 3020 3d20 696e 7465 726e 616c 0d0a  - 0 = internal..
+000170d0: 2020 2020 2320 2d20 3120 3d20 6578 7465      # - 1 = exte
+000170e0: 726e 616c 0d0a 2020 2020 230d 0a20 2020  rnal..    #..   
+000170f0: 2023 2055 7365 2063 6175 7469 6f6e 2077   # Use caution w
+00017100: 6865 6e20 696e 7465 7270 7265 7469 6e67  hen interpreting
+00017110: 2074 6865 206c 6172 6765 7220 6265 6861   the larger beha
+00017120: 7669 6f72 206f 660d 0a20 2020 2023 2074  vior of..    # t
+00017130: 6865 2064 6576 6963 6520 6173 2041 524d  he device as ARM
+00017140: 2061 6e64 2046 5832 2069 6d70 6c65 6d65   and FX2 impleme
+00017150: 6e74 6174 696f 6e73 2064 6966 6665 7220  ntations differ 
+00017160: 6173 206f 6620 3230 3137 2d30 382d 3032  as of 2017-08-02
+00017170: 0d0a 2020 2020 230d 0a20 2020 2023 2040  ..    #..    # @
+00017180: 6e6f 7465 206e 6576 6572 2063 616c 6c65  note never calle
+00017190: 6420 6279 2045 4e4c 4947 4854 454e 202d  d by ENLIGHTEN -
+000171a0: 2070 726f 7669 6465 6420 666f 7220 4f45   provided for OE
+000171b0: 4d73 0d0a 2020 2020 6465 6620 6765 745f  Ms..    def get_
+000171c0: 7472 6967 6765 725f 736f 7572 6365 2873  trigger_source(s
+000171d0: 656c 6629 3a20 2320 2d3e 2053 7065 6374  elf): # -> Spect
+000171e0: 726f 6d65 7465 7252 6573 706f 6e73 6520  rometerResponse 
+000171f0: 0d0a 2020 2020 2020 2020 7661 6c75 6520  ..        value 
+00017200: 3d20 7365 6c66 2e5f 6765 745f 636f 6465  = self._get_code
+00017210: 2830 7864 332c 206c 6162 656c 3d22 4745  (0xd3, label="GE
+00017220: 545f 5452 4947 4745 525f 534f 5552 4345  T_TRIGGER_SOURCE
+00017230: 222c 206d 7362 5f6c 656e 3d31 290d 0a20  ", msb_len=1).. 
+00017240: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
+00017250: 696e 6773 2e73 7461 7465 2e74 7269 6767  ings.state.trigg
+00017260: 6572 5f73 6f75 7263 6520 3d20 7661 6c75  er_source = valu
+00017270: 652e 6461 7461 0d0a 2020 2020 2020 2020  e.data..        
+00017280: 7265 7475 726e 2076 616c 7565 0d0a 0d0a  return value....
+00017290: 2020 2020 2323 0d0a 2020 2020 2320 406e      ##..    # @n
+000172a0: 6f74 6520 6e6f 7420 6361 6c6c 6564 2062  ote not called b
+000172b0: 7920 454e 4c49 4748 5445 4e0d 0a20 2020  y ENLIGHTEN..   
+000172c0: 2023 2040 7761 726e 696e 6720 636f 6e66   # @warning conf
+000172d0: 6c69 6374 7320 7769 7468 2047 4554 5f53  licts with GET_S
+000172e0: 454c 4543 5445 445f 4c41 5345 520d 0a20  ELECTED_LASER.. 
+000172f0: 2020 2064 6566 2067 6574 5f72 616d 616e     def get_raman
+00017300: 5f6d 6f64 655f 656e 6162 6c65 645f 4e4f  _mode_enabled_NO
+00017310: 545f 5553 4544 2873 656c 6629 3a20 2320  T_USED(self): # 
+00017320: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+00017330: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+00017340: 2020 7265 7320 3d20 7365 6c66 2e67 6574    res = self.get
+00017350: 5f75 7070 6572 5f63 6f64 6528 3078 3135  _upper_code(0x15
+00017360: 2c20 6c61 6265 6c3d 2247 4554 5f52 414d  , label="GET_RAM
+00017370: 414e 5f4d 4f44 455f 454e 4142 4c45 4422  AN_MODE_ENABLED"
+00017380: 2c20 6d73 625f 6c65 6e3d 3129 0d0a 2020  , msb_len=1)..  
+00017390: 2020 2020 2020 7265 732e 6461 7461 203d        res.data =
+000173a0: 2030 2021 3d20 7265 732e 6461 7461 0d0a   0 != res.data..
+000173b0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+000173c0: 6573 0d0a 0d0a 2020 2020 2323 0d0a 2020  es....    ##..  
+000173d0: 2020 2320 456e 6162 6c65 2022 5261 6d61    # Enable "Rama
+000173e0: 6e20 6d6f 6465 2220 2861 7574 6f6d 6174  n mode" (automat
+000173f0: 6963 206c 6173 6572 2920 696e 2074 6865  ic laser) in the
+00017400: 2073 7065 6374 726f 6d65 7465 7220 6669   spectrometer fi
+00017410: 726d 7761 7265 2e0d 0a20 2020 2064 6566  rmware...    def
+00017420: 2073 6574 5f72 616d 616e 5f6d 6f64 655f   set_raman_mode_
+00017430: 656e 6162 6c65 5f4e 4f54 5f55 5345 4428  enable_NOT_USED(
+00017440: 7365 6c66 2c20 666c 6167 3a20 626f 6f6c  self, flag: bool
+00017450: 293a 2023 202d 3e20 5370 6563 7472 6f6d  ): # -> Spectrom
+00017460: 6574 6572 5265 7370 6f6e 7365 200d 0a20  eterResponse .. 
+00017470: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00017480: 6c66 2e73 6574 7469 6e67 732e 6973 5f6d  lf.settings.is_m
+00017490: 6963 726f 2829 3a0d 0a20 2020 2020 2020  icro():..       
+000174a0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
+000174b0: 5261 6d61 6e20 6d6f 6465 206f 6e6c 7920  Raman mode only 
+000174c0: 7375 7070 6f72 7465 6420 6f6e 2053 6572  supported on Ser
+000174d0: 6965 732d 5853 2229 0d0a 2020 2020 2020  ies-XS")..      
+000174e0: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
+000174f0: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+00017500: 6528 6461 7461 3d46 616c 7365 2c65 7272  e(data=False,err
+00017510: 6f72 5f6d 7367 3d22 7261 6d61 6e20 6d6f  or_msg="raman mo
+00017520: 6465 206e 6f74 2073 7570 706f 7274 6564  de not supported
+00017530: 2229 0d0a 0d0a 2020 2020 2020 2020 7265  ")....        re
+00017540: 7475 726e 2073 656c 662e 5f73 656e 645f  turn self._send_
+00017550: 636f 6465 2862 5265 7175 6573 7420 2020  code(bRequest   
+00017560: 2020 2020 203d 2030 7866 662c 0d0a 2020       = 0xff,..  
+00017570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017580: 2020 2020 2020 2020 2020 2020 7756 616c              wVal
+00017590: 7565 2020 2020 2020 2020 2020 3d20 3078  ue          = 0x
+000175a0: 3136 2c0d 0a20 2020 2020 2020 2020 2020  16,..           
+000175b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175c0: 2020 2077 496e 6465 7820 2020 2020 2020     wIndex       
+000175d0: 2020 203d 2031 2069 6620 666c 6167 2065     = 1 if flag e
+000175e0: 6c73 6520 302c 0d0a 2020 2020 2020 2020  lse 0,..        
+000175f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017600: 2020 2020 2020 6461 7461 5f6f 725f 774c        data_or_wL
+00017610: 656e 6774 6820 3d20 5b30 5d20 2a20 382c  ength = [0] * 8,
+00017620: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00017630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017640: 6c61 6265 6c20 2020 2020 2020 2020 2020  label           
+00017650: 3d20 2253 4554 5f52 414d 414e 5f4d 4f44  = "SET_RAMAN_MOD
+00017660: 455f 454e 4142 4c45 2229 0d0a 0d0a 2020  E_ENABLE")....  
+00017670: 2020 6465 6620 6765 745f 7261 6d61 6e5f    def get_raman_
+00017680: 6465 6c61 795f 6d73 2873 656c 6629 3a20  delay_ms(self): 
+00017690: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+000176a0: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+000176b0: 2020 2020 7265 7320 3d20 7365 6c66 2e67      res = self.g
+000176c0: 6574 5f75 7070 6572 5f63 6f64 6528 3078  et_upper_code(0x
+000176d0: 3139 2c20 6c61 6265 6c3d 2247 4554 5f52  19, label="GET_R
+000176e0: 414d 414e 5f44 454c 4159 5f4d 5322 2c20  AMAN_DELAY_MS", 
+000176f0: 6d73 625f 6c65 6e3d 3229 0d0a 2020 2020  msb_len=2)..    
+00017700: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
+00017710: 732e 7374 6174 652e 7261 6d61 6e5f 6465  s.state.raman_de
+00017720: 6c61 795f 6d73 203d 2072 6573 2e64 6174  lay_ms = res.dat
+00017730: 610d 0a20 2020 2020 2020 2072 6574 7572  a..        retur
+00017740: 6e20 7265 730d 0a0d 0a20 2020 2064 6566  n res....    def
+00017750: 2073 6574 5f72 616d 616e 5f64 656c 6179   set_raman_delay
+00017760: 5f6d 7328 7365 6c66 2c20 6d73 3a20 696e  _ms(self, ms: in
+00017770: 7429 3a20 2320 2d3e 2053 7065 6374 726f  t): # -> Spectro
+00017780: 6d65 7465 7252 6573 706f 6e73 6520 0d0a  meterResponse ..
+00017790: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+000177a0: 656c 662e 7365 7474 696e 6773 2e69 735f  elf.settings.is_
+000177b0: 6d69 6372 6f28 293a 0d0a 2020 2020 2020  micro():..      
+000177c0: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+000177d0: 2252 616d 616e 2064 656c 6179 206f 6e6c  "Raman delay onl
+000177e0: 7920 7375 7070 6f72 7465 6420 6f6e 2053  y supported on S
+000177f0: 6572 6965 732d 5853 2229 0d0a 2020 2020  eries-XS")..    
+00017800: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00017810: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00017820: 6e73 6528 6461 7461 3d46 616c 7365 2c65  nse(data=False,e
+00017830: 7272 6f72 5f6d 7367 3d22 7261 6d61 6e20  rror_msg="raman 
+00017840: 6465 6c61 7920 6e6f 7420 7375 7070 6f72  delay not suppor
+00017850: 7465 6422 290d 0a0d 0a20 2020 2020 2020  ted")....       
+00017860: 2023 2073 656e 6420 7661 6c75 6520 6173   # send value as
+00017870: 2062 6967 2d65 6e64 6961 6e0d 0a20 2020   big-endian..   
+00017880: 2020 2020 206d 7362 203d 2028 6d73 203e       msb = (ms >
+00017890: 3e20 3829 2026 2030 7866 660d 0a20 2020  > 8) & 0xff..   
+000178a0: 2020 2020 206c 7362 203d 2020 6d73 2020       lsb =  ms  
+000178b0: 2020 2020 2026 2030 7866 660d 0a20 2020       & 0xff..   
+000178c0: 2020 2020 2076 616c 7565 203d 2028 6d73       value = (ms
+000178d0: 6220 3c3c 2038 2920 7c20 6c73 620d 0a0d  b << 8) | lsb...
+000178e0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+000178f0: 7474 696e 6773 2e73 7461 7465 2e72 616d  ttings.state.ram
+00017900: 616e 5f64 656c 6179 5f6d 7320 3d20 6d73  an_delay_ms = ms
+00017910: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00017920: 2073 656c 662e 5f73 656e 645f 636f 6465   self._send_code
+00017930: 2862 5265 7175 6573 7420 2020 2020 2020  (bRequest       
+00017940: 203d 2030 7866 662c 0d0a 2020 2020 2020   = 0xff,..      
+00017950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017960: 2020 2020 2020 2020 7756 616c 7565 2020          wValue  
+00017970: 2020 2020 2020 2020 3d20 3078 3230 2c0d          = 0x20,.
+00017980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017990: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000179a0: 496e 6465 7820 2020 2020 2020 2020 203d  Index          =
+000179b0: 2076 616c 7565 2c0d 0a20 2020 2020 2020   value,..       
+000179c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179d0: 2020 2020 2020 2064 6174 615f 6f72 5f77         data_or_w
+000179e0: 4c65 6e67 7468 203d 205b 305d 202a 2038  Length = [0] * 8
+000179f0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00017a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a10: 206c 6162 656c 2020 2020 2020 2020 2020   label          
+00017a20: 203d 2022 5345 545f 5241 4d41 4e5f 4445   = "SET_RAMAN_DE
+00017a30: 4c41 595f 4d53 2229 0d0a 0d0a 2020 2020  LAY_MS")....    
+00017a40: 6465 6620 6765 745f 6c61 7365 725f 7761  def get_laser_wa
+00017a50: 7463 6864 6f67 5f73 6563 2873 656c 6629  tchdog_sec(self)
+00017a60: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+00017a70: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+00017a80: 2020 2020 2020 7265 7320 3d20 7365 6c66        res = self
+00017a90: 2e67 6574 5f75 7070 6572 5f63 6f64 6528  .get_upper_code(
+00017aa0: 3078 3137 2c20 6c61 6265 6c3d 2247 4554  0x17, label="GET
+00017ab0: 5f4c 4153 4552 5f57 4154 4348 444f 475f  _LASER_WATCHDOG_
+00017ac0: 5345 4322 2c20 6d73 625f 6c65 6e3d 3229  SEC", msb_len=2)
+00017ad0: 0d0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+00017ae0: 6574 7469 6e67 732e 7374 6174 652e 6c61  ettings.state.la
+00017af0: 7365 725f 7761 7463 6864 6f67 5f73 6563  ser_watchdog_sec
+00017b00: 203d 2072 6573 2e64 6174 610d 0a20 2020   = res.data..   
+00017b10: 2020 2020 2072 6574 7572 6e20 7265 730d       return res.
+00017b20: 0a0d 0a20 2020 2023 2040 6e6f 7465 2075  ...    # @note u
+00017b30: 6e74 696c 2074 6869 7320 6368 616e 6765  ntil this change
+00017b40: 2069 7320 6d69 6d69 636b 2764 2069 6e20   is mimick'd in 
+00017b50: 7468 6520 5354 4d33 3220 2861 6e64 2061  the STM32 (and a
+00017b60: 6674 6572 2074 6861 742c 2075 6e74 696c  fter that, until
+00017b70: 2074 6865 2046 5047 410d 0a20 2020 2023   the FPGA..    #
+00017b80: 2020 2020 2020 206c 6f67 6963 2069 7473         logic its
+00017b90: 656c 6620 6973 2066 6978 6564 292c 2061  elf is fixed), a
+00017ba0: 6c77 6179 7320 7365 6e64 2061 2044 4953  lways send a DIS
+00017bb0: 4142 4c45 5f4c 4153 4552 2062 6566 6f72  ABLE_LASER befor
+00017bc0: 6520 6368 616e 6769 6e67 2074 6865 200d  e changing the .
+00017bd0: 0a20 2020 2023 2020 2020 2020 2077 6174  .    #       wat
+00017be0: 6368 646f 6720 7065 7269 6f64 2e0d 0a20  chdog period... 
+00017bf0: 2020 2064 6566 2073 6574 5f6c 6173 6572     def set_laser
+00017c00: 5f77 6174 6368 646f 675f 7365 6328 7365  _watchdog_sec(se
+00017c10: 6c66 2c20 7365 6329 3a0d 0a20 2020 2020  lf, sec):..     
+00017c20: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
+00017c30: 6574 7469 6e67 732e 6973 5f6d 6963 726f  ettings.is_micro
+00017c40: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
+00017c50: 206c 6f67 2e65 7272 6f72 2822 4c61 7365   log.error("Lase
+00017c60: 7220 7761 7463 6864 6f67 206f 6e6c 7920  r watchdog only 
+00017c70: 7375 7070 6f72 7465 6420 6f6e 2053 6572  supported on Ser
+00017c80: 6965 732d 5853 2229 0d0a 2020 2020 2020  ies-XS")..      
+00017c90: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
+00017ca0: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+00017cb0: 6528 6461 7461 3d46 616c 7365 2c65 7272  e(data=False,err
+00017cc0: 6f72 5f6d 7367 3d22 6c61 7365 7220 7761  or_msg="laser wa
+00017cd0: 7463 6864 6f67 206e 6f74 2073 7570 706f  tchdog not suppo
+00017ce0: 7274 6564 2229 0d0a 0d0a 2020 2020 2020  rted")....      
+00017cf0: 2020 6966 2028 2866 6d74 203a 3d20 7365    if ((fmt := se
+00017d00: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+00017d10: 6f6d 2e66 6f72 6d61 7429 203c 2031 3529  om.format) < 15)
+00017d20: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
+00017d30: 6f67 2e69 6e66 6f28 6622 4545 5052 4f4d  og.info(f"EEPROM
+00017d40: 2066 6f72 6d61 7420 7b66 6d74 7d20 646f   format {fmt} do
+00017d50: 6573 206e 6f74 2073 7570 706f 7274 206c  es not support l
+00017d60: 6173 6572 2077 6174 6368 646f 6722 290d  aser watchdog").
+00017d70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00017d80: 7572 6e0d 0a0d 0a20 2020 2020 2020 2023  urn....        #
+00017d90: 2072 656d 6f76 6520 7468 6973 2063 616c   remove this cal
+00017da0: 6c20 6166 7465 7220 7468 6520 5365 7269  l after the Seri
+00017db0: 6573 2d58 5320 4152 4d20 2f20 4650 4741  es-XS ARM / FPGA
+00017dc0: 2077 6174 6368 646f 6720 6172 6520 6669   watchdog are fi
+00017dd0: 7865 640d 0a20 2020 2020 2020 2023 204d  xed..        # M
+00017de0: 5a3a 2061 7265 2074 6865 7920 6669 7865  Z: are they fixe
+00017df0: 643f 2063 616e 2049 2072 656d 6f76 6520  d? can I remove 
+00017e00: 7468 6973 3f0d 0a20 2020 2020 2020 2073  this?..        s
+00017e10: 656c 662e 7365 745f 6c61 7365 725f 656e  elf.set_laser_en
+00017e20: 6162 6c65 2846 616c 7365 290d 0a0d 0a20  able(False).... 
+00017e30: 2020 2020 2020 2023 2073 656e 6420 7661         # send va
+00017e40: 6c75 6520 6173 2062 6967 2d65 6e64 6961  lue as big-endia
+00017e50: 6e0d 0a20 2020 2020 2020 206d 7362 203d  n..        msb =
+00017e60: 2028 7365 6320 3e3e 2038 2920 2620 3078   (sec >> 8) & 0x
+00017e70: 6666 0d0a 2020 2020 2020 2020 6c73 6220  ff..        lsb 
+00017e80: 3d20 2073 6563 2020 2020 2020 2026 2030  =  sec       & 0
+00017e90: 7866 660d 0a20 2020 2020 2020 2076 616c  xff..        val
+00017ea0: 7565 203d 2028 6d73 6220 3c3c 2038 2920  ue = (msb << 8) 
+00017eb0: 7c20 6c73 620d 0a0d 0a20 2020 2020 2020  | lsb....       
+00017ec0: 2073 656c 662e 7365 7474 696e 6773 2e73   self.settings.s
+00017ed0: 7461 7465 2e6c 6173 6572 5f77 6174 6368  tate.laser_watch
+00017ee0: 646f 675f 7365 6320 3d20 7365 630d 0a20  dog_sec = sec.. 
+00017ef0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00017f00: 6c66 2e5f 7365 6e64 5f63 6f64 6528 6252  lf._send_code(bR
+00017f10: 6571 7565 7374 2020 2020 2020 2020 3d20  equest        = 
+00017f20: 3078 6666 2c0d 0a20 2020 2020 2020 2020  0xff,..         
+00017f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f40: 2020 2020 2077 5661 6c75 6520 2020 2020       wValue     
+00017f50: 2020 2020 203d 2030 7831 382c 0d0a 2020       = 0x18,..  
+00017f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f70: 2020 2020 2020 2020 2020 2020 7749 6e64              wInd
+00017f80: 6578 2020 2020 2020 2020 2020 3d20 7661  ex          = va
+00017f90: 6c75 652c 0d0a 2020 2020 2020 2020 2020  lue,..          
+00017fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fb0: 2020 2020 6461 7461 5f6f 725f 774c 656e      data_or_wLen
+00017fc0: 6774 6820 3d20 5b30 5d20 2a20 382c 0d0a  gth = [0] * 8,..
+00017fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fe0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00017ff0: 6265 6c20 2020 2020 2020 2020 2020 3d20  bel           = 
+00018000: 2253 4554 5f4c 4153 4552 5f57 4154 4348  "SET_LASER_WATCH
+00018010: 444f 475f 5345 4322 290d 0a0d 0a20 2020  DOG_SEC")....   
+00018020: 2064 6566 2075 7064 6174 655f 6c61 7365   def update_lase
+00018030: 725f 7761 7463 6864 6f67 2873 656c 6629  r_watchdog(self)
+00018040: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+00018050: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+00018060: 2020 2020 2020 2222 220d 0a20 2020 2020        """..     
+00018070: 2020 2041 7574 6f6d 6174 6963 616c 6c79     Automatically
+00018080: 2073 6574 2074 6865 206c 6173 6572 2077   set the laser w
+00018090: 6174 6368 646f 6720 6c6f 6e67 2065 6e6f  atchdog long eno
+000180a0: 7567 6820 746f 2068 616e 646c 6520 7468  ugh to handle th
+000180b0: 6520 6375 7272 656e 740d 0a20 2020 2020  e current..     
+000180c0: 2020 2069 6e74 6567 7261 7469 6f6e 2074     integration t
+000180d0: 696d 652c 2061 7373 756d 696e 6720 7765  ime, assuming we
+000180e0: 2068 6176 6520 746f 2070 6572 666f 726d   have to perform
+000180f0: 2036 2074 6872 6f77 6177 6179 7320 6f6e   6 throwaways on
+00018100: 2074 6865 2073 656e 736f 720d 0a20 2020   the sensor..   
+00018110: 2020 2020 2069 6e20 6361 7365 2069 7420       in case it 
+00018120: 7765 6e74 2074 6f20 736c 6565 702e 0d0a  went to sleep...
+00018130: 0d0a 2020 2020 2020 2020 406e 6f74 6520  ..        @note 
+00018140: 7765 2061 7265 206e 6f74 2063 7572 7265  we are not curre
+00018150: 6e74 6c79 2075 7369 6e67 2074 6869 7320  ntly using this 
+00018160: 6675 6e63 7469 6f6e 0d0a 2020 2020 2020  function..      
+00018170: 2020 2222 220d 0a20 2020 2020 2020 2069    """..        i
+00018180: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
+00018190: 6e67 732e 6973 5f6d 6963 726f 2829 206f  ngs.is_micro() o
+000181a0: 7220 6e6f 7420 7365 6c66 2e73 6574 7469  r not self.setti
+000181b0: 6e67 732e 6565 7072 6f6d 2e68 6173 5f6c  ngs.eeprom.has_l
+000181c0: 6173 6572 3a0d 0a20 2020 2020 2020 2020  aser:..         
+000181d0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+000181e0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+000181f0: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
+00018200: 6d73 673d 2275 7064 6174 6520 6c61 7365  msg="update lase
+00018210: 7220 7761 7463 6864 6f67 206e 6f74 2073  r watchdog not s
+00018220: 7570 706f 7274 6564 2229 0d0a 0d0a 2020  upported")....  
+00018230: 2020 2020 2020 696e 745f 6d73 203d 2073        int_ms = s
+00018240: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+00018250: 7465 2e69 6e74 6567 7261 7469 6f6e 5f74  te.integration_t
+00018260: 696d 655f 6d73 0d0a 2020 2020 2020 2020  ime_ms..        
+00018270: 7363 616e 7320 203d 2073 656c 662e 7365  scans  = self.se
+00018280: 7474 696e 6773 2e73 7461 7465 2e73 6361  ttings.state.sca
+00018290: 6e73 5f74 6f5f 6176 6572 6167 650d 0a20  ns_to_average.. 
+000182a0: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
+000182b0: 2074 6872 6f77 6177 6179 735f 7365 6320   throwaways_sec 
+000182c0: 3d20 696e 745f 6d73 202a 2028 3820 2b20  = int_ms * (8 + 
+000182d0: 7363 616e 7329 202f 2031 3030 302e 300d  scans) / 1000.0.
+000182e0: 0a20 2020 2020 2020 2077 6174 6368 646f  .        watchdo
+000182f0: 675f 7365 6320 3d20 696e 7428 6d61 7828  g_sec = int(max(
+00018300: 3130 2c20 7468 726f 7761 7761 7973 5f73  10, throwaways_s
+00018310: 6563 2929 202a 2032 0d0a 2020 2020 2020  ec)) * 2..      
+00018320: 2020 6c6f 672e 6465 6275 6728 6622 7570    log.debug(f"up
+00018330: 6461 7469 6e67 206c 6173 6572 2077 6174  dating laser wat
+00018340: 6368 646f 6720 746f 207b 7761 7463 6864  chdog to {watchd
+00018350: 6f67 5f73 6563 7d20 6261 7365 6420 6f6e  og_sec} based on
+00018360: 2069 6e74 6567 7261 7469 6f6e 2074 696d   integration tim
+00018370: 6520 7b69 6e74 5f6d 737d 6d73 2061 6e64  e {int_ms}ms and
+00018380: 207b 7363 616e 737d 2061 7665 7261 6769   {scans} averagi
+00018390: 6e67 2229 0d0a 0d0a 2020 2020 2020 2020  ng")....        
+000183a0: 7265 7475 726e 2073 656c 662e 7365 745f  return self.set_
+000183b0: 6c61 7365 725f 7761 7463 6864 6f67 5f73  laser_watchdog_s
+000183c0: 6563 2877 6174 6368 646f 675f 7365 6329  ec(watchdog_sec)
+000183d0: 0d0a 0d0a 2020 2020 6465 6620 7365 745f  ....    def set_
+000183e0: 7665 7274 6963 616c 5f62 696e 6e69 6e67  vertical_binning
+000183f0: 2873 656c 662c 206c 696e 6573 3a20 7475  (self, lines: tu
+00018400: 706c 655b 696e 742c 2069 6e74 5d29 3a20  ple[int, int]): 
+00018410: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+00018420: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+00018430: 2020 2020 2320 6368 6563 6b20 666f 7220      # check for 
+00018440: 6c65 6761 6379 2076 6973 2073 696e 6365  legacy vis since
+00018450: 2074 6865 7920 646f 6e27 7420 6c69 6b65   they don't like
+00018460: 2076 6572 7469 6361 6c20 6269 6e6e 696e   vertical binnin
+00018470: 670d 0a20 2020 2020 2020 2069 6620 7365  g..        if se
+00018480: 6c66 2e73 6574 7469 6e67 732e 6670 6761  lf.settings.fpga
+00018490: 5f66 6972 6d77 6172 655f 7665 7273 696f  _firmware_versio
+000184a0: 6e20 3d3d 2022 3030 302d 3030 3822 2061  n == "000-008" a
+000184b0: 6e64 2073 656c 662e 7365 7474 696e 6773  nd self.settings
+000184c0: 2e6d 6963 726f 636f 6e74 726f 6c6c 6572  .microcontroller
+000184d0: 5f66 6972 6d77 6172 655f 7665 7273 696f  _firmware_versio
+000184e0: 6e20 3d3d 2022 302e 312e 302e 3722 3a0d  n == "0.1.0.7":.
+000184f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00018500: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00018510: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
+00018520: 6c73 6529 0d0a 2020 2020 2020 2020 6966  lse)..        if
+00018530: 206e 6f74 2073 656c 662e 7365 7474 696e   not self.settin
+00018540: 6773 2e69 735f 6d69 6372 6f28 293a 0d0a  gs.is_micro():..
+00018550: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+00018560: 6465 6275 6728 2256 6572 7469 6361 6c20  debug("Vertical 
+00018570: 4269 6e6e 696e 6720 6f6e 6c79 2063 6f6e  Binning only con
+00018580: 6669 6775 7261 626c 6520 6f6e 2053 6572  figurable on Ser
+00018590: 6965 732d 5853 2229 0d0a 2020 2020 2020  ies-XS")..      
+000185a0: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
+000185b0: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+000185c0: 6528 6461 7461 3d46 616c 7365 2c65 7272  e(data=False,err
+000185d0: 6f72 5f6d 7367 3d22 7665 7274 6963 616c  or_msg="vertical
+000185e0: 2062 696e 6e69 6e67 206e 6f74 2073 7570   binning not sup
+000185f0: 706f 7274 6564 2229 0d0a 0d0a 2020 2020  ported")....    
+00018600: 2020 2020 7472 793a 0d0a 2020 2020 2020      try:..      
+00018610: 2020 2020 2020 7374 6172 7420 3d20 6c69        start = li
+00018620: 6e65 735b 305d 0d0a 2020 2020 2020 2020  nes[0]..        
+00018630: 2020 2020 656e 6420 2020 3d20 6c69 6e65      end   = line
+00018640: 735b 315d 0d0a 2020 2020 2020 2020 6578  s[1]..        ex
+00018650: 6365 7074 3a0d 0a20 2020 2020 2020 2020  cept:..         
+00018660: 2020 206c 6f67 2e65 7272 6f72 2822 7365     log.error("se
+00018670: 745f 7665 7274 6963 616c 5f62 696e 6e69  t_vertical_binni
+00018680: 6e67 2072 6571 7569 7265 7320 6120 7475  ng requires a tu
+00018690: 706c 6520 6f66 2028 7374 6172 742c 2073  ple of (start, s
+000186a0: 746f 7029 206c 696e 6573 2229 0d0a 2020  top) lines")..  
+000186b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000186c0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+000186d0: 706f 6e73 6528 6461 7461 3d46 616c 7365  ponse(data=False
+000186e0: 2c65 7272 6f72 5f6d 7367 3d22 696e 7661  ,error_msg="inva
+000186f0: 6c69 6420 7374 6172 7420 616e 6420 7374  lid start and st
+00018700: 6f70 206c 696e 6573 2229 0d0a 0d0a 2020  op lines")....  
+00018710: 2020 2020 2020 6966 2073 7461 7274 203c        if start <
+00018720: 2030 206f 7220 656e 6420 3c20 303a 0d0a   0 or end < 0:..
+00018730: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+00018740: 6572 726f 7228 2273 6574 5f76 6572 7469  error("set_verti
+00018750: 6361 6c5f 6269 6e6e 696e 6720 7265 7175  cal_binning requ
+00018760: 6972 6573 2061 2074 7570 6c65 206f 6620  ires a tuple of 
+00018770: 504f 5349 5449 5645 2028 7374 6172 742c  POSITIVE (start,
+00018780: 2073 746f 7029 206c 696e 6573 2229 0d0a   stop) lines")..
+00018790: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000187a0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+000187b0: 6573 706f 6e73 6528 6461 7461 3d46 616c  esponse(data=Fal
+000187c0: 7365 2c65 7272 6f72 5f6d 7367 3d22 696e  se,error_msg="in
+000187d0: 7661 6c69 6420 7374 6172 7420 616e 6420  valid start and 
+000187e0: 7374 6f70 206c 696e 6573 2229 0d0a 0d0a  stop lines")....
+000187f0: 2020 2020 2020 2020 2320 656e 666f 7263          # enforc
+00018800: 6520 6173 6365 6e64 696e 6720 6f72 6465  e ascending orde
+00018810: 7220 2861 6c73 6f2c 206e 6f74 6520 7468  r (also, note th
+00018820: 6174 2073 746f 7020 6c69 6e65 2069 7320  at stop line is 
+00018830: 226c 6173 7420 6c69 6e65 2062 696e 6e65  "last line binne
+00018840: 6420 2b20 3122 2c20 736f 2073 746f 7020  d + 1", so stop 
+00018850: 6d75 7374 2062 6520 3e20 7374 6172 7429  must be > start)
+00018860: 0d0a 2020 2020 2020 2020 6966 2073 7461  ..        if sta
+00018870: 7274 203e 3d20 656e 643a 0d0a 2020 2020  rt >= end:..    
+00018880: 2020 2020 2020 2020 2320 2873 7461 7274          # (start
+00018890: 2c20 656e 6429 203d 2028 656e 642c 2073  , end) = (end, s
+000188a0: 7461 7274 290d 0a20 2020 2020 2020 2020  tart)..         
+000188b0: 2020 206c 6f67 2e65 7272 6f72 2822 7365     log.error("se
+000188c0: 745f 7665 7274 6963 616c 5f62 696e 6e69  t_vertical_binni
+000188d0: 6e67 2072 6571 7569 7265 7320 6173 6365  ng requires asce
+000188e0: 6e64 696e 6720 6f72 6465 7220 2869 676e  nding order (ign
+000188f0: 6f72 696e 6720 2564 2c20 2564 2922 2c20  oring %d, %d)", 
+00018900: 7374 6172 742c 2065 6e64 290d 0a20 2020  start, end)..   
+00018910: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00018920: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+00018930: 6f6e 7365 2864 6174 613d 4661 6c73 652c  onse(data=False,
+00018940: 6572 726f 725f 6d73 673d 2269 6e76 616c  error_msg="inval
+00018950: 6964 2073 7461 7274 2061 6e64 2073 746f  id start and sto
+00018960: 7020 6c69 6e65 7322 290d 0a0d 0a20 2020  p lines")....   
+00018970: 2020 2020 206f 6b31 203d 2073 656c 662e       ok1 = self.
+00018980: 5f73 656e 645f 636f 6465 2862 5265 7175  _send_code(bRequ
+00018990: 6573 7420 2020 2020 2020 203d 2030 7866  est        = 0xf
+000189a0: 662c 0d0a 2020 2020 2020 2020 2020 2020  f,..            
+000189b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189c0: 2077 5661 6c75 6520 2020 2020 2020 2020   wValue         
+000189d0: 203d 2030 7832 312c 0d0a 2020 2020 2020   = 0x21,..      
+000189e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189f0: 2020 2020 2020 2077 496e 6465 7820 2020         wIndex   
+00018a00: 2020 2020 2020 203d 2073 7461 7274 2c0d         = start,.
+00018a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018a20: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00018a30: 7461 5f6f 725f 774c 656e 6774 6820 3d20  ta_or_wLength = 
+00018a40: 5b30 5d20 2a20 382c 0d0a 2020 2020 2020  [0] * 8,..      
+00018a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a60: 2020 2020 2020 206c 6162 656c 2020 2020         label    
+00018a70: 2020 2020 2020 203d 2022 5345 545f 4343         = "SET_CC
+00018a80: 445f 5354 4152 545f 4c49 4e45 2229 0d0a  D_START_LINE")..
+00018a90: 2020 2020 2020 2020 6966 206f 6b31 2e65          if ok1.e
+00018aa0: 7272 6f72 5f6d 7367 2021 3d20 2727 3a0d  rror_msg != '':.
+00018ab0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00018ac0: 7572 6e20 6f6b 310d 0a0d 0a20 2020 2020  urn ok1....     
+00018ad0: 2020 206f 6b32 203d 2073 656c 662e 5f73     ok2 = self._s
+00018ae0: 656e 645f 636f 6465 2862 5265 7175 6573  end_code(bReques
+00018af0: 7420 2020 2020 2020 203d 2030 7866 662c  t        = 0xff,
+00018b00: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018b10: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00018b20: 5661 6c75 6520 2020 2020 2020 2020 203d  Value          =
+00018b30: 2030 7832 332c 0d0a 2020 2020 2020 2020   0x23,..        
+00018b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b50: 2020 2020 2077 496e 6465 7820 2020 2020       wIndex     
+00018b60: 2020 2020 203d 2065 6e64 2c0d 0a20 2020       = end,..   
+00018b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b80: 2020 2020 2020 2020 2020 6461 7461 5f6f            data_o
+00018b90: 725f 774c 656e 6774 6820 3d20 5b30 5d20  r_wLength = [0] 
+00018ba0: 2a20 382c 0d0a 2020 2020 2020 2020 2020  * 8,..          
+00018bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bc0: 2020 206c 6162 656c 2020 2020 2020 2020     label        
+00018bd0: 2020 203d 2022 5345 545f 4343 445f 5354     = "SET_CCD_ST
+00018be0: 4f50 5f4c 494e 4522 290d 0a20 2020 2020  OP_LINE")..     
+00018bf0: 2020 2069 6620 6f6b 322e 6572 726f 725f     if ok2.error_
+00018c00: 6d73 6720 213d 2027 273a 0d0a 2020 2020  msg != '':..    
+00018c10: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+00018c20: 6b32 0d0a 2020 2020 2020 2020 7265 7475  k2..        retu
+00018c30: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+00018c40: 6573 706f 6e73 6528 6461 7461 3d6f 6b31  esponse(data=ok1
+00018c50: 2e64 6174 6120 616e 6420 6f6b 322e 6461  .data and ok2.da
+00018c60: 7461 290d 0a0d 0a20 2020 2023 2320 0d0a  ta)....    ## ..
+00018c70: 2020 2020 2320 4070 6172 616d 7320 6d6f      # @params mo
+00018c80: 6465 3a20 696e 7465 6772 616c 2076 616c  de: integral val
+00018c90: 7565 2030 2d33 0d0a 2020 2020 230d 0a20  ue 0-3..    #.. 
+00018ca0: 2020 2023 205c 7665 7262 6f73 650d 0a20     # \verbose.. 
+00018cb0: 2020 2023 206d 6f64 6520 2041 4443 2028     # mode  ADC (
+00018cc0: 4144 2920 2020 5069 7865 6c20 5769 6474  AD)   Pixel Widt
+00018cd0: 6820 284f 4429 0d0a 2020 2020 2320 6230  h (OD)..    # b0
+00018ce0: 3020 2020 3130 2d62 6974 2020 2020 2031  0   10-bit     1
+00018cf0: 302d 6269 740d 0a20 2020 2023 2062 3031  0-bit..    # b01
+00018d00: 2020 2031 302d 6269 7420 2020 2020 3132     10-bit     12
+00018d10: 2d62 6974 0d0a 2020 2020 2320 6231 3020  -bit..    # b10 
+00018d20: 2020 3132 2d62 6974 2020 2020 2031 302d    12-bit     10-
+00018d30: 6269 740d 0a20 2020 2023 2062 3131 2020  bit..    # b11  
+00018d40: 2031 322d 6269 7420 2020 2020 3132 2d62   12-bit     12-b
+00018d50: 6974 0d0a 2020 2020 2320 5c65 6e64 7665  it..    # \endve
+00018d60: 7262 6f73 650d 0a20 2020 2064 6566 2073  rbose..    def s
+00018d70: 6574 5f70 6978 656c 5f6d 6f64 6528 7365  et_pixel_mode(se
+00018d80: 6c66 2c20 6d6f 6465 3a20 666c 6f61 7429  lf, mode: float)
+00018d90: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+00018da0: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+00018db0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+00018dc0: 662e 7365 7474 696e 6773 2e69 735f 6d69  f.settings.is_mi
+00018dd0: 6372 6f28 293a 0d0a 2020 2020 2020 2020  cro():..        
+00018de0: 2020 2020 6c6f 672e 6465 6275 6728 2250      log.debug("P
+00018df0: 6978 656c 204d 6f64 6520 6f6e 6c79 2063  ixel Mode only c
+00018e00: 6f6e 6669 6775 7261 626c 6520 6f6e 2053  onfigurable on S
+00018e10: 6572 6965 732d 5853 2229 0d0a 2020 2020  eries-XS")..    
+00018e20: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00018e30: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00018e40: 6e73 6528 6461 7461 3d46 616c 7365 2c65  nse(data=False,e
+00018e50: 7272 6f72 5f6d 7367 3d22 7069 7865 6c20  rror_msg="pixel 
+00018e60: 6d6f 6465 206e 6f74 2073 7570 706f 7274  mode not support
+00018e70: 6564 2229 0d0a 0d0a 2020 2020 2020 2020  ed")....        
+00018e80: 2320 7765 206f 6e6c 7920 6361 7265 2061  # we only care a
+00018e90: 626f 7574 2074 6865 2074 776f 206c 6561  bout the two lea
+00018ea0: 7374 2d73 6967 6e69 6669 6361 6e74 2062  st-significant b
+00018eb0: 6974 730d 0a20 2020 2020 2020 206d 6f64  its..        mod
+00018ec0: 6520 3d20 696e 7428 726f 756e 6428 6d6f  e = int(round(mo
+00018ed0: 6465 2929 2026 2030 7833 200d 0a0d 0a20  de)) & 0x3 .... 
+00018ee0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00018ef0: 7365 6c66 2e5f 7365 6e64 5f63 6f64 6528  self._send_code(
+00018f00: 6252 6571 7565 7374 203d 2030 7866 642c  bRequest = 0xfd,
+00018f10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f30: 2020 7756 616c 7565 2020 203d 206d 6f64    wValue   = mod
+00018f40: 652c 0d0a 2020 2020 2020 2020 2020 2020  e,..            
+00018f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f60: 2020 2020 6c61 6265 6c20 2020 203d 2022      label    = "
+00018f70: 5345 545f 5049 5845 4c5f 4d4f 4445 2229  SET_PIXEL_MODE")
+00018f80: 0d0a 0d0a 2020 2020 2020 2020 6c6f 672e  ....        log.
+00018f90: 6465 6275 6728 2277 6169 7469 6e67 2031  debug("waiting 1
+00018fa0: 7365 632e 2e2e 2229 0d0a 2020 2020 2020  sec...")..      
+00018fb0: 2020 736c 6565 7028 3129 0d0a 0d0a 2020    sleep(1)....  
+00018fc0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00018fd0: 756c 740d 0a0d 0a20 2020 2064 6566 2063  ult....    def c
+00018fe0: 6c65 6172 5f72 6567 696f 6e73 2873 656c  lear_regions(sel
+00018ff0: 6629 3a20 2320 2d3e 2053 7065 6374 726f  f): # -> Spectro
+00019000: 6d65 7465 7252 6573 706f 6e73 6520 0d0a  meterResponse ..
+00019010: 2020 2020 2020 2020 7831 203d 2073 656c          x1 = sel
+00019020: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+00019030: 6d2e 6163 7469 7665 5f70 6978 656c 735f  m.active_pixels_
+00019040: 686f 7269 7a6f 6e74 616c 0d0a 2020 2020  horizontal..    
+00019050: 2020 2020 7931 203d 2073 656c 662e 7365      y1 = self.se
+00019060: 7474 696e 6773 2e65 6570 726f 6d2e 6163  ttings.eeprom.ac
+00019070: 7469 7665 5f70 6978 656c 735f 7665 7274  tive_pixels_vert
+00019080: 6963 616c 0d0a 2020 2020 2020 2020 6c6f  ical..        lo
+00019090: 672e 6465 6275 6728 6622 7265 7365 7474  g.debug(f"resett
+000190a0: 696e 6773 2064 6574 6563 746f 7220 746f  ings detector to
+000190b0: 2066 756c 6c20 287b 7831 7d2c 207b 7931   full ({x1}, {y1
+000190c0: 7d29 2065 7874 656e 7422 290d 0a0d 0a20  }) extent").... 
+000190d0: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
+000190e0: 696e 6773 2e73 7461 7465 2e72 6567 696f  ings.state.regio
+000190f0: 6e20 3d20 4e6f 6e65 0d0a 2020 2020 2020  n = None..      
+00019100: 2020 7365 6c66 2e73 6574 7469 6e67 732e    self.settings.
+00019110: 7570 6461 7465 5f77 6176 6563 616c 2829  update_wavecal()
+00019120: 0d0a 0d0a 2020 2020 2020 2020 7265 7475  ....        retu
+00019130: 726e 2073 656c 662e 7365 745f 6465 7465  rn self.set_dete
+00019140: 6374 6f72 5f72 6f69 285b 302c 2030 2c20  ctor_roi([0, 0, 
+00019150: 7931 2c20 302c 2078 315d 2c20 7374 6f72  y1, 0, x1], stor
+00019160: 653d 4661 6c73 6529 0d0a 0d0a 2020 2020  e=False)....    
+00019170: 6465 6620 7365 745f 7369 6e67 6c65 5f72  def set_single_r
+00019180: 6567 696f 6e28 7365 6c66 2c20 6e3a 2069  egion(self, n: i
+00019190: 6e74 293a 2023 202d 3e20 5370 6563 7472  nt): # -> Spectr
+000191a0: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+000191b0: 0a20 2020 2020 2020 2022 2222 0d0a 2020  .        """..  
+000191c0: 2020 2020 2020 5468 6973 2066 756e 6374        This funct
+000191d0: 696f 6e20 7573 6573 2074 6865 2074 6865  ion uses the the
+000191e0: 206d 756c 7469 2d72 6567 696f 6e20 6665   multi-region fe
+000191f0: 6174 7572 6520 746f 2073 656c 6563 7420  ature to select 
+00019200: 6a75 7374 2061 2073 696e 676c 6520 0d0a  just a single ..
+00019210: 2020 2020 2020 2020 7072 652d 636f 6e66          pre-conf
+00019220: 6967 7572 6564 2072 6567 696f 6e20 6174  igured region at
+00019230: 2061 2074 696d 652e 2020 5768 6963 6865   a time.  Whiche
+00019240: 7665 7220 7265 6769 6f6e 2069 7320 7365  ver region is se
+00019250: 6c65 6374 6564 2c20 7468 6174 200d 0a20  lected, that .. 
+00019260: 2020 2020 2020 2072 6567 696f 6e27 7320         region's 
+00019270: 7061 7261 6d65 7465 7273 2061 7265 2077  parameters are w
+00019280: 7269 7474 656e 2074 6f20 2272 6567 696f  ritten to "regio
+00019290: 6e20 3022 206f 6620 7468 6520 7370 6563  n 0" of the spec
+000192a0: 7472 6f6d 6574 6572 2c20 616e 640d 0a20  trometer, and.. 
+000192b0: 2020 2020 2020 2074 6865 2067 6c6f 6261         the globa
+000192c0: 6c20 7761 7665 6361 6c20 6973 2075 7064  l wavecal is upd
+000192d0: 6174 6564 2074 6f20 7573 6520 7468 6174  ated to use that
+000192e0: 2072 6567 696f 6e27 7320 6361 6c69 6272   region's calibr
+000192f0: 6174 696f 6e2e 0d0a 2020 2020 2020 200d  ation...       .
+00019300: 0a20 2020 2020 2020 2040 746f 646f 2063  .        @todo c
+00019310: 6f6e 7369 6465 7220 636c 6561 725f 7265  onsider clear_re
+00019320: 6769 6f6e 2829 2066 756e 6374 696f 6e20  gion() function 
+00019330: 746f 2072 6573 746f 7265 2070 6879 7369  to restore physi
+00019340: 6361 6c20 524f 4920 746f 200d 0a20 2020  cal ROI to ..   
+00019350: 2020 2020 2020 2020 2028 302c 2061 6374           (0, act
+00019360: 6976 655f 7665 7274 6963 616c 5f70 6978  ive_vertical_pix
+00019370: 656c 732c 2030 2c20 6163 7469 7665 5f68  els, 0, active_h
+00019380: 6f72 697a 6f6e 7461 6c5f 7069 7865 6c73  orizontal_pixels
+00019390: 290d 0a20 2020 2020 2020 2020 2020 2028  )..            (
+000193a0: 6c65 6176 6520 7761 7665 6361 6c20 616c  leave wavecal al
+000193b0: 6f6e 653f 290d 0a20 2020 2020 2020 2022  one?)..        "
+000193c0: 2222 0d0a 2020 2020 2020 2020 6966 2073  ""..        if s
+000193d0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+000193e0: 7465 2e64 6574 6563 746f 725f 7265 6769  te.detector_regi
+000193f0: 6f6e 7320 6973 204e 6f6e 653a 0d0a 2020  ons is None:..  
+00019400: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+00019410: 6275 6728 6622 6e6f 2064 6574 6563 746f  bug(f"no detecto
+00019420: 7220 7265 6769 6f6e 7320 636f 6e66 6967  r regions config
+00019430: 7572 6564 2229 0d0a 2020 2020 2020 2020  ured")..        
+00019440: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
+00019450: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
+00019460: 6461 7461 3d46 616c 7365 2c65 7272 6f72  data=False,error
+00019470: 5f6d 7367 3d22 6e6f 2072 6567 696f 6e73  _msg="no regions
+00019480: 2063 6f6e 6669 6775 7265 6422 290d 0a0d   configured")...
+00019490: 0a20 2020 2020 2020 2072 6f69 203d 2073  .        roi = s
+000194a0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+000194b0: 7465 2e64 6574 6563 746f 725f 7265 6769  te.detector_regi
+000194c0: 6f6e 732e 6765 745f 726f 6928 6e29 0d0a  ons.get_roi(n)..
+000194d0: 2020 2020 2020 2020 6966 2072 6f69 2069          if roi i
+000194e0: 7320 4e6f 6e65 3a0d 0a20 2020 2020 2020  s None:..       
+000194f0: 2020 2020 206c 6f67 2e64 6562 7567 2866       log.debug(f
+00019500: 2275 6e63 6f6e 6669 6775 7265 6420 7265  "unconfigured re
+00019510: 6769 6f6e 207b 6e7d 2028 6d61 7820 7b73  gion {n} (max {s
+00019520: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
+00019530: 726f 6d2e 7265 6769 6f6e 5f63 6f75 6e74  rom.region_count
+00019540: 7d22 290d 0a20 2020 2020 2020 2020 2020  }")..           
+00019550: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+00019560: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+00019570: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
+00019580: 673d 2275 6e63 6f6e 6669 6775 7265 6420  g="unconfigured 
+00019590: 7265 6769 6f6e 2229 0d0a 0d0a 2020 2020  region")....    
+000195a0: 2020 2020 6c6f 672e 6465 6275 6728 6622      log.debug(f"
+000195b0: 7365 745f 7369 6e67 6c65 5f72 6567 696f  set_single_regio
+000195c0: 6e3a 2061 7070 6c79 696e 6720 7265 6769  n: applying regi
+000195d0: 6f6e 207b 6e7d 3a20 7b72 6f69 7d22 290d  on {n}: {roi}").
+000195e0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+000195f0: 7474 696e 6773 2e73 6574 5f73 696e 676c  ttings.set_singl
+00019600: 655f 7265 6769 6f6e 286e 290d 0a0d 0a20  e_region(n).... 
+00019610: 2020 2020 2020 2023 2073 656e 6420 6120         # send a 
+00019620: 2266 616b 6522 2052 4f49 2064 6f77 6e73  "fake" ROI downs
+00019630: 7472 6561 6d2c 206f 7665 7272 6964 696e  tream, overridin
+00019640: 6720 746f 2070 6f73 6974 696f 6e20 300d  g to position 0.
+00019650: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00019660: 745f 6465 7465 6374 6f72 5f72 6f69 285b  t_detector_roi([
+00019670: 302c 2072 6f69 2e79 302c 2072 6f69 2e79  0, roi.y0, roi.y
+00019680: 312c 2072 6f69 2e78 302c 2072 6f69 2e78  1, roi.x0, roi.x
+00019690: 315d 2c20 7374 6f72 653d 4661 6c73 6529  1], store=False)
+000196a0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000196b0: 2053 7053 7065 6374 726f 6d65 7465 7252   SpSpectrometerR
+000196c0: 6573 706f 6e73 6528 290d 0a0d 0a20 2020  esponse()....   
+000196d0: 2064 6566 2073 6574 5f64 6574 6563 746f   def set_detecto
+000196e0: 725f 726f 6928 7365 6c66 2c20 6172 6773  r_roi(self, args
+000196f0: 3a20 6c69 7374 5b66 6c6f 6174 5d2c 2073  : list[float], s
+00019700: 746f 7265 3a20 626f 6f6c 203d 2054 7275  tore: bool = Tru
+00019710: 6529 3a20 2320 2d3e 2053 7065 6374 726f  e): # -> Spectro
+00019720: 6d65 7465 7252 6573 706f 6e73 6520 0d0a  meterResponse ..
+00019730: 2020 2020 2020 2020 2222 220d 0a20 2020          """..   
+00019740: 2020 2020 204e 6f74 6520 7468 6973 206f       Note this o
+00019750: 6e6c 7920 7365 6e64 7320 7468 6520 524f  nly sends the RO
+00019760: 4920 646f 776e 7374 7265 616d 2074 6f20  I downstream to 
+00019770: 7468 6520 7370 6563 7472 6f6d 6574 6572  the spectrometer
+00019780: 2028 616e 6420 7374 6f72 6573 0d0a 2020   (and stores..  
+00019790: 2020 2020 2020 6974 2069 6e20 4465 7465        it in Dete
+000197a0: 6374 6f72 5265 6769 6f6e 7329 2e20 2049  ctorRegions).  I
+000197b0: 6620 796f 7520 7761 6e74 2074 6f20 7570  f you want to up
+000197c0: 6461 7465 2074 6865 2077 6176 6563 616c  date the wavecal
+000197d0: 2061 6e64 2073 746f 7265 0d0a 2020 2020   and store..    
+000197e0: 2020 2020 7468 6520 2273 656c 6563 7465      the "selecte
+000197f0: 6422 2072 6567 696f 6e20 696e 6465 782c  d" region index,
+00019800: 2075 7365 2073 6574 5f72 6567 696f 6e28   use set_region(
+00019810: 2920 696e 7374 6561 6420 2877 6869 6368  ) instead (which
+00019820: 2063 616c 6c73 2074 6869 7329 2e0d 0a20   calls this)... 
+00019830: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
+00019840: 2059 6f75 2073 686f 756c 6420 7573 6520   You should use 
+00019850: 7365 745f 7265 6769 6f6e 2829 2069 6620  set_region() if 
+00019860: 796f 7520 6172 6520 7365 6c65 6374 696e  you are selectin
+00019870: 6720 6f6e 6520 6f66 2074 6865 2073 7461  g one of the sta
+00019880: 6e64 6172 640d 0a20 2020 2020 2020 2072  ndard..        r
+00019890: 6567 696f 6e73 2061 6c72 6561 6479 2063  egions already c
+000198a0: 6f6e 6669 6775 7265 6420 6f6e 2074 6865  onfigured on the
+000198b0: 2045 4550 524f 4d2e 2020 596f 7520 7368   EEPROM.  You sh
+000198c0: 6f75 6c64 2075 7365 2073 6574 5f64 6574  ould use set_det
+000198d0: 6563 746f 725f 726f 6928 290d 0a20 2020  ector_roi()..   
+000198e0: 2020 2020 2069 6620 796f 7527 7265 206d       if you're m
+000198f0: 616b 696e 6720 6164 2d68 6f63 2052 4f49  aking ad-hoc ROI
+00019900: 7320 7768 6963 6820 6172 656e 2774 2063  s which aren't c
+00019910: 6f6e 6669 6775 7265 6420 6f6e 2074 6865  onfigured on the
+00019920: 2045 4550 524f 4d2e 0d0a 2020 2020 2020   EEPROM...      
+00019930: 2020 0d0a 2020 2020 2020 2020 4070 6172    ..        @par
+00019940: 616d 2061 7267 733a 2065 6974 6865 7220  am args: either 
+00019950: 6120 4465 7465 6374 6f72 524f 4920 6f72  a DetectorROI or
+00019960: 2061 2074 7570 6c65 206f 6620 2872 6567   a tuple of (reg
+00019970: 696f 6e2c 2079 302c 2079 312c 2078 302c  ion, y0, y1, x0,
+00019980: 2078 3129 0d0a 2020 2020 2020 2020 2222   x1)..        ""
+00019990: 220d 0a20 2020 2020 2020 2069 6620 6e6f  "..        if no
+000199a0: 7420 7365 6c66 2e73 6574 7469 6e67 732e  t self.settings.
+000199b0: 6973 5f6d 6963 726f 2829 3a0d 0a20 2020  is_micro():..   
+000199c0: 2020 2020 2020 2020 206c 6f67 2e64 6562           log.deb
+000199d0: 7567 2822 4465 7465 6374 6f72 2052 4f49  ug("Detector ROI
+000199e0: 206f 6e6c 7920 636f 6e66 6967 7572 6162   only configurab
+000199f0: 6c65 206f 6e20 5365 7269 6573 2d58 5322  le on Series-XS"
+00019a00: 290d 0a20 2020 2020 2020 2020 2020 2072  )..            r
+00019a10: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+00019a20: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+00019a30: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
+00019a40: 2244 6574 6563 746f 7220 524f 4920 6e6f  "Detector ROI no
+00019a50: 7420 636f 6e66 6967 7572 6162 6c65 2229  t configurable")
+00019a60: 0d0a 0d0a 2020 2020 2020 2020 6966 2069  ....        if i
+00019a70: 7369 6e73 7461 6e63 6528 6172 6773 2c20  sinstance(args, 
+00019a80: 4465 7465 6374 6f72 524f 4929 3a0d 0a20  DetectorROI):.. 
+00019a90: 2020 2020 2020 2020 2020 2072 6f69 203d             roi =
+00019aa0: 2061 7267 730d 0a20 2020 2020 2020 2020   args..         
+00019ab0: 2020 206c 6f67 2e64 6562 7567 2866 2270     log.debug(f"p
+00019ac0: 6173 7365 6420 4465 7465 6374 6f72 524f  assed DetectorRO
+00019ad0: 493a 207b 726f 697d 2229 0d0a 2020 2020  I: {roi}")..    
+00019ae0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+00019af0: 2020 2020 2020 2023 2063 6f6e 7665 7274         # convert
+00019b00: 2061 7267 7320 746f 2052 4f49 0d0a 2020   args to ROI..  
+00019b10: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+00019b20: 6275 6728 6622 6372 6561 7469 6e67 2044  bug(f"creating D
+00019b30: 6574 6563 746f 7252 4f49 2066 726f 6d20  etectorROI from 
+00019b40: 6172 6773 3a20 7b61 7267 737d 2229 0d0a  args: {args}")..
+00019b50: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00019b60: 206c 656e 2861 7267 7329 2021 3d20 353a   len(args) != 5:
+00019b70: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00019b80: 2020 6c6f 672e 6572 726f 7228 6622 696e    log.error(f"in
+00019b90: 7661 6c69 6420 6465 7465 6374 6f72 2072  valid detector r
+00019ba0: 6f69 2061 7267 733a 207b 6172 6773 7d22  oi args: {args}"
+00019bb0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00019bc0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+00019bd0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+00019be0: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
+00019bf0: 6d73 673d 2269 6e76 616c 6964 2072 6f69  msg="invalid roi
+00019c00: 2061 7267 7322 290d 0a0d 0a20 2020 2020   args")....     
+00019c10: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
+00019c20: 696e 7428 726f 756e 6428 6172 6773 5b30  int(round(args[0
+00019c30: 5d29 290d 0a20 2020 2020 2020 2020 2020  ]))..           
+00019c40: 2079 3020 2020 2020 3d20 696e 7428 726f   y0     = int(ro
+00019c50: 756e 6428 6172 6773 5b31 5d29 290d 0a20  und(args[1])).. 
+00019c60: 2020 2020 2020 2020 2020 2079 3120 2020             y1   
+00019c70: 2020 3d20 696e 7428 726f 756e 6428 6172    = int(round(ar
+00019c80: 6773 5b32 5d29 290d 0a20 2020 2020 2020  gs[2]))..       
+00019c90: 2020 2020 2078 3020 2020 2020 3d20 696e       x0     = in
+00019ca0: 7428 726f 756e 6428 6172 6773 5b33 5d29  t(round(args[3])
+00019cb0: 290d 0a20 2020 2020 2020 2020 2020 2078  )..            x
+00019cc0: 3120 2020 2020 3d20 696e 7428 726f 756e  1     = int(roun
+00019cd0: 6428 6172 6773 5b34 5d29 290d 0a0d 0a20  d(args[4])).... 
+00019ce0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00019cf0: 7420 2830 203c 3d20 7265 6769 6f6e 203c  t (0 <= region <
+00019d00: 3d20 3320 616e 6420 5c0d 0a20 2020 2020  = 3 and \..     
+00019d10: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00019d20: 3020 3c20 7931 2061 6e64 205c 0d0a 2020  0 < y1 and \..  
+00019d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d40: 2020 7830 203c 2078 3120 616e 6420 5c0d    x0 < x1 and \.
+00019d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019d60: 2020 2020 2079 3020 3e3d 2030 2061 6e64       y0 >= 0 and
+00019d70: 205c 0d0a 2020 2020 2020 2020 2020 2020   \..            
+00019d80: 2020 2020 2020 2020 7830 203e 3d20 3020          x0 >= 0 
+00019d90: 616e 6420 5c0d 0a20 2020 2020 2020 2020  and \..         
+00019da0: 2020 2020 2020 2020 2020 2079 3120 3c3d             y1 <=
+00019db0: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
+00019dc0: 6570 726f 6d2e 6163 7469 7665 5f70 6978  eprom.active_pix
+00019dd0: 656c 735f 686f 7269 7a6f 6e74 616c 2061  els_horizontal a
+00019de0: 6e64 205c 0d0a 2020 2020 2020 2020 2020  nd \..          
+00019df0: 2020 2020 2020 2020 2020 7831 203c 3d20            x1 <= 
+00019e00: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+00019e10: 7072 6f6d 2e61 6374 6976 655f 7069 7865  prom.active_pixe
+00019e20: 6c73 5f68 6f72 697a 6f6e 7461 6c29 3a0d  ls_horizontal):.
+00019e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019e40: 206c 6f67 2e65 7272 6f72 2866 2269 6e76   log.error(f"inv
+00019e50: 616c 6964 2064 6574 6563 746f 7220 726f  alid detector ro
+00019e60: 693a 207b 6172 6773 7d22 290d 0a20 2020  i: {args}")..   
+00019e70: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00019e80: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+00019e90: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
+00019ea0: 6c73 652c 6572 726f 725f 6d73 673d 2269  lse,error_msg="i
+00019eb0: 6e76 616c 6964 2072 6f69 2061 7267 7322  nvalid roi args"
+00019ec0: 290d 0a20 2020 2020 2020 2020 2020 2072  )..            r
+00019ed0: 6f69 203d 2044 6574 6563 746f 7252 4f49  oi = DetectorROI
+00019ee0: 2872 6567 696f 6e2c 2079 302c 2079 312c  (region, y0, y1,
+00019ef0: 2078 302c 2078 3129 0d0a 2020 2020 2020   x0, x1)..      
+00019f00: 2020 2020 2020 6c6f 672e 6465 6275 6728        log.debug(
+00019f10: 6622 6372 6561 7465 6420 4465 7465 6374  f"created Detect
+00019f20: 6f72 524f 493a 207b 726f 697d 2229 0d0a  orROI: {roi}")..
+00019f30: 0d0a 2020 2020 2020 2020 2320 6465 7465  ..        # dete
+00019f40: 726d 696e 6520 7072 6576 696f 7573 2074  rmine previous t
+00019f50: 6f74 616c 2070 6978 656c 730d 0a20 2020  otal pixels..   
+00019f60: 2020 2020 2073 656c 662e 7072 6576 5f70       self.prev_p
+00019f70: 6978 656c 7320 3d20 7365 6c66 2e73 6574  ixels = self.set
+00019f80: 7469 6e67 732e 7069 7865 6c73 2829 0d0a  tings.pixels()..
+00019f90: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
+00019fa0: 6728 6622 7072 6576 5f70 6978 656c 7320  g(f"prev_pixels 
+00019fb0: 3d20 7b73 656c 662e 7072 6576 5f70 6978  = {self.prev_pix
+00019fc0: 656c 737d 2229 0d0a 0d0a 2020 2020 2020  els}")....      
+00019fd0: 2020 6966 2073 746f 7265 3a0d 0a20 2020    if store:..   
+00019fe0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00019ff0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
+0001a000: 6465 7465 6374 6f72 5f72 6567 696f 6e73  detector_regions
+0001a010: 2069 7320 4e6f 6e65 3a0d 0a20 2020 2020   is None:..     
+0001a020: 2020 2020 2020 2020 2020 206c 6f67 2e64             log.d
+0001a030: 6562 7567 2822 6372 6561 7469 6e67 2044  ebug("creating D
+0001a040: 6574 6563 746f 7252 6567 696f 6e73 2229  etectorRegions")
+0001a050: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001a060: 2020 7365 6c66 2e73 6574 7469 6e67 732e    self.settings.
+0001a070: 7374 6174 652e 6465 7465 6374 6f72 5f72  state.detector_r
+0001a080: 6567 696f 6e73 203d 2044 6574 6563 746f  egions = Detecto
+0001a090: 7252 6567 696f 6e73 2829 0d0a 0d0a 2020  rRegions()....  
+0001a0a0: 2020 2020 2020 2020 2020 2320 7468 6973            # this
+0001a0b0: 2069 7320 6120 6e6f 2d6f 7020 6966 2069   is a no-op if i
+0001a0c0: 7427 7320 616c 7265 6164 7920 7072 6573  t's already pres
+0001a0d0: 656e 7420 616e 6420 756e 6368 616e 6765  ent and unchange
+0001a0e0: 640d 0a20 2020 2020 2020 2020 2020 206c  d..            l
+0001a0f0: 6f67 2e64 6562 7567 2822 7361 7669 6e67  og.debug("saving
+0001a100: 2044 6574 6563 746f 7252 4f49 2069 6e20   DetectorROI in 
+0001a110: 4465 7465 6374 6f72 5265 6769 6f6e 7322  DetectorRegions"
+0001a120: 290d 0a20 2020 2020 2020 2020 2020 2073  )..            s
+0001a130: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
+0001a140: 7465 2e64 6574 6563 746f 725f 7265 6769  te.detector_regi
+0001a150: 6f6e 732e 6164 6428 726f 6929 0d0a 0d0a  ons.add(roi)....
+0001a160: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
+0001a170: 6728 6622 746f 7461 6c5f 7069 7865 6c73  g(f"total_pixels
+0001a180: 206e 6f77 207b 7365 6c66 2e73 6574 7469   now {self.setti
+0001a190: 6e67 732e 7069 7865 6c73 2829 7d22 290d  ngs.pixels()}").
+0001a1a0: 0a0d 0a20 2020 2020 2020 2062 7566 203d  ...        buf =
+0001a1b0: 2075 7469 6c73 2e75 696e 7431 365f 746f   utils.uint16_to
+0001a1c0: 5f6c 6974 746c 655f 656e 6469 616e 285b  _little_endian([
+0001a1d0: 2072 6f69 2e79 302c 2072 6f69 2e79 312c   roi.y0, roi.y1,
+0001a1e0: 2072 6f69 2e78 302c 2072 6f69 2e78 3120   roi.x0, roi.x1 
+0001a1f0: 5d29 0d0a 2020 2020 2020 2020 6c6f 672e  ])..        log.
+0001a200: 6465 6275 6728 2277 6f75 6c64 2073 656e  debug("would sen
+0001a210: 6420 6275 663a 2025 7322 2c20 6275 6629  d buf: %s", buf)
+0001a220: 0d0a 0d0a 2020 2020 2020 2020 7265 7375  ....        resu
+0001a230: 6c74 203d 2073 656c 662e 5f73 656e 645f  lt = self._send_
+0001a240: 636f 6465 2862 5265 7175 6573 7420 2020  code(bRequest   
+0001a250: 2020 2020 203d 2030 7866 662c 0d0a 2020       = 0xff,..  
+0001a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a270: 2020 2020 2020 2020 2020 2020 2020 7756                wV
+0001a280: 616c 7565 2020 2020 2020 2020 2020 3d20  alue          = 
+0001a290: 3078 3235 2c0d 0a20 2020 2020 2020 2020  0x25,..         
+0001a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2b0: 2020 2020 2020 2077 496e 6465 7820 2020         wIndex   
+0001a2c0: 2020 2020 2020 203d 2072 6f69 2e72 6567         = roi.reg
+0001a2d0: 696f 6e2c 0d0a 2020 2020 2020 2020 2020  ion,..          
+0001a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2f0: 2020 2020 2020 6461 7461 5f6f 725f 774c        data_or_wL
+0001a300: 656e 6774 6820 3d20 6275 662c 0d0a 2020  ength = buf,..  
+0001a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a320: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0001a330: 6265 6c20 2020 2020 2020 2020 2020 3d20  bel           = 
+0001a340: 2253 4554 5f44 4554 4543 544f 525f 524f  "SET_DETECTOR_RO
+0001a350: 4922 290d 0a0d 0a20 2020 2020 2020 206c  I")....        l
+0001a360: 6f67 2e64 6562 7567 2822 7761 6974 696e  og.debug("waitin
+0001a370: 6720 3173 6563 2e2e 2e22 290d 0a20 2020  g 1sec...")..   
+0001a380: 2020 2020 2073 6c65 6570 2831 290d 0a0d       sleep(1)...
+0001a390: 0a20 2020 2020 2020 2023 204a 7573 7420  .        # Just 
+0001a3a0: 696e 2063 6173 652c 2066 6c6f 7773 2074  in case, flows t
+0001a3b0: 6865 2075 7064 6174 6564 2044 6574 6563  he updated Detec
+0001a3c0: 746f 7252 6567 696f 6e73 206f 626a 6563  torRegions objec
+0001a3d0: 7420 7570 7374 7265 616d 0d0a 2020 2020  t upstream..    
+0001a3e0: 2020 2020 2320 736f 2063 616c 6c65 7220      # so caller 
+0001a3f0: 6861 7320 6163 6365 7373 2074 6f20 6974  has access to it
+0001a400: 2e0d 0a20 2020 2020 2020 2069 6620 7374  ...        if st
+0001a410: 6f72 653a 0d0a 2020 2020 2020 2020 2020  ore:..          
+0001a420: 2020 7365 6c66 2e71 7565 7565 5f6d 6573    self.queue_mes
+0001a430: 7361 6765 2822 6465 7465 6374 6f72 5f72  sage("detector_r
+0001a440: 6567 696f 6e73 222c 2073 656c 662e 7365  egions", self.se
+0001a450: 7474 696e 6773 2e73 7461 7465 2e64 6574  ttings.state.det
+0001a460: 6563 746f 725f 7265 6769 6f6e 7329 0d0a  ector_regions)..
+0001a470: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001a480: 2072 6573 756c 740d 0a0d 0a20 2020 2064   result....    d
+0001a490: 6566 2067 6574 5f66 7067 615f 636f 6e66  ef get_fpga_conf
+0001a4a0: 6967 7572 6174 696f 6e5f 7265 6769 7374  iguration_regist
+0001a4b0: 6572 2873 656c 662c 206c 6162 656c 3a20  er(self, label: 
+0001a4c0: 7374 7220 3d20 2222 293a 2023 202d 3e20  str = ""): # -> 
+0001a4d0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+0001a4e0: 6f6e 7365 200d 0a20 2020 2020 2020 2072  onse ..        r
+0001a4f0: 6177 203d 2073 656c 662e 5f67 6574 5f63  aw = self._get_c
+0001a500: 6f64 6528 3078 6233 2c20 6c73 625f 6c65  ode(0xb3, lsb_le
+0001a510: 6e3d 322c 206c 6162 656c 3d22 4745 545f  n=2, label="GET_
+0001a520: 4650 4741 5f43 4f4e 4649 4755 5241 5449  FPGA_CONFIGURATI
+0001a530: 4f4e 5f52 4547 4953 5445 5222 290d 0a20  ON_REGISTER").. 
+0001a540: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
+0001a550: 2866 2246 5047 4120 436f 6e66 6967 7572  (f"FPGA Configur
+0001a560: 6174 696f 6e20 5265 6769 7374 6572 3a20  ation Register: 
+0001a570: 3078 7b72 6177 3a30 3478 7d20 287b 6c61  0x{raw:04x} ({la
+0001a580: 6265 6c7d 2922 290d 0a20 2020 2020 2020  bel})")..       
+0001a590: 2072 6574 7572 6e20 7261 770d 0a0d 0a20   return raw.... 
+0001a5a0: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
+0001a5b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a5c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a5d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a5e0: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+0001a5f0: 0a20 2020 2023 0d0a 2020 2020 2320 2020  .    #..    #   
+0001a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a610: 2020 2020 2020 2020 4163 6365 7373 6f72          Accessor
+0001a620: 7920 436f 6e6e 6563 746f 720d 0a20 2020  y Connector..   
+0001a630: 2023 0d0a 2020 2020 2320 2323 2323 2323   #..    # ######
+0001a640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a680: 2323 2323 0d0a 0d0a 2020 2020 2320 2323  ####....    # ##
+0001a690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a6a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a6b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a6c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a6d0: 2323 2323 2323 2323 0d0a 2020 2020 2320  ########..    # 
+0001a6e0: 4163 6365 7373 6f72 7920 456e 6162 6c65  Accessory Enable
+0001a6f0: 0d0a 2020 2020 2320 2323 2323 2323 2323  ..    # ########
+0001a700: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a710: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a720: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a730: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a740: 2323 0d0a 0d0a 2020 2020 2323 2040 746f  ##....    ## @to
+0001a750: 646f 2063 6861 6e67 6520 6f70 636f 6465  do change opcode
+0001a760: 2028 636f 6e66 6c69 6374 7320 7769 7468   (conflicts with
+0001a770: 2047 4554 5f44 4554 4543 544f 525f 5354   GET_DETECTOR_ST
+0001a780: 4152 545f 4c49 4e45 290d 0a20 2020 2064  ART_LINE)..    d
+0001a790: 6566 2073 6574 5f61 6363 6573 736f 7279  ef set_accessory
+0001a7a0: 5f65 6e61 626c 6528 7365 6c66 2c20 666c  _enable(self, fl
+0001a7b0: 6167 3a20 626f 6f6c 293a 2023 202d 3e20  ag: bool): # -> 
+0001a7c0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+0001a7d0: 6f6e 7365 200d 0a20 2020 2020 2020 2069  onse ..        i
+0001a7e0: 6620 6e6f 7420 7365 6c66 2e73 6574 7469  f not self.setti
+0001a7f0: 6e67 732e 6973 5f67 656e 3135 2829 3a0d  ngs.is_gen15():.
+0001a800: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001a810: 2e64 6562 7567 2822 6163 6365 7373 6f72  .debug("accessor
+0001a820: 7920 7265 7175 6972 6573 2047 656e 2031  y requires Gen 1
+0001a830: 2e35 2229 0d0a 2020 2020 2020 2020 2020  .5")..          
+0001a840: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+0001a850: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+0001a860: 7461 3d46 616c 7365 2c65 7272 6f72 5f6d  ta=False,error_m
+0001a870: 7367 3d22 7265 7175 6972 6573 2067 656e  sg="requires gen
+0001a880: 312e 3522 290d 0a20 2020 2020 2020 2076  1.5")..        v
+0001a890: 616c 7565 203d 2031 2069 6620 666c 6167  alue = 1 if flag
+0001a8a0: 2065 6c73 6520 300d 0a20 2020 2020 2020   else 0..       
+0001a8b0: 2072 6574 7572 6e20 7365 6c66 2e5f 7365   return self._se
+0001a8c0: 6e64 5f63 6f64 6528 6252 6571 7565 7374  nd_code(bRequest
+0001a8d0: 2020 2020 2020 2020 3d20 3078 3232 2c0d          = 0x22,.
+0001a8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a8f0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0001a900: 5661 6c75 6520 2020 2020 2020 2020 203d  Value          =
+0001a910: 2076 616c 7565 2c0d 0a20 2020 2020 2020   value,..       
+0001a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a930: 2020 2020 2020 2077 496e 6465 7820 2020         wIndex   
+0001a940: 2020 2020 2020 203d 2030 2c0d 0a20 2020         = 0,..   
+0001a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a960: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+0001a970: 6f72 5f77 4c65 6e67 7468 203d 205b 305d  or_wLength = [0]
+0001a980: 202a 2038 2c0d 0a20 2020 2020 2020 2020   * 8,..         
+0001a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9a0: 2020 2020 206c 6162 656c 2020 2020 2020       label      
+0001a9b0: 2020 2020 203d 2022 5345 545f 4143 4345       = "SET_ACCE
+0001a9c0: 5353 4f52 595f 454e 4142 4c45 2229 0d0a  SSORY_ENABLE")..
+0001a9d0: 0d0a 2020 2020 2323 2040 746f 646f 2066  ..    ## @todo f
+0001a9e0: 696e 6420 6f75 7420 6f70 636f 6465 0d0a  ind out opcode..
+0001a9f0: 2020 2020 6465 6620 6765 745f 6469 7363      def get_disc
+0001aa00: 7265 7465 735f 656e 6162 6c65 6428 7365  retes_enabled(se
+0001aa10: 6c66 293a 2023 202d 3e20 5370 6563 7472  lf): # -> Spectr
+0001aa20: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+0001aa30: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001aa40: 7365 6c66 2e73 6574 7469 6e67 732e 6973  self.settings.is
+0001aa50: 5f67 656e 3135 2829 3a0d 0a20 2020 2020  _gen15():..     
+0001aa60: 2020 2020 2020 206c 6f67 2e65 7272 6f72         log.error
+0001aa70: 2822 6163 6365 7373 6f72 7920 7265 7175  ("accessory requ
+0001aa80: 6972 6573 2047 656e 2031 2e35 2229 0d0a  ires Gen 1.5")..
+0001aa90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001aaa0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+0001aab0: 6573 706f 6e73 6528 6461 7461 3d46 616c  esponse(data=Fal
+0001aac0: 7365 2c65 7272 6f72 5f6d 7367 3d22 7265  se,error_msg="re
+0001aad0: 7175 6972 6573 2067 656e 312e 3522 290d  quires gen1.5").
+0001aae0: 0a20 2020 2020 2020 2023 2072 6574 7572  .        # retur
+0001aaf0: 6e20 7365 6c66 2e5f 6765 745f 636f 6465  n self._get_code
+0001ab00: 2830 7833 372c 206c 6162 656c 3d22 4745  (0x37, label="GE
+0001ab10: 545f 4143 4345 5353 4f52 595f 454e 4142  T_ACCESSORY_ENAB
+0001ab20: 4c45 4422 2c20 6d73 625f 6c65 6e3d 3129  LED", msb_len=1)
+0001ab30: 0d0a 0d0a 2020 2020 2320 2323 2323 2323  ....    # ######
+0001ab40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ab50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ab60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ab70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ab80: 2323 2323 0d0a 2020 2020 2320 4661 6e0d  ####..    # Fan.
+0001ab90: 0a20 2020 2023 2023 2323 2323 2323 2323  .    # #########
+0001aba0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001abb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001abc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001abd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001abe0: 230d 0a0d 0a20 2020 2064 6566 2073 6574  #....    def set
+0001abf0: 5f66 616e 5f65 6e61 626c 6528 7365 6c66  _fan_enable(self
+0001ac00: 2c20 666c 6167 3a20 626f 6f6c 293a 2023  , flag: bool): #
+0001ac10: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
+0001ac20: 5265 7370 6f6e 7365 200d 0a20 2020 2020  Response ..     
+0001ac30: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
+0001ac40: 6574 7469 6e67 732e 6973 5f67 656e 3135  ettings.is_gen15
+0001ac50: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
+0001ac60: 206c 6f67 2e64 6562 7567 2822 6661 6e20   log.debug("fan 
+0001ac70: 7265 7175 6972 6573 2047 656e 2031 2e35  requires Gen 1.5
+0001ac80: 2229 0d0a 2020 2020 2020 2020 2020 2020  ")..            
+0001ac90: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+0001aca0: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
+0001acb0: 3d46 616c 7365 2c65 7272 6f72 5f6d 7367  =False,error_msg
+0001acc0: 3d22 6661 6e20 7265 7175 6972 6573 2067  ="fan requires g
+0001acd0: 656e 3135 2e22 290d 0a20 2020 2020 2020  en15.")..       
+0001ace0: 2076 616c 7565 203d 2031 2069 6620 666c   value = 1 if fl
+0001acf0: 6167 2065 6c73 6520 300d 0a20 2020 2020  ag else 0..     
+0001ad00: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0001ad10: 7365 6e64 5f63 6f64 6528 6252 6571 7565  send_code(bReque
+0001ad20: 7374 2020 2020 2020 2020 3d20 3078 3336  st        = 0x36
+0001ad30: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+0001ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad50: 2077 5661 6c75 6520 2020 2020 2020 2020   wValue         
+0001ad60: 203d 2076 616c 7565 2c0d 0a20 2020 2020   = value,..     
+0001ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad80: 2020 2020 2020 2020 2077 496e 6465 7820           wIndex 
+0001ad90: 2020 2020 2020 2020 203d 2030 2c0d 0a20           = 0,.. 
+0001ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adb0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0001adc0: 615f 6f72 5f77 4c65 6e67 7468 203d 205b  a_or_wLength = [
+0001add0: 305d 202a 2038 2c0d 0a20 2020 2020 2020  0] * 8,..       
+0001ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adf0: 2020 2020 2020 206c 6162 656c 2020 2020         label    
+0001ae00: 2020 2020 2020 203d 2022 5345 545f 4641         = "SET_FA
+0001ae10: 4e5f 454e 4142 4c45 2229 0d0a 0d0a 2020  N_ENABLE")....  
+0001ae20: 2020 6465 6620 6765 745f 6661 6e5f 656e    def get_fan_en
+0001ae30: 6162 6c65 6428 7365 6c66 293a 2023 202d  abled(self): # -
+0001ae40: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+0001ae50: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+0001ae60: 2069 6620 6e6f 7420 7365 6c66 2e73 6574   if not self.set
+0001ae70: 7469 6e67 732e 6973 5f67 656e 3135 2829  tings.is_gen15()
+0001ae80: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
+0001ae90: 6f67 2e65 7272 6f72 2822 6661 6e20 7265  og.error("fan re
+0001aea0: 7175 6972 6573 2047 656e 2031 2e35 2229  quires Gen 1.5")
+0001aeb0: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0001aec0: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+0001aed0: 7252 6573 706f 6e73 6528 6461 7461 3d46  rResponse(data=F
+0001aee0: 616c 7365 2c65 7272 6f72 5f6d 7367 3d22  alse,error_msg="
+0001aef0: 6661 6e20 7265 7175 6972 6573 2067 656e  fan requires gen
+0001af00: 312e 3522 290d 0a20 2020 2020 2020 2072  1.5")..        r
+0001af10: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+0001af20: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+0001af30: 3020 213d 2073 656c 662e 5f67 6574 5f63  0 != self._get_c
+0001af40: 6f64 6528 3078 3337 2c20 6c61 6265 6c3d  ode(0x37, label=
+0001af50: 2247 4554 5f46 414e 5f45 4e41 424c 4544  "GET_FAN_ENABLED
+0001af60: 222c 206d 7362 5f6c 656e 3d31 2929 0d0a  ", msb_len=1))..
+0001af70: 0d0a 2020 2020 2320 2323 2323 2323 2323  ..    # ########
+0001af80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001af90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001afa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001afb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001afc0: 2323 0d0a 2020 2020 2320 4c61 6d70 0d0a  ##..    # Lamp..
+0001afd0: 2020 2020 2320 2323 2323 2323 2323 2323      # ##########
+0001afe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001aff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b000: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b010: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b020: 0d0a 0d0a 2020 2020 6465 6620 7365 745f  ....    def set_
+0001b030: 6c61 6d70 5f65 6e61 626c 6528 7365 6c66  lamp_enable(self
+0001b040: 2c20 666c 6167 3a20 626f 6f6c 293a 2023  , flag: bool): #
+0001b050: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
+0001b060: 5265 7370 6f6e 7365 200d 0a20 2020 2020  Response ..     
+0001b070: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
+0001b080: 6574 7469 6e67 732e 6973 5f67 656e 3135  ettings.is_gen15
+0001b090: 2829 3a0d 0a20 2020 2020 2020 2020 2020  ():..           
+0001b0a0: 206c 6f67 2e64 6562 7567 2822 6c61 6d70   log.debug("lamp
+0001b0b0: 2072 6571 7569 7265 7320 4765 6e20 312e   requires Gen 1.
+0001b0c0: 3522 290d 0a20 2020 2020 2020 2020 2020  5")..           
+0001b0d0: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+0001b0e0: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+0001b0f0: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
+0001b100: 673d 226c 616d 7020 7265 7175 6972 6573  g="lamp requires
+0001b110: 2067 656e 312e 3522 290d 0a20 2020 2020   gen1.5")..     
+0001b120: 2020 2076 616c 7565 203d 2031 2069 6620     value = 1 if 
+0001b130: 666c 6167 2065 6c73 6520 300d 0a20 2020  flag else 0..   
+0001b140: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0001b150: 2e5f 7365 6e64 5f63 6f64 6528 6252 6571  ._send_code(bReq
+0001b160: 7565 7374 2020 2020 2020 2020 3d20 3078  uest        = 0x
+0001b170: 3332 2c0d 0a20 2020 2020 2020 2020 2020  32,..           
+0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b190: 2020 2077 5661 6c75 6520 2020 2020 2020     wValue       
+0001b1a0: 2020 203d 2076 616c 7565 2c0d 0a20 2020     = value,..   
+0001b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1c0: 2020 2020 2020 2020 2020 2077 496e 6465             wInde
+0001b1d0: 7820 2020 2020 2020 2020 203d 2030 2c0d  x          = 0,.
+0001b1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b1f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001b200: 6174 615f 6f72 5f77 4c65 6e67 7468 203d  ata_or_wLength =
+0001b210: 205b 305d 202a 2038 2c0d 0a20 2020 2020   [0] * 8,..     
+0001b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b230: 2020 2020 2020 2020 206c 6162 656c 2020           label  
+0001b240: 2020 2020 2020 2020 203d 2022 5345 545f           = "SET_
+0001b250: 4c41 4d50 5f45 4e41 424c 4522 290d 0a0d  LAMP_ENABLE")...
+0001b260: 0a20 2020 2064 6566 2067 6574 5f6c 616d  .    def get_lam
+0001b270: 705f 656e 6162 6c65 6428 7365 6c66 293a  p_enabled(self):
+0001b280: 2023 202d 3e20 5370 6563 7472 6f6d 6574   # -> Spectromet
+0001b290: 6572 5265 7370 6f6e 7365 200d 0a20 2020  erResponse ..   
+0001b2a0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0001b2b0: 2e73 6574 7469 6e67 732e 6973 5f67 656e  .settings.is_gen
+0001b2c0: 3135 2829 3a0d 0a20 2020 2020 2020 2020  15():..         
+0001b2d0: 2020 206c 6f67 2e65 7272 6f72 2822 6c61     log.error("la
+0001b2e0: 6d70 2072 6571 7569 7265 7320 4765 6e20  mp requires Gen 
+0001b2f0: 312e 3522 290d 0a20 2020 2020 2020 2020  1.5")..         
+0001b300: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+0001b310: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+0001b320: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
+0001b330: 6d73 673d 226c 616d 7020 7265 7175 6972  msg="lamp requir
+0001b340: 6573 2067 656e 312e 3522 290d 0a20 2020  es gen1.5")..   
+0001b350: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
+0001b360: 5f67 6574 5f63 6f64 6528 3078 3333 2c20  _get_code(0x33, 
+0001b370: 6c61 6265 6c3d 2247 4554 5f4c 414d 505f  label="GET_LAMP_
+0001b380: 454e 4142 4c45 4422 2c20 6d73 625f 6c65  ENABLED", msb_le
+0001b390: 6e3d 3129 0d0a 2020 2020 2020 2020 7265  n=1)..        re
+0001b3a0: 732e 6461 7461 203d 2030 2021 3d20 7265  s.data = 0 != re
+0001b3b0: 732e 6461 7461 0d0a 2020 2020 2020 2020  s.data..        
+0001b3c0: 7265 7475 726e 2072 6573 0d0a 0d0a 2020  return res....  
+0001b3d0: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
+0001b3e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b3f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b410: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+0001b420: 2020 2020 2320 5368 7574 7465 720d 0a20      # Shutter.. 
+0001b430: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
+0001b440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b470: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+0001b480: 0a0d 0a20 2020 2064 6566 2073 6574 5f73  ...    def set_s
+0001b490: 6875 7474 6572 5f65 6e61 626c 6528 7365  hutter_enable(se
+0001b4a0: 6c66 2c20 666c 6167 3a20 626f 6f6c 293a  lf, flag: bool):
+0001b4b0: 2023 202d 3e20 5370 6563 7472 6f6d 6574   # -> Spectromet
+0001b4c0: 6572 5265 7370 6f6e 7365 200d 0a20 2020  erResponse ..   
+0001b4d0: 2020 2020 2069 6620 6e6f 7420 2873 656c       if not (sel
+0001b4e0: 662e 7365 7474 696e 6773 2e69 735f 6765  f.settings.is_ge
+0001b4f0: 6e31 3528 2920 616e 6420 7365 6c66 2e73  n15() and self.s
+0001b500: 6574 7469 6e67 732e 6565 7072 6f6d 2e68  ettings.eeprom.h
+0001b510: 6173 5f73 6875 7474 6572 293a 0d0a 2020  as_shutter):..  
+0001b520: 2020 2020 2020 2020 2020 6c6f 672e 6465            log.de
+0001b530: 6275 6728 2273 6875 7474 6572 2072 6571  bug("shutter req
+0001b540: 7569 7265 7320 4765 6e20 312e 3520 616e  uires Gen 1.5 an
+0001b550: 6420 6861 735f 7368 7574 7465 7220 666c  d has_shutter fl
+0001b560: 6167 2229 0d0a 2020 2020 2020 2020 2020  ag")..          
+0001b570: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+0001b580: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+0001b590: 7461 3d46 616c 7365 2c65 7272 6f72 5f6d  ta=False,error_m
+0001b5a0: 7367 3d22 7368 7574 7465 7220 7265 7175  sg="shutter requ
+0001b5b0: 6972 6573 2067 656e 312e 3522 290d 0a20  ires gen1.5").. 
+0001b5c0: 2020 2020 2020 2076 616c 7565 203d 2031         value = 1
+0001b5d0: 2069 6620 666c 6167 2065 6c73 6520 300d   if flag else 0.
+0001b5e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001b5f0: 7365 6c66 2e5f 7365 6e64 5f63 6f64 6528  self._send_code(
+0001b600: 6252 6571 7565 7374 2020 2020 2020 2020  bRequest        
+0001b610: 3d20 3078 3330 2c0d 0a20 2020 2020 2020  = 0x30,..       
+0001b620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b630: 2020 2020 2020 2077 5661 6c75 6520 2020         wValue   
+0001b640: 2020 2020 2020 203d 2076 616c 7565 2c0d         = value,.
+0001b650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b660: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0001b670: 496e 6465 7820 2020 2020 2020 2020 203d  Index          =
+0001b680: 2030 2c0d 0a20 2020 2020 2020 2020 2020   0,..           
+0001b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6a0: 2020 2064 6174 615f 6f72 5f77 4c65 6e67     data_or_wLeng
+0001b6b0: 7468 203d 205b 305d 202a 2038 2c0d 0a20  th = [0] * 8,.. 
+0001b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6d0: 2020 2020 2020 2020 2020 2020 206c 6162               lab
+0001b6e0: 656c 2020 2020 2020 2020 2020 203d 2022  el           = "
+0001b6f0: 5345 545f 5348 5554 5445 525f 454e 4142  SET_SHUTTER_ENAB
+0001b700: 4c45 2229 0d0a 0d0a 2020 2020 6465 6620  LE")....    def 
+0001b710: 6765 745f 7368 7574 7465 725f 656e 6162  get_shutter_enab
+0001b720: 6c65 6428 7365 6c66 293a 2023 202d 3e20  led(self): # -> 
+0001b730: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+0001b740: 6f6e 7365 200d 0a20 2020 2020 2020 2069  onse ..        i
+0001b750: 6620 6e6f 7420 2873 656c 662e 7365 7474  f not (self.sett
+0001b760: 696e 6773 2e69 735f 6765 6e31 3528 2920  ings.is_gen15() 
+0001b770: 616e 6420 7365 6c66 2e73 6574 7469 6e67  and self.setting
+0001b780: 732e 6565 7072 6f6d 2e68 6173 5f73 6875  s.eeprom.has_shu
+0001b790: 7474 6572 293a 0d0a 2020 2020 2020 2020  tter):..        
+0001b7a0: 2020 2020 6c6f 672e 6465 6275 6728 2273      log.debug("s
+0001b7b0: 6875 7474 6572 2072 6571 7569 7265 7320  hutter requires 
+0001b7c0: 4765 6e20 312e 3520 616e 6420 6861 735f  Gen 1.5 and has_
+0001b7d0: 7368 7574 7465 7220 666c 6167 2229 0d0a  shutter flag")..
+0001b7e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001b7f0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+0001b800: 6573 706f 6e73 6528 6461 7461 3d46 616c  esponse(data=Fal
+0001b810: 7365 2c65 7272 6f72 5f6d 7367 3d22 7368  se,error_msg="sh
+0001b820: 7574 7465 7220 7265 7175 6972 6573 2067  utter requires g
+0001b830: 656e 312e 3522 290d 0a20 2020 2020 2020  en1.5")..       
+0001b840: 2072 6573 203d 2053 7065 6374 726f 6d65   res = Spectrome
+0001b850: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
+0001b860: 3d30 2021 3d20 7365 6c66 2e5f 6765 745f  =0 != self._get_
+0001b870: 636f 6465 2830 7833 312c 206c 6162 656c  code(0x31, label
+0001b880: 3d22 4745 545f 5348 5554 5445 525f 454e  ="GET_SHUTTER_EN
+0001b890: 4142 4c45 4422 2c20 6d73 625f 6c65 6e3d  ABLED", msb_len=
+0001b8a0: 3129 290d 0a20 2020 2020 2020 2072 6573  1))..        res
+0001b8b0: 2e64 6174 6120 3d20 3020 213d 2072 6573  .data = 0 != res
+0001b8c0: 2e64 6174 610d 0a20 2020 2020 2020 2072  .data..        r
+0001b8d0: 6574 7572 6e20 7265 7320 0d0a 0d0a 2020  eturn res ....  
+0001b8e0: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
+0001b8f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b900: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b910: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b920: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+0001b930: 2020 2020 2320 4c61 7365 7220 4d6f 6475      # Laser Modu
+0001b940: 6c61 7469 6f6e 2061 6e64 2043 6f6e 7469  lation and Conti
+0001b950: 6e75 6f75 7320 5374 726f 6265 0d0a 2020  nuous Strobe..  
+0001b960: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
+0001b970: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b980: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b990: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b9a0: 2323 2323 2323 2323 2323 2323 2323 0d0a  ##############..
+0001b9b0: 0d0a 2020 2020 6465 6620 7365 745f 6d6f  ..    def set_mo
+0001b9c0: 645f 656e 6162 6c65 2873 656c 662c 2066  d_enable(self, f
+0001b9d0: 6c61 673a 2062 6f6f 6c29 3a20 2320 2d3e  lag: bool): # ->
+0001b9e0: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0001b9f0: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0001ba00: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
+0001ba10: 6174 652e 6d6f 645f 656e 6162 6c65 6420  ate.mod_enabled 
+0001ba20: 3d20 666c 6167 0d0a 2020 2020 2020 2020  = flag..        
+0001ba30: 7661 6c75 6520 3d20 3120 6966 2066 6c61  value = 1 if fla
+0001ba40: 6720 656c 7365 2030 0d0a 2020 2020 2020  g else 0..      
+0001ba50: 2020 7265 7475 726e 2073 656c 662e 5f73    return self._s
+0001ba60: 656e 645f 636f 6465 2830 7862 642c 2076  end_code(0xbd, v
+0001ba70: 616c 7565 2c20 6c61 6265 6c3d 2253 4554  alue, label="SET
+0001ba80: 5f4d 4f44 5f45 4e41 424c 4522 290d 0a0d  _MOD_ENABLE")...
+0001ba90: 0a20 2020 2064 6566 2067 6574 5f6d 6f64  .    def get_mod
+0001baa0: 5f65 6e61 626c 6564 2873 656c 6629 3a20  _enabled(self): 
+0001bab0: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+0001bac0: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+0001bad0: 2020 2020 7265 7320 3d20 7365 6c66 2e5f      res = self._
+0001bae0: 6765 745f 636f 6465 2830 7865 332c 206c  get_code(0xe3, l
+0001baf0: 6162 656c 3d22 4745 545f 4d4f 445f 454e  abel="GET_MOD_EN
+0001bb00: 4142 4c45 4422 2c20 6d73 625f 6c65 6e3d  ABLED", msb_len=
+0001bb10: 3129 0d0a 2020 2020 2020 2020 6966 2072  1)..        if r
+0001bb20: 6573 2e65 7272 6f72 5f6d 7367 2021 3d20  es.error_msg != 
+0001bb30: 2727 3a0d 0a20 2020 2020 2020 2020 2020  '':..           
+0001bb40: 2072 6574 7572 6e20 7265 730d 0a20 2020   return res..   
+0001bb50: 2020 2020 2066 6c61 6720 3d20 3020 213d       flag = 0 !=
+0001bb60: 2072 6573 2e64 6174 610d 0a20 2020 2020   res.data..     
+0001bb70: 2020 2073 656c 662e 7365 7474 696e 6773     self.settings
+0001bb80: 2e73 7461 7465 2e6d 6f64 5f65 6e61 626c  .state.mod_enabl
+0001bb90: 6564 203d 2066 6c61 670d 0a20 2020 2020  ed = flag..     
+0001bba0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+0001bbb0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+0001bbc0: 6174 613d 666c 6167 290d 0a0d 0a20 2020  ata=flag)....   
+0001bbd0: 2064 6566 2073 6574 5f6d 6f64 5f70 6572   def set_mod_per
+0001bbe0: 696f 645f 7573 2873 656c 662c 2075 733a  iod_us(self, us:
+0001bbf0: 2066 6c6f 6174 293a 2023 202d 3e20 5370   float): # -> Sp
+0001bc00: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+0001bc10: 7365 200d 0a20 2020 2020 2020 2073 656c  se ..        sel
+0001bc20: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
+0001bc30: 2e6d 6f64 5f70 6572 696f 645f 7573 203d  .mod_period_us =
+0001bc40: 2075 730d 0a20 2020 2020 2020 2028 6c73   us..        (ls
+0001bc50: 772c 206d 7377 2c20 6275 6629 203d 2073  w, msw, buf) = s
+0001bc60: 656c 662e 5f74 6f34 3062 6974 2875 7329  elf._to40bit(us)
+0001bc70: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001bc80: 2073 656c 662e 5f73 656e 645f 636f 6465   self._send_code
+0001bc90: 2830 7863 372c 206c 7377 2c20 6d73 772c  (0xc7, lsw, msw,
+0001bca0: 2062 7566 2c20 6c61 6265 6c3d 2253 4554   buf, label="SET
+0001bcb0: 5f4d 4f44 5f50 4552 494f 4422 290d 0a0d  _MOD_PERIOD")...
+0001bcc0: 0a20 2020 2064 6566 2067 6574 5f6d 6f64  .    def get_mod
+0001bcd0: 5f70 6572 696f 645f 7573 2873 656c 6629  _period_us(self)
+0001bce0: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+0001bcf0: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+0001bd00: 2020 2020 2020 7265 7375 6c74 203d 2073        result = s
+0001bd10: 656c 662e 5f67 6574 5f63 6f64 6528 3078  elf._get_code(0x
+0001bd20: 6362 2c20 6c61 6265 6c3d 2247 4554 5f4d  cb, label="GET_M
+0001bd30: 4f44 5f50 4552 494f 4422 2c20 6c73 625f  OD_PERIOD", lsb_
+0001bd40: 6c65 6e3d 3529 0d0a 2020 2020 2020 2020  len=5)..        
 0001bd50: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
-0001bd60: 6174 652e 6c61 7365 725f 656e 6162 6c65  ate.laser_enable
-0001bd70: 6420 3d20 666c 6167 0a20 2020 2020 2020  d = flag.       
-0001bd80: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
-0001bd90: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
-0001bda0: 613d 666c 6167 290a 0a20 2020 2064 6566  a=flag)..    def
-0001bdb0: 2073 6574 5f6d 6f64 5f6c 696e 6b65 645f   set_mod_linked_
-0001bdc0: 746f 5f69 6e74 6567 7261 7469 6f6e 2873  to_integration(s
-0001bdd0: 656c 662c 2066 6c61 673a 2062 6f6f 6c29  elf, flag: bool)
-0001bde0: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
-0001bdf0: 5265 7370 6f6e 7365 3a0a 2020 2020 2020  Response:.      
-0001be00: 2020 7661 6c75 6520 3d20 3120 6966 2066    value = 1 if f
-0001be10: 6c61 6720 656c 7365 2030 0a20 2020 2020  lag else 0.     
-0001be20: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0001be30: 7365 6e64 5f63 6f64 6528 3078 6464 2c20  send_code(0xdd, 
-0001be40: 7661 6c75 652c 206c 6162 656c 3d22 5345  value, label="SE
-0001be50: 545f 4d4f 445f 4c49 4e4b 4544 5f54 4f5f  T_MOD_LINKED_TO_
-0001be60: 494e 5445 4752 4154 494f 4e22 290a 0a20  INTEGRATION").. 
-0001be70: 2020 2064 6566 2067 6574 5f6d 6f64 5f6c     def get_mod_l
-0001be80: 696e 6b65 645f 746f 5f69 6e74 6567 7261  inked_to_integra
-0001be90: 7469 6f6e 2873 656c 6629 202d 3e20 5370  tion(self) -> Sp
-0001bea0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0001beb0: 7365 3a0a 2020 2020 2020 2020 7265 7320  se:.        res 
-0001bec0: 3d20 7365 6c66 2e5f 6765 745f 636f 6465  = self._get_code
-0001bed0: 2830 7864 652c 206c 6162 656c 3d22 4745  (0xde, label="GE
-0001bee0: 545f 4d4f 445f 4c49 4e4b 4544 5f54 4f5f  T_MOD_LINKED_TO_
-0001bef0: 494e 5445 4752 4154 494f 4e22 2c20 6d73  INTEGRATION", ms
-0001bf00: 625f 6c65 6e3d 3129 0a20 2020 2020 2020  b_len=1).       
-0001bf10: 2069 6620 7265 732e 6572 726f 725f 6d73   if res.error_ms
-0001bf20: 6720 213d 2027 273a 0a20 2020 2020 2020  g != '':.       
-0001bf30: 2020 2020 2072 6574 7572 6e20 7265 730a       return res.
-0001bf40: 2020 2020 2020 2020 7265 732e 6461 7461          res.data
-0001bf50: 203d 2030 2021 3d20 7265 732e 6461 7461   = 0 != res.data
-0001bf60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001bf70: 7265 730a 0a20 2020 2064 6566 2067 6574  res..    def get
-0001bf80: 5f73 656c 6563 7465 645f 6164 6328 7365  _selected_adc(se
-0001bf90: 6c66 293a 0a20 2020 2020 2020 2076 616c  lf):.        val
-0001bfa0: 7565 203d 2073 656c 662e 5f67 6574 5f63  ue = self._get_c
-0001bfb0: 6f64 6528 3078 6565 2c20 6c61 6265 6c3d  ode(0xee, label=
-0001bfc0: 2247 4554 5f53 454c 4543 5445 445f 4144  "GET_SELECTED_AD
-0001bfd0: 4322 2c20 6d73 625f 6c65 6e3d 3129 0a20  C", msb_len=1). 
-0001bfe0: 2020 2020 2020 2069 6620 7661 6c75 652e         if value.
-0001bff0: 6572 726f 725f 6d73 6720 213d 2027 273a  error_msg != '':
-0001c000: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001c010: 7572 6e20 7661 6c75 650a 2020 2020 2020  urn value.      
-0001c020: 2020 6966 2073 656c 662e 7365 7474 696e    if self.settin
-0001c030: 6773 2e73 7461 7465 2e73 656c 6563 7465  gs.state.selecte
-0001c040: 645f 6164 6320 213d 2076 616c 7565 2e64  d_adc != value.d
-0001c050: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
-0001c060: 206c 6f67 2e65 7272 6f72 2822 4745 545f   log.error("GET_
-0001c070: 5345 4c45 4354 4544 5f41 4443 2025 6420  SELECTED_ADC %d 
-0001c080: 213d 2073 7461 7465 2e73 656c 6563 7465  != state.selecte
-0001c090: 645f 6164 6320 2564 222c 2076 616c 7565  d_adc %d", value
-0001c0a0: 2c20 7365 6c66 2e73 6574 7469 6e67 732e  , self.settings.
-0001c0b0: 7374 6174 652e 7365 6c65 6374 6564 5f61  state.selected_a
-0001c0c0: 6463 290a 2020 2020 2020 2020 2020 2020  dc).            
-0001c0d0: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
-0001c0e0: 6174 652e 7365 6c65 6374 6564 5f61 6463  ate.selected_adc
-0001c0f0: 203d 2076 616c 7565 2e64 6174 610a 2020   = value.data.  
-0001c100: 2020 2020 2020 7265 7475 726e 2076 616c        return val
-0001c110: 7565 0a0a 2020 2020 6465 6620 7365 745f  ue..    def set_
-0001c120: 7472 6967 6765 725f 6465 6c61 7928 7365  trigger_delay(se
-0001c130: 6c66 2c20 6861 6c66 5f75 733a 2066 6c6f  lf, half_us: flo
-0001c140: 6174 2920 2d3e 2053 7065 6374 726f 6d65  at) -> Spectrome
-0001c150: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-0001c160: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001c170: 2041 2063 6f6e 6665 6e75 7261 626c 6520   A confenurable 
-0001c180: 6465 6c61 7920 6672 6f6d 2077 6865 6e20  delay from when 
-0001c190: 616e 2069 6e62 6f75 6e64 2074 7269 6767  an inbound trigg
-0001c1a0: 6572 2073 6967 6e61 6c20 6973 0a20 2020  er signal is.   
-0001c1b0: 2020 2020 2072 6563 6569 7665 6420 6279       received by
-0001c1c0: 2074 6865 2073 7065 6374 726f 6d65 7465   the spectromete
-0001c1d0: 722c 2075 6e74 696c 2074 6865 2074 7269  r, until the tri
-0001c1e0: 6767 6572 6564 2061 6371 7569 7369 7469  ggered acquisiti
-0001c1f0: 6f6e 2061 6374 7561 6c6c 7920 7374 6172  on actually star
-0001c200: 7473 2e0a 2020 2020 2020 2020 0a20 2020  ts..        .   
-0001c210: 2020 2020 2044 6566 6175 6c74 2076 616c       Default val
-0001c220: 7565 2069 7320 3075 732e 0a20 2020 2020  ue is 0us..     
-0001c230: 2020 200a 2020 2020 2020 2020 556e 6974     .        Unit
-0001c240: 2069 7320 696e 2030 2e35 206d 6963 726f   is in 0.5 micro
-0001c250: 7365 636f 6e64 7320 2835 3030 6e73 292c  seconds (500ns),
-0001c260: 2073 6f20 7661 6c75 6520 6f66 2032 3520   so value of 25 
-0001c270: 776f 756c 6420 7265 7072 6573 656e 7420  would represent 
-0001c280: 3132 2e35 7573 2e0a 2020 2020 2020 2020  12.5us..        
-0001c290: 0a20 2020 2020 2020 2056 616c 7565 2069  .        Value i
-0001c2a0: 7320 3234 6269 742c 2073 6f20 6d61 7820  s 24bit, so max 
-0001c2b0: 7661 6c75 6520 6973 2031 3637 3737 3231  value is 1677721
-0001c2c0: 3620 2838 2e33 3838 3630 3820 7365 6329  6 (8.388608 sec)
-0001c2d0: 2e0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
-0001c2e0: 2020 204c 696b 6520 7472 6967 6765 7269     Like triggeri
-0001c2f0: 6e67 2c20 6f6e 6c79 2063 7572 7265 6e74  ng, only current
-0001c300: 6c79 2073 7570 706f 7274 6564 206f 6e20  ly supported on 
-0001c310: 4152 4d2e 0a20 2020 2020 2020 2022 2222  ARM..        """
-0001c320: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001c330: 7365 6c66 2e73 6574 7469 6e67 732e 6973  self.settings.is
-0001c340: 5f61 726d 2829 3a0a 2020 2020 2020 2020  _arm():.        
-0001c350: 2020 2020 6c6f 672e 6572 726f 7228 2253      log.error("S
-0001c360: 4554 5f54 5249 4747 4552 5f44 454c 4159  ET_TRIGGER_DELAY
-0001c370: 206f 6e6c 7920 7375 7070 6f72 7465 6420   only supported 
-0001c380: 6f6e 2041 524d 2229 0a20 2020 2020 2020  on ARM").       
-0001c390: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-0001c3a0: 650a 2020 2020 2020 2020 6c73 7720 3d20  e.        lsw = 
-0001c3b0: 6861 6c66 5f75 7320 2620 3078 6666 6666  half_us & 0xffff
-0001c3c0: 0a20 2020 2020 2020 206d 7362 203d 2028  .        msb = (
-0001c3d0: 6861 6c66 5f75 7320 3e3e 2031 3629 2026  half_us >> 16) &
-0001c3e0: 2030 7866 660a 2020 2020 2020 2020 7265   0xff.        re
-0001c3f0: 7475 726e 2073 656c 662e 5f73 656e 645f  turn self._send_
-0001c400: 636f 6465 2830 7861 612c 2077 5661 6c75  code(0xaa, wValu
-0001c410: 653d 6c73 772c 2077 496e 6465 783d 6d73  e=lsw, wIndex=ms
-0001c420: 622c 206c 6162 656c 3d22 5345 545f 5452  b, label="SET_TR
-0001c430: 4947 4745 525f 4445 4c41 5922 290a 0a20  IGGER_DELAY").. 
-0001c440: 2020 2023 206e 6f74 2074 6573 7465 640a     # not tested.
-0001c450: 2020 2020 6465 6620 6765 745f 7472 6967      def get_trig
-0001c460: 6765 725f 6465 6c61 7928 7365 6c66 2920  ger_delay(self) 
-0001c470: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-0001c480: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-0001c490: 2069 6620 6e6f 7420 7365 6c66 2e73 6574   if not self.set
-0001c4a0: 7469 6e67 732e 6973 5f61 726d 2829 3a0a  tings.is_arm():.
-0001c4b0: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
-0001c4c0: 6572 726f 7228 2247 4554 5f54 5249 4747  error("GET_TRIGG
-0001c4d0: 4552 5f44 454c 4159 206f 6e6c 7920 7375  ER_DELAY only su
-0001c4e0: 7070 6f72 7465 6420 6f6e 2041 524d 2229  pported on ARM")
-0001c4f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001c500: 7572 6e20 2d31 0a20 2020 2020 2020 2072  urn -1.        r
-0001c510: 6574 7572 6e20 7365 6c66 2e5f 6765 745f  eturn self._get_
-0001c520: 636f 6465 2830 7865 342c 206c 6162 656c  code(0xe4, label
-0001c530: 3d22 4745 545f 5452 4947 4745 525f 4445  ="GET_TRIGGER_DE
-0001c540: 4c41 5922 2c20 6c73 625f 6c65 6e3d 3329  LAY", lsb_len=3)
-0001c550: 2023 206e 6f74 2073 7572 6520 6162 6f75   # not sure abou
-0001c560: 7420 4c53 420a 0a20 2020 2064 6566 2067  t LSB..    def g
-0001c570: 6574 5f76 725f 636f 6e74 696e 756f 7573  et_vr_continuous
-0001c580: 5f63 6364 2873 656c 6629 202d 3e20 5370  _ccd(self) -> Sp
-0001c590: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0001c5a0: 7365 3a0a 2020 2020 2020 2020 7265 7320  se:.        res 
-0001c5b0: 3d20 7365 6c66 2e5f 6765 745f 636f 6465  = self._get_code
-0001c5c0: 2830 7863 632c 206c 6162 656c 3d22 4745  (0xcc, label="GE
-0001c5d0: 545f 5652 5f43 4f4e 5449 4e55 4f55 535f  T_VR_CONTINUOUS_
-0001c5e0: 4343 4422 2c20 6d73 625f 6c65 6e3d 3129  CCD", msb_len=1)
-0001c5f0: 0a20 2020 2020 2020 2069 6620 7265 732e  .        if res.
-0001c600: 6572 726f 725f 6d73 6720 213d 2027 273a  error_msg != '':
-0001c610: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001c620: 7572 6e20 7265 730a 2020 2020 2020 2020  urn res.        
-0001c630: 7265 732e 6461 7461 203d 2030 2021 3d20  res.data = 0 != 
-0001c640: 7265 732e 6461 7461 0a20 2020 2020 2020  res.data.       
-0001c650: 2072 6574 7572 6e20 7265 730a 0a20 2020   return res..   
-0001c660: 2064 6566 2067 6574 5f76 725f 6e75 6d5f   def get_vr_num_
-0001c670: 6672 616d 6573 2873 656c 6629 202d 3e20  frames(self) -> 
-0001c680: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001c690: 6f6e 7365 3a0a 2020 2020 2020 2020 7265  onse:.        re
-0001c6a0: 7475 726e 2073 656c 662e 5f67 6574 5f63  turn self._get_c
-0001c6b0: 6f64 6528 3078 6364 2c20 6c61 6265 6c3d  ode(0xcd, label=
-0001c6c0: 2247 4554 5f56 525f 4e55 4d5f 4652 414d  "GET_VR_NUM_FRAM
-0001c6d0: 4553 222c 206d 7362 5f6c 656e 3d31 290a  ES", msb_len=1).
-0001c6e0: 0a20 2020 2064 6566 2067 6574 5f6f 7074  .    def get_opt
-0001c6f0: 5f61 6374 7561 6c5f 696e 7465 6772 6174  _actual_integrat
-0001c700: 696f 6e5f 7469 6d65 2873 656c 6629 202d  ion_time(self) -
-0001c710: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
-0001c720: 7370 6f6e 7365 3a0a 2020 2020 2020 2020  sponse:.        
-0001c730: 7265 7320 3d20 7365 6c66 2e67 6574 5f75  res = self.get_u
-0001c740: 7070 6572 5f63 6f64 6528 3078 3062 2c20  pper_code(0x0b, 
-0001c750: 6c61 6265 6c3d 2247 4554 5f4f 5054 5f41  label="GET_OPT_A
-0001c760: 4354 5f49 4e54 5f54 494d 4522 2c20 6d73  CT_INT_TIME", ms
-0001c770: 625f 6c65 6e3d 3129 200a 2020 2020 2020  b_len=1) .      
-0001c780: 2020 6966 2072 6573 2e65 7272 6f72 5f6d    if res.error_m
-0001c790: 7367 2021 3d20 2727 3a0a 2020 2020 2020  sg != '':.      
-0001c7a0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0001c7b0: 0a20 2020 2020 2020 2072 6573 2e64 6174  .        res.dat
-0001c7c0: 6120 3d20 3020 213d 2072 6573 2e64 6174  a = 0 != res.dat
-0001c7d0: 610a 2020 2020 2020 2020 7265 7475 726e  a.        return
-0001c7e0: 2072 6573 0a0a 2020 2020 6465 6620 6765   res..    def ge
-0001c7f0: 745f 6f70 745f 6172 6561 5f73 6361 6e28  t_opt_area_scan(
-0001c800: 7365 6c66 2920 2d3e 2053 7065 6374 726f  self) -> Spectro
-0001c810: 6d65 7465 7252 6573 706f 6e73 653a 0a20  meterResponse:. 
-0001c820: 2020 2020 2020 2072 6573 203d 2073 656c         res = sel
-0001c830: 662e 6765 745f 7570 7065 725f 636f 6465  f.get_upper_code
-0001c840: 2830 7830 612c 206c 6162 656c 3d22 4745  (0x0a, label="GE
-0001c850: 545f 4f50 545f 4152 4541 5f53 4341 4e22  T_OPT_AREA_SCAN"
-0001c860: 2c20 6d73 625f 6c65 6e3d 3129 0a20 2020  , msb_len=1).   
-0001c870: 2020 2020 2069 6620 7265 732e 6572 726f       if res.erro
-0001c880: 725f 6d73 6720 213d 2027 273a 0a20 2020  r_msg != '':.   
-0001c890: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001c8a0: 7265 730a 2020 2020 2020 2020 7265 732e  res.        res.
-0001c8b0: 6461 7461 203d 2030 2021 3d20 7265 732e  data = 0 != res.
-0001c8c0: 6461 7461 0a20 2020 2020 2020 2072 6574  data.        ret
-0001c8d0: 7572 6e20 7265 730a 0a20 2020 2064 6566  urn res..    def
-0001c8e0: 2067 6574 5f6f 7074 5f63 665f 7365 6c65   get_opt_cf_sele
-0001c8f0: 6374 2873 656c 6629 202d 3e20 5370 6563  ct(self) -> Spec
-0001c900: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-0001c910: 3a0a 2020 2020 2020 2020 7265 7320 3d20  :.        res = 
-0001c920: 7365 6c66 2e67 6574 5f75 7070 6572 5f63  self.get_upper_c
-0001c930: 6f64 6528 3078 3037 2c20 6c61 6265 6c3d  ode(0x07, label=
-0001c940: 2247 4554 5f4f 5054 5f43 465f 5345 4c45  "GET_OPT_CF_SELE
-0001c950: 4354 222c 206d 7362 5f6c 656e 3d31 290a  CT", msb_len=1).
-0001c960: 2020 2020 2020 2020 6966 2072 6573 2e65          if res.e
-0001c970: 7272 6f72 5f6d 7367 2021 3d20 2727 3a0a  rror_msg != '':.
-0001c980: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001c990: 726e 2072 6573 0a20 2020 2020 2020 2072  rn res.        r
-0001c9a0: 6573 2e64 6174 6120 3d20 3020 213d 2072  es.data = 0 != r
-0001c9b0: 6573 2e64 6174 610a 2020 2020 2020 2020  es.data.        
-0001c9c0: 7265 7475 726e 2072 6573 0a0a 2020 2020  return res..    
-0001c9d0: 6465 6620 6765 745f 6f70 745f 6461 7461  def get_opt_data
-0001c9e0: 5f68 6561 6465 725f 7461 6228 7365 6c66  _header_tab(self
-0001c9f0: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-0001ca00: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-0001ca10: 2020 2072 6574 7572 6e20 7365 6c66 2e67     return self.g
-0001ca20: 6574 5f75 7070 6572 5f63 6f64 6528 3078  et_upper_code(0x
-0001ca30: 3036 2c20 6c61 6265 6c3d 2247 4554 5f4f  06, label="GET_O
-0001ca40: 5054 5f44 4154 415f 4845 4144 4552 5f54  PT_DATA_HEADER_T
-0001ca50: 4142 222c 206d 7362 5f6c 656e 3d31 290a  AB", msb_len=1).
-0001ca60: 0a20 2020 2064 6566 2067 6574 5f6f 7074  .    def get_opt
-0001ca70: 5f68 6f72 697a 6f6e 7461 6c5f 6269 6e6e  _horizontal_binn
-0001ca80: 696e 6728 7365 6c66 2920 2d3e 2053 7065  ing(self) -> Spe
-0001ca90: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-0001caa0: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-0001cab0: 6e20 7365 6c66 2e67 6574 5f75 7070 6572  n self.get_upper
-0001cac0: 5f63 6f64 6528 3078 3063 2c20 6c61 6265  _code(0x0c, labe
-0001cad0: 6c3d 2247 4554 5f4f 5054 5f48 4f52 495a  l="GET_OPT_HORIZ
-0001cae0: 4f4e 5441 4c5f 4249 4e4e 494e 4722 2c20  ONTAL_BINNING", 
-0001caf0: 6d73 625f 6c65 6e3d 3129 0a0a 2020 2020  msb_len=1)..    
-0001cb00: 6465 6620 6765 745f 6f70 745f 696e 7465  def get_opt_inte
-0001cb10: 6772 6174 696f 6e5f 7469 6d65 5f72 6573  gration_time_res
-0001cb20: 6f6c 7574 696f 6e28 7365 6c66 2920 2d3e  olution(self) ->
-0001cb30: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
-0001cb40: 706f 6e73 653a 0a20 2020 2020 2020 2072  ponse:.        r
-0001cb50: 6574 7572 6e20 7365 6c66 2e67 6574 5f75  eturn self.get_u
-0001cb60: 7070 6572 5f63 6f64 6528 3078 3035 2c20  pper_code(0x05, 
-0001cb70: 6c61 6265 6c3d 2247 4554 5f4f 5054 5f49  label="GET_OPT_I
-0001cb80: 4e54 4547 5241 5449 4f4e 5f54 494d 455f  NTEGRATION_TIME_
-0001cb90: 5245 534f 4c55 5449 4f4e 222c 206d 7362  RESOLUTION", msb
-0001cba0: 5f6c 656e 3d31 290a 0a20 2020 2023 2023  _len=1)..    # #
-0001cbb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001cbc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001cbd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001cbe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001cbf0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
-0001cc00: 416e 616c 6f67 206f 7574 7075 740a 2020  Analog output.  
-0001cc10: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
-0001cc20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001cc30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001cc40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001cc50: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-0001cc60: 2020 2020 2323 2040 7061 7261 6d20 7661      ## @param va
-0001cc70: 6c75 6520 2849 6e70 7574 2920 7475 706c  lue (Input) tupl
-0001cc80: 6520 6f66 2028 626f 6f6c 2065 6e61 626c  e of (bool enabl
-0001cc90: 652c 2069 6e74 206d 6f64 6529 0a20 2020  e, int mode).   
-0001cca0: 2064 6566 2073 6574 5f61 6e61 6c6f 675f   def set_analog_
-0001ccb0: 6f75 7470 7574 5f6d 6f64 6528 7365 6c66  output_mode(self
-0001ccc0: 2c20 7661 6c75 653a 2074 7570 6c65 5b62  , value: tuple[b
-0001ccd0: 6f6f 6c2c 2069 6e74 5d29 202d 3e20 5370  ool, int]) -> Sp
-0001cce0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0001ccf0: 7365 3a0a 2020 2020 2020 2020 6966 206e  se:.        if n
-0001cd00: 6f74 2073 656c 662e 7365 7474 696e 6773  ot self.settings
-0001cd10: 2e69 735f 6765 6e32 2829 3a0a 2020 2020  .is_gen2():.    
-0001cd20: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-0001cd30: 7272 6f72 2822 616e 616c 6f67 206f 7574  rror("analog out
-0001cd40: 7075 7420 6f6e 6c79 2061 7661 696c 6162  put only availab
-0001cd50: 6c65 206f 6e20 4765 6e32 2229 0a20 2020  le on Gen2").   
-0001cd60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001cd70: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001cd80: 6f6e 7365 2864 6174 613d 4661 6c73 652c  onse(data=False,
-0001cd90: 6572 726f 725f 6d73 673d 2261 6e61 6c6f  error_msg="analo
-0001cda0: 6720 6f75 7470 7574 2075 6e73 7570 706f  g output unsuppo
-0001cdb0: 7274 6564 2229 0a0a 2020 2020 2020 2020  rted")..        
-0001cdc0: 7749 6e64 6578 203d 2030 0a0a 2020 2020  wIndex = 0..    
-0001cdd0: 2020 2020 2320 7061 7273 6520 656e 6162      # parse enab
-0001cde0: 6c65 2061 6e64 206d 6f64 6520 6672 6f6d  le and mode from
-0001cdf0: 2076 616c 7565 2074 7570 6c65 0a20 2020   value tuple.   
-0001ce00: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0001ce10: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0001ce20: 6e63 6528 7661 6c75 655b 305d 2c20 626f  nce(value[0], bo
-0001ce30: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
-0001ce40: 2020 2020 2065 6e61 626c 6520 3d20 7661       enable = va
-0001ce50: 6c75 655b 305d 0a20 2020 2020 2020 2020  lue[0].         
-0001ce60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001ce70: 2020 2020 2020 2020 2065 6e61 626c 6520           enable 
-0001ce80: 3d20 7661 6c75 655b 305d 2021 3d20 300a  = value[0] != 0.
-0001ce90: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-0001cea0: 6520 3d20 696e 7428 7661 6c75 655b 315d  e = int(value[1]
-0001ceb0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001cec0: 2028 6d6f 6465 2021 3d20 3020 616e 6420   (mode != 0 and 
-0001ced0: 6d6f 6465 2021 3d20 3129 3a0a 2020 2020  mode != 1):.    
-0001cee0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0001cef0: 6572 2e65 7272 6f72 2822 696e 7661 6c69  er.error("invali
-0001cf00: 6420 616e 616c 6f67 206f 7574 7075 7420  d analog output 
-0001cf10: 6d6f 6465 2030 7825 3032 782c 2064 6973  mode 0x%02x, dis
-0001cf20: 6162 6c69 6e67 222c 206d 6f64 6529 0a20  abling", mode). 
-0001cf30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001cf40: 6e61 626c 6520 3d20 4661 6c73 650a 2020  nable = False.  
-0001cf50: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0001cf60: 6465 203d 2030 0a0a 2020 2020 2020 2020  de = 0..        
-0001cf70: 2020 2020 6966 2065 6e61 626c 653a 0a20      if enable:. 
-0001cf80: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001cf90: 496e 6465 7820 3d20 3078 3032 207c 206d  Index = 0x02 | m
-0001cfa0: 6f64 6520 2320 3078 3032 2073 6574 7320  ode # 0x02 sets 
-0001cfb0: 7468 6520 2265 6e61 626c 6522 2062 6974  the "enable" bit
-0001cfc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cfd0: 2073 656c 662e 7374 6174 652e 616e 616c   self.state.anal
-0001cfe0: 6f67 5f6f 7574 5f65 6e61 626c 6520 3d20  og_out_enable = 
-0001cff0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001d000: 2020 2020 2073 656c 662e 7374 6174 652e       self.state.
-0001d010: 616e 616c 6f67 5f6f 7574 5f6d 6f64 6520  analog_out_mode 
-0001d020: 3d20 6d6f 6465 0a20 2020 2020 2020 2020  = mode.         
-0001d030: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-0001d040: 652e 616e 616c 6f67 5f6f 7574 5f76 616c  e.analog_out_val
-0001d050: 7565 203d 2030 2069 6620 6d6f 6465 203d  ue = 0 if mode =
-0001d060: 3d20 3020 656c 7365 2034 3020 2320 346d  = 0 else 40 # 4m
-0001d070: 4120 6465 6661 756c 7420 6375 7272 656e  A default curren
-0001d080: 7420 696e 2064 6563 692d 6d41 0a20 2020  t in deci-mA.   
-0001d090: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001d0a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001d0b0: 496e 6465 7820 3d20 300a 2020 2020 2020  Index = 0.      
-0001d0c0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0001d0d0: 7461 7465 2e61 6e61 6c6f 675f 6f75 745f  tate.analog_out_
-0001d0e0: 656e 6162 6c65 203d 2046 616c 7365 0a20  enable = False. 
-0001d0f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001d100: 656c 662e 7374 6174 652e 616e 616c 6f67  elf.state.analog
-0001d110: 5f6f 7574 5f6d 6f64 6520 3d20 300a 2020  _out_mode = 0.  
-0001d120: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001d130: 6c66 2e73 7461 7465 2e61 6e61 6c6f 675f  lf.state.analog_
-0001d140: 6f75 745f 7661 6c75 6520 3d20 300a 0a20  out_value = 0.. 
-0001d150: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-0001d160: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0001d170: 722e 6572 726f 7228 2273 6574 5f61 6e61  r.error("set_ana
-0001d180: 6c6f 675f 6f75 7470 7574 5f6d 6f64 6520  log_output_mode 
-0001d190: 7461 6b65 7320 7475 706c 6520 6f66 2028  takes tuple of (
-0001d1a0: 626f 6f6c 2c20 696e 7429 2c20 6469 7361  bool, int), disa
-0001d1b0: 626c 696e 6722 290a 2020 2020 2020 2020  bling").        
-0001d1c0: 2020 2020 7749 6e64 6578 203d 2030 0a0a      wIndex = 0..
-0001d1d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001d1e0: 656c 662e 5f73 656e 645f 636f 6465 2862  elf._send_code(b
-0001d1f0: 5265 7175 6573 7420 203d 2030 7866 662c  Request  = 0xff,
-0001d200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d210: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001d220: 5661 6c75 6520 2020 203d 2030 7831 312c  Value    = 0x11,
-0001d230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d240: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001d250: 496e 6465 7820 2020 203d 2077 496e 6465  Index    = wInde
-0001d260: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0001d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d280: 206c 6162 656c 2020 2020 203d 2022 5345   label     = "SE
-0001d290: 545f 414e 414c 4f47 5f4f 5554 5f4d 4f44  T_ANALOG_OUT_MOD
-0001d2a0: 4522 290a 0a20 2020 2064 6566 2073 6574  E")..    def set
-0001d2b0: 5f61 6e61 6c6f 675f 6f75 7470 7574 5f76  _analog_output_v
-0001d2c0: 616c 7565 2873 656c 662c 2076 616c 7565  alue(self, value
-0001d2d0: 3a20 696e 7429 202d 3e20 5370 6563 7472  : int) -> Spectr
-0001d2e0: 6f6d 6574 6572 5265 7370 6f6e 7365 3a0a  ometerResponse:.
-0001d2f0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0001d300: 656c 662e 7365 7474 696e 6773 2e69 735f  elf.settings.is_
-0001d310: 6765 6e32 2829 3a0a 2020 2020 2020 2020  gen2():.        
-0001d320: 2020 2020 6c6f 6767 6572 2e65 7272 6f72      logger.error
-0001d330: 2822 616e 616c 6f67 206f 7574 7075 7420  ("analog output 
-0001d340: 6f6e 6c79 2061 7661 696c 6162 6c65 206f  only available o
-0001d350: 6e20 4765 6e32 2229 0a20 2020 2020 2020  n Gen2").       
-0001d360: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
-0001d370: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
-0001d380: 2864 6174 613d 4661 6c73 652c 6572 726f  (data=False,erro
-0001d390: 725f 6d73 673d 2261 6e61 6c6f 6720 6f75  r_msg="analog ou
-0001d3a0: 7470 7574 2075 6e73 7570 706f 7274 6564  tput unsupported
-0001d3b0: 2229 0a0a 2020 2020 2020 2020 2320 7370  ")..        # sp
-0001d3c0: 6563 7472 6f6d 6574 6572 2073 686f 756c  ectrometer shoul
-0001d3d0: 6420 7261 6e67 652d 6c69 6d69 742c 2062  d range-limit, b
-0001d3e0: 7574 206a 7573 7420 746f 2063 6f64 6966  ut just to codif
-0001d3f0: 793a 0a20 2020 2020 2020 2069 6620 7365  y:.        if se
-0001d400: 6c66 2e73 7461 7465 2e61 6e61 6c6f 675f  lf.state.analog_
-0001d410: 6f75 745f 6d6f 6465 203d 3d20 303a 0a20  out_mode == 0:. 
-0001d420: 2020 2020 2020 2020 2020 2023 2076 6f6c             # vol
-0001d430: 7461 6765 2028 6465 6369 766f 6c74 732c  tage (decivolts,
-0001d440: 2072 616e 6765 2030 2d35 3020 2830 2d35   range 0-50 (0-5
-0001d450: 5629 290a 2020 2020 2020 2020 2020 2020  V)).            
-0001d460: 6966 2076 616c 7565 203c 2030 3a0a 2020  if value < 0:.  
-0001d470: 2020 2020 2020 2020 2020 2020 2020 7661                va
-0001d480: 6c75 6520 3d20 300a 2020 2020 2020 2020  lue = 0.        
-0001d490: 2020 2020 6966 2076 616c 7565 203e 2035      if value > 5
-0001d4a0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0001d4b0: 2020 2076 616c 7565 203d 2035 300a 2020     value = 50.  
-0001d4c0: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-0001d4d0: 7374 6174 652e 616e 616c 6f67 5f6f 7574  state.analog_out
-0001d4e0: 5f6d 6f64 6520 3d3d 2031 3a0a 2020 2020  _mode == 1:.    
-0001d4f0: 2020 2020 2020 2020 2320 6375 7272 656e          # curren
-0001d500: 7420 2864 6563 692d 6d41 2c20 7261 6e67  t (deci-mA, rang
-0001d510: 6520 3430 2d32 3030 2028 342d 3230 6d41  e 40-200 (4-20mA
-0001d520: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-0001d530: 6620 7661 6c75 6520 3c20 3430 3a0a 2020  f value < 40:.  
-0001d540: 2020 2020 2020 2020 2020 2020 2020 7661                va
-0001d550: 6c75 6520 3d20 3430 0a20 2020 2020 2020  lue = 40.       
-0001d560: 2020 2020 2065 6c69 6620 7661 6c75 6520       elif value 
-0001d570: 3e20 3230 303a 0a20 2020 2020 2020 2020  > 200:.         
-0001d580: 2020 2020 2020 2076 616c 7565 203d 2032         value = 2
-0001d590: 3030 0a20 2020 2020 2020 2065 6c73 653a  00.        else:
-0001d5a0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0001d5b0: 2e65 7272 6f72 2822 696e 7661 6c69 6420  .error("invalid 
-0001d5c0: 616e 616c 6f67 206f 7574 206d 6f64 6520  analog out mode 
-0001d5d0: 2564 2c20 6967 6e6f 7269 6e67 2076 616c  %d, ignoring val
-0001d5e0: 7565 222c 2073 656c 662e 7374 6174 652e  ue", self.state.
-0001d5f0: 616e 616c 6f67 5f6f 7574 5f6d 6f64 6529  analog_out_mode)
-0001d600: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001d610: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
-0001d620: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
-0001d630: 6c73 652c 6572 726f 725f 6d73 673d 2269  lse,error_msg="i
-0001d640: 6e76 616c 6964 206d 6f64 6522 290a 0a20  nvalid mode").. 
-0001d650: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0001d660: 6c66 2e5f 7365 6e64 5f63 6f64 6528 6252  lf._send_code(bR
-0001d670: 6571 7565 7374 2020 3d20 3078 6666 2c0a  equest  = 0xff,.
-0001d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d690: 2020 2020 2020 2020 2020 2020 2020 7756                wV
-0001d6a0: 616c 7565 2020 2020 3d20 3078 3132 2c0a  alue    = 0x12,.
-0001d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d6c0: 2020 2020 2020 2020 2020 2020 2020 7749                wI
-0001d6d0: 6e64 6578 2020 2020 3d20 7661 6c75 652c  ndex    = value,
-0001d6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d6f0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001d700: 6162 656c 2020 2020 203d 2022 5345 545f  abel     = "SET_
-0001d710: 414e 414c 4f47 5f4f 5554 5f56 414c 5545  ANALOG_OUT_VALUE
-0001d720: 2229 0a0a 2020 2020 6465 6620 6765 745f  ")..    def get_
-0001d730: 616e 616c 6f67 5f6f 7574 7075 745f 7374  analog_output_st
-0001d740: 6174 6528 7365 6c66 2920 2d3e 2053 7065  ate(self) -> Spe
-0001d750: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
-0001d760: 653a 0a20 2020 2020 2020 2069 6620 6e6f  e:.        if no
-0001d770: 7420 7365 6c66 2e73 6574 7469 6e67 732e  t self.settings.
-0001d780: 6973 5f67 656e 3228 293a 0a20 2020 2020  is_gen2():.     
-0001d790: 2020 2020 2020 206c 6f67 6765 722e 6572         logger.er
-0001d7a0: 726f 7228 2261 6e61 6c6f 6720 6f75 7470  ror("analog outp
-0001d7b0: 7574 206f 6e6c 7920 6176 6169 6c61 626c  ut only availabl
-0001d7c0: 6520 6f6e 2047 656e 3222 290a 2020 2020  e on Gen2").    
-0001d7d0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-0001d7e0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0001d7f0: 6e73 6528 6461 7461 3d46 616c 7365 2c65  nse(data=False,e
-0001d800: 7272 6f72 5f6d 7367 3d22 616e 616c 6f67  rror_msg="analog
-0001d810: 206f 7574 7075 7420 756e 7375 7070 6f72   output unsuppor
-0001d820: 7465 6422 290a 0a20 2020 2020 2020 2072  ted")..        r
-0001d830: 6573 203d 2073 656c 662e 6765 745f 7570  es = self.get_up
-0001d840: 7065 725f 636f 6465 2830 7831 612c 2077  per_code(0x1a, w
-0001d850: 4c65 6e67 7468 3d33 2c20 6c61 6265 6c3d  Length=3, label=
-0001d860: 2247 4554 5f41 4e41 4c4f 475f 4f55 545f  "GET_ANALOG_OUT_
-0001d870: 5354 4154 4522 290a 2020 2020 2020 2020  STATE").        
-0001d880: 6966 2072 6573 2e65 7272 6f72 5f6d 7367  if res.error_msg
-0001d890: 2021 3d20 2727 3a0a 2020 2020 2020 2020   != '':.        
-0001d8a0: 2020 2020 7265 7475 726e 2072 6573 0a20      return res. 
-0001d8b0: 2020 2020 2020 2064 6174 6120 3d20 7265         data = re
-0001d8c0: 732e 6461 7461 0a20 2020 2020 2020 2069  s.data.        i
-0001d8d0: 6620 2864 6174 6120 6973 204e 6f6e 6520  f (data is None 
-0001d8e0: 6f72 206c 656e 2864 6174 6129 2021 3d20  or len(data) != 
-0001d8f0: 3329 3a0a 2020 2020 2020 2020 2020 2020  3):.            
-0001d900: 6c6f 6767 6572 2e65 7272 6f72 2822 696e  logger.error("in
-0001d910: 7661 6c69 6420 616e 616c 6f67 206f 7574  valid analog out
-0001d920: 2073 7461 7465 2072 6561 643a 2025 7322   state read: %s"
-0001d930: 2c20 6461 7461 290a 2020 2020 2020 2020  , data).        
-0001d940: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-0001d950: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-0001d960: 6461 7461 3d46 616c 7365 2c65 7272 6f72  data=False,error
-0001d970: 5f6d 7367 3d22 696e 7661 6c69 6420 616e  _msg="invalid an
-0001d980: 616c 6f67 206f 7574 2073 7461 7465 2072  alog out state r
-0001d990: 6561 6422 290a 0a20 2020 2020 2020 2069  ead")..        i
-0001d9a0: 6620 6461 7461 5b30 5d20 213d 2030 2061  f data[0] != 0 a
-0001d9b0: 6e64 2064 6174 615b 305d 2021 3d20 313a  nd data[0] != 1:
-0001d9c0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0001d9d0: 6765 722e 6572 726f 7228 2272 6563 6569  ger.error("recei
-0001d9e0: 7665 6420 696e 7661 6c69 6420 616e 616c  ved invalid anal
-0001d9f0: 6f67 206f 7574 2065 6e61 626c 653a 2025  og out enable: %
-0001da00: 6422 2c20 6461 7461 5b30 5d29 0a20 2020  d", data[0]).   
-0001da10: 2020 2020 2069 6620 6461 7461 5b31 5d20       if data[1] 
-0001da20: 213d 2030 2061 6e64 2064 6174 615b 315d  != 0 and data[1]
-0001da30: 2021 3d20 313a 0a20 2020 2020 2020 2020   != 1:.         
-0001da40: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
-0001da50: 2272 6563 6569 7665 6420 696e 7661 6c69  "received invali
-0001da60: 6420 616e 616c 6f67 206f 7574 206d 6f64  d analog out mod
-0001da70: 653a 2025 6422 2c20 6461 7461 5b31 5d29  e: %d", data[1])
-0001da80: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-0001da90: 7461 7465 2e61 6e61 6c6f 675f 6f75 745f  tate.analog_out_
-0001daa0: 656e 6162 6c65 203d 2064 6174 615b 305d  enable = data[0]
-0001dab0: 2021 3d20 300a 2020 2020 2020 2020 7365   != 0.        se
-0001dac0: 6c66 2e73 7461 7465 2e61 6e61 6c6f 675f  lf.state.analog_
-0001dad0: 6f75 745f 6d6f 6465 203d 2064 6174 615b  out_mode = data[
-0001dae0: 315d 0a20 2020 2020 2020 2073 656c 662e  1].        self.
-0001daf0: 7374 6174 652e 616e 616c 6f67 5f6f 7574  state.analog_out
-0001db00: 5f76 616c 7565 203d 2064 6174 615b 325d  _value = data[2]
-0001db10: 2023 206e 6f20 7261 6e67 652d 6368 6563   # no range-chec
-0001db20: 6b69 6e67 2061 7070 6c69 6564 0a20 2020  king applied.   
-0001db30: 2020 2020 2064 6174 6120 3d20 2873 656c       data = (sel
-0001db40: 662e 7374 6174 652e 616e 616c 6f67 5f6f  f.state.analog_o
-0001db50: 7574 5f65 6e61 626c 652c 0a20 2020 2020  ut_enable,.     
-0001db60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001db70: 7374 6174 652e 616e 616c 6f67 5f6f 7574  state.analog_out
-0001db80: 5f6d 6f64 652c 0a20 2020 2020 2020 2020  _mode,.         
-0001db90: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-0001dba0: 652e 616e 616c 6f67 5f6f 7574 5f76 616c  e.analog_out_val
-0001dbb0: 7565 290a 2020 2020 2020 2020 7265 7475  ue).        retu
-0001dbc0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-0001dbd0: 6573 706f 6e73 6528 6461 7461 3d64 6174  esponse(data=dat
-0001dbe0: 6129 0a0a 2020 2020 2320 4072 6574 7572  a)..    # @retur
-0001dbf0: 6e73 2064 6563 6976 6f6c 7473 0a20 2020  ns decivolts.   
-0001dc00: 2064 6566 2067 6574 5f61 6e61 6c6f 675f   def get_analog_
-0001dc10: 696e 7075 745f 7661 6c75 6528 7365 6c66  input_value(self
-0001dc20: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-0001dc30: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-0001dc40: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
-0001dc50: 6574 7469 6e67 732e 6973 5f67 656e 3228  ettings.is_gen2(
-0001dc60: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-0001dc70: 6f67 6765 722e 6572 726f 7228 2261 6e61  ogger.error("ana
-0001dc80: 6c6f 6720 696e 7075 7420 6f6e 6c79 2061  log input only a
-0001dc90: 7661 696c 6162 6c65 206f 6e20 4765 6e32  vailable on Gen2
-0001dca0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-0001dcb0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-0001dcc0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-0001dcd0: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
-0001dce0: 2261 6e61 6c6f 6720 696e 7075 7420 756e  "analog input un
-0001dcf0: 7375 7070 6f72 7465 6422 290a 2020 2020  supported").    
-0001dd00: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0001dd10: 6765 745f 7570 7065 725f 636f 6465 2830  get_upper_code(0
-0001dd20: 7831 622c 206c 7362 5f6c 656e 3d31 2c20  x1b, lsb_len=1, 
-0001dd30: 6c61 6265 6c3d 2247 4554 5f41 4e41 4c4f  label="GET_ANALO
-0001dd40: 475f 494e 5f56 414c 5545 2229 0a0a 2020  G_IN_VALUE")..  
-0001dd50: 2020 2320 2323 2323 2323 2323 2323 2323    # ############
-0001dd60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001dd70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001dd80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001dd90: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0001dda0: 2020 2023 2045 4550 524f 4d20 4372 7566     # EEPROM Cruf
-0001ddb0: 740a 2020 2020 2320 2323 2323 2323 2323  t.    # ########
-0001ddc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ddd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001dde0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ddf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001de00: 2323 0a0a 2020 2020 6465 6620 7570 6461  ##..    def upda
-0001de10: 7465 5f73 6573 7369 6f6e 5f65 6570 726f  te_session_eepro
-0001de20: 6d28 7365 6c66 2c20 7061 6972 3a20 7475  m(self, pair: tu
-0001de30: 706c 655b 7374 722c 2045 4550 524f 4d5d  ple[str, EEPROM]
-0001de40: 2920 2d3e 2053 7065 6374 726f 6d65 7465  ) -> Spectromete
-0001de50: 7252 6573 706f 6e73 653a 0a20 2020 2020  rResponse:.     
-0001de60: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
-0001de70: 6976 656e 2061 2028 7365 7269 616c 5f6e  iven a (serial_n
-0001de80: 756d 6265 722c 2045 4550 524f 4d29 2070  umber, EEPROM) p
-0001de90: 6169 722c 2075 7064 6174 6520 7468 6973  air, update this
-0001dea0: 2070 726f 6365 7373 2773 2022 7365 7373   process's "sess
-0001deb0: 696f 6e22 0a20 2020 2020 2020 2045 4550  ion".        EEP
-0001dec0: 524f 4d20 7769 7468 206a 7573 7420 7468  ROM with just th
-0001ded0: 6520 4544 4954 4142 4c45 2066 6965 6c64  e EDITABLE field
-0001dee0: 7320 6f66 2074 6865 2070 6173 7365 6420  s of the passed 
-0001def0: 4545 5052 4f4d 2e0a 2020 2020 2020 2020  EEPROM..        
-0001df00: 2222 220a 2020 2020 2020 2020 6c6f 672e  """.        log.
-0001df10: 6465 6275 6728 2266 6964 2e75 7064 6174  debug("fid.updat
-0001df20: 655f 7365 7373 696f 6e5f 6565 7072 6f6d  e_session_eeprom
-0001df30: 3a20 2573 2075 7064 6174 696e 6720 4545  : %s updating EE
-0001df40: 5052 4f4d 2069 6e73 7461 6e63 6522 2c20  PROM instance", 
-0001df50: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
-0001df60: 7072 6f6d 2e73 6572 6961 6c5f 6e75 6d62  prom.serial_numb
-0001df70: 6572 290a 0a20 2020 2020 2020 2069 6620  er)..        if 
-0001df80: 6e6f 7420 7365 6c66 2e65 6570 726f 6d5f  not self.eeprom_
-0001df90: 6261 636b 7570 3a0a 2020 2020 2020 2020  backup:.        
-0001dfa0: 2020 2020 7365 6c66 2e65 6570 726f 6d5f      self.eeprom_
-0001dfb0: 6261 636b 7570 203d 2063 6f70 792e 6465  backup = copy.de
-0001dfc0: 6570 636f 7079 2873 656c 662e 7365 7474  epcopy(self.sett
-0001dfd0: 696e 6773 2e65 6570 726f 6d29 0a0a 2020  ings.eeprom)..  
-0001dfe0: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-0001dff0: 6e67 732e 6565 7072 6f6d 2e75 7064 6174  ngs.eeprom.updat
-0001e000: 655f 6564 6974 6162 6c65 2870 6169 725b  e_editable(pair[
-0001e010: 315d 290a 2020 2020 2020 2020 7265 7475  1]).        retu
-0001e020: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
-0001e030: 6573 706f 6e73 6528 6461 7461 3d54 7275  esponse(data=Tru
-0001e040: 6529 0a0a 2020 2020 6465 6620 7265 706c  e)..    def repl
-0001e050: 6163 655f 7365 7373 696f 6e5f 6565 7072  ace_session_eepr
-0001e060: 6f6d 2873 656c 662c 2070 6169 723a 2074  om(self, pair: t
-0001e070: 7570 6c65 5b73 7472 2c20 4545 5052 4f4d  uple[str, EEPROM
-0001e080: 5d29 202d 3e20 5370 6563 7472 6f6d 6574  ]) -> Spectromet
-0001e090: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-0001e0a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001e0b0: 4769 7665 6e20 6120 2873 6572 6961 6c5f  Given a (serial_
-0001e0c0: 6e75 6d62 6572 2c20 4545 5052 4f4d 2920  number, EEPROM) 
-0001e0d0: 7061 6972 2c20 7265 706c 6163 6520 7468  pair, replace th
-0001e0e0: 6973 2070 726f 6365 7373 2773 2022 7365  is process's "se
-0001e0f0: 7373 696f 6e22 0a20 2020 2020 2020 2045  ssion".        E
-0001e100: 4550 524f 4d20 7769 7468 2074 6865 2070  EPROM with the p
-0001e110: 6173 7365 6420 4545 5052 4f4d 2e0a 2020  assed EEPROM..  
-0001e120: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001e130: 2020 6c6f 672e 6465 6275 6728 2266 6964    log.debug("fid
-0001e140: 2e72 6570 6c61 6365 5f73 6573 7369 6f6e  .replace_session
-0001e150: 5f65 6570 726f 6d3a 2025 7320 7265 706c  _eeprom: %s repl
-0001e160: 6163 696e 6720 4545 5052 4f4d 2069 6e73  acing EEPROM ins
-0001e170: 7461 6e63 6522 2c20 7365 6c66 2e73 6574  tance", self.set
-0001e180: 7469 6e67 732e 6565 7072 6f6d 2e73 6572  tings.eeprom.ser
-0001e190: 6961 6c5f 6e75 6d62 6572 290a 0a20 2020  ial_number)..   
-0001e1a0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-0001e1b0: 2e65 6570 726f 6d5f 6261 636b 7570 3a0a  .eeprom_backup:.
-0001e1c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001e1d0: 2e65 6570 726f 6d5f 6261 636b 7570 203d  .eeprom_backup =
-0001e1e0: 2063 6f70 792e 6465 6570 636f 7079 2873   copy.deepcopy(s
-0001e1f0: 656c 662e 7365 7474 696e 6773 2e65 6570  elf.settings.eep
-0001e200: 726f 6d29 0a0a 2020 2020 2020 2020 7365  rom)..        se
-0001e210: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
-0001e220: 6f6d 203d 2070 6169 725b 315d 0a20 2020  om = pair[1].   
-0001e230: 2020 2020 2073 656c 662e 7365 7474 696e       self.settin
-0001e240: 6773 2e65 6570 726f 6d2e 6475 6d70 2829  gs.eeprom.dump()
-0001e250: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001e260: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
-0001e270: 6f6e 7365 2829 0a0a 2020 2020 2323 2041  onse()..    ## A
-0001e280: 6374 7561 6c6c 7920 7374 6f72 6520 7468  ctually store th
-0001e290: 6520 6375 7272 656e 7420 7365 7373 696f  e current sessio
-0001e2a0: 6e20 4545 5052 4f4d 2066 6965 6c64 7320  n EEPROM fields 
-0001e2b0: 746f 2074 6865 2073 7065 6374 726f 6d65  to the spectrome
-0001e2c0: 7465 722e 0a20 2020 2064 6566 2077 7269  ter..    def wri
-0001e2d0: 7465 5f65 6570 726f 6d28 7365 6c66 2920  te_eeprom(self) 
-0001e2e0: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
-0001e2f0: 6573 706f 6e73 653a 0a20 2020 2020 2020  esponse:.       
-0001e300: 2069 6620 6e6f 7420 7365 6c66 2e65 6570   if not self.eep
-0001e310: 726f 6d5f 6261 636b 7570 3a0a 2020 2020  rom_backup:.    
-0001e320: 2020 2020 2020 2020 6c6f 672e 6372 6974          log.crit
-0001e330: 6963 616c 2822 6578 7065 6374 6564 2074  ical("expected t
-0001e340: 6f20 7570 6461 7465 206f 7220 7265 706c  o update or repl
-0001e350: 6163 6520 4545 5052 4f4d 206f 626a 6563  ace EEPROM objec
-0001e360: 7420 6265 666f 7265 2077 7269 7465 2063  t before write c
-0001e370: 6f6d 6d61 6e64 2229 0a20 2020 2020 2020  ommand").       
-0001e380: 2020 2020 2073 656c 662e 7175 6575 655f       self.queue_
-0001e390: 6d65 7373 6167 6528 226d 6172 7175 6565  message("marquee
-0001e3a0: 5f65 7272 6f72 222c 2022 4661 696c 6564  _error", "Failed
-0001e3b0: 2074 6f20 7772 6974 6520 4545 5052 4f4d   to write EEPROM
-0001e3c0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-0001e3d0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-0001e3e0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-0001e3f0: 4661 6c73 652c 6572 726f 725f 6d73 673d  False,error_msg=
-0001e400: 2266 6169 6c65 6420 746f 2077 7269 7465  "failed to write
-0001e410: 2065 6570 726f 6d22 290a 0a20 2020 2020   eeprom")..     
-0001e420: 2020 2023 2062 6163 6b75 7020 636f 6e74     # backup cont
-0001e430: 656e 7473 206f 6620 7072 6576 696f 7573  ents of previous
-0001e440: 2045 4550 524f 4d20 696e 206c 6f67 0a20   EEPROM in log. 
-0001e450: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
-0001e460: 2822 4f72 6967 696e 616c 2045 4550 524f  ("Original EEPRO
-0001e470: 4d20 636f 6e74 656e 7473 2229 0a20 2020  M contents").   
-0001e480: 2020 2020 2073 656c 662e 6565 7072 6f6d       self.eeprom
-0001e490: 5f62 6163 6b75 702e 6475 6d70 2829 0a20  _backup.dump(). 
-0001e4a0: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
-0001e4b0: 2822 4f72 6967 696e 616c 2045 4550 524f  ("Original EEPRO
-0001e4c0: 4d20 6275 6666 6572 733a 2025 7322 2c20  M buffers: %s", 
-0001e4d0: 7365 6c66 2e65 6570 726f 6d5f 6261 636b  self.eeprom_back
-0001e4e0: 7570 2e62 7566 6665 7273 290a 0a20 2020  up.buffers)..   
-0001e4f0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0001e500: 2020 2020 2020 7365 6c66 2e73 6574 7469        self.setti
-0001e510: 6e67 732e 6565 7072 6f6d 2e67 656e 6572  ngs.eeprom.gener
-0001e520: 6174 655f 7772 6974 655f 6275 6666 6572  ate_write_buffer
-0001e530: 7328 290a 2020 2020 2020 2020 6578 6365  s().        exce
-0001e540: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0001e550: 6c6f 672e 6372 6974 6963 616c 2822 6661  log.critical("fa
-0001e560: 696c 6564 2074 6f20 7265 6e64 6572 2045  iled to render E
-0001e570: 4550 524f 4d20 7772 6974 6520 6275 6666  EPROM write buff
-0001e580: 6572 7322 2c20 6578 635f 696e 666f 3d31  ers", exc_info=1
-0001e590: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0001e5a0: 6c66 2e71 7565 7565 5f6d 6573 7361 6765  lf.queue_message
-0001e5b0: 2822 6d61 7271 7565 655f 6572 726f 7222  ("marquee_error"
-0001e5c0: 2c20 2246 6169 6c65 6420 746f 2077 7269  , "Failed to wri
-0001e5d0: 7465 2045 4550 524f 4d22 290a 2020 2020  te EEPROM").    
-0001e5e0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-0001e5f0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0001e600: 6e73 6528 6461 7461 3d46 616c 7365 2c65  nse(data=False,e
-0001e610: 7272 6f72 5f6d 7367 3d22 6661 696c 6564  rror_msg="failed
-0001e620: 2074 6f20 6765 6e65 7261 7465 2065 6570   to generate eep
-0001e630: 726f 6d22 290a 0a20 2020 2020 2020 206c  rom")..        l
-0001e640: 6f67 2e64 6562 7567 2822 576f 756c 6420  og.debug("Would 
-0001e650: 7772 6974 6520 6e65 7720 6275 6666 6572  write new buffer
-0001e660: 733a 2025 7322 2c20 7365 6c66 2e73 6574  s: %s", self.set
-0001e670: 7469 6e67 732e 6565 7072 6f6d 2e77 7269  tings.eeprom.wri
-0001e680: 7465 5f62 7566 6665 7273 290a 0a20 2020  te_buffers)..   
-0001e690: 2020 2020 2066 6f72 2070 6167 6520 696e       for page in
-0001e6a0: 2072 616e 6765 2845 4550 524f 4d2e 4d41   range(EEPROM.MA
-0001e6b0: 585f 5041 4745 5329 3a0a 2020 2020 2020  X_PAGES):.      
-0001e6c0: 2020 2020 2020 6966 2073 656c 662e 7365        if self.se
-0001e6d0: 7474 696e 6773 2e69 735f 6172 6d28 293a  ttings.is_arm():
-0001e6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e6f0: 206c 6f67 2e64 6562 7567 2822 7772 6974   log.debug("writ
-0001e700: 696e 6720 7061 6765 2025 643a 2025 7322  ing page %d: %s"
-0001e710: 2c20 7061 6765 2c20 7365 6c66 2e73 6574  , page, self.set
-0001e720: 7469 6e67 732e 6565 7072 6f6d 2e77 7269  tings.eeprom.wri
-0001e730: 7465 5f62 7566 6665 7273 5b70 6167 655d  te_buffers[page]
-0001e740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e750: 2020 7365 6c66 2e5f 7365 6e64 5f63 6f64    self._send_cod
-0001e760: 6528 6252 6571 7565 7374 2020 2020 2020  e(bRequest      
-0001e770: 2020 3d20 3078 6666 2c20 2320 7365 636f    = 0xff, # seco
-0001e780: 6e64 2d74 6965 720a 2020 2020 2020 2020  nd-tier.        
-0001e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7a0: 2020 2020 2020 2077 5661 6c75 6520 2020         wValue   
-0001e7b0: 2020 2020 2020 203d 2030 7830 322c 0a20         = 0x02,. 
-0001e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7d0: 2020 2020 2020 2020 2020 2020 2020 7749                wI
-0001e7e0: 6e64 6578 2020 2020 2020 2020 2020 3d20  ndex          = 
-0001e7f0: 7061 6765 2c0a 2020 2020 2020 2020 2020  page,.          
-0001e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e810: 2020 2020 2064 6174 615f 6f72 5f77 4c65       data_or_wLe
-0001e820: 6e67 7468 203d 2073 656c 662e 7365 7474  ngth = self.sett
-0001e830: 696e 6773 2e65 6570 726f 6d2e 7772 6974  ings.eeprom.writ
-0001e840: 655f 6275 6666 6572 735b 7061 6765 5d2c  e_buffers[page],
-0001e850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e870: 6c61 6265 6c20 2020 2020 2020 2020 2020  label           
-0001e880: 3d20 2257 5249 5445 5f45 4550 524f 4d22  = "WRITE_EEPROM"
-0001e890: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0001e8a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001e8b0: 2020 2020 4441 5441 5f53 5441 5254 203d      DATA_START =
-0001e8c0: 2030 7833 6330 300a 2020 2020 2020 2020   0x3c00.        
-0001e8d0: 2020 2020 2020 2020 6f66 6673 6574 203d          offset =
-0001e8e0: 2044 4154 415f 5354 4152 5420 2b20 7061   DATA_START + pa
-0001e8f0: 6765 202a 2036 340a 2020 2020 2020 2020  ge * 64.        
-0001e900: 2020 2020 2020 2020 6c6f 672e 6465 6275          log.debu
-0001e910: 6728 2277 7269 7469 6e67 2070 6167 6520  g("writing page 
-0001e920: 2564 2061 7420 6f66 6673 6574 2030 7825  %d at offset 0x%
-0001e930: 3034 783a 2025 7322 2c20 7061 6765 2c20  04x: %s", page, 
-0001e940: 6f66 6673 6574 2c20 7365 6c66 2e73 6574  offset, self.set
-0001e950: 7469 6e67 732e 6565 7072 6f6d 2e77 7269  tings.eeprom.wri
-0001e960: 7465 5f62 7566 6665 7273 5b70 6167 655d  te_buffers[page]
-0001e970: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e980: 2020 7365 6c66 2e5f 7365 6e64 5f63 6f64    self._send_cod
-0001e990: 6528 6252 6571 7565 7374 2020 2020 2020  e(bRequest      
-0001e9a0: 2020 3d20 3078 6132 2c20 2020 2320 6461    = 0xa2,   # da
-0001e9b0: 6e67 6572 6f75 730a 2020 2020 2020 2020  ngerous.        
-0001e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9d0: 2020 2020 2020 2077 5661 6c75 6520 2020         wValue   
-0001e9e0: 2020 2020 2020 203d 206f 6666 7365 742c         = offset,
-0001e9f0: 2023 2061 7267 7561 626c 7920 616e 2069   # arguably an i
-0001ea00: 6e64 6578 2062 7574 2068 6579 0a20 2020  ndex but hey.   
-0001ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea20: 2020 2020 2020 2020 2020 2020 7749 6e64              wInd
-0001ea30: 6578 2020 2020 2020 2020 2020 3d20 302c  ex          = 0,
-0001ea40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea60: 6461 7461 5f6f 725f 774c 656e 6774 6820  data_or_wLength 
-0001ea70: 3d20 7365 6c66 2e73 6574 7469 6e67 732e  = self.settings.
-0001ea80: 6565 7072 6f6d 2e77 7269 7465 5f62 7566  eeprom.write_buf
-0001ea90: 6665 7273 5b70 6167 655d 2c0a 2020 2020  fers[page],.    
-0001eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eab0: 2020 2020 2020 2020 2020 206c 6162 656c             label
-0001eac0: 2020 2020 2020 2020 2020 203d 2022 5752             = "WR
-0001ead0: 4954 455f 4545 5052 4f4d 2229 0a0a 2020  ITE_EEPROM")..  
-0001eae0: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-0001eaf0: 5f6d 6573 7361 6765 2822 6d61 7271 7565  _message("marque
-0001eb00: 655f 696e 666f 222c 2022 4545 5052 4f4d  e_info", "EEPROM
-0001eb10: 2073 7563 6365 7373 6675 6c6c 7920 7570   successfully up
-0001eb20: 6461 7465 6422 290a 0a20 2020 2020 2020  dated")..       
-0001eb30: 2023 2061 6e79 2076 616c 7565 2069 6e20   # any value in 
-0001eb40: 646f 696e 6720 7468 6973 3f0a 2020 2020  doing this?.    
-0001eb50: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
-0001eb60: 732e 6565 7072 6f6d 2e62 7566 6665 7273  s.eeprom.buffers
-0001eb70: 203d 2073 656c 662e 7365 7474 696e 6773   = self.settings
-0001eb80: 2e65 6570 726f 6d2e 7772 6974 655f 6275  .eeprom.write_bu
-0001eb90: 6666 6572 730a 0a20 2020 2020 2020 2072  ffers..        r
-0001eba0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
-0001ebb0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
-0001ebc0: 5472 7565 290a 0a20 2020 2023 2023 2323  True)..    # ###
-0001ebd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ebe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ebf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ec00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ec10: 2323 2323 2323 230a 2020 2020 2320 496e  #######.    # In
-0001ec20: 7465 7270 726f 6365 7373 2043 6f6d 6d75  terprocess Commu
-0001ec30: 6e69 6361 7469 6f6e 730a 2020 2020 2320  nications.    # 
-0001ec40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ec50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ec60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ec70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ec80: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-0001ec90: 2320 4074 6f64 6f20 6d6f 7665 2073 7472  # @todo move str
-0001eca0: 696e 672d 746f 2d65 6e75 6d20 636f 6e76  ing-to-enum conv
-0001ecb0: 6572 7465 7220 746f 2041 7070 4c6f 670a  erter to AppLog.
-0001ecc0: 2020 2020 6465 6620 7365 745f 6c6f 675f      def set_log_
-0001ecd0: 6c65 7665 6c28 7365 6c66 2c20 733a 2073  level(self, s: s
-0001ece0: 7472 2920 2d3e 2053 7065 6374 726f 6d65  tr) -> Spectrome
-0001ecf0: 7465 7252 6573 706f 6e73 653a 0a20 2020  terResponse:.   
-0001ed00: 2020 2020 206c 766c 203d 206c 6f67 6769       lvl = loggi
-0001ed10: 6e67 2e44 4542 5547 2069 6620 7320 3d3d  ng.DEBUG if s ==
-0001ed20: 2022 4445 4255 4722 2065 6c73 6520 6c6f   "DEBUG" else lo
-0001ed30: 6767 696e 672e 494e 464f 0a20 2020 2020  gging.INFO.     
-0001ed40: 2020 206c 6f67 2e64 6562 7567 2822 6669     log.debug("fi
-0001ed50: 642e 7365 745f 6c6f 675f 6c65 7665 6c3a  d.set_log_level:
-0001ed60: 2073 6574 7469 6e67 2074 6f20 2573 222c   setting to %s",
-0001ed70: 206c 766c 290a 2020 2020 2020 2020 6c6f   lvl).        lo
-0001ed80: 6767 696e 672e 6765 744c 6f67 6765 7228  gging.getLogger(
-0001ed90: 292e 7365 744c 6576 656c 286c 766c 290a  ).setLevel(lvl).
-0001eda0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-0001edb0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
-0001edc0: 6e73 6528 290a 0a20 2020 2064 6566 2071  nse()..    def q
-0001edd0: 7565 7565 5f6d 6573 7361 6765 2873 656c  ueue_message(sel
-0001ede0: 662c 2073 6574 7469 6e67 2c20 7661 6c75  f, setting, valu
-0001edf0: 6529 202d 3e20 5370 6563 7472 6f6d 6574  e) -> Spectromet
-0001ee00: 6572 5265 7370 6f6e 7365 3a0a 2020 2020  erResponse:.    
-0001ee10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001ee20: 4966 2061 6e20 7570 7374 7265 616d 2071  If an upstream q
-0001ee30: 7565 7565 2069 7320 6465 6669 6e65 642c  ueue is defined,
-0001ee40: 2073 656e 6420 7468 6520 6e61 6d65 2d76   send the name-v
-0001ee50: 616c 7565 2070 6169 722e 2020 446f 6573  alue pair.  Does
-0001ee60: 206e 6f74 6869 6e67 0a20 2020 2020 2020   nothing.       
-0001ee70: 2069 6620 7468 6520 6361 6c6c 6572 2068   if the caller h
-0001ee80: 6173 6e27 7420 7072 6f76 6964 6564 2061  asn't provided a
-0001ee90: 2071 7565 7565 2e0a 2020 2020 2020 2020   queue..        
-0001eea0: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-0001eeb0: 656c 662e 6d65 7373 6167 655f 7175 6575  elf.message_queu
-0001eec0: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-0001eed0: 2020 2020 2020 2072 6574 7572 6e20 5370         return Sp
-0001eee0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
-0001eef0: 7365 2864 6174 613d 4661 6c73 6529 0a0a  se(data=False)..
-0001ef00: 2020 2020 2020 2020 6d73 6720 3d20 5374          msg = St
-0001ef10: 6174 7573 4d65 7373 6167 6528 7365 7474  atusMessage(sett
-0001ef20: 696e 672c 2076 616c 7565 290a 2020 2020  ing, value).    
-0001ef30: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0001ef40: 2020 2020 2073 656c 662e 6d65 7373 6167       self.messag
-0001ef50: 655f 7175 6575 652e 7075 7428 6d73 6729  e_queue.put(msg)
-0001ef60: 2023 2070 7574 5f6e 6f77 6169 7428 6d73   # put_nowait(ms
-0001ef70: 6729 0a20 2020 2020 2020 2065 7863 6570  g).        excep
-0001ef80: 743a 0a20 2020 2020 2020 2020 2020 206c  t:.            l
-0001ef90: 6f67 2e65 7272 6f72 2822 6661 696c 6564  og.error("failed
-0001efa0: 2074 6f20 656e 7175 6575 6520 5374 6174   to enqueue Stat
-0001efb0: 7573 4d65 7373 6167 6520 2825 732c 2025  usMessage (%s, %
-0001efc0: 7329 222c 2073 6574 7469 6e67 2c20 7661  s)", setting, va
-0001efd0: 6c75 652c 2065 7863 5f69 6e66 6f3d 3129  lue, exc_info=1)
-0001efe0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001eff0: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
-0001f000: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
-0001f010: 6c73 652c 6572 726f 725f 6d73 673d 2266  lse,error_msg="f
-0001f020: 6169 6c65 6420 746f 2065 6e71 7565 7565  ailed to enqueue
-0001f030: 206d 6573 7373 6167 6522 290a 2020 2020   messsage").    
-0001f040: 2020 2020 7265 7475 726e 2053 7065 6374      return Spect
-0001f050: 726f 6d65 7465 7252 6573 706f 6e73 6528  rometerResponse(
-0001f060: 6461 7461 3d54 7275 6529 0a0a 2020 2020  data=True)..    
-0001f070: 6465 6620 5f69 6e69 745f 7072 6f63 6573  def _init_proces
-0001f080: 735f 6675 6e63 7328 7365 6c66 2920 2d3e  s_funcs(self) ->
-0001f090: 2064 6963 745b 7374 722c 2043 616c 6c61   dict[str, Calla
-0001f0a0: 626c 655b 2e2e 2e2c 2041 6e79 5d5d 3a0a  ble[..., Any]]:.
-0001f0b0: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
-0001f0c0: 6620 3d20 7b7d 0a0a 2020 2020 2020 2020  f = {}..        
-0001f0d0: 666f 7220 666f 6f20 696e 205b 2022 636f  for foo in [ "co
-0001f0e0: 6e6e 6563 7422 2c0a 2020 2020 2020 2020  nnect",.        
-0001f0f0: 2020 2020 2020 2020 2020 2020 2022 6469               "di
-0001f100: 7363 6f6e 6e65 6374 222c 0a20 2020 2020  sconnect",.     
-0001f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f120: 2267 6574 5f62 6174 7465 7279 5f72 6567  "get_battery_reg
-0001f130: 6973 7465 7222 2c0a 2020 2020 2020 2020  ister",.        
-0001f140: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
-0001f150: 745f 6261 7474 6572 795f 7374 6174 655f  t_battery_state_
-0001f160: 7261 7722 2c0a 2020 2020 2020 2020 2020  raw",.          
-0001f170: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
-0001f180: 6261 7474 6572 795f 7065 7263 656e 7461  battery_percenta
-0001f190: 6765 222c 0a20 2020 2020 2020 2020 2020  ge",.           
-0001f1a0: 2020 2020 2020 2020 2020 2267 6574 5f62            "get_b
-0001f1b0: 6174 7465 7279 5f63 6861 7267 696e 6722  attery_charging"
-0001f1c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f1d0: 2020 2020 2020 2022 6765 745f 696e 7465         "get_inte
-0001f1e0: 6772 6174 696f 6e5f 7469 6d65 5f6d 7322  gration_time_ms"
-0001f1f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f200: 2020 2020 2020 2022 7365 745f 6466 755f         "set_dfu_
-0001f210: 656e 6162 6c65 222c 0a20 2020 2020 2020  enable",.       
-0001f220: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0001f230: 6574 5f64 6574 6563 746f 725f 6f66 6673  et_detector_offs
-0001f240: 6574 222c 0a20 2020 2020 2020 2020 2020  et",.           
-0001f250: 2020 2020 2020 2020 2020 2273 6574 5f64            "set_d
-0001f260: 6574 6563 746f 725f 6f66 6673 6574 5f6f  etector_offset_o
-0001f270: 6464 222c 0a20 2020 2020 2020 2020 2020  dd",.           
-0001f280: 2020 2020 2020 2020 2020 2267 6574 5f64            "get_d
-0001f290: 6574 6563 746f 725f 6761 696e 222c 0a20  etector_gain",. 
-0001f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2b0: 2020 2020 2267 6574 5f64 6574 6563 746f      "get_detecto
-0001f2c0: 725f 6761 696e 5f6f 6464 222c 0a20 2020  r_gain_odd",.   
-0001f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2e0: 2020 2273 6574 5f64 6574 6563 746f 725f    "set_detector_
-0001f2f0: 6761 696e 222c 0a20 2020 2020 2020 2020  gain",.         
-0001f300: 2020 2020 2020 2020 2020 2020 2273 6574              "set
-0001f310: 5f64 6574 6563 746f 725f 6761 696e 5f6f  _detector_gain_o
-0001f320: 6464 222c 0a20 2020 2020 2020 2020 2020  dd",.           
-0001f330: 2020 2020 2020 2020 2020 2273 6574 5f61            "set_a
-0001f340: 7265 615f 7363 616e 5f65 6e61 626c 6522  rea_scan_enable"
-0001f350: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f360: 2020 2020 2020 2022 6765 745f 7365 6e73         "get_sens
-0001f370: 6f72 5f6c 696e 655f 6c65 6e67 7468 222c  or_line_length",
-0001f380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f390: 2020 2020 2020 2267 6574 5f6d 6963 726f        "get_micro
-0001f3a0: 636f 6e74 726f 6c6c 6572 5f66 6972 6d77  controller_firmw
-0001f3b0: 6172 655f 7665 7273 696f 6e22 2c0a 2020  are_version",.  
-0001f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3d0: 2020 2022 6765 745f 6670 6761 5f66 6972     "get_fpga_fir
-0001f3e0: 6d77 6172 655f 7665 7273 696f 6e22 2c0a  mware_version",.
-0001f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f400: 2020 2020 2022 6765 745f 6c69 6e65 222c       "get_line",
-0001f410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f420: 2020 2020 2020 2273 6574 5f69 6e74 6567        "set_integ
-0001f430: 7261 7469 6f6e 5f74 696d 655f 6d73 222c  ration_time_ms",
-0001f440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f450: 2020 2020 2020 2273 656c 6563 745f 6164        "select_ad
-0001f460: 6322 2c0a 2020 2020 2020 2020 2020 2020  c",.            
-0001f470: 2020 2020 2020 2020 2022 6765 745f 7365           "get_se
-0001f480: 636f 6e64 6172 795f 6164 635f 6361 6c69  condary_adc_cali
-0001f490: 6272 6174 6564 222c 0a20 2020 2020 2020  brated",.       
-0001f4a0: 2020 2020 2020 2020 2020 2020 2020 2267                "g
-0001f4b0: 6574 5f73 6563 6f6e 6461 7279 5f61 6463  et_secondary_adc
-0001f4c0: 5f72 6177 222c 0a20 2020 2020 2020 2020  _raw",.         
-0001f4d0: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-0001f4e0: 5f6c 6173 6572 5f74 656d 7065 7261 7475  _laser_temperatu
-0001f4f0: 7265 5f72 6177 222c 0a20 2020 2020 2020  re_raw",.       
-0001f500: 2020 2020 2020 2020 2020 2020 2020 2267                "g
-0001f510: 6574 5f6c 6173 6572 5f74 656d 7065 7261  et_laser_tempera
-0001f520: 7475 7265 5f64 6567 4322 2c0a 2020 2020  ture_degC",.    
-0001f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f540: 2022 6765 745f 6465 7465 6374 6f72 5f74   "get_detector_t
-0001f550: 656d 7065 7261 7475 7265 5f72 6177 222c  emperature_raw",
-0001f560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f570: 2020 2020 2020 2267 6574 5f64 6574 6563        "get_detec
-0001f580: 746f 725f 7465 6d70 6572 6174 7572 655f  tor_temperature_
-0001f590: 6465 6743 222c 0a20 2020 2020 2020 2020  degC",.         
-0001f5a0: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-0001f5b0: 5f64 6574 6563 746f 725f 7465 635f 7365  _detector_tec_se
-0001f5c0: 7470 6f69 6e74 5f64 6567 4322 2c0a 2020  tpoint_degC",.  
-0001f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5e0: 2020 2022 6765 745f 6461 6322 2c0a 2020     "get_dac",.  
-0001f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f600: 2020 2022 7365 745f 7465 635f 656e 6162     "set_tec_enab
-0001f610: 6c65 222c 0a20 2020 2020 2020 2020 2020  le",.           
-0001f620: 2020 2020 2020 2020 2020 2273 6574 5f74            "set_t
-0001f630: 7269 6767 6572 5f73 6f75 7263 6522 2c0a  rigger_source",.
-0001f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f650: 2020 2020 2022 7365 745f 6869 6768 5f67       "set_high_g
-0001f660: 6169 6e5f 6d6f 6465 5f65 6e61 626c 6522  ain_mode_enable"
-0001f670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f680: 2020 2020 2020 2022 6765 745f 6869 6768         "get_high
-0001f690: 5f67 6169 6e5f 6d6f 6465 5f65 6e61 626c  _gain_mode_enabl
-0001f6a0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
-0001f6b0: 2020 2020 2020 2020 2020 2267 6574 5f6f            "get_o
-0001f6c0: 7074 5f6c 6173 6572 5f63 6f6e 7472 6f6c  pt_laser_control
-0001f6d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001f6e0: 2020 2020 2020 2020 2267 6574 5f6f 7074          "get_opt
-0001f6f0: 5f68 6173 5f6c 6173 6572 222c 0a20 2020  _has_laser",.   
-0001f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f710: 2020 2273 6574 5f64 6574 6563 746f 725f    "set_detector_
-0001f720: 7465 635f 7365 7470 6f69 6e74 5f64 6567  tec_setpoint_deg
-0001f730: 4322 2c0a 2020 2020 2020 2020 2020 2020  C",.            
-0001f740: 2020 2020 2020 2020 2022 6765 745f 6465           "get_de
-0001f750: 7465 6374 6f72 5f74 6563 5f73 6574 706f  tector_tec_setpo
-0001f760: 696e 745f 7261 7722 2c0a 2020 2020 2020  int_raw",.      
-0001f770: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001f780: 7365 745f 7365 6c65 6374 6564 5f6c 6173  set_selected_las
-0001f790: 6572 222c 0a20 2020 2020 2020 2020 2020  er",.           
-0001f7a0: 2020 2020 2020 2020 2020 2267 6574 5f73            "get_s
-0001f7b0: 656c 6563 7465 645f 6c61 7365 7222 2c0a  elected_laser",.
-0001f7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7d0: 2020 2020 2022 6765 745f 6c61 7365 725f       "get_laser_
-0001f7e0: 656e 6162 6c65 6422 2c0a 2020 2020 2020  enabled",.      
-0001f7f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001f800: 7365 745f 6c61 7365 725f 656e 6162 6c65  set_laser_enable
-0001f810: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001f820: 2020 2020 2020 2020 2273 6574 5f6c 6173          "set_las
-0001f830: 6572 5f70 6f77 6572 5f72 616d 7069 6e67  er_power_ramping
-0001f840: 5f65 6e61 626c 6522 2c0a 2020 2020 2020  _enable",.      
-0001f850: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001f860: 6765 745f 6c61 7365 725f 706f 7765 725f  get_laser_power_
-0001f870: 7261 6d70 696e 675f 656e 6162 6c65 6422  ramping_enabled"
-0001f880: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f890: 2020 2020 2020 2022 6861 735f 6c61 7365         "has_lase
-0001f8a0: 725f 706f 7765 725f 6361 6c69 6272 6174  r_power_calibrat
-0001f8b0: 696f 6e22 2c0a 2020 2020 2020 2020 2020  ion",.          
-0001f8c0: 2020 2020 2020 2020 2020 2022 7365 745f             "set_
-0001f8d0: 6c61 7365 725f 706f 7765 725f 6d57 222c  laser_power_mW",
-0001f8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f8f0: 2020 2020 2020 2273 6574 5f6c 6173 6572        "set_laser
-0001f900: 5f70 6f77 6572 5f68 6967 685f 7265 736f  _power_high_reso
-0001f910: 6c75 7469 6f6e 222c 0a20 2020 2020 2020  lution",.       
-0001f920: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0001f930: 6574 5f6c 6173 6572 5f70 6f77 6572 5f72  et_laser_power_r
-0001f940: 6571 7569 7265 5f6d 6f64 756c 6174 696f  equire_modulatio
-0001f950: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-0001f960: 2020 2020 2020 2020 2022 7365 745f 6c61           "set_la
-0001f970: 7365 725f 706f 7765 725f 7065 7263 222c  ser_power_perc",
-0001f980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f990: 2020 2020 2020 2273 6574 5f6c 6173 6572        "set_laser
-0001f9a0: 5f70 6f77 6572 5f70 6572 635f 696d 6d65  _power_perc_imme
-0001f9b0: 6469 6174 6522 2c0a 2020 2020 2020 2020  diate",.        
-0001f9c0: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
-0001f9d0: 745f 6c61 7365 725f 7465 6d70 6572 6174  t_laser_temperat
-0001f9e0: 7572 655f 7365 7470 6f69 6e74 5f72 6177  ure_setpoint_raw
-0001f9f0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001fa00: 2020 2020 2020 2020 2273 6574 5f6c 6173          "set_las
-0001fa10: 6572 5f74 656d 7065 7261 7475 7265 5f73  er_temperature_s
-0001fa20: 6574 706f 696e 745f 7261 7722 2c0a 2020  etpoint_raw",.  
-0001fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa40: 2020 2022 7570 6461 7465 5f6c 6173 6572     "update_laser
-0001fa50: 5f77 6174 6368 646f 6722 2c0a 2020 2020  _watchdog",.    
-0001fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa70: 2022 6765 745f 6c61 7365 725f 696e 7465   "get_laser_inte
-0001fa80: 726c 6f63 6b22 2c0a 2020 2020 2020 2020  rlock",.        
-0001fa90: 2020 2020 2020 2020 2020 2020 2022 6361               "ca
-0001faa0: 6e5f 6c61 7365 725f 6669 7265 222c 0a20  n_laser_fire",. 
-0001fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fac0: 2020 2020 2272 6573 6574 5f66 7067 6122      "reset_fpga"
-0001fad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001fae0: 2020 2020 2020 2022 6765 745f 7472 6967         "get_trig
-0001faf0: 6765 725f 736f 7572 6365 222c 0a20 2020  ger_source",.   
-0001fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb10: 2020 2267 6574 5f72 616d 616e 5f64 656c    "get_raman_del
-0001fb20: 6179 5f6d 7322 2c0a 2020 2020 2020 2020  ay_ms",.        
-0001fb30: 2020 2020 2020 2020 2020 2020 2022 7365               "se
-0001fb40: 745f 7261 6d61 6e5f 6465 6c61 795f 6d73  t_raman_delay_ms
-0001fb50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001fb60: 2020 2020 2020 2020 2267 6574 5f6c 6173          "get_las
-0001fb70: 6572 5f77 6174 6368 646f 675f 7365 6322  er_watchdog_sec"
-0001fb80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001fb90: 2020 2020 2020 2022 7365 745f 6c61 7365         "set_lase
-0001fba0: 725f 7761 7463 6864 6f67 5f73 6563 222c  r_watchdog_sec",
-0001fbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fbc0: 2020 2020 2020 2273 6574 5f76 6572 7469        "set_verti
-0001fbd0: 6361 6c5f 6269 6e6e 696e 6722 2c0a 2020  cal_binning",.  
-0001fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fbf0: 2020 2022 7365 745f 7069 7865 6c5f 6d6f     "set_pixel_mo
-0001fc00: 6465 222c 0a20 2020 2020 2020 2020 2020  de",.           
-0001fc10: 2020 2020 2020 2020 2020 2263 6c65 6172            "clear
-0001fc20: 5f72 6567 696f 6e73 222c 0a20 2020 2020  _regions",.     
-0001fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc40: 2273 6574 5f73 696e 676c 655f 7265 6769  "set_single_regi
-0001fc50: 6f6e 222c 0a20 2020 2020 2020 2020 2020  on",.           
-0001fc60: 2020 2020 2020 2020 2020 2273 6574 5f64            "set_d
-0001fc70: 6574 6563 746f 725f 726f 6922 2c0a 2020  etector_roi",.  
-0001fc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc90: 2020 2022 6765 745f 6670 6761 5f63 6f6e     "get_fpga_con
-0001fca0: 6669 6775 7261 7469 6f6e 5f72 6567 6973  figuration_regis
-0001fcb0: 7465 7222 2c0a 2020 2020 2020 2020 2020  ter",.          
-0001fcc0: 2020 2020 2020 2020 2020 2022 7365 745f             "set_
-0001fcd0: 6163 6365 7373 6f72 795f 656e 6162 6c65  accessory_enable
-0001fce0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001fcf0: 2020 2020 2020 2020 2267 6574 5f64 6973          "get_dis
-0001fd00: 6372 6574 6573 5f65 6e61 626c 6564 222c  cretes_enabled",
-0001fd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fd20: 2020 2020 2020 2273 6574 5f66 616e 5f65        "set_fan_e
-0001fd30: 6e61 626c 6522 2c0a 2020 2020 2020 2020  nable",.        
-0001fd40: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
-0001fd50: 745f 6661 6e5f 656e 6162 6c65 6422 2c0a  t_fan_enabled",.
-0001fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd70: 2020 2020 2022 7365 745f 6c61 6d70 5f65       "set_lamp_e
-0001fd80: 6e61 626c 6522 2c0a 2020 2020 2020 2020  nable",.        
-0001fd90: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
-0001fda0: 745f 6c61 6d70 5f65 6e61 626c 6564 222c  t_lamp_enabled",
-0001fdb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fdc0: 2020 2020 2020 2273 6574 5f73 6875 7474        "set_shutt
-0001fdd0: 6572 5f65 6e61 626c 6522 2c0a 2020 2020  er_enable",.    
-0001fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fdf0: 2022 6765 745f 7368 7574 7465 725f 656e   "get_shutter_en
-0001fe00: 6162 6c65 6422 2c0a 2020 2020 2020 2020  abled",.        
-0001fe10: 2020 2020 2020 2020 2020 2020 2022 7365               "se
-0001fe20: 745f 6d6f 645f 656e 6162 6c65 222c 0a20  t_mod_enable",. 
-0001fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe40: 2020 2020 2267 6574 5f6d 6f64 5f65 6e61      "get_mod_ena
-0001fe50: 626c 6564 222c 0a20 2020 2020 2020 2020  bled",.         
-0001fe60: 2020 2020 2020 2020 2020 2020 2273 6574              "set
-0001fe70: 5f6d 6f64 5f70 6572 696f 645f 7573 222c  _mod_period_us",
-0001fe80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fe90: 2020 2020 2020 2267 6574 5f6d 6f64 5f70        "get_mod_p
-0001fea0: 6572 696f 645f 7573 222c 0a20 2020 2020  eriod_us",.     
-0001feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fec0: 2273 6574 5f6d 6f64 5f77 6964 7468 5f75  "set_mod_width_u
-0001fed0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0001fee0: 2020 2020 2020 2020 2022 6765 745f 6d6f           "get_mo
-0001fef0: 645f 7769 6474 685f 7573 222c 0a20 2020  d_width_us",.   
-0001ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff10: 2020 2273 6574 5f6d 6f64 5f64 656c 6179    "set_mod_delay
-0001ff20: 5f75 7322 2c0a 2020 2020 2020 2020 2020  _us",.          
-0001ff30: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
-0001ff40: 6d6f 645f 6465 6c61 795f 7573 222c 0a20  mod_delay_us",. 
-0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff60: 2020 2020 2267 6574 5f6d 6f64 5f64 7572      "get_mod_dur
-0001ff70: 6174 696f 6e5f 7573 222c 0a20 2020 2020  ation_us",.     
-0001ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff90: 2273 6574 5f73 7472 6f62 655f 656e 6162  "set_strobe_enab
-0001ffa0: 6c65 222c 0a20 2020 2020 2020 2020 2020  le",.           
-0001ffb0: 2020 2020 2020 2020 2020 2267 6574 5f73            "get_s
-0001ffc0: 7472 6f62 655f 656e 6162 6c65 6422 2c0a  trobe_enabled",.
-0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffe0: 2020 2020 2022 6765 745f 616d 6269 656e       "get_ambien
-0001fff0: 745f 7465 6d70 6572 6174 7572 655f 6465  t_temperature_de
-00020000: 6743 222c 0a20 2020 2020 2020 2020 2020  gC",.           
-00020010: 2020 2020 2020 2020 2020 2267 6574 5f74            "get_t
-00020020: 6563 5f65 6e61 626c 6564 222c 0a20 2020  ec_enabled",.   
-00020030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020040: 2020 2267 6574 5f61 6374 7561 6c5f 6672    "get_actual_fr
-00020050: 616d 6573 222c 0a20 2020 2020 2020 2020  ames",.         
-00020060: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-00020070: 5f61 6374 7561 6c5f 696e 7465 6772 6174  _actual_integrat
-00020080: 696f 6e5f 7469 6d65 5f75 7322 2c0a 2020  ion_time_us",.  
-00020090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200a0: 2020 2022 6765 745f 6465 7465 6374 6f72     "get_detector
-000200b0: 5f6f 6666 7365 7422 2c0a 2020 2020 2020  _offset",.      
-000200c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000200d0: 6765 745f 6465 7465 6374 6f72 5f6f 6666  get_detector_off
-000200e0: 7365 745f 6f64 6422 2c0a 2020 2020 2020  set_odd",.      
-000200f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00020100: 6765 745f 6363 645f 7365 6e73 696e 675f  get_ccd_sensing_
-00020110: 7468 7265 7368 6f6c 6422 2c0a 2020 2020  threshold",.    
-00020120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020130: 2022 6765 745f 6363 645f 7468 7265 7368   "get_ccd_thresh
-00020140: 6f6c 645f 7365 6e73 696e 675f 6d6f 6465  old_sensing_mode
-00020150: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00020160: 2020 2020 2020 2020 2267 6574 5f65 7874          "get_ext
-00020170: 6572 6e61 6c5f 7472 6967 6765 725f 6f75  ernal_trigger_ou
-00020180: 7470 7574 222c 0a20 2020 2020 2020 2020  tput",.         
-00020190: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-000201a0: 5f6c 6173 6572 5f69 6e74 6572 6c6f 636b  _laser_interlock
-000201b0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000201c0: 2020 2020 2020 2020 2263 616e 5f6c 6173          "can_las
-000201d0: 6572 5f66 6972 6522 2c0a 2020 2020 2020  er_fire",.      
-000201e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000201f0: 6973 5f6c 6173 6572 5f66 6972 696e 6722  is_laser_firing"
-00020200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020210: 2020 2020 2020 2022 6765 745f 6c61 7365         "get_lase
-00020220: 725f 656e 6162 6c65 6422 2c0a 2020 2020  r_enabled",.    
-00020230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020240: 2022 7365 745f 6d6f 645f 6c69 6e6b 6564   "set_mod_linked
-00020250: 5f74 6f5f 696e 7465 6772 6174 696f 6e22  _to_integration"
-00020260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020270: 2020 2020 2020 2022 6765 745f 7365 6c65         "get_sele
-00020280: 6374 6564 5f61 6463 222c 0a20 2020 2020  cted_adc",.     
-00020290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202a0: 2273 6574 5f74 7269 6767 6572 5f64 656c  "set_trigger_del
-000202b0: 6179 222c 0a20 2020 2020 2020 2020 2020  ay",.           
-000202c0: 2020 2020 2020 2020 2020 2267 6574 5f74            "get_t
-000202d0: 7269 6767 6572 5f64 656c 6179 222c 0a20  rigger_delay",. 
-000202e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000202f0: 2020 2020 2267 6574 5f76 725f 636f 6e74      "get_vr_cont
-00020300: 696e 756f 7573 5f63 6364 222c 0a20 2020  inuous_ccd",.   
-00020310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020320: 2020 2267 6574 5f76 725f 6e75 6d5f 6672    "get_vr_num_fr
-00020330: 616d 6573 222c 0a20 2020 2020 2020 2020  ames",.         
-00020340: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-00020350: 5f6f 7074 5f61 6374 7561 6c5f 696e 7465  _opt_actual_inte
-00020360: 6772 6174 696f 6e5f 7469 6d65 222c 0a20  gration_time",. 
-00020370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020380: 2020 2020 2267 6574 5f6f 7074 5f61 7265      "get_opt_are
-00020390: 615f 7363 616e 222c 0a20 2020 2020 2020  a_scan",.       
-000203a0: 2020 2020 2020 2020 2020 2020 2020 2267                "g
-000203b0: 6574 5f6f 7074 5f63 665f 7365 6c65 6374  et_opt_cf_select
-000203c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000203d0: 2020 2020 2020 2020 2267 6574 5f6f 7074          "get_opt
-000203e0: 5f64 6174 615f 6865 6164 6572 5f74 6162  _data_header_tab
-000203f0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00020400: 2020 2020 2020 2020 2267 6574 5f6f 7074          "get_opt
-00020410: 5f68 6f72 697a 6f6e 7461 6c5f 6269 6e6e  _horizontal_binn
-00020420: 696e 6722 2c0a 2020 2020 2020 2020 2020  ing",.          
-00020430: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
-00020440: 6f70 745f 696e 7465 6772 6174 696f 6e5f  opt_integration_
-00020450: 7469 6d65 5f72 6573 6f6c 7574 696f 6e22  time_resolution"
-00020460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020470: 2020 2020 2020 2022 7365 745f 616e 616c         "set_anal
-00020480: 6f67 5f6f 7574 7075 745f 6d6f 6465 222c  og_output_mode",
-00020490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000204a0: 2020 2020 2020 2273 6574 5f61 6e61 6c6f        "set_analo
-000204b0: 675f 6f75 7470 7574 5f76 616c 7565 222c  g_output_value",
-000204c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000204d0: 2020 2020 2020 2267 6574 5f61 6e61 6c6f        "get_analo
-000204e0: 675f 6f75 7470 7574 5f73 7461 7465 222c  g_output_state",
-000204f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020500: 2020 2020 2020 2267 6574 5f61 6e61 6c6f        "get_analo
-00020510: 675f 696e 7075 745f 7661 6c75 6522 2c0a  g_input_value",.
-00020520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020530: 2020 2020 2022 7570 6461 7465 5f73 6573       "update_ses
-00020540: 7369 6f6e 5f65 6570 726f 6d22 2c0a 2020  sion_eeprom",.  
-00020550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020560: 2020 2022 7265 706c 6163 655f 7365 7373     "replace_sess
-00020570: 696f 6e5f 6565 7072 6f6d 222c 0a20 2020  ion_eeprom",.   
-00020580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020590: 2020 2277 7269 7465 5f65 6570 726f 6d22    "write_eeprom"
-000205a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000205b0: 2020 2020 2020 2022 7365 745f 6c6f 675f         "set_log_
-000205c0: 6c65 7665 6c22 2c0a 2020 2020 2020 2020  level",.        
-000205d0: 2020 2020 2020 2020 2020 2020 2022 7175               "qu
-000205e0: 6575 655f 6d65 7373 6167 6522 205d 3a0a  eue_message" ]:.
-000205f0: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
-00020600: 6573 735f 665b 666f 6f5d 203d 2067 6574  ess_f[foo] = get
-00020610: 6174 7472 2873 656c 662c 2066 6f6f 290a  attr(self, foo).
-00020620: 2020 2020 0a20 2020 2020 2020 2023 2323      .        ###
-00020630: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020660: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00020670: 2020 2020 2020 2020 2320 5768 6174 2066          # What f
-00020680: 6f6c 6c6f 7773 2069 7320 7468 6520 6f6c  ollows is the ol
-00020690: 6420 696e 6974 2d6c 616d 6264 6173 2074  d init-lambdas t
-000206a0: 6861 7420 6172 6520 7371 7561 7368 6564  hat are squashed
-000206b0: 2069 6e74 6f20 7072 6f63 6573 735f 660a   into process_f.
-000206c0: 2020 2020 2020 2020 2320 4c6f 6e67 2074          # Long t
-000206d0: 6572 6d2c 2074 6865 2075 7073 7472 6561  erm, the upstrea
-000206e0: 6d20 7265 7175 6573 7473 2073 686f 756c  m requests shoul
-000206f0: 6420 6265 2063 6861 6e67 6564 2074 6f20  d be changed to 
-00020700: 6d61 7463 6820 7468 6520 6e65 7720 666f  match the new fo
-00020710: 726d 6174 0a20 2020 2020 2020 2023 2054  rmat.        # T
-00020720: 6869 7320 6973 2061 6e20 6561 7379 2066  his is an easy f
-00020730: 6978 2066 6f72 2074 6865 2074 696d 6520  ix for the time 
-00020740: 6265 696e 6720 746f 206d 616b 6520 7468  being to make th
-00020750: 696e 6773 2062 6568 6176 650a 2020 2020  ings behave.    
-00020760: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00020770: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020780: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020790: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000207a0: 2323 2323 2323 0a20 2020 2020 2020 2023  ######.        #
-000207b0: 2073 7065 6374 726f 6d65 7465 7220 636f   spectrometer co
-000207c0: 6e74 726f 6c0a 2020 2020 2020 2020 7072  ntrol.        pr
-000207d0: 6f63 6573 735f 665b 226c 6173 6572 5f65  ocess_f["laser_e
-000207e0: 6e61 626c 6522 5d20 2020 2020 2020 2020  nable"]         
-000207f0: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
-00020800: 6c61 6d62 6461 2078 3a20 7365 6c66 2e73  lambda x: self.s
-00020810: 6574 5f6c 6173 6572 5f65 6e61 626c 6528  et_laser_enable(
-00020820: 626f 6f6c 2878 2929 0a20 2020 2020 2020  bool(x)).       
-00020830: 2070 726f 6365 7373 5f66 5b22 696e 7465   process_f["inte
-00020840: 6772 6174 696f 6e5f 7469 6d65 5f6d 7322  gration_time_ms"
-00020850: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
-00020860: 203d 206c 616d 6264 6120 783a 2073 656c   = lambda x: sel
-00020870: 662e 7365 745f 696e 7465 6772 6174 696f  f.set_integratio
-00020880: 6e5f 7469 6d65 5f6d 7328 7829 0a0a 2020  n_time_ms(x)..  
-00020890: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
-000208a0: 2264 6574 6563 746f 725f 7465 635f 7365  "detector_tec_se
-000208b0: 7470 6f69 6e74 5f64 6567 4322 5d20 2020  tpoint_degC"]   
-000208c0: 2020 2020 2020 3d20 6c61 6d62 6461 2078        = lambda x
-000208d0: 3a20 7365 6c66 2e73 6574 5f64 6574 6563  : self.set_detec
-000208e0: 746f 725f 7465 635f 7365 7470 6f69 6e74  tor_tec_setpoint
-000208f0: 5f64 6567 4328 696e 7428 726f 756e 6428  _degC(int(round(
-00020900: 7829 2929 0a20 2020 2020 2020 2070 726f  x))).        pro
-00020910: 6365 7373 5f66 5b22 6465 7465 6374 6f72  cess_f["detector
-00020920: 5f74 6563 5f65 6e61 626c 6522 5d20 2020  _tec_enable"]   
-00020930: 2020 2020 2020 2020 2020 2020 203d 206c               = l
-00020940: 616d 6264 6120 783a 2073 656c 662e 7365  ambda x: self.se
-00020950: 745f 7465 635f 656e 6162 6c65 2862 6f6f  t_tec_enable(boo
-00020960: 6c28 7829 290a 2020 2020 2020 2020 7072  l(x)).        pr
-00020970: 6f63 6573 735f 665b 2264 6574 6563 746f  ocess_f["detecto
-00020980: 725f 6761 696e 225d 2020 2020 2020 2020  r_gain"]        
-00020990: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
-000209a0: 6c61 6d62 6461 2078 3a20 7365 6c66 2e73  lambda x: self.s
-000209b0: 6574 5f64 6574 6563 746f 725f 6761 696e  et_detector_gain
-000209c0: 2866 6c6f 6174 2878 2929 0a20 2020 2020  (float(x)).     
-000209d0: 2020 2070 726f 6365 7373 5f66 5b22 6465     process_f["de
-000209e0: 7465 6374 6f72 5f6f 6666 7365 7422 5d20  tector_offset"] 
-000209f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a00: 2020 203d 206c 616d 6264 6120 783a 2073     = lambda x: s
-00020a10: 656c 662e 7365 745f 6465 7465 6374 6f72  elf.set_detector
-00020a20: 5f6f 6666 7365 7428 696e 7428 726f 756e  _offset(int(roun
-00020a30: 6428 7829 2929 0a20 2020 2020 2020 2070  d(x))).        p
-00020a40: 726f 6365 7373 5f66 5b22 6465 7465 6374  rocess_f["detect
-00020a50: 6f72 5f67 6169 6e5f 6f64 6422 5d20 2020  or_gain_odd"]   
-00020a60: 2020 2020 2020 2020 2020 2020 2020 203d                 =
-00020a70: 206c 616d 6264 6120 783a 2073 656c 662e   lambda x: self.
-00020a80: 7365 745f 6465 7465 6374 6f72 5f67 6169  set_detector_gai
-00020a90: 6e5f 6f64 6428 666c 6f61 7428 7829 290a  n_odd(float(x)).
-00020aa0: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
-00020ab0: 665b 2264 6574 6563 746f 725f 6f66 6673  f["detector_offs
-00020ac0: 6574 5f6f 6464 225d 2020 2020 2020 2020  et_odd"]        
-00020ad0: 2020 2020 2020 2020 3d20 6c61 6d62 6461          = lambda
-00020ae0: 2078 3a20 7365 6c66 2e73 6574 5f64 6574   x: self.set_det
-00020af0: 6563 746f 725f 6f66 6673 6574 5f6f 6464  ector_offset_odd
-00020b00: 2869 6e74 2872 6f75 6e64 2878 2929 290a  (int(round(x))).
-00020b10: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
-00020b20: 665b 2264 6567 435f 746f 5f64 6163 5f63  f["degC_to_dac_c
-00020b30: 6f65 6666 7322 5d20 2020 2020 2020 2020  oeffs"]         
-00020b40: 2020 2020 2020 2020 3d20 6c61 6d62 6461          = lambda
-00020b50: 2078 3a20 7365 6c66 2e73 6574 7469 6e67   x: self.setting
-00020b60: 732e 6565 7072 6f6d 2e73 6574 2822 6465  s.eeprom.set("de
-00020b70: 6743 5f74 6f5f 6461 635f 636f 6566 6673  gC_to_dac_coeffs
-00020b80: 222c 2078 290a 0a20 2020 2020 2020 2070  ", x)..        p
-00020b90: 726f 6365 7373 5f66 5b22 6c61 7365 725f  rocess_f["laser_
-00020ba0: 706f 7765 725f 7065 7263 225d 2020 2020  power_perc"]    
-00020bb0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
-00020bc0: 206c 616d 6264 6120 783a 2073 656c 662e   lambda x: self.
-00020bd0: 7365 745f 6c61 7365 725f 706f 7765 725f  set_laser_power_
-00020be0: 7065 7263 2878 290a 2020 2020 2020 2020  perc(x).        
-00020bf0: 7072 6f63 6573 735f 665b 226c 6173 6572  process_f["laser
-00020c00: 5f70 6f77 6572 5f6d 5722 5d20 2020 2020  _power_mW"]     
+0001bd60: 6174 652e 6d6f 645f 7065 7269 6f64 5f75  ate.mod_period_u
+0001bd70: 7320 3d20 7265 7375 6c74 0d0a 2020 2020  s = result..    
+0001bd80: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001bd90: 740d 0a0d 0a20 2020 2064 6566 2073 6574  t....    def set
+0001bda0: 5f6d 6f64 5f77 6964 7468 5f75 7328 7365  _mod_width_us(se
+0001bdb0: 6c66 2c20 7573 3a20 666c 6f61 7429 3a20  lf, us: float): 
+0001bdc0: 2320 2d3e 2053 7065 6374 726f 6d65 7465  # -> Spectromete
+0001bdd0: 7252 6573 706f 6e73 6520 0d0a 2020 2020  rResponse ..    
+0001bde0: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
+0001bdf0: 732e 7374 6174 652e 6d6f 645f 7769 6474  s.state.mod_widt
+0001be00: 685f 7573 203d 2075 730d 0a20 2020 2020  h_us = us..     
+0001be10: 2020 2028 6c73 772c 206d 7377 2c20 6275     (lsw, msw, bu
+0001be20: 6629 203d 2073 656c 662e 5f74 6f34 3062  f) = self._to40b
+0001be30: 6974 2875 7329 0d0a 2020 2020 2020 2020  it(us)..        
+0001be40: 7265 7475 726e 2073 656c 662e 5f73 656e  return self._sen
+0001be50: 645f 636f 6465 2830 7864 622c 206c 7377  d_code(0xdb, lsw
+0001be60: 2c20 6d73 772c 2062 7566 2c20 6c61 6265  , msw, buf, labe
+0001be70: 6c3d 2253 4554 5f4d 4f44 5f57 4944 5448  l="SET_MOD_WIDTH
+0001be80: 2229 0d0a 0d0a 2020 2020 6465 6620 6765  ")....    def ge
+0001be90: 745f 6d6f 645f 7769 6474 685f 7573 2873  t_mod_width_us(s
+0001bea0: 656c 6629 3a20 2320 2d3e 2053 7065 6374  elf): # -> Spect
+0001beb0: 726f 6d65 7465 7252 6573 706f 6e73 6520  rometerResponse 
+0001bec0: 0d0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+0001bed0: 203d 2073 656c 662e 5f67 6574 5f63 6f64   = self._get_cod
+0001bee0: 6528 3078 6463 2c20 6c61 6265 6c3d 2247  e(0xdc, label="G
+0001bef0: 4554 5f4d 4f44 5f57 4944 5448 222c 206c  ET_MOD_WIDTH", l
+0001bf00: 7362 5f6c 656e 3d35 290d 0a20 2020 2020  sb_len=5)..     
+0001bf10: 2020 2073 656c 662e 7365 7474 696e 6773     self.settings
+0001bf20: 2e73 7461 7465 2e6d 6f64 5f77 6964 7468  .state.mod_width
+0001bf30: 5f75 7320 3d20 7265 7375 6c74 2e64 6174  _us = result.dat
+0001bf40: 610d 0a20 2020 2020 2020 2072 6574 7572  a..        retur
+0001bf50: 6e20 7265 7375 6c74 0d0a 0d0a 2020 2020  n result....    
+0001bf60: 6465 6620 7365 745f 6d6f 645f 6465 6c61  def set_mod_dela
+0001bf70: 795f 7573 2873 656c 662c 2075 733a 2066  y_us(self, us: f
+0001bf80: 6c6f 6174 293a 2023 202d 3e20 5370 6563  loat): # -> Spec
+0001bf90: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+0001bfa0: 200d 0a20 2020 2020 2020 2073 656c 662e   ..        self.
+0001bfb0: 7365 7474 696e 6773 2e73 7461 7465 2e6d  settings.state.m
+0001bfc0: 6f64 5f64 656c 6179 5f75 7320 3d20 7573  od_delay_us = us
+0001bfd0: 0d0a 2020 2020 2020 2020 286c 7377 2c20  ..        (lsw, 
+0001bfe0: 6d73 772c 2062 7566 2920 3d20 7365 6c66  msw, buf) = self
+0001bff0: 2e5f 746f 3430 6269 7428 7573 290d 0a20  ._to40bit(us).. 
+0001c000: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0001c010: 6c66 2e5f 7365 6e64 5f63 6f64 6528 3078  lf._send_code(0x
+0001c020: 6336 2c20 6c73 772c 206d 7377 2c20 6275  c6, lsw, msw, bu
+0001c030: 662c 206c 6162 656c 3d22 5345 545f 4d4f  f, label="SET_MO
+0001c040: 445f 4445 4c41 5922 290d 0a0d 0a20 2020  D_DELAY")....   
+0001c050: 2064 6566 2067 6574 5f6d 6f64 5f64 656c   def get_mod_del
+0001c060: 6179 5f75 7328 7365 6c66 293a 2023 202d  ay_us(self): # -
+0001c070: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+0001c080: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+0001c090: 2072 6573 756c 7420 3d20 7365 6c66 2e5f   result = self._
+0001c0a0: 6765 745f 636f 6465 2830 7863 612c 206c  get_code(0xca, l
+0001c0b0: 6162 656c 3d22 4745 545f 4d4f 445f 4445  abel="GET_MOD_DE
+0001c0c0: 4c41 5922 2c20 6c73 625f 6c65 6e3d 3529  LAY", lsb_len=5)
+0001c0d0: 0d0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+0001c0e0: 6574 7469 6e67 732e 7374 6174 652e 6d6f  ettings.state.mo
+0001c0f0: 645f 6465 6c61 795f 7573 203d 2072 6573  d_delay_us = res
+0001c100: 756c 742e 6461 7461 0d0a 2020 2020 2020  ult.data..      
+0001c110: 2020 7265 7475 726e 2072 6573 756c 740d    return result.
+0001c120: 0a0d 0a20 2020 2064 6566 2073 6574 5f6d  ...    def set_m
+0001c130: 6f64 5f64 7572 6174 696f 6e5f 7573 5f4e  od_duration_us_N
+0001c140: 4f54 5f55 5345 4428 7365 6c66 2c20 7573  OT_USED(self, us
+0001c150: 3a20 666c 6f61 7429 3a20 2320 2d3e 2053  : float): # -> S
+0001c160: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0001c170: 6e73 6520 0d0a 2020 2020 2020 2020 7365  nse ..        se
+0001c180: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
+0001c190: 652e 6d6f 645f 6475 7261 7469 6f6e 5f75  e.mod_duration_u
+0001c1a0: 7320 3d20 7573 0d0a 2020 2020 2020 2020  s = us..        
+0001c1b0: 286c 7377 2c20 6d73 772c 2062 7566 2920  (lsw, msw, buf) 
+0001c1c0: 3d20 7365 6c66 2e5f 746f 3430 6269 7428  = self._to40bit(
+0001c1d0: 7573 290d 0a20 2020 2020 2020 2072 6574  us)..        ret
+0001c1e0: 7572 6e20 7365 6c66 2e5f 7365 6e64 5f63  urn self._send_c
+0001c1f0: 6f64 6528 3078 6239 2c20 6c73 772c 206d  ode(0xb9, lsw, m
+0001c200: 7377 2c20 6275 662c 206c 6162 656c 3d22  sw, buf, label="
+0001c210: 5345 545f 4d4f 445f 4455 5241 5449 4f4e  SET_MOD_DURATION
+0001c220: 2229 0d0a 0d0a 2020 2020 6465 6620 6765  ")....    def ge
+0001c230: 745f 6d6f 645f 6475 7261 7469 6f6e 5f75  t_mod_duration_u
+0001c240: 7328 7365 6c66 293a 2023 202d 3e20 5370  s(self): # -> Sp
+0001c250: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+0001c260: 7365 200d 0a20 2020 2020 2020 2072 6573  se ..        res
+0001c270: 756c 7420 3d20 7365 6c66 2e5f 6765 745f  ult = self._get_
+0001c280: 636f 6465 2830 7863 332c 206c 6162 656c  code(0xc3, label
+0001c290: 3d22 4745 545f 4d4f 445f 4455 5241 5449  ="GET_MOD_DURATI
+0001c2a0: 4f4e 222c 206c 7362 5f6c 656e 3d35 290d  ON", lsb_len=5).
+0001c2b0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0001c2c0: 7474 696e 6773 2e73 7461 7465 2e6d 6f64  ttings.state.mod
+0001c2d0: 5f64 7572 6174 696f 6e5f 7573 203d 2072  _duration_us = r
+0001c2e0: 6573 756c 742e 6461 7461 0d0a 2020 2020  esult.data..    
+0001c2f0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0001c300: 740d 0a0d 0a20 2020 2023 2320 7468 6973  t....    ## this
+0001c310: 2069 7320 6120 7379 6e6f 6e79 6d20 666f   is a synonym fo
+0001c320: 7220 5f73 6574 5f6c 6173 6572 5f65 6e61  r _set_laser_ena
+0001c330: 626c 655f 696d 6d65 6469 6174 6528 292c  ble_immediate(),
+0001c340: 2062 7574 2077 6974 686f 7574 2073 6964   but without sid
+0001c350: 652d 6566 6665 6374 730d 0a20 2020 2064  e-effects..    d
+0001c360: 6566 2073 6574 5f73 7472 6f62 655f 656e  ef set_strobe_en
+0001c370: 6162 6c65 2873 656c 662c 2066 6c61 673a  able(self, flag:
+0001c380: 2062 6f6f 6c29 3a20 2320 2d3e 2053 7065   bool): # -> Spe
+0001c390: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+0001c3a0: 6520 0d0a 2020 2020 2020 2020 7661 6c75  e ..        valu
+0001c3b0: 6520 3d20 3120 6966 2066 6c61 6720 656c  e = 1 if flag el
+0001c3c0: 7365 2030 0d0a 2020 2020 2020 2020 7265  se 0..        re
+0001c3d0: 7475 726e 2073 656c 662e 5f73 656e 645f  turn self._send_
+0001c3e0: 636f 6465 2830 7862 652c 2076 616c 7565  code(0xbe, value
+0001c3f0: 2c20 6c61 6265 6c3d 2253 4554 5f53 5452  , label="SET_STR
+0001c400: 4f42 455f 454e 4142 4c45 2229 0d0a 0d0a  OBE_ENABLE")....
+0001c410: 2020 2020 2323 2061 206c 6974 6572 616c      ## a literal
+0001c420: 2070 6173 732d 7468 726f 7567 6820 746f   pass-through to
+0001c430: 2067 6574 5f6c 6173 6572 5f65 6e61 626c   get_laser_enabl
+0001c440: 6564 2829 0d0a 2020 2020 6465 6620 6765  ed()..    def ge
+0001c450: 745f 7374 726f 6265 5f65 6e61 626c 6564  t_strobe_enabled
+0001c460: 2873 656c 6629 3a20 2320 2d3e 2053 7065  (self): # -> Spe
+0001c470: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+0001c480: 6520 0d0a 2020 2020 2020 2020 7265 7475  e ..        retu
+0001c490: 726e 2073 656c 662e 6765 745f 6c61 7365  rn self.get_lase
+0001c4a0: 725f 656e 6162 6c65 6428 290d 0a0d 0a20  r_enabled().... 
+0001c4b0: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
+0001c4c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c4d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c4e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c4f0: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+0001c500: 0a20 2020 2023 2041 6d62 6965 6e74 2054  .    # Ambient T
+0001c510: 656d 7065 7261 7475 7265 0d0a 2020 2020  emperature..    
+0001c520: 2320 2323 2323 2323 2323 2323 2323 2323  # ##############
+0001c530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c560: 2323 2323 2323 2323 2323 2323 0d0a 0d0a  ############....
+0001c570: 2020 2020 2323 2040 7365 6520 6874 7470      ## @see http
+0001c580: 733a 2f2f 7777 772e 6e78 702e 636f 6d2f  s://www.nxp.com/
+0001c590: 646f 6373 2f65 6e2f 6461 7461 2d73 6865  docs/en/data-she
+0001c5a0: 6574 2f4c 4d37 3542 2e70 6466 0d0a 2020  et/LM75B.pdf..  
+0001c5b0: 2020 6465 6620 6765 745f 616d 6269 656e    def get_ambien
+0001c5c0: 745f 7465 6d70 6572 6174 7572 655f 6465  t_temperature_de
+0001c5d0: 6743 2873 656c 6629 3a20 2320 2d3e 2053  gC(self): # -> S
+0001c5e0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0001c5f0: 6e73 6520 0d0a 2020 2020 2020 2020 6966  nse ..        if
+0001c600: 206e 6f74 2073 656c 662e 7365 7474 696e   not self.settin
+0001c610: 6773 2e69 735f 6765 6e31 3528 293a 0d0a  gs.is_gen15():..
+0001c620: 2020 2020 2020 2020 2020 2020 6c6f 672e              log.
+0001c630: 6572 726f 7228 2261 6d62 6965 6e74 2074  error("ambient t
+0001c640: 656d 7065 7261 7475 7265 2072 6571 7569  emperature requi
+0001c650: 7265 7320 4765 6e20 312e 3522 290d 0a20  res Gen 1.5").. 
+0001c660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001c670: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
+0001c680: 7370 6f6e 7365 2864 6174 613d 4661 6c73  sponse(data=Fals
+0001c690: 652c 6572 726f 725f 6d73 673d 2261 6d62  e,error_msg="amb
+0001c6a0: 6965 6e74 2074 656d 7020 7265 7175 6972  ient temp requir
+0001c6b0: 6573 2067 656e 312e 3522 290d 0a0d 0a20  es gen1.5").... 
+0001c6c0: 2020 2020 2020 206c 6f67 2e64 6562 7567         log.debug
+0001c6d0: 2822 6174 7465 6d70 7469 6e67 2074 6f20  ("attempting to 
+0001c6e0: 7265 6164 2061 6d62 6965 6e74 2074 656d  read ambient tem
+0001c6f0: 7065 7261 7475 7265 2229 0d0a 2020 2020  perature")..    
+0001c700: 2020 2020 7265 7375 6c74 203d 2073 656c      result = sel
+0001c710: 662e 5f67 6574 5f63 6f64 6528 3078 3334  f._get_code(0x34
+0001c720: 2c20 6c61 6265 6c3d 2247 4554 5f41 4d42  , label="GET_AMB
+0001c730: 4945 4e54 5f54 454d 5045 5241 5455 5245  IENT_TEMPERATURE
+0001c740: 222c 206d 7362 5f6c 656e 3d32 290d 0a20  ", msb_len=2).. 
+0001c750: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
+0001c760: 2069 7320 4e6f 6e65 206f 7220 6c65 6e28   is None or len(
+0001c770: 7265 7375 6c74 2920 213d 2032 3a0d 0a20  result) != 2:.. 
+0001c780: 2020 2020 2020 2020 2020 206c 6f67 2e65             log.e
+0001c790: 7272 6f72 2822 6661 696c 6564 2074 6f20  rror("failed to 
+0001c7a0: 7265 6164 2061 6d62 6965 6e74 2074 656d  read ambient tem
+0001c7b0: 7065 7261 7475 7265 2229 0d0a 2020 2020  perature")..    
+0001c7c0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+0001c7d0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0001c7e0: 6e73 6528 6461 7461 3d46 616c 7365 2c65  nse(data=False,e
+0001c7f0: 7272 6f72 5f6d 7367 3d22 616d 6269 656e  rror_msg="ambien
+0001c800: 7420 7465 6d70 2072 6561 6420 6661 696c  t temp read fail
+0001c810: 6564 2229 0d0a 2020 2020 2020 2020 6c6f  ed")..        lo
+0001c820: 672e 6465 6275 6728 2261 6d62 6965 6e74  g.debug("ambient
+0001c830: 2074 656d 7065 7261 7475 7265 2072 6177   temperature raw
+0001c840: 3a20 2573 222c 2072 6573 756c 7429 0d0a  : %s", result)..
+0001c850: 0d0a 2020 2020 2020 2020 7261 7720 3d20  ..        raw = 
+0001c860: 7265 7375 6c74 2e64 6174 610d 0a20 2020  result.data..   
+0001c870: 2020 2020 2072 6177 203d 2072 6177 203e       raw = raw >
+0001c880: 3e20 350d 0a20 2020 2020 2020 2064 6567  > 5..        deg
+0001c890: 4320 3d20 302e 3132 3520 2a20 7574 696c  C = 0.125 * util
+0001c8a0: 732e 7477 6f73 5f63 6f6d 7028 7261 772c  s.twos_comp(raw,
+0001c8b0: 2031 3129 0d0a 0d0a 2020 2020 2020 2020   11)....        
+0001c8c0: 6c6f 672e 6465 6275 6728 2270 6172 7365  log.debug("parse
+0001c8d0: 6420 616d 6269 656e 7420 7465 6d70 6572  d ambient temper
+0001c8e0: 6174 7572 6520 6672 6f6d 2072 6177 2025  ature from raw %
+0001c8f0: 7320 746f 2025 2e33 6620 6465 6743 222c  s to %.3f degC",
+0001c900: 2072 6573 756c 742c 2064 6567 4329 0d0a   result, degC)..
+0001c910: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+0001c920: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0001c930: 6e73 6528 6461 7461 3d64 6567 4329 0d0a  nse(data=degC)..
+0001c940: 0d0a 2020 2020 2320 2323 2323 2323 2323  ..    # ########
+0001c950: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c960: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c970: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c980: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c990: 2323 0d0a 2020 2020 2320 6164 6465 6420  ##..    # added 
+0001c9a0: 666f 7220 7761 7361 7463 682d 7368 656c  for wasatch-shel
+0001c9b0: 6c0d 0a20 2020 2023 2023 2323 2323 2323  l..    # #######
+0001c9c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c9d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c9e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001c9f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ca00: 2323 230d 0a0d 0a20 2020 2064 6566 2067  ###....    def g
+0001ca10: 6574 5f74 6563 5f65 6e61 626c 6564 2873  et_tec_enabled(s
+0001ca20: 656c 6629 3a20 2320 2d3e 2053 7065 6374  elf): # -> Spect
+0001ca30: 726f 6d65 7465 7252 6573 706f 6e73 6520  rometerResponse 
+0001ca40: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0001ca50: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
+0001ca60: 6570 726f 6d2e 6861 735f 636f 6f6c 696e  eprom.has_coolin
+0001ca70: 673a 0d0a 2020 2020 2020 2020 2020 2020  g:..            
+0001ca80: 6c6f 672e 6572 726f 7228 2275 6e61 626c  log.error("unabl
+0001ca90: 6520 746f 2063 6f6e 7472 6f6c 2054 4543  e to control TEC
+0001caa0: 3a20 4545 5052 4f4d 2072 6570 6f72 7473  : EEPROM reports
+0001cab0: 206e 6f20 636f 6f6c 696e 6722 290d 0a20   no cooling").. 
+0001cac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001cad0: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
+0001cae0: 7370 6f6e 7365 2864 6174 613d 4661 6c73  sponse(data=Fals
+0001caf0: 652c 6572 726f 725f 6d73 673d 226e 6f20  e,error_msg="no 
+0001cb00: 636f 6f6c 696e 6720 7265 706f 7274 6564  cooling reported
+0001cb10: 2229 0d0a 2020 2020 2020 2020 7265 7320  ")..        res 
+0001cb20: 3d20 7365 6c66 2e5f 6765 745f 636f 6465  = self._get_code
+0001cb30: 2830 7864 612c 206c 6162 656c 3d22 4745  (0xda, label="GE
+0001cb40: 545f 4343 445f 5445 435f 454e 4142 4c45  T_CCD_TEC_ENABLE
+0001cb50: 4422 2c20 6d73 625f 6c65 6e3d 3129 0d0a  D", msb_len=1)..
+0001cb60: 2020 2020 2020 2020 7265 732e 6461 7461          res.data
+0001cb70: 203d 2030 2021 3d20 7265 732e 6461 7461   = 0 != res.data
+0001cb80: 0d0a 2020 2020 2020 2020 6966 2072 6573  ..        if res
+0001cb90: 2e65 7272 6f72 5f6d 7367 2021 3d20 2727  .error_msg != ''
+0001cba0: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+0001cbb0: 6574 7572 6e20 7265 730d 0a20 2020 2020  eturn res..     
+0001cbc0: 2020 2072 6574 7572 6e20 7265 730d 0a0d     return res...
+0001cbd0: 0a20 2020 2064 6566 2067 6574 5f61 6374  .    def get_act
+0001cbe0: 7561 6c5f 6672 616d 6573 2873 656c 6629  ual_frames(self)
+0001cbf0: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+0001cc00: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+0001cc10: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001cc20: 662e 5f67 6574 5f63 6f64 6528 3078 6534  f._get_code(0xe4
+0001cc30: 2c20 6c61 6265 6c3d 2247 4554 5f41 4354  , label="GET_ACT
+0001cc40: 5541 4c5f 4652 414d 4553 222c 206c 7362  UAL_FRAMES", lsb
+0001cc50: 5f6c 656e 3d32 290d 0a0d 0a20 2020 2064  _len=2)....    d
+0001cc60: 6566 2067 6574 5f61 6374 7561 6c5f 696e  ef get_actual_in
+0001cc70: 7465 6772 6174 696f 6e5f 7469 6d65 5f75  tegration_time_u
+0001cc80: 7328 7365 6c66 293a 2023 202d 3e20 5370  s(self): # -> Sp
+0001cc90: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+0001cca0: 7365 200d 0a20 2020 2020 2020 2072 6574  se ..        ret
+0001ccb0: 7572 6e20 7365 6c66 2e5f 6765 745f 636f  urn self._get_co
+0001ccc0: 6465 2830 7864 662c 206c 6162 656c 3d22  de(0xdf, label="
+0001ccd0: 4745 545f 4143 5455 414c 5f49 4e54 4547  GET_ACTUAL_INTEG
+0001cce0: 5241 5449 4f4e 5f54 494d 455f 5553 222c  RATION_TIME_US",
+0001ccf0: 206c 7362 5f6c 656e 3d33 290d 0a0d 0a20   lsb_len=3).... 
+0001cd00: 2020 2064 6566 2067 6574 5f64 6574 6563     def get_detec
+0001cd10: 746f 725f 6f66 6673 6574 2873 656c 6629  tor_offset(self)
+0001cd20: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+0001cd30: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+0001cd40: 2020 2020 2020 7661 6c75 6520 3d20 7365        value = se
+0001cd50: 6c66 2e5f 6765 745f 636f 6465 2830 7863  lf._get_code(0xc
+0001cd60: 342c 206c 6162 656c 3d22 4745 545f 4445  4, label="GET_DE
+0001cd70: 5445 4354 4f52 5f4f 4646 5345 5422 2c20  TECTOR_OFFSET", 
+0001cd80: 6c73 625f 6c65 6e3d 3229 0d0a 2020 2020  lsb_len=2)..    
+0001cd90: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
+0001cda0: 732e 6565 7072 6f6d 2e64 6574 6563 746f  s.eeprom.detecto
+0001cdb0: 725f 6f66 6673 6574 203d 2076 616c 7565  r_offset = value
+0001cdc0: 2e64 6174 610d 0a20 2020 2020 2020 2072  .data..        r
+0001cdd0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+0001cde0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+0001cdf0: 7661 6c75 6529 0d0a 0d0a 2020 2020 6465  value)....    de
+0001ce00: 6620 6765 745f 6465 7465 6374 6f72 5f6f  f get_detector_o
+0001ce10: 6666 7365 745f 6f64 6428 7365 6c66 293a  ffset_odd(self):
+0001ce20: 2023 202d 3e20 5370 6563 7472 6f6d 6574   # -> Spectromet
+0001ce30: 6572 5265 7370 6f6e 7365 200d 0a20 2020  erResponse ..   
+0001ce40: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0001ce50: 2e73 6574 7469 6e67 732e 6973 5f69 6e67  .settings.is_ing
+0001ce60: 6161 7328 293a 0d0a 2020 2020 2020 2020  aas():..        
+0001ce70: 2020 2020 6c6f 672e 6465 6275 6728 2247      log.debug("G
+0001ce80: 4554 5f44 4554 4543 544f 525f 4f46 4653  ET_DETECTOR_OFFS
+0001ce90: 4554 5f4f 4444 206f 6e6c 7920 7375 7070  ET_ODD only supp
+0001cea0: 6f72 7465 6420 6f6e 2049 6e47 6141 7322  orted on InGaAs"
+0001ceb0: 290d 0a20 2020 2020 2020 2020 2020 2072  )..            r
+0001cec0: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+0001ced0: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+0001cee0: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+0001cef0: 7072 6f6d 2e64 6574 6563 746f 725f 6f66  prom.detector_of
+0001cf00: 6673 6574 5f6f 6464 290d 0a0d 0a20 2020  fset_odd)....   
+0001cf10: 2020 2020 2076 616c 7565 203d 2073 656c       value = sel
+0001cf20: 662e 5f67 6574 5f63 6f64 6528 3078 3965  f._get_code(0x9e
+0001cf30: 2c20 6c61 6265 6c3d 2247 4554 5f44 4554  , label="GET_DET
+0001cf40: 4543 544f 525f 4f46 4653 4554 5f4f 4444  ECTOR_OFFSET_ODD
+0001cf50: 222c 206c 7362 5f6c 656e 3d32 290d 0a20  ", lsb_len=2).. 
+0001cf60: 2020 2020 2020 2069 6620 7661 6c75 652e         if value.
+0001cf70: 6572 726f 725f 6d73 6720 213d 2027 273a  error_msg != '':
+0001cf80: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0001cf90: 7475 726e 2076 616c 7565 0d0a 2020 2020  turn value..    
+0001cfa0: 2020 2020 7365 6c66 2e73 6574 7469 6e67      self.setting
+0001cfb0: 732e 6565 7072 6f6d 2e64 6574 6563 746f  s.eeprom.detecto
+0001cfc0: 725f 6f66 6673 6574 5f6f 6464 203d 2076  r_offset_odd = v
+0001cfd0: 616c 7565 2e64 6174 610d 0a20 2020 2020  alue.data..     
+0001cfe0: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+0001cff0: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+0001d000: 6174 613d 7661 6c75 6529 0d0a 0d0a 2020  ata=value)....  
+0001d010: 2020 6465 6620 6765 745f 6363 645f 7365    def get_ccd_se
+0001d020: 6e73 696e 675f 7468 7265 7368 6f6c 6428  nsing_threshold(
+0001d030: 7365 6c66 293a 2023 202d 3e20 5370 6563  self): # -> Spec
+0001d040: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+0001d050: 200d 0a20 2020 2020 2020 2072 6574 7572   ..        retur
+0001d060: 6e20 7365 6c66 2e5f 6765 745f 636f 6465  n self._get_code
+0001d070: 2830 7864 312c 206c 6162 656c 3d22 4745  (0xd1, label="GE
+0001d080: 545f 4343 445f 5345 4e53 494e 475f 5448  T_CCD_SENSING_TH
+0001d090: 5245 5348 4f4c 4422 2c20 6c73 625f 6c65  RESHOLD", lsb_le
+0001d0a0: 6e3d 3229 0d0a 0d0a 2020 2020 6465 6620  n=2)....    def 
+0001d0b0: 6765 745f 6363 645f 7468 7265 7368 6f6c  get_ccd_threshol
+0001d0c0: 645f 7365 6e73 696e 675f 6d6f 6465 2873  d_sensing_mode(s
+0001d0d0: 656c 6629 3a20 2320 2d3e 2053 7065 6374  elf): # -> Spect
+0001d0e0: 726f 6d65 7465 7252 6573 706f 6e73 6520  rometerResponse 
+0001d0f0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001d100: 2073 656c 662e 5f67 6574 5f63 6f64 6528   self._get_code(
+0001d110: 3078 6366 2c20 6c61 6265 6c3d 2247 4554  0xcf, label="GET
+0001d120: 5f43 4344 5f54 4852 4553 484f 4c44 5f53  _CCD_THRESHOLD_S
+0001d130: 454e 5349 4e47 5f4d 4f44 4522 2c20 6d73  ENSING_MODE", ms
+0001d140: 625f 6c65 6e3d 3129 0d0a 0d0a 2020 2020  b_len=1)....    
+0001d150: 6465 6620 6765 745f 6578 7465 726e 616c  def get_external
+0001d160: 5f74 7269 6767 6572 5f6f 7574 7075 7428  _trigger_output(
+0001d170: 7365 6c66 293a 2023 202d 3e20 5370 6563  self): # -> Spec
+0001d180: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+0001d190: 200d 0a20 2020 2020 2020 2072 6574 7572   ..        retur
+0001d1a0: 6e20 7365 6c66 2e5f 6765 745f 636f 6465  n self._get_code
+0001d1b0: 2830 7865 312c 206c 6162 656c 3d22 4745  (0xe1, label="GE
+0001d1c0: 545f 4558 5445 524e 414c 5f54 5249 4747  T_EXTERNAL_TRIGG
+0001d1d0: 4552 5f4f 5554 5055 5422 2c20 6d73 625f  ER_OUTPUT", msb_
+0001d1e0: 6c65 6e3d 3129 0d0a 0d0a 2020 2020 6465  len=1)....    de
+0001d1f0: 6620 6765 745f 6c61 7365 725f 696e 7465  f get_laser_inte
+0001d200: 726c 6f63 6b28 7365 6c66 293a 2023 202d  rlock(self): # -
+0001d210: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+0001d220: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+0001d230: 2069 6620 7365 6c66 2e73 6574 7469 6e67   if self.setting
+0001d240: 732e 6973 5f61 726d 2829 3a0d 0a20 2020  s.is_arm():..   
+0001d250: 2020 2020 2020 2020 206c 6f67 2e65 7272           log.err
+0001d260: 6f72 2822 4745 545f 4c41 5345 525f 494e  or("GET_LASER_IN
+0001d270: 5445 524c 4f43 4b20 6e6f 7420 7375 7070  TERLOCK not supp
+0001d280: 6f72 7465 6420 6f6e 2041 524d 2229 0d0a  orted on ARM")..
+0001d290: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001d2a0: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+0001d2b0: 6573 706f 6e73 6528 6461 7461 3d46 616c  esponse(data=Fal
+0001d2c0: 7365 2c65 7272 6f72 5f6d 7367 3d22 6c61  se,error_msg="la
+0001d2d0: 7365 7220 696e 7465 726c 6f63 6b20 6e6f  ser interlock no
+0001d2e0: 7420 7375 7070 6f72 7465 6422 290d 0a20  t supported").. 
+0001d2f0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0001d300: 6c66 2e5f 6765 745f 636f 6465 2830 7865  lf._get_code(0xe
+0001d310: 662c 206c 6162 656c 3d22 4745 545f 4c41  f, label="GET_LA
+0001d320: 5345 525f 494e 5445 524c 4f43 4b22 2c20  SER_INTERLOCK", 
+0001d330: 6d73 625f 6c65 6e3d 3129 0d0a 0d0a 2020  msb_len=1)....  
+0001d340: 2020 6465 6620 6765 745f 6c61 7365 725f    def get_laser_
+0001d350: 656e 6162 6c65 6428 7365 6c66 293a 2023  enabled(self): #
+0001d360: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
+0001d370: 5265 7370 6f6e 7365 200d 0a20 2020 2020  Response ..     
+0001d380: 2020 2072 6573 203d 2073 656c 662e 5f67     res = self._g
+0001d390: 6574 5f63 6f64 6528 3078 6532 2c20 6c61  et_code(0xe2, la
+0001d3a0: 6265 6c3d 2247 4554 5f4c 4153 4552 5f45  bel="GET_LASER_E
+0001d3b0: 4e41 424c 4544 222c 206d 7362 5f6c 656e  NABLED", msb_len
+0001d3c0: 3d31 290d 0a20 2020 2020 2020 2066 6c61  =1)..        fla
+0001d3d0: 6720 3d20 3020 213d 2072 6573 2e64 6174  g = 0 != res.dat
+0001d3e0: 610d 0a20 2020 2020 2020 206c 6f67 2e64  a..        log.d
+0001d3f0: 6562 7567 2822 6765 745f 6c61 7365 725f  ebug("get_laser_
+0001d400: 656e 6162 6c65 643a 2025 7322 2c20 666c  enabled: %s", fl
+0001d410: 6167 290d 0a20 2020 2020 2020 2073 656c  ag)..        sel
+0001d420: 662e 7365 7474 696e 6773 2e73 7461 7465  f.settings.state
+0001d430: 2e6c 6173 6572 5f65 6e61 626c 6564 203d  .laser_enabled =
+0001d440: 2066 6c61 670d 0a20 2020 2020 2020 2072   flag..        r
+0001d450: 6574 7572 6e20 5370 6563 7472 6f6d 6574  eturn Spectromet
+0001d460: 6572 5265 7370 6f6e 7365 2864 6174 613d  erResponse(data=
+0001d470: 666c 6167 290d 0a0d 0a20 2020 2064 6566  flag)....    def
+0001d480: 2073 6574 5f6d 6f64 5f6c 696e 6b65 645f   set_mod_linked_
+0001d490: 746f 5f69 6e74 6567 7261 7469 6f6e 2873  to_integration(s
+0001d4a0: 656c 662c 2066 6c61 673a 2062 6f6f 6c29  elf, flag: bool)
+0001d4b0: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+0001d4c0: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+0001d4d0: 2020 2020 2020 7661 6c75 6520 3d20 3120        value = 1 
+0001d4e0: 6966 2066 6c61 6720 656c 7365 2030 0d0a  if flag else 0..
+0001d4f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001d500: 656c 662e 5f73 656e 645f 636f 6465 2830  elf._send_code(0
+0001d510: 7864 642c 2076 616c 7565 2c20 6c61 6265  xdd, value, labe
+0001d520: 6c3d 2253 4554 5f4d 4f44 5f4c 494e 4b45  l="SET_MOD_LINKE
+0001d530: 445f 544f 5f49 4e54 4547 5241 5449 4f4e  D_TO_INTEGRATION
+0001d540: 2229 0d0a 0d0a 2020 2020 6465 6620 6765  ")....    def ge
+0001d550: 745f 6d6f 645f 6c69 6e6b 6564 5f74 6f5f  t_mod_linked_to_
+0001d560: 696e 7465 6772 6174 696f 6e28 7365 6c66  integration(self
+0001d570: 293a 2023 202d 3e20 5370 6563 7472 6f6d  ): # -> Spectrom
+0001d580: 6574 6572 5265 7370 6f6e 7365 200d 0a20  eterResponse .. 
+0001d590: 2020 2020 2020 2072 6573 203d 2073 656c         res = sel
+0001d5a0: 662e 5f67 6574 5f63 6f64 6528 3078 6465  f._get_code(0xde
+0001d5b0: 2c20 6c61 6265 6c3d 2247 4554 5f4d 4f44  , label="GET_MOD
+0001d5c0: 5f4c 494e 4b45 445f 544f 5f49 4e54 4547  _LINKED_TO_INTEG
+0001d5d0: 5241 5449 4f4e 222c 206d 7362 5f6c 656e  RATION", msb_len
+0001d5e0: 3d31 290d 0a20 2020 2020 2020 2069 6620  =1)..        if 
+0001d5f0: 7265 732e 6572 726f 725f 6d73 6720 213d  res.error_msg !=
+0001d600: 2027 273a 0d0a 2020 2020 2020 2020 2020   '':..          
+0001d610: 2020 7265 7475 726e 2072 6573 0d0a 2020    return res..  
+0001d620: 2020 2020 2020 7265 732e 6461 7461 203d        res.data =
+0001d630: 2030 2021 3d20 7265 732e 6461 7461 0d0a   0 != res.data..
+0001d640: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0001d650: 6573 0d0a 0d0a 2020 2020 6465 6620 6765  es....    def ge
+0001d660: 745f 7365 6c65 6374 6564 5f61 6463 2873  t_selected_adc(s
+0001d670: 656c 6629 3a0d 0a20 2020 2020 2020 2076  elf):..        v
+0001d680: 616c 7565 203d 2073 656c 662e 5f67 6574  alue = self._get
+0001d690: 5f63 6f64 6528 3078 6565 2c20 6c61 6265  _code(0xee, labe
+0001d6a0: 6c3d 2247 4554 5f53 454c 4543 5445 445f  l="GET_SELECTED_
+0001d6b0: 4144 4322 2c20 6d73 625f 6c65 6e3d 3129  ADC", msb_len=1)
+0001d6c0: 0d0a 2020 2020 2020 2020 6966 2076 616c  ..        if val
+0001d6d0: 7565 2e65 7272 6f72 5f6d 7367 2021 3d20  ue.error_msg != 
+0001d6e0: 2727 3a0d 0a20 2020 2020 2020 2020 2020  '':..           
+0001d6f0: 2072 6574 7572 6e20 7661 6c75 650d 0a20   return value.. 
+0001d700: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+0001d710: 6574 7469 6e67 732e 7374 6174 652e 7365  ettings.state.se
+0001d720: 6c65 6374 6564 5f61 6463 2021 3d20 7661  lected_adc != va
+0001d730: 6c75 652e 6461 7461 3a0d 0a20 2020 2020  lue.data:..     
+0001d740: 2020 2020 2020 206c 6f67 2e65 7272 6f72         log.error
+0001d750: 2822 4745 545f 5345 4c45 4354 4544 5f41  ("GET_SELECTED_A
+0001d760: 4443 2025 6420 213d 2073 7461 7465 2e73  DC %d != state.s
+0001d770: 656c 6563 7465 645f 6164 6320 2564 222c  elected_adc %d",
+0001d780: 2076 616c 7565 2c20 7365 6c66 2e73 6574   value, self.set
+0001d790: 7469 6e67 732e 7374 6174 652e 7365 6c65  tings.state.sele
+0001d7a0: 6374 6564 5f61 6463 290d 0a20 2020 2020  cted_adc)..     
+0001d7b0: 2020 2020 2020 2073 656c 662e 7365 7474         self.sett
+0001d7c0: 696e 6773 2e73 7461 7465 2e73 656c 6563  ings.state.selec
+0001d7d0: 7465 645f 6164 6320 3d20 7661 6c75 652e  ted_adc = value.
+0001d7e0: 6461 7461 0d0a 2020 2020 2020 2020 7265  data..        re
+0001d7f0: 7475 726e 2076 616c 7565 0d0a 0d0a 2020  turn value....  
+0001d800: 2020 6465 6620 7365 745f 7472 6967 6765    def set_trigge
+0001d810: 725f 6465 6c61 7928 7365 6c66 2c20 6861  r_delay(self, ha
+0001d820: 6c66 5f75 733a 2066 6c6f 6174 293a 2023  lf_us: float): #
+0001d830: 202d 3e20 5370 6563 7472 6f6d 6574 6572   -> Spectrometer
+0001d840: 5265 7370 6f6e 7365 200d 0a20 2020 2020  Response ..     
+0001d850: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+0001d860: 4120 636f 6e66 656e 7572 6162 6c65 2064  A confenurable d
+0001d870: 656c 6179 2066 726f 6d20 7768 656e 2061  elay from when a
+0001d880: 6e20 696e 626f 756e 6420 7472 6967 6765  n inbound trigge
+0001d890: 7220 7369 676e 616c 2069 730d 0a20 2020  r signal is..   
+0001d8a0: 2020 2020 2072 6563 6569 7665 6420 6279       received by
+0001d8b0: 2074 6865 2073 7065 6374 726f 6d65 7465   the spectromete
+0001d8c0: 722c 2075 6e74 696c 2074 6865 2074 7269  r, until the tri
+0001d8d0: 6767 6572 6564 2061 6371 7569 7369 7469  ggered acquisiti
+0001d8e0: 6f6e 2061 6374 7561 6c6c 7920 7374 6172  on actually star
+0001d8f0: 7473 2e0d 0a20 2020 2020 2020 200d 0a20  ts...        .. 
+0001d900: 2020 2020 2020 2044 6566 6175 6c74 2076         Default v
+0001d910: 616c 7565 2069 7320 3075 732e 0d0a 2020  alue is 0us...  
+0001d920: 2020 2020 2020 0d0a 2020 2020 2020 2020        ..        
+0001d930: 556e 6974 2069 7320 696e 2030 2e35 206d  Unit is in 0.5 m
+0001d940: 6963 726f 7365 636f 6e64 7320 2835 3030  icroseconds (500
+0001d950: 6e73 292c 2073 6f20 7661 6c75 6520 6f66  ns), so value of
+0001d960: 2032 3520 776f 756c 6420 7265 7072 6573   25 would repres
+0001d970: 656e 7420 3132 2e35 7573 2e0d 0a20 2020  ent 12.5us...   
+0001d980: 2020 2020 200d 0a20 2020 2020 2020 2056       ..        V
+0001d990: 616c 7565 2069 7320 3234 6269 742c 2073  alue is 24bit, s
+0001d9a0: 6f20 6d61 7820 7661 6c75 6520 6973 2031  o max value is 1
+0001d9b0: 3637 3737 3231 3620 2838 2e33 3838 3630  6777216 (8.38860
+0001d9c0: 3820 7365 6329 2e0d 0a20 2020 2020 2020  8 sec)...       
+0001d9d0: 200d 0a20 2020 2020 2020 204c 696b 6520   ..        Like 
+0001d9e0: 7472 6967 6765 7269 6e67 2c20 6f6e 6c79  triggering, only
+0001d9f0: 2063 7572 7265 6e74 6c79 2073 7570 706f   currently suppo
+0001da00: 7274 6564 206f 6e20 4152 4d2e 0d0a 2020  rted on ARM...  
+0001da10: 2020 2020 2020 2222 220d 0a20 2020 2020        """..     
+0001da20: 2020 2069 6620 6e6f 7420 7365 6c66 2e73     if not self.s
+0001da30: 6574 7469 6e67 732e 6973 5f61 726d 2829  ettings.is_arm()
+0001da40: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
+0001da50: 6f67 2e65 7272 6f72 2822 5345 545f 5452  og.error("SET_TR
+0001da60: 4947 4745 525f 4445 4c41 5920 6f6e 6c79  IGGER_DELAY only
+0001da70: 2073 7570 706f 7274 6564 206f 6e20 4152   supported on AR
+0001da80: 4d22 290d 0a20 2020 2020 2020 2020 2020  M")..           
+0001da90: 2072 6574 7572 6e20 4661 6c73 650d 0a20   return False.. 
+0001daa0: 2020 2020 2020 206c 7377 203d 2068 616c         lsw = hal
+0001dab0: 665f 7573 2026 2030 7866 6666 660d 0a20  f_us & 0xffff.. 
+0001dac0: 2020 2020 2020 206d 7362 203d 2028 6861         msb = (ha
+0001dad0: 6c66 5f75 7320 3e3e 2031 3629 2026 2030  lf_us >> 16) & 0
+0001dae0: 7866 660d 0a20 2020 2020 2020 2072 6574  xff..        ret
+0001daf0: 7572 6e20 7365 6c66 2e5f 7365 6e64 5f63  urn self._send_c
+0001db00: 6f64 6528 3078 6161 2c20 7756 616c 7565  ode(0xaa, wValue
+0001db10: 3d6c 7377 2c20 7749 6e64 6578 3d6d 7362  =lsw, wIndex=msb
+0001db20: 2c20 6c61 6265 6c3d 2253 4554 5f54 5249  , label="SET_TRI
+0001db30: 4747 4552 5f44 454c 4159 2229 0d0a 0d0a  GGER_DELAY")....
+0001db40: 2020 2020 2320 6e6f 7420 7465 7374 6564      # not tested
+0001db50: 0d0a 2020 2020 6465 6620 6765 745f 7472  ..    def get_tr
+0001db60: 6967 6765 725f 6465 6c61 7928 7365 6c66  igger_delay(self
+0001db70: 293a 2023 202d 3e20 5370 6563 7472 6f6d  ): # -> Spectrom
+0001db80: 6574 6572 5265 7370 6f6e 7365 200d 0a20  eterResponse .. 
+0001db90: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+0001dba0: 6c66 2e73 6574 7469 6e67 732e 6973 5f61  lf.settings.is_a
+0001dbb0: 726d 2829 3a0d 0a20 2020 2020 2020 2020  rm():..         
+0001dbc0: 2020 206d 7367 203d 2022 4745 545f 5452     msg = "GET_TR
+0001dbd0: 4947 4745 525f 4445 4c41 5920 6f6e 6c79  IGGER_DELAY only
+0001dbe0: 2073 7570 706f 7274 6564 206f 6e20 4152   supported on AR
+0001dbf0: 4d22 0d0a 2020 2020 2020 2020 2020 2020  M"..            
+0001dc00: 6c6f 672e 6572 726f 7228 6d73 6729 0d0a  log.error(msg)..
+0001dc10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001dc20: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+0001dc30: 6573 706f 6e73 6528 6572 726f 725f 6c76  esponse(error_lv
+0001dc40: 6c3d 4572 726f 724c 6576 656c 2e6c 6f77  l=ErrorLevel.low
+0001dc50: 2c20 6572 726f 725f 6d73 673d 6d73 6729  , error_msg=msg)
+0001dc60: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001dc70: 2073 656c 662e 5f67 6574 5f63 6f64 6528   self._get_code(
+0001dc80: 3078 6534 2c20 6c61 6265 6c3d 2247 4554  0xe4, label="GET
+0001dc90: 5f54 5249 4747 4552 5f44 454c 4159 222c  _TRIGGER_DELAY",
+0001dca0: 206c 7362 5f6c 656e 3d33 2920 2320 6e6f   lsb_len=3) # no
+0001dcb0: 7420 7375 7265 2061 626f 7574 204c 5342  t sure about LSB
+0001dcc0: 0d0a 0d0a 2020 2020 6465 6620 6765 745f  ....    def get_
+0001dcd0: 7672 5f63 6f6e 7469 6e75 6f75 735f 6363  vr_continuous_cc
+0001dce0: 6428 7365 6c66 293a 2023 202d 3e20 5370  d(self): # -> Sp
+0001dcf0: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+0001dd00: 7365 200d 0a20 2020 2020 2020 2072 6573  se ..        res
+0001dd10: 203d 2073 656c 662e 5f67 6574 5f63 6f64   = self._get_cod
+0001dd20: 6528 3078 6363 2c20 6c61 6265 6c3d 2247  e(0xcc, label="G
+0001dd30: 4554 5f56 525f 434f 4e54 494e 554f 5553  ET_VR_CONTINUOUS
+0001dd40: 5f43 4344 222c 206d 7362 5f6c 656e 3d31  _CCD", msb_len=1
+0001dd50: 290d 0a20 2020 2020 2020 2069 6620 7265  )..        if re
+0001dd60: 732e 6572 726f 725f 6d73 6720 213d 2027  s.error_msg != '
+0001dd70: 273a 0d0a 2020 2020 2020 2020 2020 2020  ':..            
+0001dd80: 7265 7475 726e 2072 6573 0d0a 2020 2020  return res..    
+0001dd90: 2020 2020 7265 732e 6461 7461 203d 2030      res.data = 0
+0001dda0: 2021 3d20 7265 732e 6461 7461 0d0a 2020   != res.data..  
+0001ddb0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+0001ddc0: 0d0a 0d0a 2020 2020 6465 6620 6765 745f  ....    def get_
+0001ddd0: 7672 5f6e 756d 5f66 7261 6d65 7328 7365  vr_num_frames(se
+0001dde0: 6c66 293a 2023 202d 3e20 5370 6563 7472  lf): # -> Spectr
+0001ddf0: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+0001de00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001de10: 7365 6c66 2e5f 6765 745f 636f 6465 2830  self._get_code(0
+0001de20: 7863 642c 206c 6162 656c 3d22 4745 545f  xcd, label="GET_
+0001de30: 5652 5f4e 554d 5f46 5241 4d45 5322 2c20  VR_NUM_FRAMES", 
+0001de40: 6d73 625f 6c65 6e3d 3129 0d0a 0d0a 2020  msb_len=1)....  
+0001de50: 2020 6465 6620 6765 745f 6f70 745f 6163    def get_opt_ac
+0001de60: 7475 616c 5f69 6e74 6567 7261 7469 6f6e  tual_integration
+0001de70: 5f74 696d 6528 7365 6c66 293a 2023 202d  _time(self): # -
+0001de80: 3e20 5370 6563 7472 6f6d 6574 6572 5265  > SpectrometerRe
+0001de90: 7370 6f6e 7365 200d 0a20 2020 2020 2020  sponse ..       
+0001dea0: 2072 6573 203d 2073 656c 662e 6765 745f   res = self.get_
+0001deb0: 7570 7065 725f 636f 6465 2830 7830 622c  upper_code(0x0b,
+0001dec0: 206c 6162 656c 3d22 4745 545f 4f50 545f   label="GET_OPT_
+0001ded0: 4143 545f 494e 545f 5449 4d45 222c 206d  ACT_INT_TIME", m
+0001dee0: 7362 5f6c 656e 3d31 2920 0d0a 2020 2020  sb_len=1) ..    
+0001def0: 2020 2020 6966 2072 6573 2e65 7272 6f72      if res.error
+0001df00: 5f6d 7367 2021 3d20 2727 3a0d 0a20 2020  _msg != '':..   
+0001df10: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001df20: 7265 730d 0a20 2020 2020 2020 2072 6573  res..        res
+0001df30: 2e64 6174 6120 3d20 3020 213d 2072 6573  .data = 0 != res
+0001df40: 2e64 6174 610d 0a20 2020 2020 2020 2072  .data..        r
+0001df50: 6574 7572 6e20 7265 730d 0a0d 0a20 2020  eturn res....   
+0001df60: 2064 6566 2067 6574 5f6f 7074 5f61 7265   def get_opt_are
+0001df70: 615f 7363 616e 2873 656c 6629 3a20 2320  a_scan(self): # 
+0001df80: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+0001df90: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+0001dfa0: 2020 7265 7320 3d20 7365 6c66 2e67 6574    res = self.get
+0001dfb0: 5f75 7070 6572 5f63 6f64 6528 3078 3061  _upper_code(0x0a
+0001dfc0: 2c20 6c61 6265 6c3d 2247 4554 5f4f 5054  , label="GET_OPT
+0001dfd0: 5f41 5245 415f 5343 414e 222c 206d 7362  _AREA_SCAN", msb
+0001dfe0: 5f6c 656e 3d31 290d 0a20 2020 2020 2020  _len=1)..       
+0001dff0: 2069 6620 7265 732e 6572 726f 725f 6d73   if res.error_ms
+0001e000: 6720 213d 2027 273a 0d0a 2020 2020 2020  g != '':..      
+0001e010: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+0001e020: 0d0a 2020 2020 2020 2020 7265 732e 6461  ..        res.da
+0001e030: 7461 203d 2030 2021 3d20 7265 732e 6461  ta = 0 != res.da
+0001e040: 7461 0d0a 2020 2020 2020 2020 7265 7475  ta..        retu
+0001e050: 726e 2072 6573 0d0a 0d0a 2020 2020 6465  rn res....    de
+0001e060: 6620 6765 745f 6f70 745f 6366 5f73 656c  f get_opt_cf_sel
+0001e070: 6563 7428 7365 6c66 293a 2023 202d 3e20  ect(self): # -> 
+0001e080: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+0001e090: 6f6e 7365 200d 0a20 2020 2020 2020 2072  onse ..        r
+0001e0a0: 6573 203d 2073 656c 662e 6765 745f 7570  es = self.get_up
+0001e0b0: 7065 725f 636f 6465 2830 7830 372c 206c  per_code(0x07, l
+0001e0c0: 6162 656c 3d22 4745 545f 4f50 545f 4346  abel="GET_OPT_CF
+0001e0d0: 5f53 454c 4543 5422 2c20 6d73 625f 6c65  _SELECT", msb_le
+0001e0e0: 6e3d 3129 0d0a 2020 2020 2020 2020 6966  n=1)..        if
+0001e0f0: 2072 6573 2e65 7272 6f72 5f6d 7367 2021   res.error_msg !
+0001e100: 3d20 2727 3a0d 0a20 2020 2020 2020 2020  = '':..         
+0001e110: 2020 2072 6574 7572 6e20 7265 730d 0a20     return res.. 
+0001e120: 2020 2020 2020 2072 6573 2e64 6174 6120         res.data 
+0001e130: 3d20 3020 213d 2072 6573 2e64 6174 610d  = 0 != res.data.
+0001e140: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001e150: 7265 730d 0a0d 0a20 2020 2064 6566 2067  res....    def g
+0001e160: 6574 5f6f 7074 5f64 6174 615f 6865 6164  et_opt_data_head
+0001e170: 6572 5f74 6162 2873 656c 6629 3a20 2320  er_tab(self): # 
+0001e180: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+0001e190: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+0001e1a0: 2020 7265 7475 726e 2073 656c 662e 6765    return self.ge
+0001e1b0: 745f 7570 7065 725f 636f 6465 2830 7830  t_upper_code(0x0
+0001e1c0: 362c 206c 6162 656c 3d22 4745 545f 4f50  6, label="GET_OP
+0001e1d0: 545f 4441 5441 5f48 4541 4445 525f 5441  T_DATA_HEADER_TA
+0001e1e0: 4222 2c20 6d73 625f 6c65 6e3d 3129 0d0a  B", msb_len=1)..
+0001e1f0: 0d0a 2020 2020 6465 6620 6765 745f 6f70  ..    def get_op
+0001e200: 745f 686f 7269 7a6f 6e74 616c 5f62 696e  t_horizontal_bin
+0001e210: 6e69 6e67 2873 656c 6629 3a20 2320 2d3e  ning(self): # ->
+0001e220: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0001e230: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0001e240: 7265 7475 726e 2073 656c 662e 6765 745f  return self.get_
+0001e250: 7570 7065 725f 636f 6465 2830 7830 632c  upper_code(0x0c,
+0001e260: 206c 6162 656c 3d22 4745 545f 4f50 545f   label="GET_OPT_
+0001e270: 484f 5249 5a4f 4e54 414c 5f42 494e 4e49  HORIZONTAL_BINNI
+0001e280: 4e47 222c 206d 7362 5f6c 656e 3d31 290d  NG", msb_len=1).
+0001e290: 0a0d 0a20 2020 2064 6566 2067 6574 5f6f  ...    def get_o
+0001e2a0: 7074 5f69 6e74 6567 7261 7469 6f6e 5f74  pt_integration_t
+0001e2b0: 696d 655f 7265 736f 6c75 7469 6f6e 2873  ime_resolution(s
+0001e2c0: 656c 6629 3a20 2320 2d3e 2053 7065 6374  elf): # -> Spect
+0001e2d0: 726f 6d65 7465 7252 6573 706f 6e73 6520  rometerResponse 
+0001e2e0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001e2f0: 2073 656c 662e 6765 745f 7570 7065 725f   self.get_upper_
+0001e300: 636f 6465 2830 7830 352c 206c 6162 656c  code(0x05, label
+0001e310: 3d22 4745 545f 4f50 545f 494e 5445 4752  ="GET_OPT_INTEGR
+0001e320: 4154 494f 4e5f 5449 4d45 5f52 4553 4f4c  ATION_TIME_RESOL
+0001e330: 5554 494f 4e22 2c20 6d73 625f 6c65 6e3d  UTION", msb_len=
+0001e340: 3129 0d0a 0d0a 2020 2020 2320 2323 2323  1)....    # ####
+0001e350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e370: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e390: 2323 2323 2323 0d0a 2020 2020 2320 416e  ######..    # An
+0001e3a0: 616c 6f67 206f 7574 7075 740d 0a20 2020  alog output..   
+0001e3b0: 2023 2023 2323 2323 2323 2323 2323 2323   # #############
+0001e3c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e3d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e3e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e3f0: 2323 2323 2323 2323 2323 2323 230d 0a0d  #############...
+0001e400: 0a20 2020 2023 2320 4070 6172 616d 2076  .    ## @param v
+0001e410: 616c 7565 2028 496e 7075 7429 2074 7570  alue (Input) tup
+0001e420: 6c65 206f 6620 2862 6f6f 6c20 656e 6162  le of (bool enab
+0001e430: 6c65 2c20 696e 7420 6d6f 6465 290d 0a20  le, int mode).. 
+0001e440: 2020 2064 6566 2073 6574 5f61 6e61 6c6f     def set_analo
+0001e450: 675f 6f75 7470 7574 5f6d 6f64 6528 7365  g_output_mode(se
+0001e460: 6c66 2c20 7661 6c75 653a 2074 7570 6c65  lf, value: tuple
+0001e470: 5b62 6f6f 6c2c 2069 6e74 5d29 3a20 2320  [bool, int]): # 
+0001e480: 2d3e 2053 7065 6374 726f 6d65 7465 7252  -> SpectrometerR
+0001e490: 6573 706f 6e73 6520 0d0a 2020 2020 2020  esponse ..      
+0001e4a0: 2020 6966 206e 6f74 2073 656c 662e 7365    if not self.se
+0001e4b0: 7474 696e 6773 2e69 735f 6765 6e32 2829  ttings.is_gen2()
+0001e4c0: 3a0d 0a20 2020 2020 2020 2020 2020 206c  :..            l
+0001e4d0: 6f67 6765 722e 6572 726f 7228 2261 6e61  ogger.error("ana
+0001e4e0: 6c6f 6720 6f75 7470 7574 206f 6e6c 7920  log output only 
+0001e4f0: 6176 6169 6c61 626c 6520 6f6e 2047 656e  available on Gen
+0001e500: 3222 290d 0a20 2020 2020 2020 2020 2020  2")..           
+0001e510: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+0001e520: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+0001e530: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
+0001e540: 673d 2261 6e61 6c6f 6720 6f75 7470 7574  g="analog output
+0001e550: 2075 6e73 7570 706f 7274 6564 2229 0d0a   unsupported")..
+0001e560: 0d0a 2020 2020 2020 2020 7749 6e64 6578  ..        wIndex
+0001e570: 203d 2030 0d0a 0d0a 2020 2020 2020 2020   = 0....        
+0001e580: 2320 7061 7273 6520 656e 6162 6c65 2061  # parse enable a
+0001e590: 6e64 206d 6f64 6520 6672 6f6d 2076 616c  nd mode from val
+0001e5a0: 7565 2074 7570 6c65 0d0a 2020 2020 2020  ue tuple..      
+0001e5b0: 2020 7472 793a 0d0a 2020 2020 2020 2020    try:..        
+0001e5c0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0001e5d0: 6528 7661 6c75 655b 305d 2c20 626f 6f6c  e(value[0], bool
+0001e5e0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+0001e5f0: 2020 2020 656e 6162 6c65 203d 2076 616c      enable = val
+0001e600: 7565 5b30 5d0d 0a20 2020 2020 2020 2020  ue[0]..         
+0001e610: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+0001e620: 2020 2020 2020 2020 2020 656e 6162 6c65            enable
+0001e630: 203d 2076 616c 7565 5b30 5d20 213d 2030   = value[0] != 0
+0001e640: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+0001e650: 6d6f 6465 203d 2069 6e74 2876 616c 7565  mode = int(value
+0001e660: 5b31 5d29 0d0a 2020 2020 2020 2020 2020  [1])..          
+0001e670: 2020 6966 2028 6d6f 6465 2021 3d20 3020    if (mode != 0 
+0001e680: 616e 6420 6d6f 6465 2021 3d20 3129 3a0d  and mode != 1):.
+0001e690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e6a0: 206c 6f67 6765 722e 6572 726f 7228 2269   logger.error("i
+0001e6b0: 6e76 616c 6964 2061 6e61 6c6f 6720 6f75  nvalid analog ou
+0001e6c0: 7470 7574 206d 6f64 6520 3078 2530 3278  tput mode 0x%02x
+0001e6d0: 2c20 6469 7361 626c 696e 6722 2c20 6d6f  , disabling", mo
+0001e6e0: 6465 290d 0a20 2020 2020 2020 2020 2020  de)..           
+0001e6f0: 2020 2020 2065 6e61 626c 6520 3d20 4661       enable = Fa
+0001e700: 6c73 650d 0a20 2020 2020 2020 2020 2020  lse..           
+0001e710: 2020 2020 206d 6f64 6520 3d20 300d 0a0d       mode = 0...
+0001e720: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001e730: 656e 6162 6c65 3a0d 0a20 2020 2020 2020  enable:..       
+0001e740: 2020 2020 2020 2020 2077 496e 6465 7820           wIndex 
+0001e750: 3d20 3078 3032 207c 206d 6f64 6520 2320  = 0x02 | mode # 
+0001e760: 3078 3032 2073 6574 7320 7468 6520 2265  0x02 sets the "e
+0001e770: 6e61 626c 6522 2062 6974 0d0a 2020 2020  nable" bit..    
+0001e780: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e790: 2e73 7461 7465 2e61 6e61 6c6f 675f 6f75  .state.analog_ou
+0001e7a0: 745f 656e 6162 6c65 203d 2054 7275 650d  t_enable = True.
+0001e7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e7c0: 2073 656c 662e 7374 6174 652e 616e 616c   self.state.anal
+0001e7d0: 6f67 5f6f 7574 5f6d 6f64 6520 3d20 6d6f  og_out_mode = mo
+0001e7e0: 6465 0d0a 2020 2020 2020 2020 2020 2020  de..            
+0001e7f0: 2020 2020 7365 6c66 2e73 7461 7465 2e61      self.state.a
+0001e800: 6e61 6c6f 675f 6f75 745f 7661 6c75 6520  nalog_out_value 
+0001e810: 3d20 3020 6966 206d 6f64 6520 3d3d 2030  = 0 if mode == 0
+0001e820: 2065 6c73 6520 3430 2023 2034 6d41 2064   else 40 # 4mA d
+0001e830: 6566 6175 6c74 2063 7572 7265 6e74 2069  efault current i
+0001e840: 6e20 6465 6369 2d6d 410d 0a20 2020 2020  n deci-mA..     
+0001e850: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+0001e860: 2020 2020 2020 2020 2020 2020 2020 7749                wI
+0001e870: 6e64 6578 203d 2030 0d0a 2020 2020 2020  ndex = 0..      
+0001e880: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+0001e890: 7461 7465 2e61 6e61 6c6f 675f 6f75 745f  tate.analog_out_
+0001e8a0: 656e 6162 6c65 203d 2046 616c 7365 0d0a  enable = False..
+0001e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e8c0: 7365 6c66 2e73 7461 7465 2e61 6e61 6c6f  self.state.analo
+0001e8d0: 675f 6f75 745f 6d6f 6465 203d 2030 0d0a  g_out_mode = 0..
+0001e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e8f0: 7365 6c66 2e73 7461 7465 2e61 6e61 6c6f  self.state.analo
+0001e900: 675f 6f75 745f 7661 6c75 6520 3d20 300d  g_out_value = 0.
+0001e910: 0a0d 0a20 2020 2020 2020 2065 7863 6570  ...        excep
+0001e920: 743a 0d0a 2020 2020 2020 2020 2020 2020  t:..            
+0001e930: 6c6f 6767 6572 2e65 7272 6f72 2822 7365  logger.error("se
+0001e940: 745f 616e 616c 6f67 5f6f 7574 7075 745f  t_analog_output_
+0001e950: 6d6f 6465 2074 616b 6573 2074 7570 6c65  mode takes tuple
+0001e960: 206f 6620 2862 6f6f 6c2c 2069 6e74 292c   of (bool, int),
+0001e970: 2064 6973 6162 6c69 6e67 2229 0d0a 2020   disabling")..  
+0001e980: 2020 2020 2020 2020 2020 7749 6e64 6578            wIndex
+0001e990: 203d 2030 0d0a 0d0a 2020 2020 2020 2020   = 0....        
+0001e9a0: 7265 7475 726e 2073 656c 662e 5f73 656e  return self._sen
+0001e9b0: 645f 636f 6465 2862 5265 7175 6573 7420  d_code(bRequest 
+0001e9c0: 203d 2030 7866 662c 0d0a 2020 2020 2020   = 0xff,..      
+0001e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9e0: 2020 2020 2020 2020 7756 616c 7565 2020          wValue  
+0001e9f0: 2020 3d20 3078 3131 2c0d 0a20 2020 2020    = 0x11,..     
+0001ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea10: 2020 2020 2020 2020 2077 496e 6465 7820           wIndex 
+0001ea20: 2020 203d 2077 496e 6465 782c 0d0a 2020     = wIndex,..  
+0001ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea40: 2020 2020 2020 2020 2020 2020 6c61 6265              labe
+0001ea50: 6c20 2020 2020 3d20 2253 4554 5f41 4e41  l     = "SET_ANA
+0001ea60: 4c4f 475f 4f55 545f 4d4f 4445 2229 0d0a  LOG_OUT_MODE")..
+0001ea70: 0d0a 2020 2020 6465 6620 7365 745f 616e  ..    def set_an
+0001ea80: 616c 6f67 5f6f 7574 7075 745f 7661 6c75  alog_output_valu
+0001ea90: 6528 7365 6c66 2c20 7661 6c75 653a 2069  e(self, value: i
+0001eaa0: 6e74 293a 2023 202d 3e20 5370 6563 7472  nt): # -> Spectr
+0001eab0: 6f6d 6574 6572 5265 7370 6f6e 7365 200d  ometerResponse .
+0001eac0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001ead0: 7365 6c66 2e73 6574 7469 6e67 732e 6973  self.settings.is
+0001eae0: 5f67 656e 3228 293a 0d0a 2020 2020 2020  _gen2():..      
+0001eaf0: 2020 2020 2020 6c6f 6767 6572 2e65 7272        logger.err
+0001eb00: 6f72 2822 616e 616c 6f67 206f 7574 7075  or("analog outpu
+0001eb10: 7420 6f6e 6c79 2061 7661 696c 6162 6c65  t only available
+0001eb20: 206f 6e20 4765 6e32 2229 0d0a 2020 2020   on Gen2")..    
+0001eb30: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+0001eb40: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0001eb50: 6e73 6528 6461 7461 3d46 616c 7365 2c65  nse(data=False,e
+0001eb60: 7272 6f72 5f6d 7367 3d22 616e 616c 6f67  rror_msg="analog
+0001eb70: 206f 7574 7075 7420 756e 7375 7070 6f72   output unsuppor
+0001eb80: 7465 6422 290d 0a0d 0a20 2020 2020 2020  ted")....       
+0001eb90: 2023 2073 7065 6374 726f 6d65 7465 7220   # spectrometer 
+0001eba0: 7368 6f75 6c64 2072 616e 6765 2d6c 696d  should range-lim
+0001ebb0: 6974 2c20 6275 7420 6a75 7374 2074 6f20  it, but just to 
+0001ebc0: 636f 6469 6679 3a0d 0a20 2020 2020 2020  codify:..       
+0001ebd0: 2069 6620 7365 6c66 2e73 7461 7465 2e61   if self.state.a
+0001ebe0: 6e61 6c6f 675f 6f75 745f 6d6f 6465 203d  nalog_out_mode =
+0001ebf0: 3d20 303a 0d0a 2020 2020 2020 2020 2020  = 0:..          
+0001ec00: 2020 2320 766f 6c74 6167 6520 2864 6563    # voltage (dec
+0001ec10: 6976 6f6c 7473 2c20 7261 6e67 6520 302d  ivolts, range 0-
+0001ec20: 3530 2028 302d 3556 2929 0d0a 2020 2020  50 (0-5V))..    
+0001ec30: 2020 2020 2020 2020 6966 2076 616c 7565          if value
+0001ec40: 203c 2030 3a0d 0a20 2020 2020 2020 2020   < 0:..         
+0001ec50: 2020 2020 2020 2076 616c 7565 203d 2030         value = 0
+0001ec60: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0001ec70: 2076 616c 7565 203e 2035 303a 0d0a 2020   value > 50:..  
+0001ec80: 2020 2020 2020 2020 2020 2020 2020 7661                va
+0001ec90: 6c75 6520 3d20 3530 0d0a 2020 2020 2020  lue = 50..      
+0001eca0: 2020 656c 6966 2073 656c 662e 7374 6174    elif self.stat
+0001ecb0: 652e 616e 616c 6f67 5f6f 7574 5f6d 6f64  e.analog_out_mod
+0001ecc0: 6520 3d3d 2031 3a0d 0a20 2020 2020 2020  e == 1:..       
+0001ecd0: 2020 2020 2023 2063 7572 7265 6e74 2028       # current (
+0001ece0: 6465 6369 2d6d 412c 2072 616e 6765 2034  deci-mA, range 4
+0001ecf0: 302d 3230 3020 2834 2d32 306d 4129 290d  0-200 (4-20mA)).
+0001ed00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001ed10: 7661 6c75 6520 3c20 3430 3a0d 0a20 2020  value < 40:..   
+0001ed20: 2020 2020 2020 2020 2020 2020 2076 616c               val
+0001ed30: 7565 203d 2034 300d 0a20 2020 2020 2020  ue = 40..       
+0001ed40: 2020 2020 2065 6c69 6620 7661 6c75 6520       elif value 
+0001ed50: 3e20 3230 303a 0d0a 2020 2020 2020 2020  > 200:..        
+0001ed60: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
+0001ed70: 3230 300d 0a20 2020 2020 2020 2065 6c73  200..        els
+0001ed80: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+0001ed90: 6c6f 672e 6572 726f 7228 2269 6e76 616c  log.error("inval
+0001eda0: 6964 2061 6e61 6c6f 6720 6f75 7420 6d6f  id analog out mo
+0001edb0: 6465 2025 642c 2069 676e 6f72 696e 6720  de %d, ignoring 
+0001edc0: 7661 6c75 6522 2c20 7365 6c66 2e73 7461  value", self.sta
+0001edd0: 7465 2e61 6e61 6c6f 675f 6f75 745f 6d6f  te.analog_out_mo
+0001ede0: 6465 290d 0a20 2020 2020 2020 2020 2020  de)..           
+0001edf0: 2072 6574 7572 6e20 5370 6563 7472 6f6d   return Spectrom
+0001ee00: 6574 6572 5265 7370 6f6e 7365 2864 6174  eterResponse(dat
+0001ee10: 613d 4661 6c73 652c 6572 726f 725f 6d73  a=False,error_ms
+0001ee20: 673d 2269 6e76 616c 6964 206d 6f64 6522  g="invalid mode"
+0001ee30: 290d 0a0d 0a20 2020 2020 2020 2072 6574  )....        ret
+0001ee40: 7572 6e20 7365 6c66 2e5f 7365 6e64 5f63  urn self._send_c
+0001ee50: 6f64 6528 6252 6571 7565 7374 2020 3d20  ode(bRequest  = 
+0001ee60: 3078 6666 2c0d 0a20 2020 2020 2020 2020  0xff,..         
+0001ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee80: 2020 2020 2077 5661 6c75 6520 2020 203d       wValue    =
+0001ee90: 2030 7831 322c 0d0a 2020 2020 2020 2020   0x12,..        
+0001eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eeb0: 2020 2020 2020 7749 6e64 6578 2020 2020        wIndex    
+0001eec0: 3d20 7661 6c75 652c 0d0a 2020 2020 2020  = value,..      
+0001eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eee0: 2020 2020 2020 2020 6c61 6265 6c20 2020          label   
+0001eef0: 2020 3d20 2253 4554 5f41 4e41 4c4f 475f    = "SET_ANALOG_
+0001ef00: 4f55 545f 5641 4c55 4522 290d 0a0d 0a20  OUT_VALUE").... 
+0001ef10: 2020 2064 6566 2067 6574 5f61 6e61 6c6f     def get_analo
+0001ef20: 675f 6f75 7470 7574 5f73 7461 7465 2873  g_output_state(s
+0001ef30: 656c 6629 3a20 2320 2d3e 2053 7065 6374  elf): # -> Spect
+0001ef40: 726f 6d65 7465 7252 6573 706f 6e73 6520  rometerResponse 
+0001ef50: 0d0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0001ef60: 2073 656c 662e 7365 7474 696e 6773 2e69   self.settings.i
+0001ef70: 735f 6765 6e32 2829 3a0d 0a20 2020 2020  s_gen2():..     
+0001ef80: 2020 2020 2020 206c 6f67 6765 722e 6572         logger.er
+0001ef90: 726f 7228 2261 6e61 6c6f 6720 6f75 7470  ror("analog outp
+0001efa0: 7574 206f 6e6c 7920 6176 6169 6c61 626c  ut only availabl
+0001efb0: 6520 6f6e 2047 656e 3222 290d 0a20 2020  e on Gen2")..   
+0001efc0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001efd0: 5370 6563 7472 6f6d 6574 6572 5265 7370  SpectrometerResp
+0001efe0: 6f6e 7365 2864 6174 613d 4661 6c73 652c  onse(data=False,
+0001eff0: 6572 726f 725f 6d73 673d 2261 6e61 6c6f  error_msg="analo
+0001f000: 6720 6f75 7470 7574 2075 6e73 7570 706f  g output unsuppo
+0001f010: 7274 6564 2229 0d0a 0d0a 2020 2020 2020  rted")....      
+0001f020: 2020 7265 7320 3d20 7365 6c66 2e67 6574    res = self.get
+0001f030: 5f75 7070 6572 5f63 6f64 6528 3078 3161  _upper_code(0x1a
+0001f040: 2c20 774c 656e 6774 683d 332c 206c 6162  , wLength=3, lab
+0001f050: 656c 3d22 4745 545f 414e 414c 4f47 5f4f  el="GET_ANALOG_O
+0001f060: 5554 5f53 5441 5445 2229 0d0a 2020 2020  UT_STATE")..    
+0001f070: 2020 2020 6966 2072 6573 2e65 7272 6f72      if res.error
+0001f080: 5f6d 7367 2021 3d20 2727 3a0d 0a20 2020  _msg != '':..   
+0001f090: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001f0a0: 7265 730d 0a20 2020 2020 2020 2064 6174  res..        dat
+0001f0b0: 6120 3d20 7265 732e 6461 7461 0d0a 2020  a = res.data..  
+0001f0c0: 2020 2020 2020 6966 2028 6461 7461 2069        if (data i
+0001f0d0: 7320 4e6f 6e65 206f 7220 6c65 6e28 6461  s None or len(da
+0001f0e0: 7461 2920 213d 2033 293a 0d0a 2020 2020  ta) != 3):..    
+0001f0f0: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+0001f100: 7272 6f72 2822 696e 7661 6c69 6420 616e  rror("invalid an
+0001f110: 616c 6f67 206f 7574 2073 7461 7465 2072  alog out state r
+0001f120: 6561 643a 2025 7322 2c20 6461 7461 290d  ead: %s", data).
+0001f130: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001f140: 7572 6e20 5370 6563 7472 6f6d 6574 6572  urn Spectrometer
+0001f150: 5265 7370 6f6e 7365 2864 6174 613d 4661  Response(data=Fa
+0001f160: 6c73 652c 6572 726f 725f 6d73 673d 2269  lse,error_msg="i
+0001f170: 6e76 616c 6964 2061 6e61 6c6f 6720 6f75  nvalid analog ou
+0001f180: 7420 7374 6174 6520 7265 6164 2229 0d0a  t state read")..
+0001f190: 0d0a 2020 2020 2020 2020 6966 2064 6174  ..        if dat
+0001f1a0: 615b 305d 2021 3d20 3020 616e 6420 6461  a[0] != 0 and da
+0001f1b0: 7461 5b30 5d20 213d 2031 3a0d 0a20 2020  ta[0] != 1:..   
+0001f1c0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0001f1d0: 6572 726f 7228 2272 6563 6569 7665 6420  error("received 
+0001f1e0: 696e 7661 6c69 6420 616e 616c 6f67 206f  invalid analog o
+0001f1f0: 7574 2065 6e61 626c 653a 2025 6422 2c20  ut enable: %d", 
+0001f200: 6461 7461 5b30 5d29 0d0a 2020 2020 2020  data[0])..      
+0001f210: 2020 6966 2064 6174 615b 315d 2021 3d20    if data[1] != 
+0001f220: 3020 616e 6420 6461 7461 5b31 5d20 213d  0 and data[1] !=
+0001f230: 2031 3a0d 0a20 2020 2020 2020 2020 2020   1:..           
+0001f240: 206c 6f67 6765 722e 6572 726f 7228 2272   logger.error("r
+0001f250: 6563 6569 7665 6420 696e 7661 6c69 6420  eceived invalid 
+0001f260: 616e 616c 6f67 206f 7574 206d 6f64 653a  analog out mode:
+0001f270: 2025 6422 2c20 6461 7461 5b31 5d29 0d0a   %d", data[1])..
+0001f280: 0d0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+0001f290: 7461 7465 2e61 6e61 6c6f 675f 6f75 745f  tate.analog_out_
+0001f2a0: 656e 6162 6c65 203d 2064 6174 615b 305d  enable = data[0]
+0001f2b0: 2021 3d20 300d 0a20 2020 2020 2020 2073   != 0..        s
+0001f2c0: 656c 662e 7374 6174 652e 616e 616c 6f67  elf.state.analog
+0001f2d0: 5f6f 7574 5f6d 6f64 6520 3d20 6461 7461  _out_mode = data
+0001f2e0: 5b31 5d0d 0a20 2020 2020 2020 2073 656c  [1]..        sel
+0001f2f0: 662e 7374 6174 652e 616e 616c 6f67 5f6f  f.state.analog_o
+0001f300: 7574 5f76 616c 7565 203d 2064 6174 615b  ut_value = data[
+0001f310: 325d 2023 206e 6f20 7261 6e67 652d 6368  2] # no range-ch
+0001f320: 6563 6b69 6e67 2061 7070 6c69 6564 0d0a  ecking applied..
+0001f330: 2020 2020 2020 2020 6461 7461 203d 2028          data = (
+0001f340: 7365 6c66 2e73 7461 7465 2e61 6e61 6c6f  self.state.analo
+0001f350: 675f 6f75 745f 656e 6162 6c65 2c0d 0a20  g_out_enable,.. 
+0001f360: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001f370: 656c 662e 7374 6174 652e 616e 616c 6f67  elf.state.analog
+0001f380: 5f6f 7574 5f6d 6f64 652c 0d0a 2020 2020  _out_mode,..    
+0001f390: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001f3a0: 2e73 7461 7465 2e61 6e61 6c6f 675f 6f75  .state.analog_ou
+0001f3b0: 745f 7661 6c75 6529 0d0a 2020 2020 2020  t_value)..      
+0001f3c0: 2020 7265 7475 726e 2053 7065 6374 726f    return Spectro
+0001f3d0: 6d65 7465 7252 6573 706f 6e73 6528 6461  meterResponse(da
+0001f3e0: 7461 3d64 6174 6129 0d0a 0d0a 2020 2020  ta=data)....    
+0001f3f0: 2320 4072 6574 7572 6e73 2064 6563 6976  # @returns deciv
+0001f400: 6f6c 7473 0d0a 2020 2020 6465 6620 6765  olts..    def ge
+0001f410: 745f 616e 616c 6f67 5f69 6e70 7574 5f76  t_analog_input_v
+0001f420: 616c 7565 2873 656c 6629 3a20 2320 2d3e  alue(self): # ->
+0001f430: 2053 7065 6374 726f 6d65 7465 7252 6573   SpectrometerRes
+0001f440: 706f 6e73 6520 0d0a 2020 2020 2020 2020  ponse ..        
+0001f450: 6966 206e 6f74 2073 656c 662e 7365 7474  if not self.sett
+0001f460: 696e 6773 2e69 735f 6765 6e32 2829 3a0d  ings.is_gen2():.
+0001f470: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001f480: 6765 722e 6572 726f 7228 2261 6e61 6c6f  ger.error("analo
+0001f490: 6720 696e 7075 7420 6f6e 6c79 2061 7661  g input only ava
+0001f4a0: 696c 6162 6c65 206f 6e20 4765 6e32 2229  ilable on Gen2")
+0001f4b0: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0001f4c0: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+0001f4d0: 7252 6573 706f 6e73 6528 6461 7461 3d46  rResponse(data=F
+0001f4e0: 616c 7365 2c65 7272 6f72 5f6d 7367 3d22  alse,error_msg="
+0001f4f0: 616e 616c 6f67 2069 6e70 7574 2075 6e73  analog input uns
+0001f500: 7570 706f 7274 6564 2229 0d0a 2020 2020  upported")..    
+0001f510: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0001f520: 6765 745f 7570 7065 725f 636f 6465 2830  get_upper_code(0
+0001f530: 7831 622c 206c 7362 5f6c 656e 3d31 2c20  x1b, lsb_len=1, 
+0001f540: 6c61 6265 6c3d 2247 4554 5f41 4e41 4c4f  label="GET_ANALO
+0001f550: 475f 494e 5f56 414c 5545 2229 0d0a 0d0a  G_IN_VALUE")....
+0001f560: 2020 2020 2320 2323 2323 2323 2323 2323      # ##########
+0001f570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f590: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f5a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f5b0: 0d0a 2020 2020 2320 4545 5052 4f4d 2043  ..    # EEPROM C
+0001f5c0: 7275 6674 0d0a 2020 2020 2320 2323 2323  ruft..    # ####
+0001f5d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f5e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f5f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f610: 2323 2323 2323 0d0a 0d0a 2020 2020 6465  ######....    de
+0001f620: 6620 7570 6461 7465 5f73 6573 7369 6f6e  f update_session
+0001f630: 5f65 6570 726f 6d28 7365 6c66 2c20 7061  _eeprom(self, pa
+0001f640: 6972 3a20 7475 706c 655b 7374 722c 2045  ir: tuple[str, E
+0001f650: 4550 524f 4d5d 293a 2023 202d 3e20 5370  EPROM]): # -> Sp
+0001f660: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+0001f670: 7365 200d 0a20 2020 2020 2020 2022 2222  se ..        """
+0001f680: 0d0a 2020 2020 2020 2020 4769 7665 6e20  ..        Given 
+0001f690: 6120 2873 6572 6961 6c5f 6e75 6d62 6572  a (serial_number
+0001f6a0: 2c20 4545 5052 4f4d 2920 7061 6972 2c20  , EEPROM) pair, 
+0001f6b0: 7570 6461 7465 2074 6869 7320 7072 6f63  update this proc
+0001f6c0: 6573 7327 7320 2273 6573 7369 6f6e 220d  ess's "session".
+0001f6d0: 0a20 2020 2020 2020 2045 4550 524f 4d20  .        EEPROM 
+0001f6e0: 7769 7468 206a 7573 7420 7468 6520 4544  with just the ED
+0001f6f0: 4954 4142 4c45 2066 6965 6c64 7320 6f66  ITABLE fields of
+0001f700: 2074 6865 2070 6173 7365 6420 4545 5052   the passed EEPR
+0001f710: 4f4d 2e0d 0a20 2020 2020 2020 2022 2222  OM...        """
+0001f720: 0d0a 2020 2020 2020 2020 6c6f 672e 6465  ..        log.de
+0001f730: 6275 6728 2266 6964 2e75 7064 6174 655f  bug("fid.update_
+0001f740: 7365 7373 696f 6e5f 6565 7072 6f6d 3a20  session_eeprom: 
+0001f750: 2573 2075 7064 6174 696e 6720 4545 5052  %s updating EEPR
+0001f760: 4f4d 2069 6e73 7461 6e63 6522 2c20 7365  OM instance", se
+0001f770: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+0001f780: 6f6d 2e73 6572 6961 6c5f 6e75 6d62 6572  om.serial_number
+0001f790: 290d 0a0d 0a20 2020 2020 2020 2069 6620  )....        if 
+0001f7a0: 6e6f 7420 7365 6c66 2e65 6570 726f 6d5f  not self.eeprom_
+0001f7b0: 6261 636b 7570 3a0d 0a20 2020 2020 2020  backup:..       
+0001f7c0: 2020 2020 2073 656c 662e 6565 7072 6f6d       self.eeprom
+0001f7d0: 5f62 6163 6b75 7020 3d20 636f 7079 2e64  _backup = copy.d
+0001f7e0: 6565 7063 6f70 7928 7365 6c66 2e73 6574  eepcopy(self.set
+0001f7f0: 7469 6e67 732e 6565 7072 6f6d 290d 0a0d  tings.eeprom)...
+0001f800: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0001f810: 7474 696e 6773 2e65 6570 726f 6d2e 7570  ttings.eeprom.up
+0001f820: 6461 7465 5f65 6469 7461 626c 6528 7061  date_editable(pa
+0001f830: 6972 5b31 5d29 0d0a 2020 2020 2020 2020  ir[1])..        
+0001f840: 7265 7475 726e 2053 7065 6374 726f 6d65  return Spectrome
+0001f850: 7465 7252 6573 706f 6e73 6528 6461 7461  terResponse(data
+0001f860: 3d54 7275 6529 0d0a 0d0a 2020 2020 6465  =True)....    de
+0001f870: 6620 7265 706c 6163 655f 7365 7373 696f  f replace_sessio
+0001f880: 6e5f 6565 7072 6f6d 2873 656c 662c 2070  n_eeprom(self, p
+0001f890: 6169 723a 2074 7570 6c65 5b73 7472 2c20  air: tuple[str, 
+0001f8a0: 4545 5052 4f4d 5d29 3a20 2320 2d3e 2053  EEPROM]): # -> S
+0001f8b0: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+0001f8c0: 6e73 6520 0d0a 2020 2020 2020 2020 2222  nse ..        ""
+0001f8d0: 220d 0a20 2020 2020 2020 2047 6976 656e  "..        Given
+0001f8e0: 2061 2028 7365 7269 616c 5f6e 756d 6265   a (serial_numbe
+0001f8f0: 722c 2045 4550 524f 4d29 2070 6169 722c  r, EEPROM) pair,
+0001f900: 2072 6570 6c61 6365 2074 6869 7320 7072   replace this pr
+0001f910: 6f63 6573 7327 7320 2273 6573 7369 6f6e  ocess's "session
+0001f920: 220d 0a20 2020 2020 2020 2045 4550 524f  "..        EEPRO
+0001f930: 4d20 7769 7468 2074 6865 2070 6173 7365  M with the passe
+0001f940: 6420 4545 5052 4f4d 2e0d 0a20 2020 2020  d EEPROM...     
+0001f950: 2020 2022 2222 0d0a 2020 2020 2020 2020     """..        
+0001f960: 6c6f 672e 6465 6275 6728 2266 6964 2e72  log.debug("fid.r
+0001f970: 6570 6c61 6365 5f73 6573 7369 6f6e 5f65  eplace_session_e
+0001f980: 6570 726f 6d3a 2025 7320 7265 706c 6163  eprom: %s replac
+0001f990: 696e 6720 4545 5052 4f4d 2069 6e73 7461  ing EEPROM insta
+0001f9a0: 6e63 6522 2c20 7365 6c66 2e73 6574 7469  nce", self.setti
+0001f9b0: 6e67 732e 6565 7072 6f6d 2e73 6572 6961  ngs.eeprom.seria
+0001f9c0: 6c5f 6e75 6d62 6572 290d 0a0d 0a20 2020  l_number)....   
+0001f9d0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0001f9e0: 2e65 6570 726f 6d5f 6261 636b 7570 3a0d  .eeprom_backup:.
+0001f9f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001fa00: 662e 6565 7072 6f6d 5f62 6163 6b75 7020  f.eeprom_backup 
+0001fa10: 3d20 636f 7079 2e64 6565 7063 6f70 7928  = copy.deepcopy(
+0001fa20: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+0001fa30: 7072 6f6d 290d 0a0d 0a20 2020 2020 2020  prom)....       
+0001fa40: 2073 656c 662e 7365 7474 696e 6773 2e65   self.settings.e
+0001fa50: 6570 726f 6d20 3d20 7061 6972 5b31 5d0d  eprom = pair[1].
+0001fa60: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0001fa70: 7474 696e 6773 2e65 6570 726f 6d2e 6475  ttings.eeprom.du
+0001fa80: 6d70 2829 0d0a 2020 2020 2020 2020 7265  mp()..        re
+0001fa90: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+0001faa0: 7252 6573 706f 6e73 6528 290d 0a0d 0a20  rResponse().... 
+0001fab0: 2020 2023 2320 4163 7475 616c 6c79 2073     ## Actually s
+0001fac0: 746f 7265 2074 6865 2063 7572 7265 6e74  tore the current
+0001fad0: 2073 6573 7369 6f6e 2045 4550 524f 4d20   session EEPROM 
+0001fae0: 6669 656c 6473 2074 6f20 7468 6520 7370  fields to the sp
+0001faf0: 6563 7472 6f6d 6574 6572 2e0d 0a20 2020  ectrometer...   
+0001fb00: 2064 6566 2077 7269 7465 5f65 6570 726f   def write_eepro
+0001fb10: 6d28 7365 6c66 293a 2023 202d 3e20 5370  m(self): # -> Sp
+0001fb20: 6563 7472 6f6d 6574 6572 5265 7370 6f6e  ectrometerRespon
+0001fb30: 7365 200d 0a20 2020 2020 2020 2069 6620  se ..        if 
+0001fb40: 6e6f 7420 7365 6c66 2e65 6570 726f 6d5f  not self.eeprom_
+0001fb50: 6261 636b 7570 3a0d 0a20 2020 2020 2020  backup:..       
+0001fb60: 2020 2020 206c 6f67 2e63 7269 7469 6361       log.critica
+0001fb70: 6c28 2265 7870 6563 7465 6420 746f 2075  l("expected to u
+0001fb80: 7064 6174 6520 6f72 2072 6570 6c61 6365  pdate or replace
+0001fb90: 2045 4550 524f 4d20 6f62 6a65 6374 2062   EEPROM object b
+0001fba0: 6566 6f72 6520 7772 6974 6520 636f 6d6d  efore write comm
+0001fbb0: 616e 6422 290d 0a20 2020 2020 2020 2020  and")..         
+0001fbc0: 2020 2073 656c 662e 7175 6575 655f 6d65     self.queue_me
+0001fbd0: 7373 6167 6528 226d 6172 7175 6565 5f65  ssage("marquee_e
+0001fbe0: 7272 6f72 222c 2022 4661 696c 6564 2074  rror", "Failed t
+0001fbf0: 6f20 7772 6974 6520 4545 5052 4f4d 2229  o write EEPROM")
+0001fc00: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+0001fc10: 7475 726e 2053 7065 6374 726f 6d65 7465  turn Spectromete
+0001fc20: 7252 6573 706f 6e73 6528 6461 7461 3d46  rResponse(data=F
+0001fc30: 616c 7365 2c65 7272 6f72 5f6d 7367 3d22  alse,error_msg="
+0001fc40: 6661 696c 6564 2074 6f20 7772 6974 6520  failed to write 
+0001fc50: 6565 7072 6f6d 2229 0d0a 0d0a 2020 2020  eeprom")....    
+0001fc60: 2020 2020 2320 6261 636b 7570 2063 6f6e      # backup con
+0001fc70: 7465 6e74 7320 6f66 2070 7265 7669 6f75  tents of previou
+0001fc80: 7320 4545 5052 4f4d 2069 6e20 6c6f 670d  s EEPROM in log.
+0001fc90: 0a20 2020 2020 2020 206c 6f67 2e64 6562  .        log.deb
+0001fca0: 7567 2822 4f72 6967 696e 616c 2045 4550  ug("Original EEP
+0001fcb0: 524f 4d20 636f 6e74 656e 7473 2229 0d0a  ROM contents")..
+0001fcc0: 2020 2020 2020 2020 7365 6c66 2e65 6570          self.eep
+0001fcd0: 726f 6d5f 6261 636b 7570 2e64 756d 7028  rom_backup.dump(
+0001fce0: 290d 0a20 2020 2020 2020 206c 6f67 2e64  )..        log.d
+0001fcf0: 6562 7567 2822 4f72 6967 696e 616c 2045  ebug("Original E
+0001fd00: 4550 524f 4d20 6275 6666 6572 733a 2025  EPROM buffers: %
+0001fd10: 7322 2c20 7365 6c66 2e65 6570 726f 6d5f  s", self.eeprom_
+0001fd20: 6261 636b 7570 2e62 7566 6665 7273 290d  backup.buffers).
+0001fd30: 0a0d 0a20 2020 2020 2020 2074 7279 3a0d  ...        try:.
+0001fd40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001fd50: 662e 7365 7474 696e 6773 2e65 6570 726f  f.settings.eepro
+0001fd60: 6d2e 6765 6e65 7261 7465 5f77 7269 7465  m.generate_write
+0001fd70: 5f62 7566 6665 7273 2829 0d0a 2020 2020  _buffers()..    
+0001fd80: 2020 2020 6578 6365 7074 3a0d 0a20 2020      except:..   
+0001fd90: 2020 2020 2020 2020 206c 6f67 2e63 7269           log.cri
+0001fda0: 7469 6361 6c28 2266 6169 6c65 6420 746f  tical("failed to
+0001fdb0: 2072 656e 6465 7220 4545 5052 4f4d 2077   render EEPROM w
+0001fdc0: 7269 7465 2062 7566 6665 7273 222c 2065  rite buffers", e
+0001fdd0: 7863 5f69 6e66 6f3d 3129 0d0a 2020 2020  xc_info=1)..    
+0001fde0: 2020 2020 2020 2020 7365 6c66 2e71 7565          self.que
+0001fdf0: 7565 5f6d 6573 7361 6765 2822 6d61 7271  ue_message("marq
+0001fe00: 7565 655f 6572 726f 7222 2c20 2246 6169  uee_error", "Fai
+0001fe10: 6c65 6420 746f 2077 7269 7465 2045 4550  led to write EEP
+0001fe20: 524f 4d22 290d 0a20 2020 2020 2020 2020  ROM")..         
+0001fe30: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+0001fe40: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+0001fe50: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
+0001fe60: 6d73 673d 2266 6169 6c65 6420 746f 2067  msg="failed to g
+0001fe70: 656e 6572 6174 6520 6565 7072 6f6d 2229  enerate eeprom")
+0001fe80: 0d0a 0d0a 2020 2020 2020 2020 6c6f 672e  ....        log.
+0001fe90: 6465 6275 6728 2257 6f75 6c64 2077 7269  debug("Would wri
+0001fea0: 7465 206e 6577 2062 7566 6665 7273 3a20  te new buffers: 
+0001feb0: 2573 222c 2073 656c 662e 7365 7474 696e  %s", self.settin
+0001fec0: 6773 2e65 6570 726f 6d2e 7772 6974 655f  gs.eeprom.write_
+0001fed0: 6275 6666 6572 7329 0d0a 0d0a 2020 2020  buffers)....    
+0001fee0: 2020 2020 666f 7220 7061 6765 2069 6e20      for page in 
+0001fef0: 7261 6e67 6528 4545 5052 4f4d 2e4d 4158  range(EEPROM.MAX
+0001ff00: 5f50 4147 4553 293a 0d0a 2020 2020 2020  _PAGES):..      
+0001ff10: 2020 2020 2020 6966 2073 656c 662e 7365        if self.se
+0001ff20: 7474 696e 6773 2e69 735f 6172 6d28 293a  ttings.is_arm():
+0001ff30: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001ff40: 2020 6c6f 672e 6465 6275 6728 2277 7269    log.debug("wri
+0001ff50: 7469 6e67 2070 6167 6520 2564 3a20 2573  ting page %d: %s
+0001ff60: 222c 2070 6167 652c 2073 656c 662e 7365  ", page, self.se
+0001ff70: 7474 696e 6773 2e65 6570 726f 6d2e 7772  ttings.eeprom.wr
+0001ff80: 6974 655f 6275 6666 6572 735b 7061 6765  ite_buffers[page
+0001ff90: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
+0001ffa0: 2020 2020 7365 6c66 2e5f 7365 6e64 5f63      self._send_c
+0001ffb0: 6f64 6528 6252 6571 7565 7374 2020 2020  ode(bRequest    
+0001ffc0: 2020 2020 3d20 3078 6666 2c20 2320 7365      = 0xff, # se
+0001ffd0: 636f 6e64 2d74 6965 720d 0a20 2020 2020  cond-tier..     
+0001ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fff0: 2020 2020 2020 2020 2020 7756 616c 7565            wValue
+00020000: 2020 2020 2020 2020 2020 3d20 3078 3032            = 0x02
+00020010: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00020020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020030: 2020 7749 6e64 6578 2020 2020 2020 2020    wIndex        
+00020040: 2020 3d20 7061 6765 2c0d 0a20 2020 2020    = page,..     
+00020050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020060: 2020 2020 2020 2020 2020 6461 7461 5f6f            data_o
+00020070: 725f 774c 656e 6774 6820 3d20 7365 6c66  r_wLength = self
+00020080: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+00020090: 2e77 7269 7465 5f62 7566 6665 7273 5b70  .write_buffers[p
+000200a0: 6167 655d 2c0d 0a20 2020 2020 2020 2020  age],..         
+000200b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000200c0: 2020 2020 2020 6c61 6265 6c20 2020 2020        label     
+000200d0: 2020 2020 2020 3d20 2257 5249 5445 5f45        = "WRITE_E
+000200e0: 4550 524f 4d22 290d 0a20 2020 2020 2020  EPROM")..       
+000200f0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00020100: 2020 2020 2020 2020 2020 2020 4441 5441              DATA
+00020110: 5f53 5441 5254 203d 2030 7833 6330 300d  _START = 0x3c00.
+00020120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020130: 206f 6666 7365 7420 3d20 4441 5441 5f53   offset = DATA_S
+00020140: 5441 5254 202b 2070 6167 6520 2a20 3634  TART + page * 64
+00020150: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00020160: 2020 6c6f 672e 6465 6275 6728 2277 7269    log.debug("wri
+00020170: 7469 6e67 2070 6167 6520 2564 2061 7420  ting page %d at 
+00020180: 6f66 6673 6574 2030 7825 3034 783a 2025  offset 0x%04x: %
+00020190: 7322 2c20 7061 6765 2c20 6f66 6673 6574  s", page, offset
+000201a0: 2c20 7365 6c66 2e73 6574 7469 6e67 732e  , self.settings.
+000201b0: 6565 7072 6f6d 2e77 7269 7465 5f62 7566  eeprom.write_buf
+000201c0: 6665 7273 5b70 6167 655d 290d 0a20 2020  fers[page])..   
+000201d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000201e0: 662e 5f73 656e 645f 636f 6465 2862 5265  f._send_code(bRe
+000201f0: 7175 6573 7420 2020 2020 2020 203d 2030  quest        = 0
+00020200: 7861 322c 2020 2023 2064 616e 6765 726f  xa2,   # dangero
+00020210: 7573 0d0a 2020 2020 2020 2020 2020 2020  us..            
+00020220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020230: 2020 2077 5661 6c75 6520 2020 2020 2020     wValue       
+00020240: 2020 203d 206f 6666 7365 742c 2023 2061     = offset, # a
+00020250: 7267 7561 626c 7920 616e 2069 6e64 6578  rguably an index
+00020260: 2062 7574 2068 6579 0d0a 2020 2020 2020   but hey..      
+00020270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020280: 2020 2020 2020 2020 2077 496e 6465 7820           wIndex 
+00020290: 2020 2020 2020 2020 203d 2030 2c0d 0a20           = 0,.. 
+000202a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202b0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+000202c0: 7461 5f6f 725f 774c 656e 6774 6820 3d20  ta_or_wLength = 
+000202d0: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
+000202e0: 7072 6f6d 2e77 7269 7465 5f62 7566 6665  prom.write_buffe
+000202f0: 7273 5b70 6167 655d 2c0d 0a20 2020 2020  rs[page],..     
+00020300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020310: 2020 2020 2020 2020 2020 6c61 6265 6c20            label 
+00020320: 2020 2020 2020 2020 2020 3d20 2257 5249            = "WRI
+00020330: 5445 5f45 4550 524f 4d22 290d 0a0d 0a20  TE_EEPROM").... 
+00020340: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
+00020350: 655f 6d65 7373 6167 6528 226d 6172 7175  e_message("marqu
+00020360: 6565 5f69 6e66 6f22 2c20 2245 4550 524f  ee_info", "EEPRO
+00020370: 4d20 7375 6363 6573 7366 756c 6c79 2075  M successfully u
+00020380: 7064 6174 6564 2229 0d0a 0d0a 2020 2020  pdated")....    
+00020390: 2020 2020 2320 616e 7920 7661 6c75 6520      # any value 
+000203a0: 696e 2064 6f69 6e67 2074 6869 733f 0d0a  in doing this?..
+000203b0: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
+000203c0: 7469 6e67 732e 6565 7072 6f6d 2e62 7566  tings.eeprom.buf
+000203d0: 6665 7273 203d 2073 656c 662e 7365 7474  fers = self.sett
+000203e0: 696e 6773 2e65 6570 726f 6d2e 7772 6974  ings.eeprom.writ
+000203f0: 655f 6275 6666 6572 730d 0a0d 0a20 2020  e_buffers....   
+00020400: 2020 2020 2072 6574 7572 6e20 5370 6563       return Spec
+00020410: 7472 6f6d 6574 6572 5265 7370 6f6e 7365  trometerResponse
+00020420: 2864 6174 613d 5472 7565 290d 0a0d 0a20  (data=True).... 
+00020430: 2020 2023 2023 2323 2323 2323 2323 2323     # ###########
+00020440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020470: 2323 2323 2323 2323 2323 2323 2323 230d  ###############.
+00020480: 0a20 2020 2023 2049 6e74 6572 7072 6f63  .    # Interproc
+00020490: 6573 7320 436f 6d6d 756e 6963 6174 696f  ess Communicatio
+000204a0: 6e73 0d0a 2020 2020 2320 2323 2323 2323  ns..    # ######
+000204b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000204c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000204d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000204e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000204f0: 2323 2323 0d0a 0d0a 2020 2020 2320 4074  ####....    # @t
+00020500: 6f64 6f20 6d6f 7665 2073 7472 696e 672d  odo move string-
+00020510: 746f 2d65 6e75 6d20 636f 6e76 6572 7465  to-enum converte
+00020520: 7220 746f 2041 7070 4c6f 670d 0a20 2020  r to AppLog..   
+00020530: 2064 6566 2073 6574 5f6c 6f67 5f6c 6576   def set_log_lev
+00020540: 656c 2873 656c 662c 2073 3a20 7374 7229  el(self, s: str)
+00020550: 3a20 2320 2d3e 2053 7065 6374 726f 6d65  : # -> Spectrome
+00020560: 7465 7252 6573 706f 6e73 6520 0d0a 2020  terResponse ..  
+00020570: 2020 2020 2020 6c76 6c20 3d20 6c6f 6767        lvl = logg
+00020580: 696e 672e 4445 4255 4720 6966 2073 203d  ing.DEBUG if s =
+00020590: 3d20 2244 4542 5547 2220 656c 7365 206c  = "DEBUG" else l
+000205a0: 6f67 6769 6e67 2e49 4e46 4f0d 0a20 2020  ogging.INFO..   
+000205b0: 2020 2020 206c 6f67 2e64 6562 7567 2822       log.debug("
+000205c0: 6669 642e 7365 745f 6c6f 675f 6c65 7665  fid.set_log_leve
+000205d0: 6c3a 2073 6574 7469 6e67 2074 6f20 2573  l: setting to %s
+000205e0: 222c 206c 766c 290d 0a20 2020 2020 2020  ", lvl)..       
+000205f0: 206c 6f67 6769 6e67 2e67 6574 4c6f 6767   logging.getLogg
+00020600: 6572 2829 2e73 6574 4c65 7665 6c28 6c76  er().setLevel(lv
+00020610: 6c29 0d0a 2020 2020 2020 2020 7265 7475  l)..        retu
+00020620: 726e 2053 7065 6374 726f 6d65 7465 7252  rn SpectrometerR
+00020630: 6573 706f 6e73 6528 290d 0a0d 0a20 2020  esponse()....   
+00020640: 2064 6566 2071 7565 7565 5f6d 6573 7361   def queue_messa
+00020650: 6765 2873 656c 662c 2073 6574 7469 6e67  ge(self, setting
+00020660: 2c20 7661 6c75 6529 3a20 2320 2d3e 2053  , value): # -> S
+00020670: 7065 6374 726f 6d65 7465 7252 6573 706f  pectrometerRespo
+00020680: 6e73 6520 0d0a 2020 2020 2020 2020 2222  nse ..        ""
+00020690: 220d 0a20 2020 2020 2020 2049 6620 616e  "..        If an
+000206a0: 2075 7073 7472 6561 6d20 7175 6575 6520   upstream queue 
+000206b0: 6973 2064 6566 696e 6564 2c20 7365 6e64  is defined, send
+000206c0: 2074 6865 206e 616d 652d 7661 6c75 6520   the name-value 
+000206d0: 7061 6972 2e20 2044 6f65 7320 6e6f 7468  pair.  Does noth
+000206e0: 696e 670d 0a20 2020 2020 2020 2069 6620  ing..        if 
+000206f0: 7468 6520 6361 6c6c 6572 2068 6173 6e27  the caller hasn'
+00020700: 7420 7072 6f76 6964 6564 2061 2071 7565  t provided a que
+00020710: 7565 2e0d 0a20 2020 2020 2020 2022 2222  ue...        """
+00020720: 0d0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00020730: 662e 6d65 7373 6167 655f 7175 6575 6520  f.message_queue 
+00020740: 6973 204e 6f6e 653a 0d0a 2020 2020 2020  is None:..      
+00020750: 2020 2020 2020 7265 7475 726e 2053 7065        return Spe
+00020760: 6374 726f 6d65 7465 7252 6573 706f 6e73  ctrometerRespons
+00020770: 6528 6461 7461 3d46 616c 7365 290d 0a0d  e(data=False)...
+00020780: 0a20 2020 2020 2020 206d 7367 203d 2053  .        msg = S
+00020790: 7461 7475 734d 6573 7361 6765 2873 6574  tatusMessage(set
+000207a0: 7469 6e67 2c20 7661 6c75 6529 0d0a 2020  ting, value)..  
+000207b0: 2020 2020 2020 7472 793a 0d0a 2020 2020        try:..    
+000207c0: 2020 2020 2020 2020 7365 6c66 2e6d 6573          self.mes
+000207d0: 7361 6765 5f71 7565 7565 2e70 7574 286d  sage_queue.put(m
+000207e0: 7367 2920 2320 7075 745f 6e6f 7761 6974  sg) # put_nowait
+000207f0: 286d 7367 290d 0a20 2020 2020 2020 2065  (msg)..        e
+00020800: 7863 6570 743a 0d0a 2020 2020 2020 2020  xcept:..        
+00020810: 2020 2020 6c6f 672e 6572 726f 7228 2266      log.error("f
+00020820: 6169 6c65 6420 746f 2065 6e71 7565 7565  ailed to enqueue
+00020830: 2053 7461 7475 734d 6573 7361 6765 2028   StatusMessage (
+00020840: 2573 2c20 2573 2922 2c20 7365 7474 696e  %s, %s)", settin
+00020850: 672c 2076 616c 7565 2c20 6578 635f 696e  g, value, exc_in
+00020860: 666f 3d31 290d 0a20 2020 2020 2020 2020  fo=1)..         
+00020870: 2020 2072 6574 7572 6e20 5370 6563 7472     return Spectr
+00020880: 6f6d 6574 6572 5265 7370 6f6e 7365 2864  ometerResponse(d
+00020890: 6174 613d 4661 6c73 652c 6572 726f 725f  ata=False,error_
+000208a0: 6d73 673d 2266 6169 6c65 6420 746f 2065  msg="failed to e
+000208b0: 6e71 7565 7565 206d 6573 7373 6167 6522  nqueue messsage"
+000208c0: 290d 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+000208d0: 6e20 5370 6563 7472 6f6d 6574 6572 5265  n SpectrometerRe
+000208e0: 7370 6f6e 7365 2864 6174 613d 5472 7565  sponse(data=True
+000208f0: 290d 0a0d 0a20 2020 2064 6566 205f 696e  )....    def _in
+00020900: 6974 5f70 726f 6365 7373 5f66 756e 6373  it_process_funcs
+00020910: 2873 656c 6629 3a20 2320 2d3e 2064 6963  (self): # -> dic
+00020920: 745b 7374 722c 2043 616c 6c61 626c 655b  t[str, Callable[
+00020930: 2e2e 2e2c 2041 6e79 5d5d 200d 0a20 2020  ..., Any]] ..   
+00020940: 2020 2020 2022 2222 0d0a 2020 2020 2020       """..      
+00020950: 2020 4973 2069 7420 7468 6520 6578 7065    Is it the expe
+00020960: 6374 6174 696f 6e20 7468 6174 2061 6c6c  ctation that all
+00020970: 206f 6620 7468 6573 6520 6675 6e63 7469   of these functi
+00020980: 6f6e 7320 7769 6c6c 2072 6574 7572 6e20  ons will return 
+00020990: 0d0a 2020 2020 2020 2020 5370 6563 7472  ..        Spectr
+000209a0: 6f6d 6574 6572 5265 7370 6f6e 7365 3f20  ometerResponse? 
+000209b0: 4966 2073 6f2c 2074 6861 7420 7368 6f75  If so, that shou
+000209c0: 6c64 2062 6520 6d61 6465 2065 7870 6c69  ld be made expli
+000209d0: 6369 742e 0d0a 2020 2020 2020 2020 2222  cit...        ""
+000209e0: 220d 0a20 2020 2020 2020 2070 726f 6365  "..        proce
+000209f0: 7373 5f66 203d 207b 7d0d 0a0d 0a20 2020  ss_f = {}....   
+00020a00: 2020 2020 2066 6f72 2066 6f6f 2069 6e20       for foo in 
+00020a10: 5b20 2263 6f6e 6e65 6374 222c 0d0a 2020  [ "connect",..  
+00020a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a30: 2020 2022 6469 7363 6f6e 6e65 6374 222c     "disconnect",
+00020a40: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00020a50: 2020 2020 2020 2022 6765 745f 6261 7474         "get_batt
+00020a60: 6572 795f 7265 6769 7374 6572 222c 0d0a  ery_register",..
+00020a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a80: 2020 2020 2022 6765 745f 6261 7474 6572       "get_batter
+00020a90: 795f 7374 6174 655f 7261 7722 2c0d 0a20  y_state_raw",.. 
+00020aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ab0: 2020 2020 2267 6574 5f62 6174 7465 7279      "get_battery
+00020ac0: 5f70 6572 6365 6e74 6167 6522 2c0d 0a20  _percentage",.. 
+00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ae0: 2020 2020 2267 6574 5f62 6174 7465 7279      "get_battery
+00020af0: 5f63 6861 7267 696e 6722 2c0d 0a20 2020  _charging",..   
+00020b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b10: 2020 2267 6574 5f69 6e74 6567 7261 7469    "get_integrati
+00020b20: 6f6e 5f74 696d 655f 6d73 222c 0d0a 2020  on_time_ms",..  
+00020b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b40: 2020 2022 7365 745f 6466 755f 656e 6162     "set_dfu_enab
+00020b50: 6c65 222c 0d0a 2020 2020 2020 2020 2020  le",..          
+00020b60: 2020 2020 2020 2020 2020 2022 7365 745f             "set_
+00020b70: 6465 7465 6374 6f72 5f6f 6666 7365 7422  detector_offset"
+00020b80: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00020b90: 2020 2020 2020 2020 2273 6574 5f64 6574          "set_det
+00020ba0: 6563 746f 725f 6f66 6673 6574 5f6f 6464  ector_offset_odd
+00020bb0: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00020bc0: 2020 2020 2020 2020 2022 6765 745f 6465           "get_de
+00020bd0: 7465 6374 6f72 5f67 6169 6e22 2c0d 0a20  tector_gain",.. 
+00020be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020bf0: 2020 2020 2267 6574 5f64 6574 6563 746f      "get_detecto
+00020c00: 725f 6761 696e 5f6f 6464 222c 0d0a 2020  r_gain_odd",..  
 00020c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c20: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
-00020c30: 2e73 6574 5f6c 6173 6572 5f70 6f77 6572  .set_laser_power
-00020c40: 5f6d 5728 7829 0a20 2020 2020 2020 2070  _mW(x).        p
-00020c50: 726f 6365 7373 5f66 5b22 6c61 7365 725f  rocess_f["laser_
-00020c60: 7465 6d70 6572 6174 7572 655f 7365 7470  temperature_setp
-00020c70: 6f69 6e74 5f72 6177 225d 2020 2020 203d  oint_raw"]     =
-00020c80: 206c 616d 6264 6120 783a 2073 656c 662e   lambda x: self.
-00020c90: 7365 745f 6c61 7365 725f 7465 6d70 6572  set_laser_temper
-00020ca0: 6174 7572 655f 7365 7470 6f69 6e74 5f72  ature_setpoint_r
-00020cb0: 6177 2869 6e74 2872 6f75 6e64 2878 2929  aw(int(round(x))
-00020cc0: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
-00020cd0: 735f 665b 226c 6173 6572 5f70 6f77 6572  s_f["laser_power
-00020ce0: 5f72 616d 7069 6e67 5f65 6e61 626c 6522  _ramping_enable"
-00020cf0: 5d20 2020 2020 2020 2020 3d20 6c61 6d62  ]         = lamb
-00020d00: 6461 2078 3a20 7365 6c66 2e73 6574 5f6c  da x: self.set_l
-00020d10: 6173 6572 5f70 6f77 6572 5f72 616d 7069  aser_power_rampi
-00020d20: 6e67 5f65 6e61 626c 6528 626f 6f6c 2878  ng_enable(bool(x
-00020d30: 2929 0a20 2020 2020 2020 2070 726f 6365  )).        proce
-00020d40: 7373 5f66 5b22 6c61 7365 725f 706f 7765  ss_f["laser_powe
-00020d50: 725f 6869 6768 5f72 6573 6f6c 7574 696f  r_high_resolutio
-00020d60: 6e22 5d20 2020 2020 2020 203d 206c 616d  n"]        = lam
-00020d70: 6264 6120 783a 2073 656c 662e 7365 745f  bda x: self.set_
-00020d80: 6c61 7365 725f 706f 7765 725f 6869 6768  laser_power_high
-00020d90: 5f72 6573 6f6c 7574 696f 6e28 7829 0a20  _resolution(x). 
-00020da0: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
-00020db0: 5b22 6c61 7365 725f 706f 7765 725f 7265  ["laser_power_re
-00020dc0: 7175 6972 655f 6d6f 6475 6c61 7469 6f6e  quire_modulation
-00020dd0: 225d 2020 2020 203d 206c 616d 6264 6120  "]     = lambda 
-00020de0: 783a 2073 656c 662e 7365 745f 6c61 7365  x: self.set_lase
-00020df0: 725f 706f 7765 725f 7265 7175 6972 655f  r_power_require_
-00020e00: 6d6f 6475 6c61 7469 6f6e 2878 290a 2020  modulation(x).  
-00020e10: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
-00020e20: 2273 656c 6563 7465 645f 6c61 7365 7222  "selected_laser"
-00020e30: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
-00020e40: 2020 2020 2020 3d20 6c61 6d62 6461 2078        = lambda x
-00020e50: 3a20 7365 6c66 2e73 6574 5f73 656c 6563  : self.set_selec
-00020e60: 7465 645f 6c61 7365 7228 696e 7428 7829  ted_laser(int(x)
-00020e70: 290a 0a20 2020 2020 2020 2070 726f 6365  )..        proce
-00020e80: 7373 5f66 5b22 6869 6768 5f67 6169 6e5f  ss_f["high_gain_
-00020e90: 6d6f 6465 5f65 6e61 626c 6522 5d20 2020  mode_enable"]   
-00020ea0: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
-00020eb0: 6264 6120 783a 2073 656c 662e 7365 745f  bda x: self.set_
-00020ec0: 6869 6768 5f67 6169 6e5f 6d6f 6465 5f65  high_gain_mode_e
-00020ed0: 6e61 626c 6528 626f 6f6c 2878 2929 0a20  nable(bool(x)). 
-00020ee0: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
-00020ef0: 5b22 7472 6967 6765 725f 736f 7572 6365  ["trigger_source
-00020f00: 225d 2020 2020 2020 2020 2020 2020 2020  "]              
-00020f10: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
-00020f20: 783a 2073 656c 662e 7365 745f 7472 6967  x: self.set_trig
-00020f30: 6765 725f 736f 7572 6365 2869 6e74 2878  ger_source(int(x
-00020f40: 2929 0a20 2020 2020 2020 2070 726f 6365  )).        proce
-00020f50: 7373 5f66 5b22 656e 6162 6c65 5f73 6563  ss_f["enable_sec
-00020f60: 6f6e 6461 7279 5f61 6463 225d 2020 2020  ondary_adc"]    
-00020f70: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
-00020f80: 6264 6120 783a 2073 656c 662e 7365 7474  bda x: self.sett
-00020f90: 696e 6773 2e73 7461 7465 2e73 6574 2822  ings.state.set("
-00020fa0: 7365 636f 6e64 6172 795f 6164 635f 656e  secondary_adc_en
-00020fb0: 6162 6c65 6422 2c20 626f 6f6c 2878 2929  abled", bool(x))
-00020fc0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-00020fd0: 5f66 5b22 6172 6561 5f73 6361 6e5f 656e  _f["area_scan_en
-00020fe0: 6162 6c65 225d 2020 2020 2020 2020 2020  able"]          
-00020ff0: 2020 2020 2020 2020 203d 206c 616d 6264           = lambd
-00021000: 6120 783a 2073 656c 662e 7365 745f 6172  a x: self.set_ar
-00021010: 6561 5f73 6361 6e5f 656e 6162 6c65 2862  ea_scan_enable(b
-00021020: 6f6f 6c28 7829 290a 2020 2020 2020 2020  ool(x)).        
-00021030: 7072 6f63 6573 735f 665b 2261 7265 615f  process_f["area_
-00021040: 7363 616e 5f66 6173 7422 5d20 2020 2020  scan_fast"]     
-00021050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021060: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
-00021070: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
-00021080: 7365 7428 2261 7265 615f 7363 616e 5f66  set("area_scan_f
-00021090: 6173 7422 2c20 626f 6f6c 2878 2929 0a0a  ast", bool(x))..
-000210a0: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
-000210b0: 665b 2262 6164 5f70 6978 656c 5f6d 6f64  f["bad_pixel_mod
-000210c0: 6522 5d20 2020 2020 2020 2020 2020 2020  e"]             
-000210d0: 2020 2020 2020 2020 3d20 6c61 6d62 6461          = lambda
-000210e0: 2078 3a20 7365 6c66 2e73 6574 7469 6e67   x: self.setting
-000210f0: 732e 7374 6174 652e 7365 7428 2262 6164  s.state.set("bad
-00021100: 5f70 6978 656c 5f6d 6f64 6522 2c20 696e  _pixel_mode", in
-00021110: 7428 7829 290a 2020 2020 2020 2020 7072  t(x)).        pr
-00021120: 6f63 6573 735f 665b 226d 696e 5f75 7362  ocess_f["min_usb
-00021130: 5f69 6e74 6572 7661 6c5f 6d73 225d 2020  _interval_ms"]  
-00021140: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
-00021150: 6c61 6d62 6461 2078 3a20 7365 6c66 2e73  lambda x: self.s
-00021160: 6574 7469 6e67 732e 7374 6174 652e 7365  ettings.state.se
-00021170: 7428 226d 696e 5f75 7362 5f69 6e74 6572  t("min_usb_inter
-00021180: 7661 6c5f 6d73 222c 2069 6e74 2872 6f75  val_ms", int(rou
-00021190: 6e64 2878 2929 290a 2020 2020 2020 2020  nd(x))).        
-000211a0: 7072 6f63 6573 735f 665b 226d 6178 5f75  process_f["max_u
-000211b0: 7362 5f69 6e74 6572 7661 6c5f 6d73 225d  sb_interval_ms"]
-000211c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000211d0: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
-000211e0: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
-000211f0: 7365 7428 226d 6178 5f75 7362 5f69 6e74  set("max_usb_int
-00021200: 6572 7661 6c5f 6d73 222c 2069 6e74 2872  erval_ms", int(r
-00021210: 6f75 6e64 2878 2929 290a 0a20 2020 2020  ound(x)))..     
-00021220: 2020 2070 726f 6365 7373 5f66 5b22 6163     process_f["ac
-00021230: 6365 7373 6f72 795f 656e 6162 6c65 225d  cessory_enable"]
-00021240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021250: 2020 203d 206c 616d 6264 6120 783a 2073     = lambda x: s
-00021260: 656c 662e 7365 745f 6163 6365 7373 6f72  elf.set_accessor
-00021270: 795f 656e 6162 6c65 2862 6f6f 6c28 7829  y_enable(bool(x)
-00021280: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
-00021290: 735f 665b 2266 616e 5f65 6e61 626c 6522  s_f["fan_enable"
-000212a0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
-000212b0: 2020 2020 2020 2020 2020 3d20 6c61 6d62            = lamb
-000212c0: 6461 2078 3a20 7365 6c66 2e73 6574 5f66  da x: self.set_f
-000212d0: 616e 5f65 6e61 626c 6528 626f 6f6c 2878  an_enable(bool(x
-000212e0: 2929 0a20 2020 2020 2020 2070 726f 6365  )).        proce
-000212f0: 7373 5f66 5b22 6c61 6d70 5f65 6e61 626c  ss_f["lamp_enabl
-00021300: 6522 5d20 2020 2020 2020 2020 2020 2020  e"]             
-00021310: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
-00021320: 6264 6120 783a 2073 656c 662e 7365 745f  bda x: self.set_
-00021330: 6c61 6d70 5f65 6e61 626c 6528 626f 6f6c  lamp_enable(bool
-00021340: 2878 2929 0a20 2020 2020 2020 2070 726f  (x)).        pro
-00021350: 6365 7373 5f66 5b22 7368 7574 7465 725f  cess_f["shutter_
-00021360: 656e 6162 6c65 225d 2020 2020 2020 2020  enable"]        
-00021370: 2020 2020 2020 2020 2020 2020 203d 206c               = l
-00021380: 616d 6264 6120 783a 2073 656c 662e 7365  ambda x: self.se
-00021390: 745f 7368 7574 7465 725f 656e 6162 6c65  t_shutter_enable
-000213a0: 2862 6f6f 6c28 7829 290a 2020 2020 2020  (bool(x)).      
-000213b0: 2020 7072 6f63 6573 735f 665b 2273 7472    process_f["str
-000213c0: 6f62 655f 656e 6162 6c65 225d 2020 2020  obe_enable"]    
-000213d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000213e0: 2020 3d20 6c61 6d62 6461 2078 3a20 7365    = lambda x: se
-000213f0: 6c66 2e73 6574 5f73 7472 6f62 655f 656e  lf.set_strobe_en
-00021400: 6162 6c65 2862 6f6f 6c28 7829 290a 2020  able(bool(x)).  
-00021410: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
-00021420: 226d 6f64 5f65 6e61 626c 6522 5d20 2020  "mod_enable"]   
-00021430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021440: 2020 2020 2020 3d20 6c61 6d62 6461 2078        = lambda x
-00021450: 3a20 7365 6c66 2e73 6574 5f6d 6f64 5f65  : self.set_mod_e
-00021460: 6e61 626c 6528 626f 6f6c 2878 2929 0a20  nable(bool(x)). 
-00021470: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
-00021480: 5b22 6d6f 645f 7065 7269 6f64 5f75 7322  ["mod_period_us"
-00021490: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
-000214a0: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
-000214b0: 783a 2073 656c 662e 7365 745f 6d6f 645f  x: self.set_mod_
-000214c0: 7065 7269 6f64 5f75 7328 696e 7428 726f  period_us(int(ro
-000214d0: 756e 6428 7829 2929 0a20 2020 2020 2020  und(x))).       
-000214e0: 2070 726f 6365 7373 5f66 5b22 6d6f 645f   process_f["mod_
-000214f0: 7769 6474 685f 7573 225d 2020 2020 2020  width_us"]      
-00021500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021510: 203d 206c 616d 6264 6120 783a 2073 656c   = lambda x: sel
-00021520: 662e 7365 745f 6d6f 645f 7769 6474 685f  f.set_mod_width_
-00021530: 7573 2869 6e74 2872 6f75 6e64 2878 2929  us(int(round(x))
-00021540: 290a 0a20 2020 2020 2020 2023 2042 6174  )..        # Bat
-00021550: 6368 436f 6c6c 6563 7469 6f6e 0a20 2020  chCollection.   
-00021560: 2020 2020 2070 726f 6365 7373 5f66 5b22       process_f["
-00021570: 6672 6565 5f72 756e 6e69 6e67 5f6d 6f64  free_running_mod
-00021580: 6522 5d20 2020 2020 2020 2020 2020 2020  e"]             
-00021590: 2020 2020 203d 206c 616d 6264 6120 783a       = lambda x:
-000215a0: 2073 656c 662e 7365 7474 696e 6773 2e73   self.settings.s
-000215b0: 7461 7465 2e73 6574 2822 6672 6565 5f72  tate.set("free_r
-000215c0: 756e 6e69 6e67 5f6d 6f64 6522 2c20 626f  unning_mode", bo
-000215d0: 6f6c 2878 2929 0a20 2020 2020 2020 2070  ol(x)).        p
-000215e0: 726f 6365 7373 5f66 5b22 6163 7175 6973  rocess_f["acquis
-000215f0: 6974 696f 6e5f 6c61 7365 725f 7472 6967  ition_laser_trig
-00021600: 6765 725f 656e 6162 6c65 225d 2020 203d  ger_enable"]   =
-00021610: 206c 616d 6264 6120 783a 2073 656c 662e   lambda x: self.
-00021620: 7365 7474 696e 6773 2e73 7461 7465 2e73  settings.state.s
-00021630: 6574 2822 6163 7175 6973 6974 696f 6e5f  et("acquisition_
-00021640: 6c61 7365 725f 7472 6967 6765 725f 656e  laser_trigger_en
-00021650: 6162 6c65 222c 2062 6f6f 6c28 7829 290a  able", bool(x)).
-00021660: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
-00021670: 665b 2261 6371 7569 7369 7469 6f6e 5f6c  f["acquisition_l
-00021680: 6173 6572 5f74 7269 6767 6572 5f64 656c  aser_trigger_del
-00021690: 6179 5f6d 7322 5d20 3d20 6c61 6d62 6461  ay_ms"] = lambda
-000216a0: 2078 3a20 7365 6c66 2e73 6574 7469 6e67   x: self.setting
-000216b0: 732e 7374 6174 652e 7365 7428 2261 6371  s.state.set("acq
-000216c0: 7569 7369 7469 6f6e 5f6c 6173 6572 5f74  uisition_laser_t
-000216d0: 7269 6767 6572 5f64 656c 6179 5f6d 7322  rigger_delay_ms"
-000216e0: 2c20 696e 7428 726f 756e 6428 7829 2929  , int(round(x)))
-000216f0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-00021700: 5f66 5b22 6163 7175 6973 6974 696f 6e5f  _f["acquisition_
-00021710: 7461 6b65 5f64 6172 6b5f 656e 6162 6c65  take_dark_enable
-00021720: 225d 2020 2020 2020 203d 206c 616d 6264  "]       = lambd
-00021730: 6120 783a 2073 656c 662e 7365 7474 696e  a x: self.settin
-00021740: 6773 2e73 7461 7465 2e73 6574 2822 6163  gs.state.set("ac
-00021750: 7175 6973 6974 696f 6e5f 7461 6b65 5f64  quisition_take_d
-00021760: 6172 6b5f 656e 6162 6c65 222c 2062 6f6f  ark_enable", boo
-00021770: 6c28 7829 290a 0a20 2020 2020 2020 2023  l(x))..        #
-00021780: 2053 6572 6965 732d 5853 0a20 2020 2020   Series-XS.     
-00021790: 2020 2366 5b22 7261 6d61 6e5f 6d6f 6465    #f["raman_mode
-000217a0: 5f65 6e61 626c 6522 5d20 2020 2020 2020  _enable"]       
-000217b0: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
-000217c0: 6264 6120 783a 2073 656c 662e 7365 745f  bda x: self.set_
-000217d0: 7261 6d61 6e5f 6d6f 6465 5f65 6e61 626c  raman_mode_enabl
-000217e0: 6528 626f 6f6c 2878 2929 0a20 2020 2020  e(bool(x)).     
-000217f0: 2020 2070 726f 6365 7373 5f66 5b22 7261     process_f["ra
-00021800: 6d61 6e5f 6465 6c61 795f 6d73 225d 2020  man_delay_ms"]  
-00021810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021820: 2020 203d 206c 616d 6264 6120 783a 2073     = lambda x: s
-00021830: 656c 662e 7365 745f 7261 6d61 6e5f 6465  elf.set_raman_de
-00021840: 6c61 795f 6d73 2869 6e74 2872 6f75 6e64  lay_ms(int(round
-00021850: 2878 2929 290a 2020 2020 2020 2020 7072  (x))).        pr
-00021860: 6f63 6573 735f 665b 226c 6173 6572 5f77  ocess_f["laser_w
-00021870: 6174 6368 646f 675f 7365 6322 5d20 2020  atchdog_sec"]   
-00021880: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
-00021890: 6c61 6d62 6461 2078 3a20 7365 6c66 2e73  lambda x: self.s
-000218a0: 6574 5f6c 6173 6572 5f77 6174 6368 646f  et_laser_watchdo
-000218b0: 675f 7365 6328 696e 7428 726f 756e 6428  g_sec(int(round(
-000218c0: 7829 2929 0a0a 2020 2020 2020 2020 2320  x)))..        # 
-000218d0: 7265 6769 6f6e 730a 2020 2020 2020 2020  regions.        
-000218e0: 7072 6f63 6573 735f 665b 2276 6572 7469  process_f["verti
-000218f0: 6361 6c5f 6269 6e6e 696e 6722 5d20 2020  cal_binning"]   
-00021900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021910: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
-00021920: 2e73 6574 5f76 6572 7469 6361 6c5f 6269  .set_vertical_bi
-00021930: 6e6e 696e 6728 7829 0a20 2020 2020 2020  nning(x).       
-00021940: 2070 726f 6365 7373 5f66 5b22 7369 6e67   process_f["sing
-00021950: 6c65 5f72 6567 696f 6e22 5d20 2020 2020  le_region"]     
+00020c20: 2020 2022 7365 745f 6465 7465 6374 6f72     "set_detector
+00020c30: 5f67 6169 6e22 2c0d 0a20 2020 2020 2020  _gain",..       
+00020c40: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00020c50: 6574 5f64 6574 6563 746f 725f 6761 696e  et_detector_gain
+00020c60: 5f6f 6464 222c 0d0a 2020 2020 2020 2020  _odd",..        
+00020c70: 2020 2020 2020 2020 2020 2020 2022 7365               "se
+00020c80: 745f 6172 6561 5f73 6361 6e5f 656e 6162  t_area_scan_enab
+00020c90: 6c65 222c 0d0a 2020 2020 2020 2020 2020  le",..          
+00020ca0: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
+00020cb0: 7365 6e73 6f72 5f6c 696e 655f 6c65 6e67  sensor_line_leng
+00020cc0: 7468 222c 0d0a 2020 2020 2020 2020 2020  th",..          
+00020cd0: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
+00020ce0: 6d69 6372 6f63 6f6e 7472 6f6c 6c65 725f  microcontroller_
+00020cf0: 6669 726d 7761 7265 5f76 6572 7369 6f6e  firmware_version
+00020d00: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00020d10: 2020 2020 2020 2020 2022 6765 745f 6670           "get_fp
+00020d20: 6761 5f66 6972 6d77 6172 655f 7665 7273  ga_firmware_vers
+00020d30: 696f 6e22 2c0d 0a20 2020 2020 2020 2020  ion",..         
+00020d40: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00020d50: 5f6c 696e 6522 2c0d 0a20 2020 2020 2020  _line",..       
+00020d60: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00020d70: 6574 5f69 6e74 6567 7261 7469 6f6e 5f74  et_integration_t
+00020d80: 696d 655f 6d73 222c 0d0a 2020 2020 2020  ime_ms",..      
+00020d90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00020da0: 7365 6c65 6374 5f61 6463 222c 0d0a 2020  select_adc",..  
+00020db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020dc0: 2020 2022 6765 745f 7365 636f 6e64 6172     "get_secondar
+00020dd0: 795f 6164 635f 6361 6c69 6272 6174 6564  y_adc_calibrated
+00020de0: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00020df0: 2020 2020 2020 2020 2022 6765 745f 7365           "get_se
+00020e00: 636f 6e64 6172 795f 6164 635f 7261 7722  condary_adc_raw"
+00020e10: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00020e20: 2020 2020 2020 2020 2267 6574 5f6c 6173          "get_las
+00020e30: 6572 5f74 656d 7065 7261 7475 7265 5f72  er_temperature_r
+00020e40: 6177 222c 0d0a 2020 2020 2020 2020 2020  aw",..          
+00020e50: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
+00020e60: 6c61 7365 725f 7465 6d70 6572 6174 7572  laser_temperatur
+00020e70: 655f 6465 6743 222c 0d0a 2020 2020 2020  e_degC",..      
+00020e80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00020e90: 6765 745f 6465 7465 6374 6f72 5f74 656d  get_detector_tem
+00020ea0: 7065 7261 7475 7265 5f72 6177 222c 0d0a  perature_raw",..
+00020eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ec0: 2020 2020 2022 6765 745f 6465 7465 6374       "get_detect
+00020ed0: 6f72 5f74 656d 7065 7261 7475 7265 5f64  or_temperature_d
+00020ee0: 6567 4322 2c0d 0a20 2020 2020 2020 2020  egC",..         
+00020ef0: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00020f00: 5f64 6574 6563 746f 725f 7465 635f 7365  _detector_tec_se
+00020f10: 7470 6f69 6e74 5f64 6567 4322 2c0d 0a20  tpoint_degC",.. 
+00020f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f30: 2020 2020 2267 6574 5f64 6163 222c 0d0a      "get_dac",..
+00020f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f50: 2020 2020 2022 7365 745f 7465 635f 656e       "set_tec_en
+00020f60: 6162 6c65 222c 0d0a 2020 2020 2020 2020  able",..        
+00020f70: 2020 2020 2020 2020 2020 2020 2022 7365               "se
+00020f80: 745f 7472 6967 6765 725f 736f 7572 6365  t_trigger_source
+00020f90: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00020fa0: 2020 2020 2020 2020 2022 7365 745f 6869           "set_hi
+00020fb0: 6768 5f67 6169 6e5f 6d6f 6465 5f65 6e61  gh_gain_mode_ena
+00020fc0: 626c 6522 2c0d 0a20 2020 2020 2020 2020  ble",..         
+00020fd0: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00020fe0: 5f68 6967 685f 6761 696e 5f6d 6f64 655f  _high_gain_mode_
+00020ff0: 656e 6162 6c65 6422 2c0d 0a20 2020 2020  enabled",..     
+00021000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021010: 2267 6574 5f6f 7074 5f6c 6173 6572 5f63  "get_opt_laser_c
+00021020: 6f6e 7472 6f6c 222c 0d0a 2020 2020 2020  ontrol",..      
+00021030: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00021040: 6765 745f 6f70 745f 6861 735f 6c61 7365  get_opt_has_lase
+00021050: 7222 2c0d 0a20 2020 2020 2020 2020 2020  r",..           
+00021060: 2020 2020 2020 2020 2020 2273 6574 5f64            "set_d
+00021070: 6574 6563 746f 725f 7465 635f 7365 7470  etector_tec_setp
+00021080: 6f69 6e74 5f64 6567 4322 2c0d 0a20 2020  oint_degC",..   
+00021090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000210a0: 2020 2267 6574 5f64 6574 6563 746f 725f    "get_detector_
+000210b0: 7465 635f 7365 7470 6f69 6e74 5f72 6177  tec_setpoint_raw
+000210c0: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+000210d0: 2020 2020 2020 2020 2022 7365 745f 7365           "set_se
+000210e0: 6c65 6374 6564 5f6c 6173 6572 222c 0d0a  lected_laser",..
+000210f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021100: 2020 2020 2022 6765 745f 7365 6c65 6374       "get_select
+00021110: 6564 5f6c 6173 6572 222c 0d0a 2020 2020  ed_laser",..    
+00021120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021130: 2022 6765 745f 6c61 7365 725f 656e 6162   "get_laser_enab
+00021140: 6c65 6422 2c0d 0a20 2020 2020 2020 2020  led",..         
+00021150: 2020 2020 2020 2020 2020 2020 2273 6574              "set
+00021160: 5f6c 6173 6572 5f65 6e61 626c 6522 2c0d  _laser_enable",.
+00021170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021180: 2020 2020 2020 2273 6574 5f6c 6173 6572        "set_laser
+00021190: 5f70 6f77 6572 5f72 616d 7069 6e67 5f65  _power_ramping_e
+000211a0: 6e61 626c 6522 2c0d 0a20 2020 2020 2020  nable",..       
+000211b0: 2020 2020 2020 2020 2020 2020 2020 2267                "g
+000211c0: 6574 5f6c 6173 6572 5f70 6f77 6572 5f72  et_laser_power_r
+000211d0: 616d 7069 6e67 5f65 6e61 626c 6564 222c  amping_enabled",
+000211e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000211f0: 2020 2020 2020 2022 7365 745f 6c61 7365         "set_lase
+00021200: 725f 706f 7765 725f 6d57 222c 0d0a 2020  r_power_mW",..  
+00021210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021220: 2020 2022 7365 745f 6c61 7365 725f 706f     "set_laser_po
+00021230: 7765 725f 6869 6768 5f72 6573 6f6c 7574  wer_high_resolut
+00021240: 696f 6e22 2c0d 0a20 2020 2020 2020 2020  ion",..         
+00021250: 2020 2020 2020 2020 2020 2020 2273 6574              "set
+00021260: 5f6c 6173 6572 5f70 6f77 6572 5f72 6571  _laser_power_req
+00021270: 7569 7265 5f6d 6f64 756c 6174 696f 6e22  uire_modulation"
+00021280: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00021290: 2020 2020 2020 2020 2273 6574 5f6c 6173          "set_las
+000212a0: 6572 5f70 6f77 6572 5f70 6572 6322 2c0d  er_power_perc",.
+000212b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000212c0: 2020 2020 2020 2273 6574 5f6c 6173 6572        "set_laser
+000212d0: 5f70 6f77 6572 5f70 6572 635f 696d 6d65  _power_perc_imme
+000212e0: 6469 6174 6522 2c0d 0a20 2020 2020 2020  diate",..       
+000212f0: 2020 2020 2020 2020 2020 2020 2020 2267                "g
+00021300: 6574 5f6c 6173 6572 5f74 656d 7065 7261  et_laser_tempera
+00021310: 7475 7265 5f73 6574 706f 696e 745f 7261  ture_setpoint_ra
+00021320: 7722 2c0d 0a20 2020 2020 2020 2020 2020  w",..           
+00021330: 2020 2020 2020 2020 2020 2273 6574 5f6c            "set_l
+00021340: 6173 6572 5f74 656d 7065 7261 7475 7265  aser_temperature
+00021350: 5f73 6574 706f 696e 745f 7261 7722 2c0d  _setpoint_raw",.
+00021360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021370: 2020 2020 2020 2275 7064 6174 655f 6c61        "update_la
+00021380: 7365 725f 7761 7463 6864 6f67 222c 0d0a  ser_watchdog",..
+00021390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213a0: 2020 2020 2022 6765 745f 6c61 7365 725f       "get_laser_
+000213b0: 696e 7465 726c 6f63 6b22 2c0d 0a20 2020  interlock",..   
+000213c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000213d0: 2020 2263 616e 5f6c 6173 6572 5f66 6972    "can_laser_fir
+000213e0: 6522 2c0d 0a20 2020 2020 2020 2020 2020  e",..           
+000213f0: 2020 2020 2020 2020 2020 2272 6573 6574            "reset
+00021400: 5f66 7067 6122 2c0d 0a20 2020 2020 2020  _fpga",..       
+00021410: 2020 2020 2020 2020 2020 2020 2020 2267                "g
+00021420: 6574 5f74 7269 6767 6572 5f73 6f75 7263  et_trigger_sourc
+00021430: 6522 2c0d 0a20 2020 2020 2020 2020 2020  e",..           
+00021440: 2020 2020 2020 2020 2020 2267 6574 5f72            "get_r
+00021450: 616d 616e 5f64 656c 6179 5f6d 7322 2c0d  aman_delay_ms",.
+00021460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021470: 2020 2020 2020 2273 6574 5f72 616d 616e        "set_raman
+00021480: 5f64 656c 6179 5f6d 7322 2c0d 0a20 2020  _delay_ms",..   
+00021490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214a0: 2020 2267 6574 5f6c 6173 6572 5f77 6174    "get_laser_wat
+000214b0: 6368 646f 675f 7365 6322 2c0d 0a20 2020  chdog_sec",..   
+000214c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214d0: 2020 2273 6574 5f6c 6173 6572 5f77 6174    "set_laser_wat
+000214e0: 6368 646f 675f 7365 6322 2c0d 0a20 2020  chdog_sec",..   
+000214f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021500: 2020 2273 6574 5f76 6572 7469 6361 6c5f    "set_vertical_
+00021510: 6269 6e6e 696e 6722 2c0d 0a20 2020 2020  binning",..     
+00021520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021530: 2273 6574 5f70 6978 656c 5f6d 6f64 6522  "set_pixel_mode"
+00021540: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00021550: 2020 2020 2020 2020 2263 6c65 6172 5f72          "clear_r
+00021560: 6567 696f 6e73 222c 0d0a 2020 2020 2020  egions",..      
+00021570: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00021580: 7365 745f 7369 6e67 6c65 5f72 6567 696f  set_single_regio
+00021590: 6e22 2c0d 0a20 2020 2020 2020 2020 2020  n",..           
+000215a0: 2020 2020 2020 2020 2020 2273 6574 5f64            "set_d
+000215b0: 6574 6563 746f 725f 726f 6922 2c0d 0a20  etector_roi",.. 
+000215c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215d0: 2020 2020 2267 6574 5f66 7067 615f 636f      "get_fpga_co
+000215e0: 6e66 6967 7572 6174 696f 6e5f 7265 6769  nfiguration_regi
+000215f0: 7374 6572 222c 0d0a 2020 2020 2020 2020  ster",..        
+00021600: 2020 2020 2020 2020 2020 2020 2022 7365               "se
+00021610: 745f 6163 6365 7373 6f72 795f 656e 6162  t_accessory_enab
+00021620: 6c65 222c 0d0a 2020 2020 2020 2020 2020  le",..          
+00021630: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
+00021640: 6469 7363 7265 7465 735f 656e 6162 6c65  discretes_enable
+00021650: 6422 2c0d 0a20 2020 2020 2020 2020 2020  d",..           
+00021660: 2020 2020 2020 2020 2020 2273 6574 5f66            "set_f
+00021670: 616e 5f65 6e61 626c 6522 2c0d 0a20 2020  an_enable",..   
+00021680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021690: 2020 2267 6574 5f66 616e 5f65 6e61 626c    "get_fan_enabl
+000216a0: 6564 222c 0d0a 2020 2020 2020 2020 2020  ed",..          
+000216b0: 2020 2020 2020 2020 2020 2022 7365 745f             "set_
+000216c0: 6c61 6d70 5f65 6e61 626c 6522 2c0d 0a20  lamp_enable",.. 
+000216d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000216e0: 2020 2020 2267 6574 5f6c 616d 705f 656e      "get_lamp_en
+000216f0: 6162 6c65 6422 2c0d 0a20 2020 2020 2020  abled",..       
+00021700: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00021710: 6574 5f73 6875 7474 6572 5f65 6e61 626c  et_shutter_enabl
+00021720: 6522 2c0d 0a20 2020 2020 2020 2020 2020  e",..           
+00021730: 2020 2020 2020 2020 2020 2267 6574 5f73            "get_s
+00021740: 6875 7474 6572 5f65 6e61 626c 6564 222c  hutter_enabled",
+00021750: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00021760: 2020 2020 2020 2022 7365 745f 6d6f 645f         "set_mod_
+00021770: 656e 6162 6c65 222c 0d0a 2020 2020 2020  enable",..      
+00021780: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00021790: 6765 745f 6d6f 645f 656e 6162 6c65 6422  get_mod_enabled"
+000217a0: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+000217b0: 2020 2020 2020 2020 2273 6574 5f6d 6f64          "set_mod
+000217c0: 5f70 6572 696f 645f 7573 222c 0d0a 2020  _period_us",..  
+000217d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000217e0: 2020 2022 6765 745f 6d6f 645f 7065 7269     "get_mod_peri
+000217f0: 6f64 5f75 7322 2c0d 0a20 2020 2020 2020  od_us",..       
+00021800: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00021810: 6574 5f6d 6f64 5f77 6964 7468 5f75 7322  et_mod_width_us"
+00021820: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00021830: 2020 2020 2020 2020 2267 6574 5f6d 6f64          "get_mod
+00021840: 5f77 6964 7468 5f75 7322 2c0d 0a20 2020  _width_us",..   
+00021850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021860: 2020 2273 6574 5f6d 6f64 5f64 656c 6179    "set_mod_delay
+00021870: 5f75 7322 2c0d 0a20 2020 2020 2020 2020  _us",..         
+00021880: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00021890: 5f6d 6f64 5f64 656c 6179 5f75 7322 2c0d  _mod_delay_us",.
+000218a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000218b0: 2020 2020 2020 2267 6574 5f6d 6f64 5f64        "get_mod_d
+000218c0: 7572 6174 696f 6e5f 7573 222c 0d0a 2020  uration_us",..  
+000218d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000218e0: 2020 2022 7365 745f 7374 726f 6265 5f65     "set_strobe_e
+000218f0: 6e61 626c 6522 2c0d 0a20 2020 2020 2020  nable",..       
+00021900: 2020 2020 2020 2020 2020 2020 2020 2267                "g
+00021910: 6574 5f73 7472 6f62 655f 656e 6162 6c65  et_strobe_enable
+00021920: 6422 2c0d 0a20 2020 2020 2020 2020 2020  d",..           
+00021930: 2020 2020 2020 2020 2020 2267 6574 5f61            "get_a
+00021940: 6d62 6965 6e74 5f74 656d 7065 7261 7475  mbient_temperatu
+00021950: 7265 5f64 6567 4322 2c0d 0a20 2020 2020  re_degC",..     
 00021960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021970: 203d 206c 616d 6264 6120 783a 2073 656c   = lambda x: sel
-00021980: 662e 7365 745f 7369 6e67 6c65 5f72 6567  f.set_single_reg
-00021990: 696f 6e28 696e 7428 726f 756e 6428 7829  ion(int(round(x)
-000219a0: 2929 0a20 2020 2020 2020 2070 726f 6365  )).        proce
-000219b0: 7373 5f66 5b22 636c 6561 725f 7265 6769  ss_f["clear_regi
-000219c0: 6f6e 7322 5d20 2020 2020 2020 2020 2020  ons"]           
-000219d0: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
-000219e0: 6264 6120 783a 2073 656c 662e 636c 6561  bda x: self.clea
-000219f0: 725f 7265 6769 6f6e 7328 290a 2020 2020  r_regions().    
-00021a00: 2020 2020 7072 6f63 6573 735f 665b 2264      process_f["d
-00021a10: 6574 6563 746f 725f 726f 6922 5d20 2020  etector_roi"]   
-00021a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021a30: 2020 2020 3d20 6c61 6d62 6461 2078 3a20      = lambda x: 
-00021a40: 7365 6c66 2e73 6574 5f64 6574 6563 746f  self.set_detecto
-00021a50: 725f 726f 6928 7829 0a20 2020 2020 2020  r_roi(x).       
-00021a60: 2070 726f 6365 7373 5f66 5b22 7069 7865   process_f["pixe
-00021a70: 6c5f 6d6f 6465 225d 2020 2020 2020 2020  l_mode"]        
-00021a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021a90: 203d 206c 616d 6264 6120 783a 2073 656c   = lambda x: sel
-00021aa0: 662e 7365 745f 7069 7865 6c5f 6d6f 6465  f.set_pixel_mode
-00021ab0: 2878 290a 0a20 2020 2020 2020 2023 2045  (x)..        # E
-00021ac0: 4550 524f 4d20 7570 6461 7465 730a 2020  EPROM updates.  
-00021ad0: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
-00021ae0: 2275 7064 6174 655f 6565 7072 6f6d 225d  "update_eeprom"]
-00021af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b00: 2020 2020 2020 3d20 6c61 6d62 6461 2078        = lambda x
-00021b10: 3a20 7365 6c66 2e75 7064 6174 655f 7365  : self.update_se
-00021b20: 7373 696f 6e5f 6565 7072 6f6d 2878 290a  ssion_eeprom(x).
-00021b30: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
-00021b40: 665b 2272 6570 6c61 6365 5f65 6570 726f  f["replace_eepro
-00021b50: 6d22 5d20 2020 2020 2020 2020 2020 2020  m"]             
-00021b60: 2020 2020 2020 2020 3d20 6c61 6d62 6461          = lambda
-00021b70: 2078 3a20 7365 6c66 2e72 6570 6c61 6365   x: self.replace
-00021b80: 5f73 6573 7369 6f6e 5f65 6570 726f 6d28  _session_eeprom(
-00021b90: 7829 0a20 2020 2020 2020 2070 726f 6365  x).        proce
-00021ba0: 7373 5f66 5b22 7772 6974 655f 6565 7072  ss_f["write_eepr
-00021bb0: 6f6d 225d 2020 2020 2020 2020 2020 2020  om"]            
-00021bc0: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
-00021bd0: 6264 6120 783a 2073 656c 662e 7772 6974  bda x: self.writ
-00021be0: 655f 6565 7072 6f6d 2829 0a0a 2020 2020  e_eeprom()..    
-00021bf0: 2020 2020 2320 6d61 6e75 6661 6374 7572      # manufactur
-00021c00: 696e 670a 2020 2020 2020 2020 7072 6f63  ing.        proc
-00021c10: 6573 735f 665b 2272 6573 6574 5f66 7067  ess_f["reset_fpg
-00021c20: 6122 5d20 2020 2020 2020 2020 2020 2020  a"]             
-00021c30: 2020 2020 2020 2020 2020 2020 3d20 6c61              = la
-00021c40: 6d62 6461 2078 3a20 7365 6c66 2e72 6573  mbda x: self.res
-00021c50: 6574 5f66 7067 6128 290a 2020 2020 2020  et_fpga().      
-00021c60: 2020 7072 6f63 6573 735f 665b 2264 6675    process_f["dfu
-00021c70: 5f65 6e61 626c 6522 5d20 2020 2020 2020  _enable"]       
-00021c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c90: 2020 3d20 6c61 6d62 6461 2078 3a20 7365    = lambda x: se
-00021ca0: 6c66 2e73 6574 5f64 6675 5f65 6e61 626c  lf.set_dfu_enabl
-00021cb0: 6528 290a 0a20 2020 2020 2020 2023 206c  e()..        # l
-00021cc0: 6567 6163 790a 2020 2020 2020 2020 7072  egacy.        pr
-00021cd0: 6f63 6573 735f 665b 2261 6c6c 6f77 5f64  ocess_f["allow_d
-00021ce0: 6566 6175 6c74 5f67 6169 6e5f 7265 7365  efault_gain_rese
-00021cf0: 7422 5d20 2020 2020 2020 2020 2020 3d20  t"]           = 
-00021d00: 6c61 6d62 6461 2078 3a20 7365 7461 7474  lambda x: setatt
-00021d10: 7228 7365 6c66 2c20 2261 6c6c 6f77 5f64  r(self, "allow_d
-00021d20: 6566 6175 6c74 5f67 6169 6e5f 7265 7365  efault_gain_rese
-00021d30: 7422 2c20 626f 6f6c 2878 2929 0a0a 2020  t", bool(x))..  
-00021d40: 2020 2020 2020 2320 6578 7065 7269 6d65        # experime
-00021d50: 6e74 616c 2028 5226 4429 0a20 2020 2020  ntal (R&D).     
-00021d60: 2020 2070 726f 6365 7373 5f66 5b22 6772     process_f["gr
-00021d70: 6170 685f 616c 7465 726e 6174 696e 675f  aph_alternating_
-00021d80: 7069 7865 6c73 225d 2020 2020 2020 2020  pixels"]        
-00021d90: 2020 203d 206c 616d 6264 6120 783a 2073     = lambda x: s
-00021da0: 656c 662e 7365 7474 696e 6773 2e73 7461  elf.settings.sta
-00021db0: 7465 2e73 6574 2822 6772 6170 685f 616c  te.set("graph_al
-00021dc0: 7465 726e 6174 696e 675f 7069 7865 6c73  ternating_pixels
-00021dd0: 222c 2062 6f6f 6c28 7829 290a 2020 2020  ", bool(x)).    
-00021de0: 2020 2020 7072 6f63 6573 735f 665b 2273      process_f["s
-00021df0: 7761 705f 616c 7465 726e 6174 696e 675f  wap_alternating_
-00021e00: 7069 7865 6c73 225d 2020 2020 2020 2020  pixels"]        
-00021e10: 2020 2020 3d20 6c61 6d62 6461 2078 3a20      = lambda x: 
-00021e20: 7365 6c66 2e73 6574 7469 6e67 732e 7374  self.settings.st
-00021e30: 6174 652e 7365 7428 2273 7761 705f 616c  ate.set("swap_al
-00021e40: 7465 726e 6174 696e 675f 7069 7865 6c73  ternating_pixels
-00021e50: 222c 2062 6f6f 6c28 7829 290a 2020 2020  ", bool(x)).    
-00021e60: 2020 2020 7072 6f63 6573 735f 665b 2269      process_f["i
-00021e70: 6e76 6572 745f 785f 6178 6973 225d 2020  nvert_x_axis"]  
-00021e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021e90: 2020 2020 3d20 6c61 6d62 6461 2078 3a20      = lambda x: 
-00021ea0: 7365 6c66 2e73 6574 7469 6e67 732e 6565  self.settings.ee
-00021eb0: 7072 6f6d 2e73 6574 2822 696e 7665 7274  prom.set("invert
-00021ec0: 5f78 5f61 7869 7322 2c20 626f 6f6c 2878  _x_axis", bool(x
-00021ed0: 2929 0a20 2020 2020 2020 2070 726f 6365  )).        proce
-00021ee0: 7373 5f66 5b22 6269 6e5f 3278 3222 5d20  ss_f["bin_2x2"] 
-00021ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f00: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
-00021f10: 6264 6120 783a 2073 656c 662e 7365 7474  bda x: self.sett
-00021f20: 696e 6773 2e65 6570 726f 6d2e 7365 7428  ings.eeprom.set(
-00021f30: 2262 696e 5f32 7832 222c 2062 6f6f 6c28  "bin_2x2", bool(
-00021f40: 7829 290a 2020 2020 2020 2020 7072 6f63  x)).        proc
-00021f50: 6573 735f 665b 2277 6176 656e 756d 6265  ess_f["wavenumbe
-00021f60: 725f 636f 7272 6563 7469 6f6e 225d 2020  r_correction"]  
-00021f70: 2020 2020 2020 2020 2020 2020 3d20 6c61              = la
-00021f80: 6d62 6461 2078 3a20 7365 6c66 2e73 6574  mbda x: self.set
-00021f90: 7469 6e67 732e 7365 745f 7761 7665 6e75  tings.set_wavenu
-00021fa0: 6d62 6572 5f63 6f72 7265 6374 696f 6e28  mber_correction(
-00021fb0: 666c 6f61 7428 7829 290a 0a20 2020 2020  float(x))..     
-00021fc0: 2020 2023 2068 6561 7274 6265 6174 7320     # heartbeats 
-00021fd0: 2620 636f 6e6e 6563 7469 6f6e 2064 6174  & connection dat
-00021fe0: 610a 2020 2020 2020 2020 7072 6f63 6573  a.        proces
-00021ff0: 735f 665b 2272 6169 7365 5f65 7863 6570  s_f["raise_excep
-00022000: 7469 6f6e 7322 5d20 2020 2020 2020 2020  tions"]         
-00022010: 2020 2020 2020 2020 2020 3d20 6c61 6d62            = lamb
-00022020: 6461 2078 3a20 7365 7461 7474 7228 7365  da x: setattr(se
-00022030: 6c66 2c20 2272 6169 7365 5f65 7863 6570  lf, "raise_excep
-00022040: 7469 6f6e 7322 2c20 626f 6f6c 2878 2929  tions", bool(x))
-00022050: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-00022060: 5f66 5b22 6c6f 675f 6c65 7665 6c22 5d20  _f["log_level"] 
-00022070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022080: 2020 2020 2020 2020 203d 206c 616d 6264           = lambd
-00022090: 6120 783a 2073 656c 662e 7365 745f 6c6f  a x: self.set_lo
-000220a0: 675f 6c65 7665 6c28 7829 0a20 2020 2020  g_level(x).     
-000220b0: 2020 2070 726f 6365 7373 5f66 5b22 6e75     process_f["nu
-000220c0: 6d5f 636f 6e6e 6563 7465 645f 6465 7669  m_connected_devi
-000220d0: 6365 7322 5d20 2020 2020 2020 2020 2020  ces"]           
-000220e0: 2020 203d 206c 616d 6264 6120 783a 2073     = lambda x: s
-000220f0: 656c 662e 7365 7474 696e 6773 2e73 6574  elf.settings.set
-00022100: 5f6e 756d 5f63 6f6e 6e65 6374 6564 5f64  _num_connected_d
-00022110: 6576 6963 6573 2869 6e74 2878 2929 0a20  evices(int(x)). 
-00022120: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
-00022130: 5b22 7375 6270 726f 6365 7373 5f74 696d  ["subprocess_tim
-00022140: 656f 7574 5f73 6563 225d 2020 2020 2020  eout_sec"]      
-00022150: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
-00022160: 783a 204e 6f6e 650a 2020 2020 2020 2020  x: None.        
-00022170: 7072 6f63 6573 735f 665b 2268 6561 7274  process_f["heart
-00022180: 6265 6174 225d 2020 2020 2020 2020 2020  beat"]          
-00022190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221a0: 3d20 6c61 6d62 6461 2078 3a20 4e6f 6e65  = lambda x: None
-000221b0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-000221c0: 5f66 5b22 7265 7365 7422 5d20 2020 2020  _f["reset"]     
-000221d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221e0: 2020 2020 2020 2020 203d 2073 656c 662e           = self.
-000221f0: 7265 7365 740a 0a20 2020 2020 2020 2072  reset..        r
-00022200: 6574 7572 6e20 7072 6f63 6573 735f 660a  eturn process_f.
+00021970: 2267 6574 5f74 6563 5f65 6e61 626c 6564  "get_tec_enabled
+00021980: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00021990: 2020 2020 2020 2020 2022 6765 745f 6163           "get_ac
+000219a0: 7475 616c 5f66 7261 6d65 7322 2c0d 0a20  tual_frames",.. 
+000219b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219c0: 2020 2020 2267 6574 5f61 6374 7561 6c5f      "get_actual_
+000219d0: 696e 7465 6772 6174 696f 6e5f 7469 6d65  integration_time
+000219e0: 5f75 7322 2c0d 0a20 2020 2020 2020 2020  _us",..         
+000219f0: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00021a00: 5f64 6574 6563 746f 725f 6f66 6673 6574  _detector_offset
+00021a10: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00021a20: 2020 2020 2020 2020 2022 6765 745f 6465           "get_de
+00021a30: 7465 6374 6f72 5f6f 6666 7365 745f 6f64  tector_offset_od
+00021a40: 6422 2c0d 0a20 2020 2020 2020 2020 2020  d",..           
+00021a50: 2020 2020 2020 2020 2020 2267 6574 5f63            "get_c
+00021a60: 6364 5f73 656e 7369 6e67 5f74 6872 6573  cd_sensing_thres
+00021a70: 686f 6c64 222c 0d0a 2020 2020 2020 2020  hold",..        
+00021a80: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
+00021a90: 745f 6363 645f 7468 7265 7368 6f6c 645f  t_ccd_threshold_
+00021aa0: 7365 6e73 696e 675f 6d6f 6465 222c 0d0a  sensing_mode",..
+00021ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ac0: 2020 2020 2022 6765 745f 6578 7465 726e       "get_extern
+00021ad0: 616c 5f74 7269 6767 6572 5f6f 7574 7075  al_trigger_outpu
+00021ae0: 7422 2c0d 0a20 2020 2020 2020 2020 2020  t",..           
+00021af0: 2020 2020 2020 2020 2020 2267 6574 5f6c            "get_l
+00021b00: 6173 6572 5f69 6e74 6572 6c6f 636b 222c  aser_interlock",
+00021b10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00021b20: 2020 2020 2020 2022 6361 6e5f 6c61 7365         "can_lase
+00021b30: 725f 6669 7265 222c 0d0a 2020 2020 2020  r_fire",..      
+00021b40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00021b50: 6973 5f6c 6173 6572 5f66 6972 696e 6722  is_laser_firing"
+00021b60: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00021b70: 2020 2020 2020 2020 2267 6574 5f6c 6173          "get_las
+00021b80: 6572 5f65 6e61 626c 6564 222c 0d0a 2020  er_enabled",..  
+00021b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ba0: 2020 2022 7365 745f 6d6f 645f 6c69 6e6b     "set_mod_link
+00021bb0: 6564 5f74 6f5f 696e 7465 6772 6174 696f  ed_to_integratio
+00021bc0: 6e22 2c0d 0a20 2020 2020 2020 2020 2020  n",..           
+00021bd0: 2020 2020 2020 2020 2020 2267 6574 5f73            "get_s
+00021be0: 656c 6563 7465 645f 6164 6322 2c0d 0a20  elected_adc",.. 
+00021bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c00: 2020 2020 2273 6574 5f74 7269 6767 6572      "set_trigger
+00021c10: 5f64 656c 6179 222c 0d0a 2020 2020 2020  _delay",..      
+00021c20: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00021c30: 6765 745f 7472 6967 6765 725f 6465 6c61  get_trigger_dela
+00021c40: 7922 2c0d 0a20 2020 2020 2020 2020 2020  y",..           
+00021c50: 2020 2020 2020 2020 2020 2267 6574 5f76            "get_v
+00021c60: 725f 636f 6e74 696e 756f 7573 5f63 6364  r_continuous_ccd
+00021c70: 222c 0d0a 2020 2020 2020 2020 2020 2020  ",..            
+00021c80: 2020 2020 2020 2020 2022 6765 745f 7672           "get_vr
+00021c90: 5f6e 756d 5f66 7261 6d65 7322 2c0d 0a20  _num_frames",.. 
+00021ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021cb0: 2020 2020 2267 6574 5f6f 7074 5f61 6374      "get_opt_act
+00021cc0: 7561 6c5f 696e 7465 6772 6174 696f 6e5f  ual_integration_
+00021cd0: 7469 6d65 222c 0d0a 2020 2020 2020 2020  time",..        
+00021ce0: 2020 2020 2020 2020 2020 2020 2022 6765               "ge
+00021cf0: 745f 6f70 745f 6172 6561 5f73 6361 6e22  t_opt_area_scan"
+00021d00: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00021d10: 2020 2020 2020 2020 2267 6574 5f6f 7074          "get_opt
+00021d20: 5f63 665f 7365 6c65 6374 222c 0d0a 2020  _cf_select",..  
+00021d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d40: 2020 2022 6765 745f 6f70 745f 6461 7461     "get_opt_data
+00021d50: 5f68 6561 6465 725f 7461 6222 2c0d 0a20  _header_tab",.. 
+00021d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d70: 2020 2020 2267 6574 5f6f 7074 5f68 6f72      "get_opt_hor
+00021d80: 697a 6f6e 7461 6c5f 6269 6e6e 696e 6722  izontal_binning"
+00021d90: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00021da0: 2020 2020 2020 2020 2267 6574 5f6f 7074          "get_opt
+00021db0: 5f69 6e74 6567 7261 7469 6f6e 5f74 696d  _integration_tim
+00021dc0: 655f 7265 736f 6c75 7469 6f6e 222c 0d0a  e_resolution",..
+00021dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021de0: 2020 2020 2022 7365 745f 616e 616c 6f67       "set_analog
+00021df0: 5f6f 7574 7075 745f 6d6f 6465 222c 0d0a  _output_mode",..
+00021e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e10: 2020 2020 2022 7365 745f 616e 616c 6f67       "set_analog
+00021e20: 5f6f 7574 7075 745f 7661 6c75 6522 2c0d  _output_value",.
+00021e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021e40: 2020 2020 2020 2267 6574 5f61 6e61 6c6f        "get_analo
+00021e50: 675f 6f75 7470 7574 5f73 7461 7465 222c  g_output_state",
+00021e60: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00021e70: 2020 2020 2020 2022 6765 745f 616e 616c         "get_anal
+00021e80: 6f67 5f69 6e70 7574 5f76 616c 7565 222c  og_input_value",
+00021e90: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00021ea0: 2020 2020 2020 2022 7570 6461 7465 5f73         "update_s
+00021eb0: 6573 7369 6f6e 5f65 6570 726f 6d22 2c0d  ession_eeprom",.
+00021ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021ed0: 2020 2020 2020 2272 6570 6c61 6365 5f73        "replace_s
+00021ee0: 6573 7369 6f6e 5f65 6570 726f 6d22 2c0d  ession_eeprom",.
+00021ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021f00: 2020 2020 2020 2277 7269 7465 5f65 6570        "write_eep
+00021f10: 726f 6d22 2c0d 0a20 2020 2020 2020 2020  rom",..         
+00021f20: 2020 2020 2020 2020 2020 2020 2273 6574              "set
+00021f30: 5f6c 6f67 5f6c 6576 656c 222c 0d0a 2020  _log_level",..  
+00021f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f50: 2020 2022 7175 6575 655f 6d65 7373 6167     "queue_messag
+00021f60: 6522 205d 3a0d 0a20 2020 2020 2020 2020  e" ]:..         
+00021f70: 2020 2070 726f 6365 7373 5f66 5b66 6f6f     process_f[foo
+00021f80: 5d20 3d20 6765 7461 7474 7228 7365 6c66  ] = getattr(self
+00021f90: 2c20 666f 6f29 0d0a 2020 2020 0d0a 2020  , foo)..    ..  
+00021fa0: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
+00021fb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00021fc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00021fd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00021fe0: 2323 2323 2323 2323 0d0a 2020 2020 2020  ########..      
+00021ff0: 2020 2320 5768 6174 2066 6f6c 6c6f 7773    # What follows
+00022000: 2069 7320 7468 6520 6f6c 6420 696e 6974   is the old init
+00022010: 2d6c 616d 6264 6173 2074 6861 7420 6172  -lambdas that ar
+00022020: 6520 7371 7561 7368 6564 2069 6e74 6f20  e squashed into 
+00022030: 7072 6f63 6573 735f 660d 0a20 2020 2020  process_f..     
+00022040: 2020 2023 204c 6f6e 6720 7465 726d 2c20     # Long term, 
+00022050: 7468 6520 7570 7374 7265 616d 2072 6571  the upstream req
+00022060: 7565 7374 7320 7368 6f75 6c64 2062 6520  uests should be 
+00022070: 6368 616e 6765 6420 746f 206d 6174 6368  changed to match
+00022080: 2074 6865 206e 6577 2066 6f72 6d61 740d   the new format.
+00022090: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
+000220a0: 6973 2061 6e20 6561 7379 2066 6978 2066  is an easy fix f
+000220b0: 6f72 2074 6865 2074 696d 6520 6265 696e  or the time bein
+000220c0: 6720 746f 206d 616b 6520 7468 696e 6773  g to make things
+000220d0: 2062 6568 6176 650d 0a20 2020 2020 2020   behave..       
+000220e0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+000220f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00022100: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00022110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00022120: 2323 230d 0a20 2020 2020 2020 2023 2073  ###..        # s
+00022130: 7065 6374 726f 6d65 7465 7220 636f 6e74  pectrometer cont
+00022140: 726f 6c0d 0a20 2020 2020 2020 2070 726f  rol..        pro
+00022150: 6365 7373 5f66 5b22 6c61 7365 725f 656e  cess_f["laser_en
+00022160: 6162 6c65 225d 2020 2020 2020 2020 2020  able"]          
+00022170: 2020 2020 2020 2020 2020 2020 203d 206c               = l
+00022180: 616d 6264 6120 783a 2073 656c 662e 7365  ambda x: self.se
+00022190: 745f 6c61 7365 725f 656e 6162 6c65 2862  t_laser_enable(b
+000221a0: 6f6f 6c28 7829 290d 0a20 2020 2020 2020  ool(x))..       
+000221b0: 2070 726f 6365 7373 5f66 5b22 696e 7465   process_f["inte
+000221c0: 6772 6174 696f 6e5f 7469 6d65 5f6d 7322  gration_time_ms"
+000221d0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+000221e0: 203d 206c 616d 6264 6120 783a 2073 656c   = lambda x: sel
+000221f0: 662e 7365 745f 696e 7465 6772 6174 696f  f.set_integratio
+00022200: 6e5f 7469 6d65 5f6d 7328 7829 0d0a 0d0a  n_time_ms(x)....
+00022210: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
+00022220: 665b 2264 6574 6563 746f 725f 7465 635f  f["detector_tec_
+00022230: 7365 7470 6f69 6e74 5f64 6567 4322 5d20  setpoint_degC"] 
+00022240: 2020 2020 2020 2020 3d20 6c61 6d62 6461          = lambda
+00022250: 2078 3a20 7365 6c66 2e73 6574 5f64 6574   x: self.set_det
+00022260: 6563 746f 725f 7465 635f 7365 7470 6f69  ector_tec_setpoi
+00022270: 6e74 5f64 6567 4328 696e 7428 726f 756e  nt_degC(int(roun
+00022280: 6428 7829 2929 0d0a 2020 2020 2020 2020  d(x)))..        
+00022290: 7072 6f63 6573 735f 665b 2264 6574 6563  process_f["detec
+000222a0: 746f 725f 7465 635f 656e 6162 6c65 225d  tor_tec_enable"]
+000222b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000222c0: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
+000222d0: 2e73 6574 5f74 6563 5f65 6e61 626c 6528  .set_tec_enable(
+000222e0: 626f 6f6c 2878 2929 0d0a 2020 2020 2020  bool(x))..      
+000222f0: 2020 7072 6f63 6573 735f 665b 2264 6574    process_f["det
+00022300: 6563 746f 725f 6761 696e 225d 2020 2020  ector_gain"]    
+00022310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022320: 2020 3d20 6c61 6d62 6461 2078 3a20 7365    = lambda x: se
+00022330: 6c66 2e73 6574 5f64 6574 6563 746f 725f  lf.set_detector_
+00022340: 6761 696e 2866 6c6f 6174 2878 2929 0d0a  gain(float(x))..
+00022350: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
+00022360: 665b 2264 6574 6563 746f 725f 6f66 6673  f["detector_offs
+00022370: 6574 225d 2020 2020 2020 2020 2020 2020  et"]            
+00022380: 2020 2020 2020 2020 3d20 6c61 6d62 6461          = lambda
+00022390: 2078 3a20 7365 6c66 2e73 6574 5f64 6574   x: self.set_det
+000223a0: 6563 746f 725f 6f66 6673 6574 2869 6e74  ector_offset(int
+000223b0: 2872 6f75 6e64 2878 2929 290d 0a20 2020  (round(x)))..   
+000223c0: 2020 2020 2070 726f 6365 7373 5f66 5b22       process_f["
+000223d0: 6465 7465 6374 6f72 5f67 6169 6e5f 6f64  detector_gain_od
+000223e0: 6422 5d20 2020 2020 2020 2020 2020 2020  d"]             
+000223f0: 2020 2020 203d 206c 616d 6264 6120 783a       = lambda x:
+00022400: 2073 656c 662e 7365 745f 6465 7465 6374   self.set_detect
+00022410: 6f72 5f67 6169 6e5f 6f64 6428 666c 6f61  or_gain_odd(floa
+00022420: 7428 7829 290d 0a20 2020 2020 2020 2070  t(x))..        p
+00022430: 726f 6365 7373 5f66 5b22 6465 7465 6374  rocess_f["detect
+00022440: 6f72 5f6f 6666 7365 745f 6f64 6422 5d20  or_offset_odd"] 
+00022450: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+00022460: 206c 616d 6264 6120 783a 2073 656c 662e   lambda x: self.
+00022470: 7365 745f 6465 7465 6374 6f72 5f6f 6666  set_detector_off
+00022480: 7365 745f 6f64 6428 696e 7428 726f 756e  set_odd(int(roun
+00022490: 6428 7829 2929 0d0a 2020 2020 2020 2020  d(x)))..        
+000224a0: 7072 6f63 6573 735f 665b 2264 6567 435f  process_f["degC_
+000224b0: 746f 5f64 6163 5f63 6f65 6666 7322 5d20  to_dac_coeffs"] 
+000224c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000224d0: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
+000224e0: 2e73 6574 7469 6e67 732e 6565 7072 6f6d  .settings.eeprom
+000224f0: 2e73 6574 2822 6465 6743 5f74 6f5f 6461  .set("degC_to_da
+00022500: 635f 636f 6566 6673 222c 2078 290d 0a0d  c_coeffs", x)...
+00022510: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00022520: 5f66 5b22 6c61 7365 725f 706f 7765 725f  _f["laser_power_
+00022530: 7065 7263 225d 2020 2020 2020 2020 2020  perc"]          
+00022540: 2020 2020 2020 2020 203d 206c 616d 6264           = lambd
+00022550: 6120 783a 2073 656c 662e 7365 745f 6c61  a x: self.set_la
+00022560: 7365 725f 706f 7765 725f 7065 7263 2878  ser_power_perc(x
+00022570: 290d 0a20 2020 2020 2020 2070 726f 6365  )..        proce
+00022580: 7373 5f66 5b22 6c61 7365 725f 706f 7765  ss_f["laser_powe
+00022590: 725f 6d57 225d 2020 2020 2020 2020 2020  r_mW"]          
+000225a0: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
+000225b0: 6264 6120 783a 2073 656c 662e 7365 745f  bda x: self.set_
+000225c0: 6c61 7365 725f 706f 7765 725f 6d57 2878  laser_power_mW(x
+000225d0: 290d 0a20 2020 2020 2020 2070 726f 6365  )..        proce
+000225e0: 7373 5f66 5b22 6c61 7365 725f 7465 6d70  ss_f["laser_temp
+000225f0: 6572 6174 7572 655f 7365 7470 6f69 6e74  erature_setpoint
+00022600: 5f72 6177 225d 2020 2020 203d 206c 616d  _raw"]     = lam
+00022610: 6264 6120 783a 2073 656c 662e 7365 745f  bda x: self.set_
+00022620: 6c61 7365 725f 7465 6d70 6572 6174 7572  laser_temperatur
+00022630: 655f 7365 7470 6f69 6e74 5f72 6177 2869  e_setpoint_raw(i
+00022640: 6e74 2872 6f75 6e64 2878 2929 290d 0a20  nt(round(x))).. 
+00022650: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
+00022660: 5b22 6c61 7365 725f 706f 7765 725f 7261  ["laser_power_ra
+00022670: 6d70 696e 675f 656e 6162 6c65 225d 2020  mping_enable"]  
+00022680: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
+00022690: 783a 2073 656c 662e 7365 745f 6c61 7365  x: self.set_lase
+000226a0: 725f 706f 7765 725f 7261 6d70 696e 675f  r_power_ramping_
+000226b0: 656e 6162 6c65 2862 6f6f 6c28 7829 290d  enable(bool(x)).
+000226c0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+000226d0: 5f66 5b22 6c61 7365 725f 706f 7765 725f  _f["laser_power_
+000226e0: 6869 6768 5f72 6573 6f6c 7574 696f 6e22  high_resolution"
+000226f0: 5d20 2020 2020 2020 203d 206c 616d 6264  ]        = lambd
+00022700: 6120 783a 2073 656c 662e 7365 745f 6c61  a x: self.set_la
+00022710: 7365 725f 706f 7765 725f 6869 6768 5f72  ser_power_high_r
+00022720: 6573 6f6c 7574 696f 6e28 7829 0d0a 2020  esolution(x)..  
+00022730: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
+00022740: 226c 6173 6572 5f70 6f77 6572 5f72 6571  "laser_power_req
+00022750: 7569 7265 5f6d 6f64 756c 6174 696f 6e22  uire_modulation"
+00022760: 5d20 2020 2020 3d20 6c61 6d62 6461 2078  ]     = lambda x
+00022770: 3a20 7365 6c66 2e73 6574 5f6c 6173 6572  : self.set_laser
+00022780: 5f70 6f77 6572 5f72 6571 7569 7265 5f6d  _power_require_m
+00022790: 6f64 756c 6174 696f 6e28 7829 0d0a 2020  odulation(x)..  
+000227a0: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
+000227b0: 2273 656c 6563 7465 645f 6c61 7365 7222  "selected_laser"
+000227c0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+000227d0: 2020 2020 2020 3d20 6c61 6d62 6461 2078        = lambda x
+000227e0: 3a20 7365 6c66 2e73 6574 5f73 656c 6563  : self.set_selec
+000227f0: 7465 645f 6c61 7365 7228 696e 7428 7829  ted_laser(int(x)
+00022800: 290d 0a0d 0a20 2020 2020 2020 2070 726f  )....        pro
+00022810: 6365 7373 5f66 5b22 6869 6768 5f67 6169  cess_f["high_gai
+00022820: 6e5f 6d6f 6465 5f65 6e61 626c 6522 5d20  n_mode_enable"] 
+00022830: 2020 2020 2020 2020 2020 2020 203d 206c               = l
+00022840: 616d 6264 6120 783a 2073 656c 662e 7365  ambda x: self.se
+00022850: 745f 6869 6768 5f67 6169 6e5f 6d6f 6465  t_high_gain_mode
+00022860: 5f65 6e61 626c 6528 626f 6f6c 2878 2929  _enable(bool(x))
+00022870: 0d0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+00022880: 735f 665b 2274 7269 6767 6572 5f73 6f75  s_f["trigger_sou
+00022890: 7263 6522 5d20 2020 2020 2020 2020 2020  rce"]           
+000228a0: 2020 2020 2020 2020 2020 3d20 6c61 6d62            = lamb
+000228b0: 6461 2078 3a20 7365 6c66 2e73 6574 5f74  da x: self.set_t
+000228c0: 7269 6767 6572 5f73 6f75 7263 6528 696e  rigger_source(in
+000228d0: 7428 7829 290d 0a20 2020 2020 2020 2070  t(x))..        p
+000228e0: 726f 6365 7373 5f66 5b22 656e 6162 6c65  rocess_f["enable
+000228f0: 5f73 6563 6f6e 6461 7279 5f61 6463 225d  _secondary_adc"]
+00022900: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+00022910: 206c 616d 6264 6120 783a 2073 656c 662e   lambda x: self.
+00022920: 7365 7474 696e 6773 2e73 7461 7465 2e73  settings.state.s
+00022930: 6574 2822 7365 636f 6e64 6172 795f 6164  et("secondary_ad
+00022940: 635f 656e 6162 6c65 6422 2c20 626f 6f6c  c_enabled", bool
+00022950: 2878 2929 0d0a 2020 2020 2020 2020 7072  (x))..        pr
+00022960: 6f63 6573 735f 665b 2261 7265 615f 7363  ocess_f["area_sc
+00022970: 616e 5f65 6e61 626c 6522 5d20 2020 2020  an_enable"]     
+00022980: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
+00022990: 6c61 6d62 6461 2078 3a20 7365 6c66 2e73  lambda x: self.s
+000229a0: 6574 5f61 7265 615f 7363 616e 5f65 6e61  et_area_scan_ena
+000229b0: 626c 6528 626f 6f6c 2878 2929 0d0a 2020  ble(bool(x))..  
+000229c0: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
+000229d0: 2261 7265 615f 7363 616e 5f66 6173 7422  "area_scan_fast"
+000229e0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+000229f0: 2020 2020 2020 3d20 6c61 6d62 6461 2078        = lambda x
+00022a00: 3a20 7365 6c66 2e73 6574 7469 6e67 732e  : self.settings.
+00022a10: 7374 6174 652e 7365 7428 2261 7265 615f  state.set("area_
+00022a20: 7363 616e 5f66 6173 7422 2c20 626f 6f6c  scan_fast", bool
+00022a30: 2878 2929 0d0a 0d0a 2020 2020 2020 2020  (x))....        
+00022a40: 7072 6f63 6573 735f 665b 2262 6164 5f70  process_f["bad_p
+00022a50: 6978 656c 5f6d 6f64 6522 5d20 2020 2020  ixel_mode"]     
+00022a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a70: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
+00022a80: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
+00022a90: 7365 7428 2262 6164 5f70 6978 656c 5f6d  set("bad_pixel_m
+00022aa0: 6f64 6522 2c20 696e 7428 7829 290d 0a20  ode", int(x)).. 
+00022ab0: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
+00022ac0: 5b22 6d69 6e5f 7573 625f 696e 7465 7276  ["min_usb_interv
+00022ad0: 616c 5f6d 7322 5d20 2020 2020 2020 2020  al_ms"]         
+00022ae0: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
+00022af0: 783a 2073 656c 662e 7365 7474 696e 6773  x: self.settings
+00022b00: 2e73 7461 7465 2e73 6574 2822 6d69 6e5f  .state.set("min_
+00022b10: 7573 625f 696e 7465 7276 616c 5f6d 7322  usb_interval_ms"
+00022b20: 2c20 696e 7428 726f 756e 6428 7829 2929  , int(round(x)))
+00022b30: 0d0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+00022b40: 735f 665b 226d 6178 5f75 7362 5f69 6e74  s_f["max_usb_int
+00022b50: 6572 7661 6c5f 6d73 225d 2020 2020 2020  erval_ms"]      
+00022b60: 2020 2020 2020 2020 2020 3d20 6c61 6d62            = lamb
+00022b70: 6461 2078 3a20 7365 6c66 2e73 6574 7469  da x: self.setti
+00022b80: 6e67 732e 7374 6174 652e 7365 7428 226d  ngs.state.set("m
+00022b90: 6178 5f75 7362 5f69 6e74 6572 7661 6c5f  ax_usb_interval_
+00022ba0: 6d73 222c 2069 6e74 2872 6f75 6e64 2878  ms", int(round(x
+00022bb0: 2929 290d 0a0d 0a20 2020 2020 2020 2070  )))....        p
+00022bc0: 726f 6365 7373 5f66 5b22 6163 6365 7373  rocess_f["access
+00022bd0: 6f72 795f 656e 6162 6c65 225d 2020 2020  ory_enable"]    
+00022be0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+00022bf0: 206c 616d 6264 6120 783a 2073 656c 662e   lambda x: self.
+00022c00: 7365 745f 6163 6365 7373 6f72 795f 656e  set_accessory_en
+00022c10: 6162 6c65 2862 6f6f 6c28 7829 290d 0a20  able(bool(x)).. 
+00022c20: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
+00022c30: 5b22 6661 6e5f 656e 6162 6c65 225d 2020  ["fan_enable"]  
+00022c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c50: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
+00022c60: 783a 2073 656c 662e 7365 745f 6661 6e5f  x: self.set_fan_
+00022c70: 656e 6162 6c65 2862 6f6f 6c28 7829 290d  enable(bool(x)).
+00022c80: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00022c90: 5f66 5b22 6c61 6d70 5f65 6e61 626c 6522  _f["lamp_enable"
+00022ca0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+00022cb0: 2020 2020 2020 2020 203d 206c 616d 6264           = lambd
+00022cc0: 6120 783a 2073 656c 662e 7365 745f 6c61  a x: self.set_la
+00022cd0: 6d70 5f65 6e61 626c 6528 626f 6f6c 2878  mp_enable(bool(x
+00022ce0: 2929 0d0a 2020 2020 2020 2020 7072 6f63  ))..        proc
+00022cf0: 6573 735f 665b 2273 6875 7474 6572 5f65  ess_f["shutter_e
+00022d00: 6e61 626c 6522 5d20 2020 2020 2020 2020  nable"]         
+00022d10: 2020 2020 2020 2020 2020 2020 3d20 6c61              = la
+00022d20: 6d62 6461 2078 3a20 7365 6c66 2e73 6574  mbda x: self.set
+00022d30: 5f73 6875 7474 6572 5f65 6e61 626c 6528  _shutter_enable(
+00022d40: 626f 6f6c 2878 2929 0d0a 2020 2020 2020  bool(x))..      
+00022d50: 2020 7072 6f63 6573 735f 665b 2273 7472    process_f["str
+00022d60: 6f62 655f 656e 6162 6c65 225d 2020 2020  obe_enable"]    
+00022d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d80: 2020 3d20 6c61 6d62 6461 2078 3a20 7365    = lambda x: se
+00022d90: 6c66 2e73 6574 5f73 7472 6f62 655f 656e  lf.set_strobe_en
+00022da0: 6162 6c65 2862 6f6f 6c28 7829 290d 0a20  able(bool(x)).. 
+00022db0: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
+00022dc0: 5b22 6d6f 645f 656e 6162 6c65 225d 2020  ["mod_enable"]  
+00022dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022de0: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
+00022df0: 783a 2073 656c 662e 7365 745f 6d6f 645f  x: self.set_mod_
+00022e00: 656e 6162 6c65 2862 6f6f 6c28 7829 290d  enable(bool(x)).
+00022e10: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00022e20: 5f66 5b22 6d6f 645f 7065 7269 6f64 5f75  _f["mod_period_u
+00022e30: 7322 5d20 2020 2020 2020 2020 2020 2020  s"]             
+00022e40: 2020 2020 2020 2020 203d 206c 616d 6264           = lambd
+00022e50: 6120 783a 2073 656c 662e 7365 745f 6d6f  a x: self.set_mo
+00022e60: 645f 7065 7269 6f64 5f75 7328 696e 7428  d_period_us(int(
+00022e70: 726f 756e 6428 7829 2929 0d0a 2020 2020  round(x)))..    
+00022e80: 2020 2020 7072 6f63 6573 735f 665b 226d      process_f["m
+00022e90: 6f64 5f77 6964 7468 5f75 7322 5d20 2020  od_width_us"]   
+00022ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022eb0: 2020 2020 3d20 6c61 6d62 6461 2078 3a20      = lambda x: 
+00022ec0: 7365 6c66 2e73 6574 5f6d 6f64 5f77 6964  self.set_mod_wid
+00022ed0: 7468 5f75 7328 696e 7428 726f 756e 6428  th_us(int(round(
+00022ee0: 7829 2929 0d0a 0d0a 2020 2020 2020 2020  x)))....        
+00022ef0: 2320 4261 7463 6843 6f6c 6c65 6374 696f  # BatchCollectio
+00022f00: 6e0d 0a20 2020 2020 2020 2070 726f 6365  n..        proce
+00022f10: 7373 5f66 5b22 6672 6565 5f72 756e 6e69  ss_f["free_runni
+00022f20: 6e67 5f6d 6f64 6522 5d20 2020 2020 2020  ng_mode"]       
+00022f30: 2020 2020 2020 2020 2020 203d 206c 616d             = lam
+00022f40: 6264 6120 783a 2073 656c 662e 7365 7474  bda x: self.sett
+00022f50: 696e 6773 2e73 7461 7465 2e73 6574 2822  ings.state.set("
+00022f60: 6672 6565 5f72 756e 6e69 6e67 5f6d 6f64  free_running_mod
+00022f70: 6522 2c20 626f 6f6c 2878 2929 0d0a 2020  e", bool(x))..  
+00022f80: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
+00022f90: 2261 6371 7569 7369 7469 6f6e 5f6c 6173  "acquisition_las
+00022fa0: 6572 5f74 7269 6767 6572 5f65 6e61 626c  er_trigger_enabl
+00022fb0: 6522 5d20 2020 3d20 6c61 6d62 6461 2078  e"]   = lambda x
+00022fc0: 3a20 7365 6c66 2e73 6574 7469 6e67 732e  : self.settings.
+00022fd0: 7374 6174 652e 7365 7428 2261 6371 7569  state.set("acqui
+00022fe0: 7369 7469 6f6e 5f6c 6173 6572 5f74 7269  sition_laser_tri
+00022ff0: 6767 6572 5f65 6e61 626c 6522 2c20 626f  gger_enable", bo
+00023000: 6f6c 2878 2929 0d0a 2020 2020 2020 2020  ol(x))..        
+00023010: 7072 6f63 6573 735f 665b 2261 6371 7569  process_f["acqui
+00023020: 7369 7469 6f6e 5f6c 6173 6572 5f74 7269  sition_laser_tri
+00023030: 6767 6572 5f64 656c 6179 5f6d 7322 5d20  gger_delay_ms"] 
+00023040: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
+00023050: 2e73 6574 7469 6e67 732e 7374 6174 652e  .settings.state.
+00023060: 7365 7428 2261 6371 7569 7369 7469 6f6e  set("acquisition
+00023070: 5f6c 6173 6572 5f74 7269 6767 6572 5f64  _laser_trigger_d
+00023080: 656c 6179 5f6d 7322 2c20 696e 7428 726f  elay_ms", int(ro
+00023090: 756e 6428 7829 2929 0d0a 2020 2020 2020  und(x)))..      
+000230a0: 2020 7072 6f63 6573 735f 665b 2261 6371    process_f["acq
+000230b0: 7569 7369 7469 6f6e 5f74 616b 655f 6461  uisition_take_da
+000230c0: 726b 5f65 6e61 626c 6522 5d20 2020 2020  rk_enable"]     
+000230d0: 2020 3d20 6c61 6d62 6461 2078 3a20 7365    = lambda x: se
+000230e0: 6c66 2e73 6574 7469 6e67 732e 7374 6174  lf.settings.stat
+000230f0: 652e 7365 7428 2261 6371 7569 7369 7469  e.set("acquisiti
+00023100: 6f6e 5f74 616b 655f 6461 726b 5f65 6e61  on_take_dark_ena
+00023110: 626c 6522 2c20 626f 6f6c 2878 2929 0d0a  ble", bool(x))..
+00023120: 0d0a 2020 2020 2020 2020 2320 5365 7269  ..        # Seri
+00023130: 6573 2d58 530d 0a20 2020 2020 2020 2366  es-XS..       #f
+00023140: 5b22 7261 6d61 6e5f 6d6f 6465 5f65 6e61  ["raman_mode_ena
+00023150: 626c 6522 5d20 2020 2020 2020 2020 2020  ble"]           
+00023160: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
+00023170: 783a 2073 656c 662e 7365 745f 7261 6d61  x: self.set_rama
+00023180: 6e5f 6d6f 6465 5f65 6e61 626c 6528 626f  n_mode_enable(bo
+00023190: 6f6c 2878 2929 0d0a 2020 2020 2020 2020  ol(x))..        
+000231a0: 7072 6f63 6573 735f 665b 2272 616d 616e  process_f["raman
+000231b0: 5f64 656c 6179 5f6d 7322 5d20 2020 2020  _delay_ms"]     
+000231c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231d0: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
+000231e0: 2e73 6574 5f72 616d 616e 5f64 656c 6179  .set_raman_delay
+000231f0: 5f6d 7328 696e 7428 726f 756e 6428 7829  _ms(int(round(x)
+00023200: 2929 0d0a 2020 2020 2020 2020 7072 6f63  ))..        proc
+00023210: 6573 735f 665b 226c 6173 6572 5f77 6174  ess_f["laser_wat
+00023220: 6368 646f 675f 7365 6322 5d20 2020 2020  chdog_sec"]     
+00023230: 2020 2020 2020 2020 2020 2020 3d20 6c61              = la
+00023240: 6d62 6461 2078 3a20 7365 6c66 2e73 6574  mbda x: self.set
+00023250: 5f6c 6173 6572 5f77 6174 6368 646f 675f  _laser_watchdog_
+00023260: 7365 6328 696e 7428 726f 756e 6428 7829  sec(int(round(x)
+00023270: 2929 0d0a 0d0a 2020 2020 2020 2020 2320  ))....        # 
+00023280: 7265 6769 6f6e 730d 0a20 2020 2020 2020  regions..       
+00023290: 2070 726f 6365 7373 5f66 5b22 7665 7274   process_f["vert
+000232a0: 6963 616c 5f62 696e 6e69 6e67 225d 2020  ical_binning"]  
+000232b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232c0: 203d 206c 616d 6264 6120 783a 2073 656c   = lambda x: sel
+000232d0: 662e 7365 745f 7665 7274 6963 616c 5f62  f.set_vertical_b
+000232e0: 696e 6e69 6e67 2878 290d 0a20 2020 2020  inning(x)..     
+000232f0: 2020 2070 726f 6365 7373 5f66 5b22 7369     process_f["si
+00023300: 6e67 6c65 5f72 6567 696f 6e22 5d20 2020  ngle_region"]   
+00023310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023320: 2020 203d 206c 616d 6264 6120 783a 2073     = lambda x: s
+00023330: 656c 662e 7365 745f 7369 6e67 6c65 5f72  elf.set_single_r
+00023340: 6567 696f 6e28 696e 7428 726f 756e 6428  egion(int(round(
+00023350: 7829 2929 0d0a 2020 2020 2020 2020 7072  x)))..        pr
+00023360: 6f63 6573 735f 665b 2263 6c65 6172 5f72  ocess_f["clear_r
+00023370: 6567 696f 6e73 225d 2020 2020 2020 2020  egions"]        
+00023380: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
+00023390: 6c61 6d62 6461 2078 3a20 7365 6c66 2e63  lambda x: self.c
+000233a0: 6c65 6172 5f72 6567 696f 6e73 2829 0d0a  lear_regions()..
+000233b0: 2020 2020 2020 2020 7072 6f63 6573 735f          process_
+000233c0: 665b 2264 6574 6563 746f 725f 726f 6922  f["detector_roi"
+000233d0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+000233e0: 2020 2020 2020 2020 3d20 6c61 6d62 6461          = lambda
+000233f0: 2078 3a20 7365 6c66 2e73 6574 5f64 6574   x: self.set_det
+00023400: 6563 746f 725f 726f 6928 7829 0d0a 2020  ector_roi(x)..  
+00023410: 2020 2020 2020 7072 6f63 6573 735f 665b        process_f[
+00023420: 2270 6978 656c 5f6d 6f64 6522 5d20 2020  "pixel_mode"]   
+00023430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023440: 2020 2020 2020 3d20 6c61 6d62 6461 2078        = lambda x
+00023450: 3a20 7365 6c66 2e73 6574 5f70 6978 656c  : self.set_pixel
+00023460: 5f6d 6f64 6528 7829 0d0a 0d0a 2020 2020  _mode(x)....    
+00023470: 2020 2020 2320 4545 5052 4f4d 2075 7064      # EEPROM upd
+00023480: 6174 6573 0d0a 2020 2020 2020 2020 7072  ates..        pr
+00023490: 6f63 6573 735f 665b 2275 7064 6174 655f  ocess_f["update_
+000234a0: 6565 7072 6f6d 225d 2020 2020 2020 2020  eeprom"]        
+000234b0: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
+000234c0: 6c61 6d62 6461 2078 3a20 7365 6c66 2e75  lambda x: self.u
+000234d0: 7064 6174 655f 7365 7373 696f 6e5f 6565  pdate_session_ee
+000234e0: 7072 6f6d 2878 290d 0a20 2020 2020 2020  prom(x)..       
+000234f0: 2070 726f 6365 7373 5f66 5b22 7265 706c   process_f["repl
+00023500: 6163 655f 6565 7072 6f6d 225d 2020 2020  ace_eeprom"]    
+00023510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023520: 203d 206c 616d 6264 6120 783a 2073 656c   = lambda x: sel
+00023530: 662e 7265 706c 6163 655f 7365 7373 696f  f.replace_sessio
+00023540: 6e5f 6565 7072 6f6d 2878 290d 0a20 2020  n_eeprom(x)..   
+00023550: 2020 2020 2070 726f 6365 7373 5f66 5b22       process_f["
+00023560: 7772 6974 655f 6565 7072 6f6d 225d 2020  write_eeprom"]  
+00023570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023580: 2020 2020 203d 206c 616d 6264 6120 783a       = lambda x:
+00023590: 2073 656c 662e 7772 6974 655f 6565 7072   self.write_eepr
+000235a0: 6f6d 2829 0d0a 0d0a 2020 2020 2020 2020  om()....        
+000235b0: 2320 6d61 6e75 6661 6374 7572 696e 670d  # manufacturing.
+000235c0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+000235d0: 5f66 5b22 7265 7365 745f 6670 6761 225d  _f["reset_fpga"]
+000235e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000235f0: 2020 2020 2020 2020 203d 206c 616d 6264           = lambd
+00023600: 6120 783a 2073 656c 662e 7265 7365 745f  a x: self.reset_
+00023610: 6670 6761 2829 0d0a 2020 2020 2020 2020  fpga()..        
+00023620: 7072 6f63 6573 735f 665b 2264 6675 5f65  process_f["dfu_e
+00023630: 6e61 626c 6522 5d20 2020 2020 2020 2020  nable"]         
+00023640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023650: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
+00023660: 2e73 6574 5f64 6675 5f65 6e61 626c 6528  .set_dfu_enable(
+00023670: 290d 0a0d 0a20 2020 2020 2020 2023 206c  )....        # l
+00023680: 6567 6163 790d 0a20 2020 2020 2020 2070  egacy..        p
+00023690: 726f 6365 7373 5f66 5b22 616c 6c6f 775f  rocess_f["allow_
+000236a0: 6465 6661 756c 745f 6761 696e 5f72 6573  default_gain_res
+000236b0: 6574 225d 2020 2020 2020 2020 2020 203d  et"]           =
+000236c0: 206c 616d 6264 6120 783a 2073 6574 6174   lambda x: setat
+000236d0: 7472 2873 656c 662c 2022 616c 6c6f 775f  tr(self, "allow_
+000236e0: 6465 6661 756c 745f 6761 696e 5f72 6573  default_gain_res
+000236f0: 6574 222c 2062 6f6f 6c28 7829 290d 0a0d  et", bool(x))...
+00023700: 0a20 2020 2020 2020 2023 2065 7870 6572  .        # exper
+00023710: 696d 656e 7461 6c20 2852 2644 290d 0a20  imental (R&D).. 
+00023720: 2020 2020 2020 2070 726f 6365 7373 5f66         process_f
+00023730: 5b22 6772 6170 685f 616c 7465 726e 6174  ["graph_alternat
+00023740: 696e 675f 7069 7865 6c73 225d 2020 2020  ing_pixels"]    
+00023750: 2020 2020 2020 203d 206c 616d 6264 6120         = lambda 
+00023760: 783a 2073 656c 662e 7365 7474 696e 6773  x: self.settings
+00023770: 2e73 7461 7465 2e73 6574 2822 6772 6170  .state.set("grap
+00023780: 685f 616c 7465 726e 6174 696e 675f 7069  h_alternating_pi
+00023790: 7865 6c73 222c 2062 6f6f 6c28 7829 290d  xels", bool(x)).
+000237a0: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+000237b0: 5f66 5b22 7377 6170 5f61 6c74 6572 6e61  _f["swap_alterna
+000237c0: 7469 6e67 5f70 6978 656c 7322 5d20 2020  ting_pixels"]   
+000237d0: 2020 2020 2020 2020 203d 206c 616d 6264           = lambd
+000237e0: 6120 783a 2073 656c 662e 7365 7474 696e  a x: self.settin
+000237f0: 6773 2e73 7461 7465 2e73 6574 2822 7377  gs.state.set("sw
+00023800: 6170 5f61 6c74 6572 6e61 7469 6e67 5f70  ap_alternating_p
+00023810: 6978 656c 7322 2c20 626f 6f6c 2878 2929  ixels", bool(x))
+00023820: 0d0a 2020 2020 2020 2020 7072 6f63 6573  ..        proces
+00023830: 735f 665b 2269 6e76 6572 745f 785f 6178  s_f["invert_x_ax
+00023840: 6973 225d 2020 2020 2020 2020 2020 2020  is"]            
+00023850: 2020 2020 2020 2020 2020 3d20 6c61 6d62            = lamb
+00023860: 6461 2078 3a20 7365 6c66 2e73 6574 7469  da x: self.setti
+00023870: 6e67 732e 6565 7072 6f6d 2e73 6574 2822  ngs.eeprom.set("
+00023880: 696e 7665 7274 5f78 5f61 7869 7322 2c20  invert_x_axis", 
+00023890: 626f 6f6c 2878 2929 0d0a 2020 2020 2020  bool(x))..      
+000238a0: 2020 7072 6f63 6573 735f 665b 2262 696e    process_f["bin
+000238b0: 5f32 7832 225d 2020 2020 2020 2020 2020  _2x2"]          
+000238c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000238d0: 2020 3d20 6c61 6d62 6461 2078 3a20 7365    = lambda x: se
+000238e0: 6c66 2e73 6574 7469 6e67 732e 6565 7072  lf.settings.eepr
+000238f0: 6f6d 2e73 6574 2822 6269 6e5f 3278 3222  om.set("bin_2x2"
+00023900: 2c20 626f 6f6c 2878 2929 0d0a 2020 2020  , bool(x))..    
+00023910: 2020 2020 7072 6f63 6573 735f 665b 2277      process_f["w
+00023920: 6176 656e 756d 6265 725f 636f 7272 6563  avenumber_correc
+00023930: 7469 6f6e 225d 2020 2020 2020 2020 2020  tion"]          
+00023940: 2020 2020 3d20 6c61 6d62 6461 2078 3a20      = lambda x: 
+00023950: 7365 6c66 2e73 6574 7469 6e67 732e 7365  self.settings.se
+00023960: 745f 7761 7665 6e75 6d62 6572 5f63 6f72  t_wavenumber_cor
+00023970: 7265 6374 696f 6e28 666c 6f61 7428 7829  rection(float(x)
+00023980: 290d 0a0d 0a20 2020 2020 2020 2023 2068  )....        # h
+00023990: 6561 7274 6265 6174 7320 2620 636f 6e6e  eartbeats & conn
+000239a0: 6563 7469 6f6e 2064 6174 610d 0a20 2020  ection data..   
+000239b0: 2020 2020 2070 726f 6365 7373 5f66 5b22       process_f["
+000239c0: 7261 6973 655f 6578 6365 7074 696f 6e73  raise_exceptions
+000239d0: 225d 2020 2020 2020 2020 2020 2020 2020  "]              
+000239e0: 2020 2020 203d 206c 616d 6264 6120 783a       = lambda x:
+000239f0: 2073 6574 6174 7472 2873 656c 662c 2022   setattr(self, "
+00023a00: 7261 6973 655f 6578 6365 7074 696f 6e73  raise_exceptions
+00023a10: 222c 2062 6f6f 6c28 7829 290d 0a20 2020  ", bool(x))..   
+00023a20: 2020 2020 2070 726f 6365 7373 5f66 5b22       process_f["
+00023a30: 6c6f 675f 6c65 7665 6c22 5d20 2020 2020  log_level"]     
+00023a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a50: 2020 2020 203d 206c 616d 6264 6120 783a       = lambda x:
+00023a60: 2073 656c 662e 7365 745f 6c6f 675f 6c65   self.set_log_le
+00023a70: 7665 6c28 7829 0d0a 2020 2020 2020 2020  vel(x)..        
+00023a80: 7072 6f63 6573 735f 665b 226e 756d 5f63  process_f["num_c
+00023a90: 6f6e 6e65 6374 6564 5f64 6576 6963 6573  onnected_devices
+00023aa0: 225d 2020 2020 2020 2020 2020 2020 2020  "]              
+00023ab0: 3d20 6c61 6d62 6461 2078 3a20 7365 6c66  = lambda x: self
+00023ac0: 2e73 6574 7469 6e67 732e 7365 745f 6e75  .settings.set_nu
+00023ad0: 6d5f 636f 6e6e 6563 7465 645f 6465 7669  m_connected_devi
+00023ae0: 6365 7328 696e 7428 7829 290d 0a20 2020  ces(int(x))..   
+00023af0: 2020 2020 2070 726f 6365 7373 5f66 5b22       process_f["
+00023b00: 7375 6270 726f 6365 7373 5f74 696d 656f  subprocess_timeo
+00023b10: 7574 5f73 6563 225d 2020 2020 2020 2020  ut_sec"]        
+00023b20: 2020 2020 203d 206c 616d 6264 6120 783a       = lambda x:
+00023b30: 204e 6f6e 650d 0a20 2020 2020 2020 2070   None..        p
+00023b40: 726f 6365 7373 5f66 5b22 6865 6172 7462  rocess_f["heartb
+00023b50: 6561 7422 5d20 2020 2020 2020 2020 2020  eat"]           
+00023b60: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+00023b70: 206c 616d 6264 6120 783a 204e 6f6e 650d   lambda x: None.
+00023b80: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00023b90: 5f66 5b22 7265 7365 7422 5d20 2020 2020  _f["reset"]     
+00023ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023bb0: 2020 2020 2020 2020 203d 2073 656c 662e           = self.
+00023bc0: 7265 7365 740d 0a0d 0a20 2020 2020 2020  reset....       
+00023bd0: 2072 6574 7572 6e20 7072 6f63 6573 735f   return process_
+00023be0: 660d 0a                                  f..
```

### Comparing `wasatch-2.1.24/wasatch/HardwareInfo.py` & `wasatch-2.1.32/wasatch/HardwareInfo.py`

 * *Files 13% similar despite different names*

```diff
@@ -6,18 +6,18 @@
 
 class HardwareInfo(object):
 
     def __init__(self, vid=None, pid=None):
         self.vid = vid
         self.pid = pid
     
-    def is_ingaas(self):
+    def is_ingaas(self): # -> bool 
         return self.pid == 0x2000
 
-    def is_arm(self):
+    def is_arm(self): # -> bool 
         return self.pid == 0x4000
 
     ##
     # I can't think of another way to determine whether or not a spectrometer 
     # supports this feature other than via its USB PID (ergo architecture), 
     # which isn't something ENLIGHTEN should be using in business logic.
     def supports_triggering(self):
```

### Comparing `wasatch-2.1.24/wasatch/InterfaceDevice.py` & `wasatch-2.1.32/wasatch/InterfaceDevice.py`

 * *Files 2% similar despite different names*

```diff
@@ -3,22 +3,22 @@
 from .SpectrometerResponse import SpectrometerResponse
 from .SpectrometerResponse import ErrorLevel
 from .SpectrometerRequest  import SpectrometerRequest
 
 log = logging.getLogger(__name__)
 
 class InterfaceDevice:
-    def __init__(self) -> None:
+    def __init__(self): # -> None 
         """
         Any class that communicates to a spectrometer should inherit this class.
         It provides the common functions that avoid repeated code.
         """
         self.process_f = []
 
-    def handle_requests(self, requests: list[SpectrometerRequest]) -> list[SpectrometerResponse]:
+    def handle_requests(self, requests: list[SpectrometerRequest]): # -> list[SpectrometerResponse] 
         responses = []
         for request in requests:
             try:
                 cmd = request.cmd
                 proc_func = self.process_f.get(cmd, None)
                 if proc_func == None:
                     responses.append(SpectrometerResponse(error_msg=f"unsupported cmd {request.cmd}", error_lvl=ErrorLevel.low))
```

### Comparing `wasatch-2.1.24/wasatch/MockUSBDevice.py` & `wasatch-2.1.32/wasatch/MockUSBDevice.py`

 * *Files 2% similar despite different names*

```diff
@@ -103,15 +103,15 @@
         self.reading_cycles = {}
         # turn readings arrays into cycles so 
         # we have an infinite loop of spectra to go through
         for key,value in self.spec_readings.items():
             self.reading_cycles[key] = cycle(value)
         log.info("MockUSBDevice: done")
 
-    def is_andor(self):
+    def is_andor(self): # -> bool 
         return False
 
     def cmd_get_laser_temp(self, *args):
         return [random.randint(0,255)]*2
 
     def cmd_get_detect_temp(self, *args):
         return [0, random.randint(1,255)] # 1-255, dont return a 0
@@ -129,15 +129,15 @@
             return spec_match[0]
         else:
             raise NameError(f'Multiple or No folders found matching {self.spec_name}, matches are {spec_match}')
 
     def find(self,*args,**kwargs):
         return [self]
 
-    def set_configuration(self):
+    def set_configuration(self, *args):
         pass
 
     def reset(self):
         pass
 
     def claim_interface(self, *args, **kwargs):
         # connecting
@@ -240,15 +240,15 @@
             ret_reading = next(self.reading_cycles["default"])
             time.sleep(self.int_time*10**-3)
         return ret_reading
 
     def send_code(self):
         pass
 
-    def is_usb(self):
+    def is_usb(self): # -> bool 
         return True
 
     def get_pid_hex(self):
         return str(hex(self.pid))[2:]
 
     def get_vid_hex(self):
         return str(self.vid)
```

### Comparing `wasatch-2.1.24/wasatch/OceanDevice.py` & `wasatch-2.1.32/wasatch/OceanDevice.py`

 * *Files 1% similar despite different names*

```diff
@@ -80,30 +80,30 @@
 
         self.process_f = self._init_process_funcs()
 
     ###############################################################
     # Private Methods
     ###############################################################
 
-    def _init_process_funcs(self) -> dict[str, Callable[..., Any]]:
+    def _init_process_funcs(self): # -> dict[str, Callable[..., Any]] 
         process_f = {}
 
         process_f["connect"] = self.connect
         process_f["acquire_data"] = self.acquire_data
         process_f["scans_to_average"] = self.scans_to_average
         ##################################################################
         # What follows is the old init-lambdas that are squashed into process_f
         # Long term, the upstream requests should be changed to match the new format
         # This is an easy fix for the time being to make things behave
         ##################################################################
         process_f["integration_time_ms"] = lambda x: self.spec.integration_time_micros(int(round(x*1000))) # conversion from millisec to microsec
 
         return process_f
 
-    def _take_one_averaged_reading(self) -> SpectrometerResponse:
+    def _take_one_averaged_reading(self): # -> SpectrometerResponse 
         averaging_enabled = (self.settings.state.scans_to_average > 1)
 
         if averaging_enabled and not self.settings.state.free_running_mode:
             # collect the entire averaged spectrum at once (added for
             # BatchCollection with laser delay)
             #
             # So: we're NOT in "free-running" mode, so we're basically being
@@ -185,15 +185,15 @@
         # reading.dump_area_scan()
         return SpectrometerResponse(data=reading)
 
     ###############################################################
     # Public Methods
     ###############################################################
 
-    def connect(self) -> SpectrometerResponse:
+    def connect(self): # -> SpectrometerResponse 
         self.device = None
         try:
             devices = list_devices()
         except:
             devices = list_devices()
         for device in devices:
             pyusb_device = device._raw_device.pyusb_device
@@ -211,11 +211,11 @@
         return SpectrometerResponse(data=True)
 
     def acquire_data(self):
         self.settings.wavelengths = self.spec.wavelengths()# setting wavelengths one init doesn't work for some reaons
         reading = self._take_one_averaged_reading()
         return reading
 
-    def scans_to_average(self, value: int) -> SpectrometerResponse:
+    def scans_to_average(self, value: int): # -> SpectrometerResponse 
         self.sum_count = 0
         self.settings.state.scans_to_average = int(value)
         return SpectrometerResponse(True)
```

### Comparing `wasatch-2.1.24/wasatch/ProcessedReading.py` & `wasatch-2.1.32/wasatch/ProcessedReading.py`

 * *Files 9% similar despite different names*

```diff
@@ -30,26 +30,26 @@
     session_count = 0
 
     def clear(self):
         self.reading = None
         self.device_id = None
         self.raw = None
         self.processed = None
-        self.processed_vignetted = None
+        self.processed_cropped = None
         self.reference = None
         self.dark = None
         self.dark_corrected = False
         self.recordable_reference = None
         self.recordable_dark = None
         self.used_reference = False
         self.declared_match = None
         self.raman_intensity_corrected = False
         self.deconvolved = False
-        self.wavelengths_vignetted = None
-        self.wavenumbers_vignetted = None
+        self.wavelengths_cropped = None
+        self.wavenumbers_cropped = None
         self.first_pixel = None
         self.plugin_metadata = None # extra data added by Plugin
 
     ##
     # @param d (Input) if instantiating from a dict (External API or loaded JSON),
     #                  this is the dictionary containing parsed values
     def __init__(self, reading=None, d=None):
@@ -100,38 +100,38 @@
         # it used for a particular request.
         self.session_count = ProcessedReading.session_count
         ProcessedReading.session_count += 1
 
         if d is not None:
             self.load_from_dict(d)
 
-    def has_dark(self):
+    def has_dark(self): # -> bool 
         return self.dark is not None
 
-    def has_reference(self):
+    def has_reference(self): # -> bool 
         return self.reference is not None
 
-    def is_cropped(self):
-        return self.processed_vignetted is not None and len(self.processed_vignetted) > 0
+    def is_cropped(self): # -> bool 
+        return self.processed_cropped is not None and len(self.processed_cropped) > 0
 
-    def has_processed(self):
-        return self.processed is not None or self.processed_vignetted is not None
+    def has_processed(self): # -> bool 
+        return self.processed is not None or self.processed_cropped is not None
 
     def get_processed(self):
-        if self.processed_vignetted is None:
+        if self.processed_cropped is None:
             return self.processed
         else:
-            return self.processed_vignetted
+            return self.processed_cropped
 
     def set_processed(self, spectrum):
         if self.is_cropped():
-            log.debug("set_processed: updating vignetted")
-            self.processed_vignetted = spectrum
+            log.debug("set_processed: updating cropped")
+            self.processed_cropped = spectrum
         else:
-            log.debug("set_processed: updating non-vignetted")
+            log.debug("set_processed: updating non-cropped")
             self.processed = spectrum
 
     def correct_dark(self, dark):
         if self.dark_corrected:
             log.debug("already dark-corrected")
             return
```

### Comparing `wasatch-2.1.24/wasatch/ROI.py` & `wasatch-2.1.32/wasatch/ROI.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/Reading.py` & `wasatch-2.1.32/wasatch/Reading.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/RealUSBDevice.py` & `wasatch-2.1.32/wasatch/RealUSBDevice.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/SPIDevice.py` & `wasatch-2.1.32/wasatch/SPIDevice.py`

 * *Files 0% similar despite different names*

```diff
@@ -79,15 +79,15 @@
     START = 0x3c                # <
     END   = 0x3e                # >
     WRITE = 0x80                # bit changing opcodes from 'getter' to 'setter'
     CRC   = 0xff                # for readability
 
     lock = threading.Lock()
 
-    def __init__(self, device_id: DeviceID, message_queue: Queue) -> None:
+    def __init__(self, device_id: DeviceID, message_queue: Queue): # -> None 
         super().__init__()
 
         ########################################################################
         # Attempt to import dependencies (connects to FT232H)
         ########################################################################
 
         import_successful = False
@@ -201,15 +201,15 @@
             (0x58,    0,     3, "Desmile") ]:
             self.cmds[name] = CommandTuple(addr, value, len_, name)
 
         # patch gain
         cmd = self.cmds["Gain dB"]
         cmd.value = self.gain_to_ff(cmd.value)
 
-    def connect(self) -> SpectrometerResponse:
+    def connect(self): # -> SpectrometerResponse 
         log.debug("initializing EEPROM")
         if not self.init_eeprom():
             log.critical("failed to initialize EEPROM, giving up")
             return SpectrometerResponse(False, error_msg="EEPROM initialization failure", error_lvl=ErrorLevel.high, poison_pill=True)
 
         # initialize all settings -- this ensures no setting is uninitialized
         log.debug("initializing all commands")
@@ -221,15 +221,15 @@
         self.settings.state.integration_time_ms = self.settings.eeprom.startup_integration_time_ms
         self.settings.state.gain_db = self.settings.eeprom.detector_gain
 
         log.info("SPI connect done, returning True")
         return SpectrometerResponse(True)
 
     ## @returns True on success
-    def init_eeprom(self) -> bool:
+    def init_eeprom(self): # -> bool 
         eeprom = self.settings.eeprom
 
         pages = []
         for i in range(EEPROM.MAX_PAGES):
             log.debug(f"flushing buffer before page {i}")
             if not self.flush_input_buffer():
                 log.error("unable to read EEPROM")
@@ -251,19 +251,19 @@
         self.cmds["Start Line 0"    ].value = eeprom.roi_vertical_region_1_start
         self.cmds["Stop Line 0"     ].value = eeprom.roi_vertical_region_1_end
         self.cmds["Start Column 0"  ].value = eeprom.roi_horizontal_start
         self.cmds["Stop Column 0"   ].value = eeprom.roi_horizontal_end
 
         return True
 
-    def disconnect(self) -> SpectrometerResponse:
+    def disconnect(self): # -> SpectrometerResponse 
         self.disconnect = True
         return SpectrometerResponse(True)
 
-    def acquire_data(self) -> SpectrometerResponse:
+    def acquire_data(self): # -> SpectrometerResponse 
         log.debug("spi starts reading")
         if self.disconnect:
             log.debug("disconnecting, returning False for the spectrum")
             return False
         averaging_enabled = (self.settings.state.scans_to_average > 1)
         reading = Reading(self.device_id)
 
@@ -314,36 +314,36 @@
         else:
             # if averaging isn't enabled...then a single reading is the
             # "averaged" final measurement (check reading.sum_count to confirm)
             reading.averaged = True
 
         return SpectrometerResponse(reading)
 
-    def set_integration_time_ms(self, value: int) -> SpectrometerResponse:
+    def set_integration_time_ms(self, value: int): # -> SpectrometerResponse 
         cmd = self.cmds["Integration Time"]
         cmd.value = value
         self.send_command(cmd)
         self.settings.state.integration_time_ms = value
         return SpectrometerResponse()
 
-    def set_gain(self, value: float) -> SpectrometerResponse:
+    def set_gain(self, value: float): # -> SpectrometerResponse 
         cmd = self.cmds["Gain dB"]
         cmd.value = self.gain_to_ff(value)
         self.send_command(cmd)
         self.settings.state.gain_db = value
         return SpectrometerResponse()
 
     def change_setting(self,setting,value):
         log.info(f"spi being told to change setting {setting} to {value}")
         f = self.lambdas.get(setting,None)
         if f is not None:
             f(value)
         return True
 
-    def _init_process_funcs(self) -> dict[str, Callable[..., Any]]:
+    def _init_process_funcs(self): # -> dict[str, Callable[..., Any]] 
         process_f = {}
 
         process_f["connect"] = self.connect
         process_f["disconnect"] = self.disconnect
         process_f["acquire_data"] = self.acquire_data
         process_f["set_integration_time_ms"] = self.set_integration_time_ms
         process_f["detector_gain"] = self.set_gain
@@ -390,23 +390,23 @@
         checksum = self.compute_crc(bytearray(cmd[1:index]))
         result = cmd[:index]
         result.extend([checksum, cmd[-1]])
         # log.debug(f"fix_crc: cmd {self.to_hex(cmd)} -> result {self.to_hex(result)}")
         return bytearray(result)
 
     ## @see ENG-0150-C section 3.2, "Configuration Set Response Packet"
-    def errorcode_to_string(self, code) -> str:
+    def errorcode_to_string(self, code): # -> str 
         if   code == 0: return "SUCCESS"
         elif code == 1: return "ERROR_LENGTH"
         elif code == 2: return "ERROR_CRC"
         elif code == 3: return "ERROR_UNRECOGNIZED_COMMAND"
         else          : return "ERROR_UNDEFINED"
 
     ## @param response (Input): the last 3 bytes of the device's response to a SPI write command
-    def validate_write_response(self, response) -> str:
+    def validate_write_response(self, response): # -> str 
         if len(response) != 3:
             return f"invalid response length: {response}"
         if response[0] != self.START:
             return f"invalid response START marker: {response}"
         if response[2] != self.END:
             return f"invalid response END marker: {response}"
         return self.errorcode_to_string(response[1])
@@ -502,15 +502,15 @@
                 return
             self.SPI.write_readinto(buffered_cmd, buffered_response)
 
         error_msg = self.validate_write_response(buffered_response[-3:])
         log.debug(f"send_command[{cmd.name}]: {self.to_hex(buffered_cmd)} -> {self.to_hex(buffered_response)} ({error_msg})")
 
     ## @returns False if SPI communication hosed. This can happen for instance if your SPI_PIN_READY isn't set.
-    def flush_input_buffer(self) -> bool:
+    def flush_input_buffer(self): # -> bool 
         count = 0
         junk = bytearray(self.READY_POLL_LEN)
 
         MAX_READ = 4096 # something is plainly wrong
 
         try:
             while self.ready.value:
@@ -542,15 +542,15 @@
     def gain_to_ff(self, gain):
         msb = int(round(gain, 5)) & 0xff
         lsb = int((gain - msb) * 256) & 0xff
         raw = (msb << 8) | lsb
         log.debug(f"gain_to_ff: {gain:0.3f} -> dec {raw} (0x{raw:04x})")
         return raw
 
-    def read_page(self, page: int) -> list[bytes]:
+    def read_page(self, page: int): # -> list[bytes] 
         with self.lock:
             # send 0xb0 command to tell FPGA to load EEPROM page into FPGA buffer
             unbuffered_cmd = self.fix_crc([self.START, 0, 2, 0xb0, 0x40 + page, self.CRC, self.END])
             buffered_response = bytearray(len(unbuffered_cmd) + self.READ_RESPONSE_OVERHEAD + 1)
             buffered_cmd = self.buffer_bytearray(unbuffered_cmd, len(buffered_response))
             self.SPI.write_readinto(buffered_cmd, buffered_response)
             log.debug(f">> read_page: {self.to_hex(buffered_cmd)} -> {self.to_hex(buffered_response)}")
@@ -564,15 +564,15 @@
             buffered_cmd = self.buffer_bytearray(unbuffered_cmd, len(buffered_response))
             self.SPI.write_readinto(buffered_cmd, buffered_response)
 
         buf = self.decode_read_response(unbuffered_cmd, buffered_response, "read_eeprom_page", missing_echo_len=1)
         log.debug(f"decoded {len(buf)} values from EEPROM")
         return buf
 
-    def get_spectrum(self) -> list[int]:
+    def get_spectrum(self): # -> list[int] 
         with self.lock:
 
             ####################################################################
             # Trigger Acquisition
             ####################################################################
 
             if self.settings.state.trigger_source == SpectrometerState.TRIGGER_SOURCE_EXTERNAL:
```

### Comparing `wasatch-2.1.24/wasatch/SpectrometerResponse.py` & `wasatch-2.1.32/wasatch/SpectrometerResponse.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/SpectrometerSettings.py` & `wasatch-2.1.32/wasatch/SpectrometerSettings.py`

 * *Files 6% similar despite different names*

```diff
@@ -150,34 +150,34 @@
         # if 'new' value is unreasonable AND NON-ZERO, complain
         if new != 0.0:
             log.debug(f"excitation wavelength {new} outside (200, 2500) - suspect corrupt EEPROM, using {old}")
             return old
 
         return old
 
-    def is_mml(self):
+    def is_mml(self): # -> bool 
         if not self.eeprom.has_laser:
             return False
         if self.eeprom.has_laser and not self.is_sml():
             return True
 
-    def is_sml(self):
+    def is_sml(self): # -> bool 
         if not self.eeprom.has_laser:
             return False
         elif self.eeprom.has_laser and \
             self.eeprom.max_laser_power_mW >= 95 and \
             self.eeprom.max_laser_power_mW <= 120:
             return True
         else:
             return False
 
-    def has_excitation(self):
+    def has_excitation(self): # -> bool 
         return self.excitation() > 0
 
-    def has_vertical_roi(self):
+    def has_vertical_roi(self): # -> bool 
         start = self.eeprom.roi_vertical_region_1_start
         stop  = self.eeprom.roi_vertical_region_1_end
         height = self.eeprom.active_pixels_vertical
         return start < stop and start >= 0 and stop < height
 
     ## @todo return ROI
     def get_vertical_roi(self):
@@ -214,14 +214,21 @@
         return None
 
     # ##########################################################################
     # methods
     # ##########################################################################
 
     def update_raman_intensity_factors(self):
+        """
+        @todo Note that WasatchNET.Util.applyRamanCorrection() only generates 
+              factors from (roiStart, roiEnd), whereas this function generates
+              them for the whole detector. They're only valid within the ROI,
+              and should only be applied within the ROI, so this is generating
+              more than we need (wasting memory and risking bugs).
+        """
         self.raman_intensity_factors = None
         if not self.eeprom.has_raman_intensity_calibration():
             return
         if 1 <= self.eeprom.raman_intensity_calibration_order <= EEPROM.MAX_RAMAN_INTENSITY_CALIBRATION_ORDER:
             log.debug("updating raman intensity factors")
             coeffs = self.eeprom.raman_intensity_coeffs
             log.debug("coeffs = %s", coeffs)
@@ -347,17 +354,17 @@
     #
     # What's unusual is that this spectrometer uses the horizontal ROI fields
     # on the EEPROM to TELL the spectrometer where the active region (or
     # ROI of interest) lies.
     #
     # Therefore, while most of our spectrometers assume the horizontal ROI is
     # zero-indexed at the beginning of the ACTIVE region, and therefore used
-    # to crop/vignette the array of ACTIVE pixels being output, in this case
+    # to crop the array of ACTIVE pixels being output, in this case
     # the horizontal ROI is zero-indexed at the beginning of the PHYSICAL
-    # region, and therefore HAS ALREADY been used to crop/vignette the
+    # region, and therefore HAS ALREADY been used to crop the
     # spectrum down to the active region.
     #
     # (The current unit uses EEPROM subformat 1, meaning region_count remains
     # 0 and pixels() will always return active_pixels_horizontal (1920).
     # Even if we were in subformat 4, detector_regions.total_pixels() should
     # still sum to 1920.)
     #
@@ -409,77 +416,77 @@
     #
     # We're kind of using SpectrometerSettings as a "universal interface" for
     # applications to query for things, so let's just consolidate some obvious
     # and common checks here (even if wrapping calls elsewhere).
     #
     # ##########################################################################
 
-    def is_arm(self):
+    def is_arm(self): # -> bool 
         return self.hardware_info is not None and self.hardware_info.is_arm()
 
-    def is_ingaas(self):
+    def is_ingaas(self): # -> bool 
         if self.hardware_info is not None and self.hardware_info.is_ingaas():
             log.debug("is_ingaas TRUE because hardware_info")
             return True
         elif self.eeprom is None or self.eeprom.detector is None:
             log.debug("is_ingaas FALSE because missing EEPROM or detector")
             return False
-        elif re.match(r'ingaas|g9214|g9206|g14237', self.eeprom.detector.lower()):
+        elif re.match(r'ingaas|g9214|g9206|g14237|du490', self.eeprom.detector.lower()):
             log.debug("is_ingaas TRUE because detector")
             return True
         elif self.fpga_options is not None and self.fpga_options.has_cf_select:
             log.debug("is_ingaas TRUE because has_cf_select")
             return True
         # log.debug("is_ingaas FALSE by default")
         return False
 
-    def is_imx(self) -> bool:
+    def is_imx(self): # -> bool 
         return self.eeprom is not None and \
                self.eeprom.detector is not None and \
                "imx" in self.eeprom.detector.lower()
 
-    def is_imx392(self) -> bool:
+    def is_imx392(self): # -> bool 
         return self.is_imx() and "imx392" in self.eeprom.detector.lower()
 
-    def is_spi(self) -> bool:
+    def is_spi(self): # -> bool 
         return self.hardware_info is not None and \
                self.hardware_info.pid == 0x6014
 
-    def is_micro(self) -> bool:
+    def is_micro(self): # -> bool 
         return ( self.is_arm() and ( \
                    self.is_imx() or \
                    "micro" in self.full_model().lower() or \
                    "sig"   in self.full_model().lower() or \
                    "xs"    in self.full_model().lower() \
                  ) \
                ) \
                or self.is_spi()
 
-    def is_non_raman(self) -> bool:
+    def is_non_raman(self): # -> bool 
         return not self.has_excitation()
 
-    def is_gen15(self) -> bool:
+    def is_gen15(self): # -> bool 
         if "DISABLE_GEN15" in os.environ:
             return False
         return self.eeprom.gen15
 
-    def is_gen2(self) -> bool:
+    def is_gen2(self): # -> bool 
         return False
 
     ## @todo add this to EEPROM.feature_mask if we decide to keep the feature
-    def has_marker(self) -> bool:
+    def has_marker(self): # -> bool 
         return self.eeprom.model == "WPX-8CHANNEL"
 
-    def is_andor(self) -> bool:
+    def is_andor(self): # -> bool 
         return '0x136e' in str(self.device_id)
 
-    def is_sig(self) -> bool:
+    def is_sig(self): # -> bool 
         return self.is_micro()
 
-    def is_xs(self) -> bool:
+    def is_xs(self): # -> bool 
         return self.is_micro()
 
     # probably a simpler way to do this...
     def to_dict(self):
         d = {}
         for k, v in self.__dict__.items():
             if k in ["eeprom_backup"]:
```

### Comparing `wasatch-2.1.24/wasatch/SpectrometerState.py` & `wasatch-2.1.32/wasatch/SpectrometerState.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/WasatchBus.py` & `wasatch-2.1.32/wasatch/WasatchBus.py`

 * *Files 13% similar despite different names*

```diff
@@ -18,21 +18,23 @@
     def __init__(self, use_sim=False, monitor_dir=None):
         self.device_ids = []
 
         # update buses on creation
         self.usb_bus = USBBus()
         self.update()
 
-    ## called by Controller.update_connections
+    ## called by enlighten.Controller.tick_bus_listener()
     def update(self, poll = False):
         if self.usb_bus:
-            self.device_ids.extend(self.usb_bus.update(poll))
+            # MZ: if we call .extend here...when are devices ever purged from the stateful list?
+            # self.device_ids.extend(self.usb_bus.update(poll)) 
+            self.device_ids = self.usb_bus.update(poll)
             self.device_ids = list(set(self.device_ids)) # used in case of poll if same device is present before connection finishes
 
-    def is_empty(self):
+    def is_empty(self): # -> bool 
         return 0 == len(self.device_ids)
 
     ## called by Controller.update_connections
     def dump(self):
         log.debug("WasatchBus.dump: %s", self.device_ids)
 
 class USBBus:
```

### Comparing `wasatch-2.1.24/wasatch/WasatchDevice.py` & `wasatch-2.1.32/wasatch/WasatchDevice.py`

 * *Files 1% similar despite different names*

```diff
@@ -43,15 +43,15 @@
     # It is also what is called by WrapperWorker and because of this
     # I chose to implement the minimum formatting for interface device
     # so that it can match the other calls in WrapperWorker
 
     ##
     # @param device_id      a DeviceID instance OR string label thereof
     # @param message_queue  if provided, used to send status back to caller
-    def __init__(self, device_id: DeviceID, message_queue: Queue = None) -> None:
+    def __init__(self, device_id: DeviceID, message_queue: Queue = None): # -> None 
 
         # if passed a string representation of a DeviceID, deserialize it
         if type(device_id) is str:
             device_id = DeviceID(label=device_id)
 
         self.device_id      = device_id
         self.message_queue  = message_queue
@@ -88,15 +88,15 @@
     # ######################################################################## #
     #                                                                          #
     #                               Connection                                 #
     #                                                                          #
     # ######################################################################## #
 
     ## Attempt low level connection to the specified DeviceID
-    def connect(self) -> SpectrometerResponse:
+    def connect(self): # -> SpectrometerResponse 
         if self.device_id.is_usb() or self.device_id.is_mock():
             log.debug("trying to connect to %s device" % ("USB" if self.device_id.is_usb() else "Mock"))
             result = self.connect_feature_identification()
             if result.data:
                 log.debug("Connected to FeatureIdentificationDevice")
                 self.connected = True
                 self.initialize_settings()
@@ -123,15 +123,15 @@
         time.sleep(0.1)
 
         self.connected = False
         return True
 
     ## Given a specified universal identifier, attempt to connect to the device using FID protocol.
     # @todo merge with the hardcoded list in DeviceFinderUSB
-    def connect_feature_identification(self) -> SpectrometerResponse:
+    def connect_feature_identification(self): # -> SpectrometerResponse 
         FID_list = ["1000", "2000", "4000"] # hex
 
         # check to see if valid FID PID
         pid_hex = self.device_id.get_pid_hex()
         if not pid_hex in FID_list:
             log.debug("connect_feature_identification: device_id %s PID %s not in FID list %s", self.device_id, pid_hex, FID_list)
             return SpectrometerResponse(False)
@@ -191,15 +191,15 @@
 
     # ######################################################################## #
     #                                                                          #
     #                               Acquisition                                #
     #                                                                          #
     # ######################################################################## #
 
-    def acquire_data(self) -> SpectrometerResponse:
+    def acquire_data(self): # -> SpectrometerResponse 
         """
         Process all enqueued settings, then read actual data (spectrum and
         temperatures) from the device.
 
         @see Controller.acquire_reading
         """
         log.debug("acquire_data: start")
@@ -861,15 +861,15 @@
             if control_object.setting == "free_running_mode" and not self.hardware.settings.state.free_running_mode:
                 # we just LEFT free-running mode (went on "pause"), so toss any
                 # queued for the caller (ENLIGHTEN)
                 log.debug("exited free-running mode")
 
         return retval
 
-    def _init_process_funcs(self) -> dict[str, Callable[..., Any]]:
+    def _init_process_funcs(self): # -> dict[str, Callable[..., Any]] 
         process_f = {}
 
         process_f["connect"] = self.connect
         process_f["disconnect"] = self.disconnect
         process_f["acquire_data"] = self.acquire_data
 
         return process_f
@@ -924,15 +924,15 @@
     # WasatchDeviceWrapper.continuous_poll.
     #
     # @param setting (Input) which setting to change
     # @param value   (Input) the new value of the setting (required, but can
     #                be None or "anything" for commands like "acquire" which
     #                don't use the argument).
     # @param allow_immediate
-    def change_setting(self, setting: str, value: Any, allow_immediate: bool = True) -> None:
+    def change_setting(self, setting: str, value: Any, allow_immediate: bool = True): # -> None 
         control_object = ControlObject(setting, value)
         log.debug("WasatchDevice.change_setting: %s", control_object)
 
         # Since scan averaging lives in WasatchDevice, handle commands which affect
         # averaging at this level
         if control_object.setting == "scans_to_average":
             self.sum_count = 0
@@ -958,15 +958,15 @@
         # acquisition which may never come)
         if (allow_immediate and self.immediate_mode) or re.search(r"trigger|laser", setting):
             log.debug("immediately processing %s", control_object)
             self.process_commands()
 
     # override handle_requests. I didn't see a good way to overwrite change_setting without
     # having to redo that pass through.
-    def handle_requests(self, requests: list[SpectrometerRequest]) -> list[SpectrometerResponse]:
+    def handle_requests(self, requests: list[SpectrometerRequest]): # -> list[SpectrometerResponse] 
         responses = []
         for request in requests:
             try:
                 cmd = request.cmd
                 proc_func = self.process_f.get(cmd, None)
                 if proc_func == None:
                     try:
```

### Comparing `wasatch-2.1.24/wasatch/WasatchDeviceWrapper.py` & `wasatch-2.1.32/wasatch/WasatchDeviceWrapper.py`

 * *Files 2% similar despite different names*

```diff
@@ -253,15 +253,15 @@
         self.settings = None
         log.debug("connect: blocking on settings_queue (waiting on child thread to send SpectrometerSettings)")
 
         log.debug("connect: setup connection, returning to controller for settings polling")
 
         return True
 
-    def poll_settings(self) -> SpectrometerResponse:
+    def poll_settings(self): # -> SpectrometerResponse 
         """ @returns SpectrometerResponse(True) on success, (False) otherwise """
         log.debug("polling device settings")
         if not self.settings_queue.empty():
             result = self.settings_queue.get_nowait()
             if result is None: # shouldn't happen
                 log.critical("poll_settings: failed to retrieve device settings (got None, shouldn't happen)")
                 return SpectrometerResponse(False, error_msg="Failed to retrieve device settings")
@@ -327,15 +327,15 @@
     # get_last by default will make sure the queue is cleared, then
     # return the most recent reading from the device.
     #
     # @note it is not clear that measurement modes other than
     #       ACQUISITION_MODE_KEEP_COMPLETE have been well-tested,
     #       especially in the context of multiple spectrometers,
     #       BatchCollection etc.
-    def acquire_data(self, mode=None) -> SpectrometerResponse:
+    def acquire_data(self, mode=None): # -> SpectrometerResponse 
         if self.closing or not self.connected:
             log.critical(f"acquire_data: closing {self.closing} (sending poison-pill upstream) and connected {self.connected}")
             return SpectrometerResponse(False, poison_pill=True)
 
         # ENLIGHTEN "default" - if we're doing scan averaging, take either
         #
         # 1. the NEWEST fully-averaged spectrum (purge the queue), or
@@ -348,15 +348,15 @@
         if mode is None or mode == self.ACQUISITION_MODE_KEEP_COMPLETE:
             return self.get_final_item(keep_averaged=True)
 
     ## Read from the response queue until empty (or we find an averaged item)
     #
     # In the currently implementation, it seems unlikely that a "True" will ever
     # be passed up (we're basically converting them to None here).
-    def get_final_item(self, keep_averaged=False) -> SpectrometerResponse:
+    def get_final_item(self, keep_averaged=False): # -> SpectrometerResponse 
         last_reading  = SpectrometerResponse()
         last_averaged = SpectrometerResponse()
         dequeue_count = 0
 
         # kludge - memory profiling
         if WasatchDeviceWrapper.DISABLE_RESPONSE_QUEUE and self.previous_reading is not None:
             self.previous_reading.spectrum = [(1.1 - 0.2 * random.random()) * x for x in self.previous_reading.spectrum]
```

### Comparing `wasatch-2.1.24/wasatch/WrapperWorker.py` & `wasatch-2.1.32/wasatch/WrapperWorker.py`

 * *Files 2% similar despite different names*

```diff
@@ -64,15 +64,15 @@
         self.connected_device = None
 
     ##
     # This is essentially the main() loop in a thread.
     # All communications with the parent thread are routed through
     # one of the three queues (cmd inputs, response outputs, and
     # a one-shot SpectrometerSettings).
-    def run(self) -> None:
+    def run(self): # -> None 
         is_options = (self.is_ocean, self.is_andor, self.is_ble, self.is_spi)
         device_classes = (OceanDevice, AndorDevice, BLEDevice, SPIDevice, WasatchDevice)
         try:
             if any(is_options):
                 type_connection = is_options.index(True)
                 log.debug(f"trying to instantiate device of type {device_classes[type_connection]}")
                 self.connected_device = device_classes[type_connection](
@@ -237,15 +237,15 @@
         if received_poison_pill_command:
             log.critical("exiting because of downstream poison-pill command from ENLIGHTEN")
         else:
             log.critical("exiting for no reason?!")
 
         log.critical("done")
 
-    def dedupe(self, q: Queue) -> list[ControlObject]:
+    def dedupe(self, q: Queue): # -> list[ControlObject] 
         keep = [] # list, not a set, because we want to keep it ordered
         while True:
             if not q.empty():
                 control_object = q.get_nowait() 
 
                 # treat None elements (poison pills) same as everything else
                 if control_object is None:
```

### Comparing `wasatch-2.1.24/wasatch/applog.py` & `wasatch-2.1.32/wasatch/applog.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/simulation_protocol.py` & `wasatch-2.1.32/wasatch/simulation_protocol.py`

 * *Files identical despite different names*

### Comparing `wasatch-2.1.24/wasatch/utils.py` & `wasatch-2.1.32/wasatch/utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -25,15 +25,15 @@
 
 ## convert unicode string to ascii
 def remove_unicode(s):
     if isinstance(s, str):
         return s.encode('ascii', 'ignore')
     return s
 
-def pixel_to_wavelength(x: int, coeffs: list[float]) -> float:
+def pixel_to_wavelength(x: int, coeffs: list[float]): # -> float 
     wavelength = 0.0
     log.debug(f"converting pixel {x} to wavelen with coeffs {coeffs}")
     for i in range(len(coeffs)):
         wavelength += coeffs[i] * pow(x, i)
     return wavelength
 
 ## expand 3rd-order wavelength polynomial into array of wavelengths
@@ -461,20 +461,21 @@
         if math.isnan(coeffs[i]):
             log.debug("found NaN in coeff, returning False")
             return False 
 
     # check for [0, 1, 0...] default pattern
     all_default = True
     for i in range(len(coeffs)):
-        if i == 1 and coeffs[i] != 1.0:
-            all_default = False
+        if i == 1:
+            if coeffs[i] != 1.0:
+                all_default = False
         elif coeffs[i] != 0.0:
             all_default = False
     if all_default:
-        log.debug("coeffs all default, reutrning False")
+        log.debug("coeffs all default, returning False")
         return False
 
     # check for constants (all coefficients the same value)
     all_const = True
     log.info(coeffs)
     for i in range(1, len(coeffs)):
         if coeffs[0] != coeffs[i]:
```

### Comparing `wasatch-2.1.24/PKG-INFO` & `wasatch-2.1.32/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: wasatch
-Version: 2.1.24
+Version: 2.1.32
 Summary: This package is a driver for Wasatch Photonics spectrometers
 Author-email: Wasatch Photonics <edort@wasatchphotonics.com>
 Description-Content-Type: text/markdown
 Classifier: License :: OSI Approved :: MIT License
 Project-URL: Home, https://github.com/WasatchPhotonics/Wasatch.PY
 
 ![Sample Console Views](https://github.com/WasatchPhotonics/Wasatch.PY/raw/master/screenshots/multiplatform.png)
```

